# Comparing `tmp/ops-2.4.1.tar.gz` & `tmp/ops-2.5.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ops-2.4.1.tar", last modified: Tue Jul  4 05:11:12 2023, max compression
+gzip compressed data, was "ops-2.5.0.tar", last modified: Mon Jul 31 22:31:41 2023, max compression
```

## Comparing `ops-2.4.1.tar` & `ops-2.5.0.tar`

### file list

```diff
@@ -1,46 +1,46 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.317992 ops-2.4.1/
--rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-07-04 05:11:05.000000 ops-2.4.1/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-04 05:11:12.317992 ops-2.4.1/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     3383 2023-07-04 05:11:05.000000 ops-2.4.1/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.313992 ops-2.4.1/ops/
--rw-r--r--   0 runner    (1001) docker     (123)     7506 2023-07-04 05:11:05.000000 ops-2.4.1/ops/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.313992 ops-2.4.1/ops/_private/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:05.000000 ops-2.4.1/ops/_private/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-07-04 05:11:05.000000 ops-2.4.1/ops/_private/timeconv.py
--rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-07-04 05:11:05.000000 ops-2.4.1/ops/_private/yaml.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    52286 2023-07-04 05:11:05.000000 ops-2.4.1/ops/charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    53224 2023-07-04 05:11:05.000000 ops-2.4.1/ops/framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4800 2023-07-04 05:11:05.000000 ops-2.4.1/ops/jujuversion.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.313992 ops-2.4.1/ops/lib/
--rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-07-04 05:11:05.000000 ops-2.4.1/ops/lib/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2476 2023-07-04 05:11:05.000000 ops-2.4.1/ops/log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    17834 2023-07-04 05:11:05.000000 ops-2.4.1/ops/main.py
--rw-r--r--   0 runner    (1001) docker     (123)   126790 2023-07-04 05:11:05.000000 ops-2.4.1/ops/model.py
--rw-r--r--   0 runner    (1001) docker     (123)   100804 2023-07-04 05:11:05.000000 ops-2.4.1/ops/pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:05.000000 ops-2.4.1/ops/py.typed
--rwxr-xr-x   0 runner    (1001) docker     (123)    15224 2023-07-04 05:11:05.000000 ops-2.4.1/ops/storage.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   127739 2023-07-04 05:11:05.000000 ops-2.4.1/ops/testing.py
--rw-r--r--   0 runner    (1001) docker     (123)       46 2023-07-04 05:11:12.000000 ops-2.4.1/ops/version.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.313992 ops-2.4.1/ops.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-04 05:11:12.000000 ops-2.4.1/ops.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)      704 2023-07-04 05:11:12.000000 ops-2.4.1/ops.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-04 05:11:12.000000 ops-2.4.1/ops.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       34 2023-07-04 05:11:12.000000 ops-2.4.1/ops.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-07-04 05:11:12.000000 ops-2.4.1/ops.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)     1082 2023-07-04 05:11:05.000000 ops-2.4.1/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-07-04 05:11:12.317992 ops-2.4.1/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     2910 2023-07-04 05:11:05.000000 ops-2.4.1/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-04 05:11:12.317992 ops-2.4.1/test/
--rwxr-xr-x   0 runner    (1001) docker     (123)    21858 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    64425 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4658 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_helpers.py
--rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_infra.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     6782 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_jujuversion.py
--rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    46874 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_main.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   132002 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_model.py
--rw-r--r--   0 runner    (1001) docker     (123)   125097 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_private.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    15155 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (123)   191372 2023-07-04 05:11:05.000000 ops-2.4.1/test/test_testing.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.352387 ops-2.5.0/
+-rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-07-31 22:31:39.000000 ops-2.5.0/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-31 22:31:41.352387 ops-2.5.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     3383 2023-07-31 22:31:39.000000 ops-2.5.0/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.344387 ops-2.5.0/ops/
+-rw-r--r--   0 runner    (1001) docker     (123)     7556 2023-07-31 22:31:39.000000 ops-2.5.0/ops/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.348387 ops-2.5.0/ops/_private/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:39.000000 ops-2.5.0/ops/_private/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-07-31 22:31:39.000000 ops-2.5.0/ops/_private/timeconv.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-07-31 22:31:39.000000 ops-2.5.0/ops/_private/yaml.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    56773 2023-07-31 22:31:39.000000 ops-2.5.0/ops/charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    53559 2023-07-31 22:31:39.000000 ops-2.5.0/ops/framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     5534 2023-07-31 22:31:39.000000 ops-2.5.0/ops/jujuversion.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.348387 ops-2.5.0/ops/lib/
+-rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-07-31 22:31:39.000000 ops-2.5.0/ops/lib/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2476 2023-07-31 22:31:39.000000 ops-2.5.0/ops/log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    17877 2023-07-31 22:31:39.000000 ops-2.5.0/ops/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)   127949 2023-07-31 22:31:39.000000 ops-2.5.0/ops/model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   102301 2023-07-31 22:31:39.000000 ops-2.5.0/ops/pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:39.000000 ops-2.5.0/ops/py.typed
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15224 2023-07-31 22:31:39.000000 ops-2.5.0/ops/storage.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   120807 2023-07-31 22:31:39.000000 ops-2.5.0/ops/testing.py
+-rw-r--r--   0 runner    (1001) docker     (123)       46 2023-07-31 22:31:41.000000 ops-2.5.0/ops/version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.348387 ops-2.5.0/ops.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     4077 2023-07-31 22:31:41.000000 ops-2.5.0/ops.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)      704 2023-07-31 22:31:41.000000 ops-2.5.0/ops.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-31 22:31:41.000000 ops-2.5.0/ops.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       34 2023-07-31 22:31:41.000000 ops-2.5.0/ops.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-07-31 22:31:41.000000 ops-2.5.0/ops.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1082 2023-07-31 22:31:39.000000 ops-2.5.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-07-31 22:31:41.352387 ops-2.5.0/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     2910 2023-07-31 22:31:39.000000 ops-2.5.0/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-31 22:31:41.352387 ops-2.5.0/test/
+-rwxr-xr-x   0 runner    (1001) docker     (123)    29079 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    64425 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4658 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_infra.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     7974 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_jujuversion.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    47441 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_main.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   132349 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   125443 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_private.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15155 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)   193728 2023-07-31 22:31:39.000000 ops-2.5.0/test/test_testing.py
```

### Comparing `ops-2.4.1/LICENSE.txt` & `ops-2.5.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/PKG-INFO` & `ops-2.5.0/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ops
-Version: 2.4.1
+Version: 2.5.0
 Summary: The Python library behind great charms
 Home-page: https://github.com/canonical/operator
 Author: The Charmcraft team at Canonical Ltd.
 Author-email: charmcraft@lists.launchpad.net
 License: Apache-2.0
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: Apache Software License
```

### Comparing `ops-2.4.1/README.md` & `ops-2.5.0/README.md`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/__init__.py` & `ops-2.5.0/ops/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -51,14 +51,15 @@
     # From charm.py
     'ActionEvent',
     'ActionMeta',
     'CharmBase',
     'CharmEvents',
     'CharmMeta',
     'CollectMetricsEvent',
+    'CollectStatusEvent',
     'ConfigChangedEvent',
     'ContainerMeta',
     'ContainerStorageMeta',
     'HookEvent',
     'InstallEvent',
     'LeaderElectedEvent',
     'LeaderSettingsChangedEvent',
@@ -182,14 +183,15 @@
 from .charm import (  # noqa: F401
     ActionEvent,
     ActionMeta,
     CharmBase,
     CharmEvents,
     CharmMeta,
     CollectMetricsEvent,
+    CollectStatusEvent,
     ConfigChangedEvent,
     ContainerMeta,
     ContainerStorageMeta,
     HookEvent,
     InstallEvent,
     LeaderElectedEvent,
     LeaderSettingsChangedEvent,
```

### Comparing `ops-2.4.1/ops/_private/timeconv.py` & `ops-2.5.0/ops/_private/timeconv.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/_private/yaml.py` & `ops-2.5.0/ops/_private/yaml.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/charm.py` & `ops-2.5.0/ops/charm.py`

 * *Files 8% similar despite different names*

```diff
@@ -11,14 +11,15 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Base objects for the Charm, events and metadata."""
 
 import enum
+import logging
 import os
 import pathlib
 from typing import (
     TYPE_CHECKING,
     Any,
     Dict,
     List,
@@ -70,14 +71,17 @@
 
     _MountDict = TypedDict(
         '_MountDict', {'storage': Required[str],
                        'location': str},
         total=False)
 
 
+logger = logging.getLogger(__name__)
+
+
 class HookEvent(EventBase):
     """Events raised by Juju to progress a charm's lifecycle.
 
     Hooks are callback methods of a charm class (a subclass of
     :class:`CharmBase`) that are invoked in response to events raised
     by Juju. These callback methods are the means by which a charm
     governs the lifecycle of its application.
@@ -822,14 +826,91 @@
     def defer(self) -> None:
         """Secret expiration events are not deferrable (Juju handles re-invocation)."""
         raise RuntimeError(
             'Cannot defer secret expiration events. Juju will keep firing '
             'this event until you create a new revision.')
 
 
+class CollectStatusEvent(EventBase):
+    """Event triggered at the end of every hook to collect statuses for evaluation.
+
+    If the charm wants to provide application or unit status in a consistent
+    way after the end of every hook, it should observe the
+    :attr:`collect_app_status <CharmEvents.collect_app_status>` or
+    :attr:`collect_unit_status <CharmEvents.collect_unit_status>` event,
+    respectively.
+
+    The framework will trigger these events after the hook code runs
+    successfully (``collect_app_status`` will only be triggered on the leader
+    unit). If any statuses were added by the event handlers using
+    :meth:`add_status`, the framework will choose the highest-priority status
+    and set that as the status (application status for ``collect_app_status``,
+    or unit status for ``collect_unit_status``).
+
+    The order of priorities is as follows, from highest to lowest:
+
+    * error
+    * blocked
+    * maintenance
+    * waiting
+    * active
+    * unknown
+
+    If there are multiple statuses with the same priority, the first one added
+    wins (and if an event is observed multiple times, the handlers are called
+    in the order they were observed).
+
+    A collect-status event can be observed multiple times, and
+    :meth:`add_status` can be called multiple times to add multiple statuses
+    for evaluation. This is useful when a charm has multiple components that
+    each have a status. Each code path in a collect-status handler should
+    call ``add_status`` at least once.
+
+    Below is an example "web app" charm component that observes
+    ``collect_unit_status`` to provide the status of the component, which
+    requires a "port" config option set before it can proceed::
+
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.webapp = Webapp(self)
+                # initialize other components
+
+        class WebApp(ops.Object):
+            def __init__(self, charm: ops.CharmBase):
+                super().__init__(charm, 'webapp')
+                self.framework.observe(charm.on.collect_unit_status, self._on_collect_status)
+
+            def _on_collect_status(self, event: ops.CollectStatusEvent):
+                if 'port' not in self.model.config:
+                    event.add_status(ops.BlockedStatus('please set "port" config'))
+                    return
+                event.add_status(ops.ActiveStatus())
+
+    .. # noqa (pydocstyle barfs on the above for unknown reasons I've spent hours on)
+    """
+
+    def add_status(self, status: model.StatusBase):
+        """Add a status for evaluation.
+
+        See :class:`CollectStatusEvent` for a description of how to use this.
+        """
+        if not isinstance(status, model.StatusBase):
+            raise TypeError(f'status should be a StatusBase, not {type(status).__name__}')
+        model_ = self.framework.model
+        if self.handle.kind == 'collect_app_status':
+            if not isinstance(status, model.ActiveStatus):
+                logger.debug('Adding app status %s', status, stacklevel=2)
+            model_.app._collected_statuses.append(status)
+        else:
+            if not isinstance(status, model.ActiveStatus):
+                logger.debug('Adding unit status %s', status, stacklevel=2)
+            model_.unit._collected_statuses.append(status)
+
+
 class CharmEvents(ObjectEvents):
     """Events generated by Juju pertaining to application lifecycle.
 
     By default, the events listed as attributes of this class will be
     provided via the :attr:`CharmBase.on` attribute. For example::
 
         self.framework.observe(self.on.config_changed, self._on_config_changed)
@@ -878,34 +959,49 @@
     """Triggered after a series upgrade (see :class:`PostSeriesUpgradeEvent`)."""
 
     leader_elected = EventSource(LeaderElectedEvent)
     """Triggered when a new leader has been elected (see :class:`LeaderElectedEvent`)."""
 
     leader_settings_changed = EventSource(LeaderSettingsChangedEvent)
     """DEPRECATED. Triggered when leader changes any settings (see
-    :class:`LeaderSettingsChangedEvent`)."""
+    :class:`LeaderSettingsChangedEvent`).
+    """
 
     collect_metrics = EventSource(CollectMetricsEvent)
     """Triggered by Juju to collect metrics (see :class:`CollectMetricsEvent`)."""
 
     secret_changed = EventSource(SecretChangedEvent)
     """Triggered by Juju on the observer when the secret owner changes its contents (see
-    :class:`SecretChangedEvent`)."""
+    :class:`SecretChangedEvent`).
+    """
 
     secret_expired = EventSource(SecretExpiredEvent)
     """Triggered by Juju on the owner when a secret's expiration time elapses (see
-    :class:`SecretExpiredEvent`)."""
+    :class:`SecretExpiredEvent`).
+    """
 
     secret_rotate = EventSource(SecretRotateEvent)
     """Triggered by Juju on the owner when the secret's rotation policy elapses (see
-    :class:`SecretRotateEvent`)."""
+    :class:`SecretRotateEvent`).
+    """
 
     secret_remove = EventSource(SecretRemoveEvent)
     """Triggered by Juju on the owner when a secret revision can be removed (see
-    :class:`SecretRemoveEvent`)."""
+    :class:`SecretRemoveEvent`).
+    """
+
+    collect_app_status = EventSource(CollectStatusEvent)
+    """Triggered on the leader at the end of every hook to collect app statuses for evaluation
+    (see :class:`CollectStatusEvent`).
+    """
+
+    collect_unit_status = EventSource(CollectStatusEvent)
+    """Triggered at the end of every hook to collect unit statuses for evaluation
+    (see :class:`CollectStatusEvent`).
+    """
 
 
 class CharmBase(Object):
     """Base class that represents the charm overall.
 
     :code:`CharmBase` is used to create a charm. This is done by inheriting
     from :code:`CharmBase` and customising the subclass as required. So to
@@ -991,14 +1087,31 @@
 
     @property
     def config(self) -> model.ConfigData:
         """A mapping containing the charm's config and current values."""
         return self.model.config
 
 
+def _evaluate_status(charm: CharmBase):  # pyright: ignore[reportUnusedFunction]
+    """Trigger collect-status events and evaluate and set the highest-priority status.
+
+    See :class:`CollectStatusEvent` for details.
+    """
+    if charm.framework.model._backend.is_leader():
+        charm.on.collect_app_status.emit()
+        app = charm.app
+        if app._collected_statuses:
+            app.status = model.StatusBase._get_highest_priority(app._collected_statuses)
+
+    charm.on.collect_unit_status.emit()
+    unit = charm.unit
+    if unit._collected_statuses:
+        unit.status = model.StatusBase._get_highest_priority(unit._collected_statuses)
+
+
 class CharmMeta:
     """Object containing the metadata for the charm.
 
     This is read from ``metadata.yaml`` and ``actions.yaml``. Generally
     charms will define this information, rather than reading it at runtime. This
     class is mostly for the framework to understand what the charm has defined.
```

### Comparing `ops-2.4.1/ops/framework.py` & `ops-2.5.0/ops/framework.py`

 * *Files 0% similar despite different names*

```diff
@@ -485,14 +485,22 @@
         return PrefixedEvents(self, key)
 
     def __repr__(self):
         k = type(self)
         event_kinds = ', '.join(sorted(self._event_kinds()))
         return f'<{k.__module__}.{k.__qualname__}: {event_kinds}>'
 
+    def __getattr__(self, name: str) -> Any:
+        """The existence of this method tells type checkers to allow dynamic attributes.
+
+        This allows charms to access dynamically-defined events such as
+        ``self.on.db_relation_joined`` without Mypy/Pyright whining.
+        """
+        return super().__getattribute__(name)
+
 
 class PrefixedEvents:
     """Events to be found in all events using a specific prefix."""
 
     def __init__(self, emitter: Object, key: str):
         self._emitter = emitter
         self._prefix = key.replace('-', '_') + '_'
```

### Comparing `ops-2.4.1/ops/jujuversion.py` & `ops-2.5.0/ops/jujuversion.py`

 * *Files 3% similar despite different names*

```diff
@@ -117,9 +117,26 @@
     @property
     def has_secrets(self) -> bool:
         """Report whether this Juju version supports the "secrets" feature."""
         # Juju version 3.0.0 had an initial version of secrets, but:
         # * In 3.0.2, secret-get "--update" was renamed to "--refresh", and
         #   secret-get-info was separated into its own hook tool
         # * In 3.0.3, a bug with observer labels was fixed (juju/juju#14916)
-        # TODO(benhoyt): update to 3.0.3+ once shipped (for juju/juju#14916 fix)
-        return (self.major, self.minor, self.patch) >= (3, 0, 2)
+        return (self.major, self.minor, self.patch) >= (3, 0, 3)
+
+    @property
+    def supports_open_port_on_k8s(self) -> bool:
+        """Report whether this Juju version supports open-port on Kubernetes."""
+        # Support added: https://bugs.launchpad.net/juju/+bug/1920960
+        return (self.major, self.minor, self.patch) >= (3, 0, 3)
+
+    @property
+    def supports_exec_service_context(self) -> bool:
+        """Report whether this Juju version supports exec's service_context option."""
+        if (self.major, self.minor, self.patch) < (3, 1, 6):
+            # First released in 3.1.6
+            return False
+        if (self.major, self.minor, self.patch) == (3, 2, 0):
+            # 3.2.0 was released before Pebble was updated, but all other 3.2
+            # releases have the change (3.2.1 tag was never released).
+            return False
+        return True
```

### Comparing `ops-2.4.1/ops/lib/__init__.py` & `ops-2.5.0/ops/lib/__init__.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/log.py` & `ops-2.5.0/ops/log.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/main.py` & `ops-2.5.0/ops/main.py`

 * *Files 0% similar despite different names*

```diff
@@ -436,14 +436,16 @@
         # Skip reemission of deferred events for collect-metrics events because
         # they do not have the full access to all hook tools.
         if not dispatcher.is_restricted_context():
             framework.reemit()
 
         _emit_charm_event(charm, dispatcher.event_name)
 
+        ops.charm._evaluate_status(charm)
+
         framework.commit()
     finally:
         framework.close()
 
 
 # Make this module callable and call main(), so that "import ops" and then
 # "ops.main(Charm)" works as expected now that everything is imported in
```

### Comparing `ops-2.4.1/ops/model.py` & `ops-2.5.0/ops/model.py`

 * *Files 1% similar despite different names*

```diff
@@ -261,22 +261,16 @@
             SecretNotFoundError: If a secret with this ID or label doesn't exist.
         """
         if not (id or label):
             raise TypeError('Must provide an id or label, or both')
         if id is not None:
             # Canonicalize to "secret:<id>" form for consistency in backend calls.
             id = Secret._canonicalize_id(id)
-        try:
-            content = self._backend.secret_get(id=id, label=label)
-            return Secret(self._backend, id=id, label=label, content=content)
-        except ModelError:
-            # TODO(benhoyt): remove the secret-info-get fallback once
-            #  juju/juju#14916 is fixed (should be in Juju 3.0.3)
-            info = self._backend.secret_info_get(id=id, label=label)
-            return Secret(self._backend, id=info.id, label=info.label)
+        content = self._backend.secret_get(id=id, label=label)
+        return Secret(self._backend, id=id, label=label, content=content)
 
 
 class _ModelCache:
     def __init__(self, meta: 'ops.charm.CharmMeta', backend: '_ModelBackend'):
         if typing.TYPE_CHECKING:
             # (entity type, name): instance.
             _weakcachetype = weakref.WeakValueDictionary[
@@ -321,26 +315,31 @@
     def __init__(self, name: str, meta: 'ops.charm.CharmMeta',
                  backend: '_ModelBackend', cache: _ModelCache):
         self.name = name
         self._backend = backend
         self._cache = cache
         self._is_our_app = self.name == self._backend.app_name
         self._status = None
+        self._collected_statuses: 'List[StatusBase]' = []
 
     def _invalidate(self):
         self._status = None
 
     @property
     def status(self) -> 'StatusBase':
         """Used to report or read the status of the overall application.
 
         Can only be read and set by the lead unit of the application.
 
         The status of remote units is always Unknown.
 
+        You can also use the :attr:`collect_app_status <CharmEvents.collect_app_status>`
+        event if you want to evaluate and set application status consistently
+        at the end of every hook.
+
         Raises:
             RuntimeError: if you try to set the status of another application, or if you try to
                 set the status of this application as a unit that is not the leader.
             InvalidStatusError: if you try to set the status to something that is not a
                 :class:`StatusBase`
 
         Example::
@@ -467,28 +466,33 @@
         app_name = name.split('/')[0]
         self.app = cache.get(Application, app_name)
 
         self._backend = backend
         self._cache = cache
         self._is_our_unit = self.name == self._backend.unit_name
         self._status = None
+        self._collected_statuses: 'List[StatusBase]' = []
 
         if self._is_our_unit and hasattr(meta, "containers"):
             containers: _ContainerMeta_Raw = meta.containers
             self._containers = ContainerMapping(iter(containers), backend)
 
     def _invalidate(self):
         self._status = None
 
     @property
     def status(self) -> 'StatusBase':
         """Used to report or read the status of a specific unit.
 
         The status of any unit other than yourself is always Unknown.
 
+        You can also use the :attr:`collect_unit_status <CharmEvents.collect_unit_status>`
+        event if you want to evaluate and set unit status consistently at the
+        end of every hook.
+
         Raises:
             RuntimeError: if you try to set the status of a unit other than yourself.
             InvalidStatusError: if you try to set the status to something other than
                 a :class:`StatusBase`
         Example::
 
             self.model.unit.status = MaintenanceStatus('reconfiguring the frobnicators')
@@ -1540,16 +1544,16 @@
 
     To access a status by name, use :meth:`StatusBase.from_name`. However, most use cases will
     directly use the child class such as :class:`ActiveStatus` to indicate their status.
     """
 
     _statuses: Dict[str, Type['StatusBase']] = {}
 
-    # Subclasses should override this attribute and make it a string.
-    name = NotImplemented
+    # Subclasses should override this attribute
+    name = ''
 
     def __init__(self, message: str = ''):
         if self.__class__ is StatusBase:
             raise TypeError("cannot instantiate a base class")
         self.message = message
 
     def __eq__(self, other: 'StatusBase') -> bool:
@@ -1585,14 +1589,31 @@
         """Register a Status for the child's name."""
         if not isinstance(getattr(child, 'name'), str):
             raise TypeError(f"Can't register StatusBase subclass {child}: ",
                             "missing required `name: str` class attribute")
         cls._statuses[child.name] = child
         return child
 
+    _priorities = {
+        'error': 5,
+        'blocked': 4,
+        'maintenance': 3,
+        'waiting': 2,
+        'active': 1,
+        # 'unknown' or any other status is handled below
+    }
+
+    @classmethod
+    def _get_highest_priority(cls, statuses: 'List[StatusBase]') -> 'StatusBase':
+        """Return the highest-priority status from a list of statuses.
+
+        If there are multiple highest-priority statuses, return the first one.
+        """
+        return max(statuses, key=lambda status: cls._priorities.get(status.name, 0))
+
 
 @StatusBase.register
 class UnknownStatus(StatusBase):
     """The unit status is unknown.
 
     A unit-agent has finished calling install, config-changed and start, but the
     charm has not called status-set yet.
@@ -2362,14 +2383,15 @@
 
     # Exec I/O is str if encoding is provided (the default)
     @typing.overload
     def exec(  # noqa
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2383,14 +2405,15 @@
 
     # Exec I/O is bytes if encoding is explicitly set to None
     @typing.overload
     def exec(  # noqa
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2402,14 +2425,15 @@
     ) -> pebble.ExecProcess[bytes]:
         ...
 
     def exec(
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2420,16 +2444,22 @@
         combine_stderr: bool = False
     ) -> pebble.ExecProcess[Any]:
         """Execute the given command on the remote system.
 
         See :meth:`ops.pebble.Client.exec` for documentation of the parameters
         and return value, as well as examples.
         """
+        if service_context is not None:
+            version = JujuVersion.from_environ()
+            if not version.supports_exec_service_context:
+                raise RuntimeError(
+                    f'exec with service_context not supported on Juju version {version}')
         return self._pebble.exec(
             command,
+            service_context=service_context,
             environment=environment,
             working_dir=working_dir,
             timeout=timeout,
             user_id=user_id,
             user=user,
             group_id=group_id,
             group=group,
```

### Comparing `ops-2.4.1/ops/pebble.py` & `ops-2.5.0/ops/pebble.py`

 * *Files 1% similar despite different names*

```diff
@@ -75,26 +75,44 @@
                                 'before': Sequence[str],
                                 'requires': Sequence[str],
                                 'environment': Dict[str, str],
                                 'user': str,
                                 'user-id': Optional[int],
                                 'group': str,
                                 'group-id': Optional[int],
+                                'working-dir': str,
                                 'on-success': str,
                                 'on-failure': str,
                                 'on-check-failure': Dict[str, Any],
                                 'backoff-delay': str,
                                 'backoff-factor': Optional[int],
                                 'backoff-limit': str,
+                                'kill-delay': Optional[str],
                                 },
                                total=False)
 
-HttpDict = typing.TypedDict('HttpDict', {'url': str})
-TcpDict = typing.TypedDict('TcpDict', {'port': int})
-ExecDict = typing.TypedDict('ExecDict', {'command': str})
+HttpDict = typing.TypedDict('HttpDict',
+                            {'url': str,
+                             'headers': Dict[str, str]},
+                            total=False)
+TcpDict = typing.TypedDict('TcpDict',
+                           {'port': int,
+                            'host': str},
+                           total=False)
+ExecDict = typing.TypedDict('ExecDict',
+                            {'command': str,
+                             # see JujuVersion.supports_exec_service_context
+                             'service-context': str,
+                             'environment': Dict[str, str],
+                             'user-id': Optional[int],
+                             'user': str,
+                             'group-id': Optional[int],
+                             'group': str,
+                             'working-dir': str},
+                            total=False)
 
 CheckDict = typing.TypedDict('CheckDict',
                              {'override': str,
                               'level': Union['CheckLevel', str],
                               'period': Optional[str],
                               'timeout': Optional[str],
                               'http': Optional[HttpDict],
@@ -220,15 +238,15 @@
                               'repeat-after': str})
 
     class _WebSocket(Protocol):
         def connect(self, url: str, socket: socket.socket): ...  # noqa
         def shutdown(self): ...                                  # noqa
         def send(self, payload: str): ...                        # noqa
         def send_binary(self, payload: bytes): ...               # noqa
-        def recv(self) -> typing.AnyStr: ...                     # noqa
+        def recv(self) -> Union[str, bytes]: ...                 # noqa
 
 logger = logging.getLogger(__name__)
 
 
 class _NotProvidedFlag:
     pass
 
@@ -796,20 +814,22 @@
         self.before = list(dct.get('before', []))
         self.requires = list(dct.get('requires', []))
         self.environment = dict(dct.get('environment', {}))
         self.user = dct.get('user', '')
         self.user_id = dct.get('user-id')
         self.group = dct.get('group', '')
         self.group_id = dct.get('group-id')
+        self.working_dir = dct.get('working-dir', '')
         self.on_success = dct.get('on-success', '')
         self.on_failure = dct.get('on-failure', '')
         self.on_check_failure = dict(dct.get('on-check-failure', {}))
         self.backoff_delay = dct.get('backoff-delay', '')
         self.backoff_factor = dct.get('backoff-factor')
         self.backoff_limit = dct.get('backoff-limit', '')
+        self.kill_delay = dct.get('kill-delay', '')
 
     def to_dict(self) -> 'ServiceDict':
         """Convert this service object to its dict representation."""
         fields = [
             ('summary', self.summary),
             ('description', self.description),
             ('startup', self.startup),
@@ -819,20 +839,22 @@
             ('before', self.before),
             ('requires', self.requires),
             ('environment', self.environment),
             ('user', self.user),
             ('user-id', self.user_id),
             ('group', self.group),
             ('group-id', self.group_id),
+            ('working-dir', self.working_dir),
             ('on-success', self.on_success),
             ('on-failure', self.on_failure),
             ('on-check-failure', self.on_check_failure),
             ('backoff-delay', self.backoff_delay),
             ('backoff-factor', self.backoff_factor),
             ('backoff-limit', self.backoff_limit),
+            ('kill-delay', self.kill_delay),
         ]
         dct = {name: value for name, value in fields if value}
         return typing.cast('ServiceDict', dct)
 
     def _merge(self, other: 'Service'):
         """Merges this service object with another service definition.
 
@@ -1385,15 +1407,15 @@
     ws.send('{"command":"end"}')  # type: ignore # Send "end" command as TEXT frame to signal EOF
 
 
 def _websocket_to_writer(ws: '_WebSocket', writer: '_WebsocketWriter',
                          encoding: Optional[str]):
     """Receive messages from websocket (until end signal) and write to writer."""
     while True:
-        chunk: Union[str, bytes] = typing.cast(Union[str, bytes], ws.recv())
+        chunk = ws.recv()
 
         if isinstance(chunk, str):
             try:
                 payload = json.loads(chunk)
             except ValueError:
                 # Garbage sent, try to keep going
                 logger.warning('Cannot decode I/O command (invalid JSON)')
@@ -1448,15 +1470,15 @@
     def read(self, n: int = -1) -> Union[str, bytes]:
         """Read up to n bytes from the websocket (or one message if n<0)."""
         if self.eof:
             # Calling read() multiple times after EOF should still return EOF
             return b''
 
         while not self.remaining:
-            chunk: Union[str, bytes] = typing.cast(Union[str, bytes], self.ws.recv())
+            chunk = self.ws.recv()
 
             if isinstance(chunk, str):
                 try:
                     payload = json.loads(chunk)
                 except ValueError:
                     # Garbage sent, try to keep going
                     logger.warning('Cannot decode I/O command (invalid JSON)')
@@ -2132,14 +2154,15 @@
 
     # Exec I/O is str if encoding is provided (the default)
     @typing.overload
     def exec(  # noqa
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2153,14 +2176,15 @@
 
     # Exec I/O is bytes if encoding is explicitly set to None
     @typing.overload
     def exec(  # noqa
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2172,14 +2196,15 @@
     ) -> ExecProcess[bytes]:
         ...
 
     def exec(
         self,
         command: List[str],
         *,
+        service_context: Optional[str] = None,
         environment: Optional[Dict[str, str]] = None,
         working_dir: Optional[str] = None,
         timeout: Optional[float] = None,
         user_id: Optional[int] = None,
         user: Optional[str] = None,
         group_id: Optional[int] = None,
         group: Optional[str] = None,
@@ -2256,14 +2281,19 @@
             ''
             >>> exc.stderr
             "ls: cannot access 'notfound': No such file or directory\n"
 
         Args:
             command: Command to execute: the first item is the name (or path)
                 of the executable, the rest of the items are the arguments.
+            service_context: If specified, run the command in the context of
+                this service. Specifically, inherit its environment variables,
+                user/group settings, and working directory. The other exec
+                options will override the service context; ``environment``
+                will be merged on top of the service's.
             environment: Environment variables to pass to the process.
             working_dir: Working directory to run the command in. If not set,
                 Pebble uses the target user's $HOME directory (and if the user
                 argument is not set, $HOME of the user Pebble is running as).
             timeout: Timeout in seconds for the command execution, after which
                 the process will be terminated. If not specified, the
                 execution never times out.
@@ -2321,14 +2351,15 @@
                 raise TypeError('stdin must be str, bytes, or a readable file-like object')
 
         if combine_stderr and stderr is not None:
             raise ValueError('stderr must be None if combine_stderr is True')
 
         body = {
             'command': command,
+            'service-context': service_context,
             'environment': environment or {},
             'working-dir': working_dir,
             'timeout': _format_timeout(timeout) if timeout is not None else None,
             'user-id': user_id,
             'user': user,
             'group-id': group_id,
             'group': group,
```

### Comparing `ops-2.4.1/ops/storage.py` & `ops-2.5.0/ops/storage.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/ops/testing.py` & `ops-2.5.0/ops/testing.py`

 * *Files 4% similar despite different names*

```diff
@@ -19,30 +19,30 @@
 import datetime
 import fnmatch
 import inspect
 import ipaddress
 import os
 import pathlib
 import random
+import shutil
 import signal
 import tempfile
 import uuid
 import warnings
 from contextlib import contextmanager
-from io import BytesIO, StringIO
+from io import BytesIO, IOBase, StringIO
 from textwrap import dedent
 from typing import (
     TYPE_CHECKING,
     Any,
     AnyStr,
     BinaryIO,
     Dict,
     Generic,
     Iterable,
-    Iterator,
     List,
     Literal,
     Mapping,
     Optional,
     Set,
     TextIO,
     Tuple,
@@ -51,24 +51,23 @@
     Union,
     cast,
 )
 
 from ops import charm, framework, model, pebble, storage
 from ops._private import yaml
 from ops.charm import CharmBase, CharmMeta, RelationRole
-from ops.model import RelationNotFoundError
+from ops.model import Container, RelationNotFoundError
 
 if TYPE_CHECKING:
     from typing_extensions import TypedDict
 
     from ops.model import _NetworkDict
 
     ReadableBuffer = Union[bytes, str, StringIO, BytesIO, BinaryIO]
     _StringOrPath = Union[str, pathlib.PurePosixPath, pathlib.Path]
-    _FileOrDir = Union['_File', '_Directory']
     _FileKwargs = TypedDict('_FileKwargs', {
         'permissions': Optional[int],
         'last_modified': datetime.datetime,
         'user_id': Optional[int],
         'user': Optional[str],
         'group_id': Optional[int],
         'group': Optional[str],
@@ -386,65 +385,110 @@
         """Called by your test infrastructure to clean up any temporary directories/files/etc.
 
         You should always call ``self.addCleanup(harness.cleanup)`` after creating a
         :class:`Harness`.
         """
         self._backend._cleanup()
 
-    def _create_meta(self, charm_metadata: Optional[YAMLStringOrFile],
-                     action_metadata: Optional[YAMLStringOrFile]) -> CharmMeta:
+    def _create_meta(self, charm_metadata_yaml: Optional[YAMLStringOrFile],
+                     action_metadata_yaml: Optional[YAMLStringOrFile]) -> CharmMeta:
         """Create a CharmMeta object.
 
         Handle the cases where a user doesn't supply explicit metadata snippets.
+        This will try to load metadata from ``<charm_dir>/charmcraft.yaml`` first, then
+        ``<charm_dir>/metadata.yaml`` if charmcraft.yaml does not include metadata,
+        and ``<charm_dir>/actions.yaml`` if charmcraft.yaml does not include actions.
         """
         filename = inspect.getfile(self._charm_cls)
         charm_dir = pathlib.Path(filename).parents[1]
 
+        charm_metadata: Optional[Dict[str, Any]] = None
+        charmcraft_metadata: Optional[Dict[str, Any]] = None
+        # Check charmcraft.yaml and load it if it exists
+        charmcraft_meta = charm_dir / "charmcraft.yaml"
+        if charmcraft_meta.is_file():
+            self._charm_dir = charm_dir
+            charmcraft_metadata = yaml.safe_load(charmcraft_meta.read_text())
+
+        # Load metadata from parameters if provided
+        if charm_metadata_yaml is not None:
+            if isinstance(charm_metadata_yaml, str):
+                charm_metadata_yaml = dedent(charm_metadata_yaml)
+            charm_metadata = yaml.safe_load(charm_metadata_yaml)
+        else:
+            # Check charmcraft.yaml for metadata if no metadata is provided
+            if charmcraft_metadata is not None:
+                meta_keys = ["name", "summary", "description"]
+                if any(key in charmcraft_metadata for key in meta_keys):
+                    # Unrelated keys in the charmcraft.yaml file will be ignored.
+                    charm_metadata = charmcraft_metadata
+
+            # Still no metadata, check metadata.yaml
+            if charm_metadata is None:
+                metadata_path = charm_dir / 'metadata.yaml'
+                if metadata_path.is_file():
+                    charm_metadata = yaml.safe_load(metadata_path.read_text())
+                    self._charm_dir = charm_dir
+
+        # Use default metadata if metadata is not found
         if charm_metadata is None:
-            metadata_path = charm_dir / 'metadata.yaml'
-            if metadata_path.is_file():
-                charm_metadata = metadata_path.read_text()
-                self._charm_dir = charm_dir
-            else:
-                # The simplest of metadata that the framework can support
-                charm_metadata = 'name: test-charm'
-        elif isinstance(charm_metadata, str):
-            charm_metadata = dedent(charm_metadata)
-
-        if action_metadata is None:
-            actions_path = charm_dir / 'actions.yaml'
-            if actions_path.is_file():
-                action_metadata = actions_path.read_text()
-                self._charm_dir = charm_dir
-        elif isinstance(action_metadata, str):
-            action_metadata = dedent(action_metadata)
+            charm_metadata = {"name": "test-charm"}
+
+        action_metadata: Optional[Dict[str, Any]] = None
+        # Load actions from parameters if provided
+        if action_metadata_yaml is not None:
+            if isinstance(action_metadata_yaml, str):
+                action_metadata_yaml = dedent(action_metadata_yaml)
+            action_metadata = yaml.safe_load(action_metadata_yaml)
+        else:
+            # Check charmcraft.yaml for actions if no actions are provided
+            if charmcraft_metadata is not None and "actions" in charmcraft_metadata:
+                action_metadata = charmcraft_metadata["actions"]
+
+            # Still no actions, check actions.yaml
+            if action_metadata is None:
+                actions_path = charm_dir / 'actions.yaml'
+                if actions_path.is_file():
+                    action_metadata = yaml.safe_load(actions_path.read_text())
+                    self._charm_dir = charm_dir
 
-        return CharmMeta.from_yaml(charm_metadata, action_metadata)
+        return CharmMeta(charm_metadata, action_metadata)
 
-    def _get_config(self, charm_config: Optional['YAMLStringOrFile']):
+    def _get_config(self, charm_config_yaml: Optional['YAMLStringOrFile']):
         """If the user passed a config to Harness, use it.
 
-        Otherwise, attempt to load one from charm_dir/config.yaml.
+        Otherwise try to load config from ``<charm_dir>/charmcraft.yaml`` first, then
+        ``<charm_dir>/config.yaml`` if charmcraft.yaml does not include config.
         """
         filename = inspect.getfile(self._charm_cls)
         charm_dir = pathlib.Path(filename).parents[1]
+        config: Optional[Dict[str, Any]] = None
 
-        if charm_config is None:
-            config_path = charm_dir / 'config.yaml'
-            if config_path.is_file():
-                charm_config = config_path.read_text()
-                self._charm_dir = charm_dir
-            else:
-                # The simplest of config that the framework can support
-                charm_config = '{}'
-        elif isinstance(charm_config, str):
-            charm_config = dedent(charm_config)
-
-        assert isinstance(charm_config, str)  # type guard
-        config = yaml.safe_load(charm_config)
+        # Load config from parameters if provided
+        if charm_config_yaml is not None:
+            if isinstance(charm_config_yaml, str):
+                charm_config_yaml = dedent(charm_config_yaml)
+            config = yaml.safe_load(charm_config_yaml)
+        else:
+            # Check charmcraft.yaml for config if no config is provided
+            charmcraft_meta = charm_dir / "charmcraft.yaml"
+            if charmcraft_meta.is_file():
+                charmcraft_metadata: Dict[str, Any] = yaml.safe_load(charmcraft_meta.read_text())
+                config = charmcraft_metadata.get("config")
+
+            # Still no config, check config.yaml
+            if config is None:
+                config_path = charm_dir / 'config.yaml'
+                if config_path.is_file():
+                    config = yaml.safe_load(config_path.read_text())
+                    self._charm_dir = charm_dir
+
+            # Use default config if config is not found
+            if config is None:
+                config = {}
 
         if not isinstance(config, dict):
             raise TypeError(config)
         return cast('RawConfig', config)
 
     def add_oci_resource(self, resource_name: str,
                          contents: Optional[Mapping[str, str]] = None) -> None:
@@ -548,14 +592,17 @@
                     *, attach: bool = False) -> List[str]:
         """Create a new storage device and attach it to this unit.
 
         To have repeatable tests, each device will be initialized with
         location set to /[tmpdir]/<storage_name>N, where N is the counter and
         will be a number from [0,total_num_disks-1].
 
+        The test harness uses symbolic links to imitate storage mounts, which may lead to some
+        inconsistencies compared to the actual charm.
+
         Args:
             storage_name: The storage backend name on the Charm
             count: Number of disks being added
             attach: True to also attach the storage mount and emit storage-attached if
                 harness.begin() has been called.
 
         Return:
@@ -600,14 +647,18 @@
     def attach_storage(self, storage_id: str) -> None:
         """Attach a storage device.
 
         The intent of this function is to simulate a ``juju attach-storage`` call.
         It will trigger a storage-attached hook if the storage unit in question exists
         and is presently marked as detached.
 
+        The test harness uses symbolic links to imitate storage mounts, which may lead to some
+        inconsistencies compared to the actual charm. Users should be cognizant of
+        this potential discrepancy.
+
         Args:
             storage_id: The full storage ID of the storage unit being attached, including the
                 storage key, e.g. my-storage/0.
         """
         if not self._backend._storage_attach(storage_id):
             return  # storage was already attached
         if not self._charm or not self._hooks_enabled:
@@ -1425,14 +1476,78 @@
                 label is used.
         """
         secret = self._ensure_secret(secret_id)
         if label is None:
             label = secret.label
         self.charm.on.secret_expired.emit(secret_id, label, revision)
 
+    def get_filesystem_root(self, container: Union[str, Container]) -> pathlib.Path:
+        """Return the temp directory path harness will use to simulate the container filesystem.
+
+        In a real container runtime, each container has an isolated root filesystem.
+        To simulate this behaviour, the testing harness manages a temporary directory for
+        each container. Any Pebble filesystem API calls will be translated
+        and mapped to this directory, as if the directory was the container's
+        filesystem root.
+
+        This process is quite similar to the ``chroot`` command. Charm tests should
+        treat the returned directory as the container's root directory (``/``).
+        The testing harness will not create any files or directories inside the
+        simulated container's root directory; it's up to the test to populate the container's
+        root directory with any files or directories the charm needs.
+
+        Regarding the file ownership: unprivileged users are unable to create files with distinct
+        ownership. To circumvent this limitation, the testing harness maps all user and group
+        options related to file operations to match the current user and group.
+
+        Example usage::
+
+            # charm.py
+            import ops
+            class ExampleCharm(ops.CharmBase):
+                def __init__(self, *args):
+                    super().__init__(*args)
+                    self.hostname = open("/etc/hostname").read()
+
+            # test_charm.py
+            from ops.testing import Harness
+            harness = Harness(ExampleCharm)
+            root = harness.get_filesystem_root("mycontainer")
+            (root / "etc" / "hostname").write_text("hostname.example.com")
+            harness.begin()
+
+        Args:
+            container: The name of the container or the container instance.
+
+        Return:
+            The path of the temporary directory associated with the specified container.
+        """
+        # it's okay to access the container directly in this context, as its creation has already
+        # been ensured during the model's initialization.
+        if isinstance(container, str):
+            container_name = container
+        else:
+            container_name = container.name
+        return self._backend._pebble_clients[container_name]._root
+
+    def evaluate_status(self) -> None:
+        """Trigger the collect-status events and set application and/or unit status.
+
+        This will always trigger ``collect_unit_status``, and set the unit status if any
+        statuses were added.
+
+        If running on the leader unit (:meth:`set_leader` has been called with ``True``),
+        this will trigger ``collect_app_status``, and set the application status if any
+        statuses were added.
+
+        Tests should normally call this and then assert that ``self.model.app.status``
+        or ``self.model.unit.status`` is the value expected.
+        """
+        charm._evaluate_status(self.charm)
+
 
 def _get_app_or_unit_name(app_or_unit: AppUnitOrName) -> str:
     """Return name of given application or unit (return strings directly)."""
     if isinstance(app_or_unit, model.Application):
         return app_or_unit.name
     elif isinstance(app_or_unit, model.Unit):
         return app_or_unit.name
@@ -1597,14 +1712,18 @@
     def __init__(self, unit_name: str, meta: charm.CharmMeta, config: 'RawConfig'):
         self.unit_name = unit_name
         self.app_name = self.unit_name.split('/')[0]
         self.model_name = None
         self.model_uuid = str(uuid.uuid4())
 
         self._harness_tmp_dir = tempfile.TemporaryDirectory(prefix='ops-harness-')
+        self._harness_storage_path = pathlib.Path(self._harness_tmp_dir.name) / "storages"
+        self._harness_container_path = pathlib.Path(self._harness_tmp_dir.name) / "containers"
+        self._harness_storage_path.mkdir()
+        self._harness_container_path.mkdir()
         # this is used by the _record_calls decorator
         self._calls: List[Tuple[Any, ...]] = []
         self._meta = meta
         # relation name to [relation_ids,...]
         self._relation_ids_map: Dict[str, List[int]] = {}
         # reverse map from relation_id to relation_name
         self._relation_names: Dict[int, str] = {}
@@ -1832,27 +1951,31 @@
         if name not in self._storage_list:
             self._storage_list[name] = {}
         result: List[int] = []
         for _ in range(count):
             index = self._storage_index_counter
             self._storage_index_counter += 1
             self._storage_list[name][index] = {
-                'location': os.path.join(self._harness_tmp_dir.name, name, str(index)),
+                'location': os.path.join(self._harness_storage_path, name, str(index)),
             }
             result.append(index)
         return result
 
     def _storage_detach(self, storage_id: str):
         # NOTE: This is an extra function for _TestingModelBackend to simulate
         # detachment of a storage unit.  This is not present in ops.model._ModelBackend.
         name, index = storage_id.split('/', 1)
         index = int(index)
 
-        for client in self._pebble_clients.values():
-            client._fs.remove_mount(name)
+        for container, client in self._pebble_clients.items():
+            for _, mount in self._meta.containers[container].mounts.items():
+                if mount.storage != name:
+                    continue
+                root = client._root
+                (root / mount.location[1:]).unlink()
 
         if self._storage_is_attached(name, index):
             self._storage_attached[name].remove(index)
 
     def _storage_attach(self, storage_id: str):
         """Mark the named storage_id as attached and return True if it was previously detached."""
         # NOTE: This is an extra function for _TestingModelBackend to simulate
@@ -1861,16 +1984,20 @@
         name, index = storage_id.split('/', 1)
 
         for container, client in self._pebble_clients.items():
             for _, mount in self._meta.containers[container].mounts.items():
                 if mount.storage != name:
                     continue
                 for index, store in self._storage_list[mount.storage].items():
-                    fs = client._fs
-                    fs.add_mount(mount.storage, mount.location, store['location'])
+                    root = client._root
+                    mounting_dir = root / mount.location[1:]
+                    mounting_dir.parent.mkdir(parents=True, exist_ok=True)
+                    target_dir = pathlib.Path(store["location"])
+                    target_dir.mkdir(parents=True, exist_ok=True)
+                    mounting_dir.symlink_to(target_dir)
 
         index = int(index)
         if not self._storage_is_attached(name, index):
             self._storage_attached[name].add(index)
             return True
         return False
 
@@ -1923,16 +2050,17 @@
     def juju_log(self, level, msg):  # type:ignore
         raise NotImplementedError(self.juju_log)  # type:ignore
 
     def get_pebble(self, socket_path: str) -> '_TestingPebbleClient':
         container = socket_path.split('/')[3]  # /charm/containers/<container_name>/pebble.socket
         client = self._pebble_clients.get(container, None)
         if client is None:
-            client = _TestingPebbleClient(self)
-            self._pebble_clients[container] = client
+            container_root = self._harness_container_path / container
+            container_root.mkdir()
+            client = _TestingPebbleClient(self, container_root=container_root)
 
             # we need to know which container a new pebble client belongs to
             # so we can figure out which storage mounts must be simulated on
             # this pebble client's mock file systems when storage is
             # attached/detached later.
             self._pebble_clients[container] = client
 
@@ -2198,20 +2326,20 @@
     """This conforms to the interface for pebble.Client but provides canned data.
 
     DO NOT use this class directly, it is used by `Harness`_ to run interactions with Pebble.
     `Harness`_ is responsible for maintaining the internal consistency of the values here,
     as the only public methods of this type are for implementing Client.
     """
 
-    def __init__(self, backend: _TestingModelBackend):
+    def __init__(self, backend: _TestingModelBackend, container_root: pathlib.Path):
         self._backend = _TestingModelBackend
         self._layers: Dict[str, pebble.Layer] = {}
         # Has a service been started/stopped?
         self._service_status: Dict[str, pebble.ServiceStatus] = {}
-        self._fs = _TestingFilesystem()
+        self._root = container_root
         self._backend = backend
 
     def _check_connection(self):
         if not self._backend._can_connect(self):
             msg = ('Cannot connect to Pebble; did you forget to call '
                    'begin_with_initial_hooks() or set_can_connect()?')
             raise pebble.ConnectionError(msg)
@@ -2407,19 +2535,31 @@
                 startup = pebble.ServiceStartup(service.startup)
             info = pebble.ServiceInfo(name,
                                       startup=startup,
                                       current=pebble.ServiceStatus(status))
             infos.append(info)
         return infos
 
+    @staticmethod
+    def _check_absolute_path(path: str):
+        if not path.startswith("/"):
+            raise pebble.PathError(
+                'generic-file-error',
+                f'paths must be absolute, got {path!r}'
+            )
+
     def pull(self, path: str, *,
              encoding: str = 'utf-8') -> Union[BinaryIO, TextIO]:
         self._check_connection()
+        self._check_absolute_path(path)
+        file_path = self._root / path[1:]
         try:
-            return self._fs.open(path, encoding=encoding)
+            return cast(
+                Union[BinaryIO, TextIO],
+                file_path.open("rb" if encoding is None else "r", encoding=encoding))
         except FileNotFoundError:
             raise pebble.PathError('not-found', f'stat {path}: no such file or directory')
         except IsADirectoryError:
             raise pebble.PathError('generic-file-error', f'can only read a regular file: "{path}"')
 
     def push(
             self, path: str, source: 'ReadableBuffer', *,
@@ -2430,74 +2570,72 @@
             group: Optional[str] = None
     ) -> None:
         self._check_connection()
         if permissions is not None and not (0 <= permissions <= 0o777):
             raise pebble.PathError(
                 'generic-file-error',
                 f'permissions not within 0o000 to 0o777: {permissions:#o}')
+        self._check_absolute_path(path)
+        file_path = self._root / path[1:]
+        if make_dirs and not file_path.parent.exists():
+            self.make_dir(
+                os.path.dirname(path),
+                make_parents=True,
+                permissions=None,
+                user_id=user_id,
+                user=user,
+                group_id=group_id,
+                group=group)
+        permissions = permissions if permissions is not None else 0o644
         try:
-            self._fs.create_file(
-                path, source, encoding=encoding, make_dirs=make_dirs, permissions=permissions,
-                user_id=user_id, user=user, group_id=group_id, group=group)
+            if isinstance(source, str):
+                file_path.write_text(source, encoding=encoding)
+            elif isinstance(source, bytes):
+                file_path.write_bytes(source)
+            else:
+                with file_path.open('wb' if encoding is None else 'w', encoding=encoding) as f:
+                    shutil.copyfileobj(cast(IOBase, source), cast(IOBase, f))
+            os.chmod(file_path, permissions)
         except FileNotFoundError as e:
             raise pebble.PathError(
                 'not-found', f'parent directory not found: {e.args[0]}')
-        except NonAbsolutePathError as e:
-            raise pebble.PathError(
-                'generic-file-error',
-                f'paths must be absolute, got {e.args[0]!r}'
-            )
+        except NotADirectoryError:
+            raise pebble.PathError('generic-file-error',
+                                   f'open {path}.~: not a directory')
 
     def list_files(self, path: str, *, pattern: Optional[str] = None,
                    itself: bool = False) -> List[pebble.FileInfo]:
         self._check_connection()
-        try:
-            files = [self._fs.get_path(path)]
-        except FileNotFoundError:
-            # conform with the real pebble api
+        self._check_absolute_path(path)
+        file_path = self._root / path[1:]
+        if not file_path.exists():
             raise pebble.APIError(
                 body={}, code=404, status='Not Found',
                 message=f"stat {path}: no such file or directory")
-
+        files = [file_path]
         if not itself:
             try:
-                files = self._fs.list_dir(path)
+                files = [file_path / file for file in os.listdir(file_path)]
             except NotADirectoryError:
                 pass
 
         if pattern is not None:
             files = [file for file in files if fnmatch.fnmatch(file.name, pattern)]
 
-        type_mappings = {
-            _File: pebble.FileType.FILE,
-            _Directory: pebble.FileType.DIRECTORY,
-        }
-
-        def get_pebble_file_type(file: '_FileOrDir') -> pebble.FileType:
-            pebble_type = type_mappings.get(type(file))
-            if not pebble_type:
-                raise ValueError(
-                    f'unable to convert file {file} (type not one of {type_mappings})')
-            return pebble_type
-
-        return [
-            pebble.FileInfo(
-                path=str(file.path),
-                name=file.name,
-                type=get_pebble_file_type(file),
-                size=file.size if isinstance(file, _File) else None,
-                permissions=file.kwargs.get('permissions') or 0,
-                last_modified=file.last_modified,
-                user_id=file.kwargs.get('user_id'),
-                user=file.kwargs.get('user'),
-                group_id=file.kwargs.get('group_id'),
-                group=file.kwargs.get('group'),
-            )
+        file_infos = [
+            Container._build_fileinfo(file)
             for file in files
         ]
+        for file_info in file_infos:
+            rel_path = os.path.relpath(file_info.path, start=self._root)
+            rel_path = '/' if rel_path == '.' else '/' + rel_path
+            file_info.path = rel_path
+            if rel_path == "/":
+                file_info.name = "/"
+        return file_infos
 
     def make_dir(
             self, path: str, *,
             make_parents: bool = False,
             permissions: Optional[int] = None,
             user_id: Optional[int] = None,
             user: Optional[str] = None,
@@ -2505,46 +2643,60 @@
             group: Optional[str] = None
     ) -> None:
         self._check_connection()
         if permissions is not None and not (0 <= permissions <= 0o777):
             raise pebble.PathError(
                 'generic-file-error',
                 f'permissions not within 0o000 to 0o777: {permissions:#o}')
-        try:
-            self._fs.create_dir(
-                path, make_parents=make_parents, permissions=permissions,
-                user_id=user_id, user=user, group_id=group_id, group=group)
-        except FileNotFoundError as e:
-            # Parent directory doesn't exist and make_parents is False
+        self._check_absolute_path(path)
+        dir_path = self._root / path[1:]
+        if not dir_path.parent.exists() and not make_parents:
             raise pebble.PathError(
-                'not-found', f'parent directory not found: {e.args[0]}')
+                'not-found', f'parent directory not found: {path}')
+        if not dir_path.parent.exists() and make_parents:
+            self.make_dir(
+                os.path.dirname(path),
+                make_parents=True,
+                permissions=permissions,
+                user_id=user_id,
+                user=user,
+                group_id=group_id,
+                group=group)
+        try:
+            permissions = permissions if permissions else 0o755
+            dir_path.mkdir()
+            os.chmod(dir_path, permissions)
+        except FileExistsError:
+            if not make_parents:
+                raise pebble.PathError('generic-file-error', f'mkdir {path}: file exists')
         except NotADirectoryError as e:
             # Attempted to create a subdirectory of a file
             raise pebble.PathError('generic-file-error', f'not a directory: {e.args[0]}')
-        except NonAbsolutePathError as e:
-            raise pebble.PathError(
-                'generic-file-error',
-                f'paths must be absolute, got {e.args[0]!r}'
-            )
 
     def remove_path(self, path: str, *, recursive: bool = False):
         self._check_connection()
-        try:
-            file_or_dir = self._fs.get_path(path)
-        except FileNotFoundError:
+        self._check_absolute_path(path)
+        file_path = self._root / path[1:]
+        if not file_path.exists():
             if recursive:
-                # Pebble doesn't give not-found error when recursive is specified
                 return
             raise pebble.PathError(
                 'not-found', f'remove {path}: no such file or directory')
-
-        if isinstance(file_or_dir, _Directory) and len(file_or_dir) > 0 and not recursive:
-            raise pebble.PathError(
-                'generic-file-error', 'cannot remove non-empty directory without recursive=True')
-        self._fs.delete_path(path)
+        if file_path.is_dir():
+            if recursive:
+                shutil.rmtree(file_path)
+            else:
+                try:
+                    file_path.rmdir()
+                except OSError:
+                    raise pebble.PathError(
+                        'generic-file-error',
+                        'cannot remove non-empty directory without recursive=True')
+        else:
+            file_path.unlink()
 
     def exec(self, command, **kwargs):  # type:ignore
         raise NotImplementedError(self.exec)  # type:ignore
 
     def send_signal(self, sig: Union[int, str], service_names: Iterable[str]):
         if not service_names:
             raise TypeError('send_signal expected at least 1 service name, got 0')
@@ -2580,391 +2732,7 @@
                 body=body,
                 code=500,
                 status='Internal Server Error',
                 message=message)
 
     def get_checks(self, level=None, names=None):  # type:ignore
         raise NotImplementedError(self.get_checks)  # type:ignore
-
-
-class NonAbsolutePathError(Exception):
-    """Error raised by _TestingFilesystem.
-
-    This error is raised when an absolute path is required but the code instead encountered a
-    relative path.
-    """
-
-
-class _TestingStorageMount:
-    """Simulates a filesystem backend for storage mounts."""
-
-    def __init__(self, location: pathlib.PurePosixPath, src: pathlib.Path):
-        """Creates a new simulated storage mount.
-
-        Args:
-            location: The path within simulated filesystem at which this storage will be mounted.
-            src: The temporary on-disk location where the simulated storage will live.
-        """
-        self._src = src
-        self._location = location
-
-        src.mkdir(exist_ok=True, parents=True)
-
-    def contains(self, path: '_StringOrPath') -> bool:
-        """Returns true whether path resides within this simulated storage mount's location."""
-        try:
-            pathlib.PurePosixPath(path).relative_to(self._location)
-            return True
-        except Exception:
-            return False
-
-    def check_contains(self, path: '_StringOrPath') -> pathlib.PurePosixPath:
-        """Raises if path does not reside within this simulated storage mount's location."""
-        if not self.contains(path):
-            msg = 'the provided path "{!s}" does not reside within the mount location "{!s}"' \
-                .format(path, self._location)
-            raise RuntimeError(msg)
-        return pathlib.PurePosixPath(path)
-
-    def _srcpath(self, path: pathlib.PurePosixPath) -> pathlib.Path:
-        """Returns the disk-backed path where the simulated path will actually be stored."""
-        suffix = path.relative_to(self._location)
-        return self._src / suffix
-
-    def create_dir(
-            self,
-            path: '_StringOrPath',
-            make_parents: bool = False,
-            **kwargs: Any) -> '_Directory':
-        if not pathlib.PurePosixPath(path).is_absolute():
-            raise NonAbsolutePathError(str(path))
-        path = self.check_contains(path)
-        srcpath = self._srcpath(path)
-
-        if srcpath.exists() and srcpath.is_dir() and make_parents:
-            return _Directory(path, **kwargs)  # nothing to do
-        if srcpath.exists():
-            raise FileExistsError(str(path))
-
-        dirname = srcpath.parent
-        if not dirname.exists():
-            if not make_parents:
-                raise FileNotFoundError(str(path.parent))
-            dirname.mkdir(parents=True, exist_ok=True)
-        srcpath.mkdir(exist_ok=True)
-        return _Directory(path, **kwargs)
-
-    def create_file(
-            self,
-            path: '_StringOrPath',
-            data: 'ReadableBuffer',
-            encoding: str = 'utf-8',
-            make_dirs: bool = False,
-            **kwargs: Any
-    ) -> '_File':
-        posixpath: pathlib.PurePosixPath = self.check_contains(path)
-        srcpath = self._srcpath(posixpath)
-
-        dirname = srcpath.parent
-        if not dirname.exists():
-            if not make_dirs:
-                raise FileNotFoundError(str(posixpath.parent))
-            dirname.mkdir(parents=True, exist_ok=True)
-
-        if isinstance(data, str):
-            data = data.encode(encoding=encoding)
-        elif isinstance(data, (StringIO, BytesIO)):
-            data = data.getvalue()
-            if isinstance(data, str):
-                data = data.encode()
-
-        byte_data = cast(bytes, data)
-
-        with srcpath.open('wb') as f:
-            f.write(byte_data)
-
-        return _File(posixpath, byte_data, encoding=encoding, **kwargs)
-
-    def list_dir(self, path: '_StringOrPath') -> List['_FileOrDir']:
-        _path = self.check_contains(path)
-        srcpath = self._srcpath(_path)
-
-        results: List[_FileOrDir] = []
-        if not srcpath.exists():
-            raise FileNotFoundError(str(_path))
-        if not srcpath.is_dir():
-            raise NotADirectoryError(str(_path))
-        for fpath in srcpath.iterdir():
-            mountpath = _path / fpath.name
-            if fpath.is_dir():
-                results.append(_Directory(mountpath))
-            elif fpath.is_file():
-                with fpath.open('rb') as f:
-                    results.append(_File(mountpath, f.read()))
-            else:
-                raise RuntimeError(f'unsupported file type at path {fpath}')
-        return results
-
-    def open(
-            self,
-            path: '_StringOrPath',
-            encoding: Optional[str] = 'utf-8',
-    ) -> Union[BinaryIO, TextIO]:
-        path = self.check_contains(path)
-
-        file = self.get_path(path)
-        if isinstance(file, _Directory):
-            raise IsADirectoryError(str(file.path))
-        return file.open(encoding=encoding)
-
-    def get_path(self, path: '_StringOrPath') -> '_FileOrDir':
-        path = self.check_contains(path)
-        srcpath = self._srcpath(path)
-        if srcpath.is_dir():
-            return _Directory(path)
-        if not srcpath.exists():
-            raise FileNotFoundError(str(path))
-        with srcpath.open('rb') as f:
-            return _File(path, f.read())
-
-    def delete_path(self, path: '_StringOrPath') -> None:
-        path = self.check_contains(path)
-        srcpath = self._srcpath(path)
-        if srcpath.exists():
-            srcpath.unlink()
-        else:
-            raise FileNotFoundError(str(path))
-
-
-class _TestingFilesystem:
-    r"""An in-memory mock of a pebble-controlled container's filesystem.
-
-    For now, the filesystem is assumed to be a POSIX-style filesystem; Windows-style directories
-    (e.g. \, \foo\bar, C:\foo\bar) are not supported.
-    """
-
-    def __init__(self):
-        self.root = _Directory(pathlib.PurePosixPath('/'))
-        self._mounts: Dict[str, _TestingStorageMount] = {}
-
-    def add_mount(self, name: str, mount_path: Union[str, pathlib.Path],
-                  backing_src_path: Union[str, pathlib.Path]):
-        self._mounts[name] = _TestingStorageMount(
-            pathlib.PurePosixPath(mount_path), pathlib.Path(backing_src_path))
-
-    def remove_mount(self, name: str):
-        if name in self._mounts:
-            del self._mounts[name]
-
-    def create_dir(self, path: str, make_parents: bool = False, **kwargs: Any) -> '_Directory':
-        if not path.startswith('/'):
-            raise NonAbsolutePathError(path)
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.create_dir(path, make_parents, **kwargs)
-        current_dir = self.root
-        tokens = pathlib.PurePosixPath(path).parts[1:]
-        for token in tokens[:-1]:
-            if token in current_dir:
-                current_dir = current_dir[token]
-            else:
-                if make_parents:
-                    # NOTE: other parameters (e.g. ownership, permissions) only get applied to the
-                    # final directory.
-                    # (At the time of writing, Pebble defaults to 0o755 permissions and root:root
-                    # ownership.)
-                    current_dir = current_dir.create_dir(token)
-                else:
-                    raise FileNotFoundError(str(current_dir.path / token))
-            if isinstance(current_dir, _File):
-                raise NotADirectoryError(str(current_dir.path))
-
-        # Current backend will always raise an error if the final directory component
-        # already exists.
-        token = tokens[-1]
-        if token not in current_dir:
-            current_dir = current_dir.create_dir(token, **kwargs)
-        else:
-            # If 'make_parents' is specified, behave like 'mkdir -p' and ignore if the dir already
-            # exists.
-            if make_parents:
-                current_dir = _Directory(current_dir.path / token)
-            else:
-                raise FileExistsError(str(current_dir.path / token))
-        return current_dir
-
-    def create_file(
-            self,
-            path: str,
-            data: 'ReadableBuffer',
-            encoding: str = 'utf-8',
-            make_dirs: bool = False,
-            **kwargs: Any
-    ) -> '_File':
-        if not path.startswith('/'):
-            raise NonAbsolutePathError(path)
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.create_file(path, data, encoding, make_dirs, **kwargs)
-        path_obj = pathlib.PurePosixPath(path)
-        try:
-            dir_ = self.get_path(path_obj.parent)
-        except FileNotFoundError:
-            if make_dirs:
-                dir_ = self.create_dir(str(path_obj.parent), make_parents=make_dirs)
-                # NOTE: other parameters (e.g. ownership, permissions) only get applied to the
-                # final directory.
-                # (At the time of writing, Pebble defaults to the specified permissions and
-                # root:root ownership, which is inconsistent with the push function's
-                # behavior for parent directories.)
-            else:
-                raise
-        if not isinstance(dir_, _Directory):
-            raise pebble.PathError(
-                'generic-file-error', f'parent is not a directory: {str(dir_)}')
-        return dir_.create_file(path_obj.name, data, encoding=encoding, **kwargs)
-
-    def list_dir(self, path: '_StringOrPath') -> List['_FileOrDir']:
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.list_dir(path)
-        current_dir = self.root
-        tokens = pathlib.PurePosixPath(path).parts[1:]
-        for token in tokens:
-            try:
-                current_dir = current_dir[token]
-            except KeyError:
-                raise FileNotFoundError(str(current_dir.path / token))
-            if isinstance(current_dir, _File):
-                raise NotADirectoryError(str(current_dir.path))
-            if not isinstance(current_dir, _Directory):  # type: ignore
-                # For now, ignoring other possible cases besides File and Directory (e.g. Symlink).
-                raise NotImplementedError()
-        return list(current_dir)
-
-    def open(
-            self,
-            path: '_StringOrPath',
-            encoding: Optional[str] = 'utf-8',
-    ) -> Union[BinaryIO, TextIO]:
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.open(path, encoding)
-        path = pathlib.PurePosixPath(path)
-        file = self.get_path(path)  # warning: no check re: directories
-        if isinstance(file, _Directory):
-            raise IsADirectoryError(str(file.path))
-        return file.open(encoding=encoding)
-
-    def get_path(self, path: '_StringOrPath') -> '_FileOrDir':
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.get_path(path)
-        path = pathlib.PurePosixPath(path)
-        tokens = path.parts[1:]
-        current_object = self.root
-        for token in tokens:
-            # ASSUMPTION / TESTME: object might be file
-            if isinstance(current_object, _File):
-                raise RuntimeError('cannot expand path {!r} from {!r}: '
-                                   'not a directory'.format(token, current_object))
-            if token in current_object:
-                current_object = current_object[token]
-            else:
-                raise FileNotFoundError(str(current_object.path / token))
-        return current_object
-
-    def delete_path(self, path: '_StringOrPath') -> None:
-        for mount in self._mounts.values():
-            if mount.contains(path):
-                return mount.delete_path(path)
-        path = pathlib.PurePosixPath(path)
-        parent_dir = self.get_path(path.parent)
-        if not isinstance(parent_dir, _Directory):
-            raise RuntimeError('cannot delete {}: parent {!r}'
-                               'is not a directory'.format(path.name, parent_dir))
-        del parent_dir[path.name]
-
-
-class _Directory:
-    def __init__(self, path: pathlib.PurePosixPath, **kwargs: Any):
-        self.path = path
-        self._children: Dict[str, Union[_Directory, _File]] = {}
-        self.last_modified = datetime.datetime.now()
-        self.kwargs = cast('_FileKwargs', kwargs)
-
-    @property
-    def name(self) -> str:
-        # Need to handle special case for root.
-        # pathlib.PurePosixPath('/').name is '', but pebble returns '/'.
-        return self.path.name if self.path.name else '/'
-
-    def __contains__(self, child: str) -> bool:
-        return child in self._children
-
-    def __iter__(self) -> Iterator['_FileOrDir']:
-        return (value for value in self._children.values())
-
-    def __getitem__(self, key: str) -> '_FileOrDir':
-        return self._children[key]
-
-    def __delitem__(self, key: str) -> None:
-        try:
-            del self._children[key]
-        except KeyError:
-            raise FileNotFoundError(str(self.path / key))
-
-    def __len__(self):
-        return len(self._children)
-
-    def create_dir(self, name: str, **kwargs: Any) -> '_Directory':
-        dirc = _Directory(self.path / name, **kwargs)
-        self._children[name] = dirc
-        return dirc
-
-    def create_file(
-            self,
-            name: str,
-            data: 'ReadableBuffer',
-            encoding: Optional[str] = 'utf-8',
-            **kwargs: Any
-    ) -> '_File':
-        file = _File(self.path / name, data, encoding=encoding, **kwargs)
-        self._children[name] = file
-        return file
-
-
-class _File:
-    def __init__(
-            self,
-            path: pathlib.PurePosixPath,
-            data: 'ReadableBuffer',
-            encoding: Optional[str] = 'utf-8',
-            **kwargs: Any):
-
-        if hasattr(data, 'read'):  # if BytesIO/StringIO:
-            data = data.read()  # type: ignore
-        if isinstance(data, str):  # if str/StringIO
-            data = data.encode(encoding)  # type: ignore
-
-        byte_data = cast(bytes, data)  # it's bytes by now; pyright doesn't like redeclaring vars
-        data_size = len(byte_data)
-
-        self.path = path
-        self.data = byte_data
-        self.size = data_size
-        self.last_modified = datetime.datetime.now()
-        self.kwargs = cast('_FileKwargs', kwargs)
-
-    @property
-    def name(self) -> str:
-        return self.path.name
-
-    def open(
-            self,
-            encoding: Optional[str] = 'utf-8',
-    ) -> Union[TextIO, BinaryIO]:
-        if encoding is None:
-            return BytesIO(self.data)
-        else:
-            raw = self.data.decode(encoding)
-            return StringIO(raw)
```

### Comparing `ops-2.4.1/ops.egg-info/PKG-INFO` & `ops-2.5.0/ops.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ops
-Version: 2.4.1
+Version: 2.5.0
 Summary: The Python library behind great charms
 Home-page: https://github.com/canonical/operator
 Author: The Charmcraft team at Canonical Ltd.
 Author-email: charmcraft@lists.launchpad.net
 License: Apache-2.0
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: Apache Software License
```

### Comparing `ops-2.4.1/ops.egg-info/SOURCES.txt` & `ops-2.5.0/ops.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/pyproject.toml` & `ops-2.5.0/pyproject.toml`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/setup.py` & `ops-2.5.0/setup.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_charm.py` & `ops-2.5.0/test/test_charm.py`

 * *Files 26% similar despite different names*

```diff
@@ -15,14 +15,15 @@
 import os
 import shutil
 import tempfile
 import unittest
 from pathlib import Path
 
 import ops
+import ops.charm
 from ops.model import _ModelBackend
 from ops.storage import SQLiteStorage
 
 from .test_helpers import fake_script, fake_script_calls
 
 
 class TestCharm(unittest.TestCase):
@@ -627,7 +628,190 @@
 
         self.assertEqual(charm.seen, [
             'SecretChangedEvent',
             'SecretRotateEvent',
             'SecretRemoveEvent',
             'SecretExpiredEvent',
         ])
+
+    def test_collect_app_status_leader(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                event.add_status(ops.ActiveStatus())
+                event.add_status(ops.BlockedStatus('first'))
+                event.add_status(ops.WaitingStatus('waiting'))
+                event.add_status(ops.BlockedStatus('second'))
+
+        fake_script(self, 'is-leader', 'echo true')
+        fake_script(self, 'status-set', 'exit 0')
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+            ['status-set', '--application=True', 'blocked', 'first'],
+        ])
+
+    def test_collect_app_status_no_statuses(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                pass
+
+        fake_script(self, 'is-leader', 'echo true')
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+        ])
+
+    def test_collect_app_status_non_leader(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                raise Exception  # shouldn't be called
+
+        fake_script(self, 'is-leader', 'echo false')
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+        ])
+
+    def test_collect_unit_status(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_unit_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                event.add_status(ops.ActiveStatus())
+                event.add_status(ops.BlockedStatus('first'))
+                event.add_status(ops.WaitingStatus('waiting'))
+                event.add_status(ops.BlockedStatus('second'))
+
+        fake_script(self, 'is-leader', 'echo false')  # called only for collecting app statuses
+        fake_script(self, 'status-set', 'exit 0')
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+            ['status-set', '--application=False', 'blocked', 'first'],
+        ])
+
+    def test_collect_unit_status_no_statuses(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_unit_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                pass
+
+        fake_script(self, 'is-leader', 'echo false')  # called only for collecting app statuses
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+        ])
+
+    def test_collect_app_and_unit_status(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_app_status)
+                self.framework.observe(self.on.collect_unit_status, self._on_collect_unit_status)
+
+            def _on_collect_app_status(self, event):
+                event.add_status(ops.ActiveStatus())
+
+            def _on_collect_unit_status(self, event):
+                event.add_status(ops.WaitingStatus('blah'))
+
+        fake_script(self, 'is-leader', 'echo true')
+        fake_script(self, 'status-set', 'exit 0')
+
+        charm = MyCharm(self.create_framework())
+        ops.charm._evaluate_status(charm)
+
+        self.assertEqual(fake_script_calls(self, True), [
+            ['is-leader', '--format=json'],
+            ['status-set', '--application=True', 'active', ''],
+            ['status-set', '--application=False', 'waiting', 'blah'],
+        ])
+
+    def test_add_status_type_error(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_status)
+
+            def _on_collect_status(self, event):
+                event.add_status('active')
+
+        fake_script(self, 'is-leader', 'echo true')
+
+        charm = MyCharm(self.create_framework())
+        with self.assertRaises(TypeError):
+            ops.charm._evaluate_status(charm)
+
+    def test_collect_status_priority(self):
+        class MyCharm(ops.CharmBase):
+            def __init__(self, *args, statuses=None):
+                super().__init__(*args)
+                self.framework.observe(self.on.collect_app_status, self._on_collect_status)
+                self.statuses = statuses
+
+            def _on_collect_status(self, event):
+                for status in self.statuses:
+                    event.add_status(ops.StatusBase.from_name(status, ''))
+
+        fake_script(self, 'is-leader', 'echo true')
+        fake_script(self, 'status-set', 'exit 0')
+
+        charm = MyCharm(self.create_framework(), statuses=['blocked', 'error'])
+        ops.charm._evaluate_status(charm)
+
+        charm = MyCharm(self.create_framework(), statuses=['waiting', 'blocked'])
+        ops.charm._evaluate_status(charm)
+
+        charm = MyCharm(self.create_framework(), statuses=['waiting', 'maintenance'])
+        ops.charm._evaluate_status(charm)
+
+        charm = MyCharm(self.create_framework(), statuses=['active', 'waiting'])
+        ops.charm._evaluate_status(charm)
+
+        charm = MyCharm(self.create_framework(), statuses=['active', 'unknown'])
+        ops.charm._evaluate_status(charm)
+
+        charm = MyCharm(self.create_framework(), statuses=['unknown'])
+        ops.charm._evaluate_status(charm)
+
+        status_set_calls = [call for call in fake_script_calls(self, True)
+                            if call[0] == 'status-set']
+        self.assertEqual(status_set_calls, [
+            ['status-set', '--application=True', 'error', ''],
+            ['status-set', '--application=True', 'blocked', ''],
+            ['status-set', '--application=True', 'maintenance', ''],
+            ['status-set', '--application=True', 'waiting', ''],
+            ['status-set', '--application=True', 'active', ''],
+            ['status-set', '--application=True', 'unknown', ''],
+        ])
```

### Comparing `ops-2.4.1/test/test_framework.py` & `ops-2.5.0/test/test_framework.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_helpers.py` & `ops-2.5.0/test/test_helpers.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_infra.py` & `ops-2.5.0/test/test_infra.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_jujuversion.py` & `ops-2.5.0/test/test_jujuversion.py`

 * *Files 17% similar despite different names*

```diff
@@ -65,18 +65,36 @@
         self.assertFalse(ops.JujuVersion('2.7.9').is_dispatch_aware())
 
     def test_has_controller_storage(self):
         self.assertTrue(ops.JujuVersion('2.8.0').has_controller_storage())
         self.assertFalse(ops.JujuVersion('2.7.9').has_controller_storage())
 
     def test_has_secrets(self):
-        self.assertTrue(ops.JujuVersion('3.0.2').has_secrets)
-        self.assertFalse(ops.JujuVersion('3.0.1').has_secrets)
+        self.assertTrue(ops.JujuVersion('3.0.3').has_secrets)
+        self.assertTrue(ops.JujuVersion('3.1.0').has_secrets)
+        self.assertFalse(ops.JujuVersion('3.0.2').has_secrets)
         self.assertFalse(ops.JujuVersion('2.9.30').has_secrets)
 
+    def test_supports_open_port_on_k8s(self):
+        self.assertTrue(ops.JujuVersion('3.0.3').supports_open_port_on_k8s)
+        self.assertTrue(ops.JujuVersion('3.3.0').supports_open_port_on_k8s)
+        self.assertFalse(ops.JujuVersion('3.0.2').supports_open_port_on_k8s)
+        self.assertFalse(ops.JujuVersion('2.9.30').supports_open_port_on_k8s)
+
+    def test_supports_exec_service_context(self):
+        self.assertFalse(ops.JujuVersion('2.9.30').supports_exec_service_context)
+        self.assertTrue(ops.JujuVersion('4.0.0').supports_exec_service_context)
+        self.assertFalse(ops.JujuVersion('3.0.0').supports_exec_service_context)
+        self.assertFalse(ops.JujuVersion('3.1.5').supports_exec_service_context)
+        self.assertTrue(ops.JujuVersion('3.1.6').supports_exec_service_context)
+        self.assertFalse(ops.JujuVersion('3.2.0').supports_exec_service_context)
+        self.assertTrue(ops.JujuVersion('3.2.2').supports_exec_service_context)
+        self.assertTrue(ops.JujuVersion('3.3.0').supports_exec_service_context)
+        self.assertTrue(ops.JujuVersion('3.4.0').supports_exec_service_context)
+
     def test_parsing_errors(self):
         invalid_versions = [
             "xyz",
             "foo.bar",
             "foo.bar.baz",
             "dead.beef.ca.fe",
             "1234567890.2.1",     # The major version is too long.
```

### Comparing `ops-2.4.1/test/test_lib.py` & `ops-2.5.0/test/test_lib.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_log.py` & `ops-2.5.0/test/test_log.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_main.py` & `ops-2.5.0/test/test_main.py`

 * *Files 2% similar despite different names*

```diff
@@ -13,14 +13,15 @@
 # limitations under the License.
 
 import abc
 import importlib.util
 import io
 import logging
 import os
+import re
 import shutil
 import subprocess
 import sys
 import tempfile
 import unittest
 import warnings
 from pathlib import Path
@@ -69,14 +70,16 @@
         self.workload_name = workload_name
         self.secret_id = secret_id
         self.secret_label = secret_label
         self.secret_revision = secret_revision
 
 
 @patch('ops.main.setup_root_logging', new=lambda *a, **kw: None)
+@patch('ops.main._emit_charm_event', new=lambda *a, **kw: None)
+@patch('ops.charm._evaluate_status', new=lambda *a, **kw: None)
 class CharmInitTestCase(unittest.TestCase):
 
     @patch('sys.stderr', new_callable=io.StringIO)
     def test_breakpoint(self, fake_stderr):
         class MyCharm(ops.CharmBase):
             pass
         self._check(MyCharm, extra_environ={'JUJU_DEBUG_AT': 'all'})
@@ -103,24 +106,23 @@
             'JUJU_UNIT_NAME': 'test_main/0',
             'JUJU_MODEL_NAME': 'mymodel',
             'JUJU_VERSION': '2.7.0',
         }
         if extra_environ is not None:
             fake_environ.update(extra_environ)
         with patch.dict(os.environ, fake_environ):
-            with patch('ops.main._emit_charm_event'):
-                with patch('ops.main._get_charm_dir') as mock_charmdir:
-                    with tempfile.TemporaryDirectory() as tmpdirname:
-                        tmpdirname = Path(tmpdirname)
-                        fake_metadata = tmpdirname / 'metadata.yaml'
-                        with fake_metadata.open('wb') as fh:
-                            fh.write(b'name: test')
-                        mock_charmdir.return_value = tmpdirname
+            with patch('ops.main._get_charm_dir') as mock_charmdir:
+                with tempfile.TemporaryDirectory() as tmpdirname:
+                    tmpdirname = Path(tmpdirname)
+                    fake_metadata = tmpdirname / 'metadata.yaml'
+                    with fake_metadata.open('wb') as fh:
+                        fh.write(b'name: test')
+                    mock_charmdir.return_value = tmpdirname
 
-                        ops.main(charm_class, **kwargs)
+                    ops.main(charm_class, **kwargs)
 
     def test_init_signature_passthrough(self):
         class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
 
@@ -170,14 +172,15 @@
             with self.assertWarnsRegex(DeprecationWarning, 'Controller storage'):
                 with self.assertRaisesRegex(FileNotFoundError, 'state-get'):
                     self._check(ops.CharmBase, use_juju_for_storage=True)
 
 
 @patch('sys.argv', new=("hooks/config-changed",))
 @patch('ops.main.setup_root_logging', new=lambda *a, **kw: None)
+@patch('ops.charm._evaluate_status', new=lambda *a, **kw: None)
 class TestDispatch(unittest.TestCase):
     def _check(self, *, with_dispatch=False, dispatch_path=''):
         """Helper for below tests."""
         class MyCharm(ops.CharmBase):
             def __init__(self, framework):
                 super().__init__(framework)
 
@@ -261,15 +264,16 @@
             pass
         ops.CharmBase.on = TestCharmEvents()
 
         def cleanup():
             ops.CharmBase.on = ops.CharmEvents()
         self.addCleanup(cleanup)
 
-        fake_script(self, 'juju-log', "exit 0")
+        fake_script(self, 'is-leader', 'echo true')
+        fake_script(self, 'juju-log', 'exit 0')
 
         # set to something other than None for tests that care
         self.stdout = None
         self.stderr = None
 
     def _setup_charm_dir(self):
         self._tmpdir = Path(tempfile.mkdtemp(prefix='tmp-ops-test-')).resolve()
@@ -616,34 +620,40 @@
         fake_script_calls(self, clear=True)
         self._simulate_event(EventSpec(ops.CollectMetricsEvent, 'collect_metrics'))
 
         expected = [
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting Juju event collect_metrics.'],
             ['add-metric', '--labels', 'bar=4.2', 'foo=42'],
+            ['is-leader', '--format=json'],
         ]
         calls = fake_script_calls(self)
 
         self.assertEqual(calls, expected)
 
     def test_custom_event(self):
         self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         # Clear the calls during 'install'
         fake_script_calls(self, clear=True)
         self._simulate_event(EventSpec(ops.UpdateStatusEvent, 'update-status',
                                        set_in_env={'EMIT_CUSTOM_EVENT': "1"}))
 
+        calls = fake_script_calls(self)
+
+        custom_event_prefix = 'Emitting custom event <CustomEvent via Charm/on/custom'
         expected = [
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting Juju event update_status.'],
-            ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting custom event '
-                                                       '<CustomEvent via Charm/on/custom[5]>.'],
+            ['juju-log', '--log-level', 'DEBUG', '--', custom_event_prefix],
+            ['is-leader', '--format=json'],
         ]
-        calls = fake_script_calls(self)
-        self.assertEqual(expected, calls)
+        # Remove the "[key]>" suffix from the end of the event string
+        self.assertRegex(calls[2][-1], re.escape(custom_event_prefix) + '.*')
+        calls[2][-1] = custom_event_prefix
+        self.assertEqual(calls, expected)
 
     def test_logger(self):
         fake_script(self, 'action-get', "echo '{}'")
 
         test_cases = [(
             EventSpec(ops.ActionEvent, 'log_critical_action', env_var='JUJU_ACTION_NAME'),
             ['juju-log', '--log-level', 'CRITICAL', '--', 'super critical'],
@@ -894,17 +904,18 @@
              f'Running legacy {hook}.'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              f'Legacy {hook} exited with status 0.'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Using local storage: not a Kubernetes podspec charm'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Emitting Juju event install.'],
+            ['is-leader', '--format=json'],
         ]
         calls = fake_script_calls(self)
-        self.assertRegex(' '.join(calls.pop(-2)), 'Initializing SQLite local storage: ')
+        self.assertRegex(' '.join(calls.pop(-3)), 'Initializing SQLite local storage: ')
         self.assertEqual(calls, expected)
 
     def test_non_executable_hook_and_dispatch(self):
         (self.hooks_dir / "install").write_text("")
         state = self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
@@ -913,17 +924,18 @@
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'WARNING', '--',
              'Legacy hooks/install exists but is not executable.'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Using local storage: not a Kubernetes podspec charm'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Emitting Juju event install.'],
+            ['is-leader', '--format=json'],
         ]
         calls = fake_script_calls(self)
-        self.assertRegex(' '.join(calls.pop(-2)), 'Initializing SQLite local storage: ')
+        self.assertRegex(' '.join(calls.pop(-3)), 'Initializing SQLite local storage: ')
         self.assertEqual(calls, expected)
 
     def test_hook_and_dispatch_with_failing_hook(self):
         self.stdout = self.stderr = tempfile.TemporaryFile()
         self.addCleanup(self.stdout.close)
 
         old_path = self.fake_script_path
@@ -995,17 +1007,18 @@
              f'Charm called itself via {hook}.'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              f'Legacy {hook} exited with status 0.'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Using local storage: not a Kubernetes podspec charm'],
             ['juju-log', '--log-level', 'DEBUG', '--',
              'Emitting Juju event install.'],
+            ['is-leader', '--format=json'],
         ]
         calls = fake_script_calls(self)
-        self.assertRegex(' '.join(calls.pop(-2)), 'Initializing SQLite local storage: ')
+        self.assertRegex(' '.join(calls.pop(-3)), 'Initializing SQLite local storage: ')
 
         self.assertEqual(calls, expected)
 
 
 class TestMainWithDispatch(_TestMainWithDispatch, unittest.TestCase):
     def _setup_entry_point(self, directory, entry_point):
         path = self.JUJU_CHARM_DIR / 'dispatch'
```

### Comparing `ops-2.4.1/test/test_model.py` & `ops-2.5.0/test/test_model.py`

 * *Files 1% similar despite different names*

```diff
@@ -46,8206 +46,8227 @@
 000002d0: 7469 6f6e 7320 696d 706f 7274 204f 7264  tions import Ord
 000002e0: 6572 6564 4469 6374 0a66 726f 6d20 7465  eredDict.from te
 000002f0: 7374 2e74 6573 745f 6865 6c70 6572 7320  st.test_helpers 
 00000300: 696d 706f 7274 2066 616b 655f 7363 7269  import fake_scri
 00000310: 7074 2c20 6661 6b65 5f73 6372 6970 745f  pt, fake_script_
 00000320: 6361 6c6c 730a 6672 6f6d 2074 6578 7477  calls.from textw
 00000330: 7261 7020 696d 706f 7274 2064 6564 656e  rap import deden
-00000340: 740a 0a69 6d70 6f72 7420 7079 7465 7374  t..import pytest
-00000350: 0a0a 696d 706f 7274 206f 7073 0a69 6d70  ..import ops.imp
-00000360: 6f72 7420 6f70 732e 7465 7374 696e 670a  ort ops.testing.
-00000370: 6672 6f6d 206f 7073 2069 6d70 6f72 7420  from ops import 
-00000380: 7065 6262 6c65 0a66 726f 6d20 6f70 732e  pebble.from ops.
-00000390: 5f70 7269 7661 7465 2069 6d70 6f72 7420  _private import 
-000003a0: 7961 6d6c 0a66 726f 6d20 6f70 732e 6d6f  yaml.from ops.mo
-000003b0: 6465 6c20 696d 706f 7274 205f 4d6f 6465  del import _Mode
-000003c0: 6c42 6163 6b65 6e64 0a0a 0a63 6c61 7373  lBackend...class
-000003d0: 2054 6573 744d 6f64 656c 2875 6e69 7474   TestModel(unitt
-000003e0: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
-000003f0: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
-00000400: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00000410: 2e68 6172 6e65 7373 203d 206f 7073 2e74  .harness = ops.t
-00000420: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-00000430: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-00000440: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00000450: 2020 206e 616d 653a 206d 7961 7070 0a20     name: myapp. 
-00000460: 2020 2020 2020 2020 2020 2070 726f 7669             provi
-00000470: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
-00000480: 2020 2064 6230 3a0a 2020 2020 2020 2020     db0:.        
-00000490: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-000004a0: 653a 2064 6230 0a20 2020 2020 2020 2020  e: db0.         
-000004b0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-000004c0: 2020 2020 2020 2020 2020 2064 6231 3a0a             db1:.
-000004d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000004e0: 696e 7465 7266 6163 653a 2064 6231 0a20  interface: db1. 
-000004f0: 2020 2020 2020 2020 2020 2070 6565 7273             peers
-00000500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00000510: 6462 323a 0a20 2020 2020 2020 2020 2020  db2:.           
-00000520: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-00000530: 6462 320a 2020 2020 2020 2020 2020 2020  db2.            
-00000540: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
-00000550: 2020 2020 2020 2020 2066 6f6f 3a20 7b74           foo: {t
-00000560: 7970 653a 2066 696c 652c 2066 696c 656e  ype: file, filen
-00000570: 616d 653a 2066 6f6f 2e74 7874 7d0a 2020  ame: foo.txt}.  
-00000580: 2020 2020 2020 2020 2020 2020 6261 723a              bar:
-00000590: 207b 7479 7065 3a20 6669 6c65 2c20 6669   {type: file, fi
-000005a0: 6c65 6e61 6d65 3a20 6261 722e 7478 747d  lename: bar.txt}
-000005b0: 0a20 2020 2020 2020 2027 2727 2c20 636f  .        ''', co
-000005c0: 6e66 6967 3d27 2727 0a20 2020 2020 2020  nfig='''.       
-000005d0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
-000005e0: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-000005f0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-00000600: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
-00000610: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
-00000620: 2020 2020 2020 2020 2074 7970 653a 2069           type: i
-00000630: 6e74 0a20 2020 2020 2020 2020 2020 2071  nt.            q
-00000640: 7578 3a0a 2020 2020 2020 2020 2020 2020  ux:.            
-00000650: 2020 2020 7479 7065 3a20 626f 6f6c 6561      type: boolea
-00000660: 6e0a 2020 2020 2020 2020 2727 2729 0a20  n.        '''). 
-00000670: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-00000680: 6c65 616e 7570 2873 656c 662e 6861 726e  leanup(self.harn
-00000690: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-000006a0: 2020 2020 2073 656c 662e 7265 6c61 7469       self.relati
-000006b0: 6f6e 5f69 645f 6462 3020 3d20 7365 6c66  on_id_db0 = self
-000006c0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-000006d0: 6174 696f 6e28 2764 6230 272c 2027 6462  ation('db0', 'db
-000006e0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000006f0: 6861 726e 6573 732e 5f67 6574 5f62 6163  harness._get_bac
-00000700: 6b65 6e64 5f63 616c 6c73 2872 6573 6574  kend_calls(reset
-00000710: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
-00000720: 656c 662e 6d6f 6465 6c20 3d20 7365 6c66  elf.model = self
-00000730: 2e68 6172 6e65 7373 2e6d 6f64 656c 0a0a  .harness.model..
-00000740: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
-00000750: 656c 5f61 7474 7269 6275 7465 7328 7365  el_attributes(se
-00000760: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00000770: 662e 6173 7365 7274 4973 2873 656c 662e  f.assertIs(self.
-00000780: 6d6f 6465 6c2e 6170 702c 2073 656c 662e  model.app, self.
-00000790: 6d6f 6465 6c2e 756e 6974 2e61 7070 290a  model.unit.app).
-000007a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000007b0: 6572 7449 734e 6f6e 6528 7365 6c66 2e6d  ertIsNone(self.m
-000007c0: 6f64 656c 2e6e 616d 6529 0a0a 2020 2020  odel.name)..    
-000007d0: 6465 6620 7465 7374 5f75 6e69 745f 696d  def test_unit_im
-000007e0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
-000007f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00000800: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
-00000810: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00000820: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000830: 6d6f 6465 6c2e 756e 6974 203d 206f 626a  model.unit = obj
-00000840: 6563 7428 290a 0a20 2020 2064 6566 2074  ect()..    def t
-00000850: 6573 745f 6170 705f 696d 6d75 7461 626c  est_app_immutabl
-00000860: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00000870: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00000880: 7452 6169 7365 7328 4174 7472 6962 7574  tRaises(Attribut
-00000890: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-000008a0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
-000008b0: 6170 7020 3d20 6f62 6a65 6374 2829 0a0a  app = object()..
-000008c0: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
-000008d0: 656c 5f6e 616d 655f 6672 6f6d 5f62 6163  el_name_from_bac
-000008e0: 6b65 6e64 2873 656c 6629 3a0a 2020 2020  kend(self):.    
-000008f0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00000900: 2e73 6574 5f6d 6f64 656c 5f6e 616d 6528  .set_model_name(
-00000910: 2764 6566 6175 6c74 2729 0a20 2020 2020  'default').     
-00000920: 2020 206d 203d 206f 7073 2e4d 6f64 656c     m = ops.Model
-00000930: 286f 7073 2e43 6861 726d 4d65 7461 2829  (ops.CharmMeta()
-00000940: 2c20 7365 6c66 2e68 6172 6e65 7373 2e5f  , self.harness._
-00000950: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
-00000960: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00000970: 6c28 6d2e 6e61 6d65 2c20 2764 6566 6175  l(m.name, 'defau
-00000980: 6c74 2729 0a20 2020 2020 2020 2077 6974  lt').        wit
-00000990: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000009a0: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
-000009b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000009c0: 206d 2e6e 616d 6520 3d20 2263 6861 6e67   m.name = "chang
-000009d0: 6573 2d64 6973 616c 6c6f 7765 6422 0a0a  es-disallowed"..
-000009e0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-000009f0: 6174 696f 6e73 5f6b 6579 7328 7365 6c66  ations_keys(self
-00000a00: 293a 0a20 2020 2020 2020 2072 656c 5f61  ):.        rel_a
-00000a10: 7070 3120 3d20 7365 6c66 2e68 6172 6e65  pp1 = self.harne
-00000a20: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00000a30: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
-00000a40: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
-00000a50: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
-00000a60: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00000a70: 6170 7031 2c20 2772 656d 6f74 6561 7070  app1, 'remoteapp
-00000a80: 312f 3027 290a 2020 2020 2020 2020 7365  1/0').        se
-00000a90: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00000aa0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00000ab0: 5f61 7070 312c 2027 7265 6d6f 7465 6170  _app1, 'remoteap
-00000ac0: 7031 2f31 2729 0a20 2020 2020 2020 2072  p1/1').        r
-00000ad0: 656c 5f61 7070 3220 3d20 7365 6c66 2e68  el_app2 = self.h
-00000ae0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00000af0: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
-00000b00: 7465 6170 7032 2729 0a20 2020 2020 2020  teapp2').       
-00000b10: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00000b20: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-00000b30: 7265 6c5f 6170 7032 2c20 2772 656d 6f74  rel_app2, 'remot
-00000b40: 6561 7070 322f 3027 290a 0a20 2020 2020  eapp2/0')..     
-00000b50: 2020 2023 2057 6520 696e 7661 6c69 6461     # We invalida
-00000b60: 7465 2064 6231 2073 6f20 7468 6174 2069  te db1 so that i
-00000b70: 7420 6361 7573 6573 2075 7320 746f 2072  t causes us to r
-00000b80: 656c 6f61 6420 6974 0a20 2020 2020 2020  eload it.       
-00000b90: 2073 656c 662e 6d6f 6465 6c2e 7265 6c61   self.model.rela
-00000ba0: 7469 6f6e 732e 5f69 6e76 616c 6964 6174  tions._invalidat
-00000bb0: 6528 2764 6231 2729 0a20 2020 2020 2020  e('db1').       
-00000bc0: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
-00000bd0: 6e64 4361 6c6c 7328 290a 2020 2020 2020  ndCalls().      
-00000be0: 2020 666f 7220 7265 6c61 7469 6f6e 2069    for relation i
-00000bf0: 6e20 7365 6c66 2e6d 6f64 656c 2e72 656c  n self.model.rel
-00000c00: 6174 696f 6e73 5b27 6462 3127 5d3a 0a20  ations['db1']:. 
-00000c10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000c20: 6173 7365 7274 496e 2873 656c 662e 6d6f  assertIn(self.mo
-00000c30: 6465 6c2e 756e 6974 2c20 7265 6c61 7469  del.unit, relati
-00000c40: 6f6e 2e64 6174 6129 0a20 2020 2020 2020  on.data).       
-00000c50: 2020 2020 2075 6e69 745f 6672 6f6d 5f72       unit_from_r
-00000c60: 656c 203d 206e 6578 7428 6669 6c74 6572  el = next(filter
-00000c70: 286c 616d 6264 6120 753a 2075 2e6e 616d  (lambda u: u.nam
-00000c80: 6520 3d3d 2027 6d79 6170 702f 3027 2c20  e == 'myapp/0', 
-00000c90: 7265 6c61 7469 6f6e 2e64 6174 612e 6b65  relation.data.ke
-00000ca0: 7973 2829 2929 0a20 2020 2020 2020 2020  ys())).         
-00000cb0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00000cc0: 2873 656c 662e 6d6f 6465 6c2e 756e 6974  (self.model.unit
-00000cd0: 2c20 756e 6974 5f66 726f 6d5f 7265 6c29  , unit_from_rel)
-00000ce0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00000cf0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-00000d00: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
-00000d10: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
-00000d20: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
-00000d30: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00000d40: 6c69 7374 272c 2072 656c 5f61 7070 3129  list', rel_app1)
-00000d50: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00000d60: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
-00000d70: 7265 6c5f 6170 7032 292c 0a20 2020 2020  rel_app2),.     
-00000d80: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-00000d90: 6573 745f 7265 6c61 7469 6f6e 735f 696d  est_relations_im
-00000da0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
-00000db0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00000dc0: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
-00000dd0: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00000de0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000df0: 6d6f 6465 6c2e 7265 6c61 7469 6f6e 7320  model.relations 
-00000e00: 3d20 7b7d 0a0a 2020 2020 6465 6620 7465  = {}..    def te
-00000e10: 7374 5f67 6574 5f72 656c 6174 696f 6e28  st_get_relation(
-00000e20: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-00000e30: 206f 6e65 2072 656c 6174 696f 6e20 6f6e   one relation on
-00000e40: 2064 6231 0a20 2020 2020 2020 2023 2074   db1.        # t
-00000e50: 776f 2072 656c 6174 696f 6e73 206f 6e20  wo relations on 
-00000e60: 6462 300a 2020 2020 2020 2020 2320 6e6f  db0.        # no
-00000e70: 2072 656c 6174 696f 6e73 206f 6e20 6462   relations on db
-00000e80: 320a 2020 2020 2020 2020 7265 6c61 7469  2.        relati
-00000e90: 6f6e 5f69 645f 6462 3120 3d20 7365 6c66  on_id_db1 = self
-00000ea0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-00000eb0: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
-00000ec0: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
-00000ed0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00000ee0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00000ef0: 7428 7265 6c61 7469 6f6e 5f69 645f 6462  t(relation_id_db
-00000f00: 312c 2027 7265 6d6f 7465 6170 7031 2f30  1, 'remoteapp1/0
-00000f10: 2729 0a20 2020 2020 2020 2072 656c 6174  ').        relat
-00000f20: 696f 6e5f 6964 5f64 6230 5f62 203d 2073  ion_id_db0_b = s
-00000f30: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00000f40: 7265 6c61 7469 6f6e 2827 6462 3027 2c20  relation('db0', 
-00000f50: 2761 6e6f 7468 6572 2729 0a20 2020 2020  'another').     
-00000f60: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
-00000f70: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
-00000f80: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00000f90: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00000fa0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-00000fb0: 2020 2020 2020 2020 2023 2059 6f75 2068           # You h
-00000fc0: 6176 6520 746f 2073 7065 6369 6679 2069  ave to specify i
-00000fd0: 7420 6279 206a 7573 7420 7468 6520 696e  t by just the in
-00000fe0: 7465 6765 7220 4944 0a20 2020 2020 2020  teger ID.       
-00000ff0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
-00001000: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00001010: 3127 2c20 6627 6462 313a 7b72 656c 6174  1', f'db1:{relat
-00001020: 696f 6e5f 6964 5f64 6231 7d27 290a 2020  ion_id_db1}').  
-00001030: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
-00001040: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-00001050: 656c 6174 696f 6e28 2764 6231 272c 2072  elation('db1', r
-00001060: 656c 6174 696f 6e5f 6964 5f64 6231 290a  elation_id_db1).
-00001070: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00001080: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
-00001090: 6c5f 6462 312c 206f 7073 2e52 656c 6174  l_db1, ops.Relat
-000010a0: 696f 6e29 0a20 2020 2020 2020 2073 656c  ion).        sel
-000010b0: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-000010c0: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
-000010d0: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
-000010e0: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
-000010f0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
-00001100: 6f6e 5f6c 6973 7427 2c20 7265 6c61 7469  on_list', relati
-00001110: 6f6e 5f69 645f 6462 3129 2c0a 2020 2020  on_id_db1),.    
-00001120: 2020 2020 5d29 0a20 2020 2020 2020 2064      ]).        d
-00001130: 6561 645f 7265 6c20 3d20 7365 6c66 2e6d  ead_rel = self.m
-00001140: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-00001150: 6e28 2764 6231 272c 2037 290a 2020 2020  n('db1', 7).    
-00001160: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-00001170: 7349 6e73 7461 6e63 6528 6465 6164 5f72  sInstance(dead_r
-00001180: 656c 2c20 6f70 732e 5265 6c61 7469 6f6e  el, ops.Relation
-00001190: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000011a0: 7373 6572 7445 7175 616c 2873 6574 2864  ssertEqual(set(d
-000011b0: 6561 645f 7265 6c2e 6461 7461 2e6b 6579  ead_rel.data.key
-000011c0: 7328 2929 2c20 7b73 656c 662e 6d6f 6465  s()), {self.mode
-000011d0: 6c2e 756e 6974 2c20 7365 6c66 2e6d 6f64  l.unit, self.mod
-000011e0: 656c 2e75 6e69 742e 6170 707d 290a 2020  el.unit.app}).  
-000011f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00001200: 7445 7175 616c 2864 6561 645f 7265 6c2e  tEqual(dead_rel.
-00001210: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
-00001220: 756e 6974 5d2c 207b 7d29 0a20 2020 2020  unit], {}).     
-00001230: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
-00001240: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
-00001250: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-00001260: 696f 6e5f 6c69 7374 272c 2037 292c 0a20  ion_list', 7),. 
-00001270: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
-00001280: 6174 696f 6e5f 7265 6d6f 7465 5f61 7070  ation_remote_app
-00001290: 5f6e 616d 6527 2c20 3729 2c0a 2020 2020  _name', 7),.    
-000012a0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
-000012b0: 6f6e 5f67 6574 272c 2037 2c20 276d 7961  on_get', 7, 'mya
-000012c0: 7070 2f30 272c 2046 616c 7365 292c 0a20  pp/0', False),. 
-000012d0: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
-000012e0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-000012f0: 4e6f 6e65 2873 656c 662e 6d6f 6465 6c2e  None(self.model.
-00001300: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00001310: 3227 2929 0a20 2020 2020 2020 2073 656c  2')).        sel
-00001320: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-00001330: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
-00001340: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
-00001350: 7327 2c20 2764 6232 2729 2c0a 2020 2020  s', 'db2'),.    
-00001360: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
-00001370: 656c 662e 6173 7365 7274 4973 2873 656c  elf.assertIs(sel
-00001380: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
-00001390: 7469 6f6e 2827 6462 3127 292c 2072 656c  tion('db1'), rel
-000013a0: 5f64 6231 290a 2020 2020 2020 2020 7769  _db1).        wi
-000013b0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-000013c0: 6973 6573 286f 7073 2e54 6f6f 4d61 6e79  ises(ops.TooMany
-000013d0: 5265 6c61 7465 6441 7070 7345 7272 6f72  RelatedAppsError
-000013e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000013f0: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-00001400: 6c61 7469 6f6e 2827 6462 3027 290a 0a20  lation('db0').. 
-00001410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00001420: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
-00001430: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-00001440: 656c 6174 696f 6e5f 6964 7327 2c20 2764  elation_ids', 'd
-00001450: 6230 2729 2c0a 2020 2020 2020 2020 2020  b0'),.          
-00001460: 2020 2827 7265 6c61 7469 6f6e 5f6c 6973    ('relation_lis
-00001470: 7427 2c20 7365 6c66 2e72 656c 6174 696f  t', self.relatio
-00001480: 6e5f 6964 5f64 6230 292c 0a20 2020 2020  n_id_db0),.     
-00001490: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-000014a0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
-000014b0: 6527 2c20 3029 2c0a 2020 2020 2020 2020  e', 0),.        
-000014c0: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
-000014d0: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
-000014e0: 645f 6462 305f 6229 2c0a 2020 2020 2020  d_db0_b),.      
-000014f0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-00001500: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
-00001510: 272c 2032 292c 0a20 2020 2020 2020 205d  ', 2),.        ]
-00001520: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00001530: 7065 6572 5f72 656c 6174 696f 6e5f 6170  peer_relation_ap
-00001540: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
-00001550: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00001560: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
-00001570: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
-00001580: 2020 2072 656c 5f64 6270 6565 7220 3d20     rel_dbpeer = 
-00001590: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-000015a0: 656c 6174 696f 6e28 2764 6232 2729 0a20  elation('db2'). 
-000015b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000015c0: 7274 4973 2872 656c 5f64 6270 6565 722e  rtIs(rel_dbpeer.
-000015d0: 6170 702c 2073 656c 662e 6d6f 6465 6c2e  app, self.model.
-000015e0: 6170 7029 0a0a 2020 2020 6465 6620 7465  app)..    def te
-000015f0: 7374 5f72 656d 6f74 655f 756e 6974 735f  st_remote_units_
-00001600: 6973 5f6f 7572 2873 656c 6629 3a0a 2020  is_our(self):.  
-00001610: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
-00001620: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
-00001630: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00001640: 6231 272c 2027 7265 6d6f 7465 6170 7031  b1', 'remoteapp1
-00001650: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00001660: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00001670: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
-00001680: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
-00001690: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
-000016a0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-000016b0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-000016c0: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-000016d0: 7465 6170 7031 2f31 2729 0a20 2020 2020  teapp1/1').     
-000016e0: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
-000016f0: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
-00001700: 2020 2020 2066 6f72 2075 2069 6e20 7365       for u in se
-00001710: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
-00001720: 6174 696f 6e28 2764 6231 2729 2e75 6e69  ation('db1').uni
-00001730: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00001740: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
-00001750: 2875 2e5f 6973 5f6f 7572 5f75 6e69 7429  (u._is_our_unit)
-00001760: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001770: 662e 6173 7365 7274 4661 6c73 6528 752e  f.assertFalse(u.
-00001780: 6170 702e 5f69 735f 6f75 725f 6170 7029  app._is_our_app)
-00001790: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-000017a0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-000017b0: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
-000017c0: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
-000017d0: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
-000017e0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-000017f0: 6c69 7374 272c 2072 656c 6174 696f 6e5f  list', relation_
-00001800: 6964 290a 2020 2020 2020 2020 5d29 0a0a  id).        ])..
-00001810: 2020 2020 6465 6620 7465 7374 5f6f 7572      def test_our
-00001820: 5f75 6e69 745f 6973 5f6f 7572 2873 656c  _unit_is_our(sel
-00001830: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00001840: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
-00001850: 2e6d 6f64 656c 2e75 6e69 742e 5f69 735f  .model.unit._is_
-00001860: 6f75 725f 756e 6974 290a 2020 2020 2020  our_unit).      
-00001870: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-00001880: 6528 7365 6c66 2e6d 6f64 656c 2e75 6e69  e(self.model.uni
-00001890: 742e 6170 702e 5f69 735f 6f75 725f 6170  t.app._is_our_ap
-000018a0: 7029 0a0a 2020 2020 6465 6620 7465 7374  p)..    def test
-000018b0: 5f69 6e76 616c 6964 5f74 7970 655f 7265  _invalid_type_re
-000018c0: 6c61 7469 6f6e 5f64 6174 6128 7365 6c66  lation_data(self
-000018d0: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
-000018e0: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
-000018f0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00001900: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
-00001910: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
-00001920: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00001930: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-00001940: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-00001950: 6f74 6561 7070 312f 3027 290a 0a20 2020  oteapp1/0')..   
-00001960: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00001970: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00001980: 5265 6c61 7469 6f6e 4461 7461 4572 726f  RelationDataErro
-00001990: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000019a0: 7769 7468 2073 656c 662e 6861 726e 6573  with self.harnes
-000019b0: 732e 5f65 7665 6e74 5f63 6f6e 7465 7874  s._event_context
-000019c0: 2827 666f 6f5f 6576 656e 7427 293a 0a20  ('foo_event'):. 
-000019d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000019e0: 656c 662e 6861 726e 6573 732e 7570 6461  elf.harness.upda
-000019f0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00001a00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00001a10: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
-00001a20: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00001a30: 2020 2020 2020 2027 7265 6d6f 7465 6170         'remoteap
-00001a40: 7031 2f30 272c 0a20 2020 2020 2020 2020  p1/0',.         
-00001a50: 2020 2020 2020 2020 2020 207b 3432 3a20             {42: 
-00001a60: 2772 656d 6f74 6561 7070 312d 3027 7d29  'remoteapp1-0'})
-00001a70: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-00001a80: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00001a90: 286f 7073 2e52 656c 6174 696f 6e44 6174  (ops.RelationDat
-00001aa0: 6145 7272 6f72 293a 0a20 2020 2020 2020  aError):.       
-00001ab0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-00001ac0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
-00001ad0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
-00001ae0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00001af0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00001b00: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-00001b10: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
-00001b20: 2020 2020 2020 2020 2020 2072 656c 6174             relat
-00001b30: 696f 6e5f 6964 2c0a 2020 2020 2020 2020  ion_id,.        
-00001b40: 2020 2020 2020 2020 2020 2020 2772 656d              'rem
-00001b50: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
-00001b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b70: 7b27 666f 6f27 3a20 3432 7d29 0a0a 2020  {'foo': 42})..  
-00001b80: 2020 6465 6620 7465 7374 5f67 6574 5f61    def test_get_a
-00001b90: 7070 5f72 656c 6174 696f 6e5f 6461 7461  pp_relation_data
-00001ba0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00001bb0: 7365 6c66 2e68 6172 6e65 7373 2e62 6567  self.harness.beg
-00001bc0: 696e 2829 0a20 2020 2020 2020 2072 656c  in().        rel
-00001bd0: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
-00001be0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00001bf0: 7469 6f6e 2827 6462 3127 2c20 2772 656d  tion('db1', 'rem
-00001c00: 6f74 6527 290a 2020 2020 2020 2020 7365  ote').        se
-00001c10: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00001c20: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00001c30: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
-00001c40: 652f 3027 290a 2020 2020 2020 2020 6c6f  e/0').        lo
-00001c50: 6361 6c5f 6170 7020 3d20 7365 6c66 2e68  cal_app = self.h
-00001c60: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
-00001c70: 2e6e 616d 650a 2020 2020 2020 2020 7769  .name.        wi
-00001c80: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
-00001c90: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
-00001ca0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
-00001cb0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00001cc0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00001cd0: 6174 696f 6e5f 6461 7461 280a 2020 2020  ation_data(.    
-00001ce0: 2020 2020 2020 2020 2020 2020 7265 6c61              rela
-00001cf0: 7469 6f6e 5f69 642c 0a20 2020 2020 2020  tion_id,.       
-00001d00: 2020 2020 2020 2020 206c 6f63 616c 5f61           local_a
-00001d10: 7070 2c0a 2020 2020 2020 2020 2020 2020  pp,.            
-00001d20: 2020 2020 7b27 666f 6f27 3a20 2762 6172      {'foo': 'bar
-00001d30: 277d 290a 2020 2020 2020 2020 2020 2020  '}).            
-00001d40: 6173 7365 7274 2073 656c 662e 6861 726e  assert self.harn
-00001d50: 6573 732e 6765 745f 7265 6c61 7469 6f6e  ess.get_relation
-00001d60: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
-00001d70: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-00001d80: 6964 2c20 7365 6c66 2e68 6172 6e65 7373  id, self.harness
-00001d90: 2e6d 6f64 656c 2e61 7070 2920 3d3d 2073  .model.app) == s
-00001da0: 656c 662e 6861 726e 6573 732e 6765 745f  elf.harness.get_
-00001db0: 7265 6c61 7469 6f6e 5f64 6174 6128 0a20  relation_data(. 
-00001dc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00001dd0: 656c 6174 696f 6e5f 6964 2c20 6c6f 6361  elation_id, loca
-00001de0: 6c5f 6170 7029 203d 3d20 7b27 666f 6f27  l_app) == {'foo'
-00001df0: 3a20 2762 6172 277d 0a0a 2020 2020 6465  : 'bar'}..    de
-00001e00: 6620 7465 7374 5f75 6e69 745f 7265 6c61  f test_unit_rela
-00001e10: 7469 6f6e 5f64 6174 6128 7365 6c66 293a  tion_data(self):
-00001e20: 0a20 2020 2020 2020 2072 656c 6174 696f  .        relatio
-00001e30: 6e5f 6964 203d 2073 656c 662e 6861 726e  n_id = self.harn
-00001e40: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00001e50: 2827 6462 3127 2c20 2772 656d 6f74 6561  ('db1', 'remotea
-00001e60: 7070 3127 290a 2020 2020 2020 2020 7365  pp1').        se
-00001e70: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00001e80: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00001e90: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
-00001ea0: 6561 7070 312f 3027 290a 2020 2020 2020  eapp1/0').      
-00001eb0: 2020 7769 7468 2073 656c 662e 6861 726e    with self.harn
-00001ec0: 6573 732e 5f65 7665 6e74 5f63 6f6e 7465  ess._event_conte
-00001ed0: 7874 2827 666f 6f5f 6576 656e 7427 293a  xt('foo_event'):
-00001ee0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001ef0: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
-00001f00: 5f72 656c 6174 696f 6e5f 6461 7461 280a  _relation_data(.
-00001f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f20: 7265 6c61 7469 6f6e 5f69 642c 0a20 2020  relation_id,.   
-00001f30: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00001f40: 6d6f 7465 6170 7031 2f30 272c 0a20 2020  moteapp1/0',.   
-00001f50: 2020 2020 2020 2020 2020 2020 207b 2768               {'h
-00001f60: 6f73 7427 3a20 2772 656d 6f74 6561 7070  ost': 'remoteapp
-00001f70: 312d 3027 7d29 0a20 2020 2020 2020 2073  1-0'}).        s
-00001f80: 656c 662e 6d6f 6465 6c2e 7265 6c61 7469  elf.model.relati
-00001f90: 6f6e 732e 5f69 6e76 616c 6964 6174 6528  ons._invalidate(
-00001fa0: 2764 6231 2729 0a20 2020 2020 2020 2073  'db1').        s
-00001fb0: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
-00001fc0: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
-00001fd0: 2072 616e 646f 6d5f 756e 6974 203d 2073   random_unit = s
-00001fe0: 656c 662e 6d6f 6465 6c2e 6765 745f 756e  elf.model.get_un
-00001ff0: 6974 2827 7261 6e64 6f6d 756e 6974 2f30  it('randomunit/0
-00002000: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-00002010: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00002020: 7328 4b65 7945 7272 6f72 293a 0a20 2020  s(KeyError):.   
-00002030: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
-00002040: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00002050: 2827 6462 3127 292e 6461 7461 5b72 616e  ('db1').data[ran
-00002060: 646f 6d5f 756e 6974 5d0a 2020 2020 2020  dom_unit].      
-00002070: 2020 7265 6d6f 7465 6170 7031 5f30 203d    remoteapp1_0 =
-00002080: 206e 6578 7428 6669 6c74 6572 286c 616d   next(filter(lam
-00002090: 6264 6120 753a 2075 2e6e 616d 6520 3d3d  bda u: u.name ==
-000020a0: 2027 7265 6d6f 7465 6170 7031 2f30 272c   'remoteapp1/0',
-000020b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000020c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020d0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
-000020e0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
-000020f0: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
-00002100: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00002110: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e67  ual(self.model.g
-00002120: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
-00002130: 2729 2e64 6174 615b 7265 6d6f 7465 6170  ').data[remoteap
-00002140: 7031 5f30 5d2c 0a20 2020 2020 2020 2020  p1_0],.         
-00002150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002160: 7b27 686f 7374 273a 2027 7265 6d6f 7465  {'host': 'remote
-00002170: 6170 7031 2d30 277d 290a 0a20 2020 2020  app1-0'})..     
-00002180: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
-00002190: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
-000021a0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-000021b0: 696f 6e5f 6964 7327 2c20 2764 6231 2729  ion_ids', 'db1')
-000021c0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-000021d0: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
-000021e0: 7265 6c61 7469 6f6e 5f69 6429 2c0a 2020  relation_id),.  
-000021f0: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-00002200: 7469 6f6e 5f67 6574 272c 2072 656c 6174  tion_get', relat
-00002210: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
-00002220: 7070 312f 3027 2c20 4661 6c73 6529 2c0a  pp1/0', False),.
-00002230: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-00002240: 6465 6620 7465 7374 5f72 656d 6f74 655f  def test_remote_
-00002250: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
-00002260: 6128 7365 6c66 293a 0a20 2020 2020 2020  a(self):.       
-00002270: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
-00002280: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00002290: 7265 6c61 7469 6f6e 2827 6462 3127 2c20  relation('db1', 
-000022a0: 2772 656d 6f74 6561 7070 3127 290a 2020  'remoteapp1').  
-000022b0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000022c0: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
-000022d0: 6f6e 7465 7874 2827 666f 6f5f 6576 656e  ontext('foo_even
-000022e0: 7427 293a 0a20 2020 2020 2020 2020 2020  t'):.           
-000022f0: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
-00002300: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00002310: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
-00002320: 2772 656d 6f74 6561 7070 3127 2c0a 2020  'remoteapp1',.  
-00002330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002350: 2020 2020 2020 2020 2020 2020 7b27 7365              {'se
-00002360: 6372 6574 273a 2027 6361 6665 6465 6164  cret': 'cafedead
-00002370: 6265 6566 277d 290a 2020 2020 2020 2020  beef'}).        
-00002380: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00002390: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-000023a0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-000023b0: 6f74 6561 7070 312f 3027 290a 2020 2020  oteapp1/0').    
-000023c0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-000023d0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-000023e0: 6974 2872 656c 6174 696f 6e5f 6964 2c20  it(relation_id, 
-000023f0: 2772 656d 6f74 6561 7070 312f 3127 290a  'remoteapp1/1').
-00002400: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-00002410: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
-00002420: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
-00002430: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
-00002440: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
-00002450: 2729 0a20 2020 2020 2020 2023 2054 7279  ').        # Try
-00002460: 2074 6f20 6765 7420 7265 6c61 7469 6f6e   to get relation
-00002470: 2064 6174 6120 666f 7220 616e 2069 6e76   data for an inv
-00002480: 616c 6964 2072 656d 6f74 6520 6170 706c  alid remote appl
-00002490: 6963 6174 696f 6e2e 0a20 2020 2020 2020  ication..       
-000024a0: 2072 616e 646f 6d5f 6170 7020 3d20 7365   random_app = se
-000024b0: 6c66 2e6d 6f64 656c 2e5f 6361 6368 652e  lf.model._cache.
-000024c0: 6765 7428 6f70 732e 4170 706c 6963 6174  get(ops.Applicat
-000024d0: 696f 6e2c 2027 7261 6e64 6f6d 6170 7027  ion, 'randomapp'
-000024e0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-000024f0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00002500: 284b 6579 4572 726f 7229 3a0a 2020 2020  (KeyError):.    
-00002510: 2020 2020 2020 2020 7265 6c5f 6462 312e          rel_db1.
-00002520: 6461 7461 5b72 616e 646f 6d5f 6170 705d  data[random_app]
-00002530: 0a0a 2020 2020 2020 2020 7265 6d6f 7465  ..        remote
-00002540: 6170 7031 203d 2072 656c 5f64 6231 2e61  app1 = rel_db1.a
-00002550: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
-00002560: 6173 7365 7274 4571 7561 6c28 7265 6d6f  assertEqual(remo
-00002570: 7465 6170 7031 2e6e 616d 652c 2027 7265  teapp1.name, 're
-00002580: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
-00002590: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000025a0: 7561 6c28 7265 6c5f 6462 312e 6461 7461  ual(rel_db1.data
-000025b0: 5b72 656d 6f74 6561 7070 315d 2c0a 2020  [remoteapp1],.  
-000025c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000025d0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
-000025e0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
-000025f0: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
-00002600: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-00002610: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
-00002620: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
-00002630: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
-00002640: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00002650: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
-00002660: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
-00002670: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
-00002680: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
-00002690: 2027 7265 6d6f 7465 6170 7031 272c 2054   'remoteapp1', T
-000026a0: 7275 6529 2c0a 2020 2020 2020 2020 5d29  rue),.        ])
-000026b0: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
-000026c0: 656c 6174 696f 6e5f 6461 7461 5f6d 6f64  elation_data_mod
-000026d0: 6966 795f 7265 6d6f 7465 2873 656c 6629  ify_remote(self)
-000026e0: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
-000026f0: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
-00002700: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00002710: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
-00002720: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
-00002730: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-00002740: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-00002750: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-00002760: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00002770: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00002780: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
-00002790: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
-000027a0: 6170 7031 272c 0a20 2020 2020 2020 2020  app1',.         
-000027b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027d0: 2020 2020 207b 2773 6563 7265 7427 3a20       {'secret': 
-000027e0: 2763 6166 6564 6561 6462 6565 6627 7d29  'cafedeadbeef'})
-000027f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00002800: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
-00002810: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
-00002820: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
-00002830: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
-00002840: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00002850: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00002860: 6e5f 6461 7461 2872 656c 6174 696f 6e5f  n_data(relation_
-00002870: 6964 2c20 2772 656d 6f74 6561 7070 312f  id, 'remoteapp1/
-00002880: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00002890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028b0: 2020 7b27 686f 7374 273a 2027 7265 6d6f    {'host': 'remo
-000028c0: 7465 6170 7031 2f30 277d 290a 2020 2020  teapp1/0'}).    
-000028d0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e72      self.model.r
-000028e0: 656c 6174 696f 6e73 2e5f 696e 7661 6c69  elations._invali
-000028f0: 6461 7465 2827 6462 3127 290a 2020 2020  date('db1').    
-00002900: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
-00002910: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
-00002920: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
-00002930: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-00002940: 656c 6174 696f 6e28 2764 6231 2729 0a20  elation('db1'). 
-00002950: 2020 2020 2020 2072 656d 6f74 6561 7070         remoteapp
-00002960: 315f 3020 3d20 6e65 7874 2866 696c 7465  1_0 = next(filte
-00002970: 7228 6c61 6d62 6461 2075 3a20 752e 6e61  r(lambda u: u.na
-00002980: 6d65 203d 3d20 2772 656d 6f74 6561 7070  me == 'remoteapp
-00002990: 312f 3027 2c0a 2020 2020 2020 2020 2020  1/0',.          
-000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029b0: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
-000029c0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-000029d0: 2827 6462 3127 292e 756e 6974 7329 290a  ('db1').units)).
-000029e0: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
-000029f0: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
-00002a00: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
-00002a10: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
-00002a20: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
-00002a30: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
-00002a40: 5f30 5d29 0a20 2020 2020 2020 2073 656c  _0]).        sel
-00002a50: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-00002a60: 7072 2872 656c 5f64 6231 2e64 6174 615b  pr(rel_db1.data[
-00002a70: 7265 6d6f 7465 6170 7031 5f30 5d29 2c20  remoteapp1_0]), 
-00002a80: 227b 2768 6f73 7427 3a20 2772 656d 6f74  "{'host': 'remot
-00002a90: 6561 7070 312f 3027 7d22 290a 0a20 2020  eapp1/0'}")..   
-00002aa0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-00002ab0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
-00002ac0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
-00002ad0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00002ae0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00002af0: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
-00002b00: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
-00002b10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00002b20: 656c 5f64 6231 2e64 6174 615b 7265 6d6f  el_db1.data[remo
-00002b30: 7465 6170 7031 5f30 5d5b 2766 6f6f 275d  teapp1_0]['foo']
-00002b40: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
-00002b50: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
-00002b60: 6e28 2766 6f6f 272c 2072 656c 5f64 6231  n('foo', rel_db1
-00002b70: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
-00002b80: 5f30 5d29 0a0a 2020 2020 2020 2020 7365  _0])..        se
-00002b90: 6c66 2e61 7373 6572 7442 6163 6b65 6e64  lf.assertBackend
-00002ba0: 4361 6c6c 7328 5b0a 2020 2020 2020 2020  Calls([.        
-00002bb0: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
-00002bc0: 6473 272c 2027 6462 3127 292c 0a20 2020  ds', 'db1'),.   
-00002bd0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-00002be0: 696f 6e5f 6c69 7374 272c 2072 656c 6174  ion_list', relat
-00002bf0: 696f 6e5f 6964 292c 0a20 2020 2020 2020  ion_id),.       
-00002c00: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00002c10: 6765 7427 2c20 7265 6c61 7469 6f6e 5f69  get', relation_i
-00002c20: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
-00002c30: 272c 2046 616c 7365 292c 0a20 2020 2020  ', False),.     
-00002c40: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
-00002c50: 2074 6869 7320 7769 6c6c 2066 6972 6520   this will fire 
-00002c60: 6d6f 7265 2062 6163 6b65 6e64 2063 616c  more backend cal
-00002c70: 6c73 0a20 2020 2020 2020 2077 6974 6820  ls.        with 
-00002c80: 7365 6c66 2e68 6172 6e65 7373 2e5f 6576  self.harness._ev
-00002c90: 656e 745f 636f 6e74 6578 7428 2766 6f6f  ent_context('foo
-00002ca0: 5f65 7665 6e74 2729 3a0a 2020 2020 2020  _event'):.      
-00002cb0: 2020 2020 2020 6461 7461 5f72 6570 7220        data_repr 
-00002cc0: 3d20 7265 7072 2872 656c 5f64 6231 2e64  = repr(rel_db1.d
-00002cd0: 6174 6129 0a20 2020 2020 2020 2073 656c  ata).        sel
-00002ce0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00002cf0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00002d00: 7265 7072 2c0a 2020 2020 2020 2020 2020  repr,.          
-00002d10: 2020 2827 7b3c 6f70 732e 6d6f 6465 6c2e    ('{<ops.model.
-00002d20: 556e 6974 206d 7961 7070 2f30 3e3a 207b  Unit myapp/0>: {
-00002d30: 7d2c 2027 0a20 2020 2020 2020 2020 2020  }, '.           
-00002d40: 2020 273c 6f70 732e 6d6f 6465 6c2e 4170    '<ops.model.Ap
-00002d50: 706c 6963 6174 696f 6e20 6d79 6170 703e  plication myapp>
-00002d60: 3a20 3c6e 2f61 3e2c 2027 0a20 2020 2020  : <n/a>, '.     
-00002d70: 2020 2020 2020 2020 223c 6f70 732e 6d6f          "<ops.mo
-00002d80: 6465 6c2e 556e 6974 2072 656d 6f74 6561  del.Unit remotea
-00002d90: 7070 312f 303e 3a20 7b27 686f 7374 273a  pp1/0>: {'host':
-00002da0: 2027 7265 6d6f 7465 6170 7031 2f30 277d   'remoteapp1/0'}
-00002db0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-00002dc0: 2022 3c6f 7073 2e6d 6f64 656c 2e41 7070   "<ops.model.App
-00002dd0: 6c69 6361 7469 6f6e 2072 656d 6f74 6561  lication remotea
-00002de0: 7070 313e 3a20 7b27 7365 6372 6574 273a  pp1>: {'secret':
-00002df0: 2027 6361 6665 6465 6164 6265 6566 277d   'cafedeadbeef'}
-00002e00: 7d22 2929 0a0a 2020 2020 6465 6620 7465  }"))..    def te
-00002e10: 7374 5f72 656c 6174 696f 6e5f 6461 7461  st_relation_data
-00002e20: 5f6d 6f64 6966 795f 6f75 7228 7365 6c66  _modify_our(self
-00002e30: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
-00002e40: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
-00002e50: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00002e60: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
-00002e70: 6561 7070 3127 290a 0a20 2020 2020 2020  eapp1')..       
-00002e80: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
-00002e90: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00002ea0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
-00002eb0: 276d 7961 7070 2f30 272c 207b 2768 6f73  'myapp/0', {'hos
-00002ec0: 7427 3a20 276e 6f74 6869 6e67 277d 290a  t': 'nothing'}).
-00002ed0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-00002ee0: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
-00002ef0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00002f00: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
-00002f10: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
-00002f20: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
-00002f30: 2020 2020 7265 6c5f 6462 3120 3d20 7365      rel_db1 = se
-00002f40: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
-00002f50: 6174 696f 6e28 2764 6231 2729 0a20 2020  ation('db1').   
-00002f60: 2020 2020 2020 2020 2023 2075 7064 6174           # updat
-00002f70: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
-00002f80: 7769 6c6c 2061 6c73 6f20 7472 6967 6765  will also trigge
-00002f90: 7220 7265 6c61 7469 6f6e 2d67 6574 2c20  r relation-get, 
-00002fa0: 736f 2077 650a 2020 2020 2020 2020 2020  so we.          
-00002fb0: 2020 2320 696e 7661 6c69 6461 7465 2074    # invalidate t
-00002fc0: 6865 2063 6163 6865 2074 6f20 656e 7375  he cache to ensu
-00002fd0: 7265 2069 7420 7769 6c6c 2062 6520 7265  re it will be re
-00002fe0: 6c6f 6164 6564 0a20 2020 2020 2020 2020  loaded.         
-00002ff0: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
-00003000: 7365 6c66 2e6d 6f64 656c 2e75 6e69 745d  self.model.unit]
-00003010: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
-00003020: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
-00003030: 6365 206d 656d 6f72 7920 6361 6368 6520  ce memory cache 
-00003040: 746f 2062 6520 6c6f 6164 6564 2e0a 2020  to be loaded..  
-00003050: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00003060: 7373 6572 7449 6e28 2768 6f73 7427 2c20  ssertIn('host', 
-00003070: 7265 6c5f 6462 312e 6461 7461 5b73 656c  rel_db1.data[sel
-00003080: 662e 6d6f 6465 6c2e 756e 6974 5d29 0a20  f.model.unit]). 
-00003090: 2020 2020 2020 2020 2020 2072 656c 5f64             rel_d
-000030a0: 6231 2e64 6174 615b 7365 6c66 2e6d 6f64  b1.data[self.mod
-000030b0: 656c 2e75 6e69 745d 5b27 686f 7374 275d  el.unit]['host']
-000030c0: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
-000030d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000030e0: 4571 7561 6c28 7265 6c5f 6462 312e 6461  Equal(rel_db1.da
-000030f0: 7461 5b73 656c 662e 6d6f 6465 6c2e 756e  ta[self.model.un
-00003100: 6974 5d5b 2768 6f73 7427 5d2c 2027 6261  it]['host'], 'ba
-00003110: 7227 290a 0a20 2020 2020 2020 2073 656c  r')..        sel
-00003120: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-00003130: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
-00003140: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
-00003150: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
-00003160: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
-00003170: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00003180: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-00003190: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
-000031a0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
-000031b0: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
-000031c0: 6261 7227 292c 0a20 2020 2020 2020 205d  bar'),.        ]
-000031d0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000031e0: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
-000031f0: 615f 6d6f 6469 6679 5f6c 6f63 616c 5f61  a_modify_local_a
-00003200: 735f 6c65 6164 6572 2873 656c 6629 3a0a  s_leader(self):.
-00003210: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-00003220: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
-00003230: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00003240: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
-00003250: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
-00003260: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
-00003270: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00003280: 656c 6174 696f 6e5f 6964 2c20 276d 7961  elation_id, 'mya
-00003290: 7070 272c 207b 2770 6173 7377 6f72 6427  pp', {'password'
-000032a0: 3a20 2764 6561 6462 6565 6663 6166 6527  : 'deadbeefcafe'
-000032b0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-000032c0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-000032d0: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
-000032e0: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
-000032f0: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
-00003300: 656c 662e 6861 726e 6573 732e 7365 745f  elf.harness.set_
-00003310: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
-00003320: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
-00003330: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
-00003340: 2020 2020 2020 206c 6f63 616c 5f61 7070         local_app
-00003350: 203d 2073 656c 662e 6d6f 6465 6c2e 756e   = self.model.un
-00003360: 6974 2e61 7070 0a0a 2020 2020 2020 2020  it.app..        
-00003370: 7265 6c5f 6462 3120 3d20 7365 6c66 2e6d  rel_db1 = self.m
-00003380: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-00003390: 6e28 2764 6231 2729 0a20 2020 2020 2020  n('db1').       
-000033a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000033b0: 6c28 7265 6c5f 6462 312e 6461 7461 5b6c  l(rel_db1.data[l
-000033c0: 6f63 616c 5f61 7070 5d2c 207b 2770 6173  ocal_app], {'pas
-000033d0: 7377 6f72 6427 3a20 2764 6561 6462 6565  sword': 'deadbee
-000033e0: 6663 6166 6527 7d29 0a0a 2020 2020 2020  fcafe'})..      
-000033f0: 2020 7265 6c5f 6462 312e 6461 7461 5b6c    rel_db1.data[l
-00003400: 6f63 616c 5f61 7070 5d5b 2770 6173 7377  ocal_app]['passw
-00003410: 6f72 6427 5d20 3d20 2766 6f6f 270a 0a20  ord'] = 'foo'.. 
-00003420: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003430: 7274 4571 7561 6c28 7265 6c5f 6462 312e  rtEqual(rel_db1.
-00003440: 6461 7461 5b6c 6f63 616c 5f61 7070 5d5b  data[local_app][
-00003450: 2770 6173 7377 6f72 6427 5d2c 2027 666f  'password'], 'fo
-00003460: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
-00003470: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-00003480: 616c 6c73 280a 2020 2020 2020 2020 2020  alls(.          
-00003490: 2020 5b28 2772 656c 6174 696f 6e5f 6964    [('relation_id
-000034a0: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
-000034b0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-000034c0: 696f 6e5f 6c69 7374 272c 2031 292c 0a20  ion_list', 1),. 
-000034d0: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
-000034e0: 6c61 7469 6f6e 5f67 6574 272c 2031 2c20  lation_get', 1, 
-000034f0: 276d 7961 7070 272c 2054 7275 6529 2c0a  'myapp', True),.
-00003500: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
-00003510: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00003520: 6174 6127 2c20 312c 2073 656c 662e 6d6f  ata', 1, self.mo
-00003530: 6465 6c2e 6170 702c 2027 7061 7373 776f  del.app, 'passwo
-00003540: 7264 272c 2027 666f 6f27 295d 290a 0a20  rd', 'foo')]).. 
-00003550: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
-00003560: 7265 6c61 7469 6f6e 5f64 6174 615f 6d6f  relation_data_mo
-00003570: 6469 6679 5f6c 6f63 616c 5f61 735f 6d69  dify_local_as_mi
-00003580: 6e69 6f6e 2873 656c 6629 3a0a 2020 2020  nion(self):.    
-00003590: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
-000035a0: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
-000035b0: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
-000035c0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
-000035d0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-000035e0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-000035f0: 6174 696f 6e5f 6461 7461 2872 656c 6174  ation_data(relat
-00003600: 696f 6e5f 6964 2c20 276d 7961 7070 272c  ion_id, 'myapp',
-00003610: 207b 2770 6173 7377 6f72 6427 3a20 2764   {'password': 'd
-00003620: 6561 6462 6565 6663 6166 6527 7d29 0a20  eadbeefcafe'}). 
-00003630: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-00003640: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00003650: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-00003660: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
-00003670: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00003680: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
-00003690: 6572 2846 616c 7365 290a 2020 2020 2020  er(False).      
-000036a0: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
-000036b0: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
-000036c0: 2020 2020 6c6f 6361 6c5f 6170 7020 3d20      local_app = 
-000036d0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
-000036e0: 6170 700a 0a20 2020 2020 2020 2072 656c  app..        rel
-000036f0: 5f64 6231 203d 2073 656c 662e 6d6f 6465  _db1 = self.mode
-00003700: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
-00003710: 6462 3127 290a 2020 2020 2020 2020 7365  db1').        se
-00003720: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00003730: 656c 5f64 6231 2e64 6174 615b 6c6f 6361  el_db1.data[loca
-00003740: 6c5f 6170 705d 2c20 7b27 7061 7373 776f  l_app], {'passwo
-00003750: 7264 273a 2027 6465 6164 6265 6566 6361  rd': 'deadbeefca
-00003760: 6665 277d 290a 0a20 2020 2020 2020 2077  fe'})..        w
-00003770: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-00003780: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-00003790: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-000037a0: 2020 2020 2020 2020 2020 2320 6966 2077            # if w
-000037b0: 6520 7765 7265 2069 6e73 6964 6520 616e  e were inside an
-000037c0: 2065 7665 6e74 2063 6f6e 7465 7874 2c20   event context, 
-000037d0: 7765 2764 2067 6574 3a0a 2020 2020 2020  we'd get:.      
-000037e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000037f0: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00003800: 2e52 656c 6174 696f 6e44 6174 6145 7272  .RelationDataErr
-00003810: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00003820: 2020 2020 2072 656c 5f64 6231 2e64 6174       rel_db1.dat
-00003830: 615b 6c6f 6361 6c5f 6170 705d 5b27 7061  a[local_app]['pa
-00003840: 7373 776f 7264 275d 203d 2027 666f 6f62  ssword'] = 'foob
-00003850: 6172 270a 0a20 2020 2020 2020 2073 656c  ar'..        sel
-00003860: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-00003870: 616c 6c73 285b 2827 7265 6c61 7469 6f6e  alls([('relation
-00003880: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
-00003890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038b0: 2827 7265 6c61 7469 6f6e 5f6c 6973 7427  ('relation_list'
-000038c0: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
-000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038e0: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-000038f0: 6e5f 6765 7427 2c20 312c 2027 6d79 6170  n_get', 1, 'myap
-00003900: 7027 2c20 5472 7565 292c 0a20 2020 2020  p', True),.     
-00003910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003920: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
-00003930: 5f6c 6561 6465 7227 2c29 5d29 0a0a 2020  _leader',)])..  
-00003940: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-00003950: 696f 6e5f 6461 7461 5f61 6363 6573 735f  ion_data_access_
-00003960: 7065 6572 5f6c 6561 6465 7228 7365 6c66  peer_leader(self
-00003970: 293a 0a20 2020 2020 2020 2072 5f69 6420  ):.        r_id 
-00003980: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
-00003990: 6464 5f72 656c 6174 696f 6e28 2764 6232  dd_relation('db2
-000039a0: 272c 2027 6d79 6170 7027 290a 2020 2020  ', 'myapp').    
-000039b0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-000039c0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-000039d0: 6974 2872 5f69 642c 2027 6d79 6170 702f  it(r_id, 'myapp/
-000039e0: 3127 2920 2023 2070 6565 7221 0a20 2020  1')  # peer!.   
-000039f0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00003a00: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00003a10: 6e5f 6461 7461 2872 5f69 642c 2027 6d79  n_data(r_id, 'my
-00003a20: 6170 7027 2c20 7b27 666f 6f27 3a20 2762  app', {'foo': 'b
-00003a30: 6172 277d 290a 2020 2020 2020 2020 7769  ar'}).        wi
-00003a40: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
-00003a50: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
-00003a60: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
-00003a70: 2020 2020 2020 2020 2023 206c 6561 6465           # leade
-00003a80: 7273 2063 616e 2072 6561 640a 2020 2020  rs can read.    
-00003a90: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00003aa0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
-00003ab0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-00003ac0: 2020 7265 6c61 7469 6f6e 203d 2073 656c    relation = sel
-00003ad0: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
-00003ae0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00003af0: 3227 290a 2020 2020 2020 2020 2020 2020  2').            
-00003b00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00003b10: 2872 656c 6174 696f 6e2e 6461 7461 5b72  (relation.data[r
-00003b20: 656c 6174 696f 6e2e 6170 705d 5b27 666f  elation.app]['fo
-00003b30: 6f27 5d2c 2027 6261 7227 290a 0a20 2020  o'], 'bar')..   
-00003b40: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
-00003b50: 6f6e 5f64 6174 615f 6163 6365 7373 5f70  on_data_access_p
-00003b60: 6565 725f 6d69 6e69 6f6e 2873 656c 6629  eer_minion(self)
-00003b70: 3a0a 2020 2020 2020 2020 725f 6964 203d  :.        r_id =
-00003b80: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00003b90: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
-00003ba0: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
-00003bb0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00003bc0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00003bd0: 7428 725f 6964 2c20 276d 7961 7070 2f31  t(r_id, 'myapp/1
-00003be0: 2729 2020 2320 7065 6572 210a 2020 2020  ')  # peer!.    
-00003bf0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00003c00: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-00003c10: 5f64 6174 6128 725f 6964 2c20 276d 7961  _data(r_id, 'mya
-00003c20: 7070 272c 207b 2766 6f6f 273a 2027 6261  pp', {'foo': 'ba
-00003c30: 7227 7d29 0a20 2020 2020 2020 2077 6974  r'}).        wit
-00003c40: 6820 7365 6c66 2e68 6172 6e65 7373 2e5f  h self.harness._
-00003c50: 6576 656e 745f 636f 6e74 6578 7428 2766  event_context('f
-00003c60: 6f6f 5f65 7665 6e74 2729 3a0a 2020 2020  oo_event'):.    
-00003c70: 2020 2020 2020 2020 2320 6e6f 6e6c 6561          # nonlea
-00003c80: 6465 7273 2063 616e 2072 6561 640a 2020  ders can read.  
-00003c90: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00003ca0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-00003cb0: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
-00003cc0: 2020 2020 2072 656c 6174 696f 6e20 3d20       relation = 
-00003cd0: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
-00003ce0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-00003cf0: 2764 6232 2729 0a20 2020 2020 2020 2020  'db2').         
-00003d00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00003d10: 7561 6c28 7265 6c61 7469 6f6e 2e64 6174  ual(relation.dat
-00003d20: 615b 7265 6c61 7469 6f6e 2e61 7070 5d5b  a[relation.app][
-00003d30: 2766 6f6f 275d 2c20 2762 6172 2729 0a0a  'foo'], 'bar')..
-00003d40: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-00003d50: 6174 696f 6e5f 6461 7461 5f64 656c 5f6b  ation_data_del_k
-00003d60: 6579 2873 656c 6629 3a0a 2020 2020 2020  ey(self):.      
-00003d70: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
-00003d80: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00003d90: 5f72 656c 6174 696f 6e28 2764 6231 272c  _relation('db1',
-00003da0: 2027 7265 6d6f 7465 6170 7031 2729 0a20   'remoteapp1'). 
-00003db0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00003dc0: 2e68 6172 6e65 7373 2e5f 6576 656e 745f  .harness._event_
-00003dd0: 636f 6e74 6578 7428 2766 6f6f 5f65 7665  context('foo_eve
-00003de0: 6e74 2729 3a0a 2020 2020 2020 2020 2020  nt'):.          
-00003df0: 2020 7365 6c66 2e68 6172 6e65 7373 2e75    self.harness.u
-00003e00: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00003e10: 6174 6128 7265 6c61 7469 6f6e 5f69 642c  ata(relation_id,
-00003e20: 2027 6d79 6170 702f 3027 2c20 7b27 686f   'myapp/0', {'ho
-00003e30: 7374 273a 2027 6261 7227 7d29 0a20 2020  st': 'bar'}).   
-00003e40: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00003e50: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-00003e60: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
-00003e70: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
-00003e80: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00003e90: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
-00003ea0: 290a 0a20 2020 2020 2020 2072 656c 5f64  )..        rel_d
-00003eb0: 6231 203d 2073 656c 662e 6d6f 6465 6c2e  b1 = self.model.
-00003ec0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00003ed0: 3127 290a 2020 2020 2020 2020 2320 466f  1').        # Fo
-00003ee0: 7263 6520 6d65 6d6f 7279 2063 6163 6865  rce memory cache
-00003ef0: 2074 6f20 6265 206c 6f61 6465 642e 0a20   to be loaded.. 
-00003f00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003f10: 7274 496e 2827 686f 7374 272c 2072 656c  rtIn('host', rel
-00003f20: 5f64 6231 2e64 6174 615b 7365 6c66 2e6d  _db1.data[self.m
-00003f30: 6f64 656c 2e75 6e69 745d 290a 2020 2020  odel.unit]).    
-00003f40: 2020 2020 6465 6c20 7265 6c5f 6462 312e      del rel_db1.
-00003f50: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
-00003f60: 756e 6974 5d5b 2768 6f73 7427 5d0a 2020  unit]['host'].  
-00003f70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00003f80: 744e 6f74 496e 2827 686f 7374 272c 2072  tNotIn('host', r
-00003f90: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
-00003fa0: 2e6d 6f64 656c 2e75 6e69 745d 290a 2020  .model.unit]).  
-00003fb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00003fc0: 7445 7175 616c 287b 7d2c 2073 656c 662e  tEqual({}, self.
-00003fd0: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
-00003fe0: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
-00003ff0: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
-00004000: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-00004010: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-00004020: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
-00004030: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
-00004040: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
-00004050: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00004060: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
-00004070: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
-00004080: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
-00004090: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
-000040a0: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
-000040b0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-000040c0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-000040d0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
-000040e0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
-000040f0: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
-00004100: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
-00004110: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-00004120: 6174 696f 6e5f 6461 7461 5f64 656c 5f6d  ation_data_del_m
-00004130: 6973 7369 6e67 5f6b 6579 2873 656c 6629  issing_key(self)
-00004140: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
-00004150: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
-00004160: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00004170: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
-00004180: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
-00004190: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-000041a0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-000041b0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-000041c0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-000041d0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-000041e0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
-000041f0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
-00004200: 3027 2c20 7b27 686f 7374 273a 2027 6261  0', {'host': 'ba
-00004210: 7227 7d29 0a20 2020 2020 2020 2073 656c  r'}).        sel
-00004220: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
-00004230: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
-00004240: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
-00004250: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
-00004260: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
-00004270: 6e64 4361 6c6c 7328 290a 0a20 2020 2020  ndCalls()..     
-00004280: 2020 2072 656c 5f64 6231 203d 2073 656c     rel_db1 = sel
-00004290: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
-000042a0: 7469 6f6e 2827 6462 3127 290a 2020 2020  tion('db1').    
-000042b0: 2020 2020 2320 466f 7263 6520 6d65 6d6f      # Force memo
-000042c0: 7279 2063 6163 6865 2074 6f20 6265 206c  ry cache to be l
-000042d0: 6f61 6465 642e 0a20 2020 2020 2020 2073  oaded..        s
-000042e0: 656c 662e 6173 7365 7274 496e 2827 686f  elf.assertIn('ho
-000042f0: 7374 272c 2072 656c 5f64 6231 2e64 6174  st', rel_db1.dat
-00004300: 615b 7365 6c66 2e6d 6f64 656c 2e75 6e69  a[self.model.uni
-00004310: 745d 290a 2020 2020 2020 2020 7769 7468  t]).        with
-00004320: 2073 656c 662e 6861 726e 6573 732e 5f65   self.harness._e
-00004330: 7665 6e74 5f63 6f6e 7465 7874 2827 666f  vent_context('fo
-00004340: 6f5f 6576 656e 7427 293a 0a20 2020 2020  o_event'):.     
-00004350: 2020 2020 2020 2072 656c 5f64 6231 2e64         rel_db1.d
-00004360: 6174 615b 7365 6c66 2e6d 6f64 656c 2e75  ata[self.model.u
-00004370: 6e69 745d 5b27 706f 7274 275d 203d 2027  nit]['port'] = '
-00004380: 2720 2020 2320 5361 6d65 2061 7320 6120  '   # Same as a 
-00004390: 6465 6c65 7465 2c20 7368 6f75 6c64 206e  delete, should n
-000043a0: 6f74 2066 6169 6c2e 0a20 2020 2020 2020  ot fail..       
-000043b0: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
-000043c0: 6e28 2770 6f72 7427 2c20 7265 6c5f 6462  n('port', rel_db
-000043d0: 312e 6461 7461 5b73 656c 662e 6d6f 6465  1.data[self.mode
-000043e0: 6c2e 756e 6974 5d29 0a20 2020 2020 2020  l.unit]).       
-000043f0: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00004400: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00004410: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00004420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004430: 2e61 7373 6572 7445 7175 616c 287b 2768  .assertEqual({'h
-00004440: 6f73 7427 3a20 2762 6172 277d 2c0a 2020  ost': 'bar'},.  
-00004450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004460: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00004470: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
-00004480: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
-00004490: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
-000044a0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-000044b0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-000044c0: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
-000044d0: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
-000044e0: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
-000044f0: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00004500: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
-00004510: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
-00004520: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
-00004530: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
-00004540: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
-00004550: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00004560: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-00004570: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
-00004580: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
-00004590: 2e75 6e69 742c 2027 706f 7274 272c 2027  .unit, 'port', '
-000045a0: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
-000045b0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-000045c0: 6174 696f 6e5f 7365 745f 6661 696c 2873  ation_set_fail(s
-000045d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000045e0: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
-000045f0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-00004600: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
-00004610: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
-00004620: 2020 2077 6974 6820 7365 6c66 2e68 6172     with self.har
-00004630: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
-00004640: 6578 7428 2766 6f6f 5f65 7665 6e74 2729  ext('foo_event')
-00004650: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00004660: 6c66 2e68 6172 6e65 7373 2e75 7064 6174  lf.harness.updat
-00004670: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00004680: 7265 6c61 7469 6f6e 5f69 642c 2027 6d79  relation_id, 'my
-00004690: 6170 702f 3027 2c20 7b27 686f 7374 273a  app/0', {'host':
-000046a0: 2027 6d79 6170 702d 3027 7d29 0a20 2020   'myapp-0'}).   
-000046b0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-000046c0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-000046d0: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
-000046e0: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
-000046f0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00004700: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
-00004710: 290a 0a20 2020 2020 2020 2062 6163 6b65  )..        backe
-00004720: 6e64 203d 2073 656c 662e 6861 726e 6573  nd = self.harnes
-00004730: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-00004740: 2020 2023 2054 4f44 4f3a 206a 616d 2032     # TODO: jam 2
-00004750: 3032 302d 3033 2d30 3620 5468 6973 2069  020-03-06 This i
-00004760: 7320 7761 7920 746f 6f20 6d75 6368 2069  s way too much i
-00004770: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00004780: 2072 656c 6174 696f 6e5f 7365 740a 2020   relation_set.  
-00004790: 2020 2020 2020 2320 2020 2020 2020 5468        #       Th
-000047a0: 6520 6f72 6967 696e 616c 2074 6573 7420  e original test 
-000047b0: 666f 7263 6564 2027 7265 6c61 7469 6f6e  forced 'relation
-000047c0: 2d73 6574 2720 746f 2072 6574 7572 6e20  -set' to return 
-000047d0: 6578 6974 2063 6f64 6520 322c 0a20 2020  exit code 2,.   
-000047e0: 2020 2020 2023 2020 2020 2020 2062 7574       #       but
-000047f0: 2074 6865 7265 2077 6173 206e 6f74 6869   there was nothi
-00004800: 6e67 2069 6c6c 6567 616c 2061 626f 7574  ng illegal about
-00004810: 2074 6865 2064 6174 6120 7468 6174 2077   the data that w
-00004820: 6173 2062 6569 6e67 2073 6574 2c0a 2020  as being set,.  
-00004830: 2020 2020 2020 2320 2020 2020 2020 666f        #       fo
-00004840: 7220 7573 2074 6f20 7072 6f70 6572 6c79  r us to properly
-00004850: 2074 6573 7420 7468 6520 7369 6465 2065   test the side e
-00004860: 6666 6563 7473 206f 6620 7265 6c61 7469  ffects of relati
-00004870: 6f6e 2d73 6574 2066 6169 6c69 6e67 2e0a  on-set failing..
-00004880: 0a20 2020 2020 2020 2064 6566 2062 726f  .        def bro
-00004890: 6b65 6e5f 7570 6461 7465 5f72 656c 6174  ken_update_relat
-000048a0: 696f 6e5f 6461 7461 2872 656c 6174 696f  ion_data(relatio
-000048b0: 6e5f 6964 2c20 656e 7469 7479 2c20 6b65  n_id, entity, ke
-000048c0: 792c 2076 616c 7565 293a 0a20 2020 2020  y, value):.     
-000048d0: 2020 2020 2020 2062 6163 6b65 6e64 2e5f         backend._
-000048e0: 6361 6c6c 732e 6170 7065 6e64 2828 2775  calls.append(('u
-000048f0: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00004900: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
-00004910: 642c 2065 6e74 6974 792c 206b 6579 2c20  d, entity, key, 
-00004920: 7661 6c75 6529 290a 2020 2020 2020 2020  value)).        
-00004930: 2020 2020 7261 6973 6520 6f70 732e 4d6f      raise ops.Mo
-00004940: 6465 6c45 7272 6f72 2829 0a20 2020 2020  delError().     
-00004950: 2020 2062 6163 6b65 6e64 2e75 7064 6174     backend.updat
-00004960: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
-00004970: 3d20 6272 6f6b 656e 5f75 7064 6174 655f  = broken_update_
-00004980: 7265 6c61 7469 6f6e 5f64 6174 610a 0a20  relation_data.. 
-00004990: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
-000049a0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-000049b0: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
-000049c0: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
-000049d0: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
-000049e0: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
-000049f0: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
-00004a00: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
-00004a10: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
-00004a20: 2e75 6e69 745d 290a 0a20 2020 2020 2020  .unit])..       
-00004a30: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00004a40: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00004a50: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00004a60: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00004a70: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00004a80: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
-00004a90: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00004aa0: 2020 2020 7265 6c5f 6462 312e 6461 7461      rel_db1.data
-00004ab0: 5b73 656c 662e 6d6f 6465 6c2e 756e 6974  [self.model.unit
-00004ac0: 5d5b 2768 6f73 7427 5d20 3d20 2762 6172  ]['host'] = 'bar
-00004ad0: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
-00004ae0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00004af0: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
-00004b00: 2e6d 6f64 656c 2e75 6e69 745d 5b27 686f  .model.unit]['ho
-00004b10: 7374 275d 2c20 276d 7961 7070 2d30 2729  st'], 'myapp-0')
-00004b20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00004b30: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00004b40: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
-00004b50: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00004b60: 2020 2020 2064 656c 2072 656c 5f64 6231       del rel_db1
-00004b70: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
-00004b80: 2e75 6e69 745d 5b27 686f 7374 275d 0a20  .unit]['host']. 
-00004b90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00004ba0: 6173 7365 7274 496e 2827 686f 7374 272c  assertIn('host',
-00004bb0: 2072 656c 5f64 6231 2e64 6174 615b 7365   rel_db1.data[se
-00004bc0: 6c66 2e6d 6f64 656c 2e75 6e69 745d 290a  lf.model.unit]).
-00004bd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00004be0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
-00004bf0: 285b 0a20 2020 2020 2020 2020 2020 2028  ([.            (
-00004c00: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
-00004c10: 2764 6231 2729 2c0a 2020 2020 2020 2020  'db1'),.        
-00004c20: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
-00004c30: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
-00004c40: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-00004c50: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
-00004c60: 2072 656c 6174 696f 6e5f 6964 2c20 276d   relation_id, 'm
-00004c70: 7961 7070 2f30 272c 2046 616c 7365 292c  yapp/0', False),
-00004c80: 0a20 2020 2020 2020 2020 2020 2028 2775  .            ('u
-00004c90: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00004ca0: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
-00004cb0: 642c 2073 656c 662e 6d6f 6465 6c2e 756e  d, self.model.un
-00004cc0: 6974 2c20 2768 6f73 7427 2c20 2762 6172  it, 'host', 'bar
-00004cd0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00004ce0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-00004cf0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
-00004d00: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
-00004d10: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
-00004d20: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
-00004d30: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-00004d40: 6174 696f 6e5f 6461 7461 5f74 7970 655f  ation_data_type_
-00004d50: 6368 6563 6b28 7365 6c66 293a 0a20 2020  check(self):.   
-00004d60: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
-00004d70: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-00004d80: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00004d90: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
-00004da0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00004db0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00004dc0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
-00004dd0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
-00004de0: 3027 2c20 7b27 686f 7374 273a 2027 6d79  0', {'host': 'my
-00004df0: 6170 702d 3027 7d29 0a20 2020 2020 2020  app-0'}).       
-00004e00: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00004e10: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-00004e20: 7265 6c61 7469 6f6e 5f69 642c 2027 7265  relation_id, 're
-00004e30: 6d6f 7465 6170 7031 2f30 2729 0a20 2020  moteapp1/0').   
-00004e40: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
-00004e50: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
-00004e60: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
-00004e70: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00004e80: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
-00004e90: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-00004ea0: 2076 616c 7565 2069 6e20 280a 2020 2020   value in (.    
-00004eb0: 2020 2020 2020 2020 2020 2020 2827 666f              ('fo
-00004ec0: 6f27 2c20 3129 2c0a 2020 2020 2020 2020  o', 1),.        
-00004ed0: 2020 2020 2020 2020 2827 666f 6f27 2c20          ('foo', 
-00004ee0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
-00004ef0: 2020 2020 2020 2028 2766 6f6f 272c 207b         ('foo', {
-00004f00: 2766 6f6f 273a 2027 6261 7227 7d29 2c0a  'foo': 'bar'}),.
-00004f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f20: 2831 2c20 2766 6f6f 2729 2c0a 2020 2020  (1, 'foo'),.    
-00004f30: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
-00004f40: 652c 2027 666f 6f27 292c 0a20 2020 2020  e, 'foo'),.     
-00004f50: 2020 2020 2020 2020 2020 2028 2827 666f             (('fo
-00004f60: 6f27 2c20 2762 6172 2729 2c20 2766 6f6f  o', 'bar'), 'foo
-00004f70: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00004f80: 2020 2020 2831 2c20 3129 2c0a 2020 2020      (1, 1),.    
-00004f90: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
-00004fa0: 652c 204e 6f6e 6529 0a20 2020 2020 2020  e, None).       
-00004fb0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00004fc0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00004fd0: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
-00004fe0: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
-00004ff0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00005000: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-00005010: 2e66 7261 6d65 776f 726b 2e5f 6576 656e  .framework._even
-00005020: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
-00005030: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
-00005040: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
-00005050: 6462 312e 6461 7461 5b73 656c 662e 6d6f  db1.data[self.mo
-00005060: 6465 6c2e 756e 6974 5d5b 6b65 795d 203d  del.unit][key] =
-00005070: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
-00005080: 2320 4e6f 2064 6174 6120 6861 7320 6163  # No data has ac
-00005090: 7475 616c 6c79 2062 6565 6e20 6368 616e  tually been chan
-000050a0: 6765 640a 2020 2020 2020 2020 7365 6c66  ged.        self
-000050b0: 2e61 7373 6572 7445 7175 616c 2864 6963  .assertEqual(dic
-000050c0: 7428 7265 6c5f 6462 312e 6461 7461 5b73  t(rel_db1.data[s
-000050d0: 656c 662e 6d6f 6465 6c2e 756e 6974 5d29  elf.model.unit])
-000050e0: 2c20 7b27 686f 7374 273a 2027 6d79 6170  , {'host': 'myap
-000050f0: 702d 3027 7d29 0a0a 2020 2020 2020 2020  p-0'})..        
-00005100: 7365 6c66 2e61 7373 6572 7442 6163 6b65  self.assertBacke
-00005110: 6e64 4361 6c6c 7328 5b0a 2020 2020 2020  ndCalls([.      
-00005120: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-00005130: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
-00005140: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
-00005150: 6174 696f 6e5f 6c69 7374 272c 2072 656c  ation_list', rel
-00005160: 6174 696f 6e5f 6964 292c 0a20 2020 2020  ation_id),.     
-00005170: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00005180: 6e5f 6765 7427 2c20 7265 6c61 7469 6f6e  n_get', relation
-00005190: 5f69 642c 2027 6d79 6170 702f 3027 2c20  _id, 'myapp/0', 
-000051a0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-000051b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-000051c0: 5f72 656c 6174 696f 6e5f 6c6f 6361 6c5f  _relation_local_
-000051d0: 6170 705f 6461 7461 5f72 6561 6461 6269  app_data_readabi
-000051e0: 6c69 7479 5f6c 6561 6465 7228 7365 6c66  lity_leader(self
-000051f0: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
-00005200: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
-00005210: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00005220: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
-00005230: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
-00005240: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
-00005250: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00005260: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
-00005270: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
-00005280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052a0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
-000052b0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
-000052c0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-000052d0: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
-000052e0: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-000052f0: 6174 696f 6e5f 6964 2c20 276d 7961 7070  ation_id, 'myapp
-00005300: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005320: 2020 2020 2020 2020 2020 2020 207b 276c               {'l
-00005330: 6f63 616c 273a 2027 6461 7461 277d 290a  ocal': 'data'}).
-00005340: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00005350: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00005360: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
-00005370: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
-00005380: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
-00005390: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
-000053a0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-000053b0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-000053c0: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
-000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053f0: 2020 2020 2020 7b27 686f 7374 273a 2027        {'host': '
-00005400: 7265 6d6f 7465 6170 7031 2f30 277d 290a  remoteapp1/0'}).
-00005410: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-00005420: 656c 2e72 656c 6174 696f 6e73 2e5f 696e  el.relations._in
-00005430: 7661 6c69 6461 7465 2827 6462 3127 290a  validate('db1').
-00005440: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-00005450: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
-00005460: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
-00005470: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
-00005480: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
-00005490: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000054a0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-000054b0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-000054c0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
-000054d0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-000054e0: 6c66 2e72 6573 6574 4261 636b 656e 6443  lf.resetBackendC
-000054f0: 616c 6c73 2829 0a0a 2020 2020 2020 2020  alls()..        
-00005500: 6c6f 6361 6c5f 6170 7020 3d20 7365 6c66  local_app = self
-00005510: 2e68 6172 6e65 7373 2e63 6861 726d 2e61  .harness.charm.a
-00005520: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
-00005530: 7265 7365 7442 6163 6b65 6e64 4361 6c6c  resetBackendCall
-00005540: 7328 290a 0a20 2020 2020 2020 2023 2061  s()..        # a
-00005550: 6464 7265 7373 696e 6720 7468 6520 6f62  ddressing the ob
-00005560: 6a65 6374 2069 7320 4f4b 0a20 2020 2020  ject is OK.     
-00005570: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
-00005580: 6c6f 6361 6c5f 6170 705d 0a0a 2020 2020  local_app]..    
-00005590: 2020 2020 7365 6c66 2e61 7373 6572 7442      self.assertB
-000055a0: 6163 6b65 6e64 4361 6c6c 7328 5b5d 290a  ackendCalls([]).
-000055b0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-000055c0: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
-000055d0: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
-000055e0: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
-000055f0: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
-00005600: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
-00005610: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00005620: 7373 6572 7445 7175 616c 2872 656c 5f64  ssertEqual(rel_d
-00005630: 6231 2e64 6174 615b 6c6f 6361 6c5f 6170  b1.data[local_ap
-00005640: 705d 5b27 6c6f 6361 6c27 5d2c 2027 6461  p]['local'], 'da
-00005650: 7461 2729 0a0a 2020 2020 2020 2020 2020  ta')..          
-00005660: 2020 7365 6c66 2e61 7373 6572 7442 6163    self.assertBac
-00005670: 6b65 6e64 4361 6c6c 7328 5b28 2769 735f  kendCalls([('is_
-00005680: 6c65 6164 6572 272c 292c 0a20 2020 2020  leader',),.     
-00005690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056b0: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
-000056c0: 2031 2c20 276d 7961 7070 272c 2054 7275   1, 'myapp', Tru
-000056d0: 6529 5d29 0a0a 2020 2020 2020 2020 2020  e)])..          
-000056e0: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
-000056f0: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
-00005700: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005710: 6572 7445 7175 616c 2872 6570 7228 7265  ertEqual(repr(re
-00005720: 6c5f 6462 312e 6461 7461 5b6c 6f63 616c  l_db1.data[local
-00005730: 5f61 7070 5d29 2c20 7265 7072 287b 276c  _app]), repr({'l
-00005740: 6f63 616c 273a 2027 6461 7461 277d 2929  ocal': 'data'}))
-00005750: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00005760: 7765 2064 6f6e 2774 2067 6574 2074 6865  we don't get the
-00005770: 2064 6174 612c 2062 6563 6175 7365 2077   data, because w
-00005780: 6527 7265 206c 617a 790a 2020 2020 2020  e're lazy.      
-00005790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000057a0: 7442 6163 6b65 6e64 4361 6c6c 7328 5b28  tBackendCalls([(
-000057b0: 2769 735f 6c65 6164 6572 272c 295d 290a  'is_leader',)]).
-000057c0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-000057d0: 7320 7765 6c6c 2061 7320 7265 6c61 7469  s well as relati
-000057e0: 6f6e 2064 6174 6120 7265 7072 2829 2069  on data repr() i
-000057f0: 6e20 6765 6e65 7261 6c3a 0a20 2020 2020  n general:.     
-00005800: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00005810: 7274 4973 496e 7374 616e 6365 2872 6570  rtIsInstance(rep
-00005820: 7228 7265 6c5f 6462 312e 6461 7461 292c  r(rel_db1.data),
-00005830: 2073 7472 290a 0a20 2020 2064 6566 2074   str)..    def t
-00005840: 6573 745f 7265 6c61 7469 6f6e 5f6c 6f63  est_relation_loc
-00005850: 616c 5f61 7070 5f64 6174 615f 7265 6164  al_app_data_read
-00005860: 6162 696c 6974 795f 666f 6c6c 6f77 6572  ability_follower
-00005870: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00005880: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
-00005890: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-000058a0: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
-000058b0: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
-000058c0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-000058d0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
-000058e0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
-000058f0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00005900: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
-00005910: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00005920: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
-00005930: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
-00005940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005960: 2020 2020 2020 2020 2020 207b 2773 6563             {'sec
-00005970: 7265 7427 3a20 2763 6166 6564 6561 6462  ret': 'cafedeadb
-00005980: 6565 6627 7d29 0a20 2020 2020 2020 2020  eef'}).         
-00005990: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-000059a0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-000059b0: 6461 7461 2872 656c 6174 696f 6e5f 6964  data(relation_id
-000059c0: 2c20 276d 7961 7070 272c 0a20 2020 2020  , 'myapp',.     
-000059d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059f0: 2020 2020 2020 2020 207b 276c 6f63 616c           {'local
-00005a00: 273a 2027 6461 7461 277d 290a 0a20 2020  ': 'data'})..   
-00005a10: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00005a20: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00005a30: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
-00005a40: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
-00005a50: 2f30 2729 0a20 2020 2020 2020 2020 2020  /0').           
-00005a60: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
-00005a70: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00005a80: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
-00005a90: 2772 656d 6f74 6561 7070 312f 3027 2c0a  'remoteapp1/0',.
-00005aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ac0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-00005ad0: 686f 7374 273a 2027 7265 6d6f 7465 6170  host': 'remoteap
-00005ae0: 7031 2f30 277d 290a 2020 2020 2020 2020  p1/0'}).        
-00005af0: 7365 6c66 2e6d 6f64 656c 2e72 656c 6174  self.model.relat
-00005b00: 696f 6e73 2e5f 696e 7661 6c69 6461 7465  ions._invalidate
-00005b10: 2827 6462 3127 290a 2020 2020 2020 2020  ('db1').        
-00005b20: 7365 6c66 2e72 6573 6574 4261 636b 656e  self.resetBacken
-00005b30: 6443 616c 6c73 2829 0a0a 2020 2020 2020  dCalls()..      
-00005b40: 2020 7265 6c5f 6462 3120 3d20 7365 6c66    rel_db1 = self
-00005b50: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
-00005b60: 696f 6e28 2764 6231 2729 0a20 2020 2020  ion('db1').     
-00005b70: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00005b80: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-00005b90: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
-00005ba0: 5f6c 6561 6465 7228 4661 6c73 6529 0a0a  _leader(False)..
-00005bb0: 2020 2020 2020 2020 6c6f 6361 6c5f 6170          local_ap
-00005bc0: 7020 3d20 7365 6c66 2e68 6172 6e65 7373  p = self.harness
-00005bd0: 2e63 6861 726d 2e61 7070 0a20 2020 2020  .charm.app.     
-00005be0: 2020 2023 2061 6464 7265 7373 696e 6720     # addressing 
-00005bf0: 7468 6520 6f62 6a65 6374 2069 7320 4f4b  the object is OK
-00005c00: 0a20 2020 2020 2020 2072 656c 5f64 6231  .        rel_db1
-00005c10: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
-00005c20: 0a20 2020 2020 2020 2023 206e 6f6e 6c65  .        # nonle
-00005c30: 6164 6572 2075 6e69 7473 2063 616e 6e6f  ader units canno
-00005c40: 7420 7265 6164 2074 6865 6972 206c 6f63  t read their loc
-00005c50: 616c 2061 7070 2064 6174 6162 6167 0a20  al app databag. 
-00005c60: 2020 2020 2020 2023 2061 7474 656d 7074         # attempt
-00005c70: 696e 6720 746f 2072 6561 6420 6974 2069  ing to read it i
-00005c80: 7320 6e6f 740a 2020 2020 2020 2020 7769  s not.        wi
-00005c90: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
-00005ca0: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
-00005cb0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
-00005cc0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00005cd0: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
-00005ce0: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
-00005cf0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00005d00: 6169 7365 7328 6f70 732e 5265 6c61 7469  aises(ops.Relati
-00005d10: 6f6e 4461 7461 4572 726f 7229 3a0a 2020  onDataError):.  
-00005d20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00005d30: 276c 6f63 616c 2720 6973 2074 6865 7265  'local' is there
-00005d40: 2c20 6275 7420 7374 696c 6c3a 0a20 2020  , but still:.   
-00005d50: 2020 2020 2020 2020 2020 2020 2072 656c               rel
-00005d60: 5f64 6231 2e64 6174 615b 6c6f 6361 6c5f  _db1.data[local_
-00005d70: 6170 705d 5b27 6c6f 6361 6c27 5d0a 0a20  app]['local'].. 
-00005d80: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
-00005d90: 6469 646e 2774 2065 7665 6e20 6765 7420  didn't even get 
-00005da0: 746f 2072 656c 6174 696f 6e2d 6765 740a  to relation-get.
-00005db0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005dc0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-00005dd0: 6c6c 7328 5b28 2769 735f 6c65 6164 6572  lls([('is_leader
-00005de0: 272c 2029 5d29 0a0a 2020 2020 2020 2020  ', )])..        
-00005df0: 2020 2020 2320 7765 2063 616e 2774 2073      # we can't s
-00005e00: 6565 2069 7420 6275 7420 7265 7072 2829  ee it but repr()
-00005e10: 2077 6f72 6b73 0a20 2020 2020 2020 2020   works.         
-00005e20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00005e30: 7561 6c28 7265 7072 2872 656c 5f64 6231  ual(repr(rel_db1
-00005e40: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
-00005e50: 292c 2027 3c6e 2f61 3e27 290a 2020 2020  ), '<n/a>').    
-00005e60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005e70: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
-00005e80: 5b28 2769 735f 6c65 6164 6572 272c 2029  [('is_leader', )
-00005e90: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00005ea0: 2320 6173 2077 656c 6c20 6173 2072 656c  # as well as rel
-00005eb0: 6174 696f 6e20 6461 7461 2072 6570 7228  ation data repr(
-00005ec0: 2920 696e 2067 656e 6572 616c 3a0a 2020  ) in general:.  
-00005ed0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00005ee0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-00005ef0: 7265 7072 2872 656c 5f64 6231 2e64 6174  repr(rel_db1.dat
-00005f00: 6129 2c20 7374 7229 0a0a 2020 2020 2020  a), str)..      
-00005f10: 2020 2020 2020 6578 7065 6374 6564 5f62        expected_b
-00005f20: 6163 6b65 6e64 5f63 616c 6c73 203d 205b  ackend_calls = [
-00005f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005f40: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
-00005f50: 2c20 312c 2027 6d79 6170 702f 3027 2c20  , 1, 'myapp/0', 
-00005f60: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-00005f70: 2020 2020 2020 2020 2827 6973 5f6c 6561          ('is_lea
-00005f80: 6465 7227 2c29 2c0a 2020 2020 2020 2020  der',),.        
-00005f90: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
-00005fa0: 6f6e 5f67 6574 272c 2031 2c20 2772 656d  on_get', 1, 'rem
-00005fb0: 6f74 6561 7070 312f 3027 2c20 4661 6c73  oteapp1/0', Fals
-00005fc0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00005fd0: 2020 2020 2827 6973 5f6c 6561 6465 7227      ('is_leader'
-00005fe0: 2c29 2c0a 2020 2020 2020 2020 2020 2020  ,),.            
-00005ff0: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
-00006000: 6574 272c 2031 2c20 2772 656d 6f74 6561  et', 1, 'remotea
-00006010: 7070 3127 2c20 5472 7565 295d 0a20 2020  pp1', True)].   
-00006020: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00006030: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
-00006040: 2865 7870 6563 7465 645f 6261 636b 656e  (expected_backen
-00006050: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
-00006060: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-00006070: 6e6f 5f75 6e69 7473 2873 656c 6629 3a0a  no_units(self):.
-00006080: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00006090: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-000060a0: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
-000060b0: 6170 7031 2729 0a20 2020 2020 2020 2072  app1').        r
-000060c0: 656c 203d 2073 656c 662e 6d6f 6465 6c2e  el = self.model.
-000060d0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-000060e0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-000060f0: 2e61 7373 6572 7445 7175 616c 2872 656c  .assertEqual(rel
-00006100: 2e75 6e69 7473 2c20 7365 7428 2929 0a20  .units, set()). 
-00006110: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006120: 7274 4973 2872 656c 2e61 7070 2c20 7365  rtIs(rel.app, se
-00006130: 6c66 2e6d 6f64 656c 2e67 6574 5f61 7070  lf.model.get_app
-00006140: 2827 7265 6d6f 7465 6170 7031 2729 290a  ('remoteapp1')).
-00006150: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00006160: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
-00006170: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-00006180: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
-00006190: 6462 3127 292c 0a20 2020 2020 2020 2020  db1'),.         
-000061a0: 2020 2028 2772 656c 6174 696f 6e5f 6c69     ('relation_li
-000061b0: 7374 272c 2031 292c 0a20 2020 2020 2020  st', 1),.       
-000061c0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-000061d0: 7265 6d6f 7465 5f61 7070 5f6e 616d 6527  remote_app_name'
-000061e0: 2c20 3129 2c0a 2020 2020 2020 2020 5d29  , 1),.        ])
-000061f0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00006200: 6f6e 6669 6728 7365 6c66 293a 0a20 2020  onfig(self):.   
-00006210: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00006220: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
-00006230: 616c 6c73 2872 6573 6574 3d54 7275 6529  alls(reset=True)
-00006240: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00006250: 726e 6573 732e 7570 6461 7465 5f63 6f6e  rness.update_con
-00006260: 6669 6728 7b27 666f 6f27 3a20 2766 6f6f  fig({'foo': 'foo
-00006270: 272c 2027 6261 7227 3a20 312c 2027 7175  ', 'bar': 1, 'qu
-00006280: 7827 3a20 5472 7565 7d29 0a20 2020 2020  x': True}).     
-00006290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000062a0: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e63  ual(self.model.c
-000062b0: 6f6e 6669 672c 207b 0a20 2020 2020 2020  onfig, {.       
-000062c0: 2020 2020 2027 666f 6f27 3a20 2766 6f6f       'foo': 'foo
-000062d0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000062e0: 6261 7227 3a20 312c 0a20 2020 2020 2020  bar': 1,.       
-000062f0: 2020 2020 2027 7175 7827 3a20 5472 7565       'qux': True
-00006300: 2c0a 2020 2020 2020 2020 7d29 0a20 2020  ,.        }).   
-00006310: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00006320: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-00006330: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00006340: 2020 2020 2320 436f 6e66 6972 6d20 7468      # Confirm th
-00006350: 6174 2077 6520 6361 6e6e 6f74 206d 6f64  at we cannot mod
-00006360: 6966 7920 636f 6e66 6967 2076 616c 7565  ify config value
-00006370: 732e 0a20 2020 2020 2020 2020 2020 2073  s..            s
-00006380: 656c 662e 6d6f 6465 6c2e 636f 6e66 6967  elf.model.config
-00006390: 5b27 666f 6f27 5d20 3d20 2762 6172 270a  ['foo'] = 'bar'.
-000063a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000063b0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
-000063c0: 285b 2827 636f 6e66 6967 5f67 6574 272c  ([('config_get',
-000063d0: 295d 290a 0a20 2020 2064 6566 2074 6573  )])..    def tes
-000063e0: 745f 636f 6e66 6967 5f69 6d6d 7574 6162  t_config_immutab
-000063f0: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
-00006400: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00006410: 7274 5261 6973 6573 2841 7474 7269 6275  rtRaises(Attribu
-00006420: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
-00006430: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-00006440: 2e63 6f6e 6669 6720 3d20 7b7d 0a0a 2020  .config = {}..  
-00006450: 2020 6465 6620 7465 7374 5f69 735f 6c65    def test_is_le
-00006460: 6164 6572 2873 656c 6629 3a0a 2020 2020  ader(self):.    
-00006470: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
-00006480: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
-00006490: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
-000064a0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
-000064b0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-000064c0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-000064d0: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
-000064e0: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
-000064f0: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
-00006500: 662e 6861 726e 6573 732e 7365 745f 6c65  f.harness.set_le
-00006510: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
-00006520: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
-00006530: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
-00006540: 2020 2020 2064 6566 2063 6865 636b 5f72       def check_r
-00006550: 656d 6f74 655f 756e 6974 7328 293a 0a20  emote_units():. 
-00006560: 2020 2020 2020 2020 2020 2023 2043 616e             # Can
-00006570: 6e6f 7420 6465 7465 726d 696e 6520 6c65  not determine le
-00006580: 6164 6572 7368 6970 2066 6f72 2072 656d  adership for rem
-00006590: 6f74 6520 756e 6974 732e 0a20 2020 2020  ote units..     
-000065a0: 2020 2020 2020 2066 6f72 2075 2069 6e20         for u in 
-000065b0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-000065c0: 656c 6174 696f 6e28 2764 6231 2729 2e75  elation('db1').u
-000065d0: 6e69 7473 3a0a 2020 2020 2020 2020 2020  nits:.          
-000065e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000065f0: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-00006600: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-00006610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006620: 752e 6973 5f6c 6561 6465 7228 290a 0a20  u.is_leader().. 
-00006630: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006640: 7274 5472 7565 2873 656c 662e 6d6f 6465  rtTrue(self.mode
-00006650: 6c2e 756e 6974 2e69 735f 6c65 6164 6572  l.unit.is_leader
-00006660: 2829 290a 0a20 2020 2020 2020 2063 6865  ())..        che
-00006670: 636b 5f72 656d 6f74 655f 756e 6974 7328  ck_remote_units(
-00006680: 290a 0a20 2020 2020 2020 2023 2043 7265  )..        # Cre
-00006690: 6174 6520 6120 6e65 7720 6d6f 6465 6c20  ate a new model 
-000066a0: 616e 6420 6261 636b 656e 6420 746f 2064  and backend to d
-000066b0: 726f 7020 6120 6361 6368 6564 2069 732d  rop a cached is-
-000066c0: 6c65 6164 6572 206f 7574 7075 742e 0a20  leader output.. 
-000066d0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-000066e0: 6573 732e 7365 745f 6c65 6164 6572 2846  ess.set_leader(F
-000066f0: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
-00006700: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-00006710: 656c 662e 6d6f 6465 6c2e 756e 6974 2e69  elf.model.unit.i
-00006720: 735f 6c65 6164 6572 2829 290a 0a20 2020  s_leader())..   
-00006730: 2020 2020 2063 6865 636b 5f72 656d 6f74       check_remot
-00006740: 655f 756e 6974 7328 290a 0a20 2020 2020  e_units()..     
-00006750: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
-00006760: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
-00006770: 2020 2020 2020 2020 2028 2769 735f 6c65           ('is_le
-00006780: 6164 6572 272c 292c 0a20 2020 2020 2020  ader',),.       
-00006790: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-000067a0: 6964 7327 2c20 2764 6231 2729 2c0a 2020  ids', 'db1'),.  
-000067b0: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-000067c0: 7469 6f6e 5f6c 6973 7427 2c20 7265 6c61  tion_list', rela
-000067d0: 7469 6f6e 5f69 6429 2c0a 2020 2020 2020  tion_id),.      
-000067e0: 2020 2020 2020 2827 6973 5f6c 6561 6465        ('is_leade
-000067f0: 7227 2c29 2c0a 2020 2020 2020 2020 5d29  r',),.        ])
-00006800: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-00006810: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
-00006820: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00006830: 656c 662e 6d6f 6465 6c2e 756e 6974 2e73  elf.model.unit.s
-00006840: 6574 5f77 6f72 6b6c 6f61 645f 7665 7273  et_workload_vers
-00006850: 696f 6e28 2731 2e32 2e33 2729 0a20 2020  ion('1.2.3').   
-00006860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006870: 4261 636b 656e 6443 616c 6c73 285b 0a20  BackendCalls([. 
-00006880: 2020 2020 2020 2020 2020 2028 2761 7070             ('app
-00006890: 6c69 6361 7469 6f6e 5f76 6572 7369 6f6e  lication_version
-000068a0: 5f73 6574 272c 2027 312e 322e 3327 292c  _set', '1.2.3'),
-000068b0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-000068c0: 2064 6566 2074 6573 745f 776f 726b 6c6f   def test_worklo
-000068d0: 6164 5f76 6572 7369 6f6e 5f69 6e76 616c  ad_version_inval
-000068e0: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
-000068f0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00006900: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
-00006910: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-00006920: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-00006930: 6c2e 756e 6974 2e73 6574 5f77 6f72 6b6c  l.unit.set_workl
-00006940: 6f61 645f 7665 7273 696f 6e28 3529 0a20  oad_version(5). 
-00006950: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006960: 7274 4571 7561 6c28 7374 7228 636d 2e65  rtEqual(str(cm.e
-00006970: 7863 6570 7469 6f6e 292c 2022 776f 726b  xception), "work
-00006980: 6c6f 6164 2076 6572 7369 6f6e 206d 7573  load version mus
-00006990: 7420 6265 2061 2073 7472 2c20 6e6f 7420  t be a str, not 
-000069a0: 696e 743a 2035 2229 0a20 2020 2020 2020  int: 5").       
-000069b0: 2073 656c 662e 6173 7365 7274 4261 636b   self.assertBack
-000069c0: 656e 6443 616c 6c73 285b 5d29 0a0a 2020  endCalls([])..  
-000069d0: 2020 6465 6620 7465 7374 5f72 6573 6f75    def test_resou
-000069e0: 7263 6573 2873 656c 6629 3a0a 2020 2020  rces(self):.    
-000069f0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00006a00: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
-00006a10: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-00006a20: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00006a30: 6e65 7373 2e6d 6f64 656c 2e72 6573 6f75  ness.model.resou
-00006a40: 7263 6573 2e66 6574 6368 2827 666f 6f27  rces.fetch('foo'
-00006a50: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00006a60: 6861 726e 6573 732e 6164 645f 7265 736f  harness.add_reso
-00006a70: 7572 6365 2827 666f 6f27 2c20 2766 6f6f  urce('foo', 'foo
-00006a80: 2063 6f6e 7465 6e74 735c 6e27 290a 2020   contents\n').  
-00006a90: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00006aa0: 7373 2e61 6464 5f72 6573 6f75 7263 6528  ss.add_resource(
-00006ab0: 2762 6172 272c 2027 2729 0a0a 2020 2020  'bar', '')..    
-00006ac0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00006ad0: 7365 7274 5261 6973 6573 284e 616d 6545  sertRaises(NameE
-00006ae0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00006af0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00006b00: 6d6f 6465 6c2e 7265 736f 7572 6365 732e  model.resources.
-00006b10: 6665 7463 6828 2771 7578 2729 0a0a 2020  fetch('qux')..  
-00006b20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006b30: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
-00006b40: 6573 732e 6d6f 6465 6c2e 7265 736f 7572  ess.model.resour
-00006b50: 6365 732e 6665 7463 6828 2766 6f6f 2729  ces.fetch('foo')
-00006b60: 2e6e 616d 652c 2027 666f 6f2e 7478 7427  .name, 'foo.txt'
-00006b70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006b80: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-00006b90: 6861 726e 6573 732e 6d6f 6465 6c2e 7265  harness.model.re
-00006ba0: 736f 7572 6365 732e 6665 7463 6828 2762  sources.fetch('b
-00006bb0: 6172 2729 2e6e 616d 652c 2027 6261 722e  ar').name, 'bar.
-00006bc0: 7478 7427 290a 0a20 2020 2064 6566 2074  txt')..    def t
-00006bd0: 6573 745f 7265 736f 7572 6365 735f 696d  est_resources_im
-00006be0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
-00006bf0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00006c00: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
-00006c10: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00006c20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006c30: 6d6f 6465 6c2e 7265 736f 7572 6365 7320  model.resources 
-00006c40: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
-00006c50: 6465 6620 7465 7374 5f70 6f64 5f73 7065  def test_pod_spe
-00006c60: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
-00006c70: 2073 656c 662e 6861 726e 6573 732e 7365   self.harness.se
-00006c80: 745f 6c65 6164 6572 2854 7275 6529 0a20  t_leader(True). 
-00006c90: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-00006ca0: 6573 732e 6d6f 6465 6c2e 706f 642e 7365  ess.model.pod.se
-00006cb0: 745f 7370 6563 287b 2766 6f6f 273a 2027  t_spec({'foo': '
-00006cc0: 6261 7227 7d29 0a20 2020 2020 2020 2073  bar'}).        s
-00006cd0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006ce0: 7365 6c66 2e68 6172 6e65 7373 2e67 6574  self.harness.get
-00006cf0: 5f70 6f64 5f73 7065 6328 292c 2028 7b27  _pod_spec(), ({'
-00006d00: 666f 6f27 3a20 2762 6172 277d 2c20 4e6f  foo': 'bar'}, No
-00006d10: 6e65 2929 0a0a 2020 2020 2020 2020 7365  ne))..        se
-00006d20: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
-00006d30: 2e70 6f64 2e73 6574 5f73 7065 6328 7b27  .pod.set_spec({'
-00006d40: 6261 7227 3a20 2766 6f6f 277d 2c20 7b27  bar': 'foo'}, {'
-00006d50: 7175 7827 3a20 2762 617a 277d 290a 2020  qux': 'baz'}).  
-00006d60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006d70: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
-00006d80: 6573 732e 6765 745f 706f 645f 7370 6563  ess.get_pod_spec
-00006d90: 2829 2c20 287b 2762 6172 273a 2027 666f  (), ({'bar': 'fo
-00006da0: 6f27 7d2c 207b 2771 7578 273a 2027 6261  o'}, {'qux': 'ba
-00006db0: 7a27 7d29 290a 0a20 2020 2020 2020 2023  z'}))..        #
-00006dc0: 206e 6f20 6c65 6164 6572 202d 3e20 6e6f   no leader -> no
-00006dd0: 2073 6574 2070 6f64 2073 7065 630a 2020   set pod spec.  
-00006de0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00006df0: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
-00006e00: 6c73 6529 0a20 2020 2020 2020 2077 6974  lse).        wit
-00006e10: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00006e20: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
-00006e30: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00006e40: 2073 656c 662e 6861 726e 6573 732e 6d6f   self.harness.mo
-00006e50: 6465 6c2e 706f 642e 7365 745f 7370 6563  del.pod.set_spec
-00006e60: 287b 2766 6f6f 273a 2027 6261 7227 7d29  ({'foo': 'bar'})
-00006e70: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-00006e80: 6f64 5f69 6d6d 7574 6162 6c65 2873 656c  od_immutable(sel
-00006e90: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
-00006ea0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00006eb0: 6573 2841 7474 7269 6275 7465 4572 726f  es(AttributeErro
-00006ec0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00006ed0: 7365 6c66 2e6d 6f64 656c 2e70 6f64 203d  self.model.pod =
-00006ee0: 206f 626a 6563 7428 290a 0a20 2020 2064   object()..    d
-00006ef0: 6566 2074 6573 745f 6261 7365 5f73 7461  ef test_base_sta
-00006f00: 7475 735f 696e 7374 616e 6365 5f72 6169  tus_instance_rai
-00006f10: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
-00006f20: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00006f30: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-00006f40: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00006f50: 2020 6f70 732e 5374 6174 7573 4261 7365    ops.StatusBase
-00006f60: 2827 7465 7374 2729 0a0a 2020 2020 2020  ('test')..      
-00006f70: 2020 636c 6173 7320 4e6f 4e61 6d65 5374    class NoNameSt
-00006f80: 6174 7573 286f 7073 2e53 7461 7475 7342  atus(ops.StatusB
-00006f90: 6173 6529 3a0a 2020 2020 2020 2020 2020  ase):.          
-00006fa0: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-00006fb0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00006fc0: 5261 6973 6573 2841 7474 7269 6275 7465  Raises(Attribute
-00006fd0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00006fe0: 2020 2020 6f70 732e 5374 6174 7573 4261      ops.StatusBa
-00006ff0: 7365 2e72 6567 6973 7465 725f 7374 6174  se.register_stat
-00007000: 7573 284e 6f4e 616d 6553 7461 7475 7329  us(NoNameStatus)
-00007010: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00007020: 7461 7475 735f 7265 7072 2873 656c 6629  tatus_repr(self)
-00007030: 3a0a 2020 2020 2020 2020 7465 7374 5f63  :.        test_c
-00007040: 6173 6573 203d 207b 0a20 2020 2020 2020  ases = {.       
-00007050: 2020 2020 2022 4163 7469 7665 5374 6174       "ActiveStat
-00007060: 7573 2827 5365 6173 6865 6c6c 2729 223a  us('Seashell')":
-00007070: 206f 7073 2e41 6374 6976 6553 7461 7475   ops.ActiveStatu
-00007080: 7328 2753 6561 7368 656c 6c27 292c 0a20  s('Seashell'),. 
-00007090: 2020 2020 2020 2020 2020 2022 4d61 696e             "Main
-000070a0: 7465 6e61 6e63 6553 7461 7475 7328 2752  tenanceStatus('R
-000070b0: 6564 2729 223a 206f 7073 2e4d 6169 6e74  ed')": ops.Maint
-000070c0: 656e 616e 6365 5374 6174 7573 2827 5265  enanceStatus('Re
-000070d0: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
-000070e0: 2022 426c 6f63 6b65 6453 7461 7475 7328   "BlockedStatus(
-000070f0: 274d 6167 656e 7461 2729 223a 206f 7073  'Magenta')": ops
-00007100: 2e42 6c6f 636b 6564 5374 6174 7573 2827  .BlockedStatus('
-00007110: 4d61 6765 6e74 6127 292c 0a20 2020 2020  Magenta'),.     
-00007120: 2020 2020 2020 2022 5761 6974 696e 6753         "WaitingS
-00007130: 7461 7475 7328 2754 6869 7374 6c65 2729  tatus('Thistle')
-00007140: 223a 206f 7073 2e57 6169 7469 6e67 5374  ": ops.WaitingSt
-00007150: 6174 7573 2827 5468 6973 746c 6527 292c  atus('Thistle'),
-00007160: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
-00007170: 6b6e 6f77 6e53 7461 7475 7328 2927 3a20  knownStatus()': 
-00007180: 6f70 732e 556e 6b6e 6f77 6e53 7461 7475  ops.UnknownStatu
-00007190: 7328 292c 0a20 2020 2020 2020 207d 0a20  s(),.        }. 
-000071a0: 2020 2020 2020 2066 6f72 2065 7870 6563         for expec
-000071b0: 7465 642c 2073 7461 7475 7320 696e 2074  ted, status in t
-000071c0: 6573 745f 6361 7365 732e 6974 656d 7328  est_cases.items(
-000071d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000071e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000071f0: 7265 7072 2873 7461 7475 7329 2c20 6578  repr(status), ex
-00007200: 7065 6374 6564 290a 0a20 2020 2064 6566  pected)..    def
-00007210: 2074 6573 745f 7374 6174 7573 5f65 7128   test_status_eq(
-00007220: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00007230: 7461 7475 735f 7479 7065 7320 3d20 5b0a  tatus_types = [.
-00007240: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00007250: 4163 7469 7665 5374 6174 7573 2c0a 2020  ActiveStatus,.  
-00007260: 2020 2020 2020 2020 2020 6f70 732e 4d61            ops.Ma
-00007270: 696e 7465 6e61 6e63 6553 7461 7475 732c  intenanceStatus,
-00007280: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-00007290: 2e42 6c6f 636b 6564 5374 6174 7573 2c0a  .BlockedStatus,.
-000072a0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-000072b0: 5761 6974 696e 6753 7461 7475 732c 0a20  WaitingStatus,. 
-000072c0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
-000072d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000072e0: 616c 286f 7073 2e55 6e6b 6e6f 776e 5374  al(ops.UnknownSt
-000072f0: 6174 7573 2829 2c20 6f70 732e 556e 6b6e  atus(), ops.Unkn
-00007300: 6f77 6e53 7461 7475 7328 2929 0a20 2020  ownStatus()).   
-00007310: 2020 2020 2066 6f72 2028 692c 2074 3129       for (i, t1)
-00007320: 2069 6e20 656e 756d 6572 6174 6528 7374   in enumerate(st
-00007330: 6174 7573 5f74 7970 6573 293a 0a20 2020  atus_types):.   
-00007340: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00007350: 7365 7274 4e6f 7445 7175 616c 2874 3128  sertNotEqual(t1(
-00007360: 2727 292c 206f 7073 2e55 6e6b 6e6f 776e  ''), ops.Unknown
-00007370: 5374 6174 7573 2829 290a 2020 2020 2020  Status()).      
-00007380: 2020 2020 2020 666f 7220 286a 2c20 7432        for (j, t2
-00007390: 2920 696e 2065 6e75 6d65 7261 7465 2873  ) in enumerate(s
-000073a0: 7461 7475 735f 7479 7065 7329 3a0a 2020  tatus_types):.  
-000073b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000073c0: 6c66 2e61 7373 6572 744e 6f74 4571 7561  lf.assertNotEqua
-000073d0: 6c28 7431 2827 6f6e 6527 292c 2074 3228  l(t1('one'), t2(
-000073e0: 2774 776f 2729 290a 2020 2020 2020 2020  'two')).        
-000073f0: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
-00007400: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
-00007410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007420: 7274 4571 7561 6c28 7431 2827 6f6e 6527  rtEqual(t1('one'
-00007430: 292c 2074 3228 276f 6e65 2729 290a 2020  ), t2('one')).  
-00007440: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00007450: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007460: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007470: 6572 744e 6f74 4571 7561 6c28 7431 2827  ertNotEqual(t1('
-00007480: 6f6e 6527 292c 2074 3228 276f 6e65 2729  one'), t2('one')
-00007490: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000074a0: 6163 7469 7665 5f6d 6573 7361 6765 5f64  active_message_d
-000074b0: 6566 6175 6c74 2873 656c 6629 3a0a 2020  efault(self):.  
-000074c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000074d0: 7445 7175 616c 286f 7073 2e41 6374 6976  tEqual(ops.Activ
-000074e0: 6553 7461 7475 7328 292e 6d65 7373 6167  eStatus().messag
-000074f0: 652c 2027 2729 0a0a 2020 2020 6465 6620  e, '')..    def 
-00007500: 7465 7374 5f6c 6f63 616c 5f73 6574 5f76  test_local_set_v
-00007510: 616c 6964 5f75 6e69 745f 7374 6174 7573  alid_unit_status
-00007520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00007530: 7365 6c66 2e68 6172 6e65 7373 2e5f 6765  self.harness._ge
-00007540: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
-00007550: 7265 7365 743d 5472 7565 290a 2020 2020  reset=True).    
-00007560: 2020 2020 7465 7374 5f63 6173 6573 203d      test_cases =
-00007570: 205b 280a 2020 2020 2020 2020 2020 2020   [(.            
-00007580: 2761 6374 6976 6527 2c0a 2020 2020 2020  'active',.      
-00007590: 2020 2020 2020 6f70 732e 4163 7469 7665        ops.Active
-000075a0: 5374 6174 7573 2827 4772 6565 6e27 292c  Status('Green'),
-000075b0: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
-000075c0: 7461 7475 735f 7365 7427 2c20 2761 6374  tatus_set', 'act
-000075d0: 6976 6527 2c20 2747 7265 656e 272c 207b  ive', 'Green', {
-000075e0: 2769 735f 6170 7027 3a20 4661 6c73 657d  'is_app': False}
-000075f0: 292c 0a20 2020 2020 2020 2029 2c20 280a  ),.        ), (.
-00007600: 2020 2020 2020 2020 2020 2020 276d 6169              'mai
-00007610: 6e74 656e 616e 6365 272c 0a20 2020 2020  ntenance',.     
-00007620: 2020 2020 2020 206f 7073 2e4d 6169 6e74         ops.Maint
-00007630: 656e 616e 6365 5374 6174 7573 2827 5965  enanceStatus('Ye
-00007640: 6c6c 6f77 2729 2c0a 2020 2020 2020 2020  llow'),.        
-00007650: 2020 2020 2827 7374 6174 7573 5f73 6574      ('status_set
-00007660: 272c 2027 6d61 696e 7465 6e61 6e63 6527  ', 'maintenance'
-00007670: 2c20 2759 656c 6c6f 7727 2c20 7b27 6973  , 'Yellow', {'is
-00007680: 5f61 7070 273a 2046 616c 7365 7d29 2c0a  _app': False}),.
-00007690: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
-000076a0: 2020 2020 2020 2020 2027 626c 6f63 6b65           'blocke
-000076b0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-000076c0: 6f70 732e 426c 6f63 6b65 6453 7461 7475  ops.BlockedStatu
-000076d0: 7328 2752 6564 2729 2c0a 2020 2020 2020  s('Red'),.      
-000076e0: 2020 2020 2020 2827 7374 6174 7573 5f73        ('status_s
-000076f0: 6574 272c 2027 626c 6f63 6b65 6427 2c20  et', 'blocked', 
-00007700: 2752 6564 272c 207b 2769 735f 6170 7027  'Red', {'is_app'
-00007710: 3a20 4661 6c73 657d 292c 0a20 2020 2020  : False}),.     
-00007720: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
-00007730: 2020 2020 2777 6169 7469 6e67 272c 0a20      'waiting',. 
-00007740: 2020 2020 2020 2020 2020 206f 7073 2e57             ops.W
-00007750: 6169 7469 6e67 5374 6174 7573 2827 5768  aitingStatus('Wh
-00007760: 6974 6527 292c 0a20 2020 2020 2020 2020  ite'),.         
-00007770: 2020 2028 2773 7461 7475 735f 7365 7427     ('status_set'
-00007780: 2c20 2777 6169 7469 6e67 272c 2027 5768  , 'waiting', 'Wh
-00007790: 6974 6527 2c20 7b27 6973 5f61 7070 273a  ite', {'is_app':
-000077a0: 2046 616c 7365 7d29 2c0a 2020 2020 2020   False}),.      
-000077b0: 2020 295d 0a0a 2020 2020 2020 2020 666f    )]..        fo
-000077c0: 7220 7465 7374 5f63 6173 652c 2074 6172  r test_case, tar
-000077d0: 6765 745f 7374 6174 7573 2c20 6261 636b  get_status, back
-000077e0: 656e 645f 6361 6c6c 2069 6e20 7465 7374  end_call in test
-000077f0: 5f63 6173 6573 3a0a 2020 2020 2020 2020  _cases:.        
-00007800: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
-00007810: 6254 6573 7428 7465 7374 5f63 6173 6529  bTest(test_case)
-00007820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007830: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
-00007840: 742e 7374 6174 7573 203d 2074 6172 6765  t.status = targe
-00007850: 745f 7374 6174 7573 0a20 2020 2020 2020  t_status.       
-00007860: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00007870: 7365 7274 4571 7561 6c28 7365 6c66 2e6d  sertEqual(self.m
-00007880: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-00007890: 2c20 7461 7267 6574 5f73 7461 7475 7329  , target_status)
-000078a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000078b0: 2073 656c 662e 6d6f 6465 6c2e 756e 6974   self.model.unit
-000078c0: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
-000078d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000078e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000078f0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
-00007900: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
-00007910: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
-00007920: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007930: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
-00007940: 6261 636b 656e 645f 6361 6c6c 2c20 2827  backend_call, ('
-00007950: 7374 6174 7573 5f67 6574 272c 207b 2769  status_get', {'i
-00007960: 735f 6170 7027 3a20 4661 6c73 657d 295d  s_app': False})]
-00007970: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007980: 6c6f 6361 6c5f 7365 745f 7661 6c69 645f  local_set_valid_
-00007990: 6170 705f 7374 6174 7573 2873 656c 6629  app_status(self)
-000079a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-000079b0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-000079c0: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
-000079d0: 7465 7374 5f63 6173 6573 203d 205b 280a  test_cases = [(.
-000079e0: 2020 2020 2020 2020 2020 2020 2761 6374              'act
-000079f0: 6976 6527 2c0a 2020 2020 2020 2020 2020  ive',.          
-00007a00: 2020 6f70 732e 4163 7469 7665 5374 6174    ops.ActiveStat
-00007a10: 7573 2827 4772 6565 6e27 292c 0a20 2020  us('Green'),.   
-00007a20: 2020 2020 2020 2020 2028 2773 7461 7475           ('statu
-00007a30: 735f 7365 7427 2c20 2761 6374 6976 6527  s_set', 'active'
-00007a40: 2c20 2747 7265 656e 272c 207b 2769 735f  , 'Green', {'is_
-00007a50: 6170 7027 3a20 5472 7565 7d29 2c0a 2020  app': True}),.  
-00007a60: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
-00007a70: 2020 2020 2020 2027 6d61 696e 7465 6e61         'maintena
-00007a80: 6e63 6527 2c0a 2020 2020 2020 2020 2020  nce',.          
-00007a90: 2020 6f70 732e 4d61 696e 7465 6e61 6e63    ops.Maintenanc
-00007aa0: 6553 7461 7475 7328 2759 656c 6c6f 7727  eStatus('Yellow'
-00007ab0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00007ac0: 2773 7461 7475 735f 7365 7427 2c20 276d  'status_set', 'm
-00007ad0: 6169 6e74 656e 616e 6365 272c 2027 5965  aintenance', 'Ye
-00007ae0: 6c6c 6f77 272c 207b 2769 735f 6170 7027  llow', {'is_app'
-00007af0: 3a20 5472 7565 7d29 2c0a 2020 2020 2020  : True}),.      
-00007b00: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
-00007b10: 2020 2027 626c 6f63 6b65 6427 2c0a 2020     'blocked',.  
-00007b20: 2020 2020 2020 2020 2020 6f70 732e 426c            ops.Bl
-00007b30: 6f63 6b65 6453 7461 7475 7328 2752 6564  ockedStatus('Red
-00007b40: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00007b50: 2827 7374 6174 7573 5f73 6574 272c 2027  ('status_set', '
-00007b60: 626c 6f63 6b65 6427 2c20 2752 6564 272c  blocked', 'Red',
-00007b70: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
-00007b80: 7d29 2c0a 2020 2020 2020 2020 292c 2028  }),.        ), (
-00007b90: 0a20 2020 2020 2020 2020 2020 2027 7761  .            'wa
-00007ba0: 6974 696e 6727 2c0a 2020 2020 2020 2020  iting',.        
-00007bb0: 2020 2020 6f70 732e 5761 6974 696e 6753      ops.WaitingS
-00007bc0: 7461 7475 7328 2757 6869 7465 2729 2c0a  tatus('White'),.
-00007bd0: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
-00007be0: 6174 7573 5f73 6574 272c 2027 7761 6974  atus_set', 'wait
-00007bf0: 696e 6727 2c20 2757 6869 7465 272c 207b  ing', 'White', {
-00007c00: 2769 735f 6170 7027 3a20 5472 7565 7d29  'is_app': True})
-00007c10: 2c0a 2020 2020 2020 2020 295d 0a0a 2020  ,.        )]..  
-00007c20: 2020 2020 2020 666f 7220 7465 7374 5f63        for test_c
-00007c30: 6173 652c 2074 6172 6765 745f 7374 6174  ase, target_stat
-00007c40: 7573 2c20 6261 636b 656e 645f 6361 6c6c  us, backend_call
-00007c50: 2069 6e20 7465 7374 5f63 6173 6573 3a0a   in test_cases:.
-00007c60: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00007c70: 2073 656c 662e 7375 6254 6573 7428 7465   self.subTest(te
-00007c80: 7374 5f63 6173 6529 3a0a 2020 2020 2020  st_case):.      
-00007c90: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00007ca0: 6f64 656c 2e61 7070 2e73 7461 7475 7320  odel.app.status 
-00007cb0: 3d20 7461 7267 6574 5f73 7461 7475 730a  = target_status.
-00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00007ce0: 2873 656c 662e 6d6f 6465 6c2e 6170 702e  (self.model.app.
-00007cf0: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
-00007d00: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
-00007d10: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-00007d20: 6c2e 6170 702e 5f69 6e76 616c 6964 6174  l.app._invalidat
-00007d30: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00007d40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007d50: 7175 616c 2873 656c 662e 6d6f 6465 6c2e  qual(self.model.
-00007d60: 6170 702e 7374 6174 7573 2c20 7461 7267  app.status, targ
-00007d70: 6574 5f73 7461 7475 7329 0a20 2020 2020  et_status).     
-00007d80: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00007d90: 7265 2069 7320 6120 6261 636b 656e 6420  re is a backend 
-00007da0: 6361 6c6c 2074 6f20 6368 6563 6b20 6966  call to check if
-00007db0: 2077 6520 6361 6e20 7365 7420 7468 6520   we can set the 
-00007dc0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
-00007dd0: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
-00007de0: 6e20 616e 6f74 6865 7220 6368 6563 6b20  n another check 
-00007df0: 6561 6368 2074 696d 6520 7765 2061 7373  each time we ass
-00007e00: 6572 7420 7468 6520 7374 6174 7573 2061  ert the status a
-00007e10: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
-00007e20: 2020 2020 2065 7870 6563 7465 645f 6361       expected_ca
-00007e30: 6c6c 7320 3d20 5b0a 2020 2020 2020 2020  lls = [.        
-00007e40: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
-00007e50: 5f6c 6561 6465 7227 2c29 2c20 6261 636b  _leader',), back
-00007e60: 656e 645f 6361 6c6c 2c0a 2020 2020 2020  end_call,.      
-00007e70: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00007e80: 6973 5f6c 6561 6465 7227 2c29 2c0a 2020  is_leader',),.  
-00007e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ea0: 2020 2827 6973 5f6c 6561 6465 7227 2c29    ('is_leader',)
-00007eb0: 2c20 2827 7374 6174 7573 5f67 6574 272c  , ('status_get',
-00007ec0: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
-00007ed0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00007ee0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-00007ef0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007f00: 7442 6163 6b65 6e64 4361 6c6c 7328 6578  tBackendCalls(ex
-00007f10: 7065 6374 6564 5f63 616c 6c73 290a 0a20  pected_calls).. 
-00007f20: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
-00007f30: 6170 705f 7374 6174 7573 5f6e 6f6e 5f6c  app_status_non_l
-00007f40: 6561 6465 725f 7261 6973 6573 2873 656c  eader_raises(sel
-00007f50: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00007f60: 2e68 6172 6e65 7373 2e73 6574 5f6c 6561  .harness.set_lea
-00007f70: 6465 7228 4661 6c73 6529 0a20 2020 2020  der(False).     
-00007f80: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00007f90: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-00007fa0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00007fb0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
-00007fc0: 6170 702e 7374 6174 7573 0a0a 2020 2020  app.status..    
-00007fd0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00007fe0: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-00007ff0: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-00008000: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-00008010: 2e61 7070 2e73 7461 7475 7320 3d20 6f70  .app.status = op
-00008020: 732e 4163 7469 7665 5374 6174 7573 2829  s.ActiveStatus()
-00008030: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00008040: 6574 5f75 6e69 745f 7374 6174 7573 5f69  et_unit_status_i
-00008050: 6e76 616c 6964 2873 656c 6629 3a0a 2020  nvalid(self):.  
-00008060: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00008070: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00008080: 2e49 6e76 616c 6964 5374 6174 7573 4572  .InvalidStatusEr
-00008090: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000080a0: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
-000080b0: 742e 7374 6174 7573 203d 2027 626c 6f63  t.status = 'bloc
-000080c0: 6b65 6427 0a0a 2020 2020 6465 6620 7465  ked'..    def te
-000080d0: 7374 5f73 6574 5f61 7070 5f73 7461 7475  st_set_app_statu
-000080e0: 735f 696e 7661 6c69 6428 7365 6c66 293a  s_invalid(self):
-000080f0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00008100: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00008110: 6f70 732e 496e 7661 6c69 6453 7461 7475  ops.InvalidStatu
-00008120: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
-00008130: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
-00008140: 6170 702e 7374 6174 7573 203d 2027 626c  app.status = 'bl
-00008150: 6f63 6b65 6427 0a0a 2020 2020 6465 6620  ocked'..    def 
-00008160: 7465 7374 5f72 656d 6f74 655f 756e 6974  test_remote_unit
-00008170: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
-00008180: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-00008190: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
-000081a0: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-000081b0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
-000081c0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-000081d0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-000081e0: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
-000081f0: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
-00008200: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
-00008210: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00008220: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-00008230: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-00008240: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
-00008250: 2020 2020 7265 6d6f 7465 5f75 6e69 7420      remote_unit 
-00008260: 3d20 6e65 7874 2866 696c 7465 7228 6c61  = next(filter(la
-00008270: 6d62 6461 2075 3a20 752e 6e61 6d65 203d  mbda u: u.name =
-00008280: 3d20 2772 656d 6f74 6561 7070 312f 3027  = 'remoteapp1/0'
-00008290: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000082a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082b0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
-000082c0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
-000082d0: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
-000082e0: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
-000082f0: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
-00008300: 2020 2020 2023 2052 656d 6f74 6520 756e       # Remote un
-00008310: 6974 2073 7461 7475 7320 6973 2061 6c77  it status is alw
-00008320: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
-00008330: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008340: 4571 7561 6c28 7265 6d6f 7465 5f75 6e69  Equal(remote_uni
-00008350: 742e 7374 6174 7573 2c20 6f70 732e 556e  t.status, ops.Un
-00008360: 6b6e 6f77 6e53 7461 7475 7328 2929 0a0a  knownStatus())..
-00008370: 2020 2020 2020 2020 7465 7374 5f73 7461          test_sta
-00008380: 7475 7365 7320 3d20 280a 2020 2020 2020  tuses = (.      
-00008390: 2020 2020 2020 6f70 732e 556e 6b6e 6f77        ops.Unknow
-000083a0: 6e53 7461 7475 7328 292c 0a20 2020 2020  nStatus(),.     
-000083b0: 2020 2020 2020 206f 7073 2e41 6374 6976         ops.Activ
-000083c0: 6553 7461 7475 7328 2747 7265 656e 2729  eStatus('Green')
-000083d0: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
-000083e0: 732e 4d61 696e 7465 6e61 6e63 6553 7461  s.MaintenanceSta
-000083f0: 7475 7328 2759 656c 6c6f 7727 292c 0a20  tus('Yellow'),. 
-00008400: 2020 2020 2020 2020 2020 206f 7073 2e42             ops.B
-00008410: 6c6f 636b 6564 5374 6174 7573 2827 5265  lockedStatus('Re
-00008420: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
-00008430: 206f 7073 2e57 6169 7469 6e67 5374 6174   ops.WaitingStat
-00008440: 7573 2827 5768 6974 6527 292c 0a20 2020  us('White'),.   
-00008450: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00008460: 666f 7220 7461 7267 6574 5f73 7461 7475  for target_statu
-00008470: 7320 696e 2074 6573 745f 7374 6174 7573  s in test_status
-00008480: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00008490: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
-000084a0: 7428 7461 7267 6574 5f73 7461 7475 732e  t(target_status.
-000084b0: 6e61 6d65 293a 0a20 2020 2020 2020 2020  name):.         
-000084c0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000084d0: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
-000084e0: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
-000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008500: 2072 656d 6f74 655f 756e 6974 2e73 7461   remote_unit.sta
-00008510: 7475 7320 3d20 7461 7267 6574 5f73 7461  tus = target_sta
-00008520: 7475 730a 2020 2020 2020 2020 7365 6c66  tus.        self
-00008530: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-00008540: 6c6c 7328 5b5d 290a 0a20 2020 2064 6566  lls([])..    def
-00008550: 2074 6573 745f 7265 6d6f 7465 5f61 7070   test_remote_app
-00008560: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
-00008570: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-00008580: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
-00008590: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-000085a0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
-000085b0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-000085c0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-000085d0: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
-000085e0: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
-000085f0: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
-00008600: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00008610: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-00008620: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-00008630: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
-00008640: 2020 2020 7265 6d6f 7465 6170 7031 203d      remoteapp1 =
-00008650: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00008660: 7265 6c61 7469 6f6e 2827 6462 3127 292e  relation('db1').
-00008670: 6170 700a 2020 2020 2020 2020 7365 6c66  app.        self
-00008680: 2e72 6573 6574 4261 636b 656e 6443 616c  .resetBackendCal
-00008690: 6c73 2829 0a0a 2020 2020 2020 2020 2320  ls()..        # 
-000086a0: 5265 6d6f 7465 2061 7070 6c69 6361 7469  Remote applicati
-000086b0: 6f6e 2073 7461 7475 7320 6973 2061 6c77  on status is alw
-000086c0: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
-000086d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000086e0: 4973 496e 7374 616e 6365 2872 656d 6f74  IsInstance(remot
-000086f0: 6561 7070 312e 7374 6174 7573 2c20 6f70  eapp1.status, op
-00008700: 732e 556e 6b6e 6f77 6e53 7461 7475 7329  s.UnknownStatus)
-00008710: 0a0a 2020 2020 2020 2020 7465 7374 5f73  ..        test_s
-00008720: 7461 7475 7365 7320 3d20 280a 2020 2020  tatuses = (.    
-00008730: 2020 2020 2020 2020 6f70 732e 556e 6b6e          ops.Unkn
-00008740: 6f77 6e53 7461 7475 7328 292c 0a20 2020  ownStatus(),.   
-00008750: 2020 2020 2020 2020 206f 7073 2e41 6374           ops.Act
-00008760: 6976 6553 7461 7475 7328 292c 0a20 2020  iveStatus(),.   
-00008770: 2020 2020 2020 2020 206f 7073 2e4d 6169           ops.Mai
-00008780: 6e74 656e 616e 6365 5374 6174 7573 2827  ntenanceStatus('
-00008790: 5570 6772 6164 696e 6720 736f 6674 7761  Upgrading softwa
-000087a0: 7265 2729 2c0a 2020 2020 2020 2020 2020  re'),.          
-000087b0: 2020 6f70 732e 426c 6f63 6b65 6453 7461    ops.BlockedSta
-000087c0: 7475 7328 2741 7761 6974 696e 6720 6d61  tus('Awaiting ma
-000087d0: 6e75 616c 2072 6573 6f6c 7574 696f 6e27  nual resolution'
-000087e0: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-000087f0: 7073 2e57 6169 7469 6e67 5374 6174 7573  ps.WaitingStatus
-00008800: 2827 4177 6169 7469 6e67 2072 656c 6174  ('Awaiting relat
-00008810: 6564 2061 7070 2075 7064 6174 6573 2729  ed app updates')
-00008820: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00008830: 2020 2020 666f 7220 7461 7267 6574 5f73      for target_s
-00008840: 7461 7475 7320 696e 2074 6573 745f 7374  tatus in test_st
-00008850: 6174 7573 6573 3a0a 2020 2020 2020 2020  atuses:.        
-00008860: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
-00008870: 6254 6573 7428 7461 7267 6574 5f73 7461  bTest(target_sta
-00008880: 7475 732e 6e61 6d65 293a 0a20 2020 2020  tus.name):.     
-00008890: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000088a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000088b0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-000088c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000088d0: 2020 2020 2072 656d 6f74 6561 7070 312e       remoteapp1.
-000088e0: 7374 6174 7573 203d 2074 6172 6765 745f  status = target_
-000088f0: 7374 6174 7573 0a20 2020 2020 2020 2073  status.        s
-00008900: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
-00008910: 6443 616c 6c73 285b 5d29 0a0a 2020 2020  dCalls([])..    
-00008920: 6465 6620 7465 7374 5f73 746f 7261 6765  def test_storage
-00008930: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00008940: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
-00008950: 4d65 7461 2829 0a20 2020 2020 2020 206d  Meta().        m
-00008960: 6574 612e 7374 6f72 6167 6573 203d 207b  eta.storages = {
-00008970: 2764 6973 6b73 273a 204e 6f6e 652c 2027  'disks': None, '
-00008980: 6461 7461 273a 204e 6f6e 657d 0a20 2020  data': None}.   
-00008990: 2020 2020 206d 6f64 656c 203d 206f 7073       model = ops
-000089a0: 2e4d 6f64 656c 286d 6574 612c 205f 4d6f  .Model(meta, _Mo
-000089b0: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
-000089c0: 702f 3027 2929 0a0a 2020 2020 2020 2020  p/0'))..        
-000089d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000089e0: 2c20 2773 746f 7261 6765 2d6c 6973 7427  , 'storage-list'
-000089f0: 2c20 2727 270a 2020 2020 2020 2020 2020  , '''.          
-00008a00: 2020 6966 205b 2022 2431 2220 3d20 6469    if [ "$1" = di
-00008a10: 736b 7320 5d3b 2074 6865 6e0a 2020 2020  sks ]; then.    
-00008a20: 2020 2020 2020 2020 2020 2020 6563 686f              echo
-00008a30: 2027 5b22 6469 736b 732f 3022 2c20 2264   '["disks/0", "d
-00008a40: 6973 6b73 2f31 225d 270a 2020 2020 2020  isks/1"]'.      
-00008a50: 2020 2020 2020 656c 7365 0a20 2020 2020        else.     
-00008a60: 2020 2020 2020 2020 2020 2065 6368 6f20             echo 
-00008a70: 275b 5d27 0a20 2020 2020 2020 2020 2020  '[]'.           
-00008a80: 2066 690a 2020 2020 2020 2020 2727 2729   fi.        ''')
-00008a90: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00008aa0: 7269 7074 2873 656c 662c 2027 7374 6f72  ript(self, 'stor
-00008ab0: 6167 652d 6765 7427 2c20 2727 270a 2020  age-get', '''.  
-00008ac0: 2020 2020 2020 2020 2020 6966 205b 2022            if [ "
-00008ad0: 2432 2220 3d20 6469 736b 732f 3020 5d3b  $2" = disks/0 ];
-00008ae0: 2074 6865 6e0a 2020 2020 2020 2020 2020   then.          
-00008af0: 2020 2020 2020 6563 686f 2027 222f 7661        echo '"/va
-00008b00: 722f 7372 762f 6469 736b 732f 3022 270a  r/srv/disks/0"'.
-00008b10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00008b20: 205b 2022 2432 2220 3d20 6469 736b 732f   [ "$2" = disks/
-00008b30: 3120 5d3b 2074 6865 6e0a 2020 2020 2020  1 ]; then.      
-00008b40: 2020 2020 2020 2020 2020 6563 686f 2027            echo '
-00008b50: 222f 7661 722f 7372 762f 6469 736b 732f  "/var/srv/disks/
-00008b60: 3122 270a 2020 2020 2020 2020 2020 2020  1"'.            
-00008b70: 656c 7365 0a20 2020 2020 2020 2020 2020  else.           
-00008b80: 2020 2020 2065 7869 7420 320a 2020 2020       exit 2.    
-00008b90: 2020 2020 2020 2020 6669 0a20 2020 2020          fi.     
-00008ba0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00008bb0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00008bc0: 2c20 2773 746f 7261 6765 2d61 6464 272c  , 'storage-add',
-00008bd0: 2027 2729 0a0a 2020 2020 2020 2020 7365   '')..        se
-00008be0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-00008bf0: 656e 286d 6f64 656c 2e73 746f 7261 6765  en(model.storage
-00008c00: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
-00008c10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008c20: 6d6f 6465 6c2e 7374 6f72 6167 6573 2e6b  model.storages.k
-00008c30: 6579 7328 292c 206d 6574 612e 7374 6f72  eys(), meta.stor
-00008c40: 6167 6573 2e6b 6579 7328 2929 0a20 2020  ages.keys()).   
-00008c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008c60: 496e 2827 6469 736b 7327 2c20 6d6f 6465  In('disks', mode
-00008c70: 6c2e 7374 6f72 6167 6573 290a 0a20 2020  l.storages)..   
-00008c80: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
-00008c90: 2e72 6169 7365 7328 4b65 7945 7272 6f72  .raises(KeyError
-00008ca0: 2c20 6d61 7463 683d 2744 6964 2079 6f75  , match='Did you
-00008cb0: 206d 6561 6e27 293a 0a20 2020 2020 2020   mean'):.       
-00008cc0: 2020 2020 206d 6f64 656c 2e73 746f 7261       model.stora
-00008cd0: 6765 735b 2764 6f65 732d 6e6f 742d 6578  ges['does-not-ex
-00008ce0: 6973 7427 5d0a 0a20 2020 2020 2020 2074  ist']..        t
-00008cf0: 6573 745f 6361 7365 7320 3d20 7b0a 2020  est_cases = {.  
-00008d00: 2020 2020 2020 2020 2020 303a 207b 276e            0: {'n
-00008d10: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
-00008d20: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
-00008d30: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
-00008d40: 762f 6469 736b 732f 3027 297d 2c0a 2020  v/disks/0')},.  
-00008d50: 2020 2020 2020 2020 2020 313a 207b 276e            1: {'n
-00008d60: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
-00008d70: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
-00008d80: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
-00008d90: 762f 6469 736b 732f 3127 297d 2c0a 2020  v/disks/1')},.  
-00008da0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00008db0: 666f 7220 7374 6f72 6167 6520 696e 206d  for storage in m
-00008dc0: 6f64 656c 2e73 746f 7261 6765 735b 2764  odel.storages['d
-00008dd0: 6973 6b73 275d 3a0a 2020 2020 2020 2020  isks']:.        
-00008de0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00008df0: 7175 616c 2873 746f 7261 6765 2e6e 616d  qual(storage.nam
-00008e00: 652c 2027 6469 736b 7327 290a 2020 2020  e, 'disks').    
-00008e10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008e20: 6572 7449 6e28 7374 6f72 6167 652e 6964  ertIn(storage.id
-00008e30: 2c20 7465 7374 5f63 6173 6573 290a 2020  , test_cases).  
-00008e40: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00008e50: 7373 6572 7445 7175 616c 2873 746f 7261  ssertEqual(stora
-00008e60: 6765 2e6e 616d 652c 2074 6573 745f 6361  ge.name, test_ca
-00008e70: 7365 735b 7374 6f72 6167 652e 6964 5d5b  ses[storage.id][
-00008e80: 276e 616d 6527 5d29 0a20 2020 2020 2020  'name']).       
-00008e90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008ea0: 4571 7561 6c28 7374 6f72 6167 652e 6c6f  Equal(storage.lo
-00008eb0: 6361 7469 6f6e 2c20 7465 7374 5f63 6173  cation, test_cas
-00008ec0: 6573 5b73 746f 7261 6765 2e69 645d 5b27  es[storage.id]['
-00008ed0: 6c6f 6361 7469 6f6e 275d 290a 0a20 2020  location'])..   
-00008ee0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008ef0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-00008f00: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-00008f10: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
-00008f20: 2020 2020 2020 2020 205b 2773 746f 7261           ['stora
-00008f30: 6765 2d6c 6973 7427 2c20 2764 6973 6b73  ge-list', 'disks
-00008f40: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-00008f50: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
-00008f60: 205b 2773 746f 7261 6765 2d67 6574 272c   ['storage-get',
-00008f70: 2027 2d73 272c 2027 6469 736b 732f 3027   '-s', 'disks/0'
-00008f80: 2c20 276c 6f63 6174 696f 6e27 2c20 272d  , 'location', '-
-00008f90: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-00008fa0: 2020 2020 2020 2020 2020 2020 5b27 7374              ['st
-00008fb0: 6f72 6167 652d 6765 7427 2c20 272d 7327  orage-get', '-s'
-00008fc0: 2c20 2764 6973 6b73 2f31 272c 2027 6c6f  , 'disks/1', 'lo
-00008fd0: 6361 7469 6f6e 272c 2027 2d2d 666f 726d  cation', '--form
-00008fe0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-00008ff0: 2020 205d 290a 0a20 2020 2020 2020 2073     ])..        s
-00009000: 656c 662e 6173 7365 7274 5365 7175 656e  elf.assertSequen
-00009010: 6365 4571 7561 6c28 6d6f 6465 6c2e 7374  ceEqual(model.st
-00009020: 6f72 6167 6573 5b27 6461 7461 275d 2c20  orages['data'], 
-00009030: 5b5d 290a 2020 2020 2020 2020 6d6f 6465  []).        mode
-00009040: 6c2e 7374 6f72 6167 6573 2e72 6571 7565  l.storages.reque
-00009050: 7374 2827 6461 7461 272c 2063 6f75 6e74  st('data', count
-00009060: 3d33 290a 2020 2020 2020 2020 7365 6c66  =3).        self
-00009070: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-00009080: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-00009090: 656c 6629 2c20 5b0a 2020 2020 2020 2020  elf), [.        
-000090a0: 2020 2020 5b27 7374 6f72 6167 652d 6c69      ['storage-li
-000090b0: 7374 272c 2027 6461 7461 272c 2027 2d2d  st', 'data', '--
-000090c0: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
-000090d0: 2020 2020 2020 2020 2020 205b 2773 746f             ['sto
-000090e0: 7261 6765 2d61 6464 272c 2027 6461 7461  rage-add', 'data
-000090f0: 3d33 275d 2c0a 2020 2020 2020 2020 5d29  =3'],.        ])
-00009100: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
-00009110: 746f 2061 6464 2073 746f 7261 6765 206e  to add storage n
-00009120: 6f74 2070 7265 7365 6e74 2069 6e20 6368  ot present in ch
-00009130: 6172 6d20 6d65 7461 6461 7461 2e0a 2020  arm metadata..  
-00009140: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00009150: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00009160: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-00009170: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
-00009180: 7374 6f72 6167 6573 2e72 6571 7565 7374  storages.request
-00009190: 2827 6465 6164 6265 6566 2729 0a0a 2020  ('deadbeef')..  
-000091a0: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
-000091b0: 636f 756e 7420 7061 7261 6d65 7465 7220  count parameter 
-000091c0: 7479 7065 732e 0a20 2020 2020 2020 2066  types..        f
-000091d0: 6f72 2063 6f75 6e74 5f76 2069 6e20 5b4e  or count_v in [N
-000091e0: 6f6e 652c 2046 616c 7365 2c20 322e 302c  one, False, 2.0,
-000091f0: 2027 6127 2c20 6227 6265 6566 272c 206f   'a', b'beef', o
-00009200: 626a 6563 745d 3a0a 2020 2020 2020 2020  bject]:.        
-00009210: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00009220: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-00009230: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00009240: 2020 2020 2020 206d 6f64 656c 2e73 746f         model.sto
-00009250: 7261 6765 732e 7265 7175 6573 7428 2764  rages.request('d
-00009260: 6174 6127 2c20 636f 756e 745f 7629 0a0a  ata', count_v)..
-00009270: 2020 2020 6465 6620 7465 7374 5f73 746f      def test_sto
-00009280: 7261 6765 735f 696d 6d75 7461 626c 6528  rages_immutable(
-00009290: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-000092a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000092b0: 6169 7365 7328 4174 7472 6962 7574 6545  aises(AttributeE
-000092c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000092d0: 2020 2073 656c 662e 6d6f 6465 6c2e 7374     self.model.st
-000092e0: 6f72 6167 6573 203d 207b 7d0a 0a20 2020  orages = {}..   
-000092f0: 2064 6566 2072 6573 6574 4261 636b 656e   def resetBacken
-00009300: 6443 616c 6c73 2873 656c 6629 3a20 2023  dCalls(self):  #
-00009310: 206e 6f71 613a 204e 3830 320a 2020 2020   noqa: N802.    
-00009320: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00009330: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
-00009340: 6c6c 7328 7265 7365 743d 5472 7565 290a  lls(reset=True).
-00009350: 0a20 2020 2064 6566 2061 7373 6572 7442  .    def assertB
-00009360: 6163 6b65 6e64 4361 6c6c 7328 7365 6c66  ackendCalls(self
-00009370: 2c20 6578 7065 6374 6564 2c20 2a2c 2072  , expected, *, r
-00009380: 6573 6574 3d54 7275 6529 3a20 2023 206e  eset=True):  # n
-00009390: 6f71 613a 204e 3830 320a 2020 2020 2020  oqa: N802.      
-000093a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000093b0: 616c 2865 7870 6563 7465 642c 2073 656c  al(expected, sel
-000093c0: 662e 6861 726e 6573 732e 5f67 6574 5f62  f.harness._get_b
-000093d0: 6163 6b65 6e64 5f63 616c 6c73 2872 6573  ackend_calls(res
-000093e0: 6574 3d72 6573 6574 2929 0a0a 2020 2020  et=reset))..    
-000093f0: 6465 6620 7465 7374 5f72 756e 5f65 7272  def test_run_err
-00009400: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-00009410: 2020 6d6f 6465 6c20 3d20 6f70 732e 4d6f    model = ops.Mo
-00009420: 6465 6c28 6f70 732e 4368 6172 6d4d 6574  del(ops.CharmMet
-00009430: 6128 292c 205f 4d6f 6465 6c42 6163 6b65  a(), _ModelBacke
-00009440: 6e64 2827 6d79 6170 702f 3027 2929 0a20  nd('myapp/0')). 
-00009450: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00009460: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
-00009470: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
-00009480: 4552 524f 5220 6361 6e6e 6f74 2067 6574  ERROR cannot get
-00009490: 2073 7461 7475 7327 203e 2632 3b20 6578   status' >&2; ex
-000094a0: 6974 2031 2222 2229 0a20 2020 2020 2020  it 1""").       
-000094b0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-000094c0: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
-000094d0: 6c45 7272 6f72 2920 6173 2063 6d3a 0a20  lError) as cm:. 
-000094e0: 2020 2020 2020 2020 2020 205f 203d 206d             _ = m
-000094f0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-00009500: 2e6d 6573 7361 6765 0a20 2020 2020 2020  .message.       
-00009510: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00009520: 6c28 7374 7228 636d 2e65 7863 6570 7469  l(str(cm.excepti
-00009530: 6f6e 292c 2027 4552 524f 5220 6361 6e6e  on), 'ERROR cann
-00009540: 6f74 2067 6574 2073 7461 7475 735c 6e27  ot get status\n'
-00009550: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009560: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
-00009570: 6365 7074 696f 6e2e 6172 6773 5b30 5d2c  ception.args[0],
-00009580: 2027 4552 524f 5220 6361 6e6e 6f74 2067   'ERROR cannot g
-00009590: 6574 2073 7461 7475 735c 6e27 290a 0a0a  et status\n')...
-000095a0: 636c 6173 7320 5075 7368 5075 6c6c 4361  class PushPullCa
-000095b0: 7365 3a0a 2020 2020 2222 2254 6573 7420  se:.    """Test 
-000095c0: 6361 7365 2066 6f72 2074 6162 6c65 2d64  case for table-d
-000095d0: 7269 7665 6e20 7465 7374 732e 2222 220a  riven tests.""".
-000095e0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-000095f0: 5f28 7365 6c66 2c20 2a2a 7661 6c73 293a  _(self, **vals):
-00009600: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
-00009610: 7474 6572 6e20 3d20 4e6f 6e65 0a20 2020  ttern = None.   
-00009620: 2020 2020 2073 656c 662e 6473 7420 3d20       self.dst = 
-00009630: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-00009640: 662e 6572 726f 7273 203d 205b 5d0a 2020  f.errors = [].  
-00009650: 2020 2020 2020 7365 6c66 2e77 616e 7420        self.want 
-00009660: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00009670: 666f 7220 6b65 792c 2076 616c 2069 6e20  for key, val in 
-00009680: 7661 6c73 2e69 7465 6d73 2829 3a0a 2020  vals.items():.  
-00009690: 2020 2020 2020 2020 2020 7365 7461 7474            setatt
-000096a0: 7228 7365 6c66 2c20 6b65 792c 2076 616c  r(self, key, val
-000096b0: 290a 0a0a 7265 6375 7273 6976 655f 6c69  )...recursive_li
-000096c0: 7374 5f63 6173 6573 203d 205b 0a20 2020  st_cases = [.   
-000096d0: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
-000096e0: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
-000096f0: 6963 2072 6563 7572 7369 7665 206c 6973  ic recursive lis
-00009700: 7427 2c0a 2020 2020 2020 2020 7061 7468  t',.        path
-00009710: 3d27 2f27 2c0a 2020 2020 2020 2020 6669  ='/',.        fi
-00009720: 6c65 733d 5b27 2f66 6f6f 2f62 6172 2e74  les=['/foo/bar.t
-00009730: 7874 272c 2027 2f62 617a 2e74 7874 275d  xt', '/baz.txt']
-00009740: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
-00009750: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
-00009760: 272f 6261 7a2e 7478 7427 7d2c 0a20 2020  '/baz.txt'},.   
-00009770: 2029 2c0a 2020 2020 5075 7368 5075 6c6c   ),.    PushPull
-00009780: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
-00009790: 6d65 3d27 6261 7369 6320 7265 6375 7273  me='basic recurs
-000097a0: 6976 6520 6c69 7374 2072 6576 6572 7365  ive list reverse
-000097b0: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
-000097c0: 272f 272c 0a20 2020 2020 2020 2066 696c  '/',.        fil
-000097d0: 6573 3d5b 272f 6261 7a2e 7478 7427 2c20  es=['/baz.txt', 
-000097e0: 272f 666f 6f2f 6261 722e 7478 7427 5d2c  '/foo/bar.txt'],
-000097f0: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
-00009800: 2f66 6f6f 2f62 6172 2e74 7874 272c 2027  /foo/bar.txt', '
-00009810: 2f62 617a 2e74 7874 277d 2c0a 2020 2020  /baz.txt'},.    
-00009820: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
-00009830: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
-00009840: 653d 2764 6972 6563 746c 7920 6c69 7374  e='directly list
-00009850: 2061 2028 6e6f 6e2d 6469 7265 6374 6f72   a (non-director
-00009860: 7929 2066 696c 6527 2c0a 2020 2020 2020  y) file',.      
-00009870: 2020 7061 7468 3d27 2f62 617a 2e74 7874    path='/baz.txt
-00009880: 272c 0a20 2020 2020 2020 2066 696c 6573  ',.        files
-00009890: 3d5b 272f 6261 7a2e 7478 7427 5d2c 0a20  =['/baz.txt'],. 
-000098a0: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
-000098b0: 617a 2e74 7874 277d 2c0a 2020 2020 292c  az.txt'},.    ),
-000098c0: 0a5d 0a0a 0a40 7079 7465 7374 2e6d 6172  .]...@pytest.mar
-000098d0: 6b2e 7061 7261 6d65 7472 697a 6528 2763  k.parametrize('c
-000098e0: 6173 6527 2c20 7265 6375 7273 6976 655f  ase', recursive_
-000098f0: 6c69 7374 5f63 6173 6573 290a 6465 6620  list_cases).def 
-00009900: 7465 7374 5f72 6563 7572 7369 7665 5f6c  test_recursive_l
-00009910: 6973 7428 6361 7365 293a 0a20 2020 2064  ist(case):.    d
-00009920: 6566 206c 6973 745f 6675 6e63 5f67 656e  ef list_func_gen
-00009930: 2866 696c 655f 6c69 7374 293a 0a20 2020  (file_list):.   
-00009940: 2020 2020 2061 7267 7320 3d20 7b0a 2020       args = {.  
-00009950: 2020 2020 2020 2020 2020 276c 6173 745f            'last_
-00009960: 6d6f 6469 6669 6564 273a 2064 6174 6574  modified': datet
-00009970: 696d 652e 7469 6d65 2829 2c0a 2020 2020  ime.time(),.    
-00009980: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
-00009990: 696f 6e73 273a 2030 6f37 3737 2c0a 2020  ions': 0o777,.  
-000099a0: 2020 2020 2020 2020 2020 2773 697a 6527            'size'
-000099b0: 3a20 3432 2c0a 2020 2020 2020 2020 2020  : 42,.          
-000099c0: 2020 2775 7365 725f 6964 273a 2030 2c0a    'user_id': 0,.
-000099d0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
-000099e0: 7227 3a20 2766 6f6f 272c 0a20 2020 2020  r': 'foo',.     
-000099f0: 2020 2020 2020 2027 6772 6f75 705f 6964         'group_id
-00009a00: 273a 2031 3032 342c 0a20 2020 2020 2020  ': 1024,.       
-00009a10: 2020 2020 2027 6772 6f75 7027 3a20 2762       'group': 'b
-00009a20: 6172 272c 0a20 2020 2020 2020 207d 0a20  ar',.        }. 
-00009a30: 2020 2020 2020 2066 696c 655f 696e 666f         file_info
-00009a40: 732c 2064 6972 7320 3d20 5b5d 2c20 7365  s, dirs = [], se
-00009a50: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-00009a60: 6620 696e 2066 696c 655f 6c69 7374 3a0a  f in file_list:.
-00009a70: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00009a80: 5f69 6e66 6f73 2e61 7070 656e 6428 0a20  _infos.append(. 
-00009a90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00009aa0: 6562 626c 652e 4669 6c65 496e 666f 280a  ebble.FileInfo(.
-00009ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ac0: 2020 2020 7061 7468 3d66 2c0a 2020 2020      path=f,.    
+00000340: 740a 6672 6f6d 2075 6e69 7474 6573 742e  t.from unittest.
+00000350: 6d6f 636b 2069 6d70 6f72 7420 7061 7463  mock import patc
+00000360: 680a 0a69 6d70 6f72 7420 7079 7465 7374  h..import pytest
+00000370: 0a0a 696d 706f 7274 206f 7073 0a69 6d70  ..import ops.imp
+00000380: 6f72 7420 6f70 732e 7465 7374 696e 670a  ort ops.testing.
+00000390: 6672 6f6d 206f 7073 2069 6d70 6f72 7420  from ops import 
+000003a0: 7065 6262 6c65 0a66 726f 6d20 6f70 732e  pebble.from ops.
+000003b0: 5f70 7269 7661 7465 2069 6d70 6f72 7420  _private import 
+000003c0: 7961 6d6c 0a66 726f 6d20 6f70 732e 6d6f  yaml.from ops.mo
+000003d0: 6465 6c20 696d 706f 7274 205f 4d6f 6465  del import _Mode
+000003e0: 6c42 6163 6b65 6e64 0a0a 0a63 6c61 7373  lBackend...class
+000003f0: 2054 6573 744d 6f64 656c 2875 6e69 7474   TestModel(unitt
+00000400: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+00000410: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
+00000420: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00000430: 2e68 6172 6e65 7373 203d 206f 7073 2e74  .harness = ops.t
+00000440: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+00000450: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+00000460: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00000470: 2020 206e 616d 653a 206d 7961 7070 0a20     name: myapp. 
+00000480: 2020 2020 2020 2020 2020 2070 726f 7669             provi
+00000490: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
+000004a0: 2020 2064 6230 3a0a 2020 2020 2020 2020     db0:.        
+000004b0: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+000004c0: 653a 2064 6230 0a20 2020 2020 2020 2020  e: db0.         
+000004d0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
+000004e0: 2020 2020 2020 2020 2020 2064 6231 3a0a             db1:.
+000004f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000500: 696e 7465 7266 6163 653a 2064 6231 0a20  interface: db1. 
+00000510: 2020 2020 2020 2020 2020 2070 6565 7273             peers
+00000520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00000530: 6462 323a 0a20 2020 2020 2020 2020 2020  db2:.           
+00000540: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00000550: 6462 320a 2020 2020 2020 2020 2020 2020  db2.            
+00000560: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+00000570: 2020 2020 2020 2020 2066 6f6f 3a20 7b74           foo: {t
+00000580: 7970 653a 2066 696c 652c 2066 696c 656e  ype: file, filen
+00000590: 616d 653a 2066 6f6f 2e74 7874 7d0a 2020  ame: foo.txt}.  
+000005a0: 2020 2020 2020 2020 2020 2020 6261 723a              bar:
+000005b0: 207b 7479 7065 3a20 6669 6c65 2c20 6669   {type: file, fi
+000005c0: 6c65 6e61 6d65 3a20 6261 722e 7478 747d  lename: bar.txt}
+000005d0: 0a20 2020 2020 2020 2027 2727 2c20 636f  .        ''', co
+000005e0: 6e66 6967 3d27 2727 0a20 2020 2020 2020  nfig='''.       
+000005f0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
+00000600: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
+00000610: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+00000620: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+00000630: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
+00000640: 2020 2020 2020 2020 2074 7970 653a 2069           type: i
+00000650: 6e74 0a20 2020 2020 2020 2020 2020 2071  nt.            q
+00000660: 7578 3a0a 2020 2020 2020 2020 2020 2020  ux:.            
+00000670: 2020 2020 7479 7065 3a20 626f 6f6c 6561      type: boolea
+00000680: 6e0a 2020 2020 2020 2020 2727 2729 0a20  n.        '''). 
+00000690: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+000006a0: 6c65 616e 7570 2873 656c 662e 6861 726e  leanup(self.harn
+000006b0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+000006c0: 2020 2020 2073 656c 662e 7265 6c61 7469       self.relati
+000006d0: 6f6e 5f69 645f 6462 3020 3d20 7365 6c66  on_id_db0 = self
+000006e0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+000006f0: 6174 696f 6e28 2764 6230 272c 2027 6462  ation('db0', 'db
+00000700: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00000710: 6861 726e 6573 732e 5f67 6574 5f62 6163  harness._get_bac
+00000720: 6b65 6e64 5f63 616c 6c73 2872 6573 6574  kend_calls(reset
+00000730: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
+00000740: 656c 662e 6d6f 6465 6c20 3d20 7365 6c66  elf.model = self
+00000750: 2e68 6172 6e65 7373 2e6d 6f64 656c 0a0a  .harness.model..
+00000760: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
+00000770: 656c 5f61 7474 7269 6275 7465 7328 7365  el_attributes(se
+00000780: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00000790: 662e 6173 7365 7274 4973 2873 656c 662e  f.assertIs(self.
+000007a0: 6d6f 6465 6c2e 6170 702c 2073 656c 662e  model.app, self.
+000007b0: 6d6f 6465 6c2e 756e 6974 2e61 7070 290a  model.unit.app).
+000007c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000007d0: 6572 7449 734e 6f6e 6528 7365 6c66 2e6d  ertIsNone(self.m
+000007e0: 6f64 656c 2e6e 616d 6529 0a0a 2020 2020  odel.name)..    
+000007f0: 6465 6620 7465 7374 5f75 6e69 745f 696d  def test_unit_im
+00000800: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+00000810: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000820: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00000830: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00000840: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000850: 6d6f 6465 6c2e 756e 6974 203d 206f 626a  model.unit = obj
+00000860: 6563 7428 290a 0a20 2020 2064 6566 2074  ect()..    def t
+00000870: 6573 745f 6170 705f 696d 6d75 7461 626c  est_app_immutabl
+00000880: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00000890: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000008a0: 7452 6169 7365 7328 4174 7472 6962 7574  tRaises(Attribut
+000008b0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+000008c0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+000008d0: 6170 7020 3d20 6f62 6a65 6374 2829 0a0a  app = object()..
+000008e0: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
+000008f0: 656c 5f6e 616d 655f 6672 6f6d 5f62 6163  el_name_from_bac
+00000900: 6b65 6e64 2873 656c 6629 3a0a 2020 2020  kend(self):.    
+00000910: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00000920: 2e73 6574 5f6d 6f64 656c 5f6e 616d 6528  .set_model_name(
+00000930: 2764 6566 6175 6c74 2729 0a20 2020 2020  'default').     
+00000940: 2020 206d 203d 206f 7073 2e4d 6f64 656c     m = ops.Model
+00000950: 286f 7073 2e43 6861 726d 4d65 7461 2829  (ops.CharmMeta()
+00000960: 2c20 7365 6c66 2e68 6172 6e65 7373 2e5f  , self.harness._
+00000970: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
+00000980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00000990: 6c28 6d2e 6e61 6d65 2c20 2764 6566 6175  l(m.name, 'defau
+000009a0: 6c74 2729 0a20 2020 2020 2020 2077 6974  lt').        wit
+000009b0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+000009c0: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
+000009d0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000009e0: 206d 2e6e 616d 6520 3d20 2263 6861 6e67   m.name = "chang
+000009f0: 6573 2d64 6973 616c 6c6f 7765 6422 0a0a  es-disallowed"..
+00000a00: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00000a10: 6174 696f 6e73 5f6b 6579 7328 7365 6c66  ations_keys(self
+00000a20: 293a 0a20 2020 2020 2020 2072 656c 5f61  ):.        rel_a
+00000a30: 7070 3120 3d20 7365 6c66 2e68 6172 6e65  pp1 = self.harne
+00000a40: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00000a50: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
+00000a60: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
+00000a70: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00000a80: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
+00000a90: 6170 7031 2c20 2772 656d 6f74 6561 7070  app1, 'remoteapp
+00000aa0: 312f 3027 290a 2020 2020 2020 2020 7365  1/0').        se
+00000ab0: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00000ac0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00000ad0: 5f61 7070 312c 2027 7265 6d6f 7465 6170  _app1, 'remoteap
+00000ae0: 7031 2f31 2729 0a20 2020 2020 2020 2072  p1/1').        r
+00000af0: 656c 5f61 7070 3220 3d20 7365 6c66 2e68  el_app2 = self.h
+00000b00: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00000b10: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
+00000b20: 7465 6170 7032 2729 0a20 2020 2020 2020  teapp2').       
+00000b30: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00000b40: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+00000b50: 7265 6c5f 6170 7032 2c20 2772 656d 6f74  rel_app2, 'remot
+00000b60: 6561 7070 322f 3027 290a 0a20 2020 2020  eapp2/0')..     
+00000b70: 2020 2023 2057 6520 696e 7661 6c69 6461     # We invalida
+00000b80: 7465 2064 6231 2073 6f20 7468 6174 2069  te db1 so that i
+00000b90: 7420 6361 7573 6573 2075 7320 746f 2072  t causes us to r
+00000ba0: 656c 6f61 6420 6974 0a20 2020 2020 2020  eload it.       
+00000bb0: 2073 656c 662e 6d6f 6465 6c2e 7265 6c61   self.model.rela
+00000bc0: 7469 6f6e 732e 5f69 6e76 616c 6964 6174  tions._invalidat
+00000bd0: 6528 2764 6231 2729 0a20 2020 2020 2020  e('db1').       
+00000be0: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
+00000bf0: 6e64 4361 6c6c 7328 290a 2020 2020 2020  ndCalls().      
+00000c00: 2020 666f 7220 7265 6c61 7469 6f6e 2069    for relation i
+00000c10: 6e20 7365 6c66 2e6d 6f64 656c 2e72 656c  n self.model.rel
+00000c20: 6174 696f 6e73 5b27 6462 3127 5d3a 0a20  ations['db1']:. 
+00000c30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000c40: 6173 7365 7274 496e 2873 656c 662e 6d6f  assertIn(self.mo
+00000c50: 6465 6c2e 756e 6974 2c20 7265 6c61 7469  del.unit, relati
+00000c60: 6f6e 2e64 6174 6129 0a20 2020 2020 2020  on.data).       
+00000c70: 2020 2020 2075 6e69 745f 6672 6f6d 5f72       unit_from_r
+00000c80: 656c 203d 206e 6578 7428 6669 6c74 6572  el = next(filter
+00000c90: 286c 616d 6264 6120 753a 2075 2e6e 616d  (lambda u: u.nam
+00000ca0: 6520 3d3d 2027 6d79 6170 702f 3027 2c20  e == 'myapp/0', 
+00000cb0: 7265 6c61 7469 6f6e 2e64 6174 612e 6b65  relation.data.ke
+00000cc0: 7973 2829 2929 0a20 2020 2020 2020 2020  ys())).         
+00000cd0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00000ce0: 2873 656c 662e 6d6f 6465 6c2e 756e 6974  (self.model.unit
+00000cf0: 2c20 756e 6974 5f66 726f 6d5f 7265 6c29  , unit_from_rel)
+00000d00: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00000d10: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
+00000d20: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
+00000d30: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
+00000d40: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
+00000d50: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+00000d60: 6c69 7374 272c 2072 656c 5f61 7070 3129  list', rel_app1)
+00000d70: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+00000d80: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
+00000d90: 7265 6c5f 6170 7032 292c 0a20 2020 2020  rel_app2),.     
+00000da0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+00000db0: 6573 745f 7265 6c61 7469 6f6e 735f 696d  est_relations_im
+00000dc0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+00000dd0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000de0: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00000df0: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00000e00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000e10: 6d6f 6465 6c2e 7265 6c61 7469 6f6e 7320  model.relations 
+00000e20: 3d20 7b7d 0a0a 2020 2020 6465 6620 7465  = {}..    def te
+00000e30: 7374 5f67 6574 5f72 656c 6174 696f 6e28  st_get_relation(
+00000e40: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+00000e50: 206f 6e65 2072 656c 6174 696f 6e20 6f6e   one relation on
+00000e60: 2064 6231 0a20 2020 2020 2020 2023 2074   db1.        # t
+00000e70: 776f 2072 656c 6174 696f 6e73 206f 6e20  wo relations on 
+00000e80: 6462 300a 2020 2020 2020 2020 2320 6e6f  db0.        # no
+00000e90: 2072 656c 6174 696f 6e73 206f 6e20 6462   relations on db
+00000ea0: 320a 2020 2020 2020 2020 7265 6c61 7469  2.        relati
+00000eb0: 6f6e 5f69 645f 6462 3120 3d20 7365 6c66  on_id_db1 = self
+00000ec0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+00000ed0: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
+00000ee0: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+00000ef0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00000f00: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00000f10: 7428 7265 6c61 7469 6f6e 5f69 645f 6462  t(relation_id_db
+00000f20: 312c 2027 7265 6d6f 7465 6170 7031 2f30  1, 'remoteapp1/0
+00000f30: 2729 0a20 2020 2020 2020 2072 656c 6174  ').        relat
+00000f40: 696f 6e5f 6964 5f64 6230 5f62 203d 2073  ion_id_db0_b = s
+00000f50: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+00000f60: 7265 6c61 7469 6f6e 2827 6462 3027 2c20  relation('db0', 
+00000f70: 2761 6e6f 7468 6572 2729 0a20 2020 2020  'another').     
+00000f80: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00000f90: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00000fa0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00000fb0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00000fc0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00000fd0: 2020 2020 2020 2020 2023 2059 6f75 2068           # You h
+00000fe0: 6176 6520 746f 2073 7065 6369 6679 2069  ave to specify i
+00000ff0: 7420 6279 206a 7573 7420 7468 6520 696e  t by just the in
+00001000: 7465 6765 7220 4944 0a20 2020 2020 2020  teger ID.       
+00001010: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00001020: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00001030: 3127 2c20 6627 6462 313a 7b72 656c 6174  1', f'db1:{relat
+00001040: 696f 6e5f 6964 5f64 6231 7d27 290a 2020  ion_id_db1}').  
+00001050: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
+00001060: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+00001070: 656c 6174 696f 6e28 2764 6231 272c 2072  elation('db1', r
+00001080: 656c 6174 696f 6e5f 6964 5f64 6231 290a  elation_id_db1).
+00001090: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000010a0: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
+000010b0: 6c5f 6462 312c 206f 7073 2e52 656c 6174  l_db1, ops.Relat
+000010c0: 696f 6e29 0a20 2020 2020 2020 2073 656c  ion).        sel
+000010d0: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+000010e0: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+000010f0: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
+00001100: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
+00001110: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+00001120: 6f6e 5f6c 6973 7427 2c20 7265 6c61 7469  on_list', relati
+00001130: 6f6e 5f69 645f 6462 3129 2c0a 2020 2020  on_id_db1),.    
+00001140: 2020 2020 5d29 0a20 2020 2020 2020 2064      ]).        d
+00001150: 6561 645f 7265 6c20 3d20 7365 6c66 2e6d  ead_rel = self.m
+00001160: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+00001170: 6e28 2764 6231 272c 2037 290a 2020 2020  n('db1', 7).    
+00001180: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00001190: 7349 6e73 7461 6e63 6528 6465 6164 5f72  sInstance(dead_r
+000011a0: 656c 2c20 6f70 732e 5265 6c61 7469 6f6e  el, ops.Relation
+000011b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000011c0: 7373 6572 7445 7175 616c 2873 6574 2864  ssertEqual(set(d
+000011d0: 6561 645f 7265 6c2e 6461 7461 2e6b 6579  ead_rel.data.key
+000011e0: 7328 2929 2c20 7b73 656c 662e 6d6f 6465  s()), {self.mode
+000011f0: 6c2e 756e 6974 2c20 7365 6c66 2e6d 6f64  l.unit, self.mod
+00001200: 656c 2e75 6e69 742e 6170 707d 290a 2020  el.unit.app}).  
+00001210: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001220: 7445 7175 616c 2864 6561 645f 7265 6c2e  tEqual(dead_rel.
+00001230: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
+00001240: 756e 6974 5d2c 207b 7d29 0a20 2020 2020  unit], {}).     
+00001250: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+00001260: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+00001270: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+00001280: 696f 6e5f 6c69 7374 272c 2037 292c 0a20  ion_list', 7),. 
+00001290: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+000012a0: 6174 696f 6e5f 7265 6d6f 7465 5f61 7070  ation_remote_app
+000012b0: 5f6e 616d 6527 2c20 3729 2c0a 2020 2020  _name', 7),.    
+000012c0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+000012d0: 6f6e 5f67 6574 272c 2037 2c20 276d 7961  on_get', 7, 'mya
+000012e0: 7070 2f30 272c 2046 616c 7365 292c 0a20  pp/0', False),. 
+000012f0: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
+00001300: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00001310: 4e6f 6e65 2873 656c 662e 6d6f 6465 6c2e  None(self.model.
+00001320: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00001330: 3227 2929 0a20 2020 2020 2020 2073 656c  2')).        sel
+00001340: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00001350: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+00001360: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
+00001370: 7327 2c20 2764 6232 2729 2c0a 2020 2020  s', 'db2'),.    
+00001380: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
+00001390: 656c 662e 6173 7365 7274 4973 2873 656c  elf.assertIs(sel
+000013a0: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+000013b0: 7469 6f6e 2827 6462 3127 292c 2072 656c  tion('db1'), rel
+000013c0: 5f64 6231 290a 2020 2020 2020 2020 7769  _db1).        wi
+000013d0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000013e0: 6973 6573 286f 7073 2e54 6f6f 4d61 6e79  ises(ops.TooMany
+000013f0: 5265 6c61 7465 6441 7070 7345 7272 6f72  RelatedAppsError
+00001400: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00001410: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
+00001420: 6c61 7469 6f6e 2827 6462 3027 290a 0a20  lation('db0').. 
+00001430: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00001440: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
+00001450: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
+00001460: 656c 6174 696f 6e5f 6964 7327 2c20 2764  elation_ids', 'd
+00001470: 6230 2729 2c0a 2020 2020 2020 2020 2020  b0'),.          
+00001480: 2020 2827 7265 6c61 7469 6f6e 5f6c 6973    ('relation_lis
+00001490: 7427 2c20 7365 6c66 2e72 656c 6174 696f  t', self.relatio
+000014a0: 6e5f 6964 5f64 6230 292c 0a20 2020 2020  n_id_db0),.     
+000014b0: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+000014c0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
+000014d0: 6527 2c20 3029 2c0a 2020 2020 2020 2020  e', 0),.        
+000014e0: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
+000014f0: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
+00001500: 645f 6462 305f 6229 2c0a 2020 2020 2020  d_db0_b),.      
+00001510: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+00001520: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
+00001530: 272c 2032 292c 0a20 2020 2020 2020 205d  ', 2),.        ]
+00001540: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00001550: 7065 6572 5f72 656c 6174 696f 6e5f 6170  peer_relation_ap
+00001560: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
+00001570: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00001580: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
+00001590: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
+000015a0: 2020 2072 656c 5f64 6270 6565 7220 3d20     rel_dbpeer = 
+000015b0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+000015c0: 656c 6174 696f 6e28 2764 6232 2729 0a20  elation('db2'). 
+000015d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000015e0: 7274 4973 2872 656c 5f64 6270 6565 722e  rtIs(rel_dbpeer.
+000015f0: 6170 702c 2073 656c 662e 6d6f 6465 6c2e  app, self.model.
+00001600: 6170 7029 0a0a 2020 2020 6465 6620 7465  app)..    def te
+00001610: 7374 5f72 656d 6f74 655f 756e 6974 735f  st_remote_units_
+00001620: 6973 5f6f 7572 2873 656c 6629 3a0a 2020  is_our(self):.  
+00001630: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+00001640: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
+00001650: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00001660: 6231 272c 2027 7265 6d6f 7465 6170 7031  b1', 'remoteapp1
+00001670: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00001680: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001690: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+000016a0: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
+000016b0: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
+000016c0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+000016d0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+000016e0: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
+000016f0: 7465 6170 7031 2f31 2729 0a20 2020 2020  teapp1/1').     
+00001700: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00001710: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00001720: 2020 2020 2066 6f72 2075 2069 6e20 7365       for u in se
+00001730: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00001740: 6174 696f 6e28 2764 6231 2729 2e75 6e69  ation('db1').uni
+00001750: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00001760: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+00001770: 2875 2e5f 6973 5f6f 7572 5f75 6e69 7429  (u._is_our_unit)
+00001780: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001790: 662e 6173 7365 7274 4661 6c73 6528 752e  f.assertFalse(u.
+000017a0: 6170 702e 5f69 735f 6f75 725f 6170 7029  app._is_our_app)
+000017b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000017c0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
+000017d0: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
+000017e0: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
+000017f0: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
+00001800: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+00001810: 6c69 7374 272c 2072 656c 6174 696f 6e5f  list', relation_
+00001820: 6964 290a 2020 2020 2020 2020 5d29 0a0a  id).        ])..
+00001830: 2020 2020 6465 6620 7465 7374 5f6f 7572      def test_our
+00001840: 5f75 6e69 745f 6973 5f6f 7572 2873 656c  _unit_is_our(sel
+00001850: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00001860: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+00001870: 2e6d 6f64 656c 2e75 6e69 742e 5f69 735f  .model.unit._is_
+00001880: 6f75 725f 756e 6974 290a 2020 2020 2020  our_unit).      
+00001890: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+000018a0: 6528 7365 6c66 2e6d 6f64 656c 2e75 6e69  e(self.model.uni
+000018b0: 742e 6170 702e 5f69 735f 6f75 725f 6170  t.app._is_our_ap
+000018c0: 7029 0a0a 2020 2020 6465 6620 7465 7374  p)..    def test
+000018d0: 5f69 6e76 616c 6964 5f74 7970 655f 7265  _invalid_type_re
+000018e0: 6c61 7469 6f6e 5f64 6174 6128 7365 6c66  lation_data(self
+000018f0: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+00001900: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+00001910: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00001920: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00001930: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
+00001940: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00001950: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00001960: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00001970: 6f74 6561 7070 312f 3027 290a 0a20 2020  oteapp1/0')..   
+00001980: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00001990: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+000019a0: 5265 6c61 7469 6f6e 4461 7461 4572 726f  RelationDataErro
+000019b0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000019c0: 7769 7468 2073 656c 662e 6861 726e 6573  with self.harnes
+000019d0: 732e 5f65 7665 6e74 5f63 6f6e 7465 7874  s._event_context
+000019e0: 2827 666f 6f5f 6576 656e 7427 293a 0a20  ('foo_event'):. 
+000019f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00001a00: 656c 662e 6861 726e 6573 732e 7570 6461  elf.harness.upda
+00001a10: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00001a20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00001a30: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+00001a40: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00001a50: 2020 2020 2020 2027 7265 6d6f 7465 6170         'remoteap
+00001a60: 7031 2f30 272c 0a20 2020 2020 2020 2020  p1/0',.         
+00001a70: 2020 2020 2020 2020 2020 207b 3432 3a20             {42: 
+00001a80: 2772 656d 6f74 6561 7070 312d 3027 7d29  'remoteapp1-0'})
+00001a90: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+00001aa0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00001ab0: 286f 7073 2e52 656c 6174 696f 6e44 6174  (ops.RelationDat
+00001ac0: 6145 7272 6f72 293a 0a20 2020 2020 2020  aError):.       
+00001ad0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+00001ae0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+00001af0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+00001b00: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00001b10: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00001b20: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00001b30: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00001b40: 2020 2020 2020 2020 2020 2072 656c 6174             relat
+00001b50: 696f 6e5f 6964 2c0a 2020 2020 2020 2020  ion_id,.        
+00001b60: 2020 2020 2020 2020 2020 2020 2772 656d              'rem
+00001b70: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
+00001b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b90: 7b27 666f 6f27 3a20 3432 7d29 0a0a 2020  {'foo': 42})..  
+00001ba0: 2020 6465 6620 7465 7374 5f67 6574 5f61    def test_get_a
+00001bb0: 7070 5f72 656c 6174 696f 6e5f 6461 7461  pp_relation_data
+00001bc0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00001bd0: 7365 6c66 2e68 6172 6e65 7373 2e62 6567  self.harness.beg
+00001be0: 696e 2829 0a20 2020 2020 2020 2072 656c  in().        rel
+00001bf0: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
+00001c00: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001c10: 7469 6f6e 2827 6462 3127 2c20 2772 656d  tion('db1', 'rem
+00001c20: 6f74 6527 290a 2020 2020 2020 2020 7365  ote').        se
+00001c30: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00001c40: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00001c50: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
+00001c60: 652f 3027 290a 2020 2020 2020 2020 6c6f  e/0').        lo
+00001c70: 6361 6c5f 6170 7020 3d20 7365 6c66 2e68  cal_app = self.h
+00001c80: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
+00001c90: 2e6e 616d 650a 2020 2020 2020 2020 7769  .name.        wi
+00001ca0: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00001cb0: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00001cc0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00001cd0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00001ce0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
+00001cf0: 6174 696f 6e5f 6461 7461 280a 2020 2020  ation_data(.    
+00001d00: 2020 2020 2020 2020 2020 2020 7265 6c61              rela
+00001d10: 7469 6f6e 5f69 642c 0a20 2020 2020 2020  tion_id,.       
+00001d20: 2020 2020 2020 2020 206c 6f63 616c 5f61           local_a
+00001d30: 7070 2c0a 2020 2020 2020 2020 2020 2020  pp,.            
+00001d40: 2020 2020 7b27 666f 6f27 3a20 2762 6172      {'foo': 'bar
+00001d50: 277d 290a 2020 2020 2020 2020 2020 2020  '}).            
+00001d60: 6173 7365 7274 2073 656c 662e 6861 726e  assert self.harn
+00001d70: 6573 732e 6765 745f 7265 6c61 7469 6f6e  ess.get_relation
+00001d80: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00001d90: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+00001da0: 6964 2c20 7365 6c66 2e68 6172 6e65 7373  id, self.harness
+00001db0: 2e6d 6f64 656c 2e61 7070 2920 3d3d 2073  .model.app) == s
+00001dc0: 656c 662e 6861 726e 6573 732e 6765 745f  elf.harness.get_
+00001dd0: 7265 6c61 7469 6f6e 5f64 6174 6128 0a20  relation_data(. 
+00001de0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001df0: 656c 6174 696f 6e5f 6964 2c20 6c6f 6361  elation_id, loca
+00001e00: 6c5f 6170 7029 203d 3d20 7b27 666f 6f27  l_app) == {'foo'
+00001e10: 3a20 2762 6172 277d 0a0a 2020 2020 6465  : 'bar'}..    de
+00001e20: 6620 7465 7374 5f75 6e69 745f 7265 6c61  f test_unit_rela
+00001e30: 7469 6f6e 5f64 6174 6128 7365 6c66 293a  tion_data(self):
+00001e40: 0a20 2020 2020 2020 2072 656c 6174 696f  .        relatio
+00001e50: 6e5f 6964 203d 2073 656c 662e 6861 726e  n_id = self.harn
+00001e60: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00001e70: 2827 6462 3127 2c20 2772 656d 6f74 6561  ('db1', 'remotea
+00001e80: 7070 3127 290a 2020 2020 2020 2020 7365  pp1').        se
+00001e90: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00001ea0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00001eb0: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
+00001ec0: 6561 7070 312f 3027 290a 2020 2020 2020  eapp1/0').      
+00001ed0: 2020 7769 7468 2073 656c 662e 6861 726e    with self.harn
+00001ee0: 6573 732e 5f65 7665 6e74 5f63 6f6e 7465  ess._event_conte
+00001ef0: 7874 2827 666f 6f5f 6576 656e 7427 293a  xt('foo_event'):
+00001f00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001f10: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+00001f20: 5f72 656c 6174 696f 6e5f 6461 7461 280a  _relation_data(.
+00001f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f40: 7265 6c61 7469 6f6e 5f69 642c 0a20 2020  relation_id,.   
+00001f50: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00001f60: 6d6f 7465 6170 7031 2f30 272c 0a20 2020  moteapp1/0',.   
+00001f70: 2020 2020 2020 2020 2020 2020 207b 2768               {'h
+00001f80: 6f73 7427 3a20 2772 656d 6f74 6561 7070  ost': 'remoteapp
+00001f90: 312d 3027 7d29 0a20 2020 2020 2020 2073  1-0'}).        s
+00001fa0: 656c 662e 6d6f 6465 6c2e 7265 6c61 7469  elf.model.relati
+00001fb0: 6f6e 732e 5f69 6e76 616c 6964 6174 6528  ons._invalidate(
+00001fc0: 2764 6231 2729 0a20 2020 2020 2020 2073  'db1').        s
+00001fd0: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
+00001fe0: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
+00001ff0: 2072 616e 646f 6d5f 756e 6974 203d 2073   random_unit = s
+00002000: 656c 662e 6d6f 6465 6c2e 6765 745f 756e  elf.model.get_un
+00002010: 6974 2827 7261 6e64 6f6d 756e 6974 2f30  it('randomunit/0
+00002020: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+00002030: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00002040: 7328 4b65 7945 7272 6f72 293a 0a20 2020  s(KeyError):.   
+00002050: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
+00002060: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00002070: 2827 6462 3127 292e 6461 7461 5b72 616e  ('db1').data[ran
+00002080: 646f 6d5f 756e 6974 5d0a 2020 2020 2020  dom_unit].      
+00002090: 2020 7265 6d6f 7465 6170 7031 5f30 203d    remoteapp1_0 =
+000020a0: 206e 6578 7428 6669 6c74 6572 286c 616d   next(filter(lam
+000020b0: 6264 6120 753a 2075 2e6e 616d 6520 3d3d  bda u: u.name ==
+000020c0: 2027 7265 6d6f 7465 6170 7031 2f30 272c   'remoteapp1/0',
+000020d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020f0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
+00002100: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00002110: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
+00002120: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00002130: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e67  ual(self.model.g
+00002140: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00002150: 2729 2e64 6174 615b 7265 6d6f 7465 6170  ').data[remoteap
+00002160: 7031 5f30 5d2c 0a20 2020 2020 2020 2020  p1_0],.         
+00002170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002180: 7b27 686f 7374 273a 2027 7265 6d6f 7465  {'host': 'remote
+00002190: 6170 7031 2d30 277d 290a 0a20 2020 2020  app1-0'})..     
+000021a0: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+000021b0: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+000021c0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+000021d0: 696f 6e5f 6964 7327 2c20 2764 6231 2729  ion_ids', 'db1')
+000021e0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+000021f0: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
+00002200: 7265 6c61 7469 6f6e 5f69 6429 2c0a 2020  relation_id),.  
+00002210: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
+00002220: 7469 6f6e 5f67 6574 272c 2072 656c 6174  tion_get', relat
+00002230: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+00002240: 7070 312f 3027 2c20 4661 6c73 6529 2c0a  pp1/0', False),.
+00002250: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+00002260: 6465 6620 7465 7374 5f72 656d 6f74 655f  def test_remote_
+00002270: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
+00002280: 6128 7365 6c66 293a 0a20 2020 2020 2020  a(self):.       
+00002290: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
+000022a0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+000022b0: 7265 6c61 7469 6f6e 2827 6462 3127 2c20  relation('db1', 
+000022c0: 2772 656d 6f74 6561 7070 3127 290a 2020  'remoteapp1').  
+000022d0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000022e0: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
+000022f0: 6f6e 7465 7874 2827 666f 6f5f 6576 656e  ontext('foo_even
+00002300: 7427 293a 0a20 2020 2020 2020 2020 2020  t'):.           
+00002310: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00002320: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002330: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00002340: 2772 656d 6f74 6561 7070 3127 2c0a 2020  'remoteapp1',.  
+00002350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002370: 2020 2020 2020 2020 2020 2020 7b27 7365              {'se
+00002380: 6372 6574 273a 2027 6361 6665 6465 6164  cret': 'cafedead
+00002390: 6265 6566 277d 290a 2020 2020 2020 2020  beef'}).        
+000023a0: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+000023b0: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+000023c0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+000023d0: 6f74 6561 7070 312f 3027 290a 2020 2020  oteapp1/0').    
+000023e0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+000023f0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+00002400: 6974 2872 656c 6174 696f 6e5f 6964 2c20  it(relation_id, 
+00002410: 2772 656d 6f74 6561 7070 312f 3127 290a  'remoteapp1/1').
+00002420: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00002430: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00002440: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
+00002450: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
+00002460: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00002470: 2729 0a20 2020 2020 2020 2023 2054 7279  ').        # Try
+00002480: 2074 6f20 6765 7420 7265 6c61 7469 6f6e   to get relation
+00002490: 2064 6174 6120 666f 7220 616e 2069 6e76   data for an inv
+000024a0: 616c 6964 2072 656d 6f74 6520 6170 706c  alid remote appl
+000024b0: 6963 6174 696f 6e2e 0a20 2020 2020 2020  ication..       
+000024c0: 2072 616e 646f 6d5f 6170 7020 3d20 7365   random_app = se
+000024d0: 6c66 2e6d 6f64 656c 2e5f 6361 6368 652e  lf.model._cache.
+000024e0: 6765 7428 6f70 732e 4170 706c 6963 6174  get(ops.Applicat
+000024f0: 696f 6e2c 2027 7261 6e64 6f6d 6170 7027  ion, 'randomapp'
+00002500: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00002510: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00002520: 284b 6579 4572 726f 7229 3a0a 2020 2020  (KeyError):.    
+00002530: 2020 2020 2020 2020 7265 6c5f 6462 312e          rel_db1.
+00002540: 6461 7461 5b72 616e 646f 6d5f 6170 705d  data[random_app]
+00002550: 0a0a 2020 2020 2020 2020 7265 6d6f 7465  ..        remote
+00002560: 6170 7031 203d 2072 656c 5f64 6231 2e61  app1 = rel_db1.a
+00002570: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
+00002580: 6173 7365 7274 4571 7561 6c28 7265 6d6f  assertEqual(remo
+00002590: 7465 6170 7031 2e6e 616d 652c 2027 7265  teapp1.name, 're
+000025a0: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+000025b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000025c0: 7561 6c28 7265 6c5f 6462 312e 6461 7461  ual(rel_db1.data
+000025d0: 5b72 656d 6f74 6561 7070 315d 2c0a 2020  [remoteapp1],.  
+000025e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025f0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
+00002600: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
+00002610: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+00002620: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00002630: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+00002640: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+00002650: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+00002660: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00002670: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00002680: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+00002690: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+000026a0: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+000026b0: 2027 7265 6d6f 7465 6170 7031 272c 2054   'remoteapp1', T
+000026c0: 7275 6529 2c0a 2020 2020 2020 2020 5d29  rue),.        ])
+000026d0: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
+000026e0: 656c 6174 696f 6e5f 6461 7461 5f6d 6f64  elation_data_mod
+000026f0: 6966 795f 7265 6d6f 7465 2873 656c 6629  ify_remote(self)
+00002700: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
+00002710: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
+00002720: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00002730: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+00002740: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
+00002750: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+00002760: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+00002770: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+00002780: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00002790: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+000027a0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+000027b0: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+000027c0: 6170 7031 272c 0a20 2020 2020 2020 2020  app1',.         
+000027d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027f0: 2020 2020 207b 2773 6563 7265 7427 3a20       {'secret': 
+00002800: 2763 6166 6564 6561 6462 6565 6627 7d29  'cafedeadbeef'})
+00002810: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002820: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00002830: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
+00002840: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+00002850: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
+00002860: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00002870: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00002880: 6e5f 6461 7461 2872 656c 6174 696f 6e5f  n_data(relation_
+00002890: 6964 2c20 2772 656d 6f74 6561 7070 312f  id, 'remoteapp1/
+000028a0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+000028b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000028c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000028d0: 2020 7b27 686f 7374 273a 2027 7265 6d6f    {'host': 'remo
+000028e0: 7465 6170 7031 2f30 277d 290a 2020 2020  teapp1/0'}).    
+000028f0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e72      self.model.r
+00002900: 656c 6174 696f 6e73 2e5f 696e 7661 6c69  elations._invali
+00002910: 6461 7465 2827 6462 3127 290a 2020 2020  date('db1').    
+00002920: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
+00002930: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
+00002940: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
+00002950: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+00002960: 656c 6174 696f 6e28 2764 6231 2729 0a20  elation('db1'). 
+00002970: 2020 2020 2020 2072 656d 6f74 6561 7070         remoteapp
+00002980: 315f 3020 3d20 6e65 7874 2866 696c 7465  1_0 = next(filte
+00002990: 7228 6c61 6d62 6461 2075 3a20 752e 6e61  r(lambda u: u.na
+000029a0: 6d65 203d 3d20 2772 656d 6f74 6561 7070  me == 'remoteapp
+000029b0: 312f 3027 2c0a 2020 2020 2020 2020 2020  1/0',.          
+000029c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029d0: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
+000029e0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+000029f0: 2827 6462 3127 292e 756e 6974 7329 290a  ('db1').units)).
+00002a00: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
+00002a10: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
+00002a20: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
+00002a30: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
+00002a40: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
+00002a50: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
+00002a60: 5f30 5d29 0a20 2020 2020 2020 2073 656c  _0]).        sel
+00002a70: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
+00002a80: 7072 2872 656c 5f64 6231 2e64 6174 615b  pr(rel_db1.data[
+00002a90: 7265 6d6f 7465 6170 7031 5f30 5d29 2c20  remoteapp1_0]), 
+00002aa0: 227b 2768 6f73 7427 3a20 2772 656d 6f74  "{'host': 'remot
+00002ab0: 6561 7070 312f 3027 7d22 290a 0a20 2020  eapp1/0'}")..   
+00002ac0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+00002ad0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+00002ae0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+00002af0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00002b00: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00002b10: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00002b20: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
+00002b30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00002b40: 656c 5f64 6231 2e64 6174 615b 7265 6d6f  el_db1.data[remo
+00002b50: 7465 6170 7031 5f30 5d5b 2766 6f6f 275d  teapp1_0]['foo']
+00002b60: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+00002b70: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
+00002b80: 6e28 2766 6f6f 272c 2072 656c 5f64 6231  n('foo', rel_db1
+00002b90: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
+00002ba0: 5f30 5d29 0a0a 2020 2020 2020 2020 7365  _0])..        se
+00002bb0: 6c66 2e61 7373 6572 7442 6163 6b65 6e64  lf.assertBackend
+00002bc0: 4361 6c6c 7328 5b0a 2020 2020 2020 2020  Calls([.        
+00002bd0: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
+00002be0: 6473 272c 2027 6462 3127 292c 0a20 2020  ds', 'db1'),.   
+00002bf0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+00002c00: 696f 6e5f 6c69 7374 272c 2072 656c 6174  ion_list', relat
+00002c10: 696f 6e5f 6964 292c 0a20 2020 2020 2020  ion_id),.       
+00002c20: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+00002c30: 6765 7427 2c20 7265 6c61 7469 6f6e 5f69  get', relation_i
+00002c40: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
+00002c50: 272c 2046 616c 7365 292c 0a20 2020 2020  ', False),.     
+00002c60: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
+00002c70: 2074 6869 7320 7769 6c6c 2066 6972 6520   this will fire 
+00002c80: 6d6f 7265 2062 6163 6b65 6e64 2063 616c  more backend cal
+00002c90: 6c73 0a20 2020 2020 2020 2077 6974 6820  ls.        with 
+00002ca0: 7365 6c66 2e68 6172 6e65 7373 2e5f 6576  self.harness._ev
+00002cb0: 656e 745f 636f 6e74 6578 7428 2766 6f6f  ent_context('foo
+00002cc0: 5f65 7665 6e74 2729 3a0a 2020 2020 2020  _event'):.      
+00002cd0: 2020 2020 2020 6461 7461 5f72 6570 7220        data_repr 
+00002ce0: 3d20 7265 7072 2872 656c 5f64 6231 2e64  = repr(rel_db1.d
+00002cf0: 6174 6129 0a20 2020 2020 2020 2073 656c  ata).        sel
+00002d00: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00002d10: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00002d20: 7265 7072 2c0a 2020 2020 2020 2020 2020  repr,.          
+00002d30: 2020 2827 7b3c 6f70 732e 6d6f 6465 6c2e    ('{<ops.model.
+00002d40: 556e 6974 206d 7961 7070 2f30 3e3a 207b  Unit myapp/0>: {
+00002d50: 7d2c 2027 0a20 2020 2020 2020 2020 2020  }, '.           
+00002d60: 2020 273c 6f70 732e 6d6f 6465 6c2e 4170    '<ops.model.Ap
+00002d70: 706c 6963 6174 696f 6e20 6d79 6170 703e  plication myapp>
+00002d80: 3a20 3c6e 2f61 3e2c 2027 0a20 2020 2020  : <n/a>, '.     
+00002d90: 2020 2020 2020 2020 223c 6f70 732e 6d6f          "<ops.mo
+00002da0: 6465 6c2e 556e 6974 2072 656d 6f74 6561  del.Unit remotea
+00002db0: 7070 312f 303e 3a20 7b27 686f 7374 273a  pp1/0>: {'host':
+00002dc0: 2027 7265 6d6f 7465 6170 7031 2f30 277d   'remoteapp1/0'}
+00002dd0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+00002de0: 2022 3c6f 7073 2e6d 6f64 656c 2e41 7070   "<ops.model.App
+00002df0: 6c69 6361 7469 6f6e 2072 656d 6f74 6561  lication remotea
+00002e00: 7070 313e 3a20 7b27 7365 6372 6574 273a  pp1>: {'secret':
+00002e10: 2027 6361 6665 6465 6164 6265 6566 277d   'cafedeadbeef'}
+00002e20: 7d22 2929 0a0a 2020 2020 6465 6620 7465  }"))..    def te
+00002e30: 7374 5f72 656c 6174 696f 6e5f 6461 7461  st_relation_data
+00002e40: 5f6d 6f64 6966 795f 6f75 7228 7365 6c66  _modify_our(self
+00002e50: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+00002e60: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+00002e70: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00002e80: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00002e90: 6561 7070 3127 290a 0a20 2020 2020 2020  eapp1')..       
+00002ea0: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00002eb0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002ec0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00002ed0: 276d 7961 7070 2f30 272c 207b 2768 6f73  'myapp/0', {'hos
+00002ee0: 7427 3a20 276e 6f74 6869 6e67 277d 290a  t': 'nothing'}).
+00002ef0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00002f00: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00002f10: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00002f20: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
+00002f30: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+00002f40: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+00002f50: 2020 2020 7265 6c5f 6462 3120 3d20 7365      rel_db1 = se
+00002f60: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00002f70: 6174 696f 6e28 2764 6231 2729 0a20 2020  ation('db1').   
+00002f80: 2020 2020 2020 2020 2023 2075 7064 6174           # updat
+00002f90: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
+00002fa0: 7769 6c6c 2061 6c73 6f20 7472 6967 6765  will also trigge
+00002fb0: 7220 7265 6c61 7469 6f6e 2d67 6574 2c20  r relation-get, 
+00002fc0: 736f 2077 650a 2020 2020 2020 2020 2020  so we.          
+00002fd0: 2020 2320 696e 7661 6c69 6461 7465 2074    # invalidate t
+00002fe0: 6865 2063 6163 6865 2074 6f20 656e 7375  he cache to ensu
+00002ff0: 7265 2069 7420 7769 6c6c 2062 6520 7265  re it will be re
+00003000: 6c6f 6164 6564 0a20 2020 2020 2020 2020  loaded.         
+00003010: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
+00003020: 7365 6c66 2e6d 6f64 656c 2e75 6e69 745d  self.model.unit]
+00003030: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
+00003040: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
+00003050: 6365 206d 656d 6f72 7920 6361 6368 6520  ce memory cache 
+00003060: 746f 2062 6520 6c6f 6164 6564 2e0a 2020  to be loaded..  
+00003070: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00003080: 7373 6572 7449 6e28 2768 6f73 7427 2c20  ssertIn('host', 
+00003090: 7265 6c5f 6462 312e 6461 7461 5b73 656c  rel_db1.data[sel
+000030a0: 662e 6d6f 6465 6c2e 756e 6974 5d29 0a20  f.model.unit]). 
+000030b0: 2020 2020 2020 2020 2020 2072 656c 5f64             rel_d
+000030c0: 6231 2e64 6174 615b 7365 6c66 2e6d 6f64  b1.data[self.mod
+000030d0: 656c 2e75 6e69 745d 5b27 686f 7374 275d  el.unit]['host']
+000030e0: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+000030f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00003100: 4571 7561 6c28 7265 6c5f 6462 312e 6461  Equal(rel_db1.da
+00003110: 7461 5b73 656c 662e 6d6f 6465 6c2e 756e  ta[self.model.un
+00003120: 6974 5d5b 2768 6f73 7427 5d2c 2027 6261  it]['host'], 'ba
+00003130: 7227 290a 0a20 2020 2020 2020 2073 656c  r')..        sel
+00003140: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00003150: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+00003160: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00003170: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+00003180: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+00003190: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000031a0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+000031b0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+000031c0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+000031d0: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+000031e0: 6261 7227 292c 0a20 2020 2020 2020 205d  bar'),.        ]
+000031f0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00003200: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
+00003210: 615f 6d6f 6469 6679 5f6c 6f63 616c 5f61  a_modify_local_a
+00003220: 735f 6c65 6164 6572 2873 656c 6629 3a0a  s_leader(self):.
+00003230: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
+00003240: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
+00003250: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00003260: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
+00003270: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
+00003280: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+00003290: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000032a0: 656c 6174 696f 6e5f 6964 2c20 276d 7961  elation_id, 'mya
+000032b0: 7070 272c 207b 2770 6173 7377 6f72 6427  pp', {'password'
+000032c0: 3a20 2764 6561 6462 6565 6663 6166 6527  : 'deadbeefcafe'
+000032d0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000032e0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+000032f0: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+00003300: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
+00003310: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
+00003320: 656c 662e 6861 726e 6573 732e 7365 745f  elf.harness.set_
+00003330: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
+00003340: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
+00003350: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
+00003360: 2020 2020 2020 206c 6f63 616c 5f61 7070         local_app
+00003370: 203d 2073 656c 662e 6d6f 6465 6c2e 756e   = self.model.un
+00003380: 6974 2e61 7070 0a0a 2020 2020 2020 2020  it.app..        
+00003390: 7265 6c5f 6462 3120 3d20 7365 6c66 2e6d  rel_db1 = self.m
+000033a0: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+000033b0: 6e28 2764 6231 2729 0a20 2020 2020 2020  n('db1').       
+000033c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000033d0: 6c28 7265 6c5f 6462 312e 6461 7461 5b6c  l(rel_db1.data[l
+000033e0: 6f63 616c 5f61 7070 5d2c 207b 2770 6173  ocal_app], {'pas
+000033f0: 7377 6f72 6427 3a20 2764 6561 6462 6565  sword': 'deadbee
+00003400: 6663 6166 6527 7d29 0a0a 2020 2020 2020  fcafe'})..      
+00003410: 2020 7265 6c5f 6462 312e 6461 7461 5b6c    rel_db1.data[l
+00003420: 6f63 616c 5f61 7070 5d5b 2770 6173 7377  ocal_app]['passw
+00003430: 6f72 6427 5d20 3d20 2766 6f6f 270a 0a20  ord'] = 'foo'.. 
+00003440: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00003450: 7274 4571 7561 6c28 7265 6c5f 6462 312e  rtEqual(rel_db1.
+00003460: 6461 7461 5b6c 6f63 616c 5f61 7070 5d5b  data[local_app][
+00003470: 2770 6173 7377 6f72 6427 5d2c 2027 666f  'password'], 'fo
+00003480: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
+00003490: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+000034a0: 616c 6c73 280a 2020 2020 2020 2020 2020  alls(.          
+000034b0: 2020 5b28 2772 656c 6174 696f 6e5f 6964    [('relation_id
+000034c0: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
+000034d0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+000034e0: 696f 6e5f 6c69 7374 272c 2031 292c 0a20  ion_list', 1),. 
+000034f0: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
+00003500: 6c61 7469 6f6e 5f67 6574 272c 2031 2c20  lation_get', 1, 
+00003510: 276d 7961 7070 272c 2054 7275 6529 2c0a  'myapp', True),.
+00003520: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00003530: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00003540: 6174 6127 2c20 312c 2073 656c 662e 6d6f  ata', 1, self.mo
+00003550: 6465 6c2e 6170 702c 2027 7061 7373 776f  del.app, 'passwo
+00003560: 7264 272c 2027 666f 6f27 295d 290a 0a20  rd', 'foo')]).. 
+00003570: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
+00003580: 7265 6c61 7469 6f6e 5f64 6174 615f 6d6f  relation_data_mo
+00003590: 6469 6679 5f6c 6f63 616c 5f61 735f 6d69  dify_local_as_mi
+000035a0: 6e69 6f6e 2873 656c 6629 3a0a 2020 2020  nion(self):.    
+000035b0: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
+000035c0: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+000035d0: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
+000035e0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
+000035f0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+00003600: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
+00003610: 6174 696f 6e5f 6461 7461 2872 656c 6174  ation_data(relat
+00003620: 696f 6e5f 6964 2c20 276d 7961 7070 272c  ion_id, 'myapp',
+00003630: 207b 2770 6173 7377 6f72 6427 3a20 2764   {'password': 'd
+00003640: 6561 6462 6565 6663 6166 6527 7d29 0a20  eadbeefcafe'}). 
+00003650: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+00003660: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00003670: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
+00003680: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
+00003690: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000036a0: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
+000036b0: 6572 2846 616c 7365 290a 2020 2020 2020  er(False).      
+000036c0: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
+000036d0: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
+000036e0: 2020 2020 6c6f 6361 6c5f 6170 7020 3d20      local_app = 
+000036f0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
+00003700: 6170 700a 0a20 2020 2020 2020 2072 656c  app..        rel
+00003710: 5f64 6231 203d 2073 656c 662e 6d6f 6465  _db1 = self.mode
+00003720: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
+00003730: 6462 3127 290a 2020 2020 2020 2020 7365  db1').        se
+00003740: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00003750: 656c 5f64 6231 2e64 6174 615b 6c6f 6361  el_db1.data[loca
+00003760: 6c5f 6170 705d 2c20 7b27 7061 7373 776f  l_app], {'passwo
+00003770: 7264 273a 2027 6465 6164 6265 6566 6361  rd': 'deadbeefca
+00003780: 6665 277d 290a 0a20 2020 2020 2020 2077  fe'})..        w
+00003790: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+000037a0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+000037b0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+000037c0: 2020 2020 2020 2020 2020 2320 6966 2077            # if w
+000037d0: 6520 7765 7265 2069 6e73 6964 6520 616e  e were inside an
+000037e0: 2065 7665 6e74 2063 6f6e 7465 7874 2c20   event context, 
+000037f0: 7765 2764 2067 6574 3a0a 2020 2020 2020  we'd get:.      
+00003800: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00003810: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00003820: 2e52 656c 6174 696f 6e44 6174 6145 7272  .RelationDataErr
+00003830: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00003840: 2020 2020 2072 656c 5f64 6231 2e64 6174       rel_db1.dat
+00003850: 615b 6c6f 6361 6c5f 6170 705d 5b27 7061  a[local_app]['pa
+00003860: 7373 776f 7264 275d 203d 2027 666f 6f62  ssword'] = 'foob
+00003870: 6172 270a 0a20 2020 2020 2020 2073 656c  ar'..        sel
+00003880: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00003890: 616c 6c73 285b 2827 7265 6c61 7469 6f6e  alls([('relation
+000038a0: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
+000038b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038d0: 2827 7265 6c61 7469 6f6e 5f6c 6973 7427  ('relation_list'
+000038e0: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
+000038f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003900: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00003910: 6e5f 6765 7427 2c20 312c 2027 6d79 6170  n_get', 1, 'myap
+00003920: 7027 2c20 5472 7565 292c 0a20 2020 2020  p', True),.     
+00003930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003940: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
+00003950: 5f6c 6561 6465 7227 2c29 5d29 0a0a 2020  _leader',)])..  
+00003960: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+00003970: 696f 6e5f 6461 7461 5f61 6363 6573 735f  ion_data_access_
+00003980: 7065 6572 5f6c 6561 6465 7228 7365 6c66  peer_leader(self
+00003990: 293a 0a20 2020 2020 2020 2072 5f69 6420  ):.        r_id 
+000039a0: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+000039b0: 6464 5f72 656c 6174 696f 6e28 2764 6232  dd_relation('db2
+000039c0: 272c 2027 6d79 6170 7027 290a 2020 2020  ', 'myapp').    
+000039d0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+000039e0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+000039f0: 6974 2872 5f69 642c 2027 6d79 6170 702f  it(r_id, 'myapp/
+00003a00: 3127 2920 2023 2070 6565 7221 0a20 2020  1')  # peer!.   
+00003a10: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00003a20: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00003a30: 6e5f 6461 7461 2872 5f69 642c 2027 6d79  n_data(r_id, 'my
+00003a40: 6170 7027 2c20 7b27 666f 6f27 3a20 2762  app', {'foo': 'b
+00003a50: 6172 277d 290a 2020 2020 2020 2020 7769  ar'}).        wi
+00003a60: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00003a70: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00003a80: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00003a90: 2020 2020 2020 2020 2023 206c 6561 6465           # leade
+00003aa0: 7273 2063 616e 2072 6561 640a 2020 2020  rs can read.    
+00003ab0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+00003ac0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+00003ad0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00003ae0: 2020 7265 6c61 7469 6f6e 203d 2073 656c    relation = sel
+00003af0: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
+00003b00: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00003b10: 3227 290a 2020 2020 2020 2020 2020 2020  2').            
+00003b20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003b30: 2872 656c 6174 696f 6e2e 6461 7461 5b72  (relation.data[r
+00003b40: 656c 6174 696f 6e2e 6170 705d 5b27 666f  elation.app]['fo
+00003b50: 6f27 5d2c 2027 6261 7227 290a 0a20 2020  o'], 'bar')..   
+00003b60: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
+00003b70: 6f6e 5f64 6174 615f 6163 6365 7373 5f70  on_data_access_p
+00003b80: 6565 725f 6d69 6e69 6f6e 2873 656c 6629  eer_minion(self)
+00003b90: 3a0a 2020 2020 2020 2020 725f 6964 203d  :.        r_id =
+00003ba0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00003bb0: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
+00003bc0: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
+00003bd0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00003be0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00003bf0: 7428 725f 6964 2c20 276d 7961 7070 2f31  t(r_id, 'myapp/1
+00003c00: 2729 2020 2320 7065 6572 210a 2020 2020  ')  # peer!.    
+00003c10: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00003c20: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00003c30: 5f64 6174 6128 725f 6964 2c20 276d 7961  _data(r_id, 'mya
+00003c40: 7070 272c 207b 2766 6f6f 273a 2027 6261  pp', {'foo': 'ba
+00003c50: 7227 7d29 0a20 2020 2020 2020 2077 6974  r'}).        wit
+00003c60: 6820 7365 6c66 2e68 6172 6e65 7373 2e5f  h self.harness._
+00003c70: 6576 656e 745f 636f 6e74 6578 7428 2766  event_context('f
+00003c80: 6f6f 5f65 7665 6e74 2729 3a0a 2020 2020  oo_event'):.    
+00003c90: 2020 2020 2020 2020 2320 6e6f 6e6c 6561          # nonlea
+00003ca0: 6465 7273 2063 616e 2072 6561 640a 2020  ders can read.  
+00003cb0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00003cc0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+00003cd0: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
+00003ce0: 2020 2020 2072 656c 6174 696f 6e20 3d20       relation = 
+00003cf0: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
+00003d00: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+00003d10: 2764 6232 2729 0a20 2020 2020 2020 2020  'db2').         
+00003d20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003d30: 7561 6c28 7265 6c61 7469 6f6e 2e64 6174  ual(relation.dat
+00003d40: 615b 7265 6c61 7469 6f6e 2e61 7070 5d5b  a[relation.app][
+00003d50: 2766 6f6f 275d 2c20 2762 6172 2729 0a0a  'foo'], 'bar')..
+00003d60: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00003d70: 6174 696f 6e5f 6461 7461 5f64 656c 5f6b  ation_data_del_k
+00003d80: 6579 2873 656c 6629 3a0a 2020 2020 2020  ey(self):.      
+00003d90: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
+00003da0: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00003db0: 5f72 656c 6174 696f 6e28 2764 6231 272c  _relation('db1',
+00003dc0: 2027 7265 6d6f 7465 6170 7031 2729 0a20   'remoteapp1'). 
+00003dd0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00003de0: 2e68 6172 6e65 7373 2e5f 6576 656e 745f  .harness._event_
+00003df0: 636f 6e74 6578 7428 2766 6f6f 5f65 7665  context('foo_eve
+00003e00: 6e74 2729 3a0a 2020 2020 2020 2020 2020  nt'):.          
+00003e10: 2020 7365 6c66 2e68 6172 6e65 7373 2e75    self.harness.u
+00003e20: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00003e30: 6174 6128 7265 6c61 7469 6f6e 5f69 642c  ata(relation_id,
+00003e40: 2027 6d79 6170 702f 3027 2c20 7b27 686f   'myapp/0', {'ho
+00003e50: 7374 273a 2027 6261 7227 7d29 0a20 2020  st': 'bar'}).   
+00003e60: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00003e70: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00003e80: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+00003e90: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
+00003ea0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00003eb0: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00003ec0: 290a 0a20 2020 2020 2020 2072 656c 5f64  )..        rel_d
+00003ed0: 6231 203d 2073 656c 662e 6d6f 6465 6c2e  b1 = self.model.
+00003ee0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00003ef0: 3127 290a 2020 2020 2020 2020 2320 466f  1').        # Fo
+00003f00: 7263 6520 6d65 6d6f 7279 2063 6163 6865  rce memory cache
+00003f10: 2074 6f20 6265 206c 6f61 6465 642e 0a20   to be loaded.. 
+00003f20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00003f30: 7274 496e 2827 686f 7374 272c 2072 656c  rtIn('host', rel
+00003f40: 5f64 6231 2e64 6174 615b 7365 6c66 2e6d  _db1.data[self.m
+00003f50: 6f64 656c 2e75 6e69 745d 290a 2020 2020  odel.unit]).    
+00003f60: 2020 2020 6465 6c20 7265 6c5f 6462 312e      del rel_db1.
+00003f70: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
+00003f80: 756e 6974 5d5b 2768 6f73 7427 5d0a 2020  unit]['host'].  
+00003f90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00003fa0: 744e 6f74 496e 2827 686f 7374 272c 2072  tNotIn('host', r
+00003fb0: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
+00003fc0: 2e6d 6f64 656c 2e75 6e69 745d 290a 2020  .model.unit]).  
+00003fd0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00003fe0: 7445 7175 616c 287b 7d2c 2073 656c 662e  tEqual({}, self.
+00003ff0: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+00004000: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
+00004010: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
+00004020: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+00004030: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00004040: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+00004050: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+00004060: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+00004070: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00004080: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00004090: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+000040a0: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+000040b0: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+000040c0: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+000040d0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000040e0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+000040f0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+00004100: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+00004110: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+00004120: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+00004130: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00004140: 6174 696f 6e5f 6461 7461 5f64 656c 5f6d  ation_data_del_m
+00004150: 6973 7369 6e67 5f6b 6579 2873 656c 6629  issing_key(self)
+00004160: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
+00004170: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
+00004180: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00004190: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+000041a0: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
+000041b0: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+000041c0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+000041d0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+000041e0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+000041f0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00004200: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+00004210: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
+00004220: 3027 2c20 7b27 686f 7374 273a 2027 6261  0', {'host': 'ba
+00004230: 7227 7d29 0a20 2020 2020 2020 2073 656c  r'}).        sel
+00004240: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00004250: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
+00004260: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+00004270: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
+00004280: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
+00004290: 6e64 4361 6c6c 7328 290a 0a20 2020 2020  ndCalls()..     
+000042a0: 2020 2072 656c 5f64 6231 203d 2073 656c     rel_db1 = sel
+000042b0: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+000042c0: 7469 6f6e 2827 6462 3127 290a 2020 2020  tion('db1').    
+000042d0: 2020 2020 2320 466f 7263 6520 6d65 6d6f      # Force memo
+000042e0: 7279 2063 6163 6865 2074 6f20 6265 206c  ry cache to be l
+000042f0: 6f61 6465 642e 0a20 2020 2020 2020 2073  oaded..        s
+00004300: 656c 662e 6173 7365 7274 496e 2827 686f  elf.assertIn('ho
+00004310: 7374 272c 2072 656c 5f64 6231 2e64 6174  st', rel_db1.dat
+00004320: 615b 7365 6c66 2e6d 6f64 656c 2e75 6e69  a[self.model.uni
+00004330: 745d 290a 2020 2020 2020 2020 7769 7468  t]).        with
+00004340: 2073 656c 662e 6861 726e 6573 732e 5f65   self.harness._e
+00004350: 7665 6e74 5f63 6f6e 7465 7874 2827 666f  vent_context('fo
+00004360: 6f5f 6576 656e 7427 293a 0a20 2020 2020  o_event'):.     
+00004370: 2020 2020 2020 2072 656c 5f64 6231 2e64         rel_db1.d
+00004380: 6174 615b 7365 6c66 2e6d 6f64 656c 2e75  ata[self.model.u
+00004390: 6e69 745d 5b27 706f 7274 275d 203d 2027  nit]['port'] = '
+000043a0: 2720 2020 2320 5361 6d65 2061 7320 6120  '   # Same as a 
+000043b0: 6465 6c65 7465 2c20 7368 6f75 6c64 206e  delete, should n
+000043c0: 6f74 2066 6169 6c2e 0a20 2020 2020 2020  ot fail..       
+000043d0: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
+000043e0: 6e28 2770 6f72 7427 2c20 7265 6c5f 6462  n('port', rel_db
+000043f0: 312e 6461 7461 5b73 656c 662e 6d6f 6465  1.data[self.mode
+00004400: 6c2e 756e 6974 5d29 0a20 2020 2020 2020  l.unit]).       
+00004410: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
+00004420: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
+00004430: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
+00004440: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00004450: 2e61 7373 6572 7445 7175 616c 287b 2768  .assertEqual({'h
+00004460: 6f73 7427 3a20 2762 6172 277d 2c0a 2020  ost': 'bar'},.  
+00004470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00004490: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+000044a0: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
+000044b0: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
+000044c0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+000044d0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+000044e0: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+000044f0: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+00004500: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+00004510: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00004520: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00004530: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+00004540: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00004550: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+00004560: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+00004570: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00004580: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+00004590: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+000045a0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+000045b0: 2e75 6e69 742c 2027 706f 7274 272c 2027  .unit, 'port', '
+000045c0: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+000045d0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+000045e0: 6174 696f 6e5f 7365 745f 6661 696c 2873  ation_set_fail(s
+000045f0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00004600: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
+00004610: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+00004620: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
+00004630: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+00004640: 2020 2077 6974 6820 7365 6c66 2e68 6172     with self.har
+00004650: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
+00004660: 6578 7428 2766 6f6f 5f65 7665 6e74 2729  ext('foo_event')
+00004670: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00004680: 6c66 2e68 6172 6e65 7373 2e75 7064 6174  lf.harness.updat
+00004690: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+000046a0: 7265 6c61 7469 6f6e 5f69 642c 2027 6d79  relation_id, 'my
+000046b0: 6170 702f 3027 2c20 7b27 686f 7374 273a  app/0', {'host':
+000046c0: 2027 6d79 6170 702d 3027 7d29 0a20 2020   'myapp-0'}).   
+000046d0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+000046e0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+000046f0: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+00004700: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
+00004710: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00004720: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00004730: 290a 0a20 2020 2020 2020 2062 6163 6b65  )..        backe
+00004740: 6e64 203d 2073 656c 662e 6861 726e 6573  nd = self.harnes
+00004750: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
+00004760: 2020 2023 2054 4f44 4f3a 206a 616d 2032     # TODO: jam 2
+00004770: 3032 302d 3033 2d30 3620 5468 6973 2069  020-03-06 This i
+00004780: 7320 7761 7920 746f 6f20 6d75 6368 2069  s way too much i
+00004790: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+000047a0: 2072 656c 6174 696f 6e5f 7365 740a 2020   relation_set.  
+000047b0: 2020 2020 2020 2320 2020 2020 2020 5468        #       Th
+000047c0: 6520 6f72 6967 696e 616c 2074 6573 7420  e original test 
+000047d0: 666f 7263 6564 2027 7265 6c61 7469 6f6e  forced 'relation
+000047e0: 2d73 6574 2720 746f 2072 6574 7572 6e20  -set' to return 
+000047f0: 6578 6974 2063 6f64 6520 322c 0a20 2020  exit code 2,.   
+00004800: 2020 2020 2023 2020 2020 2020 2062 7574       #       but
+00004810: 2074 6865 7265 2077 6173 206e 6f74 6869   there was nothi
+00004820: 6e67 2069 6c6c 6567 616c 2061 626f 7574  ng illegal about
+00004830: 2074 6865 2064 6174 6120 7468 6174 2077   the data that w
+00004840: 6173 2062 6569 6e67 2073 6574 2c0a 2020  as being set,.  
+00004850: 2020 2020 2020 2320 2020 2020 2020 666f        #       fo
+00004860: 7220 7573 2074 6f20 7072 6f70 6572 6c79  r us to properly
+00004870: 2074 6573 7420 7468 6520 7369 6465 2065   test the side e
+00004880: 6666 6563 7473 206f 6620 7265 6c61 7469  ffects of relati
+00004890: 6f6e 2d73 6574 2066 6169 6c69 6e67 2e0a  on-set failing..
+000048a0: 0a20 2020 2020 2020 2064 6566 2062 726f  .        def bro
+000048b0: 6b65 6e5f 7570 6461 7465 5f72 656c 6174  ken_update_relat
+000048c0: 696f 6e5f 6461 7461 2872 656c 6174 696f  ion_data(relatio
+000048d0: 6e5f 6964 2c20 656e 7469 7479 2c20 6b65  n_id, entity, ke
+000048e0: 792c 2076 616c 7565 293a 0a20 2020 2020  y, value):.     
+000048f0: 2020 2020 2020 2062 6163 6b65 6e64 2e5f         backend._
+00004900: 6361 6c6c 732e 6170 7065 6e64 2828 2775  calls.append(('u
+00004910: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00004920: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
+00004930: 642c 2065 6e74 6974 792c 206b 6579 2c20  d, entity, key, 
+00004940: 7661 6c75 6529 290a 2020 2020 2020 2020  value)).        
+00004950: 2020 2020 7261 6973 6520 6f70 732e 4d6f      raise ops.Mo
+00004960: 6465 6c45 7272 6f72 2829 0a20 2020 2020  delError().     
+00004970: 2020 2062 6163 6b65 6e64 2e75 7064 6174     backend.updat
+00004980: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
+00004990: 3d20 6272 6f6b 656e 5f75 7064 6174 655f  = broken_update_
+000049a0: 7265 6c61 7469 6f6e 5f64 6174 610a 0a20  relation_data.. 
+000049b0: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
+000049c0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+000049d0: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
+000049e0: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
+000049f0: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
+00004a00: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
+00004a10: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
+00004a20: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
+00004a30: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
+00004a40: 2e75 6e69 745d 290a 0a20 2020 2020 2020  .unit])..       
+00004a50: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
+00004a60: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
+00004a70: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
+00004a80: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00004a90: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00004aa0: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00004ab0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00004ac0: 2020 2020 7265 6c5f 6462 312e 6461 7461      rel_db1.data
+00004ad0: 5b73 656c 662e 6d6f 6465 6c2e 756e 6974  [self.model.unit
+00004ae0: 5d5b 2768 6f73 7427 5d20 3d20 2762 6172  ]['host'] = 'bar
+00004af0: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
+00004b00: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00004b10: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
+00004b20: 2e6d 6f64 656c 2e75 6e69 745d 5b27 686f  .model.unit]['ho
+00004b30: 7374 275d 2c20 276d 7961 7070 2d30 2729  st'], 'myapp-0')
+00004b40: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00004b50: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00004b60: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+00004b70: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00004b80: 2020 2020 2064 656c 2072 656c 5f64 6231       del rel_db1
+00004b90: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
+00004ba0: 2e75 6e69 745d 5b27 686f 7374 275d 0a20  .unit]['host']. 
+00004bb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00004bc0: 6173 7365 7274 496e 2827 686f 7374 272c  assertIn('host',
+00004bd0: 2072 656c 5f64 6231 2e64 6174 615b 7365   rel_db1.data[se
+00004be0: 6c66 2e6d 6f64 656c 2e75 6e69 745d 290a  lf.model.unit]).
+00004bf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004c00: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+00004c10: 285b 0a20 2020 2020 2020 2020 2020 2028  ([.            (
+00004c20: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
+00004c30: 2764 6231 2729 2c0a 2020 2020 2020 2020  'db1'),.        
+00004c40: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
+00004c50: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
+00004c60: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00004c70: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
+00004c80: 2072 656c 6174 696f 6e5f 6964 2c20 276d   relation_id, 'm
+00004c90: 7961 7070 2f30 272c 2046 616c 7365 292c  yapp/0', False),
+00004ca0: 0a20 2020 2020 2020 2020 2020 2028 2775  .            ('u
+00004cb0: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00004cc0: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
+00004cd0: 642c 2073 656c 662e 6d6f 6465 6c2e 756e  d, self.model.un
+00004ce0: 6974 2c20 2768 6f73 7427 2c20 2762 6172  it, 'host', 'bar
+00004cf0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00004d00: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+00004d10: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+00004d20: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+00004d30: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+00004d40: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+00004d50: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00004d60: 6174 696f 6e5f 6461 7461 5f74 7970 655f  ation_data_type_
+00004d70: 6368 6563 6b28 7365 6c66 293a 0a20 2020  check(self):.   
+00004d80: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
+00004d90: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
+00004da0: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00004db0: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
+00004dc0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
+00004dd0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00004de0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+00004df0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
+00004e00: 3027 2c20 7b27 686f 7374 273a 2027 6d79  0', {'host': 'my
+00004e10: 6170 702d 3027 7d29 0a20 2020 2020 2020  app-0'}).       
+00004e20: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00004e30: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+00004e40: 7265 6c61 7469 6f6e 5f69 642c 2027 7265  relation_id, 're
+00004e50: 6d6f 7465 6170 7031 2f30 2729 0a20 2020  moteapp1/0').   
+00004e60: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
+00004e70: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
+00004e80: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
+00004e90: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00004ea0: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
+00004eb0: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
+00004ec0: 2076 616c 7565 2069 6e20 280a 2020 2020   value in (.    
+00004ed0: 2020 2020 2020 2020 2020 2020 2827 666f              ('fo
+00004ee0: 6f27 2c20 3129 2c0a 2020 2020 2020 2020  o', 1),.        
+00004ef0: 2020 2020 2020 2020 2827 666f 6f27 2c20          ('foo', 
+00004f00: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+00004f10: 2020 2020 2020 2028 2766 6f6f 272c 207b         ('foo', {
+00004f20: 2766 6f6f 273a 2027 6261 7227 7d29 2c0a  'foo': 'bar'}),.
+00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f40: 2831 2c20 2766 6f6f 2729 2c0a 2020 2020  (1, 'foo'),.    
+00004f50: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
+00004f60: 652c 2027 666f 6f27 292c 0a20 2020 2020  e, 'foo'),.     
+00004f70: 2020 2020 2020 2020 2020 2028 2827 666f             (('fo
+00004f80: 6f27 2c20 2762 6172 2729 2c20 2766 6f6f  o', 'bar'), 'foo
+00004f90: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00004fa0: 2020 2020 2831 2c20 3129 2c0a 2020 2020      (1, 1),.    
+00004fb0: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
+00004fc0: 652c 204e 6f6e 6529 0a20 2020 2020 2020  e, None).       
+00004fd0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00004fe0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00004ff0: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00005000: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
+00005010: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00005020: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+00005030: 2e66 7261 6d65 776f 726b 2e5f 6576 656e  .framework._even
+00005040: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+00005050: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+00005060: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+00005070: 6462 312e 6461 7461 5b73 656c 662e 6d6f  db1.data[self.mo
+00005080: 6465 6c2e 756e 6974 5d5b 6b65 795d 203d  del.unit][key] =
+00005090: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
+000050a0: 2320 4e6f 2064 6174 6120 6861 7320 6163  # No data has ac
+000050b0: 7475 616c 6c79 2062 6565 6e20 6368 616e  tually been chan
+000050c0: 6765 640a 2020 2020 2020 2020 7365 6c66  ged.        self
+000050d0: 2e61 7373 6572 7445 7175 616c 2864 6963  .assertEqual(dic
+000050e0: 7428 7265 6c5f 6462 312e 6461 7461 5b73  t(rel_db1.data[s
+000050f0: 656c 662e 6d6f 6465 6c2e 756e 6974 5d29  elf.model.unit])
+00005100: 2c20 7b27 686f 7374 273a 2027 6d79 6170  , {'host': 'myap
+00005110: 702d 3027 7d29 0a0a 2020 2020 2020 2020  p-0'})..        
+00005120: 7365 6c66 2e61 7373 6572 7442 6163 6b65  self.assertBacke
+00005130: 6e64 4361 6c6c 7328 5b0a 2020 2020 2020  ndCalls([.      
+00005140: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+00005150: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
+00005160: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+00005170: 6174 696f 6e5f 6c69 7374 272c 2072 656c  ation_list', rel
+00005180: 6174 696f 6e5f 6964 292c 0a20 2020 2020  ation_id),.     
+00005190: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+000051a0: 6e5f 6765 7427 2c20 7265 6c61 7469 6f6e  n_get', relation
+000051b0: 5f69 642c 2027 6d79 6170 702f 3027 2c20  _id, 'myapp/0', 
+000051c0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000051d0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+000051e0: 5f72 656c 6174 696f 6e5f 6c6f 6361 6c5f  _relation_local_
+000051f0: 6170 705f 6461 7461 5f72 6561 6461 6269  app_data_readabi
+00005200: 6c69 7479 5f6c 6561 6465 7228 7365 6c66  lity_leader(self
+00005210: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+00005220: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+00005230: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005240: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00005250: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
+00005260: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
+00005270: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00005280: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
+00005290: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
+000052a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052c0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
+000052d0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
+000052e0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000052f0: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
+00005300: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
+00005310: 6174 696f 6e5f 6964 2c20 276d 7961 7070  ation_id, 'myapp
+00005320: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00005330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005340: 2020 2020 2020 2020 2020 2020 207b 276c               {'l
+00005350: 6f63 616c 273a 2027 6461 7461 277d 290a  ocal': 'data'}).
+00005360: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+00005370: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005380: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+00005390: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+000053a0: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+000053b0: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+000053c0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000053d0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+000053e0: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
+000053f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005410: 2020 2020 2020 7b27 686f 7374 273a 2027        {'host': '
+00005420: 7265 6d6f 7465 6170 7031 2f30 277d 290a  remoteapp1/0'}).
+00005430: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
+00005440: 656c 2e72 656c 6174 696f 6e73 2e5f 696e  el.relations._in
+00005450: 7661 6c69 6461 7465 2827 6462 3127 290a  validate('db1').
+00005460: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00005470: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00005480: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
+00005490: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
+000054a0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+000054b0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000054c0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+000054d0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+000054e0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+000054f0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+00005500: 6c66 2e72 6573 6574 4261 636b 656e 6443  lf.resetBackendC
+00005510: 616c 6c73 2829 0a0a 2020 2020 2020 2020  alls()..        
+00005520: 6c6f 6361 6c5f 6170 7020 3d20 7365 6c66  local_app = self
+00005530: 2e68 6172 6e65 7373 2e63 6861 726d 2e61  .harness.charm.a
+00005540: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
+00005550: 7265 7365 7442 6163 6b65 6e64 4361 6c6c  resetBackendCall
+00005560: 7328 290a 0a20 2020 2020 2020 2023 2061  s()..        # a
+00005570: 6464 7265 7373 696e 6720 7468 6520 6f62  ddressing the ob
+00005580: 6a65 6374 2069 7320 4f4b 0a20 2020 2020  ject is OK.     
+00005590: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
+000055a0: 6c6f 6361 6c5f 6170 705d 0a0a 2020 2020  local_app]..    
+000055b0: 2020 2020 7365 6c66 2e61 7373 6572 7442      self.assertB
+000055c0: 6163 6b65 6e64 4361 6c6c 7328 5b5d 290a  ackendCalls([]).
+000055d0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+000055e0: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
+000055f0: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+00005600: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+00005610: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
+00005620: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
+00005630: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00005640: 7373 6572 7445 7175 616c 2872 656c 5f64  ssertEqual(rel_d
+00005650: 6231 2e64 6174 615b 6c6f 6361 6c5f 6170  b1.data[local_ap
+00005660: 705d 5b27 6c6f 6361 6c27 5d2c 2027 6461  p]['local'], 'da
+00005670: 7461 2729 0a0a 2020 2020 2020 2020 2020  ta')..          
+00005680: 2020 7365 6c66 2e61 7373 6572 7442 6163    self.assertBac
+00005690: 6b65 6e64 4361 6c6c 7328 5b28 2769 735f  kendCalls([('is_
+000056a0: 6c65 6164 6572 272c 292c 0a20 2020 2020  leader',),.     
+000056b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056d0: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
+000056e0: 2031 2c20 276d 7961 7070 272c 2054 7275   1, 'myapp', Tru
+000056f0: 6529 5d29 0a0a 2020 2020 2020 2020 2020  e)])..          
+00005700: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
+00005710: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
+00005720: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005730: 6572 7445 7175 616c 2872 6570 7228 7265  ertEqual(repr(re
+00005740: 6c5f 6462 312e 6461 7461 5b6c 6f63 616c  l_db1.data[local
+00005750: 5f61 7070 5d29 2c20 7265 7072 287b 276c  _app]), repr({'l
+00005760: 6f63 616c 273a 2027 6461 7461 277d 2929  ocal': 'data'}))
+00005770: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00005780: 7765 2064 6f6e 2774 2067 6574 2074 6865  we don't get the
+00005790: 2064 6174 612c 2062 6563 6175 7365 2077   data, because w
+000057a0: 6527 7265 206c 617a 790a 2020 2020 2020  e're lazy.      
+000057b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000057c0: 7442 6163 6b65 6e64 4361 6c6c 7328 5b28  tBackendCalls([(
+000057d0: 2769 735f 6c65 6164 6572 272c 295d 290a  'is_leader',)]).
+000057e0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000057f0: 7320 7765 6c6c 2061 7320 7265 6c61 7469  s well as relati
+00005800: 6f6e 2064 6174 6120 7265 7072 2829 2069  on data repr() i
+00005810: 6e20 6765 6e65 7261 6c3a 0a20 2020 2020  n general:.     
+00005820: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00005830: 7274 4973 496e 7374 616e 6365 2872 6570  rtIsInstance(rep
+00005840: 7228 7265 6c5f 6462 312e 6461 7461 292c  r(rel_db1.data),
+00005850: 2073 7472 290a 0a20 2020 2064 6566 2074   str)..    def t
+00005860: 6573 745f 7265 6c61 7469 6f6e 5f6c 6f63  est_relation_loc
+00005870: 616c 5f61 7070 5f64 6174 615f 7265 6164  al_app_data_read
+00005880: 6162 696c 6974 795f 666f 6c6c 6f77 6572  ability_follower
+00005890: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000058a0: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
+000058b0: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+000058c0: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
+000058d0: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
+000058e0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+000058f0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+00005900: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+00005910: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00005920: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
+00005930: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00005940: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
+00005950: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
+00005960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005980: 2020 2020 2020 2020 2020 207b 2773 6563             {'sec
+00005990: 7265 7427 3a20 2763 6166 6564 6561 6462  ret': 'cafedeadb
+000059a0: 6565 6627 7d29 0a20 2020 2020 2020 2020  eef'}).         
+000059b0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+000059c0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+000059d0: 6461 7461 2872 656c 6174 696f 6e5f 6964  data(relation_id
+000059e0: 2c20 276d 7961 7070 272c 0a20 2020 2020  , 'myapp',.     
+000059f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a10: 2020 2020 2020 2020 207b 276c 6f63 616c           {'local
+00005a20: 273a 2027 6461 7461 277d 290a 0a20 2020  ': 'data'})..   
+00005a30: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00005a40: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005a50: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+00005a60: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+00005a70: 2f30 2729 0a20 2020 2020 2020 2020 2020  /0').           
+00005a80: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00005a90: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00005aa0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00005ab0: 2772 656d 6f74 6561 7070 312f 3027 2c0a  'remoteapp1/0',.
+00005ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ae0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00005af0: 686f 7374 273a 2027 7265 6d6f 7465 6170  host': 'remoteap
+00005b00: 7031 2f30 277d 290a 2020 2020 2020 2020  p1/0'}).        
+00005b10: 7365 6c66 2e6d 6f64 656c 2e72 656c 6174  self.model.relat
+00005b20: 696f 6e73 2e5f 696e 7661 6c69 6461 7465  ions._invalidate
+00005b30: 2827 6462 3127 290a 2020 2020 2020 2020  ('db1').        
+00005b40: 7365 6c66 2e72 6573 6574 4261 636b 656e  self.resetBacken
+00005b50: 6443 616c 6c73 2829 0a0a 2020 2020 2020  dCalls()..      
+00005b60: 2020 7265 6c5f 6462 3120 3d20 7365 6c66    rel_db1 = self
+00005b70: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+00005b80: 696f 6e28 2764 6231 2729 0a20 2020 2020  ion('db1').     
+00005b90: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00005ba0: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00005bb0: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
+00005bc0: 5f6c 6561 6465 7228 4661 6c73 6529 0a0a  _leader(False)..
+00005bd0: 2020 2020 2020 2020 6c6f 6361 6c5f 6170          local_ap
+00005be0: 7020 3d20 7365 6c66 2e68 6172 6e65 7373  p = self.harness
+00005bf0: 2e63 6861 726d 2e61 7070 0a20 2020 2020  .charm.app.     
+00005c00: 2020 2023 2061 6464 7265 7373 696e 6720     # addressing 
+00005c10: 7468 6520 6f62 6a65 6374 2069 7320 4f4b  the object is OK
+00005c20: 0a20 2020 2020 2020 2072 656c 5f64 6231  .        rel_db1
+00005c30: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
+00005c40: 0a20 2020 2020 2020 2023 206e 6f6e 6c65  .        # nonle
+00005c50: 6164 6572 2075 6e69 7473 2063 616e 6e6f  ader units canno
+00005c60: 7420 7265 6164 2074 6865 6972 206c 6f63  t read their loc
+00005c70: 616c 2061 7070 2064 6174 6162 6167 0a20  al app databag. 
+00005c80: 2020 2020 2020 2023 2061 7474 656d 7074         # attempt
+00005c90: 696e 6720 746f 2072 6561 6420 6974 2069  ing to read it i
+00005ca0: 7320 6e6f 740a 2020 2020 2020 2020 7769  s not.        wi
+00005cb0: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00005cc0: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00005cd0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00005ce0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00005cf0: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00005d00: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+00005d10: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00005d20: 6169 7365 7328 6f70 732e 5265 6c61 7469  aises(ops.Relati
+00005d30: 6f6e 4461 7461 4572 726f 7229 3a0a 2020  onDataError):.  
+00005d40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00005d50: 276c 6f63 616c 2720 6973 2074 6865 7265  'local' is there
+00005d60: 2c20 6275 7420 7374 696c 6c3a 0a20 2020  , but still:.   
+00005d70: 2020 2020 2020 2020 2020 2020 2072 656c               rel
+00005d80: 5f64 6231 2e64 6174 615b 6c6f 6361 6c5f  _db1.data[local_
+00005d90: 6170 705d 5b27 6c6f 6361 6c27 5d0a 0a20  app]['local'].. 
+00005da0: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
+00005db0: 6469 646e 2774 2065 7665 6e20 6765 7420  didn't even get 
+00005dc0: 746f 2072 656c 6174 696f 6e2d 6765 740a  to relation-get.
+00005dd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005de0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00005df0: 6c6c 7328 5b28 2769 735f 6c65 6164 6572  lls([('is_leader
+00005e00: 272c 2029 5d29 0a0a 2020 2020 2020 2020  ', )])..        
+00005e10: 2020 2020 2320 7765 2063 616e 2774 2073      # we can't s
+00005e20: 6565 2069 7420 6275 7420 7265 7072 2829  ee it but repr()
+00005e30: 2077 6f72 6b73 0a20 2020 2020 2020 2020   works.         
+00005e40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00005e50: 7561 6c28 7265 7072 2872 656c 5f64 6231  ual(repr(rel_db1
+00005e60: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
+00005e70: 292c 2027 3c6e 2f61 3e27 290a 2020 2020  ), '<n/a>').    
+00005e80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005e90: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
+00005ea0: 5b28 2769 735f 6c65 6164 6572 272c 2029  [('is_leader', )
+00005eb0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00005ec0: 2320 6173 2077 656c 6c20 6173 2072 656c  # as well as rel
+00005ed0: 6174 696f 6e20 6461 7461 2072 6570 7228  ation data repr(
+00005ee0: 2920 696e 2067 656e 6572 616c 3a0a 2020  ) in general:.  
+00005ef0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00005f00: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+00005f10: 7265 7072 2872 656c 5f64 6231 2e64 6174  repr(rel_db1.dat
+00005f20: 6129 2c20 7374 7229 0a0a 2020 2020 2020  a), str)..      
+00005f30: 2020 2020 2020 6578 7065 6374 6564 5f62        expected_b
+00005f40: 6163 6b65 6e64 5f63 616c 6c73 203d 205b  ackend_calls = [
+00005f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005f60: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
+00005f70: 2c20 312c 2027 6d79 6170 702f 3027 2c20  , 1, 'myapp/0', 
+00005f80: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+00005f90: 2020 2020 2020 2020 2827 6973 5f6c 6561          ('is_lea
+00005fa0: 6465 7227 2c29 2c0a 2020 2020 2020 2020  der',),.        
+00005fb0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+00005fc0: 6f6e 5f67 6574 272c 2031 2c20 2772 656d  on_get', 1, 'rem
+00005fd0: 6f74 6561 7070 312f 3027 2c20 4661 6c73  oteapp1/0', Fals
+00005fe0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00005ff0: 2020 2020 2827 6973 5f6c 6561 6465 7227      ('is_leader'
+00006000: 2c29 2c0a 2020 2020 2020 2020 2020 2020  ,),.            
+00006010: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
+00006020: 6574 272c 2031 2c20 2772 656d 6f74 6561  et', 1, 'remotea
+00006030: 7070 3127 2c20 5472 7565 295d 0a20 2020  pp1', True)].   
+00006040: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00006050: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+00006060: 2865 7870 6563 7465 645f 6261 636b 656e  (expected_backen
+00006070: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
+00006080: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+00006090: 6e6f 5f75 6e69 7473 2873 656c 6629 3a0a  no_units(self):.
+000060a0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+000060b0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+000060c0: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+000060d0: 6170 7031 2729 0a20 2020 2020 2020 2072  app1').        r
+000060e0: 656c 203d 2073 656c 662e 6d6f 6465 6c2e  el = self.model.
+000060f0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00006100: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+00006110: 2e61 7373 6572 7445 7175 616c 2872 656c  .assertEqual(rel
+00006120: 2e75 6e69 7473 2c20 7365 7428 2929 0a20  .units, set()). 
+00006130: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006140: 7274 4973 2872 656c 2e61 7070 2c20 7365  rtIs(rel.app, se
+00006150: 6c66 2e6d 6f64 656c 2e67 6574 5f61 7070  lf.model.get_app
+00006160: 2827 7265 6d6f 7465 6170 7031 2729 290a  ('remoteapp1')).
+00006170: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00006180: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
+00006190: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+000061a0: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
+000061b0: 6462 3127 292c 0a20 2020 2020 2020 2020  db1'),.         
+000061c0: 2020 2028 2772 656c 6174 696f 6e5f 6c69     ('relation_li
+000061d0: 7374 272c 2031 292c 0a20 2020 2020 2020  st', 1),.       
+000061e0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+000061f0: 7265 6d6f 7465 5f61 7070 5f6e 616d 6527  remote_app_name'
+00006200: 2c20 3129 2c0a 2020 2020 2020 2020 5d29  , 1),.        ])
+00006210: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+00006220: 6f6e 6669 6728 7365 6c66 293a 0a20 2020  onfig(self):.   
+00006230: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00006240: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
+00006250: 616c 6c73 2872 6573 6574 3d54 7275 6529  alls(reset=True)
+00006260: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+00006270: 726e 6573 732e 7570 6461 7465 5f63 6f6e  rness.update_con
+00006280: 6669 6728 7b27 666f 6f27 3a20 2766 6f6f  fig({'foo': 'foo
+00006290: 272c 2027 6261 7227 3a20 312c 2027 7175  ', 'bar': 1, 'qu
+000062a0: 7827 3a20 5472 7565 7d29 0a20 2020 2020  x': True}).     
+000062b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000062c0: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e63  ual(self.model.c
+000062d0: 6f6e 6669 672c 207b 0a20 2020 2020 2020  onfig, {.       
+000062e0: 2020 2020 2027 666f 6f27 3a20 2766 6f6f       'foo': 'foo
+000062f0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00006300: 6261 7227 3a20 312c 0a20 2020 2020 2020  bar': 1,.       
+00006310: 2020 2020 2027 7175 7827 3a20 5472 7565       'qux': True
+00006320: 2c0a 2020 2020 2020 2020 7d29 0a20 2020  ,.        }).   
+00006330: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00006340: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+00006350: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00006360: 2020 2020 2320 436f 6e66 6972 6d20 7468      # Confirm th
+00006370: 6174 2077 6520 6361 6e6e 6f74 206d 6f64  at we cannot mod
+00006380: 6966 7920 636f 6e66 6967 2076 616c 7565  ify config value
+00006390: 732e 0a20 2020 2020 2020 2020 2020 2073  s..            s
+000063a0: 656c 662e 6d6f 6465 6c2e 636f 6e66 6967  elf.model.config
+000063b0: 5b27 666f 6f27 5d20 3d20 2762 6172 270a  ['foo'] = 'bar'.
+000063c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000063d0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+000063e0: 285b 2827 636f 6e66 6967 5f67 6574 272c  ([('config_get',
+000063f0: 295d 290a 0a20 2020 2064 6566 2074 6573  )])..    def tes
+00006400: 745f 636f 6e66 6967 5f69 6d6d 7574 6162  t_config_immutab
+00006410: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
+00006420: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00006430: 7274 5261 6973 6573 2841 7474 7269 6275  rtRaises(Attribu
+00006440: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
+00006450: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00006460: 2e63 6f6e 6669 6720 3d20 7b7d 0a0a 2020  .config = {}..  
+00006470: 2020 6465 6620 7465 7374 5f69 735f 6c65    def test_is_le
+00006480: 6164 6572 2873 656c 6629 3a0a 2020 2020  ader(self):.    
+00006490: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
+000064a0: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+000064b0: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
+000064c0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
+000064d0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+000064e0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+000064f0: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+00006500: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+00006510: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+00006520: 662e 6861 726e 6573 732e 7365 745f 6c65  f.harness.set_le
+00006530: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
+00006540: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00006550: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00006560: 2020 2020 2064 6566 2063 6865 636b 5f72       def check_r
+00006570: 656d 6f74 655f 756e 6974 7328 293a 0a20  emote_units():. 
+00006580: 2020 2020 2020 2020 2020 2023 2043 616e             # Can
+00006590: 6e6f 7420 6465 7465 726d 696e 6520 6c65  not determine le
+000065a0: 6164 6572 7368 6970 2066 6f72 2072 656d  adership for rem
+000065b0: 6f74 6520 756e 6974 732e 0a20 2020 2020  ote units..     
+000065c0: 2020 2020 2020 2066 6f72 2075 2069 6e20         for u in 
+000065d0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+000065e0: 656c 6174 696f 6e28 2764 6231 2729 2e75  elation('db1').u
+000065f0: 6e69 7473 3a0a 2020 2020 2020 2020 2020  nits:.          
+00006600: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00006610: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+00006620: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006640: 752e 6973 5f6c 6561 6465 7228 290a 0a20  u.is_leader().. 
+00006650: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006660: 7274 5472 7565 2873 656c 662e 6d6f 6465  rtTrue(self.mode
+00006670: 6c2e 756e 6974 2e69 735f 6c65 6164 6572  l.unit.is_leader
+00006680: 2829 290a 0a20 2020 2020 2020 2063 6865  ())..        che
+00006690: 636b 5f72 656d 6f74 655f 756e 6974 7328  ck_remote_units(
+000066a0: 290a 0a20 2020 2020 2020 2023 2043 7265  )..        # Cre
+000066b0: 6174 6520 6120 6e65 7720 6d6f 6465 6c20  ate a new model 
+000066c0: 616e 6420 6261 636b 656e 6420 746f 2064  and backend to d
+000066d0: 726f 7020 6120 6361 6368 6564 2069 732d  rop a cached is-
+000066e0: 6c65 6164 6572 206f 7574 7075 742e 0a20  leader output.. 
+000066f0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+00006700: 6573 732e 7365 745f 6c65 6164 6572 2846  ess.set_leader(F
+00006710: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
+00006720: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
+00006730: 656c 662e 6d6f 6465 6c2e 756e 6974 2e69  elf.model.unit.i
+00006740: 735f 6c65 6164 6572 2829 290a 0a20 2020  s_leader())..   
+00006750: 2020 2020 2063 6865 636b 5f72 656d 6f74       check_remot
+00006760: 655f 756e 6974 7328 290a 0a20 2020 2020  e_units()..     
+00006770: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+00006780: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+00006790: 2020 2020 2020 2020 2028 2769 735f 6c65           ('is_le
+000067a0: 6164 6572 272c 292c 0a20 2020 2020 2020  ader',),.       
+000067b0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+000067c0: 6964 7327 2c20 2764 6231 2729 2c0a 2020  ids', 'db1'),.  
+000067d0: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
+000067e0: 7469 6f6e 5f6c 6973 7427 2c20 7265 6c61  tion_list', rela
+000067f0: 7469 6f6e 5f69 6429 2c0a 2020 2020 2020  tion_id),.      
+00006800: 2020 2020 2020 2827 6973 5f6c 6561 6465        ('is_leade
+00006810: 7227 2c29 2c0a 2020 2020 2020 2020 5d29  r',),.        ])
+00006820: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
+00006830: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
+00006840: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00006850: 656c 662e 6d6f 6465 6c2e 756e 6974 2e73  elf.model.unit.s
+00006860: 6574 5f77 6f72 6b6c 6f61 645f 7665 7273  et_workload_vers
+00006870: 696f 6e28 2731 2e32 2e33 2729 0a20 2020  ion('1.2.3').   
+00006880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006890: 4261 636b 656e 6443 616c 6c73 285b 0a20  BackendCalls([. 
+000068a0: 2020 2020 2020 2020 2020 2028 2761 7070             ('app
+000068b0: 6c69 6361 7469 6f6e 5f76 6572 7369 6f6e  lication_version
+000068c0: 5f73 6574 272c 2027 312e 322e 3327 292c  _set', '1.2.3'),
+000068d0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+000068e0: 2064 6566 2074 6573 745f 776f 726b 6c6f   def test_worklo
+000068f0: 6164 5f76 6572 7369 6f6e 5f69 6e76 616c  ad_version_inval
+00006900: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
+00006910: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00006920: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+00006930: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+00006940: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00006950: 6c2e 756e 6974 2e73 6574 5f77 6f72 6b6c  l.unit.set_workl
+00006960: 6f61 645f 7665 7273 696f 6e28 3529 0a20  oad_version(5). 
+00006970: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006980: 7274 4571 7561 6c28 7374 7228 636d 2e65  rtEqual(str(cm.e
+00006990: 7863 6570 7469 6f6e 292c 2022 776f 726b  xception), "work
+000069a0: 6c6f 6164 2076 6572 7369 6f6e 206d 7573  load version mus
+000069b0: 7420 6265 2061 2073 7472 2c20 6e6f 7420  t be a str, not 
+000069c0: 696e 743a 2035 2229 0a20 2020 2020 2020  int: 5").       
+000069d0: 2073 656c 662e 6173 7365 7274 4261 636b   self.assertBack
+000069e0: 656e 6443 616c 6c73 285b 5d29 0a0a 2020  endCalls([])..  
+000069f0: 2020 6465 6620 7465 7374 5f72 6573 6f75    def test_resou
+00006a00: 7263 6573 2873 656c 6629 3a0a 2020 2020  rces(self):.    
+00006a10: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00006a20: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+00006a30: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+00006a40: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+00006a50: 6e65 7373 2e6d 6f64 656c 2e72 6573 6f75  ness.model.resou
+00006a60: 7263 6573 2e66 6574 6368 2827 666f 6f27  rces.fetch('foo'
+00006a70: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00006a80: 6861 726e 6573 732e 6164 645f 7265 736f  harness.add_reso
+00006a90: 7572 6365 2827 666f 6f27 2c20 2766 6f6f  urce('foo', 'foo
+00006aa0: 2063 6f6e 7465 6e74 735c 6e27 290a 2020   contents\n').  
+00006ab0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+00006ac0: 7373 2e61 6464 5f72 6573 6f75 7263 6528  ss.add_resource(
+00006ad0: 2762 6172 272c 2027 2729 0a0a 2020 2020  'bar', '')..    
+00006ae0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00006af0: 7365 7274 5261 6973 6573 284e 616d 6545  sertRaises(NameE
+00006b00: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00006b10: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00006b20: 6d6f 6465 6c2e 7265 736f 7572 6365 732e  model.resources.
+00006b30: 6665 7463 6828 2771 7578 2729 0a0a 2020  fetch('qux')..  
+00006b40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006b50: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
+00006b60: 6573 732e 6d6f 6465 6c2e 7265 736f 7572  ess.model.resour
+00006b70: 6365 732e 6665 7463 6828 2766 6f6f 2729  ces.fetch('foo')
+00006b80: 2e6e 616d 652c 2027 666f 6f2e 7478 7427  .name, 'foo.txt'
+00006b90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006ba0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00006bb0: 6861 726e 6573 732e 6d6f 6465 6c2e 7265  harness.model.re
+00006bc0: 736f 7572 6365 732e 6665 7463 6828 2762  sources.fetch('b
+00006bd0: 6172 2729 2e6e 616d 652c 2027 6261 722e  ar').name, 'bar.
+00006be0: 7478 7427 290a 0a20 2020 2064 6566 2074  txt')..    def t
+00006bf0: 6573 745f 7265 736f 7572 6365 735f 696d  est_resources_im
+00006c00: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+00006c10: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00006c20: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00006c30: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00006c40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006c50: 6d6f 6465 6c2e 7265 736f 7572 6365 7320  model.resources 
+00006c60: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
+00006c70: 6465 6620 7465 7374 5f70 6f64 5f73 7065  def test_pod_spe
+00006c80: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+00006c90: 2073 656c 662e 6861 726e 6573 732e 7365   self.harness.se
+00006ca0: 745f 6c65 6164 6572 2854 7275 6529 0a20  t_leader(True). 
+00006cb0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+00006cc0: 6573 732e 6d6f 6465 6c2e 706f 642e 7365  ess.model.pod.se
+00006cd0: 745f 7370 6563 287b 2766 6f6f 273a 2027  t_spec({'foo': '
+00006ce0: 6261 7227 7d29 0a20 2020 2020 2020 2073  bar'}).        s
+00006cf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006d00: 7365 6c66 2e68 6172 6e65 7373 2e67 6574  self.harness.get
+00006d10: 5f70 6f64 5f73 7065 6328 292c 2028 7b27  _pod_spec(), ({'
+00006d20: 666f 6f27 3a20 2762 6172 277d 2c20 4e6f  foo': 'bar'}, No
+00006d30: 6e65 2929 0a0a 2020 2020 2020 2020 7365  ne))..        se
+00006d40: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
+00006d50: 2e70 6f64 2e73 6574 5f73 7065 6328 7b27  .pod.set_spec({'
+00006d60: 6261 7227 3a20 2766 6f6f 277d 2c20 7b27  bar': 'foo'}, {'
+00006d70: 7175 7827 3a20 2762 617a 277d 290a 2020  qux': 'baz'}).  
+00006d80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006d90: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
+00006da0: 6573 732e 6765 745f 706f 645f 7370 6563  ess.get_pod_spec
+00006db0: 2829 2c20 287b 2762 6172 273a 2027 666f  (), ({'bar': 'fo
+00006dc0: 6f27 7d2c 207b 2771 7578 273a 2027 6261  o'}, {'qux': 'ba
+00006dd0: 7a27 7d29 290a 0a20 2020 2020 2020 2023  z'}))..        #
+00006de0: 206e 6f20 6c65 6164 6572 202d 3e20 6e6f   no leader -> no
+00006df0: 2073 6574 2070 6f64 2073 7065 630a 2020   set pod spec.  
+00006e00: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+00006e10: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
+00006e20: 6c73 6529 0a20 2020 2020 2020 2077 6974  lse).        wit
+00006e30: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00006e40: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+00006e50: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00006e60: 2073 656c 662e 6861 726e 6573 732e 6d6f   self.harness.mo
+00006e70: 6465 6c2e 706f 642e 7365 745f 7370 6563  del.pod.set_spec
+00006e80: 287b 2766 6f6f 273a 2027 6261 7227 7d29  ({'foo': 'bar'})
+00006e90: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+00006ea0: 6f64 5f69 6d6d 7574 6162 6c65 2873 656c  od_immutable(sel
+00006eb0: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+00006ec0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00006ed0: 6573 2841 7474 7269 6275 7465 4572 726f  es(AttributeErro
+00006ee0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00006ef0: 7365 6c66 2e6d 6f64 656c 2e70 6f64 203d  self.model.pod =
+00006f00: 206f 626a 6563 7428 290a 0a20 2020 2064   object()..    d
+00006f10: 6566 2074 6573 745f 6261 7365 5f73 7461  ef test_base_sta
+00006f20: 7475 735f 696e 7374 616e 6365 5f72 6169  tus_instance_rai
+00006f30: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
+00006f40: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00006f50: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+00006f60: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00006f70: 2020 6f70 732e 5374 6174 7573 4261 7365    ops.StatusBase
+00006f80: 2827 7465 7374 2729 0a0a 2020 2020 2020  ('test')..      
+00006f90: 2020 636c 6173 7320 4e6f 4e61 6d65 5374    class NoNameSt
+00006fa0: 6174 7573 286f 7073 2e53 7461 7475 7342  atus(ops.StatusB
+00006fb0: 6173 6529 3a0a 2020 2020 2020 2020 2020  ase):.          
+00006fc0: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+00006fd0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00006fe0: 5261 6973 6573 2841 7474 7269 6275 7465  Raises(Attribute
+00006ff0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00007000: 2020 2020 6f70 732e 5374 6174 7573 4261      ops.StatusBa
+00007010: 7365 2e72 6567 6973 7465 725f 7374 6174  se.register_stat
+00007020: 7573 284e 6f4e 616d 6553 7461 7475 7329  us(NoNameStatus)
+00007030: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00007040: 7461 7475 735f 7265 7072 2873 656c 6629  tatus_repr(self)
+00007050: 3a0a 2020 2020 2020 2020 7465 7374 5f63  :.        test_c
+00007060: 6173 6573 203d 207b 0a20 2020 2020 2020  ases = {.       
+00007070: 2020 2020 2022 4163 7469 7665 5374 6174       "ActiveStat
+00007080: 7573 2827 5365 6173 6865 6c6c 2729 223a  us('Seashell')":
+00007090: 206f 7073 2e41 6374 6976 6553 7461 7475   ops.ActiveStatu
+000070a0: 7328 2753 6561 7368 656c 6c27 292c 0a20  s('Seashell'),. 
+000070b0: 2020 2020 2020 2020 2020 2022 4d61 696e             "Main
+000070c0: 7465 6e61 6e63 6553 7461 7475 7328 2752  tenanceStatus('R
+000070d0: 6564 2729 223a 206f 7073 2e4d 6169 6e74  ed')": ops.Maint
+000070e0: 656e 616e 6365 5374 6174 7573 2827 5265  enanceStatus('Re
+000070f0: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
+00007100: 2022 426c 6f63 6b65 6453 7461 7475 7328   "BlockedStatus(
+00007110: 274d 6167 656e 7461 2729 223a 206f 7073  'Magenta')": ops
+00007120: 2e42 6c6f 636b 6564 5374 6174 7573 2827  .BlockedStatus('
+00007130: 4d61 6765 6e74 6127 292c 0a20 2020 2020  Magenta'),.     
+00007140: 2020 2020 2020 2022 5761 6974 696e 6753         "WaitingS
+00007150: 7461 7475 7328 2754 6869 7374 6c65 2729  tatus('Thistle')
+00007160: 223a 206f 7073 2e57 6169 7469 6e67 5374  ": ops.WaitingSt
+00007170: 6174 7573 2827 5468 6973 746c 6527 292c  atus('Thistle'),
+00007180: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
+00007190: 6b6e 6f77 6e53 7461 7475 7328 2927 3a20  knownStatus()': 
+000071a0: 6f70 732e 556e 6b6e 6f77 6e53 7461 7475  ops.UnknownStatu
+000071b0: 7328 292c 0a20 2020 2020 2020 207d 0a20  s(),.        }. 
+000071c0: 2020 2020 2020 2066 6f72 2065 7870 6563         for expec
+000071d0: 7465 642c 2073 7461 7475 7320 696e 2074  ted, status in t
+000071e0: 6573 745f 6361 7365 732e 6974 656d 7328  est_cases.items(
+000071f0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00007200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00007210: 7265 7072 2873 7461 7475 7329 2c20 6578  repr(status), ex
+00007220: 7065 6374 6564 290a 0a20 2020 2064 6566  pected)..    def
+00007230: 2074 6573 745f 7374 6174 7573 5f65 7128   test_status_eq(
+00007240: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00007250: 7461 7475 735f 7479 7065 7320 3d20 5b0a  tatus_types = [.
+00007260: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+00007270: 4163 7469 7665 5374 6174 7573 2c0a 2020  ActiveStatus,.  
+00007280: 2020 2020 2020 2020 2020 6f70 732e 4d61            ops.Ma
+00007290: 696e 7465 6e61 6e63 6553 7461 7475 732c  intenanceStatus,
+000072a0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+000072b0: 2e42 6c6f 636b 6564 5374 6174 7573 2c0a  .BlockedStatus,.
+000072c0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+000072d0: 5761 6974 696e 6753 7461 7475 732c 0a20  WaitingStatus,. 
+000072e0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+000072f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00007300: 616c 286f 7073 2e55 6e6b 6e6f 776e 5374  al(ops.UnknownSt
+00007310: 6174 7573 2829 2c20 6f70 732e 556e 6b6e  atus(), ops.Unkn
+00007320: 6f77 6e53 7461 7475 7328 2929 0a20 2020  ownStatus()).   
+00007330: 2020 2020 2066 6f72 2028 692c 2074 3129       for (i, t1)
+00007340: 2069 6e20 656e 756d 6572 6174 6528 7374   in enumerate(st
+00007350: 6174 7573 5f74 7970 6573 293a 0a20 2020  atus_types):.   
+00007360: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00007370: 7365 7274 4e6f 7445 7175 616c 2874 3128  sertNotEqual(t1(
+00007380: 2727 292c 206f 7073 2e55 6e6b 6e6f 776e  ''), ops.Unknown
+00007390: 5374 6174 7573 2829 290a 2020 2020 2020  Status()).      
+000073a0: 2020 2020 2020 666f 7220 286a 2c20 7432        for (j, t2
+000073b0: 2920 696e 2065 6e75 6d65 7261 7465 2873  ) in enumerate(s
+000073c0: 7461 7475 735f 7479 7065 7329 3a0a 2020  tatus_types):.  
+000073d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000073e0: 6c66 2e61 7373 6572 744e 6f74 4571 7561  lf.assertNotEqua
+000073f0: 6c28 7431 2827 6f6e 6527 292c 2074 3228  l(t1('one'), t2(
+00007400: 2774 776f 2729 290a 2020 2020 2020 2020  'two')).        
+00007410: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+00007420: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+00007430: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007440: 7274 4571 7561 6c28 7431 2827 6f6e 6527  rtEqual(t1('one'
+00007450: 292c 2074 3228 276f 6e65 2729 290a 2020  ), t2('one')).  
+00007460: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00007470: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007480: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007490: 6572 744e 6f74 4571 7561 6c28 7431 2827  ertNotEqual(t1('
+000074a0: 6f6e 6527 292c 2074 3228 276f 6e65 2729  one'), t2('one')
+000074b0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000074c0: 6163 7469 7665 5f6d 6573 7361 6765 5f64  active_message_d
+000074d0: 6566 6175 6c74 2873 656c 6629 3a0a 2020  efault(self):.  
+000074e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000074f0: 7445 7175 616c 286f 7073 2e41 6374 6976  tEqual(ops.Activ
+00007500: 6553 7461 7475 7328 292e 6d65 7373 6167  eStatus().messag
+00007510: 652c 2027 2729 0a0a 2020 2020 6465 6620  e, '')..    def 
+00007520: 7465 7374 5f6c 6f63 616c 5f73 6574 5f76  test_local_set_v
+00007530: 616c 6964 5f75 6e69 745f 7374 6174 7573  alid_unit_status
+00007540: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00007550: 7365 6c66 2e68 6172 6e65 7373 2e5f 6765  self.harness._ge
+00007560: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
+00007570: 7265 7365 743d 5472 7565 290a 2020 2020  reset=True).    
+00007580: 2020 2020 7465 7374 5f63 6173 6573 203d      test_cases =
+00007590: 205b 280a 2020 2020 2020 2020 2020 2020   [(.            
+000075a0: 2761 6374 6976 6527 2c0a 2020 2020 2020  'active',.      
+000075b0: 2020 2020 2020 6f70 732e 4163 7469 7665        ops.Active
+000075c0: 5374 6174 7573 2827 4772 6565 6e27 292c  Status('Green'),
+000075d0: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+000075e0: 7461 7475 735f 7365 7427 2c20 2761 6374  tatus_set', 'act
+000075f0: 6976 6527 2c20 2747 7265 656e 272c 207b  ive', 'Green', {
+00007600: 2769 735f 6170 7027 3a20 4661 6c73 657d  'is_app': False}
+00007610: 292c 0a20 2020 2020 2020 2029 2c20 280a  ),.        ), (.
+00007620: 2020 2020 2020 2020 2020 2020 276d 6169              'mai
+00007630: 6e74 656e 616e 6365 272c 0a20 2020 2020  ntenance',.     
+00007640: 2020 2020 2020 206f 7073 2e4d 6169 6e74         ops.Maint
+00007650: 656e 616e 6365 5374 6174 7573 2827 5965  enanceStatus('Ye
+00007660: 6c6c 6f77 2729 2c0a 2020 2020 2020 2020  llow'),.        
+00007670: 2020 2020 2827 7374 6174 7573 5f73 6574      ('status_set
+00007680: 272c 2027 6d61 696e 7465 6e61 6e63 6527  ', 'maintenance'
+00007690: 2c20 2759 656c 6c6f 7727 2c20 7b27 6973  , 'Yellow', {'is
+000076a0: 5f61 7070 273a 2046 616c 7365 7d29 2c0a  _app': False}),.
+000076b0: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
+000076c0: 2020 2020 2020 2020 2027 626c 6f63 6b65           'blocke
+000076d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+000076e0: 6f70 732e 426c 6f63 6b65 6453 7461 7475  ops.BlockedStatu
+000076f0: 7328 2752 6564 2729 2c0a 2020 2020 2020  s('Red'),.      
+00007700: 2020 2020 2020 2827 7374 6174 7573 5f73        ('status_s
+00007710: 6574 272c 2027 626c 6f63 6b65 6427 2c20  et', 'blocked', 
+00007720: 2752 6564 272c 207b 2769 735f 6170 7027  'Red', {'is_app'
+00007730: 3a20 4661 6c73 657d 292c 0a20 2020 2020  : False}),.     
+00007740: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+00007750: 2020 2020 2777 6169 7469 6e67 272c 0a20      'waiting',. 
+00007760: 2020 2020 2020 2020 2020 206f 7073 2e57             ops.W
+00007770: 6169 7469 6e67 5374 6174 7573 2827 5768  aitingStatus('Wh
+00007780: 6974 6527 292c 0a20 2020 2020 2020 2020  ite'),.         
+00007790: 2020 2028 2773 7461 7475 735f 7365 7427     ('status_set'
+000077a0: 2c20 2777 6169 7469 6e67 272c 2027 5768  , 'waiting', 'Wh
+000077b0: 6974 6527 2c20 7b27 6973 5f61 7070 273a  ite', {'is_app':
+000077c0: 2046 616c 7365 7d29 2c0a 2020 2020 2020   False}),.      
+000077d0: 2020 295d 0a0a 2020 2020 2020 2020 666f    )]..        fo
+000077e0: 7220 7465 7374 5f63 6173 652c 2074 6172  r test_case, tar
+000077f0: 6765 745f 7374 6174 7573 2c20 6261 636b  get_status, back
+00007800: 656e 645f 6361 6c6c 2069 6e20 7465 7374  end_call in test
+00007810: 5f63 6173 6573 3a0a 2020 2020 2020 2020  _cases:.        
+00007820: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
+00007830: 6254 6573 7428 7465 7374 5f63 6173 6529  bTest(test_case)
+00007840: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007850: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
+00007860: 742e 7374 6174 7573 203d 2074 6172 6765  t.status = targe
+00007870: 745f 7374 6174 7573 0a20 2020 2020 2020  t_status.       
+00007880: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00007890: 7365 7274 4571 7561 6c28 7365 6c66 2e6d  sertEqual(self.m
+000078a0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
+000078b0: 2c20 7461 7267 6574 5f73 7461 7475 7329  , target_status)
+000078c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000078d0: 2073 656c 662e 6d6f 6465 6c2e 756e 6974   self.model.unit
+000078e0: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
+000078f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00007900: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00007910: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
+00007920: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
+00007930: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
+00007940: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007950: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
+00007960: 6261 636b 656e 645f 6361 6c6c 2c20 2827  backend_call, ('
+00007970: 7374 6174 7573 5f67 6574 272c 207b 2769  status_get', {'i
+00007980: 735f 6170 7027 3a20 4661 6c73 657d 295d  s_app': False})]
+00007990: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000079a0: 6c6f 6361 6c5f 7365 745f 7661 6c69 645f  local_set_valid_
+000079b0: 6170 705f 7374 6174 7573 2873 656c 6629  app_status(self)
+000079c0: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
+000079d0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+000079e0: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
+000079f0: 7465 7374 5f63 6173 6573 203d 205b 280a  test_cases = [(.
+00007a00: 2020 2020 2020 2020 2020 2020 2761 6374              'act
+00007a10: 6976 6527 2c0a 2020 2020 2020 2020 2020  ive',.          
+00007a20: 2020 6f70 732e 4163 7469 7665 5374 6174    ops.ActiveStat
+00007a30: 7573 2827 4772 6565 6e27 292c 0a20 2020  us('Green'),.   
+00007a40: 2020 2020 2020 2020 2028 2773 7461 7475           ('statu
+00007a50: 735f 7365 7427 2c20 2761 6374 6976 6527  s_set', 'active'
+00007a60: 2c20 2747 7265 656e 272c 207b 2769 735f  , 'Green', {'is_
+00007a70: 6170 7027 3a20 5472 7565 7d29 2c0a 2020  app': True}),.  
+00007a80: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
+00007a90: 2020 2020 2020 2027 6d61 696e 7465 6e61         'maintena
+00007aa0: 6e63 6527 2c0a 2020 2020 2020 2020 2020  nce',.          
+00007ab0: 2020 6f70 732e 4d61 696e 7465 6e61 6e63    ops.Maintenanc
+00007ac0: 6553 7461 7475 7328 2759 656c 6c6f 7727  eStatus('Yellow'
+00007ad0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00007ae0: 2773 7461 7475 735f 7365 7427 2c20 276d  'status_set', 'm
+00007af0: 6169 6e74 656e 616e 6365 272c 2027 5965  aintenance', 'Ye
+00007b00: 6c6c 6f77 272c 207b 2769 735f 6170 7027  llow', {'is_app'
+00007b10: 3a20 5472 7565 7d29 2c0a 2020 2020 2020  : True}),.      
+00007b20: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
+00007b30: 2020 2027 626c 6f63 6b65 6427 2c0a 2020     'blocked',.  
+00007b40: 2020 2020 2020 2020 2020 6f70 732e 426c            ops.Bl
+00007b50: 6f63 6b65 6453 7461 7475 7328 2752 6564  ockedStatus('Red
+00007b60: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00007b70: 2827 7374 6174 7573 5f73 6574 272c 2027  ('status_set', '
+00007b80: 626c 6f63 6b65 6427 2c20 2752 6564 272c  blocked', 'Red',
+00007b90: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
+00007ba0: 7d29 2c0a 2020 2020 2020 2020 292c 2028  }),.        ), (
+00007bb0: 0a20 2020 2020 2020 2020 2020 2027 7761  .            'wa
+00007bc0: 6974 696e 6727 2c0a 2020 2020 2020 2020  iting',.        
+00007bd0: 2020 2020 6f70 732e 5761 6974 696e 6753      ops.WaitingS
+00007be0: 7461 7475 7328 2757 6869 7465 2729 2c0a  tatus('White'),.
+00007bf0: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
+00007c00: 6174 7573 5f73 6574 272c 2027 7761 6974  atus_set', 'wait
+00007c10: 696e 6727 2c20 2757 6869 7465 272c 207b  ing', 'White', {
+00007c20: 2769 735f 6170 7027 3a20 5472 7565 7d29  'is_app': True})
+00007c30: 2c0a 2020 2020 2020 2020 295d 0a0a 2020  ,.        )]..  
+00007c40: 2020 2020 2020 666f 7220 7465 7374 5f63        for test_c
+00007c50: 6173 652c 2074 6172 6765 745f 7374 6174  ase, target_stat
+00007c60: 7573 2c20 6261 636b 656e 645f 6361 6c6c  us, backend_call
+00007c70: 2069 6e20 7465 7374 5f63 6173 6573 3a0a   in test_cases:.
+00007c80: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00007c90: 2073 656c 662e 7375 6254 6573 7428 7465   self.subTest(te
+00007ca0: 7374 5f63 6173 6529 3a0a 2020 2020 2020  st_case):.      
+00007cb0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00007cc0: 6f64 656c 2e61 7070 2e73 7461 7475 7320  odel.app.status 
+00007cd0: 3d20 7461 7267 6574 5f73 7461 7475 730a  = target_status.
+00007ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cf0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00007d00: 2873 656c 662e 6d6f 6465 6c2e 6170 702e  (self.model.app.
+00007d10: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
+00007d20: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
+00007d30: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00007d40: 6c2e 6170 702e 5f69 6e76 616c 6964 6174  l.app._invalidat
+00007d50: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00007d60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007d70: 7175 616c 2873 656c 662e 6d6f 6465 6c2e  qual(self.model.
+00007d80: 6170 702e 7374 6174 7573 2c20 7461 7267  app.status, targ
+00007d90: 6574 5f73 7461 7475 7329 0a20 2020 2020  et_status).     
+00007da0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00007db0: 7265 2069 7320 6120 6261 636b 656e 6420  re is a backend 
+00007dc0: 6361 6c6c 2074 6f20 6368 6563 6b20 6966  call to check if
+00007dd0: 2077 6520 6361 6e20 7365 7420 7468 6520   we can set the 
+00007de0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+00007df0: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
+00007e00: 6e20 616e 6f74 6865 7220 6368 6563 6b20  n another check 
+00007e10: 6561 6368 2074 696d 6520 7765 2061 7373  each time we ass
+00007e20: 6572 7420 7468 6520 7374 6174 7573 2061  ert the status a
+00007e30: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
+00007e40: 2020 2020 2065 7870 6563 7465 645f 6361       expected_ca
+00007e50: 6c6c 7320 3d20 5b0a 2020 2020 2020 2020  lls = [.        
+00007e60: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
+00007e70: 5f6c 6561 6465 7227 2c29 2c20 6261 636b  _leader',), back
+00007e80: 656e 645f 6361 6c6c 2c0a 2020 2020 2020  end_call,.      
+00007e90: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+00007ea0: 6973 5f6c 6561 6465 7227 2c29 2c0a 2020  is_leader',),.  
+00007eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ec0: 2020 2827 6973 5f6c 6561 6465 7227 2c29    ('is_leader',)
+00007ed0: 2c20 2827 7374 6174 7573 5f67 6574 272c  , ('status_get',
+00007ee0: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
+00007ef0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00007f00: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00007f10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007f20: 7442 6163 6b65 6e64 4361 6c6c 7328 6578  tBackendCalls(ex
+00007f30: 7065 6374 6564 5f63 616c 6c73 290a 0a20  pected_calls).. 
+00007f40: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
+00007f50: 6170 705f 7374 6174 7573 5f6e 6f6e 5f6c  app_status_non_l
+00007f60: 6561 6465 725f 7261 6973 6573 2873 656c  eader_raises(sel
+00007f70: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00007f80: 2e68 6172 6e65 7373 2e73 6574 5f6c 6561  .harness.set_lea
+00007f90: 6465 7228 4661 6c73 6529 0a20 2020 2020  der(False).     
+00007fa0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00007fb0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+00007fc0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00007fd0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00007fe0: 6170 702e 7374 6174 7573 0a0a 2020 2020  app.status..    
+00007ff0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00008000: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+00008010: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+00008020: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00008030: 2e61 7070 2e73 7461 7475 7320 3d20 6f70  .app.status = op
+00008040: 732e 4163 7469 7665 5374 6174 7573 2829  s.ActiveStatus()
+00008050: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00008060: 6574 5f75 6e69 745f 7374 6174 7573 5f69  et_unit_status_i
+00008070: 6e76 616c 6964 2873 656c 6629 3a0a 2020  nvalid(self):.  
+00008080: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00008090: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+000080a0: 2e49 6e76 616c 6964 5374 6174 7573 4572  .InvalidStatusEr
+000080b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000080c0: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
+000080d0: 742e 7374 6174 7573 203d 2027 626c 6f63  t.status = 'bloc
+000080e0: 6b65 6427 0a0a 2020 2020 6465 6620 7465  ked'..    def te
+000080f0: 7374 5f73 6574 5f61 7070 5f73 7461 7475  st_set_app_statu
+00008100: 735f 696e 7661 6c69 6428 7365 6c66 293a  s_invalid(self):
+00008110: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00008120: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00008130: 6f70 732e 496e 7661 6c69 6453 7461 7475  ops.InvalidStatu
+00008140: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
+00008150: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00008160: 6170 702e 7374 6174 7573 203d 2027 626c  app.status = 'bl
+00008170: 6f63 6b65 6427 0a0a 2020 2020 6465 6620  ocked'..    def 
+00008180: 7465 7374 5f72 656d 6f74 655f 756e 6974  test_remote_unit
+00008190: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
+000081a0: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+000081b0: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
+000081c0: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+000081d0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
+000081e0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+000081f0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+00008200: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
+00008210: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+00008220: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
+00008230: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00008240: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00008250: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00008260: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
+00008270: 2020 2020 7265 6d6f 7465 5f75 6e69 7420      remote_unit 
+00008280: 3d20 6e65 7874 2866 696c 7465 7228 6c61  = next(filter(la
+00008290: 6d62 6461 2075 3a20 752e 6e61 6d65 203d  mbda u: u.name =
+000082a0: 3d20 2772 656d 6f74 6561 7070 312f 3027  = 'remoteapp1/0'
+000082b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000082c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082d0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
+000082e0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+000082f0: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
+00008300: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00008310: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00008320: 2020 2020 2023 2052 656d 6f74 6520 756e       # Remote un
+00008330: 6974 2073 7461 7475 7320 6973 2061 6c77  it status is alw
+00008340: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
+00008350: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008360: 4571 7561 6c28 7265 6d6f 7465 5f75 6e69  Equal(remote_uni
+00008370: 742e 7374 6174 7573 2c20 6f70 732e 556e  t.status, ops.Un
+00008380: 6b6e 6f77 6e53 7461 7475 7328 2929 0a0a  knownStatus())..
+00008390: 2020 2020 2020 2020 7465 7374 5f73 7461          test_sta
+000083a0: 7475 7365 7320 3d20 280a 2020 2020 2020  tuses = (.      
+000083b0: 2020 2020 2020 6f70 732e 556e 6b6e 6f77        ops.Unknow
+000083c0: 6e53 7461 7475 7328 292c 0a20 2020 2020  nStatus(),.     
+000083d0: 2020 2020 2020 206f 7073 2e41 6374 6976         ops.Activ
+000083e0: 6553 7461 7475 7328 2747 7265 656e 2729  eStatus('Green')
+000083f0: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
+00008400: 732e 4d61 696e 7465 6e61 6e63 6553 7461  s.MaintenanceSta
+00008410: 7475 7328 2759 656c 6c6f 7727 292c 0a20  tus('Yellow'),. 
+00008420: 2020 2020 2020 2020 2020 206f 7073 2e42             ops.B
+00008430: 6c6f 636b 6564 5374 6174 7573 2827 5265  lockedStatus('Re
+00008440: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
+00008450: 206f 7073 2e57 6169 7469 6e67 5374 6174   ops.WaitingStat
+00008460: 7573 2827 5768 6974 6527 292c 0a20 2020  us('White'),.   
+00008470: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008480: 666f 7220 7461 7267 6574 5f73 7461 7475  for target_statu
+00008490: 7320 696e 2074 6573 745f 7374 6174 7573  s in test_status
+000084a0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000084b0: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
+000084c0: 7428 7461 7267 6574 5f73 7461 7475 732e  t(target_status.
+000084d0: 6e61 6d65 293a 0a20 2020 2020 2020 2020  name):.         
+000084e0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000084f0: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
+00008500: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
+00008510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008520: 2072 656d 6f74 655f 756e 6974 2e73 7461   remote_unit.sta
+00008530: 7475 7320 3d20 7461 7267 6574 5f73 7461  tus = target_sta
+00008540: 7475 730a 2020 2020 2020 2020 7365 6c66  tus.        self
+00008550: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00008560: 6c6c 7328 5b5d 290a 0a20 2020 2064 6566  lls([])..    def
+00008570: 2074 6573 745f 7265 6d6f 7465 5f61 7070   test_remote_app
+00008580: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
+00008590: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+000085a0: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
+000085b0: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+000085c0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
+000085d0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+000085e0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+000085f0: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
+00008600: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+00008610: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
+00008620: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00008630: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00008640: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00008650: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
+00008660: 2020 2020 7265 6d6f 7465 6170 7031 203d      remoteapp1 =
+00008670: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00008680: 7265 6c61 7469 6f6e 2827 6462 3127 292e  relation('db1').
+00008690: 6170 700a 2020 2020 2020 2020 7365 6c66  app.        self
+000086a0: 2e72 6573 6574 4261 636b 656e 6443 616c  .resetBackendCal
+000086b0: 6c73 2829 0a0a 2020 2020 2020 2020 2320  ls()..        # 
+000086c0: 5265 6d6f 7465 2061 7070 6c69 6361 7469  Remote applicati
+000086d0: 6f6e 2073 7461 7475 7320 6973 2061 6c77  on status is alw
+000086e0: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
+000086f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008700: 4973 496e 7374 616e 6365 2872 656d 6f74  IsInstance(remot
+00008710: 6561 7070 312e 7374 6174 7573 2c20 6f70  eapp1.status, op
+00008720: 732e 556e 6b6e 6f77 6e53 7461 7475 7329  s.UnknownStatus)
+00008730: 0a0a 2020 2020 2020 2020 7465 7374 5f73  ..        test_s
+00008740: 7461 7475 7365 7320 3d20 280a 2020 2020  tatuses = (.    
+00008750: 2020 2020 2020 2020 6f70 732e 556e 6b6e          ops.Unkn
+00008760: 6f77 6e53 7461 7475 7328 292c 0a20 2020  ownStatus(),.   
+00008770: 2020 2020 2020 2020 206f 7073 2e41 6374           ops.Act
+00008780: 6976 6553 7461 7475 7328 292c 0a20 2020  iveStatus(),.   
+00008790: 2020 2020 2020 2020 206f 7073 2e4d 6169           ops.Mai
+000087a0: 6e74 656e 616e 6365 5374 6174 7573 2827  ntenanceStatus('
+000087b0: 5570 6772 6164 696e 6720 736f 6674 7761  Upgrading softwa
+000087c0: 7265 2729 2c0a 2020 2020 2020 2020 2020  re'),.          
+000087d0: 2020 6f70 732e 426c 6f63 6b65 6453 7461    ops.BlockedSta
+000087e0: 7475 7328 2741 7761 6974 696e 6720 6d61  tus('Awaiting ma
+000087f0: 6e75 616c 2072 6573 6f6c 7574 696f 6e27  nual resolution'
+00008800: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+00008810: 7073 2e57 6169 7469 6e67 5374 6174 7573  ps.WaitingStatus
+00008820: 2827 4177 6169 7469 6e67 2072 656c 6174  ('Awaiting relat
+00008830: 6564 2061 7070 2075 7064 6174 6573 2729  ed app updates')
+00008840: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00008850: 2020 2020 666f 7220 7461 7267 6574 5f73      for target_s
+00008860: 7461 7475 7320 696e 2074 6573 745f 7374  tatus in test_st
+00008870: 6174 7573 6573 3a0a 2020 2020 2020 2020  atuses:.        
+00008880: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
+00008890: 6254 6573 7428 7461 7267 6574 5f73 7461  bTest(target_sta
+000088a0: 7475 732e 6e61 6d65 293a 0a20 2020 2020  tus.name):.     
+000088b0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+000088c0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000088d0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+000088e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000088f0: 2020 2020 2072 656d 6f74 6561 7070 312e       remoteapp1.
+00008900: 7374 6174 7573 203d 2074 6172 6765 745f  status = target_
+00008910: 7374 6174 7573 0a20 2020 2020 2020 2073  status.        s
+00008920: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
+00008930: 6443 616c 6c73 285b 5d29 0a0a 2020 2020  dCalls([])..    
+00008940: 6465 6620 7465 7374 5f73 746f 7261 6765  def test_storage
+00008950: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00008960: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
+00008970: 4d65 7461 2829 0a20 2020 2020 2020 206d  Meta().        m
+00008980: 6574 612e 7374 6f72 6167 6573 203d 207b  eta.storages = {
+00008990: 2764 6973 6b73 273a 204e 6f6e 652c 2027  'disks': None, '
+000089a0: 6461 7461 273a 204e 6f6e 657d 0a20 2020  data': None}.   
+000089b0: 2020 2020 206d 6f64 656c 203d 206f 7073       model = ops
+000089c0: 2e4d 6f64 656c 286d 6574 612c 205f 4d6f  .Model(meta, _Mo
+000089d0: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+000089e0: 702f 3027 2929 0a0a 2020 2020 2020 2020  p/0'))..        
+000089f0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00008a00: 2c20 2773 746f 7261 6765 2d6c 6973 7427  , 'storage-list'
+00008a10: 2c20 2727 270a 2020 2020 2020 2020 2020  , '''.          
+00008a20: 2020 6966 205b 2022 2431 2220 3d20 6469    if [ "$1" = di
+00008a30: 736b 7320 5d3b 2074 6865 6e0a 2020 2020  sks ]; then.    
+00008a40: 2020 2020 2020 2020 2020 2020 6563 686f              echo
+00008a50: 2027 5b22 6469 736b 732f 3022 2c20 2264   '["disks/0", "d
+00008a60: 6973 6b73 2f31 225d 270a 2020 2020 2020  isks/1"]'.      
+00008a70: 2020 2020 2020 656c 7365 0a20 2020 2020        else.     
+00008a80: 2020 2020 2020 2020 2020 2065 6368 6f20             echo 
+00008a90: 275b 5d27 0a20 2020 2020 2020 2020 2020  '[]'.           
+00008aa0: 2066 690a 2020 2020 2020 2020 2727 2729   fi.        ''')
+00008ab0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00008ac0: 7269 7074 2873 656c 662c 2027 7374 6f72  ript(self, 'stor
+00008ad0: 6167 652d 6765 7427 2c20 2727 270a 2020  age-get', '''.  
+00008ae0: 2020 2020 2020 2020 2020 6966 205b 2022            if [ "
+00008af0: 2432 2220 3d20 6469 736b 732f 3020 5d3b  $2" = disks/0 ];
+00008b00: 2074 6865 6e0a 2020 2020 2020 2020 2020   then.          
+00008b10: 2020 2020 2020 6563 686f 2027 222f 7661        echo '"/va
+00008b20: 722f 7372 762f 6469 736b 732f 3022 270a  r/srv/disks/0"'.
+00008b30: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00008b40: 205b 2022 2432 2220 3d20 6469 736b 732f   [ "$2" = disks/
+00008b50: 3120 5d3b 2074 6865 6e0a 2020 2020 2020  1 ]; then.      
+00008b60: 2020 2020 2020 2020 2020 6563 686f 2027            echo '
+00008b70: 222f 7661 722f 7372 762f 6469 736b 732f  "/var/srv/disks/
+00008b80: 3122 270a 2020 2020 2020 2020 2020 2020  1"'.            
+00008b90: 656c 7365 0a20 2020 2020 2020 2020 2020  else.           
+00008ba0: 2020 2020 2065 7869 7420 320a 2020 2020       exit 2.    
+00008bb0: 2020 2020 2020 2020 6669 0a20 2020 2020          fi.     
+00008bc0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00008bd0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00008be0: 2c20 2773 746f 7261 6765 2d61 6464 272c  , 'storage-add',
+00008bf0: 2027 2729 0a0a 2020 2020 2020 2020 7365   '')..        se
+00008c00: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+00008c10: 656e 286d 6f64 656c 2e73 746f 7261 6765  en(model.storage
+00008c20: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
+00008c30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00008c40: 6d6f 6465 6c2e 7374 6f72 6167 6573 2e6b  model.storages.k
+00008c50: 6579 7328 292c 206d 6574 612e 7374 6f72  eys(), meta.stor
+00008c60: 6167 6573 2e6b 6579 7328 2929 0a20 2020  ages.keys()).   
+00008c70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008c80: 496e 2827 6469 736b 7327 2c20 6d6f 6465  In('disks', mode
+00008c90: 6c2e 7374 6f72 6167 6573 290a 0a20 2020  l.storages)..   
+00008ca0: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
+00008cb0: 2e72 6169 7365 7328 4b65 7945 7272 6f72  .raises(KeyError
+00008cc0: 2c20 6d61 7463 683d 2744 6964 2079 6f75  , match='Did you
+00008cd0: 206d 6561 6e27 293a 0a20 2020 2020 2020   mean'):.       
+00008ce0: 2020 2020 206d 6f64 656c 2e73 746f 7261       model.stora
+00008cf0: 6765 735b 2764 6f65 732d 6e6f 742d 6578  ges['does-not-ex
+00008d00: 6973 7427 5d0a 0a20 2020 2020 2020 2074  ist']..        t
+00008d10: 6573 745f 6361 7365 7320 3d20 7b0a 2020  est_cases = {.  
+00008d20: 2020 2020 2020 2020 2020 303a 207b 276e            0: {'n
+00008d30: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
+00008d40: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
+00008d50: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
+00008d60: 762f 6469 736b 732f 3027 297d 2c0a 2020  v/disks/0')},.  
+00008d70: 2020 2020 2020 2020 2020 313a 207b 276e            1: {'n
+00008d80: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
+00008d90: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
+00008da0: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
+00008db0: 762f 6469 736b 732f 3127 297d 2c0a 2020  v/disks/1')},.  
+00008dc0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00008dd0: 666f 7220 7374 6f72 6167 6520 696e 206d  for storage in m
+00008de0: 6f64 656c 2e73 746f 7261 6765 735b 2764  odel.storages['d
+00008df0: 6973 6b73 275d 3a0a 2020 2020 2020 2020  isks']:.        
+00008e00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008e10: 7175 616c 2873 746f 7261 6765 2e6e 616d  qual(storage.nam
+00008e20: 652c 2027 6469 736b 7327 290a 2020 2020  e, 'disks').    
+00008e30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00008e40: 6572 7449 6e28 7374 6f72 6167 652e 6964  ertIn(storage.id
+00008e50: 2c20 7465 7374 5f63 6173 6573 290a 2020  , test_cases).  
+00008e60: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00008e70: 7373 6572 7445 7175 616c 2873 746f 7261  ssertEqual(stora
+00008e80: 6765 2e6e 616d 652c 2074 6573 745f 6361  ge.name, test_ca
+00008e90: 7365 735b 7374 6f72 6167 652e 6964 5d5b  ses[storage.id][
+00008ea0: 276e 616d 6527 5d29 0a20 2020 2020 2020  'name']).       
+00008eb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008ec0: 4571 7561 6c28 7374 6f72 6167 652e 6c6f  Equal(storage.lo
+00008ed0: 6361 7469 6f6e 2c20 7465 7374 5f63 6173  cation, test_cas
+00008ee0: 6573 5b73 746f 7261 6765 2e69 645d 5b27  es[storage.id]['
+00008ef0: 6c6f 6361 7469 6f6e 275d 290a 0a20 2020  location'])..   
+00008f00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008f10: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+00008f20: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+00008f30: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
+00008f40: 2020 2020 2020 2020 205b 2773 746f 7261           ['stora
+00008f50: 6765 2d6c 6973 7427 2c20 2764 6973 6b73  ge-list', 'disks
+00008f60: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+00008f70: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
+00008f80: 205b 2773 746f 7261 6765 2d67 6574 272c   ['storage-get',
+00008f90: 2027 2d73 272c 2027 6469 736b 732f 3027   '-s', 'disks/0'
+00008fa0: 2c20 276c 6f63 6174 696f 6e27 2c20 272d  , 'location', '-
+00008fb0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+00008fc0: 2020 2020 2020 2020 2020 2020 5b27 7374              ['st
+00008fd0: 6f72 6167 652d 6765 7427 2c20 272d 7327  orage-get', '-s'
+00008fe0: 2c20 2764 6973 6b73 2f31 272c 2027 6c6f  , 'disks/1', 'lo
+00008ff0: 6361 7469 6f6e 272c 2027 2d2d 666f 726d  cation', '--form
+00009000: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+00009010: 2020 205d 290a 0a20 2020 2020 2020 2073     ])..        s
+00009020: 656c 662e 6173 7365 7274 5365 7175 656e  elf.assertSequen
+00009030: 6365 4571 7561 6c28 6d6f 6465 6c2e 7374  ceEqual(model.st
+00009040: 6f72 6167 6573 5b27 6461 7461 275d 2c20  orages['data'], 
+00009050: 5b5d 290a 2020 2020 2020 2020 6d6f 6465  []).        mode
+00009060: 6c2e 7374 6f72 6167 6573 2e72 6571 7565  l.storages.reque
+00009070: 7374 2827 6461 7461 272c 2063 6f75 6e74  st('data', count
+00009080: 3d33 290a 2020 2020 2020 2020 7365 6c66  =3).        self
+00009090: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+000090a0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+000090b0: 656c 6629 2c20 5b0a 2020 2020 2020 2020  elf), [.        
+000090c0: 2020 2020 5b27 7374 6f72 6167 652d 6c69      ['storage-li
+000090d0: 7374 272c 2027 6461 7461 272c 2027 2d2d  st', 'data', '--
+000090e0: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+000090f0: 2020 2020 2020 2020 2020 205b 2773 746f             ['sto
+00009100: 7261 6765 2d61 6464 272c 2027 6461 7461  rage-add', 'data
+00009110: 3d33 275d 2c0a 2020 2020 2020 2020 5d29  =3'],.        ])
+00009120: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
+00009130: 746f 2061 6464 2073 746f 7261 6765 206e  to add storage n
+00009140: 6f74 2070 7265 7365 6e74 2069 6e20 6368  ot present in ch
+00009150: 6172 6d20 6d65 7461 6461 7461 2e0a 2020  arm metadata..  
+00009160: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00009170: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00009180: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+00009190: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
+000091a0: 7374 6f72 6167 6573 2e72 6571 7565 7374  storages.request
+000091b0: 2827 6465 6164 6265 6566 2729 0a0a 2020  ('deadbeef')..  
+000091c0: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
+000091d0: 636f 756e 7420 7061 7261 6d65 7465 7220  count parameter 
+000091e0: 7479 7065 732e 0a20 2020 2020 2020 2066  types..        f
+000091f0: 6f72 2063 6f75 6e74 5f76 2069 6e20 5b4e  or count_v in [N
+00009200: 6f6e 652c 2046 616c 7365 2c20 322e 302c  one, False, 2.0,
+00009210: 2027 6127 2c20 6227 6265 6566 272c 206f   'a', b'beef', o
+00009220: 626a 6563 745d 3a0a 2020 2020 2020 2020  bject]:.        
+00009230: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00009240: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+00009250: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00009260: 2020 2020 2020 206d 6f64 656c 2e73 746f         model.sto
+00009270: 7261 6765 732e 7265 7175 6573 7428 2764  rages.request('d
+00009280: 6174 6127 2c20 636f 756e 745f 7629 0a0a  ata', count_v)..
+00009290: 2020 2020 6465 6620 7465 7374 5f73 746f      def test_sto
+000092a0: 7261 6765 735f 696d 6d75 7461 626c 6528  rages_immutable(
+000092b0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+000092c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000092d0: 6169 7365 7328 4174 7472 6962 7574 6545  aises(AttributeE
+000092e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000092f0: 2020 2073 656c 662e 6d6f 6465 6c2e 7374     self.model.st
+00009300: 6f72 6167 6573 203d 207b 7d0a 0a20 2020  orages = {}..   
+00009310: 2064 6566 2072 6573 6574 4261 636b 656e   def resetBacken
+00009320: 6443 616c 6c73 2873 656c 6629 3a20 2023  dCalls(self):  #
+00009330: 206e 6f71 613a 204e 3830 320a 2020 2020   noqa: N802.    
+00009340: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00009350: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
+00009360: 6c6c 7328 7265 7365 743d 5472 7565 290a  lls(reset=True).
+00009370: 0a20 2020 2064 6566 2061 7373 6572 7442  .    def assertB
+00009380: 6163 6b65 6e64 4361 6c6c 7328 7365 6c66  ackendCalls(self
+00009390: 2c20 6578 7065 6374 6564 2c20 2a2c 2072  , expected, *, r
+000093a0: 6573 6574 3d54 7275 6529 3a20 2023 206e  eset=True):  # n
+000093b0: 6f71 613a 204e 3830 320a 2020 2020 2020  oqa: N802.      
+000093c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000093d0: 616c 2865 7870 6563 7465 642c 2073 656c  al(expected, sel
+000093e0: 662e 6861 726e 6573 732e 5f67 6574 5f62  f.harness._get_b
+000093f0: 6163 6b65 6e64 5f63 616c 6c73 2872 6573  ackend_calls(res
+00009400: 6574 3d72 6573 6574 2929 0a0a 2020 2020  et=reset))..    
+00009410: 6465 6620 7465 7374 5f72 756e 5f65 7272  def test_run_err
+00009420: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+00009430: 2020 6d6f 6465 6c20 3d20 6f70 732e 4d6f    model = ops.Mo
+00009440: 6465 6c28 6f70 732e 4368 6172 6d4d 6574  del(ops.CharmMet
+00009450: 6128 292c 205f 4d6f 6465 6c42 6163 6b65  a(), _ModelBacke
+00009460: 6e64 2827 6d79 6170 702f 3027 2929 0a20  nd('myapp/0')). 
+00009470: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00009480: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
+00009490: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+000094a0: 4552 524f 5220 6361 6e6e 6f74 2067 6574  ERROR cannot get
+000094b0: 2073 7461 7475 7327 203e 2632 3b20 6578   status' >&2; ex
+000094c0: 6974 2031 2222 2229 0a20 2020 2020 2020  it 1""").       
+000094d0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000094e0: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
+000094f0: 6c45 7272 6f72 2920 6173 2063 6d3a 0a20  lError) as cm:. 
+00009500: 2020 2020 2020 2020 2020 205f 203d 206d             _ = m
+00009510: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
+00009520: 2e6d 6573 7361 6765 0a20 2020 2020 2020  .message.       
+00009530: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009540: 6c28 7374 7228 636d 2e65 7863 6570 7469  l(str(cm.excepti
+00009550: 6f6e 292c 2027 4552 524f 5220 6361 6e6e  on), 'ERROR cann
+00009560: 6f74 2067 6574 2073 7461 7475 735c 6e27  ot get status\n'
+00009570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009580: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00009590: 6365 7074 696f 6e2e 6172 6773 5b30 5d2c  ception.args[0],
+000095a0: 2027 4552 524f 5220 6361 6e6e 6f74 2067   'ERROR cannot g
+000095b0: 6574 2073 7461 7475 735c 6e27 290a 0a0a  et status\n')...
+000095c0: 636c 6173 7320 5075 7368 5075 6c6c 4361  class PushPullCa
+000095d0: 7365 3a0a 2020 2020 2222 2254 6573 7420  se:.    """Test 
+000095e0: 6361 7365 2066 6f72 2074 6162 6c65 2d64  case for table-d
+000095f0: 7269 7665 6e20 7465 7374 732e 2222 220a  riven tests.""".
+00009600: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00009610: 5f28 7365 6c66 2c20 2a2a 7661 6c73 293a  _(self, **vals):
+00009620: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
+00009630: 7474 6572 6e20 3d20 4e6f 6e65 0a20 2020  ttern = None.   
+00009640: 2020 2020 2073 656c 662e 6473 7420 3d20       self.dst = 
+00009650: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00009660: 662e 6572 726f 7273 203d 205b 5d0a 2020  f.errors = [].  
+00009670: 2020 2020 2020 7365 6c66 2e77 616e 7420        self.want 
+00009680: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00009690: 666f 7220 6b65 792c 2076 616c 2069 6e20  for key, val in 
+000096a0: 7661 6c73 2e69 7465 6d73 2829 3a0a 2020  vals.items():.  
+000096b0: 2020 2020 2020 2020 2020 7365 7461 7474            setatt
+000096c0: 7228 7365 6c66 2c20 6b65 792c 2076 616c  r(self, key, val
+000096d0: 290a 0a0a 7265 6375 7273 6976 655f 6c69  )...recursive_li
+000096e0: 7374 5f63 6173 6573 203d 205b 0a20 2020  st_cases = [.   
+000096f0: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
+00009700: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
+00009710: 6963 2072 6563 7572 7369 7665 206c 6973  ic recursive lis
+00009720: 7427 2c0a 2020 2020 2020 2020 7061 7468  t',.        path
+00009730: 3d27 2f27 2c0a 2020 2020 2020 2020 6669  ='/',.        fi
+00009740: 6c65 733d 5b27 2f66 6f6f 2f62 6172 2e74  les=['/foo/bar.t
+00009750: 7874 272c 2027 2f62 617a 2e74 7874 275d  xt', '/baz.txt']
+00009760: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
+00009770: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
+00009780: 272f 6261 7a2e 7478 7427 7d2c 0a20 2020  '/baz.txt'},.   
+00009790: 2029 2c0a 2020 2020 5075 7368 5075 6c6c   ),.    PushPull
+000097a0: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
+000097b0: 6d65 3d27 6261 7369 6320 7265 6375 7273  me='basic recurs
+000097c0: 6976 6520 6c69 7374 2072 6576 6572 7365  ive list reverse
+000097d0: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
+000097e0: 272f 272c 0a20 2020 2020 2020 2066 696c  '/',.        fil
+000097f0: 6573 3d5b 272f 6261 7a2e 7478 7427 2c20  es=['/baz.txt', 
+00009800: 272f 666f 6f2f 6261 722e 7478 7427 5d2c  '/foo/bar.txt'],
+00009810: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
+00009820: 2f66 6f6f 2f62 6172 2e74 7874 272c 2027  /foo/bar.txt', '
+00009830: 2f62 617a 2e74 7874 277d 2c0a 2020 2020  /baz.txt'},.    
+00009840: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+00009850: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+00009860: 653d 2764 6972 6563 746c 7920 6c69 7374  e='directly list
+00009870: 2061 2028 6e6f 6e2d 6469 7265 6374 6f72   a (non-director
+00009880: 7929 2066 696c 6527 2c0a 2020 2020 2020  y) file',.      
+00009890: 2020 7061 7468 3d27 2f62 617a 2e74 7874    path='/baz.txt
+000098a0: 272c 0a20 2020 2020 2020 2066 696c 6573  ',.        files
+000098b0: 3d5b 272f 6261 7a2e 7478 7427 5d2c 0a20  =['/baz.txt'],. 
+000098c0: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
+000098d0: 617a 2e74 7874 277d 2c0a 2020 2020 292c  az.txt'},.    ),
+000098e0: 0a5d 0a0a 0a40 7079 7465 7374 2e6d 6172  .]...@pytest.mar
+000098f0: 6b2e 7061 7261 6d65 7472 697a 6528 2763  k.parametrize('c
+00009900: 6173 6527 2c20 7265 6375 7273 6976 655f  ase', recursive_
+00009910: 6c69 7374 5f63 6173 6573 290a 6465 6620  list_cases).def 
+00009920: 7465 7374 5f72 6563 7572 7369 7665 5f6c  test_recursive_l
+00009930: 6973 7428 6361 7365 293a 0a20 2020 2064  ist(case):.    d
+00009940: 6566 206c 6973 745f 6675 6e63 5f67 656e  ef list_func_gen
+00009950: 2866 696c 655f 6c69 7374 293a 0a20 2020  (file_list):.   
+00009960: 2020 2020 2061 7267 7320 3d20 7b0a 2020       args = {.  
+00009970: 2020 2020 2020 2020 2020 276c 6173 745f            'last_
+00009980: 6d6f 6469 6669 6564 273a 2064 6174 6574  modified': datet
+00009990: 696d 652e 7469 6d65 2829 2c0a 2020 2020  ime.time(),.    
+000099a0: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
+000099b0: 696f 6e73 273a 2030 6f37 3737 2c0a 2020  ions': 0o777,.  
+000099c0: 2020 2020 2020 2020 2020 2773 697a 6527            'size'
+000099d0: 3a20 3432 2c0a 2020 2020 2020 2020 2020  : 42,.          
+000099e0: 2020 2775 7365 725f 6964 273a 2030 2c0a    'user_id': 0,.
+000099f0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
+00009a00: 7227 3a20 2766 6f6f 272c 0a20 2020 2020  r': 'foo',.     
+00009a10: 2020 2020 2020 2027 6772 6f75 705f 6964         'group_id
+00009a20: 273a 2031 3032 342c 0a20 2020 2020 2020  ': 1024,.       
+00009a30: 2020 2020 2027 6772 6f75 7027 3a20 2762       'group': 'b
+00009a40: 6172 272c 0a20 2020 2020 2020 207d 0a20  ar',.        }. 
+00009a50: 2020 2020 2020 2066 696c 655f 696e 666f         file_info
+00009a60: 732c 2064 6972 7320 3d20 5b5d 2c20 7365  s, dirs = [], se
+00009a70: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+00009a80: 6620 696e 2066 696c 655f 6c69 7374 3a0a  f in file_list:.
+00009a90: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00009aa0: 5f69 6e66 6f73 2e61 7070 656e 6428 0a20  _infos.append(. 
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00009ac0: 6562 626c 652e 4669 6c65 496e 666f 280a  ebble.FileInfo(.
 00009ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ae0: 6e61 6d65 3d6f 732e 7061 7468 2e62 6173  name=os.path.bas
-00009af0: 656e 616d 6528 6629 2c0a 2020 2020 2020  ename(f),.      
-00009b00: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-00009b10: 7065 3d70 6562 626c 652e 4669 6c65 5479  pe=pebble.FileTy
-00009b20: 7065 2e46 494c 452c 0a20 2020 2020 2020  pe.FILE,.       
-00009b30: 2020 2020 2020 2020 2020 2020 202a 2a61               **a
-00009b40: 7267 7329 290a 0a20 2020 2020 2020 2020  rgs))..         
-00009b50: 2020 2023 2063 6f6c 6c65 6374 2061 6c6c     # collect all
-00009b60: 2074 6865 2064 6972 6563 746f 7269 6573   the directories
-00009b70: 2066 6f72 2074 6865 2074 6573 7420 6361   for the test ca
-00009b80: 7365 2773 2066 696c 6573 0a20 2020 2020  se's files.     
-00009b90: 2020 2020 2020 2064 6972 7061 7468 203d         dirpath =
-00009ba0: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
-00009bb0: 2866 290a 2020 2020 2020 2020 2020 2020  (f).            
-00009bc0: 6966 2064 6972 7061 7468 2021 3d20 2727  if dirpath != ''
-00009bd0: 2061 6e64 2064 6972 7061 7468 206e 6f74   and dirpath not
-00009be0: 2069 6e20 6469 7273 3a0a 2020 2020 2020   in dirs:.      
-00009bf0: 2020 2020 2020 2020 2020 6469 7273 2e75            dirs.u
-00009c00: 7064 6174 6528 6469 7270 6174 6829 0a20  pdate(dirpath). 
-00009c10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009c20: 696c 655f 696e 666f 732e 6170 7065 6e64  ile_infos.append
-00009c30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00009c40: 2020 2020 2020 7065 6262 6c65 2e46 696c        pebble.Fil
-00009c50: 6549 6e66 6f28 0a20 2020 2020 2020 2020  eInfo(.         
-00009c60: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00009c70: 6174 683d 6469 7270 6174 682c 0a20 2020  ath=dirpath,.   
-00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c90: 2020 2020 206e 616d 653d 6f73 2e70 6174       name=os.pat
-00009ca0: 682e 6261 7365 6e61 6d65 2864 6972 7061  h.basename(dirpa
-00009cb0: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
-00009cc0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-00009cd0: 653d 7065 6262 6c65 2e46 696c 6554 7970  e=pebble.FileTyp
-00009ce0: 652e 4449 5245 4354 4f52 592c 0a20 2020  e.DIRECTORY,.   
-00009cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d00: 2020 2020 202a 2a61 7267 7329 290a 0a20       **args)).. 
-00009d10: 2020 2020 2020 2064 6566 2069 6e6e 6572         def inner
-00009d20: 2870 6174 6829 3a0a 2020 2020 2020 2020  (path):.        
-00009d30: 2020 2020 7061 7468 203d 2073 7472 2870      path = str(p
-00009d40: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00009d50: 206d 6174 6368 6573 203d 205b 5d0a 2020   matches = [].  
-00009d60: 2020 2020 2020 2020 2020 666f 7220 696e            for in
-00009d70: 666f 2069 6e20 6669 6c65 5f69 6e66 6f73  fo in file_infos
-00009d80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009d90: 2020 2320 6578 636c 7564 6520 6669 6c65    # exclude file
-00009da0: 2069 6e66 6f73 2066 6f72 2073 6570 6172   infos for separ
-00009db0: 6174 6520 7472 6565 7320 616e 6420 616c  ate trees and al
-00009dc0: 736f 0a20 2020 2020 2020 2020 2020 2020  so.             
-00009dd0: 2020 2023 2066 6f72 2074 6865 2064 6972     # for the dir
-00009de0: 6563 746f 7279 2077 6520 6172 6520 6c69  ectory we are li
-00009df0: 7374 696e 6720 6974 7365 6c66 202d 2077  sting itself - w
-00009e00: 6520 6f6e 6c79 2077 616e 7420 6974 7320  e only want its 
-00009e10: 636f 6e74 656e 7473 2e0a 2020 2020 2020  contents..      
-00009e20: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00009e30: 2069 6e66 6f2e 7061 7468 2e73 7461 7274   info.path.start
-00009e40: 7377 6974 6828 7061 7468 2920 6f72 2028  swith(path) or (
-00009e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009e60: 2020 2020 2020 2020 2069 6e66 6f2e 7479           info.ty
-00009e70: 7065 203d 3d20 7065 6262 6c65 2e46 696c  pe == pebble.Fil
-00009e80: 6554 7970 652e 4449 5245 4354 4f52 5920  eType.DIRECTORY 
-00009e90: 616e 6420 7061 7468 203d 3d20 696e 666f  and path == info
-00009ea0: 2e70 6174 6829 3a0a 2020 2020 2020 2020  .path):.        
-00009eb0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00009ec0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00009ed0: 2020 2020 2023 2065 7863 6c75 6465 2066       # exclude f
-00009ee0: 696c 6520 696e 666f 7320 666f 7220 6669  ile infos for fi
-00009ef0: 6c65 7320 7468 6174 2061 7265 2069 6e20  les that are in 
-00009f00: 7375 6264 6972 6563 746f 7269 6573 206f  subdirectories o
-00009f10: 6620 7061 7468 2e0a 2020 2020 2020 2020  f path..        
-00009f20: 2020 2020 2020 2020 2320 7765 206f 6e6c          # we onl
-00009f30: 7920 7761 6e74 2066 696c 6573 2074 6861  y want files tha
-00009f40: 7420 6172 6520 6469 7265 6374 6c79 2069  t are directly i
-00009f50: 6e20 7061 7468 2e0a 2020 2020 2020 2020  n path..        
-00009f60: 2020 2020 2020 2020 6966 2069 6e66 6f2e          if info.
-00009f70: 7061 7468 5b6c 656e 2870 6174 6829 3a5d  path[len(path):]
-00009f80: 2e66 696e 6428 272f 2729 203e 2030 3a0a  .find('/') > 0:.
-00009f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fa0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00009fb0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
-00009fc0: 6368 6573 2e61 7070 656e 6428 696e 666f  ches.append(info
-00009fd0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00009fe0: 7475 726e 206d 6174 6368 6573 0a20 2020  turn matches.   
-00009ff0: 2020 2020 2072 6574 7572 6e20 696e 6e65       return inne
-0000a000: 720a 0a20 2020 2023 2074 6573 7420 7261  r..    # test ra
-0000a010: 7720 6275 7369 6e65 7373 206c 6f67 6963  w business logic
-0000a020: 2066 6f72 2072 6563 7572 7369 6f6e 2061   for recursion a
-0000a030: 6e64 2064 6573 7420 7061 7468 2063 6f6e  nd dest path con
-0000a040: 7374 7275 6374 696f 6e0a 2020 2020 6669  struction.    fi
-0000a050: 6c65 7320 3d20 7365 7428 290a 2020 2020  les = set().    
-0000a060: 6361 7365 2e70 6174 6820 3d20 6f73 2e70  case.path = os.p
-0000a070: 6174 682e 6e6f 726d 7061 7468 2863 6173  ath.normpath(cas
-0000a080: 652e 7061 7468 290a 2020 2020 6361 7365  e.path).    case
-0000a090: 2e66 696c 6573 203d 205b 6f73 2e70 6174  .files = [os.pat
-0000a0a0: 682e 6e6f 726d 7061 7468 2866 2920 666f  h.normpath(f) fo
-0000a0b0: 7220 6620 696e 2063 6173 652e 6669 6c65  r f in case.file
-0000a0c0: 735d 0a20 2020 2063 6173 652e 7761 6e74  s].    case.want
-0000a0d0: 203d 207b 6f73 2e70 6174 682e 6e6f 726d   = {os.path.norm
-0000a0e0: 7061 7468 2866 2920 666f 7220 6620 696e  path(f) for f in
-0000a0f0: 2063 6173 652e 7761 6e74 7d0a 2020 2020   case.want}.    
-0000a100: 666f 7220 6620 696e 206f 7073 2e43 6f6e  for f in ops.Con
-0000a110: 7461 696e 6572 2e5f 6c69 7374 5f72 6563  tainer._list_rec
-0000a120: 7572 7369 7665 280a 2020 2020 2020 2020  ursive(.        
-0000a130: 6c69 7374 5f66 756e 635f 6765 6e28 0a20  list_func_gen(. 
-0000a140: 2020 2020 2020 2020 2020 2063 6173 652e             case.
-0000a150: 6669 6c65 7329 2c20 7061 7468 6c69 622e  files), pathlib.
-0000a160: 5061 7468 280a 2020 2020 2020 2020 2020  Path(.          
-0000a170: 2020 6361 7365 2e70 6174 6829 293a 0a20    case.path)):. 
-0000a180: 2020 2020 2020 2070 6174 6820 3d20 662e         path = f.
-0000a190: 7061 7468 0a20 2020 2020 2020 2069 6620  path.        if 
-0000a1a0: 6361 7365 2e64 7374 2069 7320 6e6f 7420  case.dst is not 
-0000a1b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000a1c0: 2020 2320 7465 7374 2064 6573 7469 6e61    # test destina
-0000a1d0: 7469 6f6e 2070 6174 6820 636f 6e73 7472  tion path constr
-0000a1e0: 7563 7469 6f6e 0a20 2020 2020 2020 2020  uction.         
-0000a1f0: 2020 205f 2c20 7061 7468 203d 2066 2e70     _, path = f.p
-0000a200: 6174 682c 206f 7073 2e43 6f6e 7461 696e  ath, ops.Contain
-0000a210: 6572 2e5f 6275 696c 645f 6465 7374 7061  er._build_destpa
-0000a220: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
-0000a230: 2020 2020 662e 7061 7468 2c20 6361 7365      f.path, case
-0000a240: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
-0000a250: 0a20 2020 2020 2020 2066 696c 6573 2e61  .        files.a
-0000a260: 6464 2870 6174 6829 0a20 2020 2061 7373  dd(path).    ass
-0000a270: 6572 7420 6361 7365 2e77 616e 7420 3d3d  ert case.want ==
-0000a280: 2066 696c 6573 2c20 6627 6361 7365 207b   files, f'case {
-0000a290: 6361 7365 2e6e 616d 6521 727d 2068 6173  case.name!r} has
-0000a2a0: 2077 726f 6e67 2066 696c 6573 3a20 7761   wrong files: wa
-0000a2b0: 6e74 207b 6361 7365 2e77 616e 747d 2c20  nt {case.want}, 
-0000a2c0: 676f 7420 7b66 696c 6573 7d27 0a0a 0a72  got {files}'...r
-0000a2d0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
-0000a2e0: 6c6c 5f63 6173 6573 203d 205b 0a20 2020  ll_cases = [.   
-0000a2f0: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
-0000a300: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
-0000a310: 6963 2070 7573 682f 7075 6c6c 272c 0a20  ic push/pull',. 
-0000a320: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
-0000a330: 6f27 2c0a 2020 2020 2020 2020 6473 743d  o',.        dst=
-0000a340: 272f 6261 7a27 2c0a 2020 2020 2020 2020  '/baz',.        
-0000a350: 6669 6c65 733d 5b27 2f66 6f6f 2f62 6172  files=['/foo/bar
-0000a360: 2e74 7874 275d 2c0a 2020 2020 2020 2020  .txt'],.        
-0000a370: 7761 6e74 3d7b 272f 6261 7a2f 666f 6f2f  want={'/baz/foo/
-0000a380: 6261 722e 7478 7427 7d2c 0a20 2020 2029  bar.txt'},.    )
-0000a390: 2c0a 2020 2020 5075 7368 5075 6c6c 4361  ,.    PushPullCa
-0000a3a0: 7365 280a 2020 2020 2020 2020 6e61 6d65  se(.        name
-0000a3b0: 3d27 7075 7368 2f70 756c 6c20 2d20 7472  ='push/pull - tr
-0000a3c0: 6169 6c69 6e67 2073 6c61 7368 272c 0a20  ailing slash',. 
-0000a3d0: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
-0000a3e0: 6f2f 272c 0a20 2020 2020 2020 2064 7374  o/',.        dst
-0000a3f0: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
-0000a400: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
-0000a410: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
-0000a420: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
-0000a430: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
-0000a440: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
-0000a450: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
-0000a460: 653d 2762 6173 6963 2070 7573 682f 7075  e='basic push/pu
-0000a470: 6c6c 202d 2072 6f6f 7427 2c0a 2020 2020  ll - root',.    
-0000a480: 2020 2020 7061 7468 3d27 2f27 2c0a 2020      path='/',.  
-0000a490: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
-0000a4a0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
-0000a4b0: 5b27 2f66 6f6f 2f62 6172 2e74 7874 275d  ['/foo/bar.txt']
-0000a4c0: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
-0000a4d0: 272f 6261 7a2f 666f 6f2f 6261 722e 7478  '/baz/foo/bar.tx
-0000a4e0: 7427 7d2c 0a20 2020 2029 2c0a 2020 2020  t'},.    ),.    
-0000a4f0: 5075 7368 5075 6c6c 4361 7365 280a 2020  PushPullCase(.  
-0000a500: 2020 2020 2020 6e61 6d65 3d27 6261 7369        name='basi
-0000a510: 6320 7075 7368 2f70 756c 6c20 2d20 6d75  c push/pull - mu
-0000a520: 6c74 6963 6f6d 706f 6e65 6e74 2070 6174  lticomponent pat
-0000a530: 6827 2c0a 2020 2020 2020 2020 7061 7468  h',.        path
-0000a540: 3d27 2f66 6f6f 2f62 6172 272c 0a20 2020  ='/foo/bar',.   
-0000a550: 2020 2020 2064 7374 3d27 2f62 617a 272c       dst='/baz',
-0000a560: 0a20 2020 2020 2020 2066 696c 6573 3d5b  .        files=[
-0000a570: 272f 666f 6f2f 6261 722f 6261 7a2e 7478  '/foo/bar/baz.tx
-0000a580: 7427 5d2c 0a20 2020 2020 2020 2077 616e  t'],.        wan
-0000a590: 743d 7b27 2f62 617a 2f62 6172 2f62 617a  t={'/baz/bar/baz
-0000a5a0: 2e74 7874 277d 2c0a 2020 2020 292c 0a20  .txt'},.    ),. 
-0000a5b0: 2020 2050 7573 6850 756c 6c43 6173 6528     PushPullCase(
-0000a5c0: 0a20 2020 2020 2020 206e 616d 653d 2770  .        name='p
-0000a5d0: 7573 682f 7075 6c6c 2063 6f6e 7465 6e74  ush/pull content
-0000a5e0: 7327 2c0a 2020 2020 2020 2020 7061 7468  s',.        path
-0000a5f0: 3d27 2f66 6f6f 2f2a 272c 0a20 2020 2020  ='/foo/*',.     
-0000a600: 2020 2064 7374 3d27 2f62 617a 272c 0a20     dst='/baz',. 
-0000a610: 2020 2020 2020 2066 696c 6573 3d5b 272f         files=['/
-0000a620: 666f 6f2f 6261 722e 7478 7427 5d2c 0a20  foo/bar.txt'],. 
-0000a630: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
-0000a640: 617a 2f62 6172 2e74 7874 277d 2c0a 2020  az/bar.txt'},.  
-0000a650: 2020 292c 0a20 2020 2050 7573 6850 756c    ),.    PushPul
-0000a660: 6c43 6173 6528 0a20 2020 2020 2020 206e  lCase(.        n
-0000a670: 616d 653d 2764 6972 6563 746c 7920 7075  ame='directly pu
-0000a680: 7368 2f70 756c 6c20 6120 7370 6563 6966  sh/pull a specif
-0000a690: 6963 2066 696c 6527 2c0a 2020 2020 2020  ic file',.      
-0000a6a0: 2020 7061 7468 3d27 2f66 6f6f 2f62 6172    path='/foo/bar
-0000a6b0: 2e74 7874 272c 0a20 2020 2020 2020 2064  .txt',.        d
-0000a6c0: 7374 3d27 2f62 617a 272c 0a20 2020 2020  st='/baz',.     
-0000a6d0: 2020 2066 696c 6573 3d5b 272f 666f 6f2f     files=['/foo/
-0000a6e0: 6261 722e 7478 7427 5d2c 0a20 2020 2020  bar.txt'],.     
-0000a6f0: 2020 2077 616e 743d 7b27 2f62 617a 2f62     want={'/baz/b
-0000a700: 6172 2e74 7874 277d 2c0a 2020 2020 292c  ar.txt'},.    ),
-0000a710: 0a20 2020 2050 7573 6850 756c 6c43 6173  .    PushPullCas
-0000a720: 6528 0a20 2020 2020 2020 206e 616d 653d  e(.        name=
-0000a730: 2765 7272 6f72 206f 6e20 7075 7368 2f70  'error on push/p
-0000a740: 756c 6c20 6e6f 6e2d 6578 6973 7469 6e67  ull non-existing
-0000a750: 2066 696c 6527 2c0a 2020 2020 2020 2020   file',.        
-0000a760: 7061 7468 3d27 2f66 6f6f 2f62 6172 2e74  path='/foo/bar.t
-0000a770: 7874 272c 0a20 2020 2020 2020 2064 7374  xt',.        dst
-0000a780: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
-0000a790: 2066 696c 6573 3d5b 5d2c 0a20 2020 2020   files=[],.     
-0000a7a0: 2020 2065 7272 6f72 733d 7b27 2f66 6f6f     errors={'/foo
-0000a7b0: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
-0000a7c0: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
-0000a7d0: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
-0000a7e0: 653d 2770 7573 682f 7075 6c6c 206d 756c  e='push/pull mul
-0000a7f0: 7469 706c 6520 6e6f 6e2d 6578 6973 7469  tiple non-existi
-0000a800: 6e67 2066 696c 6573 272c 0a20 2020 2020  ng files',.     
-0000a810: 2020 2070 6174 683d 5b27 2f66 6f6f 2f62     path=['/foo/b
-0000a820: 6172 2e74 7874 272c 2027 2f62 6f6f 2f66  ar.txt', '/boo/f
-0000a830: 6172 2e74 7874 275d 2c0a 2020 2020 2020  ar.txt'],.      
-0000a840: 2020 6473 743d 272f 6261 7a27 2c0a 2020    dst='/baz',.  
-0000a850: 2020 2020 2020 6669 6c65 733d 5b5d 2c0a        files=[],.
-0000a860: 2020 2020 2020 2020 6572 726f 7273 3d7b          errors={
-0000a870: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
-0000a880: 272f 626f 6f2f 6661 722e 7478 7427 7d2c  '/boo/far.txt'},
-0000a890: 0a20 2020 2029 2c0a 2020 2020 5075 7368  .    ),.    Push
-0000a8a0: 5075 6c6c 4361 7365 280a 2020 2020 2020  PullCase(.      
-0000a8b0: 2020 6e61 6d65 3d27 7075 7368 2f70 756c    name='push/pul
-0000a8c0: 6c20 6669 6c65 2061 6e64 2064 6972 2063  l file and dir c
-0000a8d0: 6f6d 626f 272c 0a20 2020 2020 2020 2070  ombo',.        p
-0000a8e0: 6174 683d 5b27 2f66 6f6f 2f66 6f6f 6261  ath=['/foo/fooba
-0000a8f0: 722e 7478 7427 2c20 272f 666f 6f2f 6261  r.txt', '/foo/ba
-0000a900: 7227 5d2c 0a20 2020 2020 2020 2064 7374  r'],.        dst
-0000a910: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
-0000a920: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
-0000a930: 722f 6261 7a2e 7478 7427 2c20 272f 666f  r/baz.txt', '/fo
-0000a940: 6f2f 666f 6f62 6172 2e74 7874 272c 2027  o/foobar.txt', '
-0000a950: 2f71 7575 782e 7478 7427 5d2c 0a20 2020  /quux.txt'],.   
-0000a960: 2020 2020 2077 616e 743d 7b27 2f62 617a       want={'/baz
-0000a970: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
-0000a980: 6261 7a2f 6261 722f 6261 7a2e 7478 7427  baz/bar/baz.txt'
-0000a990: 7d2c 0a20 2020 2029 2c0a 5d0a 0a0a 4070  },.    ),.]...@p
-0000a9a0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-0000a9b0: 6574 7269 7a65 2827 6361 7365 272c 2072  etrize('case', r
-0000a9c0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
-0000a9d0: 6c6c 5f63 6173 6573 290a 6465 6620 7465  ll_cases).def te
-0000a9e0: 7374 5f72 6563 7572 7369 7665 5f70 7573  st_recursive_pus
-0000a9f0: 685f 616e 645f 7075 6c6c 2863 6173 6529  h_and_pull(case)
-0000aa00: 3a0a 2020 2020 2320 6675 6c6c 2022 696e  :.    # full "in
-0000aa10: 7465 6772 6174 696f 6e22 2074 6573 7420  tegration" test 
-0000aa20: 6f66 2070 7573 682b 7075 6c6c 0a20 2020  of push+pull.   
-0000aa30: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-0000aa40: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-0000aa50: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-0000aa60: 7461 3d27 2727 0a20 2020 2020 2020 206e  ta='''.        n
-0000aa70: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-0000aa80: 2020 2020 2020 636f 6e74 6169 6e65 7273        containers
-0000aa90: 3a0a 2020 2020 2020 2020 2020 666f 6f3a  :.          foo:
-0000aaa0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000aab0: 6f75 7263 653a 2066 6f6f 2d69 6d61 6765  ource: foo-image
-0000aac0: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
-0000aad0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-0000aae0: 290a 2020 2020 6861 726e 6573 732e 7365  ).    harness.se
-0000aaf0: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
-0000ab00: 6f6f 272c 2054 7275 6529 0a20 2020 2063  oo', True).    c
-0000ab10: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
-0000ab20: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
-0000ab30: 5b27 666f 6f27 5d0a 0a20 2020 2023 2063  ['foo']..    # c
-0000ab40: 7265 6174 6520 7075 7368 2074 6573 7420  reate push test 
-0000ab50: 6361 7365 2066 696c 6573 7973 7465 6d20  case filesystem 
-0000ab60: 7374 7275 6374 7572 650a 2020 2020 7075  structure.    pu
-0000ab70: 7368 5f73 7263 203d 2074 656d 7066 696c  sh_src = tempfil
-0000ab80: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
-0000ab90: 746f 7279 2829 0a20 2020 2066 6f72 2066  tory().    for f
-0000aba0: 696c 6520 696e 2063 6173 652e 6669 6c65  ile in case.file
-0000abb0: 733a 0a20 2020 2020 2020 2066 7061 7468  s:.        fpath
-0000abc0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0000abd0: 7075 7368 5f73 7263 2e6e 616d 652c 2066  push_src.name, f
-0000abe0: 696c 655b 313a 5d29 0a20 2020 2020 2020  ile[1:]).       
-0000abf0: 206f 732e 6d61 6b65 6469 7273 286f 732e   os.makedirs(os.
-0000ac00: 7061 7468 2e64 6972 6e61 6d65 2866 7061  path.dirname(fpa
-0000ac10: 7468 292c 2065 7869 7374 5f6f 6b3d 5472  th), exist_ok=Tr
-0000ac20: 7565 290a 2020 2020 2020 2020 7769 7468  ue).        with
-0000ac30: 206f 7065 6e28 6670 6174 682c 2027 7727   open(fpath, 'w'
-0000ac40: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-0000ac50: 2020 2020 662e 7772 6974 6528 2768 656c      f.write('hel
-0000ac60: 6c6f 2729 0a0a 2020 2020 2320 7465 7374  lo')..    # test
-0000ac70: 2070 7573 680a 2020 2020 6966 2069 7369   push.    if isi
-0000ac80: 6e73 7461 6e63 6528 6361 7365 2e70 6174  nstance(case.pat
-0000ac90: 682c 206c 6973 7429 3a0a 2020 2020 2020  h, list):.      
-0000aca0: 2020 2320 7377 6170 2073 6c61 7368 2066    # swap slash f
-0000acb0: 6f72 2064 756d 6d79 2064 6972 206f 6e20  or dummy dir on 
-0000acc0: 726f 6f74 2064 6972 2073 6f20 5061 7468  root dir so Path
-0000acd0: 2e70 6172 656e 7420 646f 6573 6e27 7420  .parent doesn't 
-0000ace0: 7265 7475 726e 2074 6d70 6469 7220 7061  return tmpdir pa
-0000acf0: 7468 2063 6f6d 706f 6e65 6e74 0a20 2020  th component.   
-0000ad00: 2020 2020 2023 206f 7468 6572 7769 7365       # otherwise
-0000ad10: 2072 656d 6f76 6520 6c65 6164 696e 6720   remove leading 
-0000ad20: 736c 6173 6820 736f 2077 6520 6361 6e20  slash so we can 
-0000ad30: 646f 2074 6865 2070 6174 6820 6a6f 696e  do the path join
-0000ad40: 2070 726f 7065 726c 792e 0a20 2020 2020   properly..     
-0000ad50: 2020 2070 7573 685f 7061 7468 203d 205b     push_path = [
-0000ad60: 6f73 2e70 6174 682e 6a6f 696e 2870 7573  os.path.join(pus
-0000ad70: 685f 7372 632e 6e61 6d65 2c20 705b 313a  h_src.name, p[1:
-0000ad80: 5d20 6966 206c 656e 2870 2920 3e20 3120  ] if len(p) > 1 
-0000ad90: 656c 7365 2027 666f 6f27 290a 2020 2020  else 'foo').    
-0000ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adb0: 2066 6f72 2070 2069 6e20 6361 7365 2e70   for p in case.p
-0000adc0: 6174 685d 0a20 2020 2065 6c73 653a 0a20  ath].    else:. 
-0000add0: 2020 2020 2020 2023 2073 7761 7020 736c         # swap sl
-0000ade0: 6173 6820 666f 7220 6475 6d6d 7920 6469  ash for dummy di
-0000adf0: 7220 6f6e 2072 6f6f 7420 6469 7220 736f  r on root dir so
-0000ae00: 2050 6174 682e 7061 7265 6e74 2064 6f65   Path.parent doe
-0000ae10: 736e 2774 2072 6574 7572 6e20 746d 7064  sn't return tmpd
-0000ae20: 6972 2070 6174 6820 636f 6d70 6f6e 656e  ir path componen
-0000ae30: 740a 2020 2020 2020 2020 2320 6f74 6865  t.        # othe
-0000ae40: 7277 6973 6520 7265 6d6f 7665 206c 6561  rwise remove lea
-0000ae50: 6469 6e67 2073 6c61 7368 2073 6f20 7765  ding slash so we
-0000ae60: 2063 616e 2064 6f20 7468 6520 7061 7468   can do the path
-0000ae70: 206a 6f69 6e20 7072 6f70 6572 6c79 2e0a   join properly..
-0000ae80: 2020 2020 2020 2020 7075 7368 5f70 6174          push_pat
-0000ae90: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-0000aea0: 2870 7573 685f 7372 632e 6e61 6d65 2c20  (push_src.name, 
-0000aeb0: 6361 7365 2e70 6174 685b 313a 5d20 6966  case.path[1:] if
-0000aec0: 206c 656e 2863 6173 652e 7061 7468 2920   len(case.path) 
-0000aed0: 3e20 3120 656c 7365 2027 666f 6f27 290a  > 1 else 'foo').
-0000aee0: 0a20 2020 2065 7272 6f72 7320 3d20 5b5d  .    errors = []
-0000aef0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-0000af00: 2020 632e 7075 7368 5f70 6174 6828 7075    c.push_path(pu
-0000af10: 7368 5f70 6174 682c 2063 6173 652e 6473  sh_path, case.ds
-0000af20: 7429 0a20 2020 2065 7863 6570 7420 6f70  t).    except op
-0000af30: 732e 4d75 6c74 6950 7573 6850 756c 6c45  s.MultiPushPullE
-0000af40: 7272 6f72 2061 7320 6572 723a 0a20 2020  rror as err:.   
-0000af50: 2020 2020 2069 6620 6e6f 7420 6361 7365       if not case
-0000af60: 2e65 7272 6f72 733a 0a20 2020 2020 2020  .errors:.       
-0000af70: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-0000af80: 2020 2065 7272 6f72 7320 3d20 7b73 7263     errors = {src
-0000af90: 5b6c 656e 2870 7573 685f 7372 632e 6e61  [len(push_src.na
-0000afa0: 6d65 293a 5d20 666f 7220 7372 632c 205f  me):] for src, _
-0000afb0: 2069 6e20 6572 722e 6572 726f 7273 7d0a   in err.errors}.
-0000afc0: 0a20 2020 2061 7373 6572 7420 6361 7365  .    assert case
-0000afd0: 2e65 7272 6f72 7320 3d3d 2065 7272 6f72  .errors == error
-0000afe0: 732c 205c 0a20 2020 2020 2020 2066 2770  s, \.        f'p
-0000aff0: 7573 685f 7061 7468 2067 6176 6520 7772  ush_path gave wr
-0000b000: 6f6e 6720 6578 7065 6374 6564 2065 7272  ong expected err
-0000b010: 6f72 733a 2077 616e 7420 7b63 6173 652e  ors: want {case.
-0000b020: 6572 726f 7273 7d2c 2067 6f74 207b 6572  errors}, got {er
-0000b030: 726f 7273 7d27 0a20 2020 2066 6f72 2066  rors}'.    for f
-0000b040: 7061 7468 2069 6e20 6361 7365 2e77 616e  path in case.wan
-0000b050: 743a 0a20 2020 2020 2020 2061 7373 6572  t:.        asser
-0000b060: 7420 632e 6578 6973 7473 2866 7061 7468  t c.exists(fpath
-0000b070: 292c 2066 2770 7573 685f 7061 7468 2066  ), f'push_path f
-0000b080: 6169 6c65 643a 2066 696c 6520 7b66 7061  ailed: file {fpa
-0000b090: 7468 7d20 6d69 7373 696e 6720 6174 2064  th} missing at d
-0000b0a0: 6573 7469 6e61 7469 6f6e 270a 0a20 2020  estination'..   
-0000b0b0: 2023 2063 7265 6174 6520 7075 6c6c 2074   # create pull t
-0000b0c0: 6573 7420 6361 7365 2066 696c 6573 7973  est case filesys
-0000b0d0: 7465 6d20 7374 7275 6374 7572 650a 2020  tem structure.  
-0000b0e0: 2020 7075 6c6c 5f64 7374 203d 2074 656d    pull_dst = tem
-0000b0f0: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
-0000b100: 6972 6563 746f 7279 2829 0a20 2020 2066  irectory().    f
-0000b110: 6f72 2066 7061 7468 2069 6e20 6361 7365  or fpath in case
-0000b120: 2e66 696c 6573 3a0a 2020 2020 2020 2020  .files:.        
-0000b130: 632e 7075 7368 2866 7061 7468 2c20 2768  c.push(fpath, 'h
-0000b140: 656c 6c6f 272c 206d 616b 655f 6469 7273  ello', make_dirs
-0000b150: 3d54 7275 6529 0a0a 2020 2020 2320 7465  =True)..    # te
-0000b160: 7374 2070 756c 6c0a 2020 2020 6572 726f  st pull.    erro
-0000b170: 7273 203d 205b 5d0a 2020 2020 7472 793a  rs = [].    try:
-0000b180: 0a20 2020 2020 2020 2063 2e70 756c 6c5f  .        c.pull_
-0000b190: 7061 7468 2863 6173 652e 7061 7468 2c20  path(case.path, 
-0000b1a0: 6f73 2e70 6174 682e 6a6f 696e 2870 756c  os.path.join(pul
-0000b1b0: 6c5f 6473 742e 6e61 6d65 2c20 6361 7365  l_dst.name, case
-0000b1c0: 2e64 7374 5b31 3a5d 2929 0a20 2020 2065  .dst[1:])).    e
-0000b1d0: 7863 6570 7420 6f70 732e 4d75 6c74 6950  xcept ops.MultiP
-0000b1e0: 7573 6850 756c 6c45 7272 6f72 2061 7320  ushPullError as 
-0000b1f0: 6572 723a 0a20 2020 2020 2020 2069 6620  err:.        if 
-0000b200: 6e6f 7420 6361 7365 2e65 7272 6f72 733a  not case.errors:
-0000b210: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000b220: 7365 0a20 2020 2020 2020 2065 7272 6f72  se.        error
-0000b230: 7320 3d20 7b73 7263 2066 6f72 2073 7263  s = {src for src
-0000b240: 2c20 5f20 696e 2065 7272 2e65 7272 6f72  , _ in err.error
-0000b250: 737d 0a0a 2020 2020 6173 7365 7274 2063  s}..    assert c
-0000b260: 6173 652e 6572 726f 7273 203d 3d20 6572  ase.errors == er
-0000b270: 726f 7273 2c20 5c0a 2020 2020 2020 2020  rors, \.        
-0000b280: 6627 7075 6c6c 5f70 6174 6820 6761 7665  f'pull_path gave
-0000b290: 2077 726f 6e67 2065 7870 6563 7465 6420   wrong expected 
-0000b2a0: 6572 726f 7273 3a20 7761 6e74 207b 6361  errors: want {ca
-0000b2b0: 7365 2e65 7272 6f72 737d 2c20 676f 7420  se.errors}, got 
-0000b2c0: 7b65 7272 6f72 737d 270a 2020 2020 666f  {errors}'.    fo
-0000b2d0: 7220 6670 6174 6820 696e 2063 6173 652e  r fpath in case.
-0000b2e0: 7761 6e74 3a0a 2020 2020 2020 2020 6173  want:.        as
-0000b2f0: 7365 7274 2063 2e65 7869 7374 7328 6670  sert c.exists(fp
-0000b300: 6174 6829 2c20 6627 7075 6c6c 5f70 6174  ath), f'pull_pat
-0000b310: 6820 6661 696c 6564 3a20 6669 6c65 207b  h failed: file {
-0000b320: 6670 6174 687d 206d 6973 7369 6e67 2061  fpath} missing a
-0000b330: 7420 6465 7374 696e 6174 696f 6e27 0a0a  t destination'..
-0000b340: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-0000b350: 7261 6d65 7472 697a 6528 2763 6173 6527  rametrize('case'
-0000b360: 2c20 5b0a 2020 2020 5075 7368 5075 6c6c  , [.    PushPull
-0000b370: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
-0000b380: 6d65 3d27 7075 7368 2064 6972 6563 746f  me='push directo
-0000b390: 7279 2077 6974 686f 7574 2074 7261 696c  ry without trail
-0000b3a0: 696e 6720 736c 6173 6827 2c0a 2020 2020  ing slash',.    
-0000b3b0: 2020 2020 7061 7468 3d27 666f 6f27 2c0a      path='foo',.
-0000b3c0: 2020 2020 2020 2020 6473 743d 272f 6261          dst='/ba
-0000b3d0: 7a27 2c0a 2020 2020 2020 2020 6669 6c65  z',.        file
-0000b3e0: 733d 5b27 666f 6f2f 6261 722f 6261 7a2e  s=['foo/bar/baz.
-0000b3f0: 7478 7427 2c20 2766 6f6f 2f66 6f6f 6261  txt', 'foo/fooba
-0000b400: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
-0000b410: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
-0000b420: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
-0000b430: 6261 7a2f 666f 6f2f 6261 722f 6261 7a2e  baz/foo/bar/baz.
-0000b440: 7478 7427 7d2c 0a20 2020 2029 2c0a 2020  txt'},.    ),.  
-0000b450: 2020 5075 7368 5075 6c6c 4361 7365 280a    PushPullCase(.
-0000b460: 2020 2020 2020 2020 6e61 6d65 3d27 7075          name='pu
-0000b470: 7368 2064 6972 6563 746f 7279 2077 6974  sh directory wit
-0000b480: 6820 7472 6169 6c69 6e67 2073 6c61 7368  h trailing slash
-0000b490: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
-0000b4a0: 2766 6f6f 2f27 2c0a 2020 2020 2020 2020  'foo/',.        
-0000b4b0: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
-0000b4c0: 2020 2020 6669 6c65 733d 5b27 666f 6f2f      files=['foo/
-0000b4d0: 6261 722f 6261 7a2e 7478 7427 2c20 2766  bar/baz.txt', 'f
-0000b4e0: 6f6f 2f66 6f6f 6261 722e 7478 7427 5d2c  oo/foobar.txt'],
-0000b4f0: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
-0000b500: 2f62 617a 2f66 6f6f 2f66 6f6f 6261 722e  /baz/foo/foobar.
-0000b510: 7478 7427 2c20 272f 6261 7a2f 666f 6f2f  txt', '/baz/foo/
-0000b520: 6261 722f 6261 7a2e 7478 7427 7d2c 0a20  bar/baz.txt'},. 
-0000b530: 2020 2029 2c0a 2020 2020 5075 7368 5075     ),.    PushPu
-0000b540: 6c6c 4361 7365 280a 2020 2020 2020 2020  llCase(.        
-0000b550: 6e61 6d65 3d27 7075 7368 2064 6972 6563  name='push direc
-0000b560: 746f 7279 2072 656c 6174 6976 6520 7061  tory relative pa
-0000b570: 7468 696e 6727 2c0a 2020 2020 2020 2020  thing',.        
-0000b580: 7061 7468 3d27 2e2f 666f 6f27 2c0a 2020  path='./foo',.  
-0000b590: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
-0000b5a0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
-0000b5b0: 5b27 666f 6f2f 6261 722f 6261 7a2e 7478  ['foo/bar/baz.tx
-0000b5c0: 7427 2c20 2766 6f6f 2f66 6f6f 6261 722e  t', 'foo/foobar.
-0000b5d0: 7478 7427 5d2c 0a20 2020 2020 2020 2077  txt'],.        w
-0000b5e0: 616e 743d 7b27 2f62 617a 2f66 6f6f 2f66  ant={'/baz/foo/f
-0000b5f0: 6f6f 6261 722e 7478 7427 2c20 272f 6261  oobar.txt', '/ba
-0000b600: 7a2f 666f 6f2f 6261 722f 6261 7a2e 7478  z/foo/bar/baz.tx
-0000b610: 7427 7d2c 0a20 2020 2029 2c0a 5d29 0a64  t'},.    ),.]).d
-0000b620: 6566 2074 6573 745f 7075 7368 5f70 6174  ef test_push_pat
-0000b630: 685f 7265 6c61 7469 7665 2863 6173 6529  h_relative(case)
-0000b640: 3a0a 2020 2020 6861 726e 6573 7320 3d20  :.    harness = 
-0000b650: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
-0000b660: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
-0000b670: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
-0000b680: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-0000b690: 7070 0a20 2020 2020 2020 2063 6f6e 7461  pp.        conta
-0000b6a0: 696e 6572 733a 0a20 2020 2020 2020 2020  iners:.         
-0000b6b0: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
-0000b6c0: 2020 7265 736f 7572 6365 3a20 666f 6f2d    resource: foo-
-0000b6d0: 696d 6167 650a 2020 2020 2020 2020 2727  image.        ''
-0000b6e0: 2729 0a20 2020 2068 6172 6e65 7373 2e62  ').    harness.b
-0000b6f0: 6567 696e 2829 0a20 2020 2068 6172 6e65  egin().    harne
-0000b700: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
-0000b710: 6374 2827 666f 6f27 2c20 5472 7565 290a  ct('foo', True).
-0000b720: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
-0000b730: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
-0000b740: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
-0000b750: 6f6f 275d 0a0a 2020 2020 7769 7468 2074  oo']..    with t
-0000b760: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
-0000b770: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
-0000b780: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
-0000b790: 6377 6420 3d20 6f73 2e67 6574 6377 6428  cwd = os.getcwd(
-0000b7a0: 290a 2020 2020 2020 2020 2320 6368 616e  ).        # chan
-0000b7b0: 6765 2077 6f72 6b69 6e67 2064 6972 6563  ge working direc
-0000b7c0: 746f 7279 2074 6f20 656e 6162 6c65 2072  tory to enable r
-0000b7d0: 656c 6174 6976 6520 7061 7468 696e 6720  elative pathing 
-0000b7e0: 666f 7220 7465 7374 696e 670a 2020 2020  for testing.    
-0000b7f0: 2020 2020 6f73 2e63 6864 6972 2874 6d70      os.chdir(tmp
-0000b800: 6469 7229 0a20 2020 2020 2020 2074 7279  dir).        try
-0000b810: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000b820: 6372 6561 7465 2074 6573 7420 6669 6c65  create test file
-0000b830: 7320 756e 6465 7220 7465 6d70 6f72 6172  s under temporar
-0000b840: 7920 7465 7374 2064 6972 6563 746f 7279  y test directory
-0000b850: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
-0000b860: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-0000b870: 746d 7064 6972 290a 2020 2020 2020 2020  tmpdir).        
-0000b880: 2020 2020 666f 7220 7465 7374 6669 6c65      for testfile
-0000b890: 2069 6e20 6361 7365 2e66 696c 6573 3a0a   in case.files:.
-0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8b0: 7465 7374 6669 6c65 5f70 6174 6820 3d20  testfile_path = 
-0000b8c0: 7061 7468 6c69 622e 5061 7468 2874 6d70  pathlib.Path(tmp
-0000b8d0: 202f 2074 6573 7466 696c 6529 0a20 2020   / testfile).   
-0000b8e0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
-0000b8f0: 7466 696c 655f 7061 7468 2e70 6172 656e  tfile_path.paren
-0000b900: 742e 6d6b 6469 7228 7061 7265 6e74 733d  t.mkdir(parents=
-0000b910: 5472 7565 2c20 6578 6973 745f 6f6b 3d54  True, exist_ok=T
-0000b920: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0000b930: 2020 2020 2074 6573 7466 696c 655f 7061       testfile_pa
-0000b940: 7468 2e74 6f75 6368 2865 7869 7374 5f6f  th.touch(exist_o
-0000b950: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
-0000b960: 2020 2020 2020 2020 7465 7374 6669 6c65          testfile
-0000b970: 5f70 6174 682e 7772 6974 655f 7465 7874  _path.write_text
-0000b980: 2822 7465 7374 222c 2065 6e63 6f64 696e  ("test", encodin
-0000b990: 673d 2275 7466 2d38 2229 0a0a 2020 2020  g="utf-8")..    
-0000b9a0: 2020 2020 2020 2020 2320 7075 7368 2070          # push p
-0000b9b0: 6174 6820 756e 6465 7220 7465 7374 2074  ath under test t
-0000b9c0: 6f20 636f 6e74 6169 6e65 720a 2020 2020  o container.    
-0000b9d0: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
-0000b9e0: 722e 7075 7368 5f70 6174 6828 6361 7365  r.push_path(case
-0000b9f0: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
-0000ba00: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000ba10: 7465 7374 0a20 2020 2020 2020 2020 2020  test.           
-0000ba20: 2066 6f72 2077 616e 745f 7061 7468 2069   for want_path i
-0000ba30: 6e20 6361 7365 2e77 616e 743a 0a20 2020  n case.want:.   
-0000ba40: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000ba50: 7465 6e74 203d 2063 6f6e 7461 696e 6572  tent = container
-0000ba60: 2e70 756c 6c28 7761 6e74 5f70 6174 6829  .pull(want_path)
-0000ba70: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
-0000ba80: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0000ba90: 6f6e 7465 6e74 203d 3d20 2774 6573 7427  ontent == 'test'
-0000baa0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-0000bab0: 3a0a 2020 2020 2020 2020 2020 2020 6f73  :.            os
-0000bac0: 2e63 6864 6972 2863 7764 290a 0a0a 636c  .chdir(cwd)...cl
-0000bad0: 6173 7320 5465 7374 4170 706c 6963 6174  ass TestApplicat
-0000bae0: 696f 6e28 756e 6974 7465 7374 2e54 6573  ion(unittest.Tes
-0000baf0: 7443 6173 6529 3a0a 0a20 2020 2064 6566  tCase):..    def
-0000bb00: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
-0000bb10: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000bb20: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0000bb30: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-0000bb40: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-0000bb50: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0000bb60: 653a 206d 7961 7070 0a20 2020 2020 2020  e: myapp.       
-0000bb70: 2020 2020 2070 726f 7669 6465 733a 0a20       provides:. 
-0000bb80: 2020 2020 2020 2020 2020 2020 2064 6230               db0
-0000bb90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bba0: 2020 696e 7465 7266 6163 653a 2064 6230    interface: db0
-0000bbb0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-0000bbc0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-0000bbd0: 2020 2020 2064 6231 3a0a 2020 2020 2020       db1:.      
-0000bbe0: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-0000bbf0: 6163 653a 2064 6231 0a20 2020 2020 2020  ace: db1.       
-0000bc00: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
-0000bc10: 2020 2020 2020 2020 2020 6462 323a 0a20            db2:. 
-0000bc20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000bc30: 6e74 6572 6661 6365 3a20 6462 320a 2020  nterface: db2.  
-0000bc40: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-0000bc50: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0000bc60: 2020 2066 6f6f 3a20 7b74 7970 653a 2066     foo: {type: f
-0000bc70: 696c 652c 2066 696c 656e 616d 653a 2066  ile, filename: f
-0000bc80: 6f6f 2e74 7874 7d0a 2020 2020 2020 2020  oo.txt}.        
-0000bc90: 2020 2020 2020 6261 723a 207b 7479 7065        bar: {type
-0000bca0: 3a20 6669 6c65 2c20 6669 6c65 6e61 6d65  : file, filename
-0000bcb0: 3a20 6261 722e 7478 747d 0a20 2020 2020  : bar.txt}.     
-0000bcc0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
-0000bcd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000bce0: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
-0000bcf0: 2020 2020 2020 6b3a 2076 0a20 2020 2020        k: v.     
-0000bd00: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-0000bd10: 7365 6c66 2e70 6565 725f 7265 6c5f 6964  self.peer_rel_id
-0000bd20: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-0000bd30: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-0000bd40: 3227 2c20 2764 6232 2729 0a20 2020 2020  2', 'db2').     
-0000bd50: 2020 2073 656c 662e 6170 7020 3d20 7365     self.app = se
-0000bd60: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
-0000bd70: 2e61 7070 0a20 2020 2020 2020 2073 656c  .app.        sel
-0000bd80: 662e 6164 6443 6c65 616e 7570 2873 656c  f.addCleanup(sel
-0000bd90: 662e 6861 726e 6573 732e 636c 6561 6e75  f.harness.cleanu
-0000bda0: 7029 0a0a 2020 2020 2320 5465 7374 7320  p)..    # Tests 
-0000bdb0: 6669 7820 666f 7220 6874 7470 733a 2f2f  fix for https://
-0000bdc0: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
-0000bdd0: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
-0000bde0: 7375 6573 2f36 3934 2e0a 2020 2020 6465  sues/694..    de
-0000bdf0: 6620 7465 7374 5f6d 6f63 6b65 645f 6765  f test_mocked_ge
-0000be00: 745f 7365 7276 6963 6573 2873 656c 6629  t_services(self)
-0000be10: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-0000be20: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-0000be30: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-0000be40: 6573 732e 7365 745f 6361 6e5f 636f 6e6e  ess.set_can_conn
-0000be50: 6563 7428 2762 6172 272c 2054 7275 6529  ect('bar', True)
-0000be60: 0a20 2020 2020 2020 2063 203d 2073 656c  .        c = sel
-0000be70: 662e 6861 726e 6573 732e 6368 6172 6d2e  f.harness.charm.
-0000be80: 756e 6974 2e67 6574 5f63 6f6e 7461 696e  unit.get_contain
-0000be90: 6572 2827 6261 7227 290a 2020 2020 2020  er('bar').      
-0000bea0: 2020 632e 6164 645f 6c61 7965 7228 276c    c.add_layer('l
-0000beb0: 6179 6572 3127 2c20 7b0a 2020 2020 2020  ayer1', {.      
-0000bec0: 2020 2020 2020 2773 756d 6d61 7279 273a        'summary':
-0000bed0: 2027 6c61 7965 7227 2c0a 2020 2020 2020   'layer',.      
-0000bee0: 2020 2020 2020 2773 6572 7669 6365 7327        'services'
-0000bef0: 3a20 7b22 6261 7a22 3a20 7b27 6f76 6572  : {"baz": {'over
-0000bf00: 7269 6465 273a 2027 7265 706c 6163 6527  ride': 'replace'
-0000bf10: 2c20 2773 756d 6d61 7279 273a 2027 6563  , 'summary': 'ec
-0000bf20: 686f 272c 2027 636f 6d6d 616e 6427 3a20  ho', 'command': 
-0000bf30: 2765 6368 6f20 3127 7d7d 2c0a 2020 2020  'echo 1'}},.    
-0000bf40: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
-0000bf50: 7320 3d20 632e 6765 745f 7365 7276 6963  s = c.get_servic
-0000bf60: 6528 2762 617a 2729 2020 2320 536f 2066  e('baz')  # So f
-0000bf70: 6172 2c20 736f 2067 6f6f 640a 2020 2020  ar, so good.    
-0000bf80: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000bf90: 7275 6528 7329 0a20 2020 2020 2020 2073  rue(s).        s
-0000bfa0: 656c 662e 6173 7365 7274 5472 7565 2827  elf.assertTrue('
-0000bfb0: 6261 7a27 2069 6e20 632e 6765 745f 7365  baz' in c.get_se
-0000bfc0: 7276 6963 6573 2829 290a 0a20 2020 2064  rvices())..    d
-0000bfd0: 6566 2074 6573 745f 706c 616e 6e65 645f  ef test_planned_
-0000bfe0: 756e 6974 7328 7365 6c66 293a 0a20 2020  units(self):.   
-0000bff0: 2020 2020 2072 656c 5f69 6420 3d20 7365       rel_id = se
-0000c000: 6c66 2e70 6565 725f 7265 6c5f 6964 0a0a  lf.peer_rel_id..
-0000c010: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
-0000c020: 6861 7420 7765 2061 6c77 6179 7320 636f  hat we always co
-0000c030: 756e 7420 6f75 7273 656c 662e 0a20 2020  unt ourself..   
-0000c040: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000c050: 4571 7561 6c28 7365 6c66 2e61 7070 2e70  Equal(self.app.p
-0000c060: 6c61 6e6e 6564 5f75 6e69 7473 2829 2c20  lanned_units(), 
-0000c070: 3129 0a0a 2020 2020 2020 2020 2320 4164  1)..        # Ad
-0000c080: 6420 736f 6d65 2075 6e69 7473 2c20 616e  d some units, an
-0000c090: 6420 7665 7269 6679 2063 6f75 6e74 2e0a  d verify count..
-0000c0a0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-0000c0b0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0000c0c0: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
-0000c0d0: 6d79 6170 702f 3127 290a 2020 2020 2020  myapp/1').      
-0000c0e0: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
-0000c0f0: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-0000c100: 2872 656c 5f69 642c 2027 6d79 6170 702f  (rel_id, 'myapp/
-0000c110: 3227 290a 0a20 2020 2020 2020 2073 656c  2')..        sel
-0000c120: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000c130: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
-0000c140: 6e69 7473 2829 2c20 3329 0a0a 2020 2020  nits(), 3)..    
-0000c150: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0000c160: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-0000c170: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
-0000c180: 702f 3327 290a 2020 2020 2020 2020 7365  p/3').        se
-0000c190: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000c1a0: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
-0000c1b0: 756e 6974 7328 292c 2034 290a 0a20 2020  units(), 4)..   
-0000c1c0: 2020 2020 2023 2041 6e64 2072 656d 6f76       # And remov
-0000c1d0: 6520 6120 756e 6974 0a20 2020 2020 2020  e a unit.       
-0000c1e0: 2073 656c 662e 6861 726e 6573 732e 7265   self.harness.re
-0000c1f0: 6d6f 7665 5f72 656c 6174 696f 6e5f 756e  move_relation_un
-0000c200: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
-0000c210: 702f 3227 290a 0a20 2020 2020 2020 2073  p/2')..        s
-0000c220: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000c230: 7365 6c66 2e61 7070 2e70 6c61 6e6e 6564  self.app.planned
-0000c240: 5f75 6e69 7473 2829 2c20 3329 0a0a 2020  _units(), 3)..  
-0000c250: 2020 6465 6620 7465 7374 5f70 6c61 6e6e    def test_plann
-0000c260: 6564 5f75 6e69 7473 5f75 7365 725f 7365  ed_units_user_se
-0000c270: 7428 7365 6c66 293a 0a0a 2020 2020 2020  t(self):..      
-0000c280: 2020 7365 6c66 2e68 6172 6e65 7373 2e73    self.harness.s
-0000c290: 6574 5f70 6c61 6e6e 6564 5f75 6e69 7473  et_planned_units
-0000c2a0: 2831 290a 2020 2020 2020 2020 7365 6c66  (1).        self
-0000c2b0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000c2c0: 662e 6170 702e 706c 616e 6e65 645f 756e  f.app.planned_un
-0000c2d0: 6974 7328 292c 2031 290a 0a20 2020 2020  its(), 1)..     
-0000c2e0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-0000c2f0: 7365 745f 706c 616e 6e65 645f 756e 6974  set_planned_unit
-0000c300: 7328 3229 0a20 2020 2020 2020 2073 656c  s(2).        sel
-0000c310: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000c320: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
-0000c330: 6e69 7473 2829 2c20 3229 0a0a 2020 2020  nits(), 2)..    
-0000c340: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0000c350: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
-0000c360: 7473 2831 3030 290a 2020 2020 2020 2020  ts(100).        
-0000c370: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c380: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
-0000c390: 645f 756e 6974 7328 292c 2031 3030 290a  d_units(), 100).
-0000c3a0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
-0000c3b0: 616e 6e65 645f 756e 6974 735f 6761 7262  anned_units_garb
-0000c3c0: 6167 655f 7661 6c75 6573 2873 656c 6629  age_values(self)
-0000c3d0: 3a0a 2020 2020 2020 2020 2320 506c 616e  :.        # Plan
-0000c3e0: 6e65 6420 756e 6974 7320 7368 6f75 6c64  ned units should
-0000c3f0: 2062 6520 6120 706f 7369 7469 7665 2069   be a positive i
-0000c400: 6e74 6567 6572 2c20 6f72 207a 6572 6f2e  nteger, or zero.
-0000c410: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0000c420: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0000c430: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
-0000c440: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-0000c450: 6e65 7373 2e73 6574 5f70 6c61 6e6e 6564  ness.set_planned
-0000c460: 5f75 6e69 7473 282d 3129 0a20 2020 2020  _units(-1).     
-0000c470: 2020 2023 2056 6572 6966 7920 7468 6174     # Verify that
-0000c480: 2077 6520 6469 646e 2774 2073 6574 206f   we didn't set o
-0000c490: 7572 2076 616c 7565 2062 6566 6f72 6520  ur value before 
-0000c4a0: 7261 6973 696e 6720 7468 6520 6572 726f  raising the erro
-0000c4b0: 722e 0a20 2020 2020 2020 2073 656c 662e  r..        self.
-0000c4c0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
-0000c4d0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
-0000c4e0: 2e5f 706c 616e 6e65 645f 756e 6974 7320  ._planned_units 
-0000c4f0: 6973 204e 6f6e 6529 0a20 2020 2020 2020  is None).       
-0000c500: 2023 2056 6572 6966 7920 7468 6174 2077   # Verify that w
-0000c510: 6520 7374 696c 6c20 6765 7420 7468 6520  e still get the 
-0000c520: 6465 6661 756c 7420 7661 6c75 6520 6261  default value ba
-0000c530: 636b 2066 726f 6d20 2e70 6c61 6e6e 6564  ck from .planned
-0000c540: 5f75 6e69 7473 2e0a 2020 2020 2020 2020  _units..        
-0000c550: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c560: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
-0000c570: 645f 756e 6974 7328 292c 2031 290a 0a20  d_units(), 1).. 
-0000c580: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000c590: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
-0000c5a0: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-0000c5b0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000c5c0: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
-0000c5d0: 6e69 7473 2822 666f 6f22 290a 0a20 2020  nits("foo")..   
-0000c5e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000c5f0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0000c600: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000c610: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0000c620: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
-0000c630: 7473 282d 3334 3233 3030 3031 3032 3331  ts(-342300010231
-0000c640: 3233 3231 3039 3029 0a0a 2020 2020 6465  2321090)..    de
-0000c650: 6620 7465 7374 5f70 6c61 6e6e 6564 5f75  f test_planned_u
-0000c660: 6e69 7473 5f6f 7665 7272 6964 6528 7365  nits_override(se
-0000c670: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-0000c680: 5665 7269 6679 2074 6861 7420 7765 206f  Verify that we o
-0000c690: 7665 7272 6964 6520 7468 6520 6361 6c63  verride the calc
-0000c6a0: 756c 6174 6564 2076 616c 7565 206f 6620  ulated value of 
-0000c6b0: 706c 616e 6e65 645f 756e 6974 7320 7768  planned_units wh
-0000c6c0: 656e 2077 6520 7365 7420 6974 206d 616e  en we set it man
-0000c6d0: 7561 6c6c 792e 0a0a 2020 2020 2020 2020  ually...        
-0000c6e0: 5768 656e 2061 2063 6861 726d 2061 7574  When a charm aut
-0000c6f0: 686f 7220 7772 6974 6573 2061 2074 6573  hor writes a tes
-0000c700: 7420 7468 6174 2065 7870 6c69 6369 746c  t that explicitl
-0000c710: 7920 6361 6c6c 7320 7365 745f 706c 616e  y calls set_plan
-0000c720: 6e65 645f 756e 6974 732c 2077 6520 6173  ned_units, we as
-0000c730: 7375 6d65 2074 6861 740a 2020 2020 2020  sume that.      
-0000c740: 2020 7468 6569 7220 696e 7465 6e74 2069    their intent i
-0000c750: 7320 746f 206f 7665 7272 6964 6520 7468  s to override th
-0000c760: 6520 6361 6c63 756c 6174 6564 2072 6574  e calculated ret
-0000c770: 7572 6e20 7661 6c75 652e 204f 6674 656e  urn value. Often
-0000c780: 2c20 7468 6973 2077 696c 6c20 6265 2062  , this will be b
-0000c790: 6563 6175 7365 2074 6865 0a20 2020 2020  ecause the.     
-0000c7a0: 2020 2063 6861 726d 2061 7574 686f 7220     charm author 
-0000c7b0: 6973 2063 6f6d 706f 7369 6e67 2061 2063  is composing a c
-0000c7c0: 6861 726d 2077 6974 686f 7574 2070 6565  harm without pee
-0000c7d0: 7220 7265 6c61 7469 6f6e 732c 2061 6e64  r relations, and
-0000c7e0: 2074 6865 2068 6172 6e65 7373 2773 2063   the harness's c
-0000c7f0: 6f75 6e74 206f 660a 2020 2020 2020 2020  ount of.        
-0000c800: 706c 616e 6e65 6420 756e 6974 732c 2077  planned units, w
-0000c810: 6869 6368 2069 7320 6261 7365 6420 6f6e  hich is based on
-0000c820: 2074 6865 206e 756d 6265 7220 6f66 2070   the number of p
-0000c830: 6565 7220 7265 6c61 7469 6f6e 732c 2077  eer relations, w
-0000c840: 696c 6c20 6e6f 7420 6265 2061 6363 7572  ill not be accur
-0000c850: 6174 652e 0a20 2020 2020 2020 2022 2222  ate..        """
-0000c860: 0a20 2020 2020 2020 2070 6565 725f 6964  .        peer_id
-0000c870: 203d 2073 656c 662e 7065 6572 5f72 656c   = self.peer_rel
-0000c880: 5f69 640a 0a20 2020 2020 2020 2073 656c  _id..        sel
-0000c890: 662e 6861 726e 6573 732e 7365 745f 706c  f.harness.set_pl
-0000c8a0: 616e 6e65 645f 756e 6974 7328 3130 290a  anned_units(10).
-0000c8b0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-0000c8c0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0000c8d0: 6e5f 756e 6974 2870 6565 725f 6964 2c20  n_unit(peer_id, 
-0000c8e0: 276d 7961 7070 2f31 2729 0a20 2020 2020  'myapp/1').     
-0000c8f0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-0000c900: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-0000c910: 7428 7065 6572 5f69 642c 2027 6d79 6170  t(peer_id, 'myap
-0000c920: 702f 3227 290a 2020 2020 2020 2020 7365  p/2').        se
-0000c930: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-0000c940: 656c 6174 696f 6e5f 756e 6974 2870 6565  elation_unit(pee
-0000c950: 725f 6964 2c20 276d 7961 7070 2f33 2729  r_id, 'myapp/3')
-0000c960: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0000c970: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000c980: 6170 702e 706c 616e 6e65 645f 756e 6974  app.planned_unit
-0000c990: 7328 292c 2031 3029 0a0a 2020 2020 2020  s(), 10)..      
-0000c9a0: 2020 2320 5665 7269 6679 2074 6861 7420    # Verify that 
-0000c9b0: 7765 2063 616e 2063 6c65 6172 2074 6865  we can clear the
-0000c9c0: 206f 7665 7272 6964 652e 0a20 2020 2020   override..     
-0000c9d0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-0000c9e0: 7265 7365 745f 706c 616e 6e65 645f 756e  reset_planned_un
-0000c9f0: 6974 7328 290a 2020 2020 2020 2020 7365  its().        se
-0000ca00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000ca10: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
-0000ca20: 756e 6974 7328 292c 2034 2920 2023 2073  units(), 4)  # s
-0000ca30: 656c 6620 2b20 3320 7065 6572 730a 0a0a  elf + 3 peers...
-0000ca40: 636c 6173 7320 5465 7374 436f 6e74 6169  class TestContai
-0000ca50: 6e65 7273 2875 6e69 7474 6573 742e 5465  ners(unittest.Te
-0000ca60: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-0000ca70: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
-0000ca80: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
-0000ca90: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
-0000caa0: 7961 6d6c 2822 2222 0a6e 616d 653a 206b  yaml(""".name: k
-0000cab0: 3873 2d63 6861 726d 0a63 6f6e 7461 696e  8s-charm.contain
-0000cac0: 6572 733a 0a20 2063 313a 0a20 2020 206b  ers:.  c1:.    k
-0000cad0: 3a20 760a 2020 6332 3a0a 2020 2020 6b3a  : v.  c2:.    k:
-0000cae0: 2076 0a22 2222 290a 2020 2020 2020 2020   v.""").        
-0000caf0: 6261 636b 656e 6420 3d20 5f4d 6f64 656c  backend = _Model
-0000cb00: 4261 636b 656e 6428 276d 7961 7070 2f30  Backend('myapp/0
-0000cb10: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000cb20: 6d6f 6465 6c20 3d20 6f70 732e 4d6f 6465  model = ops.Mode
-0000cb30: 6c28 6d65 7461 2c20 6261 636b 656e 6429  l(meta, backend)
-0000cb40: 0a0a 2020 2020 6465 6620 7465 7374 5f75  ..    def test_u
-0000cb50: 6e69 745f 636f 6e74 6169 6e65 7273 2873  nit_containers(s
-0000cb60: 656c 6629 3a0a 2020 2020 2020 2020 636f  elf):.        co
-0000cb70: 6e74 6169 6e65 7273 203d 2073 656c 662e  ntainers = self.
-0000cb80: 6d6f 6465 6c2e 756e 6974 2e63 6f6e 7461  model.unit.conta
-0000cb90: 696e 6572 730a 2020 2020 2020 2020 7365  iners.        se
-0000cba0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000cbb0: 6f72 7465 6428 636f 6e74 6169 6e65 7273  orted(containers
-0000cbc0: 292c 205b 2763 3127 2c20 2763 3227 5d29  ), ['c1', 'c2'])
-0000cbd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000cbe0: 7365 7274 4571 7561 6c28 6c65 6e28 636f  sertEqual(len(co
-0000cbf0: 6e74 6169 6e65 7273 292c 2032 290a 2020  ntainers), 2).  
-0000cc00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000cc10: 7449 6e28 2763 3127 2c20 636f 6e74 6169  tIn('c1', contai
-0000cc20: 6e65 7273 290a 2020 2020 2020 2020 7365  ners).        se
-0000cc30: 6c66 2e61 7373 6572 7449 6e28 2763 3227  lf.assertIn('c2'
-0000cc40: 2c20 636f 6e74 6169 6e65 7273 290a 2020  , containers).  
-0000cc50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000cc60: 744e 6f74 496e 2827 6333 272c 2063 6f6e  tNotIn('c3', con
-0000cc70: 7461 696e 6572 7329 0a20 2020 2020 2020  tainers).       
-0000cc80: 2066 6f72 206e 616d 6520 696e 205b 2763   for name in ['c
-0000cc90: 3127 2c20 2763 3227 5d3a 0a20 2020 2020  1', 'c2']:.     
-0000cca0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
-0000ccb0: 203d 2063 6f6e 7461 696e 6572 735b 6e61   = containers[na
-0000ccc0: 6d65 5d0a 2020 2020 2020 2020 2020 2020  me].            
-0000ccd0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-0000cce0: 7461 6e63 6528 636f 6e74 6169 6e65 722c  tance(container,
-0000ccf0: 206f 7073 2e43 6f6e 7461 696e 6572 290a   ops.Container).
-0000cd00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000cd10: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
-0000cd20: 7461 696e 6572 2e6e 616d 652c 206e 616d  tainer.name, nam
-0000cd30: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-0000cd40: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-0000cd50: 616e 6365 2863 6f6e 7461 696e 6572 2e70  ance(container.p
-0000cd60: 6562 626c 652c 2070 6562 626c 652e 436c  ebble, pebble.Cl
-0000cd70: 6965 6e74 290a 2020 2020 2020 2020 7769  ient).        wi
-0000cd80: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000cd90: 6973 6573 284b 6579 4572 726f 7229 3a0a  ises(KeyError):.
-0000cda0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000cdb0: 6169 6e65 7273 5b27 6333 275d 0a0a 2020  ainers['c3']..  
-0000cdc0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000cdd0: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0000cde0: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0000cdf0: 2020 2020 2020 2020 6f74 6865 725f 756e          other_un
-0000ce00: 6974 203d 2073 656c 662e 6d6f 6465 6c2e  it = self.model.
-0000ce10: 6765 745f 756e 6974 2827 6f74 6865 7227  get_unit('other'
-0000ce20: 290a 2020 2020 2020 2020 2020 2020 6f74  ).            ot
-0000ce30: 6865 725f 756e 6974 2e63 6f6e 7461 696e  her_unit.contain
-0000ce40: 6572 730a 0a20 2020 2064 6566 2074 6573  ers..    def tes
-0000ce50: 745f 756e 6974 5f67 6574 5f63 6f6e 7461  t_unit_get_conta
-0000ce60: 696e 6572 2873 656c 6629 3a0a 2020 2020  iner(self):.    
-0000ce70: 2020 2020 756e 6974 203d 2073 656c 662e      unit = self.
-0000ce80: 6d6f 6465 6c2e 756e 6974 0a20 2020 2020  model.unit.     
-0000ce90: 2020 2066 6f72 206e 616d 6520 696e 205b     for name in [
-0000cea0: 2763 3127 2c20 2763 3227 5d3a 0a20 2020  'c1', 'c2']:.   
-0000ceb0: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
-0000cec0: 6572 203d 2075 6e69 742e 6765 745f 636f  er = unit.get_co
-0000ced0: 6e74 6169 6e65 7228 6e61 6d65 290a 2020  ntainer(name).  
-0000cee0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0000cef0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-0000cf00: 636f 6e74 6169 6e65 722c 206f 7073 2e43  container, ops.C
-0000cf10: 6f6e 7461 696e 6572 290a 2020 2020 2020  ontainer).      
-0000cf20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000cf30: 7445 7175 616c 2863 6f6e 7461 696e 6572  tEqual(container
-0000cf40: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
-0000cf50: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-0000cf60: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
-0000cf70: 6f6e 7461 696e 6572 2e70 6562 626c 652c  ontainer.pebble,
-0000cf80: 2070 6562 626c 652e 436c 6965 6e74 290a   pebble.Client).
-0000cf90: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000cfa0: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
-0000cfb0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
-0000cfc0: 2020 2020 2020 2020 2020 2020 756e 6974              unit
-0000cfd0: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
-0000cfe0: 6333 2729 0a0a 2020 2020 2020 2020 7769  c3')..        wi
-0000cff0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000d000: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
-0000d010: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000d020: 6f74 6865 725f 756e 6974 203d 2073 656c  other_unit = sel
-0000d030: 662e 6d6f 6465 6c2e 6765 745f 756e 6974  f.model.get_unit
-0000d040: 2827 6f74 6865 7227 290a 2020 2020 2020  ('other').      
-0000d050: 2020 2020 2020 6f74 6865 725f 756e 6974        other_unit
-0000d060: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
-0000d070: 666f 6f27 290a 0a0a 636c 6173 7320 5465  foo')...class Te
-0000d080: 7374 436f 6e74 6169 6e65 7250 6562 626c  stContainerPebbl
-0000d090: 6528 756e 6974 7465 7374 2e54 6573 7443  e(unittest.TestC
-0000d0a0: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
-0000d0b0: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
-0000d0c0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
-0000d0d0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
-0000d0e0: 6c28 2222 220a 6e61 6d65 3a20 6b38 732d  l(""".name: k8s-
-0000d0f0: 6368 6172 6d0a 636f 6e74 6169 6e65 7273  charm.containers
-0000d100: 3a0a 2020 6331 3a0a 2020 2020 6b3a 2076  :.  c1:.    k: v
-0000d110: 0a22 2222 290a 2020 2020 2020 2020 6261  .""").        ba
-0000d120: 636b 656e 6420 3d20 4d6f 636b 5065 6262  ckend = MockPebb
-0000d130: 6c65 4261 636b 656e 6428 276d 7961 7070  leBackend('myapp
-0000d140: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
-0000d150: 662e 6d6f 6465 6c20 3d20 6f70 732e 4d6f  f.model = ops.Mo
-0000d160: 6465 6c28 6d65 7461 2c20 6261 636b 656e  del(meta, backen
-0000d170: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-0000d180: 636f 6e74 6169 6e65 7220 3d20 7365 6c66  container = self
-0000d190: 2e6d 6f64 656c 2e75 6e69 742e 636f 6e74  .model.unit.cont
-0000d1a0: 6169 6e65 7273 5b27 6331 275d 0a20 2020  ainers['c1'].   
-0000d1b0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000d1c0: 203d 2073 656c 662e 636f 6e74 6169 6e65   = self.containe
-0000d1d0: 722e 7065 6262 6c65 0a0a 2020 2020 6465  r.pebble..    de
-0000d1e0: 6620 7465 7374 5f73 6f63 6b65 745f 7061  f test_socket_pa
-0000d1f0: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
-0000d200: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000d210: 616c 2873 656c 662e 7065 6262 6c65 2e73  al(self.pebble.s
-0000d220: 6f63 6b65 745f 7061 7468 2c20 272f 6368  ocket_path, '/ch
-0000d230: 6172 6d2f 636f 6e74 6169 6e65 7273 2f63  arm/containers/c
-0000d240: 312f 7065 6262 6c65 2e73 6f63 6b65 7427  1/pebble.socket'
-0000d250: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000d260: 6175 746f 7374 6172 7428 7365 6c66 293a  autostart(self):
-0000d270: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0000d280: 6e74 6169 6e65 722e 6175 746f 7374 6172  ntainer.autostar
-0000d290: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000d2a0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000d2b0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-0000d2c0: 732c 205b 2827 6175 746f 7374 6172 7427  s, [('autostart'
-0000d2d0: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
-0000d2e0: 7374 5f72 6570 6c61 6e28 7365 6c66 293a  st_replan(self):
-0000d2f0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0000d300: 6e74 6169 6e65 722e 7265 706c 616e 2829  ntainer.replan()
-0000d310: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000d320: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000d330: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
-0000d340: 5b28 2772 6570 6c61 6e27 2c29 5d29 0a0a  [('replan',)])..
-0000d350: 2020 2020 6465 6620 7465 7374 5f63 616e      def test_can
-0000d360: 5f63 6f6e 6e65 6374 2873 656c 6629 3a0a  _connect(self):.
-0000d370: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000d380: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000d390: 7065 6e64 2870 6562 626c 652e 5379 7374  pend(pebble.Syst
-0000d3a0: 656d 496e 666f 2e66 726f 6d5f 6469 6374  emInfo.from_dict
-0000d3b0: 287b 2776 6572 7369 6f6e 273a 2027 312e  ({'version': '1.
-0000d3c0: 302e 3027 7d29 290a 2020 2020 2020 2020  0.0'})).        
-0000d3d0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000d3e0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e63  self.container.c
-0000d3f0: 616e 5f63 6f6e 6e65 6374 2829 290a 2020  an_connect()).  
-0000d400: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000d410: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-0000d420: 6c65 2e72 6571 7565 7374 732c 205b 2827  le.requests, [('
-0000d430: 6765 745f 7379 7374 656d 5f69 6e66 6f27  get_system_info'
-0000d440: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
-0000d450: 7374 5f73 7461 7274 2873 656c 6629 3a0a  st_start(self):.
-0000d460: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000d470: 7461 696e 6572 2e73 7461 7274 2827 666f  tainer.start('fo
-0000d480: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
-0000d490: 2e63 6f6e 7461 696e 6572 2e73 7461 7274  .container.start
-0000d4a0: 2827 666f 6f27 2c20 2762 6172 2729 0a20  ('foo', 'bar'). 
-0000d4b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d4c0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
-0000d4d0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
-0000d4e0: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
-0000d4f0: 6172 7427 2c20 2827 666f 6f27 2c29 292c  art', ('foo',)),
-0000d500: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
-0000d510: 7461 7274 272c 2028 2766 6f6f 272c 2027  tart', ('foo', '
-0000d520: 6261 7227 2929 2c0a 2020 2020 2020 2020  bar')),.        
-0000d530: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000d540: 5f73 7461 7274 5f6e 6f5f 6172 6775 6d65  _start_no_argume
-0000d550: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
-0000d560: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000d570: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0000d580: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000d590: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
-0000d5a0: 2e73 7461 7274 2829 0a0a 2020 2020 6465  .start()..    de
-0000d5b0: 6620 7465 7374 5f73 746f 7028 7365 6c66  f test_stop(self
-0000d5c0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000d5d0: 636f 6e74 6169 6e65 722e 7374 6f70 2827  container.stop('
-0000d5e0: 666f 6f27 290a 2020 2020 2020 2020 7365  foo').        se
-0000d5f0: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
-0000d600: 7028 2766 6f6f 272c 2027 6261 7227 290a  p('foo', 'bar').
-0000d610: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000d620: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
-0000d630: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
-0000d640: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
-0000d650: 746f 7027 2c20 2827 666f 6f27 2c29 292c  top', ('foo',)),
+00009ae0: 2020 2020 7061 7468 3d66 2c0a 2020 2020      path=f,.    
+00009af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b00: 6e61 6d65 3d6f 732e 7061 7468 2e62 6173  name=os.path.bas
+00009b10: 656e 616d 6528 6629 2c0a 2020 2020 2020  ename(f),.      
+00009b20: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00009b30: 7065 3d70 6562 626c 652e 4669 6c65 5479  pe=pebble.FileTy
+00009b40: 7065 2e46 494c 452c 0a20 2020 2020 2020  pe.FILE,.       
+00009b50: 2020 2020 2020 2020 2020 2020 202a 2a61               **a
+00009b60: 7267 7329 290a 0a20 2020 2020 2020 2020  rgs))..         
+00009b70: 2020 2023 2063 6f6c 6c65 6374 2061 6c6c     # collect all
+00009b80: 2074 6865 2064 6972 6563 746f 7269 6573   the directories
+00009b90: 2066 6f72 2074 6865 2074 6573 7420 6361   for the test ca
+00009ba0: 7365 2773 2066 696c 6573 0a20 2020 2020  se's files.     
+00009bb0: 2020 2020 2020 2064 6972 7061 7468 203d         dirpath =
+00009bc0: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
+00009bd0: 2866 290a 2020 2020 2020 2020 2020 2020  (f).            
+00009be0: 6966 2064 6972 7061 7468 2021 3d20 2727  if dirpath != ''
+00009bf0: 2061 6e64 2064 6972 7061 7468 206e 6f74   and dirpath not
+00009c00: 2069 6e20 6469 7273 3a0a 2020 2020 2020   in dirs:.      
+00009c10: 2020 2020 2020 2020 2020 6469 7273 2e75            dirs.u
+00009c20: 7064 6174 6528 6469 7270 6174 6829 0a20  pdate(dirpath). 
+00009c30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009c40: 696c 655f 696e 666f 732e 6170 7065 6e64  ile_infos.append
+00009c50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009c60: 2020 2020 2020 7065 6262 6c65 2e46 696c        pebble.Fil
+00009c70: 6549 6e66 6f28 0a20 2020 2020 2020 2020  eInfo(.         
+00009c80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00009c90: 6174 683d 6469 7270 6174 682c 0a20 2020  ath=dirpath,.   
+00009ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cb0: 2020 2020 206e 616d 653d 6f73 2e70 6174       name=os.pat
+00009cc0: 682e 6261 7365 6e61 6d65 2864 6972 7061  h.basename(dirpa
+00009cd0: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+00009ce0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00009cf0: 653d 7065 6262 6c65 2e46 696c 6554 7970  e=pebble.FileTyp
+00009d00: 652e 4449 5245 4354 4f52 592c 0a20 2020  e.DIRECTORY,.   
+00009d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d20: 2020 2020 202a 2a61 7267 7329 290a 0a20       **args)).. 
+00009d30: 2020 2020 2020 2064 6566 2069 6e6e 6572         def inner
+00009d40: 2870 6174 6829 3a0a 2020 2020 2020 2020  (path):.        
+00009d50: 2020 2020 7061 7468 203d 2073 7472 2870      path = str(p
+00009d60: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00009d70: 206d 6174 6368 6573 203d 205b 5d0a 2020   matches = [].  
+00009d80: 2020 2020 2020 2020 2020 666f 7220 696e            for in
+00009d90: 666f 2069 6e20 6669 6c65 5f69 6e66 6f73  fo in file_infos
+00009da0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009db0: 2020 2320 6578 636c 7564 6520 6669 6c65    # exclude file
+00009dc0: 2069 6e66 6f73 2066 6f72 2073 6570 6172   infos for separ
+00009dd0: 6174 6520 7472 6565 7320 616e 6420 616c  ate trees and al
+00009de0: 736f 0a20 2020 2020 2020 2020 2020 2020  so.             
+00009df0: 2020 2023 2066 6f72 2074 6865 2064 6972     # for the dir
+00009e00: 6563 746f 7279 2077 6520 6172 6520 6c69  ectory we are li
+00009e10: 7374 696e 6720 6974 7365 6c66 202d 2077  sting itself - w
+00009e20: 6520 6f6e 6c79 2077 616e 7420 6974 7320  e only want its 
+00009e30: 636f 6e74 656e 7473 2e0a 2020 2020 2020  contents..      
+00009e40: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00009e50: 2069 6e66 6f2e 7061 7468 2e73 7461 7274   info.path.start
+00009e60: 7377 6974 6828 7061 7468 2920 6f72 2028  swith(path) or (
+00009e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e80: 2020 2020 2020 2020 2069 6e66 6f2e 7479           info.ty
+00009e90: 7065 203d 3d20 7065 6262 6c65 2e46 696c  pe == pebble.Fil
+00009ea0: 6554 7970 652e 4449 5245 4354 4f52 5920  eType.DIRECTORY 
+00009eb0: 616e 6420 7061 7468 203d 3d20 696e 666f  and path == info
+00009ec0: 2e70 6174 6829 3a0a 2020 2020 2020 2020  .path):.        
+00009ed0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00009ee0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00009ef0: 2020 2020 2023 2065 7863 6c75 6465 2066       # exclude f
+00009f00: 696c 6520 696e 666f 7320 666f 7220 6669  ile infos for fi
+00009f10: 6c65 7320 7468 6174 2061 7265 2069 6e20  les that are in 
+00009f20: 7375 6264 6972 6563 746f 7269 6573 206f  subdirectories o
+00009f30: 6620 7061 7468 2e0a 2020 2020 2020 2020  f path..        
+00009f40: 2020 2020 2020 2020 2320 7765 206f 6e6c          # we onl
+00009f50: 7920 7761 6e74 2066 696c 6573 2074 6861  y want files tha
+00009f60: 7420 6172 6520 6469 7265 6374 6c79 2069  t are directly i
+00009f70: 6e20 7061 7468 2e0a 2020 2020 2020 2020  n path..        
+00009f80: 2020 2020 2020 2020 6966 2069 6e66 6f2e          if info.
+00009f90: 7061 7468 5b6c 656e 2870 6174 6829 3a5d  path[len(path):]
+00009fa0: 2e66 696e 6428 272f 2729 203e 2030 3a0a  .find('/') > 0:.
+00009fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009fc0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00009fd0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+00009fe0: 6368 6573 2e61 7070 656e 6428 696e 666f  ches.append(info
+00009ff0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000a000: 7475 726e 206d 6174 6368 6573 0a20 2020  turn matches.   
+0000a010: 2020 2020 2072 6574 7572 6e20 696e 6e65       return inne
+0000a020: 720a 0a20 2020 2023 2074 6573 7420 7261  r..    # test ra
+0000a030: 7720 6275 7369 6e65 7373 206c 6f67 6963  w business logic
+0000a040: 2066 6f72 2072 6563 7572 7369 6f6e 2061   for recursion a
+0000a050: 6e64 2064 6573 7420 7061 7468 2063 6f6e  nd dest path con
+0000a060: 7374 7275 6374 696f 6e0a 2020 2020 6669  struction.    fi
+0000a070: 6c65 7320 3d20 7365 7428 290a 2020 2020  les = set().    
+0000a080: 6361 7365 2e70 6174 6820 3d20 6f73 2e70  case.path = os.p
+0000a090: 6174 682e 6e6f 726d 7061 7468 2863 6173  ath.normpath(cas
+0000a0a0: 652e 7061 7468 290a 2020 2020 6361 7365  e.path).    case
+0000a0b0: 2e66 696c 6573 203d 205b 6f73 2e70 6174  .files = [os.pat
+0000a0c0: 682e 6e6f 726d 7061 7468 2866 2920 666f  h.normpath(f) fo
+0000a0d0: 7220 6620 696e 2063 6173 652e 6669 6c65  r f in case.file
+0000a0e0: 735d 0a20 2020 2063 6173 652e 7761 6e74  s].    case.want
+0000a0f0: 203d 207b 6f73 2e70 6174 682e 6e6f 726d   = {os.path.norm
+0000a100: 7061 7468 2866 2920 666f 7220 6620 696e  path(f) for f in
+0000a110: 2063 6173 652e 7761 6e74 7d0a 2020 2020   case.want}.    
+0000a120: 666f 7220 6620 696e 206f 7073 2e43 6f6e  for f in ops.Con
+0000a130: 7461 696e 6572 2e5f 6c69 7374 5f72 6563  tainer._list_rec
+0000a140: 7572 7369 7665 280a 2020 2020 2020 2020  ursive(.        
+0000a150: 6c69 7374 5f66 756e 635f 6765 6e28 0a20  list_func_gen(. 
+0000a160: 2020 2020 2020 2020 2020 2063 6173 652e             case.
+0000a170: 6669 6c65 7329 2c20 7061 7468 6c69 622e  files), pathlib.
+0000a180: 5061 7468 280a 2020 2020 2020 2020 2020  Path(.          
+0000a190: 2020 6361 7365 2e70 6174 6829 293a 0a20    case.path)):. 
+0000a1a0: 2020 2020 2020 2070 6174 6820 3d20 662e         path = f.
+0000a1b0: 7061 7468 0a20 2020 2020 2020 2069 6620  path.        if 
+0000a1c0: 6361 7365 2e64 7374 2069 7320 6e6f 7420  case.dst is not 
+0000a1d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a1e0: 2020 2320 7465 7374 2064 6573 7469 6e61    # test destina
+0000a1f0: 7469 6f6e 2070 6174 6820 636f 6e73 7472  tion path constr
+0000a200: 7563 7469 6f6e 0a20 2020 2020 2020 2020  uction.         
+0000a210: 2020 205f 2c20 7061 7468 203d 2066 2e70     _, path = f.p
+0000a220: 6174 682c 206f 7073 2e43 6f6e 7461 696e  ath, ops.Contain
+0000a230: 6572 2e5f 6275 696c 645f 6465 7374 7061  er._build_destpa
+0000a240: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
+0000a250: 2020 2020 662e 7061 7468 2c20 6361 7365      f.path, case
+0000a260: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
+0000a270: 0a20 2020 2020 2020 2066 696c 6573 2e61  .        files.a
+0000a280: 6464 2870 6174 6829 0a20 2020 2061 7373  dd(path).    ass
+0000a290: 6572 7420 6361 7365 2e77 616e 7420 3d3d  ert case.want ==
+0000a2a0: 2066 696c 6573 2c20 6627 6361 7365 207b   files, f'case {
+0000a2b0: 6361 7365 2e6e 616d 6521 727d 2068 6173  case.name!r} has
+0000a2c0: 2077 726f 6e67 2066 696c 6573 3a20 7761   wrong files: wa
+0000a2d0: 6e74 207b 6361 7365 2e77 616e 747d 2c20  nt {case.want}, 
+0000a2e0: 676f 7420 7b66 696c 6573 7d27 0a0a 0a72  got {files}'...r
+0000a2f0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
+0000a300: 6c6c 5f63 6173 6573 203d 205b 0a20 2020  ll_cases = [.   
+0000a310: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
+0000a320: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
+0000a330: 6963 2070 7573 682f 7075 6c6c 272c 0a20  ic push/pull',. 
+0000a340: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
+0000a350: 6f27 2c0a 2020 2020 2020 2020 6473 743d  o',.        dst=
+0000a360: 272f 6261 7a27 2c0a 2020 2020 2020 2020  '/baz',.        
+0000a370: 6669 6c65 733d 5b27 2f66 6f6f 2f62 6172  files=['/foo/bar
+0000a380: 2e74 7874 275d 2c0a 2020 2020 2020 2020  .txt'],.        
+0000a390: 7761 6e74 3d7b 272f 6261 7a2f 666f 6f2f  want={'/baz/foo/
+0000a3a0: 6261 722e 7478 7427 7d2c 0a20 2020 2029  bar.txt'},.    )
+0000a3b0: 2c0a 2020 2020 5075 7368 5075 6c6c 4361  ,.    PushPullCa
+0000a3c0: 7365 280a 2020 2020 2020 2020 6e61 6d65  se(.        name
+0000a3d0: 3d27 7075 7368 2f70 756c 6c20 2d20 7472  ='push/pull - tr
+0000a3e0: 6169 6c69 6e67 2073 6c61 7368 272c 0a20  ailing slash',. 
+0000a3f0: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
+0000a400: 6f2f 272c 0a20 2020 2020 2020 2064 7374  o/',.        dst
+0000a410: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a420: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
+0000a430: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
+0000a440: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
+0000a450: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
+0000a460: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+0000a470: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+0000a480: 653d 2762 6173 6963 2070 7573 682f 7075  e='basic push/pu
+0000a490: 6c6c 202d 2072 6f6f 7427 2c0a 2020 2020  ll - root',.    
+0000a4a0: 2020 2020 7061 7468 3d27 2f27 2c0a 2020      path='/',.  
+0000a4b0: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
+0000a4c0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
+0000a4d0: 5b27 2f66 6f6f 2f62 6172 2e74 7874 275d  ['/foo/bar.txt']
+0000a4e0: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
+0000a4f0: 272f 6261 7a2f 666f 6f2f 6261 722e 7478  '/baz/foo/bar.tx
+0000a500: 7427 7d2c 0a20 2020 2029 2c0a 2020 2020  t'},.    ),.    
+0000a510: 5075 7368 5075 6c6c 4361 7365 280a 2020  PushPullCase(.  
+0000a520: 2020 2020 2020 6e61 6d65 3d27 6261 7369        name='basi
+0000a530: 6320 7075 7368 2f70 756c 6c20 2d20 6d75  c push/pull - mu
+0000a540: 6c74 6963 6f6d 706f 6e65 6e74 2070 6174  lticomponent pat
+0000a550: 6827 2c0a 2020 2020 2020 2020 7061 7468  h',.        path
+0000a560: 3d27 2f66 6f6f 2f62 6172 272c 0a20 2020  ='/foo/bar',.   
+0000a570: 2020 2020 2064 7374 3d27 2f62 617a 272c       dst='/baz',
+0000a580: 0a20 2020 2020 2020 2066 696c 6573 3d5b  .        files=[
+0000a590: 272f 666f 6f2f 6261 722f 6261 7a2e 7478  '/foo/bar/baz.tx
+0000a5a0: 7427 5d2c 0a20 2020 2020 2020 2077 616e  t'],.        wan
+0000a5b0: 743d 7b27 2f62 617a 2f62 6172 2f62 617a  t={'/baz/bar/baz
+0000a5c0: 2e74 7874 277d 2c0a 2020 2020 292c 0a20  .txt'},.    ),. 
+0000a5d0: 2020 2050 7573 6850 756c 6c43 6173 6528     PushPullCase(
+0000a5e0: 0a20 2020 2020 2020 206e 616d 653d 2770  .        name='p
+0000a5f0: 7573 682f 7075 6c6c 2063 6f6e 7465 6e74  ush/pull content
+0000a600: 7327 2c0a 2020 2020 2020 2020 7061 7468  s',.        path
+0000a610: 3d27 2f66 6f6f 2f2a 272c 0a20 2020 2020  ='/foo/*',.     
+0000a620: 2020 2064 7374 3d27 2f62 617a 272c 0a20     dst='/baz',. 
+0000a630: 2020 2020 2020 2066 696c 6573 3d5b 272f         files=['/
+0000a640: 666f 6f2f 6261 722e 7478 7427 5d2c 0a20  foo/bar.txt'],. 
+0000a650: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
+0000a660: 617a 2f62 6172 2e74 7874 277d 2c0a 2020  az/bar.txt'},.  
+0000a670: 2020 292c 0a20 2020 2050 7573 6850 756c    ),.    PushPul
+0000a680: 6c43 6173 6528 0a20 2020 2020 2020 206e  lCase(.        n
+0000a690: 616d 653d 2764 6972 6563 746c 7920 7075  ame='directly pu
+0000a6a0: 7368 2f70 756c 6c20 6120 7370 6563 6966  sh/pull a specif
+0000a6b0: 6963 2066 696c 6527 2c0a 2020 2020 2020  ic file',.      
+0000a6c0: 2020 7061 7468 3d27 2f66 6f6f 2f62 6172    path='/foo/bar
+0000a6d0: 2e74 7874 272c 0a20 2020 2020 2020 2064  .txt',.        d
+0000a6e0: 7374 3d27 2f62 617a 272c 0a20 2020 2020  st='/baz',.     
+0000a6f0: 2020 2066 696c 6573 3d5b 272f 666f 6f2f     files=['/foo/
+0000a700: 6261 722e 7478 7427 5d2c 0a20 2020 2020  bar.txt'],.     
+0000a710: 2020 2077 616e 743d 7b27 2f62 617a 2f62     want={'/baz/b
+0000a720: 6172 2e74 7874 277d 2c0a 2020 2020 292c  ar.txt'},.    ),
+0000a730: 0a20 2020 2050 7573 6850 756c 6c43 6173  .    PushPullCas
+0000a740: 6528 0a20 2020 2020 2020 206e 616d 653d  e(.        name=
+0000a750: 2765 7272 6f72 206f 6e20 7075 7368 2f70  'error on push/p
+0000a760: 756c 6c20 6e6f 6e2d 6578 6973 7469 6e67  ull non-existing
+0000a770: 2066 696c 6527 2c0a 2020 2020 2020 2020   file',.        
+0000a780: 7061 7468 3d27 2f66 6f6f 2f62 6172 2e74  path='/foo/bar.t
+0000a790: 7874 272c 0a20 2020 2020 2020 2064 7374  xt',.        dst
+0000a7a0: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a7b0: 2066 696c 6573 3d5b 5d2c 0a20 2020 2020   files=[],.     
+0000a7c0: 2020 2065 7272 6f72 733d 7b27 2f66 6f6f     errors={'/foo
+0000a7d0: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
+0000a7e0: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+0000a7f0: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+0000a800: 653d 2770 7573 682f 7075 6c6c 206d 756c  e='push/pull mul
+0000a810: 7469 706c 6520 6e6f 6e2d 6578 6973 7469  tiple non-existi
+0000a820: 6e67 2066 696c 6573 272c 0a20 2020 2020  ng files',.     
+0000a830: 2020 2070 6174 683d 5b27 2f66 6f6f 2f62     path=['/foo/b
+0000a840: 6172 2e74 7874 272c 2027 2f62 6f6f 2f66  ar.txt', '/boo/f
+0000a850: 6172 2e74 7874 275d 2c0a 2020 2020 2020  ar.txt'],.      
+0000a860: 2020 6473 743d 272f 6261 7a27 2c0a 2020    dst='/baz',.  
+0000a870: 2020 2020 2020 6669 6c65 733d 5b5d 2c0a        files=[],.
+0000a880: 2020 2020 2020 2020 6572 726f 7273 3d7b          errors={
+0000a890: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
+0000a8a0: 272f 626f 6f2f 6661 722e 7478 7427 7d2c  '/boo/far.txt'},
+0000a8b0: 0a20 2020 2029 2c0a 2020 2020 5075 7368  .    ),.    Push
+0000a8c0: 5075 6c6c 4361 7365 280a 2020 2020 2020  PullCase(.      
+0000a8d0: 2020 6e61 6d65 3d27 7075 7368 2f70 756c    name='push/pul
+0000a8e0: 6c20 6669 6c65 2061 6e64 2064 6972 2063  l file and dir c
+0000a8f0: 6f6d 626f 272c 0a20 2020 2020 2020 2070  ombo',.        p
+0000a900: 6174 683d 5b27 2f66 6f6f 2f66 6f6f 6261  ath=['/foo/fooba
+0000a910: 722e 7478 7427 2c20 272f 666f 6f2f 6261  r.txt', '/foo/ba
+0000a920: 7227 5d2c 0a20 2020 2020 2020 2064 7374  r'],.        dst
+0000a930: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a940: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
+0000a950: 722f 6261 7a2e 7478 7427 2c20 272f 666f  r/baz.txt', '/fo
+0000a960: 6f2f 666f 6f62 6172 2e74 7874 272c 2027  o/foobar.txt', '
+0000a970: 2f71 7575 782e 7478 7427 5d2c 0a20 2020  /quux.txt'],.   
+0000a980: 2020 2020 2077 616e 743d 7b27 2f62 617a       want={'/baz
+0000a990: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
+0000a9a0: 6261 7a2f 6261 722f 6261 7a2e 7478 7427  baz/bar/baz.txt'
+0000a9b0: 7d2c 0a20 2020 2029 2c0a 5d0a 0a0a 4070  },.    ),.]...@p
+0000a9c0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0000a9d0: 6574 7269 7a65 2827 6361 7365 272c 2072  etrize('case', r
+0000a9e0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
+0000a9f0: 6c6c 5f63 6173 6573 290a 6465 6620 7465  ll_cases).def te
+0000aa00: 7374 5f72 6563 7572 7369 7665 5f70 7573  st_recursive_pus
+0000aa10: 685f 616e 645f 7075 6c6c 2863 6173 6529  h_and_pull(case)
+0000aa20: 3a0a 2020 2020 2320 6675 6c6c 2022 696e  :.    # full "in
+0000aa30: 7465 6772 6174 696f 6e22 2074 6573 7420  tegration" test 
+0000aa40: 6f66 2070 7573 682b 7075 6c6c 0a20 2020  of push+pull.   
+0000aa50: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+0000aa60: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+0000aa70: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+0000aa80: 7461 3d27 2727 0a20 2020 2020 2020 206e  ta='''.        n
+0000aa90: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+0000aaa0: 2020 2020 2020 636f 6e74 6169 6e65 7273        containers
+0000aab0: 3a0a 2020 2020 2020 2020 2020 666f 6f3a  :.          foo:
+0000aac0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000aad0: 6f75 7263 653a 2066 6f6f 2d69 6d61 6765  ource: foo-image
+0000aae0: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
+0000aaf0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0000ab00: 290a 2020 2020 6861 726e 6573 732e 7365  ).    harness.se
+0000ab10: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
+0000ab20: 6f6f 272c 2054 7275 6529 0a20 2020 2063  oo', True).    c
+0000ab30: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0000ab40: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
+0000ab50: 5b27 666f 6f27 5d0a 0a20 2020 2023 2063  ['foo']..    # c
+0000ab60: 7265 6174 6520 7075 7368 2074 6573 7420  reate push test 
+0000ab70: 6361 7365 2066 696c 6573 7973 7465 6d20  case filesystem 
+0000ab80: 7374 7275 6374 7572 650a 2020 2020 7075  structure.    pu
+0000ab90: 7368 5f73 7263 203d 2074 656d 7066 696c  sh_src = tempfil
+0000aba0: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
+0000abb0: 746f 7279 2829 0a20 2020 2066 6f72 2066  tory().    for f
+0000abc0: 696c 6520 696e 2063 6173 652e 6669 6c65  ile in case.file
+0000abd0: 733a 0a20 2020 2020 2020 2066 7061 7468  s:.        fpath
+0000abe0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0000abf0: 7075 7368 5f73 7263 2e6e 616d 652c 2066  push_src.name, f
+0000ac00: 696c 655b 313a 5d29 0a20 2020 2020 2020  ile[1:]).       
+0000ac10: 206f 732e 6d61 6b65 6469 7273 286f 732e   os.makedirs(os.
+0000ac20: 7061 7468 2e64 6972 6e61 6d65 2866 7061  path.dirname(fpa
+0000ac30: 7468 292c 2065 7869 7374 5f6f 6b3d 5472  th), exist_ok=Tr
+0000ac40: 7565 290a 2020 2020 2020 2020 7769 7468  ue).        with
+0000ac50: 206f 7065 6e28 6670 6174 682c 2027 7727   open(fpath, 'w'
+0000ac60: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000ac70: 2020 2020 662e 7772 6974 6528 2768 656c      f.write('hel
+0000ac80: 6c6f 2729 0a0a 2020 2020 2320 7465 7374  lo')..    # test
+0000ac90: 2070 7573 680a 2020 2020 6966 2069 7369   push.    if isi
+0000aca0: 6e73 7461 6e63 6528 6361 7365 2e70 6174  nstance(case.pat
+0000acb0: 682c 206c 6973 7429 3a0a 2020 2020 2020  h, list):.      
+0000acc0: 2020 2320 7377 6170 2073 6c61 7368 2066    # swap slash f
+0000acd0: 6f72 2064 756d 6d79 2064 6972 206f 6e20  or dummy dir on 
+0000ace0: 726f 6f74 2064 6972 2073 6f20 5061 7468  root dir so Path
+0000acf0: 2e70 6172 656e 7420 646f 6573 6e27 7420  .parent doesn't 
+0000ad00: 7265 7475 726e 2074 6d70 6469 7220 7061  return tmpdir pa
+0000ad10: 7468 2063 6f6d 706f 6e65 6e74 0a20 2020  th component.   
+0000ad20: 2020 2020 2023 206f 7468 6572 7769 7365       # otherwise
+0000ad30: 2072 656d 6f76 6520 6c65 6164 696e 6720   remove leading 
+0000ad40: 736c 6173 6820 736f 2077 6520 6361 6e20  slash so we can 
+0000ad50: 646f 2074 6865 2070 6174 6820 6a6f 696e  do the path join
+0000ad60: 2070 726f 7065 726c 792e 0a20 2020 2020   properly..     
+0000ad70: 2020 2070 7573 685f 7061 7468 203d 205b     push_path = [
+0000ad80: 6f73 2e70 6174 682e 6a6f 696e 2870 7573  os.path.join(pus
+0000ad90: 685f 7372 632e 6e61 6d65 2c20 705b 313a  h_src.name, p[1:
+0000ada0: 5d20 6966 206c 656e 2870 2920 3e20 3120  ] if len(p) > 1 
+0000adb0: 656c 7365 2027 666f 6f27 290a 2020 2020  else 'foo').    
+0000adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000add0: 2066 6f72 2070 2069 6e20 6361 7365 2e70   for p in case.p
+0000ade0: 6174 685d 0a20 2020 2065 6c73 653a 0a20  ath].    else:. 
+0000adf0: 2020 2020 2020 2023 2073 7761 7020 736c         # swap sl
+0000ae00: 6173 6820 666f 7220 6475 6d6d 7920 6469  ash for dummy di
+0000ae10: 7220 6f6e 2072 6f6f 7420 6469 7220 736f  r on root dir so
+0000ae20: 2050 6174 682e 7061 7265 6e74 2064 6f65   Path.parent doe
+0000ae30: 736e 2774 2072 6574 7572 6e20 746d 7064  sn't return tmpd
+0000ae40: 6972 2070 6174 6820 636f 6d70 6f6e 656e  ir path componen
+0000ae50: 740a 2020 2020 2020 2020 2320 6f74 6865  t.        # othe
+0000ae60: 7277 6973 6520 7265 6d6f 7665 206c 6561  rwise remove lea
+0000ae70: 6469 6e67 2073 6c61 7368 2073 6f20 7765  ding slash so we
+0000ae80: 2063 616e 2064 6f20 7468 6520 7061 7468   can do the path
+0000ae90: 206a 6f69 6e20 7072 6f70 6572 6c79 2e0a   join properly..
+0000aea0: 2020 2020 2020 2020 7075 7368 5f70 6174          push_pat
+0000aeb0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0000aec0: 2870 7573 685f 7372 632e 6e61 6d65 2c20  (push_src.name, 
+0000aed0: 6361 7365 2e70 6174 685b 313a 5d20 6966  case.path[1:] if
+0000aee0: 206c 656e 2863 6173 652e 7061 7468 2920   len(case.path) 
+0000aef0: 3e20 3120 656c 7365 2027 666f 6f27 290a  > 1 else 'foo').
+0000af00: 0a20 2020 2065 7272 6f72 7320 3d20 5b5d  .    errors = []
+0000af10: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+0000af20: 2020 632e 7075 7368 5f70 6174 6828 7075    c.push_path(pu
+0000af30: 7368 5f70 6174 682c 2063 6173 652e 6473  sh_path, case.ds
+0000af40: 7429 0a20 2020 2065 7863 6570 7420 6f70  t).    except op
+0000af50: 732e 4d75 6c74 6950 7573 6850 756c 6c45  s.MultiPushPullE
+0000af60: 7272 6f72 2061 7320 6572 723a 0a20 2020  rror as err:.   
+0000af70: 2020 2020 2069 6620 6e6f 7420 6361 7365       if not case
+0000af80: 2e65 7272 6f72 733a 0a20 2020 2020 2020  .errors:.       
+0000af90: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+0000afa0: 2020 2065 7272 6f72 7320 3d20 7b73 7263     errors = {src
+0000afb0: 5b6c 656e 2870 7573 685f 7372 632e 6e61  [len(push_src.na
+0000afc0: 6d65 293a 5d20 666f 7220 7372 632c 205f  me):] for src, _
+0000afd0: 2069 6e20 6572 722e 6572 726f 7273 7d0a   in err.errors}.
+0000afe0: 0a20 2020 2061 7373 6572 7420 6361 7365  .    assert case
+0000aff0: 2e65 7272 6f72 7320 3d3d 2065 7272 6f72  .errors == error
+0000b000: 732c 205c 0a20 2020 2020 2020 2066 2770  s, \.        f'p
+0000b010: 7573 685f 7061 7468 2067 6176 6520 7772  ush_path gave wr
+0000b020: 6f6e 6720 6578 7065 6374 6564 2065 7272  ong expected err
+0000b030: 6f72 733a 2077 616e 7420 7b63 6173 652e  ors: want {case.
+0000b040: 6572 726f 7273 7d2c 2067 6f74 207b 6572  errors}, got {er
+0000b050: 726f 7273 7d27 0a20 2020 2066 6f72 2066  rors}'.    for f
+0000b060: 7061 7468 2069 6e20 6361 7365 2e77 616e  path in case.wan
+0000b070: 743a 0a20 2020 2020 2020 2061 7373 6572  t:.        asser
+0000b080: 7420 632e 6578 6973 7473 2866 7061 7468  t c.exists(fpath
+0000b090: 292c 2066 2770 7573 685f 7061 7468 2066  ), f'push_path f
+0000b0a0: 6169 6c65 643a 2066 696c 6520 7b66 7061  ailed: file {fpa
+0000b0b0: 7468 7d20 6d69 7373 696e 6720 6174 2064  th} missing at d
+0000b0c0: 6573 7469 6e61 7469 6f6e 270a 0a20 2020  estination'..   
+0000b0d0: 2023 2063 7265 6174 6520 7075 6c6c 2074   # create pull t
+0000b0e0: 6573 7420 6361 7365 2066 696c 6573 7973  est case filesys
+0000b0f0: 7465 6d20 7374 7275 6374 7572 650a 2020  tem structure.  
+0000b100: 2020 7075 6c6c 5f64 7374 203d 2074 656d    pull_dst = tem
+0000b110: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
+0000b120: 6972 6563 746f 7279 2829 0a20 2020 2066  irectory().    f
+0000b130: 6f72 2066 7061 7468 2069 6e20 6361 7365  or fpath in case
+0000b140: 2e66 696c 6573 3a0a 2020 2020 2020 2020  .files:.        
+0000b150: 632e 7075 7368 2866 7061 7468 2c20 2768  c.push(fpath, 'h
+0000b160: 656c 6c6f 272c 206d 616b 655f 6469 7273  ello', make_dirs
+0000b170: 3d54 7275 6529 0a0a 2020 2020 2320 7465  =True)..    # te
+0000b180: 7374 2070 756c 6c0a 2020 2020 6572 726f  st pull.    erro
+0000b190: 7273 203d 205b 5d0a 2020 2020 7472 793a  rs = [].    try:
+0000b1a0: 0a20 2020 2020 2020 2063 2e70 756c 6c5f  .        c.pull_
+0000b1b0: 7061 7468 2863 6173 652e 7061 7468 2c20  path(case.path, 
+0000b1c0: 6f73 2e70 6174 682e 6a6f 696e 2870 756c  os.path.join(pul
+0000b1d0: 6c5f 6473 742e 6e61 6d65 2c20 6361 7365  l_dst.name, case
+0000b1e0: 2e64 7374 5b31 3a5d 2929 0a20 2020 2065  .dst[1:])).    e
+0000b1f0: 7863 6570 7420 6f70 732e 4d75 6c74 6950  xcept ops.MultiP
+0000b200: 7573 6850 756c 6c45 7272 6f72 2061 7320  ushPullError as 
+0000b210: 6572 723a 0a20 2020 2020 2020 2069 6620  err:.        if 
+0000b220: 6e6f 7420 6361 7365 2e65 7272 6f72 733a  not case.errors:
+0000b230: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000b240: 7365 0a20 2020 2020 2020 2065 7272 6f72  se.        error
+0000b250: 7320 3d20 7b73 7263 2066 6f72 2073 7263  s = {src for src
+0000b260: 2c20 5f20 696e 2065 7272 2e65 7272 6f72  , _ in err.error
+0000b270: 737d 0a0a 2020 2020 6173 7365 7274 2063  s}..    assert c
+0000b280: 6173 652e 6572 726f 7273 203d 3d20 6572  ase.errors == er
+0000b290: 726f 7273 2c20 5c0a 2020 2020 2020 2020  rors, \.        
+0000b2a0: 6627 7075 6c6c 5f70 6174 6820 6761 7665  f'pull_path gave
+0000b2b0: 2077 726f 6e67 2065 7870 6563 7465 6420   wrong expected 
+0000b2c0: 6572 726f 7273 3a20 7761 6e74 207b 6361  errors: want {ca
+0000b2d0: 7365 2e65 7272 6f72 737d 2c20 676f 7420  se.errors}, got 
+0000b2e0: 7b65 7272 6f72 737d 270a 2020 2020 666f  {errors}'.    fo
+0000b2f0: 7220 6670 6174 6820 696e 2063 6173 652e  r fpath in case.
+0000b300: 7761 6e74 3a0a 2020 2020 2020 2020 6173  want:.        as
+0000b310: 7365 7274 2063 2e65 7869 7374 7328 6670  sert c.exists(fp
+0000b320: 6174 6829 2c20 6627 7075 6c6c 5f70 6174  ath), f'pull_pat
+0000b330: 6820 6661 696c 6564 3a20 6669 6c65 207b  h failed: file {
+0000b340: 6670 6174 687d 206d 6973 7369 6e67 2061  fpath} missing a
+0000b350: 7420 6465 7374 696e 6174 696f 6e27 0a0a  t destination'..
+0000b360: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
+0000b370: 7261 6d65 7472 697a 6528 2763 6173 6527  rametrize('case'
+0000b380: 2c20 5b0a 2020 2020 5075 7368 5075 6c6c  , [.    PushPull
+0000b390: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
+0000b3a0: 6d65 3d27 7075 7368 2064 6972 6563 746f  me='push directo
+0000b3b0: 7279 2077 6974 686f 7574 2074 7261 696c  ry without trail
+0000b3c0: 696e 6720 736c 6173 6827 2c0a 2020 2020  ing slash',.    
+0000b3d0: 2020 2020 7061 7468 3d27 666f 6f27 2c0a      path='foo',.
+0000b3e0: 2020 2020 2020 2020 6473 743d 272f 6261          dst='/ba
+0000b3f0: 7a27 2c0a 2020 2020 2020 2020 6669 6c65  z',.        file
+0000b400: 733d 5b27 666f 6f2f 6261 722f 6261 7a2e  s=['foo/bar/baz.
+0000b410: 7478 7427 2c20 2766 6f6f 2f66 6f6f 6261  txt', 'foo/fooba
+0000b420: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
+0000b430: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
+0000b440: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
+0000b450: 6261 7a2f 666f 6f2f 6261 722f 6261 7a2e  baz/foo/bar/baz.
+0000b460: 7478 7427 7d2c 0a20 2020 2029 2c0a 2020  txt'},.    ),.  
+0000b470: 2020 5075 7368 5075 6c6c 4361 7365 280a    PushPullCase(.
+0000b480: 2020 2020 2020 2020 6e61 6d65 3d27 7075          name='pu
+0000b490: 7368 2064 6972 6563 746f 7279 2077 6974  sh directory wit
+0000b4a0: 6820 7472 6169 6c69 6e67 2073 6c61 7368  h trailing slash
+0000b4b0: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
+0000b4c0: 2766 6f6f 2f27 2c0a 2020 2020 2020 2020  'foo/',.        
+0000b4d0: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
+0000b4e0: 2020 2020 6669 6c65 733d 5b27 666f 6f2f      files=['foo/
+0000b4f0: 6261 722f 6261 7a2e 7478 7427 2c20 2766  bar/baz.txt', 'f
+0000b500: 6f6f 2f66 6f6f 6261 722e 7478 7427 5d2c  oo/foobar.txt'],
+0000b510: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
+0000b520: 2f62 617a 2f66 6f6f 2f66 6f6f 6261 722e  /baz/foo/foobar.
+0000b530: 7478 7427 2c20 272f 6261 7a2f 666f 6f2f  txt', '/baz/foo/
+0000b540: 6261 722f 6261 7a2e 7478 7427 7d2c 0a20  bar/baz.txt'},. 
+0000b550: 2020 2029 2c0a 2020 2020 5075 7368 5075     ),.    PushPu
+0000b560: 6c6c 4361 7365 280a 2020 2020 2020 2020  llCase(.        
+0000b570: 6e61 6d65 3d27 7075 7368 2064 6972 6563  name='push direc
+0000b580: 746f 7279 2072 656c 6174 6976 6520 7061  tory relative pa
+0000b590: 7468 696e 6727 2c0a 2020 2020 2020 2020  thing',.        
+0000b5a0: 7061 7468 3d27 2e2f 666f 6f27 2c0a 2020  path='./foo',.  
+0000b5b0: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
+0000b5c0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
+0000b5d0: 5b27 666f 6f2f 6261 722f 6261 7a2e 7478  ['foo/bar/baz.tx
+0000b5e0: 7427 2c20 2766 6f6f 2f66 6f6f 6261 722e  t', 'foo/foobar.
+0000b5f0: 7478 7427 5d2c 0a20 2020 2020 2020 2077  txt'],.        w
+0000b600: 616e 743d 7b27 2f62 617a 2f66 6f6f 2f66  ant={'/baz/foo/f
+0000b610: 6f6f 6261 722e 7478 7427 2c20 272f 6261  oobar.txt', '/ba
+0000b620: 7a2f 666f 6f2f 6261 722f 6261 7a2e 7478  z/foo/bar/baz.tx
+0000b630: 7427 7d2c 0a20 2020 2029 2c0a 5d29 0a64  t'},.    ),.]).d
+0000b640: 6566 2074 6573 745f 7075 7368 5f70 6174  ef test_push_pat
+0000b650: 685f 7265 6c61 7469 7665 2863 6173 6529  h_relative(case)
+0000b660: 3a0a 2020 2020 6861 726e 6573 7320 3d20  :.    harness = 
+0000b670: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0000b680: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0000b690: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+0000b6a0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+0000b6b0: 7070 0a20 2020 2020 2020 2063 6f6e 7461  pp.        conta
+0000b6c0: 696e 6572 733a 0a20 2020 2020 2020 2020  iners:.         
+0000b6d0: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
+0000b6e0: 2020 7265 736f 7572 6365 3a20 666f 6f2d    resource: foo-
+0000b6f0: 696d 6167 650a 2020 2020 2020 2020 2727  image.        ''
+0000b700: 2729 0a20 2020 2068 6172 6e65 7373 2e62  ').    harness.b
+0000b710: 6567 696e 2829 0a20 2020 2068 6172 6e65  egin().    harne
+0000b720: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+0000b730: 6374 2827 666f 6f27 2c20 5472 7565 290a  ct('foo', True).
+0000b740: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
+0000b750: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
+0000b760: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
+0000b770: 6f6f 275d 0a0a 2020 2020 7769 7468 2074  oo']..    with t
+0000b780: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
+0000b790: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
+0000b7a0: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
+0000b7b0: 6377 6420 3d20 6f73 2e67 6574 6377 6428  cwd = os.getcwd(
+0000b7c0: 290a 2020 2020 2020 2020 2320 6368 616e  ).        # chan
+0000b7d0: 6765 2077 6f72 6b69 6e67 2064 6972 6563  ge working direc
+0000b7e0: 746f 7279 2074 6f20 656e 6162 6c65 2072  tory to enable r
+0000b7f0: 656c 6174 6976 6520 7061 7468 696e 6720  elative pathing 
+0000b800: 666f 7220 7465 7374 696e 670a 2020 2020  for testing.    
+0000b810: 2020 2020 6f73 2e63 6864 6972 2874 6d70      os.chdir(tmp
+0000b820: 6469 7229 0a20 2020 2020 2020 2074 7279  dir).        try
+0000b830: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000b840: 6372 6561 7465 2074 6573 7420 6669 6c65  create test file
+0000b850: 7320 756e 6465 7220 7465 6d70 6f72 6172  s under temporar
+0000b860: 7920 7465 7374 2064 6972 6563 746f 7279  y test directory
+0000b870: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+0000b880: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+0000b890: 746d 7064 6972 290a 2020 2020 2020 2020  tmpdir).        
+0000b8a0: 2020 2020 666f 7220 7465 7374 6669 6c65      for testfile
+0000b8b0: 2069 6e20 6361 7365 2e66 696c 6573 3a0a   in case.files:.
+0000b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8d0: 7465 7374 6669 6c65 5f70 6174 6820 3d20  testfile_path = 
+0000b8e0: 7061 7468 6c69 622e 5061 7468 2874 6d70  pathlib.Path(tmp
+0000b8f0: 202f 2074 6573 7466 696c 6529 0a20 2020   / testfile).   
+0000b900: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+0000b910: 7466 696c 655f 7061 7468 2e70 6172 656e  tfile_path.paren
+0000b920: 742e 6d6b 6469 7228 7061 7265 6e74 733d  t.mkdir(parents=
+0000b930: 5472 7565 2c20 6578 6973 745f 6f6b 3d54  True, exist_ok=T
+0000b940: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0000b950: 2020 2020 2074 6573 7466 696c 655f 7061       testfile_pa
+0000b960: 7468 2e74 6f75 6368 2865 7869 7374 5f6f  th.touch(exist_o
+0000b970: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
+0000b980: 2020 2020 2020 2020 7465 7374 6669 6c65          testfile
+0000b990: 5f70 6174 682e 7772 6974 655f 7465 7874  _path.write_text
+0000b9a0: 2822 7465 7374 222c 2065 6e63 6f64 696e  ("test", encodin
+0000b9b0: 673d 2275 7466 2d38 2229 0a0a 2020 2020  g="utf-8")..    
+0000b9c0: 2020 2020 2020 2020 2320 7075 7368 2070          # push p
+0000b9d0: 6174 6820 756e 6465 7220 7465 7374 2074  ath under test t
+0000b9e0: 6f20 636f 6e74 6169 6e65 720a 2020 2020  o container.    
+0000b9f0: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
+0000ba00: 722e 7075 7368 5f70 6174 6828 6361 7365  r.push_path(case
+0000ba10: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
+0000ba20: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000ba30: 7465 7374 0a20 2020 2020 2020 2020 2020  test.           
+0000ba40: 2066 6f72 2077 616e 745f 7061 7468 2069   for want_path i
+0000ba50: 6e20 6361 7365 2e77 616e 743a 0a20 2020  n case.want:.   
+0000ba60: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000ba70: 7465 6e74 203d 2063 6f6e 7461 696e 6572  tent = container
+0000ba80: 2e70 756c 6c28 7761 6e74 5f70 6174 6829  .pull(want_path)
+0000ba90: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
+0000baa0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+0000bab0: 6f6e 7465 6e74 203d 3d20 2774 6573 7427  ontent == 'test'
+0000bac0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+0000bad0: 3a0a 2020 2020 2020 2020 2020 2020 6f73  :.            os
+0000bae0: 2e63 6864 6972 2863 7764 290a 0a0a 636c  .chdir(cwd)...cl
+0000baf0: 6173 7320 5465 7374 4170 706c 6963 6174  ass TestApplicat
+0000bb00: 696f 6e28 756e 6974 7465 7374 2e54 6573  ion(unittest.Tes
+0000bb10: 7443 6173 6529 3a0a 0a20 2020 2064 6566  tCase):..    def
+0000bb20: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000bb30: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000bb40: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000bb50: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0000bb60: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+0000bb70: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000bb80: 653a 206d 7961 7070 0a20 2020 2020 2020  e: myapp.       
+0000bb90: 2020 2020 2070 726f 7669 6465 733a 0a20       provides:. 
+0000bba0: 2020 2020 2020 2020 2020 2020 2064 6230               db0
+0000bbb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bbc0: 2020 696e 7465 7266 6163 653a 2064 6230    interface: db0
+0000bbd0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000bbe0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000bbf0: 2020 2020 2064 6231 3a0a 2020 2020 2020       db1:.      
+0000bc00: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+0000bc10: 6163 653a 2064 6231 0a20 2020 2020 2020  ace: db1.       
+0000bc20: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
+0000bc30: 2020 2020 2020 2020 2020 6462 323a 0a20            db2:. 
+0000bc40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000bc50: 6e74 6572 6661 6365 3a20 6462 320a 2020  nterface: db2.  
+0000bc60: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0000bc70: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+0000bc80: 2020 2066 6f6f 3a20 7b74 7970 653a 2066     foo: {type: f
+0000bc90: 696c 652c 2066 696c 656e 616d 653a 2066  ile, filename: f
+0000bca0: 6f6f 2e74 7874 7d0a 2020 2020 2020 2020  oo.txt}.        
+0000bcb0: 2020 2020 2020 6261 723a 207b 7479 7065        bar: {type
+0000bcc0: 3a20 6669 6c65 2c20 6669 6c65 6e61 6d65  : file, filename
+0000bcd0: 3a20 6261 722e 7478 747d 0a20 2020 2020  : bar.txt}.     
+0000bce0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0000bcf0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000bd00: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
+0000bd10: 2020 2020 2020 6b3a 2076 0a20 2020 2020        k: v.     
+0000bd20: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+0000bd30: 7365 6c66 2e70 6565 725f 7265 6c5f 6964  self.peer_rel_id
+0000bd40: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
+0000bd50: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+0000bd60: 3227 2c20 2764 6232 2729 0a20 2020 2020  2', 'db2').     
+0000bd70: 2020 2073 656c 662e 6170 7020 3d20 7365     self.app = se
+0000bd80: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
+0000bd90: 2e61 7070 0a20 2020 2020 2020 2073 656c  .app.        sel
+0000bda0: 662e 6164 6443 6c65 616e 7570 2873 656c  f.addCleanup(sel
+0000bdb0: 662e 6861 726e 6573 732e 636c 6561 6e75  f.harness.cleanu
+0000bdc0: 7029 0a0a 2020 2020 2320 5465 7374 7320  p)..    # Tests 
+0000bdd0: 6669 7820 666f 7220 6874 7470 733a 2f2f  fix for https://
+0000bde0: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
+0000bdf0: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
+0000be00: 7375 6573 2f36 3934 2e0a 2020 2020 6465  sues/694..    de
+0000be10: 6620 7465 7374 5f6d 6f63 6b65 645f 6765  f test_mocked_ge
+0000be20: 745f 7365 7276 6963 6573 2873 656c 6629  t_services(self)
+0000be30: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
+0000be40: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
+0000be50: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0000be60: 6573 732e 7365 745f 6361 6e5f 636f 6e6e  ess.set_can_conn
+0000be70: 6563 7428 2762 6172 272c 2054 7275 6529  ect('bar', True)
+0000be80: 0a20 2020 2020 2020 2063 203d 2073 656c  .        c = sel
+0000be90: 662e 6861 726e 6573 732e 6368 6172 6d2e  f.harness.charm.
+0000bea0: 756e 6974 2e67 6574 5f63 6f6e 7461 696e  unit.get_contain
+0000beb0: 6572 2827 6261 7227 290a 2020 2020 2020  er('bar').      
+0000bec0: 2020 632e 6164 645f 6c61 7965 7228 276c    c.add_layer('l
+0000bed0: 6179 6572 3127 2c20 7b0a 2020 2020 2020  ayer1', {.      
+0000bee0: 2020 2020 2020 2773 756d 6d61 7279 273a        'summary':
+0000bef0: 2027 6c61 7965 7227 2c0a 2020 2020 2020   'layer',.      
+0000bf00: 2020 2020 2020 2773 6572 7669 6365 7327        'services'
+0000bf10: 3a20 7b22 6261 7a22 3a20 7b27 6f76 6572  : {"baz": {'over
+0000bf20: 7269 6465 273a 2027 7265 706c 6163 6527  ride': 'replace'
+0000bf30: 2c20 2773 756d 6d61 7279 273a 2027 6563  , 'summary': 'ec
+0000bf40: 686f 272c 2027 636f 6d6d 616e 6427 3a20  ho', 'command': 
+0000bf50: 2765 6368 6f20 3127 7d7d 2c0a 2020 2020  'echo 1'}},.    
+0000bf60: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
+0000bf70: 7320 3d20 632e 6765 745f 7365 7276 6963  s = c.get_servic
+0000bf80: 6528 2762 617a 2729 2020 2320 536f 2066  e('baz')  # So f
+0000bf90: 6172 2c20 736f 2067 6f6f 640a 2020 2020  ar, so good.    
+0000bfa0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000bfb0: 7275 6528 7329 0a20 2020 2020 2020 2073  rue(s).        s
+0000bfc0: 656c 662e 6173 7365 7274 5472 7565 2827  elf.assertTrue('
+0000bfd0: 6261 7a27 2069 6e20 632e 6765 745f 7365  baz' in c.get_se
+0000bfe0: 7276 6963 6573 2829 290a 0a20 2020 2064  rvices())..    d
+0000bff0: 6566 2074 6573 745f 706c 616e 6e65 645f  ef test_planned_
+0000c000: 756e 6974 7328 7365 6c66 293a 0a20 2020  units(self):.   
+0000c010: 2020 2020 2072 656c 5f69 6420 3d20 7365       rel_id = se
+0000c020: 6c66 2e70 6565 725f 7265 6c5f 6964 0a0a  lf.peer_rel_id..
+0000c030: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
+0000c040: 6861 7420 7765 2061 6c77 6179 7320 636f  hat we always co
+0000c050: 756e 7420 6f75 7273 656c 662e 0a20 2020  unt ourself..   
+0000c060: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c070: 4571 7561 6c28 7365 6c66 2e61 7070 2e70  Equal(self.app.p
+0000c080: 6c61 6e6e 6564 5f75 6e69 7473 2829 2c20  lanned_units(), 
+0000c090: 3129 0a0a 2020 2020 2020 2020 2320 4164  1)..        # Ad
+0000c0a0: 6420 736f 6d65 2075 6e69 7473 2c20 616e  d some units, an
+0000c0b0: 6420 7665 7269 6679 2063 6f75 6e74 2e0a  d verify count..
+0000c0c0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c0d0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0000c0e0: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
+0000c0f0: 6d79 6170 702f 3127 290a 2020 2020 2020  myapp/1').      
+0000c100: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
+0000c110: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+0000c120: 2872 656c 5f69 642c 2027 6d79 6170 702f  (rel_id, 'myapp/
+0000c130: 3227 290a 0a20 2020 2020 2020 2073 656c  2')..        sel
+0000c140: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000c150: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
+0000c160: 6e69 7473 2829 2c20 3329 0a0a 2020 2020  nits(), 3)..    
+0000c170: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c180: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+0000c190: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
+0000c1a0: 702f 3327 290a 2020 2020 2020 2020 7365  p/3').        se
+0000c1b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000c1c0: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
+0000c1d0: 756e 6974 7328 292c 2034 290a 0a20 2020  units(), 4)..   
+0000c1e0: 2020 2020 2023 2041 6e64 2072 656d 6f76       # And remov
+0000c1f0: 6520 6120 756e 6974 0a20 2020 2020 2020  e a unit.       
+0000c200: 2073 656c 662e 6861 726e 6573 732e 7265   self.harness.re
+0000c210: 6d6f 7665 5f72 656c 6174 696f 6e5f 756e  move_relation_un
+0000c220: 6974 2872 656c 5f69 642c 2027 6d79 6170  it(rel_id, 'myap
+0000c230: 702f 3227 290a 0a20 2020 2020 2020 2073  p/2')..        s
+0000c240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000c250: 7365 6c66 2e61 7070 2e70 6c61 6e6e 6564  self.app.planned
+0000c260: 5f75 6e69 7473 2829 2c20 3329 0a0a 2020  _units(), 3)..  
+0000c270: 2020 6465 6620 7465 7374 5f70 6c61 6e6e    def test_plann
+0000c280: 6564 5f75 6e69 7473 5f75 7365 725f 7365  ed_units_user_se
+0000c290: 7428 7365 6c66 293a 0a0a 2020 2020 2020  t(self):..      
+0000c2a0: 2020 7365 6c66 2e68 6172 6e65 7373 2e73    self.harness.s
+0000c2b0: 6574 5f70 6c61 6e6e 6564 5f75 6e69 7473  et_planned_units
+0000c2c0: 2831 290a 2020 2020 2020 2020 7365 6c66  (1).        self
+0000c2d0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000c2e0: 662e 6170 702e 706c 616e 6e65 645f 756e  f.app.planned_un
+0000c2f0: 6974 7328 292c 2031 290a 0a20 2020 2020  its(), 1)..     
+0000c300: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000c310: 7365 745f 706c 616e 6e65 645f 756e 6974  set_planned_unit
+0000c320: 7328 3229 0a20 2020 2020 2020 2073 656c  s(2).        sel
+0000c330: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000c340: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
+0000c350: 6e69 7473 2829 2c20 3229 0a0a 2020 2020  nits(), 2)..    
+0000c360: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c370: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
+0000c380: 7473 2831 3030 290a 2020 2020 2020 2020  ts(100).        
+0000c390: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c3a0: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000c3b0: 645f 756e 6974 7328 292c 2031 3030 290a  d_units(), 100).
+0000c3c0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
+0000c3d0: 616e 6e65 645f 756e 6974 735f 6761 7262  anned_units_garb
+0000c3e0: 6167 655f 7661 6c75 6573 2873 656c 6629  age_values(self)
+0000c3f0: 3a0a 2020 2020 2020 2020 2320 506c 616e  :.        # Plan
+0000c400: 6e65 6420 756e 6974 7320 7368 6f75 6c64  ned units should
+0000c410: 2062 6520 6120 706f 7369 7469 7665 2069   be a positive i
+0000c420: 6e74 6567 6572 2c20 6f72 207a 6572 6f2e  nteger, or zero.
+0000c430: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000c440: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000c450: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+0000c460: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c470: 6e65 7373 2e73 6574 5f70 6c61 6e6e 6564  ness.set_planned
+0000c480: 5f75 6e69 7473 282d 3129 0a20 2020 2020  _units(-1).     
+0000c490: 2020 2023 2056 6572 6966 7920 7468 6174     # Verify that
+0000c4a0: 2077 6520 6469 646e 2774 2073 6574 206f   we didn't set o
+0000c4b0: 7572 2076 616c 7565 2062 6566 6f72 6520  ur value before 
+0000c4c0: 7261 6973 696e 6720 7468 6520 6572 726f  raising the erro
+0000c4d0: 722e 0a20 2020 2020 2020 2073 656c 662e  r..        self.
+0000c4e0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+0000c4f0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0000c500: 2e5f 706c 616e 6e65 645f 756e 6974 7320  ._planned_units 
+0000c510: 6973 204e 6f6e 6529 0a20 2020 2020 2020  is None).       
+0000c520: 2023 2056 6572 6966 7920 7468 6174 2077   # Verify that w
+0000c530: 6520 7374 696c 6c20 6765 7420 7468 6520  e still get the 
+0000c540: 6465 6661 756c 7420 7661 6c75 6520 6261  default value ba
+0000c550: 636b 2066 726f 6d20 2e70 6c61 6e6e 6564  ck from .planned
+0000c560: 5f75 6e69 7473 2e0a 2020 2020 2020 2020  _units..        
+0000c570: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c580: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000c590: 645f 756e 6974 7328 292c 2031 290a 0a20  d_units(), 1).. 
+0000c5a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000c5b0: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
+0000c5c0: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
+0000c5d0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000c5e0: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
+0000c5f0: 6e69 7473 2822 666f 6f22 290a 0a20 2020  nits("foo")..   
+0000c600: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000c610: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0000c620: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0000c630: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000c640: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
+0000c650: 7473 282d 3334 3233 3030 3031 3032 3331  ts(-342300010231
+0000c660: 3233 3231 3039 3029 0a0a 2020 2020 6465  2321090)..    de
+0000c670: 6620 7465 7374 5f70 6c61 6e6e 6564 5f75  f test_planned_u
+0000c680: 6e69 7473 5f6f 7665 7272 6964 6528 7365  nits_override(se
+0000c690: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+0000c6a0: 5665 7269 6679 2074 6861 7420 7765 206f  Verify that we o
+0000c6b0: 7665 7272 6964 6520 7468 6520 6361 6c63  verride the calc
+0000c6c0: 756c 6174 6564 2076 616c 7565 206f 6620  ulated value of 
+0000c6d0: 706c 616e 6e65 645f 756e 6974 7320 7768  planned_units wh
+0000c6e0: 656e 2077 6520 7365 7420 6974 206d 616e  en we set it man
+0000c6f0: 7561 6c6c 792e 0a0a 2020 2020 2020 2020  ually...        
+0000c700: 5768 656e 2061 2063 6861 726d 2061 7574  When a charm aut
+0000c710: 686f 7220 7772 6974 6573 2061 2074 6573  hor writes a tes
+0000c720: 7420 7468 6174 2065 7870 6c69 6369 746c  t that explicitl
+0000c730: 7920 6361 6c6c 7320 7365 745f 706c 616e  y calls set_plan
+0000c740: 6e65 645f 756e 6974 732c 2077 6520 6173  ned_units, we as
+0000c750: 7375 6d65 2074 6861 740a 2020 2020 2020  sume that.      
+0000c760: 2020 7468 6569 7220 696e 7465 6e74 2069    their intent i
+0000c770: 7320 746f 206f 7665 7272 6964 6520 7468  s to override th
+0000c780: 6520 6361 6c63 756c 6174 6564 2072 6574  e calculated ret
+0000c790: 7572 6e20 7661 6c75 652e 204f 6674 656e  urn value. Often
+0000c7a0: 2c20 7468 6973 2077 696c 6c20 6265 2062  , this will be b
+0000c7b0: 6563 6175 7365 2074 6865 0a20 2020 2020  ecause the.     
+0000c7c0: 2020 2063 6861 726d 2061 7574 686f 7220     charm author 
+0000c7d0: 6973 2063 6f6d 706f 7369 6e67 2061 2063  is composing a c
+0000c7e0: 6861 726d 2077 6974 686f 7574 2070 6565  harm without pee
+0000c7f0: 7220 7265 6c61 7469 6f6e 732c 2061 6e64  r relations, and
+0000c800: 2074 6865 2068 6172 6e65 7373 2773 2063   the harness's c
+0000c810: 6f75 6e74 206f 660a 2020 2020 2020 2020  ount of.        
+0000c820: 706c 616e 6e65 6420 756e 6974 732c 2077  planned units, w
+0000c830: 6869 6368 2069 7320 6261 7365 6420 6f6e  hich is based on
+0000c840: 2074 6865 206e 756d 6265 7220 6f66 2070   the number of p
+0000c850: 6565 7220 7265 6c61 7469 6f6e 732c 2077  eer relations, w
+0000c860: 696c 6c20 6e6f 7420 6265 2061 6363 7572  ill not be accur
+0000c870: 6174 652e 0a20 2020 2020 2020 2022 2222  ate..        """
+0000c880: 0a20 2020 2020 2020 2070 6565 725f 6964  .        peer_id
+0000c890: 203d 2073 656c 662e 7065 6572 5f72 656c   = self.peer_rel
+0000c8a0: 5f69 640a 0a20 2020 2020 2020 2073 656c  _id..        sel
+0000c8b0: 662e 6861 726e 6573 732e 7365 745f 706c  f.harness.set_pl
+0000c8c0: 616e 6e65 645f 756e 6974 7328 3130 290a  anned_units(10).
+0000c8d0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0000c8e0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0000c8f0: 6e5f 756e 6974 2870 6565 725f 6964 2c20  n_unit(peer_id, 
+0000c900: 276d 7961 7070 2f31 2729 0a20 2020 2020  'myapp/1').     
+0000c910: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000c920: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+0000c930: 7428 7065 6572 5f69 642c 2027 6d79 6170  t(peer_id, 'myap
+0000c940: 702f 3227 290a 2020 2020 2020 2020 7365  p/2').        se
+0000c950: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+0000c960: 656c 6174 696f 6e5f 756e 6974 2870 6565  elation_unit(pee
+0000c970: 725f 6964 2c20 276d 7961 7070 2f33 2729  r_id, 'myapp/3')
+0000c980: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0000c990: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000c9a0: 6170 702e 706c 616e 6e65 645f 756e 6974  app.planned_unit
+0000c9b0: 7328 292c 2031 3029 0a0a 2020 2020 2020  s(), 10)..      
+0000c9c0: 2020 2320 5665 7269 6679 2074 6861 7420    # Verify that 
+0000c9d0: 7765 2063 616e 2063 6c65 6172 2074 6865  we can clear the
+0000c9e0: 206f 7665 7272 6964 652e 0a20 2020 2020   override..     
+0000c9f0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0000ca00: 7265 7365 745f 706c 616e 6e65 645f 756e  reset_planned_un
+0000ca10: 6974 7328 290a 2020 2020 2020 2020 7365  its().        se
+0000ca20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ca30: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
+0000ca40: 756e 6974 7328 292c 2034 2920 2023 2073  units(), 4)  # s
+0000ca50: 656c 6620 2b20 3320 7065 6572 730a 0a0a  elf + 3 peers...
+0000ca60: 636c 6173 7320 5465 7374 436f 6e74 6169  class TestContai
+0000ca70: 6e65 7273 2875 6e69 7474 6573 742e 5465  ners(unittest.Te
+0000ca80: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0000ca90: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000caa0: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
+0000cab0: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
+0000cac0: 7961 6d6c 2822 2222 0a6e 616d 653a 206b  yaml(""".name: k
+0000cad0: 3873 2d63 6861 726d 0a63 6f6e 7461 696e  8s-charm.contain
+0000cae0: 6572 733a 0a20 2063 313a 0a20 2020 206b  ers:.  c1:.    k
+0000caf0: 3a20 760a 2020 6332 3a0a 2020 2020 6b3a  : v.  c2:.    k:
+0000cb00: 2076 0a22 2222 290a 2020 2020 2020 2020   v.""").        
+0000cb10: 6261 636b 656e 6420 3d20 5f4d 6f64 656c  backend = _Model
+0000cb20: 4261 636b 656e 6428 276d 7961 7070 2f30  Backend('myapp/0
+0000cb30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000cb40: 6d6f 6465 6c20 3d20 6f70 732e 4d6f 6465  model = ops.Mode
+0000cb50: 6c28 6d65 7461 2c20 6261 636b 656e 6429  l(meta, backend)
+0000cb60: 0a0a 2020 2020 6465 6620 7465 7374 5f75  ..    def test_u
+0000cb70: 6e69 745f 636f 6e74 6169 6e65 7273 2873  nit_containers(s
+0000cb80: 656c 6629 3a0a 2020 2020 2020 2020 636f  elf):.        co
+0000cb90: 6e74 6169 6e65 7273 203d 2073 656c 662e  ntainers = self.
+0000cba0: 6d6f 6465 6c2e 756e 6974 2e63 6f6e 7461  model.unit.conta
+0000cbb0: 696e 6572 730a 2020 2020 2020 2020 7365  iners.        se
+0000cbc0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000cbd0: 6f72 7465 6428 636f 6e74 6169 6e65 7273  orted(containers
+0000cbe0: 292c 205b 2763 3127 2c20 2763 3227 5d29  ), ['c1', 'c2'])
+0000cbf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000cc00: 7365 7274 4571 7561 6c28 6c65 6e28 636f  sertEqual(len(co
+0000cc10: 6e74 6169 6e65 7273 292c 2032 290a 2020  ntainers), 2).  
+0000cc20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cc30: 7449 6e28 2763 3127 2c20 636f 6e74 6169  tIn('c1', contai
+0000cc40: 6e65 7273 290a 2020 2020 2020 2020 7365  ners).        se
+0000cc50: 6c66 2e61 7373 6572 7449 6e28 2763 3227  lf.assertIn('c2'
+0000cc60: 2c20 636f 6e74 6169 6e65 7273 290a 2020  , containers).  
+0000cc70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cc80: 744e 6f74 496e 2827 6333 272c 2063 6f6e  tNotIn('c3', con
+0000cc90: 7461 696e 6572 7329 0a20 2020 2020 2020  tainers).       
+0000cca0: 2066 6f72 206e 616d 6520 696e 205b 2763   for name in ['c
+0000ccb0: 3127 2c20 2763 3227 5d3a 0a20 2020 2020  1', 'c2']:.     
+0000ccc0: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0000ccd0: 203d 2063 6f6e 7461 696e 6572 735b 6e61   = containers[na
+0000cce0: 6d65 5d0a 2020 2020 2020 2020 2020 2020  me].            
+0000ccf0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+0000cd00: 7461 6e63 6528 636f 6e74 6169 6e65 722c  tance(container,
+0000cd10: 206f 7073 2e43 6f6e 7461 696e 6572 290a   ops.Container).
+0000cd20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000cd30: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
+0000cd40: 7461 696e 6572 2e6e 616d 652c 206e 616d  tainer.name, nam
+0000cd50: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0000cd60: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0000cd70: 616e 6365 2863 6f6e 7461 696e 6572 2e70  ance(container.p
+0000cd80: 6562 626c 652c 2070 6562 626c 652e 436c  ebble, pebble.Cl
+0000cd90: 6965 6e74 290a 2020 2020 2020 2020 7769  ient).        wi
+0000cda0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000cdb0: 6973 6573 284b 6579 4572 726f 7229 3a0a  ises(KeyError):.
+0000cdc0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000cdd0: 6169 6e65 7273 5b27 6333 275d 0a0a 2020  ainers['c3']..  
+0000cde0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000cdf0: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0000ce00: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+0000ce10: 2020 2020 2020 2020 6f74 6865 725f 756e          other_un
+0000ce20: 6974 203d 2073 656c 662e 6d6f 6465 6c2e  it = self.model.
+0000ce30: 6765 745f 756e 6974 2827 6f74 6865 7227  get_unit('other'
+0000ce40: 290a 2020 2020 2020 2020 2020 2020 6f74  ).            ot
+0000ce50: 6865 725f 756e 6974 2e63 6f6e 7461 696e  her_unit.contain
+0000ce60: 6572 730a 0a20 2020 2064 6566 2074 6573  ers..    def tes
+0000ce70: 745f 756e 6974 5f67 6574 5f63 6f6e 7461  t_unit_get_conta
+0000ce80: 696e 6572 2873 656c 6629 3a0a 2020 2020  iner(self):.    
+0000ce90: 2020 2020 756e 6974 203d 2073 656c 662e      unit = self.
+0000cea0: 6d6f 6465 6c2e 756e 6974 0a20 2020 2020  model.unit.     
+0000ceb0: 2020 2066 6f72 206e 616d 6520 696e 205b     for name in [
+0000cec0: 2763 3127 2c20 2763 3227 5d3a 0a20 2020  'c1', 'c2']:.   
+0000ced0: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
+0000cee0: 6572 203d 2075 6e69 742e 6765 745f 636f  er = unit.get_co
+0000cef0: 6e74 6169 6e65 7228 6e61 6d65 290a 2020  ntainer(name).  
+0000cf00: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+0000cf10: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+0000cf20: 636f 6e74 6169 6e65 722c 206f 7073 2e43  container, ops.C
+0000cf30: 6f6e 7461 696e 6572 290a 2020 2020 2020  ontainer).      
+0000cf40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000cf50: 7445 7175 616c 2863 6f6e 7461 696e 6572  tEqual(container
+0000cf60: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
+0000cf70: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0000cf80: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
+0000cf90: 6f6e 7461 696e 6572 2e70 6562 626c 652c  ontainer.pebble,
+0000cfa0: 2070 6562 626c 652e 436c 6965 6e74 290a   pebble.Client).
+0000cfb0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000cfc0: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0000cfd0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+0000cfe0: 2020 2020 2020 2020 2020 2020 756e 6974              unit
+0000cff0: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
+0000d000: 6333 2729 0a0a 2020 2020 2020 2020 7769  c3')..        wi
+0000d010: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000d020: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+0000d030: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d040: 6f74 6865 725f 756e 6974 203d 2073 656c  other_unit = sel
+0000d050: 662e 6d6f 6465 6c2e 6765 745f 756e 6974  f.model.get_unit
+0000d060: 2827 6f74 6865 7227 290a 2020 2020 2020  ('other').      
+0000d070: 2020 2020 2020 6f74 6865 725f 756e 6974        other_unit
+0000d080: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
+0000d090: 666f 6f27 290a 0a0a 636c 6173 7320 5465  foo')...class Te
+0000d0a0: 7374 436f 6e74 6169 6e65 7250 6562 626c  stContainerPebbl
+0000d0b0: 6528 756e 6974 7465 7374 2e54 6573 7443  e(unittest.TestC
+0000d0c0: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
+0000d0d0: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
+0000d0e0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
+0000d0f0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
+0000d100: 6c28 2222 220a 6e61 6d65 3a20 6b38 732d  l(""".name: k8s-
+0000d110: 6368 6172 6d0a 636f 6e74 6169 6e65 7273  charm.containers
+0000d120: 3a0a 2020 6331 3a0a 2020 2020 6b3a 2076  :.  c1:.    k: v
+0000d130: 0a22 2222 290a 2020 2020 2020 2020 6261  .""").        ba
+0000d140: 636b 656e 6420 3d20 4d6f 636b 5065 6262  ckend = MockPebb
+0000d150: 6c65 4261 636b 656e 6428 276d 7961 7070  leBackend('myapp
+0000d160: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+0000d170: 662e 6d6f 6465 6c20 3d20 6f70 732e 4d6f  f.model = ops.Mo
+0000d180: 6465 6c28 6d65 7461 2c20 6261 636b 656e  del(meta, backen
+0000d190: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+0000d1a0: 636f 6e74 6169 6e65 7220 3d20 7365 6c66  container = self
+0000d1b0: 2e6d 6f64 656c 2e75 6e69 742e 636f 6e74  .model.unit.cont
+0000d1c0: 6169 6e65 7273 5b27 6331 275d 0a20 2020  ainers['c1'].   
+0000d1d0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000d1e0: 203d 2073 656c 662e 636f 6e74 6169 6e65   = self.containe
+0000d1f0: 722e 7065 6262 6c65 0a0a 2020 2020 6465  r.pebble..    de
+0000d200: 6620 7465 7374 5f73 6f63 6b65 745f 7061  f test_socket_pa
+0000d210: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
+0000d220: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000d230: 616c 2873 656c 662e 7065 6262 6c65 2e73  al(self.pebble.s
+0000d240: 6f63 6b65 745f 7061 7468 2c20 272f 6368  ocket_path, '/ch
+0000d250: 6172 6d2f 636f 6e74 6169 6e65 7273 2f63  arm/containers/c
+0000d260: 312f 7065 6262 6c65 2e73 6f63 6b65 7427  1/pebble.socket'
+0000d270: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000d280: 6175 746f 7374 6172 7428 7365 6c66 293a  autostart(self):
+0000d290: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000d2a0: 6e74 6169 6e65 722e 6175 746f 7374 6172  ntainer.autostar
+0000d2b0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000d2c0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000d2d0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000d2e0: 732c 205b 2827 6175 746f 7374 6172 7427  s, [('autostart'
+0000d2f0: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
+0000d300: 7374 5f72 6570 6c61 6e28 7365 6c66 293a  st_replan(self):
+0000d310: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000d320: 6e74 6169 6e65 722e 7265 706c 616e 2829  ntainer.replan()
+0000d330: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000d340: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+0000d350: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+0000d360: 5b28 2772 6570 6c61 6e27 2c29 5d29 0a0a  [('replan',)])..
+0000d370: 2020 2020 6465 6620 7465 7374 5f63 616e      def test_can
+0000d380: 5f63 6f6e 6e65 6374 2873 656c 6629 3a0a  _connect(self):.
+0000d390: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d3a0: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000d3b0: 7065 6e64 2870 6562 626c 652e 5379 7374  pend(pebble.Syst
+0000d3c0: 656d 496e 666f 2e66 726f 6d5f 6469 6374  emInfo.from_dict
+0000d3d0: 287b 2776 6572 7369 6f6e 273a 2027 312e  ({'version': '1.
+0000d3e0: 302e 3027 7d29 290a 2020 2020 2020 2020  0.0'})).        
+0000d3f0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000d400: 7365 6c66 2e63 6f6e 7461 696e 6572 2e63  self.container.c
+0000d410: 616e 5f63 6f6e 6e65 6374 2829 290a 2020  an_connect()).  
+0000d420: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000d430: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+0000d440: 6c65 2e72 6571 7565 7374 732c 205b 2827  le.requests, [('
+0000d450: 6765 745f 7379 7374 656d 5f69 6e66 6f27  get_system_info'
+0000d460: 2c29 5d29 0a0a 2020 2020 6465 6620 7465  ,)])..    def te
+0000d470: 7374 5f73 7461 7274 2873 656c 6629 3a0a  st_start(self):.
+0000d480: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000d490: 7461 696e 6572 2e73 7461 7274 2827 666f  tainer.start('fo
+0000d4a0: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
+0000d4b0: 2e63 6f6e 7461 696e 6572 2e73 7461 7274  .container.start
+0000d4c0: 2827 666f 6f27 2c20 2762 6172 2729 0a20  ('foo', 'bar'). 
+0000d4d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d4e0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+0000d4f0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
+0000d500: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
+0000d510: 6172 7427 2c20 2827 666f 6f27 2c29 292c  art', ('foo',)),
+0000d520: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+0000d530: 7461 7274 272c 2028 2766 6f6f 272c 2027  tart', ('foo', '
+0000d540: 6261 7227 2929 2c0a 2020 2020 2020 2020  bar')),.        
+0000d550: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+0000d560: 5f73 7461 7274 5f6e 6f5f 6172 6775 6d65  _start_no_argume
+0000d570: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+0000d580: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000d590: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+0000d5a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000d5b0: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
+0000d5c0: 2e73 7461 7274 2829 0a0a 2020 2020 6465  .start()..    de
+0000d5d0: 6620 7465 7374 5f73 746f 7028 7365 6c66  f test_stop(self
+0000d5e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000d5f0: 636f 6e74 6169 6e65 722e 7374 6f70 2827  container.stop('
+0000d600: 666f 6f27 290a 2020 2020 2020 2020 7365  foo').        se
+0000d610: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
+0000d620: 7028 2766 6f6f 272c 2027 6261 7227 290a  p('foo', 'bar').
+0000d630: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000d640: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000d650: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
 0000d660: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
-0000d670: 746f 7027 2c20 2827 666f 6f27 2c20 2762  top', ('foo', 'b
-0000d680: 6172 2729 292c 0a20 2020 2020 2020 205d  ar')),.        ]
-0000d690: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000d6a0: 7374 6f70 5f6e 6f5f 6172 6775 6d65 6e74  stop_no_argument
-0000d6b0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0000d6c0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000d6d0: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-0000d6e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000d6f0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e73  self.container.s
-0000d700: 746f 7028 290a 0a20 2020 2064 6566 2074  top()..    def t
-0000d710: 6573 745f 7265 7374 6172 7428 7365 6c66  est_restart(self
-0000d720: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000d730: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
-0000d740: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
-0000d750: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000d760: 7265 7374 6172 7428 2766 6f6f 272c 2027  restart('foo', '
-0000d770: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
-0000d780: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000d790: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000d7a0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000d7b0: 2020 2028 2772 6573 7461 7274 272c 2028     ('restart', (
-0000d7c0: 2766 6f6f 272c 2929 2c0a 2020 2020 2020  'foo',)),.      
-0000d7d0: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
-0000d7e0: 2c20 2827 666f 6f27 2c20 2762 6172 2729  , ('foo', 'bar')
-0000d7f0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0000d800: 2020 2064 6566 2074 6573 745f 7265 7374     def test_rest
-0000d810: 6172 745f 6661 6c6c 6261 636b 2873 656c  art_fallback(sel
-0000d820: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
-0000d830: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
-0000d840: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
-0000d850: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000d860: 626c 652e 7265 7175 6573 7473 2e61 7070  ble.requests.app
-0000d870: 656e 6428 2827 7265 7374 6172 7427 2c20  end(('restart', 
-0000d880: 7365 7276 6963 6573 2929 0a20 2020 2020  services)).     
-0000d890: 2020 2020 2020 2072 6169 7365 2070 6562         raise peb
-0000d8a0: 626c 652e 4150 4945 7272 6f72 287b 7d2c  ble.APIError({},
-0000d8b0: 2034 3030 2c20 2222 2c20 2222 290a 0a20   400, "", "").. 
-0000d8c0: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
-0000d8d0: 6c65 2e72 6573 7461 7274 5f73 6572 7669  le.restart_servi
-0000d8e0: 6365 7320 3d20 7265 7374 6172 745f 7365  ces = restart_se
-0000d8f0: 7276 6963 6573 0a20 2020 2020 2020 2023  rvices.        #
-0000d900: 2053 6574 7570 2074 6865 2050 6562 626c   Setup the Pebbl
-0000d910: 6520 636c 6965 6e74 2074 6f20 7265 7370  e client to resp
-0000d920: 6f6e 6420 746f 2061 2063 616c 6c20 746f  ond to a call to
-0000d930: 2067 6574 5f73 6572 7669 6365 7328 290a   get_services().
-0000d940: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000d950: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000d960: 7065 6e64 285b 0a20 2020 2020 2020 2020  pend([.         
-0000d970: 2020 2070 6562 626c 652e 5365 7276 6963     pebble.Servic
-0000d980: 6549 6e66 6f2e 6672 6f6d 5f64 6963 7428  eInfo.from_dict(
-0000d990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d9a0: 207b 276e 616d 6527 3a20 2766 6f6f 272c   {'name': 'foo',
-0000d9b0: 2027 7374 6172 7475 7027 3a20 2765 6e61   'startup': 'ena
-0000d9c0: 626c 6564 272c 2027 6375 7272 656e 7427  bled', 'current'
-0000d9d0: 3a20 2761 6374 6976 6527 7d29 2c0a 2020  : 'active'}),.  
-0000d9e0: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
-0000d9f0: 2e53 6572 7669 6365 496e 666f 2e66 726f  .ServiceInfo.fro
-0000da00: 6d5f 6469 6374 280a 2020 2020 2020 2020  m_dict(.        
-0000da10: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-0000da20: 2027 6261 7227 2c20 2773 7461 7274 7570   'bar', 'startup
-0000da30: 273a 2027 656e 6162 6c65 6427 2c20 2763  ': 'enabled', 'c
-0000da40: 7572 7265 6e74 273a 2027 696e 6163 7469  urrent': 'inacti
-0000da50: 7665 277d 292c 0a20 2020 2020 2020 205d  ve'}),.        ]
-0000da60: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000da70: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
-0000da80: 7428 2766 6f6f 272c 2027 6261 7227 290a  t('foo', 'bar').
-0000da90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000daa0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
-0000dab0: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
-0000dac0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0000dad0: 6869 7320 6973 2074 6865 2066 6972 7374  his is the first
-0000dae0: 2072 6571 7565 7374 2c20 7768 6963 6820   request, which 
-0000daf0: 696e 2072 6561 6c20 6c69 6665 2066 6169  in real life fai
-0000db00: 6c73 2077 6974 6820 4150 4945 7272 6f72  ls with APIError
-0000db10: 206f 6e20 6f6c 6465 7220 7665 7273 696f   on older versio
-0000db20: 6e73 0a20 2020 2020 2020 2020 2020 2028  ns.            (
-0000db30: 2772 6573 7461 7274 272c 2028 2766 6f6f  'restart', ('foo
-0000db40: 272c 2027 6261 7227 2929 2c0a 2020 2020  ', 'bar')),.    
-0000db50: 2020 2020 2020 2020 2320 4e65 7874 2074          # Next t
-0000db60: 6865 2063 6f64 6520 7368 6f75 6c64 206c  he code should l
-0000db70: 6f6f 7020 6f76 6572 2074 6865 2073 7461  oop over the sta
-0000db80: 7274 6564 2073 6572 7669 6365 732c 2061  rted services, a
-0000db90: 6e64 2073 746f 7020 7468 656d 0a20 2020  nd stop them.   
-0000dba0: 2020 2020 2020 2020 2028 2767 6574 5f73           ('get_s
-0000dbb0: 6572 7669 6365 7327 2c20 2827 666f 6f27  ervices', ('foo'
-0000dbc0: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
-0000dbd0: 2020 2020 2020 2028 2773 746f 7027 2c20         ('stop', 
-0000dbe0: 2827 666f 6f27 2c29 292c 0a20 2020 2020  ('foo',)),.     
-0000dbf0: 2020 2020 2020 2023 2054 6865 6e20 7374         # Then st
-0000dc00: 6172 7420 616c 6c20 7468 6520 7370 6563  art all the spec
-0000dc10: 6966 6965 6420 7365 7276 6963 6573 0a20  ified services. 
-0000dc20: 2020 2020 2020 2020 2020 2028 2773 7461             ('sta
-0000dc30: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
-0000dc40: 7227 2929 0a20 2020 2020 2020 205d 290a  r')).        ]).
-0000dc50: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
-0000dc60: 7374 6172 745f 6661 6c6c 6261 636b 5f6e  start_fallback_n
-0000dc70: 6f6e 5f34 3030 5f65 7272 6f72 2873 656c  on_400_error(sel
-0000dc80: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
-0000dc90: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
-0000dca0: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
-0000dcb0: 2020 2020 2020 2020 7261 6973 6520 7065          raise pe
-0000dcc0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
-0000dcd0: 2c20 3530 302c 2022 222c 2022 2229 0a0a  , 500, "", "")..
-0000dce0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000dcf0: 626c 652e 7265 7374 6172 745f 7365 7276  ble.restart_serv
-0000dd00: 6963 6573 203d 2072 6573 7461 7274 5f73  ices = restart_s
-0000dd10: 6572 7669 6365 730a 2020 2020 2020 2020  ervices.        
-0000dd20: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000dd30: 5261 6973 6573 2870 6562 626c 652e 4150  Raises(pebble.AP
-0000dd40: 4945 7272 6f72 2920 6173 2063 6d3a 0a20  IError) as cm:. 
-0000dd50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000dd60: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
-0000dd70: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
-0000dd80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000dd90: 6c28 636d 2e65 7863 6570 7469 6f6e 2e63  l(cm.exception.c
-0000dda0: 6f64 652c 2035 3030 290a 0a20 2020 2064  ode, 500)..    d
-0000ddb0: 6566 2074 6573 745f 7265 7374 6172 745f  ef test_restart_
-0000ddc0: 6e6f 5f61 7267 756d 656e 7473 2873 656c  no_arguments(sel
-0000ddd0: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
-0000dde0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000ddf0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-0000de00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000de10: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
-0000de20: 7428 290a 0a20 2020 2064 6566 2074 6573  t()..    def tes
-0000de30: 745f 7479 7065 5f65 7272 6f72 7328 7365  t_type_errors(se
-0000de40: 6c66 293a 0a20 2020 2020 2020 206d 6574  lf):.        met
-0000de50: 6120 3d20 6f70 732e 4368 6172 6d4d 6574  a = ops.CharmMet
-0000de60: 612e 6672 6f6d 5f79 616d 6c28 2222 220a  a.from_yaml(""".
-0000de70: 6e61 6d65 3a20 6b38 732d 6368 6172 6d0a  name: k8s-charm.
-0000de80: 636f 6e74 6169 6e65 7273 3a0a 2020 6331  containers:.  c1
-0000de90: 3a0a 2020 2020 6b3a 2076 0a22 2222 290a  :.    k: v.""").
-0000dea0: 2020 2020 2020 2020 2320 4f6e 6c79 2074          # Only t
-0000deb0: 6865 2072 6561 6c20 7065 6262 6c65 2043  he real pebble C
-0000dec0: 6c69 656e 7420 6368 6563 6b73 2074 7970  lient checks typ
-0000ded0: 6573 2c20 736f 2075 7365 2061 6374 7561  es, so use actua
-0000dee0: 6c20 6261 636b 656e 6420 636c 6173 730a  l backend class.
-0000def0: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
-0000df00: 3d20 5f4d 6f64 656c 4261 636b 656e 6428  = _ModelBackend(
-0000df10: 276d 7961 7070 2f30 2729 0a20 2020 2020  'myapp/0').     
-0000df20: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
-0000df30: 6f64 656c 286d 6574 612c 2062 6163 6b65  odel(meta, backe
-0000df40: 6e64 290a 2020 2020 2020 2020 636f 6e74  nd).        cont
-0000df50: 6169 6e65 7220 3d20 6d6f 6465 6c2e 756e  ainer = model.un
-0000df60: 6974 2e63 6f6e 7461 696e 6572 735b 2763  it.containers['c
-0000df70: 3127 5d0a 0a20 2020 2020 2020 2077 6974  1']..        wit
-0000df80: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000df90: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-0000dfa0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000dfb0: 6169 6e65 722e 7374 6172 7428 5b27 666f  ainer.start(['fo
-0000dfc0: 6f27 5d29 0a0a 2020 2020 2020 2020 7769  o'])..        wi
-0000dfd0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000dfe0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-0000dff0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000e000: 7461 696e 6572 2e73 746f 7028 5b27 666f  tainer.stop(['fo
-0000e010: 6f27 5d29 0a0a 2020 2020 6465 6620 7465  o'])..    def te
-0000e020: 7374 5f61 6464 5f6c 6179 6572 2873 656c  st_add_layer(sel
-0000e030: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000e040: 2e63 6f6e 7461 696e 6572 2e61 6464 5f6c  .container.add_l
-0000e050: 6179 6572 2827 6127 2c20 2773 756d 6d61  ayer('a', 'summa
-0000e060: 7279 3a20 7374 725c 6e27 290a 2020 2020  ry: str\n').    
-0000e070: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000e080: 6572 2e61 6464 5f6c 6179 6572 2827 6227  er.add_layer('b'
-0000e090: 2c20 7b27 7375 6d6d 6172 7927 3a20 2764  , {'summary': 'd
-0000e0a0: 6963 7427 7d29 0a20 2020 2020 2020 2073  ict'}).        s
-0000e0b0: 656c 662e 636f 6e74 6169 6e65 722e 6164  elf.container.ad
-0000e0c0: 645f 6c61 7965 7228 2763 272c 2070 6562  d_layer('c', peb
-0000e0d0: 626c 652e 4c61 7965 7228 2773 756d 6d61  ble.Layer('summa
-0000e0e0: 7279 3a20 4c61 7965 7227 2929 0a20 2020  ry: Layer')).   
-0000e0f0: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
-0000e100: 6e65 722e 6164 645f 6c61 7965 7228 2764  ner.add_layer('d
-0000e110: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
-0000e120: 5c6e 272c 2063 6f6d 6269 6e65 3d54 7275  \n', combine=Tru
-0000e130: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-0000e140: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000e150: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000e160: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000e170: 2827 6164 645f 6c61 7965 7227 2c20 2761  ('add_layer', 'a
-0000e180: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
-0000e190: 5c6e 272c 2046 616c 7365 292c 0a20 2020  \n', False),.   
-0000e1a0: 2020 2020 2020 2020 2028 2761 6464 5f6c           ('add_l
-0000e1b0: 6179 6572 272c 2027 6227 2c20 2773 756d  ayer', 'b', 'sum
-0000e1c0: 6d61 7279 3a20 6469 6374 5c6e 272c 2046  mary: dict\n', F
-0000e1d0: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
-0000e1e0: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
-0000e1f0: 2027 6327 2c20 2773 756d 6d61 7279 3a20   'c', 'summary: 
-0000e200: 4c61 7965 725c 6e27 2c20 4661 6c73 6529  Layer\n', False)
-0000e210: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-0000e220: 6164 645f 6c61 7965 7227 2c20 2764 272c  add_layer', 'd',
-0000e230: 2027 7375 6d6d 6172 793a 2073 7472 5c6e   'summary: str\n
-0000e240: 272c 2054 7275 6529 2c0a 2020 2020 2020  ', True),.      
-0000e250: 2020 5d29 0a0a 2020 2020 2020 2020 2320    ])..        # 
-0000e260: 636f 6d62 696e 6520 6973 2061 206b 6579  combine is a key
-0000e270: 776f 7264 2d6f 6e6c 7920 6172 6720 2873  word-only arg (s
-0000e280: 686f 756c 6420 6265 2063 6f6d 6269 6e65  hould be combine
-0000e290: 3d54 7275 6529 0a20 2020 2020 2020 2077  =True).        w
-0000e2a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000e2b0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-0000e2c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000e2d0: 6c66 2e63 6f6e 7461 696e 6572 2e61 6464  lf.container.add
-0000e2e0: 5f6c 6179 6572 2827 7827 2c20 7b7d 2c20  _layer('x', {}, 
-0000e2f0: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
-0000e300: 6573 745f 6765 745f 706c 616e 2873 656c  est_get_plan(sel
-0000e310: 6629 3a0a 2020 2020 2020 2020 706c 616e  f):.        plan
-0000e320: 5f79 616d 6c20 3d20 2773 6572 7669 6365  _yaml = 'service
-0000e330: 733a 5c6e 2066 6f6f 3a5c 6e20 206f 7665  s:\n foo:\n  ove
-0000e340: 7272 6964 653a 2072 6570 6c61 6365 5c6e  rride: replace\n
-0000e350: 2020 636f 6d6d 616e 643a 2062 6172 270a    command: bar'.
-0000e360: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000e370: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000e380: 7065 6e64 2870 6562 626c 652e 506c 616e  pend(pebble.Plan
-0000e390: 2870 6c61 6e5f 7961 6d6c 2929 0a20 2020  (plan_yaml)).   
-0000e3a0: 2020 2020 2070 6c61 6e20 3d20 7365 6c66       plan = self
-0000e3b0: 2e63 6f6e 7461 696e 6572 2e67 6574 5f70  .container.get_p
-0000e3c0: 6c61 6e28 290a 2020 2020 2020 2020 7365  lan().        se
-0000e3d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000e3e0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000e3f0: 7374 732c 205b 2827 6765 745f 706c 616e  sts, [('get_plan
-0000e400: 272c 295d 290a 2020 2020 2020 2020 7365  ',)]).        se
-0000e410: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-0000e420: 6e63 6528 706c 616e 2c20 7065 6262 6c65  nce(plan, pebble
-0000e430: 2e50 6c61 6e29 0a20 2020 2020 2020 2073  .Plan).        s
-0000e440: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000e450: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
-0000e460: 7961 6d6c 2e73 6166 655f 6475 6d70 2879  yaml.safe_dump(y
-0000e470: 616d 6c2e 7361 6665 5f6c 6f61 6428 706c  aml.safe_load(pl
-0000e480: 616e 5f79 616d 6c29 2929 0a0a 2020 2020  an_yaml)))..    
-0000e490: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0000e4a0: 2020 6465 6620 5f6d 616b 655f 7365 7276    def _make_serv
-0000e4b0: 6963 6528 6e61 6d65 2c20 7374 6172 7475  ice(name, startu
-0000e4c0: 702c 2063 7572 7265 6e74 293a 0a20 2020  p, current):.   
-0000e4d0: 2020 2020 2072 6574 7572 6e20 7065 6262       return pebb
-0000e4e0: 6c65 2e53 6572 7669 6365 496e 666f 2e66  le.ServiceInfo.f
-0000e4f0: 726f 6d5f 6469 6374 280a 2020 2020 2020  rom_dict(.      
-0000e500: 2020 2020 2020 7b27 6e61 6d65 273a 206e        {'name': n
-0000e510: 616d 652c 2027 7374 6172 7475 7027 3a20  ame, 'startup': 
-0000e520: 7374 6172 7475 702c 2027 6375 7272 656e  startup, 'curren
-0000e530: 7427 3a20 6375 7272 656e 747d 290a 0a20  t': current}).. 
-0000e540: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-0000e550: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
-0000e560: 2020 2020 2020 2020 7477 6f5f 7365 7276          two_serv
-0000e570: 6963 6573 203d 205b 0a20 2020 2020 2020  ices = [.       
-0000e580: 2020 2020 2073 656c 662e 5f6d 616b 655f       self._make_
-0000e590: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
-0000e5a0: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
-0000e5b0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-0000e5c0: 7365 6c66 2e5f 6d61 6b65 5f73 6572 7669  self._make_servi
-0000e5d0: 6365 2827 7332 272c 2027 6469 7361 626c  ce('s2', 'disabl
-0000e5e0: 6564 272c 2027 696e 6163 7469 7665 2729  ed', 'inactive')
-0000e5f0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
-0000e600: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000e610: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000e620: 2874 776f 5f73 6572 7669 6365 7329 0a20  (two_services). 
-0000e630: 2020 2020 2020 2073 6572 7669 6365 7320         services 
-0000e640: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
-0000e650: 2e67 6574 5f73 6572 7669 6365 7328 290a  .get_services().
-0000e660: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000e670: 6572 7445 7175 616c 286c 656e 2873 6572  ertEqual(len(ser
-0000e680: 7669 6365 7329 2c20 3229 0a20 2020 2020  vices), 2).     
-0000e690: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e6a0: 7561 6c28 7365 7428 7365 7276 6963 6573  ual(set(services
-0000e6b0: 292c 207b 2773 3127 2c20 2773 3227 7d29  ), {'s1', 's2'})
-0000e6c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e6d0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-0000e6e0: 6573 5b27 7331 275d 2e6e 616d 652c 2027  es['s1'].name, '
-0000e6f0: 7331 2729 0a20 2020 2020 2020 2073 656c  s1').        sel
-0000e700: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e710: 7276 6963 6573 5b27 7331 275d 2e73 7461  rvices['s1'].sta
-0000e720: 7274 7570 2c20 7065 6262 6c65 2e53 6572  rtup, pebble.Ser
-0000e730: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
-0000e740: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
-0000e750: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e760: 7276 6963 6573 5b27 7331 275d 2e63 7572  rvices['s1'].cur
-0000e770: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
-0000e780: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
-0000e790: 4529 0a20 2020 2020 2020 2073 656c 662e  E).        self.
-0000e7a0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
-0000e7b0: 6963 6573 5b27 7332 275d 2e6e 616d 652c  ices['s2'].name,
-0000e7c0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
-0000e7d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000e7e0: 7365 7276 6963 6573 5b27 7332 275d 2e73  services['s2'].s
-0000e7f0: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
-0000e800: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
-0000e810: 5341 424c 4544 290a 2020 2020 2020 2020  SABLED).        
-0000e820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000e830: 2873 6572 7669 6365 735b 2773 3227 5d2e  (services['s2'].
-0000e840: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
-0000e850: 5365 7276 6963 6553 7461 7475 732e 494e  ServiceStatus.IN
-0000e860: 4143 5449 5645 290a 0a20 2020 2020 2020  ACTIVE)..       
-0000e870: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
-0000e880: 706f 6e73 6573 2e61 7070 656e 6428 7477  ponses.append(tw
-0000e890: 6f5f 7365 7276 6963 6573 290a 2020 2020  o_services).    
-0000e8a0: 2020 2020 7365 7276 6963 6573 203d 2073      services = s
-0000e8b0: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
-0000e8c0: 745f 7365 7276 6963 6573 2827 7331 272c  t_services('s1',
-0000e8d0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
-0000e8e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000e8f0: 6c65 6e28 7365 7276 6963 6573 292c 2032  len(services), 2
-0000e900: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000e910: 7373 6572 7445 7175 616c 2873 6574 2873  ssertEqual(set(s
-0000e920: 6572 7669 6365 7329 2c20 7b27 7331 272c  ervices), {'s1',
-0000e930: 2027 7332 277d 290a 2020 2020 2020 2020   's2'}).        
-0000e940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000e950: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
-0000e960: 6e61 6d65 2c20 2773 3127 290a 2020 2020  name, 's1').    
-0000e970: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000e980: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
-0000e990: 3127 5d2e 7374 6172 7475 702c 2070 6562  1'].startup, peb
-0000e9a0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-0000e9b0: 7570 2e45 4e41 424c 4544 290a 2020 2020  up.ENABLED).    
-0000e9c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000e9d0: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
-0000e9e0: 3127 5d2e 6375 7272 656e 742c 2070 6562  1'].current, peb
-0000e9f0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-0000ea00: 732e 4143 5449 5645 290a 2020 2020 2020  s.ACTIVE).      
-0000ea10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000ea20: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
-0000ea30: 5d2e 6e61 6d65 2c20 2773 3227 290a 2020  ].name, 's2').  
-0000ea40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000ea50: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
-0000ea60: 2773 3227 5d2e 7374 6172 7475 702c 2070  's2'].startup, p
-0000ea70: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-0000ea80: 7274 7570 2e44 4953 4142 4c45 4429 0a20  rtup.DISABLED). 
-0000ea90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000eaa0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
-0000eab0: 5b27 7332 275d 2e63 7572 7265 6e74 2c20  ['s2'].current, 
-0000eac0: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-0000ead0: 6174 7573 2e49 4e41 4354 4956 4529 0a0a  atus.INACTIVE)..
-0000eae0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000eaf0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
-0000eb00: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
-0000eb10: 0a20 2020 2020 2020 2020 2020 2028 2767  .            ('g
-0000eb20: 6574 5f73 6572 7669 6365 7327 2c20 4e6f  et_services', No
-0000eb30: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
-0000eb40: 2028 2767 6574 5f73 6572 7669 6365 7327   ('get_services'
-0000eb50: 2c20 2827 7331 272c 2027 7332 2729 292c  , ('s1', 's2')),
-0000eb60: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-0000eb70: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
-0000eb80: 7276 6963 6528 7365 6c66 293a 0a20 2020  rvice(self):.   
-0000eb90: 2020 2020 2023 2053 696e 676c 6520 7365       # Single se
-0000eba0: 7276 6963 6520 7265 7475 726e 6564 2073  rvice returned s
-0000ebb0: 7563 6365 7373 6675 6c6c 790a 2020 2020  uccessfully.    
-0000ebc0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000ebd0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000ebe0: 285b 7365 6c66 2e5f 6d61 6b65 5f73 6572  ([self._make_ser
-0000ebf0: 7669 6365 2827 7331 272c 2027 656e 6162  vice('s1', 'enab
-0000ec00: 6c65 6427 2c20 2761 6374 6976 6527 295d  led', 'active')]
-0000ec10: 290a 2020 2020 2020 2020 7320 3d20 7365  ).        s = se
-0000ec20: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000ec30: 5f73 6572 7669 6365 2827 7331 2729 0a20  _service('s1'). 
-0000ec40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ec50: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
-0000ec60: 626c 652e 7265 7175 6573 7473 2c20 5b28  ble.requests, [(
-0000ec70: 2767 6574 5f73 6572 7669 6365 7327 2c20  'get_services', 
-0000ec80: 2827 7331 272c 2029 295d 290a 2020 2020  ('s1', ))]).    
-0000ec90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000eca0: 7175 616c 2873 2e6e 616d 652c 2027 7331  qual(s.name, 's1
-0000ecb0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000ecc0: 6173 7365 7274 4571 7561 6c28 732e 7374  assertEqual(s.st
-0000ecd0: 6172 7475 702c 2070 6562 626c 652e 5365  artup, pebble.Se
-0000ece0: 7276 6963 6553 7461 7274 7570 2e45 4e41  rviceStartup.ENA
-0000ecf0: 424c 4544 290a 2020 2020 2020 2020 7365  BLED).        se
-0000ed00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000ed10: 2e63 7572 7265 6e74 2c20 7065 6262 6c65  .current, pebble
-0000ed20: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
-0000ed30: 4354 4956 4529 0a0a 2020 2020 2020 2020  CTIVE)..        
-0000ed40: 2320 4966 2050 6562 626c 6520 7265 7475  # If Pebble retu
-0000ed50: 726e 7320 6e6f 2073 6572 7669 6365 732c  rns no services,
-0000ed60: 2073 686f 756c 6420 6265 2061 206f 7073   should be a ops
-0000ed70: 2e4d 6f64 656c 4572 726f 720a 2020 2020  .ModelError.    
-0000ed80: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000ed90: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000eda0: 285b 5d29 0a20 2020 2020 2020 2077 6974  ([]).        wit
-0000edb0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000edc0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
-0000edd0: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-0000ede0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000edf0: 6169 6e65 722e 6765 745f 7365 7276 6963  ainer.get_servic
-0000ee00: 6528 2773 3227 290a 2020 2020 2020 2020  e('s2').        
-0000ee10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ee20: 2873 7472 2863 6d2e 6578 6365 7074 696f  (str(cm.exceptio
-0000ee30: 6e29 2c20 2273 6572 7669 6365 2027 7332  n), "service 's2
-0000ee40: 2720 6e6f 7420 666f 756e 6422 290a 0a20  ' not found").. 
-0000ee50: 2020 2020 2020 2023 2049 6620 5065 6262         # If Pebb
-0000ee60: 6c65 2072 6574 7572 6e73 206d 6f72 6520  le returns more 
-0000ee70: 7468 616e 206f 6e65 2073 6572 7669 6365  than one service
-0000ee80: 2c20 5275 6e74 696d 6545 7272 6f72 2069  , RuntimeError i
-0000ee90: 7320 7261 6973 6564 0a20 2020 2020 2020  s raised.       
-0000eea0: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
-0000eeb0: 706f 6e73 6573 2e61 7070 656e 6428 5b0a  ponses.append([.
-0000eec0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000eed0: 2e5f 6d61 6b65 5f73 6572 7669 6365 2827  ._make_service('
-0000eee0: 7331 272c 2027 656e 6162 6c65 6427 2c20  s1', 'enabled', 
-0000eef0: 2761 6374 6976 6527 292c 0a20 2020 2020  'active'),.     
-0000ef00: 2020 2020 2020 2073 656c 662e 5f6d 616b         self._mak
-0000ef10: 655f 7365 7276 6963 6528 2773 3227 2c20  e_service('s2', 
-0000ef20: 2764 6973 6162 6c65 6427 2c20 2769 6e61  'disabled', 'ina
-0000ef30: 6374 6976 6527 292c 0a20 2020 2020 2020  ctive'),.       
-0000ef40: 205d 290a 2020 2020 2020 2020 7769 7468   ]).        with
-0000ef50: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000ef60: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000ef70: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000ef80: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000ef90: 5f73 6572 7669 6365 2827 7331 2729 0a0a  _service('s1')..
-0000efa0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000efb0: 5f63 6865 636b 7328 7365 6c66 293a 0a20  _checks(self):. 
-0000efc0: 2020 2020 2020 2072 6573 706f 6e73 655f         response_
-0000efd0: 6368 6563 6b73 203d 205b 0a20 2020 2020  checks = [.     
-0000efe0: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
-0000eff0: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
-0000f000: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
-0000f010: 2020 2020 276e 616d 6527 3a20 2763 3127      'name': 'c1'
-0000f020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f030: 2020 2773 7461 7475 7327 3a20 2775 7027    'status': 'up'
+0000d670: 746f 7027 2c20 2827 666f 6f27 2c29 292c  top', ('foo',)),
+0000d680: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+0000d690: 746f 7027 2c20 2827 666f 6f27 2c20 2762  top', ('foo', 'b
+0000d6a0: 6172 2729 292c 0a20 2020 2020 2020 205d  ar')),.        ]
+0000d6b0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000d6c0: 7374 6f70 5f6e 6f5f 6172 6775 6d65 6e74  stop_no_argument
+0000d6d0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000d6e0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000d6f0: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0000d700: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d710: 7365 6c66 2e63 6f6e 7461 696e 6572 2e73  self.container.s
+0000d720: 746f 7028 290a 0a20 2020 2064 6566 2074  top()..    def t
+0000d730: 6573 745f 7265 7374 6172 7428 7365 6c66  est_restart(self
+0000d740: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000d750: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000d760: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
+0000d770: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000d780: 7265 7374 6172 7428 2766 6f6f 272c 2027  restart('foo', '
+0000d790: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
+0000d7a0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000d7b0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000d7c0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000d7d0: 2020 2028 2772 6573 7461 7274 272c 2028     ('restart', (
+0000d7e0: 2766 6f6f 272c 2929 2c0a 2020 2020 2020  'foo',)),.      
+0000d7f0: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
+0000d800: 2c20 2827 666f 6f27 2c20 2762 6172 2729  , ('foo', 'bar')
+0000d810: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+0000d820: 2020 2064 6566 2074 6573 745f 7265 7374     def test_rest
+0000d830: 6172 745f 6661 6c6c 6261 636b 2873 656c  art_fallback(sel
+0000d840: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000d850: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
+0000d860: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
+0000d870: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d880: 626c 652e 7265 7175 6573 7473 2e61 7070  ble.requests.app
+0000d890: 656e 6428 2827 7265 7374 6172 7427 2c20  end(('restart', 
+0000d8a0: 7365 7276 6963 6573 2929 0a20 2020 2020  services)).     
+0000d8b0: 2020 2020 2020 2072 6169 7365 2070 6562         raise peb
+0000d8c0: 626c 652e 4150 4945 7272 6f72 287b 7d2c  ble.APIError({},
+0000d8d0: 2034 3030 2c20 2222 2c20 2222 290a 0a20   400, "", "").. 
+0000d8e0: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
+0000d8f0: 6c65 2e72 6573 7461 7274 5f73 6572 7669  le.restart_servi
+0000d900: 6365 7320 3d20 7265 7374 6172 745f 7365  ces = restart_se
+0000d910: 7276 6963 6573 0a20 2020 2020 2020 2023  rvices.        #
+0000d920: 2053 6574 7570 2074 6865 2050 6562 626c   Setup the Pebbl
+0000d930: 6520 636c 6965 6e74 2074 6f20 7265 7370  e client to resp
+0000d940: 6f6e 6420 746f 2061 2063 616c 6c20 746f  ond to a call to
+0000d950: 2067 6574 5f73 6572 7669 6365 7328 290a   get_services().
+0000d960: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000d970: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000d980: 7065 6e64 285b 0a20 2020 2020 2020 2020  pend([.         
+0000d990: 2020 2070 6562 626c 652e 5365 7276 6963     pebble.Servic
+0000d9a0: 6549 6e66 6f2e 6672 6f6d 5f64 6963 7428  eInfo.from_dict(
+0000d9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d9c0: 207b 276e 616d 6527 3a20 2766 6f6f 272c   {'name': 'foo',
+0000d9d0: 2027 7374 6172 7475 7027 3a20 2765 6e61   'startup': 'ena
+0000d9e0: 626c 6564 272c 2027 6375 7272 656e 7427  bled', 'current'
+0000d9f0: 3a20 2761 6374 6976 6527 7d29 2c0a 2020  : 'active'}),.  
+0000da00: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+0000da10: 2e53 6572 7669 6365 496e 666f 2e66 726f  .ServiceInfo.fro
+0000da20: 6d5f 6469 6374 280a 2020 2020 2020 2020  m_dict(.        
+0000da30: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+0000da40: 2027 6261 7227 2c20 2773 7461 7274 7570   'bar', 'startup
+0000da50: 273a 2027 656e 6162 6c65 6427 2c20 2763  ': 'enabled', 'c
+0000da60: 7572 7265 6e74 273a 2027 696e 6163 7469  urrent': 'inacti
+0000da70: 7665 277d 292c 0a20 2020 2020 2020 205d  ve'}),.        ]
+0000da80: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000da90: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000daa0: 7428 2766 6f6f 272c 2027 6261 7227 290a  t('foo', 'bar').
+0000dab0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000dac0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000dad0: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
+0000dae0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000daf0: 6869 7320 6973 2074 6865 2066 6972 7374  his is the first
+0000db00: 2072 6571 7565 7374 2c20 7768 6963 6820   request, which 
+0000db10: 696e 2072 6561 6c20 6c69 6665 2066 6169  in real life fai
+0000db20: 6c73 2077 6974 6820 4150 4945 7272 6f72  ls with APIError
+0000db30: 206f 6e20 6f6c 6465 7220 7665 7273 696f   on older versio
+0000db40: 6e73 0a20 2020 2020 2020 2020 2020 2028  ns.            (
+0000db50: 2772 6573 7461 7274 272c 2028 2766 6f6f  'restart', ('foo
+0000db60: 272c 2027 6261 7227 2929 2c0a 2020 2020  ', 'bar')),.    
+0000db70: 2020 2020 2020 2020 2320 4e65 7874 2074          # Next t
+0000db80: 6865 2063 6f64 6520 7368 6f75 6c64 206c  he code should l
+0000db90: 6f6f 7020 6f76 6572 2074 6865 2073 7461  oop over the sta
+0000dba0: 7274 6564 2073 6572 7669 6365 732c 2061  rted services, a
+0000dbb0: 6e64 2073 746f 7020 7468 656d 0a20 2020  nd stop them.   
+0000dbc0: 2020 2020 2020 2020 2028 2767 6574 5f73           ('get_s
+0000dbd0: 6572 7669 6365 7327 2c20 2827 666f 6f27  ervices', ('foo'
+0000dbe0: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
+0000dbf0: 2020 2020 2020 2028 2773 746f 7027 2c20         ('stop', 
+0000dc00: 2827 666f 6f27 2c29 292c 0a20 2020 2020  ('foo',)),.     
+0000dc10: 2020 2020 2020 2023 2054 6865 6e20 7374         # Then st
+0000dc20: 6172 7420 616c 6c20 7468 6520 7370 6563  art all the spec
+0000dc30: 6966 6965 6420 7365 7276 6963 6573 0a20  ified services. 
+0000dc40: 2020 2020 2020 2020 2020 2028 2773 7461             ('sta
+0000dc50: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
+0000dc60: 7227 2929 0a20 2020 2020 2020 205d 290a  r')).        ]).
+0000dc70: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+0000dc80: 7374 6172 745f 6661 6c6c 6261 636b 5f6e  start_fallback_n
+0000dc90: 6f6e 5f34 3030 5f65 7272 6f72 2873 656c  on_400_error(sel
+0000dca0: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000dcb0: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
+0000dcc0: 2873 6572 7669 6365 7329 3a0a 2020 2020  (services):.    
+0000dcd0: 2020 2020 2020 2020 7261 6973 6520 7065          raise pe
+0000dce0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
+0000dcf0: 2c20 3530 302c 2022 222c 2022 2229 0a0a  , 500, "", "")..
+0000dd00: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000dd10: 626c 652e 7265 7374 6172 745f 7365 7276  ble.restart_serv
+0000dd20: 6963 6573 203d 2072 6573 7461 7274 5f73  ices = restart_s
+0000dd30: 6572 7669 6365 730a 2020 2020 2020 2020  ervices.        
+0000dd40: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000dd50: 5261 6973 6573 2870 6562 626c 652e 4150  Raises(pebble.AP
+0000dd60: 4945 7272 6f72 2920 6173 2063 6d3a 0a20  IError) as cm:. 
+0000dd70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000dd80: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000dd90: 7428 2766 6f6f 2729 0a20 2020 2020 2020  t('foo').       
+0000dda0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ddb0: 6c28 636d 2e65 7863 6570 7469 6f6e 2e63  l(cm.exception.c
+0000ddc0: 6f64 652c 2035 3030 290a 0a20 2020 2064  ode, 500)..    d
+0000ddd0: 6566 2074 6573 745f 7265 7374 6172 745f  ef test_restart_
+0000dde0: 6e6f 5f61 7267 756d 656e 7473 2873 656c  no_arguments(sel
+0000ddf0: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+0000de00: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000de10: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+0000de20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000de30: 636f 6e74 6169 6e65 722e 7265 7374 6172  container.restar
+0000de40: 7428 290a 0a20 2020 2064 6566 2074 6573  t()..    def tes
+0000de50: 745f 7479 7065 5f65 7272 6f72 7328 7365  t_type_errors(se
+0000de60: 6c66 293a 0a20 2020 2020 2020 206d 6574  lf):.        met
+0000de70: 6120 3d20 6f70 732e 4368 6172 6d4d 6574  a = ops.CharmMet
+0000de80: 612e 6672 6f6d 5f79 616d 6c28 2222 220a  a.from_yaml(""".
+0000de90: 6e61 6d65 3a20 6b38 732d 6368 6172 6d0a  name: k8s-charm.
+0000dea0: 636f 6e74 6169 6e65 7273 3a0a 2020 6331  containers:.  c1
+0000deb0: 3a0a 2020 2020 6b3a 2076 0a22 2222 290a  :.    k: v.""").
+0000dec0: 2020 2020 2020 2020 2320 4f6e 6c79 2074          # Only t
+0000ded0: 6865 2072 6561 6c20 7065 6262 6c65 2043  he real pebble C
+0000dee0: 6c69 656e 7420 6368 6563 6b73 2074 7970  lient checks typ
+0000def0: 6573 2c20 736f 2075 7365 2061 6374 7561  es, so use actua
+0000df00: 6c20 6261 636b 656e 6420 636c 6173 730a  l backend class.
+0000df10: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
+0000df20: 3d20 5f4d 6f64 656c 4261 636b 656e 6428  = _ModelBackend(
+0000df30: 276d 7961 7070 2f30 2729 0a20 2020 2020  'myapp/0').     
+0000df40: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
+0000df50: 6f64 656c 286d 6574 612c 2062 6163 6b65  odel(meta, backe
+0000df60: 6e64 290a 2020 2020 2020 2020 636f 6e74  nd).        cont
+0000df70: 6169 6e65 7220 3d20 6d6f 6465 6c2e 756e  ainer = model.un
+0000df80: 6974 2e63 6f6e 7461 696e 6572 735b 2763  it.containers['c
+0000df90: 3127 5d0a 0a20 2020 2020 2020 2077 6974  1']..        wit
+0000dfa0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000dfb0: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+0000dfc0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000dfd0: 6169 6e65 722e 7374 6172 7428 5b27 666f  ainer.start(['fo
+0000dfe0: 6f27 5d29 0a0a 2020 2020 2020 2020 7769  o'])..        wi
+0000dff0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000e000: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+0000e010: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000e020: 7461 696e 6572 2e73 746f 7028 5b27 666f  tainer.stop(['fo
+0000e030: 6f27 5d29 0a0a 2020 2020 6465 6620 7465  o'])..    def te
+0000e040: 7374 5f61 6464 5f6c 6179 6572 2873 656c  st_add_layer(sel
+0000e050: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000e060: 2e63 6f6e 7461 696e 6572 2e61 6464 5f6c  .container.add_l
+0000e070: 6179 6572 2827 6127 2c20 2773 756d 6d61  ayer('a', 'summa
+0000e080: 7279 3a20 7374 725c 6e27 290a 2020 2020  ry: str\n').    
+0000e090: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000e0a0: 6572 2e61 6464 5f6c 6179 6572 2827 6227  er.add_layer('b'
+0000e0b0: 2c20 7b27 7375 6d6d 6172 7927 3a20 2764  , {'summary': 'd
+0000e0c0: 6963 7427 7d29 0a20 2020 2020 2020 2073  ict'}).        s
+0000e0d0: 656c 662e 636f 6e74 6169 6e65 722e 6164  elf.container.ad
+0000e0e0: 645f 6c61 7965 7228 2763 272c 2070 6562  d_layer('c', peb
+0000e0f0: 626c 652e 4c61 7965 7228 2773 756d 6d61  ble.Layer('summa
+0000e100: 7279 3a20 4c61 7965 7227 2929 0a20 2020  ry: Layer')).   
+0000e110: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
+0000e120: 6e65 722e 6164 645f 6c61 7965 7228 2764  ner.add_layer('d
+0000e130: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
+0000e140: 5c6e 272c 2063 6f6d 6269 6e65 3d54 7275  \n', combine=Tru
+0000e150: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+0000e160: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000e170: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000e180: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000e190: 2827 6164 645f 6c61 7965 7227 2c20 2761  ('add_layer', 'a
+0000e1a0: 272c 2027 7375 6d6d 6172 793a 2073 7472  ', 'summary: str
+0000e1b0: 5c6e 272c 2046 616c 7365 292c 0a20 2020  \n', False),.   
+0000e1c0: 2020 2020 2020 2020 2028 2761 6464 5f6c           ('add_l
+0000e1d0: 6179 6572 272c 2027 6227 2c20 2773 756d  ayer', 'b', 'sum
+0000e1e0: 6d61 7279 3a20 6469 6374 5c6e 272c 2046  mary: dict\n', F
+0000e1f0: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+0000e200: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
+0000e210: 2027 6327 2c20 2773 756d 6d61 7279 3a20   'c', 'summary: 
+0000e220: 4c61 7965 725c 6e27 2c20 4661 6c73 6529  Layer\n', False)
+0000e230: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+0000e240: 6164 645f 6c61 7965 7227 2c20 2764 272c  add_layer', 'd',
+0000e250: 2027 7375 6d6d 6172 793a 2073 7472 5c6e   'summary: str\n
+0000e260: 272c 2054 7275 6529 2c0a 2020 2020 2020  ', True),.      
+0000e270: 2020 5d29 0a0a 2020 2020 2020 2020 2320    ])..        # 
+0000e280: 636f 6d62 696e 6520 6973 2061 206b 6579  combine is a key
+0000e290: 776f 7264 2d6f 6e6c 7920 6172 6720 2873  word-only arg (s
+0000e2a0: 686f 756c 6420 6265 2063 6f6d 6269 6e65  hould be combine
+0000e2b0: 3d54 7275 6529 0a20 2020 2020 2020 2077  =True).        w
+0000e2c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000e2d0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0000e2e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000e2f0: 6c66 2e63 6f6e 7461 696e 6572 2e61 6464  lf.container.add
+0000e300: 5f6c 6179 6572 2827 7827 2c20 7b7d 2c20  _layer('x', {}, 
+0000e310: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
+0000e320: 6573 745f 6765 745f 706c 616e 2873 656c  est_get_plan(sel
+0000e330: 6629 3a0a 2020 2020 2020 2020 706c 616e  f):.        plan
+0000e340: 5f79 616d 6c20 3d20 2773 6572 7669 6365  _yaml = 'service
+0000e350: 733a 5c6e 2066 6f6f 3a5c 6e20 206f 7665  s:\n foo:\n  ove
+0000e360: 7272 6964 653a 2072 6570 6c61 6365 5c6e  rride: replace\n
+0000e370: 2020 636f 6d6d 616e 643a 2062 6172 270a    command: bar'.
+0000e380: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000e390: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000e3a0: 7065 6e64 2870 6562 626c 652e 506c 616e  pend(pebble.Plan
+0000e3b0: 2870 6c61 6e5f 7961 6d6c 2929 0a20 2020  (plan_yaml)).   
+0000e3c0: 2020 2020 2070 6c61 6e20 3d20 7365 6c66       plan = self
+0000e3d0: 2e63 6f6e 7461 696e 6572 2e67 6574 5f70  .container.get_p
+0000e3e0: 6c61 6e28 290a 2020 2020 2020 2020 7365  lan().        se
+0000e3f0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000e400: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000e410: 7374 732c 205b 2827 6765 745f 706c 616e  sts, [('get_plan
+0000e420: 272c 295d 290a 2020 2020 2020 2020 7365  ',)]).        se
+0000e430: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+0000e440: 6e63 6528 706c 616e 2c20 7065 6262 6c65  nce(plan, pebble
+0000e450: 2e50 6c61 6e29 0a20 2020 2020 2020 2073  .Plan).        s
+0000e460: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e470: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
+0000e480: 7961 6d6c 2e73 6166 655f 6475 6d70 2879  yaml.safe_dump(y
+0000e490: 616d 6c2e 7361 6665 5f6c 6f61 6428 706c  aml.safe_load(pl
+0000e4a0: 616e 5f79 616d 6c29 2929 0a0a 2020 2020  an_yaml)))..    
+0000e4b0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0000e4c0: 2020 6465 6620 5f6d 616b 655f 7365 7276    def _make_serv
+0000e4d0: 6963 6528 6e61 6d65 2c20 7374 6172 7475  ice(name, startu
+0000e4e0: 702c 2063 7572 7265 6e74 293a 0a20 2020  p, current):.   
+0000e4f0: 2020 2020 2072 6574 7572 6e20 7065 6262       return pebb
+0000e500: 6c65 2e53 6572 7669 6365 496e 666f 2e66  le.ServiceInfo.f
+0000e510: 726f 6d5f 6469 6374 280a 2020 2020 2020  rom_dict(.      
+0000e520: 2020 2020 2020 7b27 6e61 6d65 273a 206e        {'name': n
+0000e530: 616d 652c 2027 7374 6172 7475 7027 3a20  ame, 'startup': 
+0000e540: 7374 6172 7475 702c 2027 6375 7272 656e  startup, 'curren
+0000e550: 7427 3a20 6375 7272 656e 747d 290a 0a20  t': current}).. 
+0000e560: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+0000e570: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
+0000e580: 2020 2020 2020 2020 7477 6f5f 7365 7276          two_serv
+0000e590: 6963 6573 203d 205b 0a20 2020 2020 2020  ices = [.       
+0000e5a0: 2020 2020 2073 656c 662e 5f6d 616b 655f       self._make_
+0000e5b0: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
+0000e5c0: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
+0000e5d0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+0000e5e0: 7365 6c66 2e5f 6d61 6b65 5f73 6572 7669  self._make_servi
+0000e5f0: 6365 2827 7332 272c 2027 6469 7361 626c  ce('s2', 'disabl
+0000e600: 6564 272c 2027 696e 6163 7469 7665 2729  ed', 'inactive')
+0000e610: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0000e620: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000e630: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000e640: 2874 776f 5f73 6572 7669 6365 7329 0a20  (two_services). 
+0000e650: 2020 2020 2020 2073 6572 7669 6365 7320         services 
+0000e660: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
+0000e670: 2e67 6574 5f73 6572 7669 6365 7328 290a  .get_services().
+0000e680: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000e690: 6572 7445 7175 616c 286c 656e 2873 6572  ertEqual(len(ser
+0000e6a0: 7669 6365 7329 2c20 3229 0a20 2020 2020  vices), 2).     
+0000e6b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e6c0: 7561 6c28 7365 7428 7365 7276 6963 6573  ual(set(services
+0000e6d0: 292c 207b 2773 3127 2c20 2773 3227 7d29  ), {'s1', 's2'})
+0000e6e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e6f0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+0000e700: 6573 5b27 7331 275d 2e6e 616d 652c 2027  es['s1'].name, '
+0000e710: 7331 2729 0a20 2020 2020 2020 2073 656c  s1').        sel
+0000e720: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e730: 7276 6963 6573 5b27 7331 275d 2e73 7461  rvices['s1'].sta
+0000e740: 7274 7570 2c20 7065 6262 6c65 2e53 6572  rtup, pebble.Ser
+0000e750: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
+0000e760: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
+0000e770: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e780: 7276 6963 6573 5b27 7331 275d 2e63 7572  rvices['s1'].cur
+0000e790: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
+0000e7a0: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
+0000e7b0: 4529 0a20 2020 2020 2020 2073 656c 662e  E).        self.
+0000e7c0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
+0000e7d0: 6963 6573 5b27 7332 275d 2e6e 616d 652c  ices['s2'].name,
+0000e7e0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
+0000e7f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e800: 7365 7276 6963 6573 5b27 7332 275d 2e73  services['s2'].s
+0000e810: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
+0000e820: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
+0000e830: 5341 424c 4544 290a 2020 2020 2020 2020  SABLED).        
+0000e840: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e850: 2873 6572 7669 6365 735b 2773 3227 5d2e  (services['s2'].
+0000e860: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+0000e870: 5365 7276 6963 6553 7461 7475 732e 494e  ServiceStatus.IN
+0000e880: 4143 5449 5645 290a 0a20 2020 2020 2020  ACTIVE)..       
+0000e890: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
+0000e8a0: 706f 6e73 6573 2e61 7070 656e 6428 7477  ponses.append(tw
+0000e8b0: 6f5f 7365 7276 6963 6573 290a 2020 2020  o_services).    
+0000e8c0: 2020 2020 7365 7276 6963 6573 203d 2073      services = s
+0000e8d0: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
+0000e8e0: 745f 7365 7276 6963 6573 2827 7331 272c  t_services('s1',
+0000e8f0: 2027 7332 2729 0a20 2020 2020 2020 2073   's2').        s
+0000e900: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e910: 6c65 6e28 7365 7276 6963 6573 292c 2032  len(services), 2
+0000e920: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000e930: 7373 6572 7445 7175 616c 2873 6574 2873  ssertEqual(set(s
+0000e940: 6572 7669 6365 7329 2c20 7b27 7331 272c  ervices), {'s1',
+0000e950: 2027 7332 277d 290a 2020 2020 2020 2020   's2'}).        
+0000e960: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e970: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
+0000e980: 6e61 6d65 2c20 2773 3127 290a 2020 2020  name, 's1').    
+0000e990: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e9a0: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
+0000e9b0: 3127 5d2e 7374 6172 7475 702c 2070 6562  1'].startup, peb
+0000e9c0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
+0000e9d0: 7570 2e45 4e41 424c 4544 290a 2020 2020  up.ENABLED).    
+0000e9e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e9f0: 7175 616c 2873 6572 7669 6365 735b 2773  qual(services['s
+0000ea00: 3127 5d2e 6375 7272 656e 742c 2070 6562  1'].current, peb
+0000ea10: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+0000ea20: 732e 4143 5449 5645 290a 2020 2020 2020  s.ACTIVE).      
+0000ea30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ea40: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
+0000ea50: 5d2e 6e61 6d65 2c20 2773 3227 290a 2020  ].name, 's2').  
+0000ea60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000ea70: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+0000ea80: 2773 3227 5d2e 7374 6172 7475 702c 2070  's2'].startup, p
+0000ea90: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+0000eaa0: 7274 7570 2e44 4953 4142 4c45 4429 0a20  rtup.DISABLED). 
+0000eab0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000eac0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
+0000ead0: 5b27 7332 275d 2e63 7572 7265 6e74 2c20  ['s2'].current, 
+0000eae0: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+0000eaf0: 6174 7573 2e49 4e41 4354 4956 4529 0a0a  atus.INACTIVE)..
+0000eb00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000eb10: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
+0000eb20: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
+0000eb30: 0a20 2020 2020 2020 2020 2020 2028 2767  .            ('g
+0000eb40: 6574 5f73 6572 7669 6365 7327 2c20 4e6f  et_services', No
+0000eb50: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
+0000eb60: 2028 2767 6574 5f73 6572 7669 6365 7327   ('get_services'
+0000eb70: 2c20 2827 7331 272c 2027 7332 2729 292c  , ('s1', 's2')),
+0000eb80: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+0000eb90: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
+0000eba0: 7276 6963 6528 7365 6c66 293a 0a20 2020  rvice(self):.   
+0000ebb0: 2020 2020 2023 2053 696e 676c 6520 7365       # Single se
+0000ebc0: 7276 6963 6520 7265 7475 726e 6564 2073  rvice returned s
+0000ebd0: 7563 6365 7373 6675 6c6c 790a 2020 2020  uccessfully.    
+0000ebe0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000ebf0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000ec00: 285b 7365 6c66 2e5f 6d61 6b65 5f73 6572  ([self._make_ser
+0000ec10: 7669 6365 2827 7331 272c 2027 656e 6162  vice('s1', 'enab
+0000ec20: 6c65 6427 2c20 2761 6374 6976 6527 295d  led', 'active')]
+0000ec30: 290a 2020 2020 2020 2020 7320 3d20 7365  ).        s = se
+0000ec40: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
+0000ec50: 5f73 6572 7669 6365 2827 7331 2729 0a20  _service('s1'). 
+0000ec60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ec70: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+0000ec80: 626c 652e 7265 7175 6573 7473 2c20 5b28  ble.requests, [(
+0000ec90: 2767 6574 5f73 6572 7669 6365 7327 2c20  'get_services', 
+0000eca0: 2827 7331 272c 2029 295d 290a 2020 2020  ('s1', ))]).    
+0000ecb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000ecc0: 7175 616c 2873 2e6e 616d 652c 2027 7331  qual(s.name, 's1
+0000ecd0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000ece0: 6173 7365 7274 4571 7561 6c28 732e 7374  assertEqual(s.st
+0000ecf0: 6172 7475 702c 2070 6562 626c 652e 5365  artup, pebble.Se
+0000ed00: 7276 6963 6553 7461 7274 7570 2e45 4e41  rviceStartup.ENA
+0000ed10: 424c 4544 290a 2020 2020 2020 2020 7365  BLED).        se
+0000ed20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ed30: 2e63 7572 7265 6e74 2c20 7065 6262 6c65  .current, pebble
+0000ed40: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
+0000ed50: 4354 4956 4529 0a0a 2020 2020 2020 2020  CTIVE)..        
+0000ed60: 2320 4966 2050 6562 626c 6520 7265 7475  # If Pebble retu
+0000ed70: 726e 7320 6e6f 2073 6572 7669 6365 732c  rns no services,
+0000ed80: 2073 686f 756c 6420 6265 2061 206f 7073   should be a ops
+0000ed90: 2e4d 6f64 656c 4572 726f 720a 2020 2020  .ModelError.    
+0000eda0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000edb0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000edc0: 285b 5d29 0a20 2020 2020 2020 2077 6974  ([]).        wit
+0000edd0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000ede0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+0000edf0: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+0000ee00: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000ee10: 6169 6e65 722e 6765 745f 7365 7276 6963  ainer.get_servic
+0000ee20: 6528 2773 3227 290a 2020 2020 2020 2020  e('s2').        
+0000ee30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000ee40: 2873 7472 2863 6d2e 6578 6365 7074 696f  (str(cm.exceptio
+0000ee50: 6e29 2c20 2273 6572 7669 6365 2027 7332  n), "service 's2
+0000ee60: 2720 6e6f 7420 666f 756e 6422 290a 0a20  ' not found").. 
+0000ee70: 2020 2020 2020 2023 2049 6620 5065 6262         # If Pebb
+0000ee80: 6c65 2072 6574 7572 6e73 206d 6f72 6520  le returns more 
+0000ee90: 7468 616e 206f 6e65 2073 6572 7669 6365  than one service
+0000eea0: 2c20 5275 6e74 696d 6545 7272 6f72 2069  , RuntimeError i
+0000eeb0: 7320 7261 6973 6564 0a20 2020 2020 2020  s raised.       
+0000eec0: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
+0000eed0: 706f 6e73 6573 2e61 7070 656e 6428 5b0a  ponses.append([.
+0000eee0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000eef0: 2e5f 6d61 6b65 5f73 6572 7669 6365 2827  ._make_service('
+0000ef00: 7331 272c 2027 656e 6162 6c65 6427 2c20  s1', 'enabled', 
+0000ef10: 2761 6374 6976 6527 292c 0a20 2020 2020  'active'),.     
+0000ef20: 2020 2020 2020 2073 656c 662e 5f6d 616b         self._mak
+0000ef30: 655f 7365 7276 6963 6528 2773 3227 2c20  e_service('s2', 
+0000ef40: 2764 6973 6162 6c65 6427 2c20 2769 6e61  'disabled', 'ina
+0000ef50: 6374 6976 6527 292c 0a20 2020 2020 2020  ctive'),.       
+0000ef60: 205d 290a 2020 2020 2020 2020 7769 7468   ]).        with
+0000ef70: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000ef80: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0000ef90: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000efa0: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
+0000efb0: 5f73 6572 7669 6365 2827 7331 2729 0a0a  _service('s1')..
+0000efc0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0000efd0: 5f63 6865 636b 7328 7365 6c66 293a 0a20  _checks(self):. 
+0000efe0: 2020 2020 2020 2072 6573 706f 6e73 655f         response_
+0000eff0: 6368 6563 6b73 203d 205b 0a20 2020 2020  checks = [.     
+0000f000: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
+0000f010: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
+0000f020: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
+0000f030: 2020 2020 276e 616d 6527 3a20 2763 3127      'name': 'c1'
 0000f040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f050: 2020 2766 6169 6c75 7265 7327 3a20 302c    'failures': 0,
-0000f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f070: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
-0000f080: 0a20 2020 2020 2020 2020 2020 207d 292c  .            }),
-0000f090: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
-0000f0a0: 626c 652e 4368 6563 6b49 6e66 6f2e 6672  ble.CheckInfo.fr
-0000f0b0: 6f6d 5f64 6963 7428 7b0a 2020 2020 2020  om_dict({.      
-0000f0c0: 2020 2020 2020 2020 2020 276e 616d 6527            'name'
-0000f0d0: 3a20 2763 3227 2c0a 2020 2020 2020 2020  : 'c2',.        
-0000f0e0: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
-0000f0f0: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
-0000f100: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
-0000f110: 7327 3a20 2764 6f77 6e27 2c0a 2020 2020  s': 'down',.    
-0000f120: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
-0000f130: 6c75 7265 7327 3a20 322c 0a20 2020 2020  lures': 2,.     
-0000f140: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
-0000f150: 7368 6f6c 6427 3a20 322c 0a20 2020 2020  shold': 2,.     
-0000f160: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
-0000f170: 2020 205d 0a0a 2020 2020 2020 2020 7365     ]..        se
-0000f180: 6c66 2e70 6562 626c 652e 7265 7370 6f6e  lf.pebble.respon
-0000f190: 7365 732e 6170 7065 6e64 2872 6573 706f  ses.append(respo
-0000f1a0: 6e73 655f 6368 6563 6b73 290a 2020 2020  nse_checks).    
-0000f1b0: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
-0000f1c0: 662e 636f 6e74 6169 6e65 722e 6765 745f  f.container.get_
-0000f1d0: 6368 6563 6b73 2829 0a20 2020 2020 2020  checks().       
-0000f1e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f1f0: 6c28 6c65 6e28 6368 6563 6b73 292c 2032  l(len(checks), 2
-0000f200: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f210: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0000f220: 735b 2763 3127 5d2e 6e61 6d65 2c20 2763  s['c1'].name, 'c
-0000f230: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-0000f240: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-0000f250: 636b 735b 2763 3127 5d2e 6c65 7665 6c2c  cks['c1'].level,
-0000f260: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
-0000f270: 656c 2e55 4e53 4554 290a 2020 2020 2020  el.UNSET).      
-0000f280: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000f290: 616c 2863 6865 636b 735b 2763 3127 5d2e  al(checks['c1'].
-0000f2a0: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
-0000f2b0: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
-0000f2c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f2d0: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
-0000f2e0: 6331 275d 2e66 6169 6c75 7265 732c 2030  c1'].failures, 0
-0000f2f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f300: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0000f310: 735b 2763 3127 5d2e 7468 7265 7368 6f6c  s['c1'].threshol
-0000f320: 642c 2033 290a 2020 2020 2020 2020 7365  d, 3).        se
-0000f330: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000f340: 6865 636b 735b 2763 3227 5d2e 6e61 6d65  hecks['c2'].name
-0000f350: 2c20 2763 3227 290a 2020 2020 2020 2020  , 'c2').        
-0000f360: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f370: 2863 6865 636b 735b 2763 3227 5d2e 6c65  (checks['c2'].le
-0000f380: 7665 6c2c 2070 6562 626c 652e 4368 6563  vel, pebble.Chec
-0000f390: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
-0000f3a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f3b0: 7445 7175 616c 2863 6865 636b 735b 2763  tEqual(checks['c
-0000f3c0: 3227 5d2e 7374 6174 7573 2c20 7065 6262  2'].status, pebb
-0000f3d0: 6c65 2e43 6865 636b 5374 6174 7573 2e44  le.CheckStatus.D
-0000f3e0: 4f57 4e29 0a20 2020 2020 2020 2073 656c  OWN).        sel
-0000f3f0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000f400: 6563 6b73 5b27 6332 275d 2e66 6169 6c75  ecks['c2'].failu
-0000f410: 7265 732c 2032 290a 2020 2020 2020 2020  res, 2).        
-0000f420: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f430: 2863 6865 636b 735b 2763 3227 5d2e 7468  (checks['c2'].th
-0000f440: 7265 7368 6f6c 642c 2032 290a 0a20 2020  reshold, 2)..   
-0000f450: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000f460: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-0000f470: 6428 7265 7370 6f6e 7365 5f63 6865 636b  d(response_check
-0000f480: 735b 313a 325d 290a 2020 2020 2020 2020  s[1:2]).        
-0000f490: 6368 6563 6b73 203d 2073 656c 662e 636f  checks = self.co
-0000f4a0: 6e74 6169 6e65 722e 6765 745f 6368 6563  ntainer.get_chec
-0000f4b0: 6b73 2827 6331 272c 2027 6332 272c 206c  ks('c1', 'c2', l
-0000f4c0: 6576 656c 3d70 6562 626c 652e 4368 6563  evel=pebble.Chec
-0000f4d0: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
-0000f4e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f4f0: 7445 7175 616c 286c 656e 2863 6865 636b  tEqual(len(check
-0000f500: 7329 2c20 3129 0a20 2020 2020 2020 2073  s), 1).        s
-0000f510: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000f520: 6368 6563 6b73 5b27 6332 275d 2e6e 616d  checks['c2'].nam
-0000f530: 652c 2027 6332 2729 0a20 2020 2020 2020  e, 'c2').       
-0000f540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f550: 6c28 6368 6563 6b73 5b27 6332 275d 2e6c  l(checks['c2'].l
-0000f560: 6576 656c 2c20 7065 6262 6c65 2e43 6865  evel, pebble.Che
-0000f570: 636b 4c65 7665 6c2e 414c 4956 4529 0a20  ckLevel.ALIVE). 
-0000f580: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f590: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
-0000f5a0: 6332 275d 2e73 7461 7475 732c 2070 6562  c2'].status, peb
-0000f5b0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-0000f5c0: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
-0000f5d0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000f5e0: 6865 636b 735b 2763 3227 5d2e 6661 696c  hecks['c2'].fail
-0000f5f0: 7572 6573 2c20 3229 0a20 2020 2020 2020  ures, 2).       
-0000f600: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f610: 6c28 6368 6563 6b73 5b27 6332 275d 2e74  l(checks['c2'].t
-0000f620: 6872 6573 686f 6c64 2c20 3229 0a0a 2020  hreshold, 2)..  
-0000f630: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f640: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-0000f650: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
-0000f660: 2020 2020 2020 2020 2020 2028 2767 6574             ('get
-0000f670: 5f63 6865 636b 7327 2c20 4e6f 6e65 2c20  _checks', None, 
-0000f680: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
-0000f690: 2020 2028 2767 6574 5f63 6865 636b 7327     ('get_checks'
-0000f6a0: 2c20 7065 6262 6c65 2e43 6865 636b 4c65  , pebble.CheckLe
-0000f6b0: 7665 6c2e 414c 4956 452c 2028 2763 3127  vel.ALIVE, ('c1'
-0000f6c0: 2c20 2763 3227 2929 2c0a 2020 2020 2020  , 'c2')),.      
-0000f6d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000f6e0: 7374 5f67 6574 5f63 6865 636b 2873 656c  st_get_check(sel
-0000f6f0: 6629 3a0a 2020 2020 2020 2020 2320 5369  f):.        # Si
-0000f700: 6e67 6c65 2063 6865 636b 2072 6574 7572  ngle check retur
-0000f710: 6e65 6420 7375 6363 6573 7366 756c 6c79  ned successfully
-0000f720: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-0000f730: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
-0000f740: 7070 656e 6428 5b0a 2020 2020 2020 2020  ppend([.        
-0000f750: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
-0000f760: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
-0000f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f780: 2027 6e61 6d65 273a 2027 6331 272c 0a20   'name': 'c1',. 
-0000f790: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000f7a0: 7374 6174 7573 273a 2027 7570 272c 0a20  status': 'up',. 
+0000f050: 2020 2773 7461 7475 7327 3a20 2775 7027    'status': 'up'
+0000f060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f070: 2020 2766 6169 6c75 7265 7327 3a20 302c    'failures': 0,
+0000f080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f090: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
+0000f0a0: 0a20 2020 2020 2020 2020 2020 207d 292c  .            }),
+0000f0b0: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+0000f0c0: 626c 652e 4368 6563 6b49 6e66 6f2e 6672  ble.CheckInfo.fr
+0000f0d0: 6f6d 5f64 6963 7428 7b0a 2020 2020 2020  om_dict({.      
+0000f0e0: 2020 2020 2020 2020 2020 276e 616d 6527            'name'
+0000f0f0: 3a20 2763 3227 2c0a 2020 2020 2020 2020  : 'c2',.        
+0000f100: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+0000f110: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
+0000f120: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+0000f130: 7327 3a20 2764 6f77 6e27 2c0a 2020 2020  s': 'down',.    
+0000f140: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
+0000f150: 6c75 7265 7327 3a20 322c 0a20 2020 2020  lures': 2,.     
+0000f160: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
+0000f170: 7368 6f6c 6427 3a20 322c 0a20 2020 2020  shold': 2,.     
+0000f180: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
+0000f190: 2020 205d 0a0a 2020 2020 2020 2020 7365     ]..        se
+0000f1a0: 6c66 2e70 6562 626c 652e 7265 7370 6f6e  lf.pebble.respon
+0000f1b0: 7365 732e 6170 7065 6e64 2872 6573 706f  ses.append(respo
+0000f1c0: 6e73 655f 6368 6563 6b73 290a 2020 2020  nse_checks).    
+0000f1d0: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
+0000f1e0: 662e 636f 6e74 6169 6e65 722e 6765 745f  f.container.get_
+0000f1f0: 6368 6563 6b73 2829 0a20 2020 2020 2020  checks().       
+0000f200: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f210: 6c28 6c65 6e28 6368 6563 6b73 292c 2032  l(len(checks), 2
+0000f220: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f230: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000f240: 735b 2763 3127 5d2e 6e61 6d65 2c20 2763  s['c1'].name, 'c
+0000f250: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+0000f260: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0000f270: 636b 735b 2763 3127 5d2e 6c65 7665 6c2c  cks['c1'].level,
+0000f280: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
+0000f290: 656c 2e55 4e53 4554 290a 2020 2020 2020  el.UNSET).      
+0000f2a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000f2b0: 616c 2863 6865 636b 735b 2763 3127 5d2e  al(checks['c1'].
+0000f2c0: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
+0000f2d0: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
+0000f2e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f2f0: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
+0000f300: 6331 275d 2e66 6169 6c75 7265 732c 2030  c1'].failures, 0
+0000f310: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f320: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000f330: 735b 2763 3127 5d2e 7468 7265 7368 6f6c  s['c1'].threshol
+0000f340: 642c 2033 290a 2020 2020 2020 2020 7365  d, 3).        se
+0000f350: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f360: 6865 636b 735b 2763 3227 5d2e 6e61 6d65  hecks['c2'].name
+0000f370: 2c20 2763 3227 290a 2020 2020 2020 2020  , 'c2').        
+0000f380: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f390: 2863 6865 636b 735b 2763 3227 5d2e 6c65  (checks['c2'].le
+0000f3a0: 7665 6c2c 2070 6562 626c 652e 4368 6563  vel, pebble.Chec
+0000f3b0: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
+0000f3c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f3d0: 7445 7175 616c 2863 6865 636b 735b 2763  tEqual(checks['c
+0000f3e0: 3227 5d2e 7374 6174 7573 2c20 7065 6262  2'].status, pebb
+0000f3f0: 6c65 2e43 6865 636b 5374 6174 7573 2e44  le.CheckStatus.D
+0000f400: 4f57 4e29 0a20 2020 2020 2020 2073 656c  OWN).        sel
+0000f410: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000f420: 6563 6b73 5b27 6332 275d 2e66 6169 6c75  ecks['c2'].failu
+0000f430: 7265 732c 2032 290a 2020 2020 2020 2020  res, 2).        
+0000f440: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f450: 2863 6865 636b 735b 2763 3227 5d2e 7468  (checks['c2'].th
+0000f460: 7265 7368 6f6c 642c 2032 290a 0a20 2020  reshold, 2)..   
+0000f470: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000f480: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000f490: 6428 7265 7370 6f6e 7365 5f63 6865 636b  d(response_check
+0000f4a0: 735b 313a 325d 290a 2020 2020 2020 2020  s[1:2]).        
+0000f4b0: 6368 6563 6b73 203d 2073 656c 662e 636f  checks = self.co
+0000f4c0: 6e74 6169 6e65 722e 6765 745f 6368 6563  ntainer.get_chec
+0000f4d0: 6b73 2827 6331 272c 2027 6332 272c 206c  ks('c1', 'c2', l
+0000f4e0: 6576 656c 3d70 6562 626c 652e 4368 6563  evel=pebble.Chec
+0000f4f0: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
+0000f500: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f510: 7445 7175 616c 286c 656e 2863 6865 636b  tEqual(len(check
+0000f520: 7329 2c20 3129 0a20 2020 2020 2020 2073  s), 1).        s
+0000f530: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f540: 6368 6563 6b73 5b27 6332 275d 2e6e 616d  checks['c2'].nam
+0000f550: 652c 2027 6332 2729 0a20 2020 2020 2020  e, 'c2').       
+0000f560: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f570: 6c28 6368 6563 6b73 5b27 6332 275d 2e6c  l(checks['c2'].l
+0000f580: 6576 656c 2c20 7065 6262 6c65 2e43 6865  evel, pebble.Che
+0000f590: 636b 4c65 7665 6c2e 414c 4956 4529 0a20  ckLevel.ALIVE). 
+0000f5a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f5b0: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
+0000f5c0: 6332 275d 2e73 7461 7475 732c 2070 6562  c2'].status, peb
+0000f5d0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
+0000f5e0: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
+0000f5f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f600: 6865 636b 735b 2763 3227 5d2e 6661 696c  hecks['c2'].fail
+0000f610: 7572 6573 2c20 3229 0a20 2020 2020 2020  ures, 2).       
+0000f620: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f630: 6c28 6368 6563 6b73 5b27 6332 275d 2e74  l(checks['c2'].t
+0000f640: 6872 6573 686f 6c64 2c20 3229 0a0a 2020  hreshold, 2)..  
+0000f650: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f660: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+0000f670: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
+0000f680: 2020 2020 2020 2020 2020 2028 2767 6574             ('get
+0000f690: 5f63 6865 636b 7327 2c20 4e6f 6e65 2c20  _checks', None, 
+0000f6a0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000f6b0: 2020 2028 2767 6574 5f63 6865 636b 7327     ('get_checks'
+0000f6c0: 2c20 7065 6262 6c65 2e43 6865 636b 4c65  , pebble.CheckLe
+0000f6d0: 7665 6c2e 414c 4956 452c 2028 2763 3127  vel.ALIVE, ('c1'
+0000f6e0: 2c20 2763 3227 2929 2c0a 2020 2020 2020  , 'c2')),.      
+0000f6f0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000f700: 7374 5f67 6574 5f63 6865 636b 2873 656c  st_get_check(sel
+0000f710: 6629 3a0a 2020 2020 2020 2020 2320 5369  f):.        # Si
+0000f720: 6e67 6c65 2063 6865 636b 2072 6574 7572  ngle check retur
+0000f730: 6e65 6420 7375 6363 6573 7366 756c 6c79  ned successfully
+0000f740: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+0000f750: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
+0000f760: 7070 656e 6428 5b0a 2020 2020 2020 2020  ppend([.        
+0000f770: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
+0000f780: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+0000f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f7a0: 2027 6e61 6d65 273a 2027 6331 272c 0a20   'name': 'c1',. 
 0000f7b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000f7c0: 6661 696c 7572 6573 273a 2030 2c0a 2020  failures': 0,.  
-0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0000f7e0: 6872 6573 686f 6c64 273a 2033 2c0a 2020  hreshold': 3,.  
-0000f7f0: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
-0000f800: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-0000f810: 6320 3d20 7365 6c66 2e63 6f6e 7461 696e  c = self.contain
-0000f820: 6572 2e67 6574 5f63 6865 636b 2827 6331  er.get_check('c1
-0000f830: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000f840: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000f850: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000f860: 2c20 5b28 2767 6574 5f63 6865 636b 7327  , [('get_checks'
-0000f870: 2c20 4e6f 6e65 2c20 2827 6331 272c 2029  , None, ('c1', )
-0000f880: 295d 290a 2020 2020 2020 2020 7365 6c66  )]).        self
-0000f890: 2e61 7373 6572 7445 7175 616c 2863 2e6e  .assertEqual(c.n
-0000f8a0: 616d 652c 2027 6331 2729 0a20 2020 2020  ame, 'c1').     
-0000f8b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f8c0: 7561 6c28 632e 6c65 7665 6c2c 2070 6562  ual(c.level, peb
-0000f8d0: 626c 652e 4368 6563 6b4c 6576 656c 2e55  ble.CheckLevel.U
-0000f8e0: 4e53 4554 290a 2020 2020 2020 2020 7365  NSET).        se
-0000f8f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000f900: 2e73 7461 7475 732c 2070 6562 626c 652e  .status, pebble.
-0000f910: 4368 6563 6b53 7461 7475 732e 5550 290a  CheckStatus.UP).
-0000f920: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000f930: 6572 7445 7175 616c 2863 2e66 6169 6c75  ertEqual(c.failu
-0000f940: 7265 732c 2030 290a 2020 2020 2020 2020  res, 0).        
-0000f950: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f960: 2863 2e74 6872 6573 686f 6c64 2c20 3329  (c.threshold, 3)
-0000f970: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
-0000f980: 6562 626c 6520 7265 7475 726e 7320 6e6f  ebble returns no
-0000f990: 2063 6865 636b 732c 2073 686f 756c 6420   checks, should 
-0000f9a0: 6265 2061 206f 7073 2e4d 6f64 656c 4572  be a ops.ModelEr
-0000f9b0: 726f 720a 2020 2020 2020 2020 7365 6c66  ror.        self
-0000f9c0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
-0000f9d0: 732e 6170 7065 6e64 285b 5d29 0a20 2020  s.append([]).   
-0000f9e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000f9f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-0000fa00: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
-0000fa10: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0000fa20: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
-0000fa30: 745f 6368 6563 6b28 2763 3227 290a 2020  t_check('c2').  
-0000fa40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000fa50: 7445 7175 616c 2873 7472 2863 6d2e 6578  tEqual(str(cm.ex
-0000fa60: 6365 7074 696f 6e29 2c20 2263 6865 636b  ception), "check
-0000fa70: 2027 6332 2720 6e6f 7420 666f 756e 6422   'c2' not found"
-0000fa80: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
-0000fa90: 5065 6262 6c65 2072 6574 7572 6e73 206d  Pebble returns m
-0000faa0: 6f72 6520 7468 616e 206f 6e65 2063 6865  ore than one che
-0000fab0: 636b 2c20 5275 6e74 696d 6545 7272 6f72  ck, RuntimeError
-0000fac0: 2069 7320 7261 6973 6564 0a20 2020 2020   is raised.     
-0000fad0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
-0000fae0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-0000faf0: 5b0a 2020 2020 2020 2020 2020 2020 7065  [.            pe
-0000fb00: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
-0000fb10: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
-0000fb20: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
-0000fb30: 273a 2027 6331 272c 0a20 2020 2020 2020  ': 'c1',.       
-0000fb40: 2020 2020 2020 2020 2027 7374 6174 7573           'status
-0000fb50: 273a 2027 7570 272c 0a20 2020 2020 2020  ': 'up',.       
-0000fb60: 2020 2020 2020 2020 2027 6661 696c 7572           'failur
-0000fb70: 6573 273a 2030 2c0a 2020 2020 2020 2020  es': 0,.        
-0000fb80: 2020 2020 2020 2020 2774 6872 6573 686f          'thresho
-0000fb90: 6c64 273a 2033 2c0a 2020 2020 2020 2020  ld': 3,.        
-0000fba0: 2020 2020 7d29 2c0a 2020 2020 2020 2020      }),.        
-0000fbb0: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
-0000fbc0: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
-0000fbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fbe0: 2027 6e61 6d65 273a 2027 6332 272c 0a20   'name': 'c2',. 
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000fc00: 6c65 7665 6c27 3a20 2761 6c69 7665 272c  level': 'alive',
-0000fc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fc20: 2027 7374 6174 7573 273a 2027 646f 776e   'status': 'down
-0000fc30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0000fc40: 2020 2027 6661 696c 7572 6573 273a 2032     'failures': 2
-0000fc50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fc60: 2020 2774 6872 6573 686f 6c64 273a 2032    'threshold': 2
-0000fc70: 2c0a 2020 2020 2020 2020 2020 2020 7d29  ,.            })
-0000fc80: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0000fc90: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000fca0: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
-0000fcb0: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
-0000fcc0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000fcd0: 6169 6e65 722e 6765 745f 6368 6563 6b28  ainer.get_check(
-0000fce0: 2763 3127 290a 0a20 2020 2064 6566 2074  'c1')..    def t
-0000fcf0: 6573 745f 7075 6c6c 2873 656c 6629 3a0a  est_pull(self):.
-0000fd00: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-0000fd10: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
-0000fd20: 7065 6e64 2827 6475 6d6d 7931 2729 0a20  pend('dummy1'). 
-0000fd30: 2020 2020 2020 2067 6f74 203d 2073 656c         got = sel
-0000fd40: 662e 636f 6e74 6169 6e65 722e 7075 6c6c  f.container.pull
-0000fd50: 2827 2f70 6174 682f 3127 290a 2020 2020  ('/path/1').    
-0000fd60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fd70: 7175 616c 2867 6f74 2c20 2764 756d 6d79  qual(got, 'dummy
-0000fd80: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-0000fd90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000fda0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-0000fdb0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0000fdc0: 2028 2770 756c 6c27 2c20 272f 7061 7468   ('pull', '/path
-0000fdd0: 2f31 272c 2027 7574 662d 3827 292c 0a20  /1', 'utf-8'),. 
-0000fde0: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-0000fdf0: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
-0000fe00: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
-0000fe10: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000fe20: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-0000fe30: 6428 6227 6475 6d6d 7932 2729 0a20 2020  d(b'dummy2').   
-0000fe40: 2020 2020 2067 6f74 203d 2073 656c 662e       got = self.
-0000fe50: 636f 6e74 6169 6e65 722e 7075 6c6c 2827  container.pull('
-0000fe60: 2f70 6174 682f 3227 2c20 656e 636f 6469  /path/2', encodi
-0000fe70: 6e67 3d4e 6f6e 6529 0a20 2020 2020 2020  ng=None).       
-0000fe80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000fe90: 6c28 676f 742c 2062 2764 756d 6d79 3227  l(got, b'dummy2'
-0000fea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000feb0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000fec0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000fed0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0000fee0: 2770 756c 6c27 2c20 272f 7061 7468 2f32  'pull', '/path/2
-0000fef0: 272c 204e 6f6e 6529 2c0a 2020 2020 2020  ', None),.      
-0000ff00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000ff10: 7374 5f70 7573 6828 7365 6c66 293a 0a20  st_push(self):. 
-0000ff20: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000ff30: 6169 6e65 722e 7075 7368 2827 2f70 6174  ainer.push('/pat
-0000ff40: 682f 3127 2c20 2763 6f6e 7465 6e74 3127  h/1', 'content1'
-0000ff50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000ff60: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000ff70: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000ff80: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0000ff90: 2770 7573 6827 2c20 272f 7061 7468 2f31  'push', '/path/1
-0000ffa0: 272c 2027 636f 6e74 656e 7431 272c 2027  ', 'content1', '
-0000ffb0: 7574 662d 3827 2c20 4661 6c73 652c 204e  utf-8', False, N
-0000ffc0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0000ffd0: 2020 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f    None, None, No
-0000ffe0: 6e65 2c20 4e6f 6e65 292c 0a20 2020 2020  ne, None),.     
-0000fff0: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-00010000: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
-00010010: 7473 203d 205b 5d0a 0a20 2020 2020 2020  ts = []..       
-00010020: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-00010030: 7075 7368 2827 2f70 6174 682f 3227 2c20  push('/path/2', 
-00010040: 6227 636f 6e74 656e 7432 272c 2065 6e63  b'content2', enc
-00010050: 6f64 696e 673d 4e6f 6e65 2c20 6d61 6b65  oding=None, make
-00010060: 5f64 6972 733d 5472 7565 2c0a 2020 2020  _dirs=True,.    
-00010070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010080: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
-00010090: 6f6e 733d 306f 3630 302c 2075 7365 725f  ons=0o600, user_
-000100a0: 6964 3d31 322c 2075 7365 723d 2762 6f62  id=12, user='bob
-000100b0: 272c 2067 726f 7570 5f69 643d 3334 2c20  ', group_id=34, 
-000100c0: 6772 6f75 703d 2773 7461 6666 2729 0a20  group='staff'). 
-000100d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000100e0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
-000100f0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
-00010100: 2020 2020 2020 2020 2020 2020 2827 7075              ('pu
-00010110: 7368 272c 2027 2f70 6174 682f 3227 2c20  sh', '/path/2', 
-00010120: 6227 636f 6e74 656e 7432 272c 204e 6f6e  b'content2', Non
-00010130: 652c 2054 7275 652c 2030 6f36 3030 2c20  e, True, 0o600, 
-00010140: 3132 2c20 2762 6f62 272c 2033 342c 2027  12, 'bob', 34, '
-00010150: 7374 6166 6627 292c 0a20 2020 2020 2020  staff'),.       
-00010160: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-00010170: 745f 6c69 7374 5f66 696c 6573 2873 656c  t_list_files(sel
-00010180: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00010190: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
-000101a0: 732e 6170 7065 6e64 2827 6475 6d6d 7931  s.append('dummy1
-000101b0: 2729 0a20 2020 2020 2020 2072 6574 203d  ').        ret =
-000101c0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-000101d0: 6c69 7374 5f66 696c 6573 2827 2f70 6174  list_files('/pat
-000101e0: 682f 3127 290a 2020 2020 2020 2020 7365  h/1').        se
-000101f0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00010200: 6574 2c20 2764 756d 6d79 3127 290a 2020  et, 'dummy1').  
-00010210: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010220: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-00010230: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
-00010240: 2020 2020 2020 2020 2020 2028 276c 6973             ('lis
-00010250: 745f 6669 6c65 7327 2c20 272f 7061 7468  t_files', '/path
-00010260: 2f31 272c 204e 6f6e 652c 2046 616c 7365  /1', None, False
-00010270: 292c 0a20 2020 2020 2020 205d 290a 2020  ),.        ]).  
-00010280: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
-00010290: 652e 7265 7175 6573 7473 203d 205b 5d0a  e.requests = [].
-000102a0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-000102b0: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
-000102c0: 7070 656e 6428 2764 756d 6d79 3227 290a  ppend('dummy2').
-000102d0: 2020 2020 2020 2020 7265 7420 3d20 7365          ret = se
-000102e0: 6c66 2e63 6f6e 7461 696e 6572 2e6c 6973  lf.container.lis
-000102f0: 745f 6669 6c65 7328 272f 7061 7468 2f32  t_files('/path/2
-00010300: 272c 2070 6174 7465 726e 3d27 2a2e 7478  ', pattern='*.tx
-00010310: 7427 2c20 6974 7365 6c66 3d54 7275 6529  t', itself=True)
-00010320: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00010330: 7365 7274 4571 7561 6c28 7265 742c 2027  sertEqual(ret, '
-00010340: 6475 6d6d 7932 2729 0a20 2020 2020 2020  dummy2').       
-00010350: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010360: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-00010370: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-00010380: 2020 2020 2020 2827 6c69 7374 5f66 696c        ('list_fil
-00010390: 6573 272c 2027 2f70 6174 682f 3227 2c20  es', '/path/2', 
-000103a0: 272a 2e74 7874 272c 2054 7275 6529 2c0a  '*.txt', True),.
-000103b0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-000103c0: 6465 6620 7465 7374 5f6d 616b 655f 6469  def test_make_di
-000103d0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-000103e0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-000103f0: 6d61 6b65 5f64 6972 2827 2f70 6174 682f  make_dir('/path/
-00010400: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-00010410: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00010420: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-00010430: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-00010440: 2028 276d 616b 655f 6469 7227 2c20 272f   ('make_dir', '/
-00010450: 7061 7468 2f31 272c 2046 616c 7365 2c20  path/1', False, 
-00010460: 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f 6e65  None, None, None
-00010470: 2c20 4e6f 6e65 2c20 4e6f 6e65 292c 0a20  , None, None),. 
-00010480: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-00010490: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
-000104a0: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
-000104b0: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
-000104c0: 6e65 722e 6d61 6b65 5f64 6972 2827 2f70  ner.make_dir('/p
-000104d0: 6174 682f 3227 2c20 6d61 6b65 5f70 6172  ath/2', make_par
-000104e0: 656e 7473 3d54 7275 652c 2070 6572 6d69  ents=True, permi
-000104f0: 7373 696f 6e73 3d30 6f37 3030 2c0a 2020  ssions=0o700,.  
-00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010510: 2020 2020 2020 2020 2020 2020 2020 7573                us
-00010520: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
-00010530: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
-00010540: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
-00010550: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010560: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-00010570: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-00010580: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-00010590: 276d 616b 655f 6469 7227 2c20 272f 7061  'make_dir', '/pa
-000105a0: 7468 2f32 272c 2054 7275 652c 2030 6f37  th/2', True, 0o7
-000105b0: 3030 2c20 3132 2c20 2762 6f62 272c 2033  00, 12, 'bob', 3
-000105c0: 342c 2027 7374 6166 6627 292c 0a20 2020  4, 'staff'),.   
-000105d0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-000105e0: 2074 6573 745f 7265 6d6f 7665 5f70 6174   test_remove_pat
-000105f0: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
-00010600: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-00010610: 7265 6d6f 7665 5f70 6174 6828 272f 7061  remove_path('/pa
-00010620: 7468 2f31 2729 0a20 2020 2020 2020 2073  th/1').        s
-00010630: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010640: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
-00010650: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-00010660: 2020 2020 2827 7265 6d6f 7665 5f70 6174      ('remove_pat
-00010670: 6827 2c20 272f 7061 7468 2f31 272c 2046  h', '/path/1', F
-00010680: 616c 7365 292c 0a20 2020 2020 2020 205d  alse),.        ]
-00010690: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
-000106a0: 6562 626c 652e 7265 7175 6573 7473 203d  ebble.requests =
-000106b0: 205b 5d0a 0a20 2020 2020 2020 2073 656c   []..        sel
-000106c0: 662e 636f 6e74 6169 6e65 722e 7265 6d6f  f.container.remo
-000106d0: 7665 5f70 6174 6828 272f 7061 7468 2f32  ve_path('/path/2
-000106e0: 272c 2072 6563 7572 7369 7665 3d54 7275  ', recursive=Tru
-000106f0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00010700: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00010710: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-00010720: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00010730: 2827 7265 6d6f 7665 5f70 6174 6827 2c20  ('remove_path', 
-00010740: 272f 7061 7468 2f32 272c 2054 7275 6529  '/path/2', True)
-00010750: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00010760: 2020 6465 6620 7465 7374 5f63 616e 5f63    def test_can_c
-00010770: 6f6e 6e65 6374 5f73 696d 706c 6528 7365  onnect_simple(se
-00010780: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00010790: 662e 7065 6262 6c65 2e72 6573 706f 6e73  f.pebble.respons
-000107a0: 6573 2e61 7070 656e 6428 7065 6262 6c65  es.append(pebble
-000107b0: 2e53 7973 7465 6d49 6e66 6f2e 6672 6f6d  .SystemInfo.from
-000107c0: 5f64 6963 7428 7b27 7665 7273 696f 6e27  _dict({'version'
-000107d0: 3a20 2731 2e30 2e30 277d 2929 0a20 2020  : '1.0.0'})).   
-000107e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000107f0: 5472 7565 2873 656c 662e 636f 6e74 6169  True(self.contai
-00010800: 6e65 722e 6361 6e5f 636f 6e6e 6563 7428  ner.can_connect(
-00010810: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-00010820: 5f63 616e 5f63 6f6e 6e65 6374 5f63 6f6e  _can_connect_con
-00010830: 6e65 6374 696f 6e5f 6572 726f 7228 7365  nection_error(se
-00010840: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
-00010850: 2072 6169 7365 5f65 7272 6f72 2829 3a0a   raise_error():.
-00010860: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010870: 6520 7065 6262 6c65 2e43 6f6e 6e65 6374  e pebble.Connect
-00010880: 696f 6e45 7272 6f72 2827 636f 6e6e 6563  ionError('connec
-00010890: 7469 6f6e 2065 7272 6f72 2127 290a 2020  tion error!').  
-000108a0: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
-000108b0: 652e 6765 745f 7379 7374 656d 5f69 6e66  e.get_system_inf
-000108c0: 6f20 3d20 7261 6973 655f 6572 726f 720a  o = raise_error.
-000108d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000108e0: 662e 6173 7365 7274 4c6f 6773 2827 6f70  f.assertLogs('op
-000108f0: 7327 2c20 6c65 7665 6c3d 2744 4542 5547  s', level='DEBUG
-00010900: 2729 2061 7320 636d 3a0a 2020 2020 2020  ') as cm:.      
-00010910: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010920: 7446 616c 7365 2873 656c 662e 636f 6e74  tFalse(self.cont
-00010930: 6169 6e65 722e 6361 6e5f 636f 6e6e 6563  ainer.can_connec
-00010940: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
-00010950: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-00010960: 6e28 636d 2e6f 7574 7075 7429 2c20 3129  n(cm.output), 1)
-00010970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00010980: 7365 7274 5265 6765 7828 636d 2e6f 7574  sertRegex(cm.out
-00010990: 7075 745b 305d 2c20 7227 4445 4255 473a  put[0], r'DEBUG:
-000109a0: 6f70 732e 6d6f 6465 6c3a 2e2a 3a20 636f  ops.model:.*: co
-000109b0: 6e6e 6563 7469 6f6e 2065 7272 6f72 2127  nnection error!'
-000109c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000109d0: 6361 6e5f 636f 6e6e 6563 745f 6669 6c65  can_connect_file
-000109e0: 5f6e 6f74 5f66 6f75 6e64 5f65 7272 6f72  _not_found_error
-000109f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00010a00: 6465 6620 7261 6973 655f 6572 726f 7228  def raise_error(
-00010a10: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00010a20: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
-00010a30: 6445 7272 6f72 2827 6669 6c65 206e 6f74  dError('file not
-00010a40: 2066 6f75 6e64 2127 290a 2020 2020 2020   found!').      
-00010a50: 2020 7365 6c66 2e70 6562 626c 652e 6765    self.pebble.ge
-00010a60: 745f 7379 7374 656d 5f69 6e66 6f20 3d20  t_system_info = 
-00010a70: 7261 6973 655f 6572 726f 720a 2020 2020  raise_error.    
-00010a80: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00010a90: 7365 7274 4c6f 6773 2827 6f70 7327 2c20  sertLogs('ops', 
-00010aa0: 6c65 7665 6c3d 2744 4542 5547 2729 2061  level='DEBUG') a
-00010ab0: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-00010ac0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00010ad0: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
-00010ae0: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
-00010af0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00010b00: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
-00010b10: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
-00010b20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010b30: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
-00010b40: 305d 2c20 7227 4445 4255 473a 6f70 732e  0], r'DEBUG:ops.
-00010b50: 6d6f 6465 6c3a 2e2a 3a20 6669 6c65 206e  model:.*: file n
-00010b60: 6f74 2066 6f75 6e64 2127 290a 0a20 2020  ot found!')..   
-00010b70: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
-00010b80: 6e6e 6563 745f 6170 695f 6572 726f 7228  nnect_api_error(
-00010b90: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-00010ba0: 6566 2072 6169 7365 5f65 7272 6f72 2829  ef raise_error()
-00010bb0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00010bc0: 6973 6520 7065 6262 6c65 2e41 5049 4572  ise pebble.APIEr
-00010bd0: 726f 7228 2762 6f64 7927 2c20 3430 342c  ror('body', 404,
-00010be0: 2027 7374 6174 7573 272c 2027 6170 6920   'status', 'api 
-00010bf0: 6572 726f 7221 2729 0a20 2020 2020 2020  error!').       
-00010c00: 2073 656c 662e 7065 6262 6c65 2e67 6574   self.pebble.get
-00010c10: 5f73 7973 7465 6d5f 696e 666f 203d 2072  _system_info = r
-00010c20: 6169 7365 5f65 7272 6f72 0a20 2020 2020  aise_error.     
-00010c30: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00010c40: 6572 744c 6f67 7328 276f 7073 2729 2061  ertLogs('ops') a
-00010c50: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-00010c60: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00010c70: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
-00010c80: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
-00010c90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00010ca0: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
-00010cb0: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
-00010cc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010cd0: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
-00010ce0: 305d 2c20 7227 5741 524e 494e 473a 6f70  0], r'WARNING:op
-00010cf0: 732e 6d6f 6465 6c3a 2e2a 3a20 6170 6920  s.model:.*: api 
-00010d00: 6572 726f 7221 2729 0a0a 2020 2020 6465  error!')..    de
-00010d10: 6620 7465 7374 5f65 7865 6328 7365 6c66  f test_exec(self
-00010d20: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00010d30: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-00010d40: 2e61 7070 656e 6428 2766 616b 655f 6578  .append('fake_ex
-00010d50: 6563 5f70 726f 6365 7373 2729 0a20 2020  ec_process').   
-00010d60: 2020 2020 2070 203d 2073 656c 662e 636f       p = self.co
-00010d70: 6e74 6169 6e65 722e 6578 6563 280a 2020  ntainer.exec(.  
-00010d80: 2020 2020 2020 2020 2020 5b27 6563 686f            ['echo
-00010d90: 272c 2027 666f 6f27 5d2c 0a20 2020 2020  ', 'foo'],.     
-00010da0: 2020 2020 2020 2065 6e76 6972 6f6e 6d65         environme
-00010db0: 6e74 3d7b 274b 3127 3a20 2756 3127 2c20  nt={'K1': 'V1', 
-00010dc0: 274b 3227 3a20 2756 3227 7d2c 0a20 2020  'K2': 'V2'},.   
-00010dd0: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
-00010de0: 5f64 6972 3d27 5744 272c 0a20 2020 2020  _dir='WD',.     
-00010df0: 2020 2020 2020 2074 696d 656f 7574 3d31         timeout=1
-00010e00: 302e 352c 0a20 2020 2020 2020 2020 2020  0.5,.           
-00010e10: 2075 7365 725f 6964 3d31 3030 302c 0a20   user_id=1000,. 
-00010e20: 2020 2020 2020 2020 2020 2075 7365 723d             user=
-00010e30: 2762 6f62 272c 0a20 2020 2020 2020 2020  'bob',.         
-00010e40: 2020 2067 726f 7570 5f69 643d 3130 3030     group_id=1000
-00010e50: 2c0a 2020 2020 2020 2020 2020 2020 6772  ,.            gr
-00010e60: 6f75 703d 2773 7461 6666 272c 0a20 2020  oup='staff',.   
-00010e70: 2020 2020 2020 2020 2073 7464 696e 3d27           stdin='
-00010e80: 5354 4449 4e27 2c0a 2020 2020 2020 2020  STDIN',.        
-00010e90: 2020 2020 7374 646f 7574 3d27 5354 444f      stdout='STDO
-00010ea0: 5554 272c 0a20 2020 2020 2020 2020 2020  UT',.           
-00010eb0: 2073 7464 6572 723d 2753 5444 4552 5227   stderr='STDERR'
-00010ec0: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
-00010ed0: 636f 6469 6e67 3d4e 6f6e 652c 0a20 2020  coding=None,.   
-00010ee0: 2020 2020 2020 2020 2063 6f6d 6269 6e65           combine
-00010ef0: 5f73 7464 6572 723d 5472 7565 2c0a 2020  _stderr=True,.  
-00010f00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010f10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00010f20: 2873 656c 662e 7065 6262 6c65 2e72 6571  (self.pebble.req
-00010f30: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00010f40: 2020 2020 2028 2765 7865 6327 2c20 5b27       ('exec', ['
-00010f50: 6563 686f 272c 2027 666f 6f27 5d2c 2064  echo', 'foo'], d
-00010f60: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-00010f70: 2020 2020 2065 6e76 6972 6f6e 6d65 6e74       environment
-00010f80: 3d7b 274b 3127 3a20 2756 3127 2c20 274b  ={'K1': 'V1', 'K
-00010f90: 3227 3a20 2756 3227 7d2c 0a20 2020 2020  2': 'V2'},.     
-00010fa0: 2020 2020 2020 2020 2020 2077 6f72 6b69             worki
-00010fb0: 6e67 5f64 6972 3d27 5744 272c 0a20 2020  ng_dir='WD',.   
-00010fc0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-00010fd0: 656f 7574 3d31 302e 352c 0a20 2020 2020  eout=10.5,.     
-00010fe0: 2020 2020 2020 2020 2020 2075 7365 725f             user_
-00010ff0: 6964 3d31 3030 302c 0a20 2020 2020 2020  id=1000,.       
-00011000: 2020 2020 2020 2020 2075 7365 723d 2762           user='b
-00011010: 6f62 272c 0a20 2020 2020 2020 2020 2020  ob',.           
-00011020: 2020 2020 2067 726f 7570 5f69 643d 3130       group_id=10
-00011030: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00011040: 2020 2020 6772 6f75 703d 2773 7461 6666      group='staff
-00011050: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00011060: 2020 2073 7464 696e 3d27 5354 4449 4e27     stdin='STDIN'
-00011070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011080: 2020 7374 646f 7574 3d27 5354 444f 5554    stdout='STDOUT
-00011090: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000110a0: 2020 2073 7464 6572 723d 2753 5444 4552     stderr='STDER
-000110b0: 5227 2c0a 2020 2020 2020 2020 2020 2020  R',.            
-000110c0: 2020 2020 656e 636f 6469 6e67 3d4e 6f6e      encoding=Non
-000110d0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000110e0: 2020 2063 6f6d 6269 6e65 5f73 7464 6572     combine_stder
-000110f0: 723d 5472 7565 2c0a 2020 2020 2020 2020  r=True,.        
-00011100: 2020 2020 2929 0a20 2020 2020 2020 205d      )).        ]
-00011110: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011120: 7373 6572 7445 7175 616c 2870 2c20 2766  ssertEqual(p, 'f
-00011130: 616b 655f 6578 6563 5f70 726f 6365 7373  ake_exec_process
-00011140: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-00011150: 5f73 656e 645f 7369 676e 616c 2873 656c  _send_signal(sel
-00011160: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
-00011170: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00011180: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-00011190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000111a0: 636f 6e74 6169 6e65 722e 7365 6e64 5f73  container.send_s
-000111b0: 6967 6e61 6c28 2753 4947 4855 5027 290a  ignal('SIGHUP').
-000111c0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-000111d0: 6e74 6169 6e65 722e 7365 6e64 5f73 6967  ntainer.send_sig
-000111e0: 6e61 6c28 2753 4947 4855 5027 2c20 2773  nal('SIGHUP', 's
-000111f0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-00011200: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00011210: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-00011220: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-00011230: 2028 2773 656e 645f 7369 676e 616c 272c   ('send_signal',
-00011240: 2027 5349 4748 5550 272c 2028 2773 3127   'SIGHUP', ('s1'
-00011250: 2c29 292c 0a20 2020 2020 2020 205d 290a  ,)),.        ]).
-00011260: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
-00011270: 626c 652e 7265 7175 6573 7473 203d 205b  ble.requests = [
-00011280: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
-00011290: 636f 6e74 6169 6e65 722e 7365 6e64 5f73  container.send_s
-000112a0: 6967 6e61 6c28 2753 4947 4855 5027 2c20  ignal('SIGHUP', 
-000112b0: 2773 3127 2c20 2773 3227 290a 2020 2020  's1', 's2').    
-000112c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000112d0: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
-000112e0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-000112f0: 2020 2020 2020 2020 2028 2773 656e 645f           ('send_
-00011300: 7369 676e 616c 272c 2027 5349 4748 5550  signal', 'SIGHUP
-00011310: 272c 2028 2773 3127 2c20 2773 3227 2929  ', ('s1', 's2'))
-00011320: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-00011330: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-00011340: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
-00011350: 0a63 6c61 7373 204d 6f63 6b50 6562 626c  .class MockPebbl
-00011360: 6542 6163 6b65 6e64 285f 4d6f 6465 6c42  eBackend(_ModelB
-00011370: 6163 6b65 6e64 293a 0a20 2020 2064 6566  ackend):.    def
-00011380: 2067 6574 5f70 6562 626c 6528 7365 6c66   get_pebble(self
-00011390: 2c20 736f 636b 6574 5f70 6174 6829 3a0a  , socket_path):.
-000113a0: 2020 2020 2020 2020 7265 7475 726e 204d          return M
-000113b0: 6f63 6b50 6562 626c 6543 6c69 656e 7428  ockPebbleClient(
-000113c0: 736f 636b 6574 5f70 6174 6829 0a0a 0a63  socket_path)...c
-000113d0: 6c61 7373 204d 6f63 6b50 6562 626c 6543  lass MockPebbleC
-000113e0: 6c69 656e 743a 0a20 2020 2064 6566 205f  lient:.    def _
-000113f0: 5f69 6e69 745f 5f28 7365 6c66 2c20 736f  _init__(self, so
-00011400: 636b 6574 5f70 6174 6829 3a0a 2020 2020  cket_path):.    
-00011410: 2020 2020 7365 6c66 2e73 6f63 6b65 745f      self.socket_
-00011420: 7061 7468 203d 2073 6f63 6b65 745f 7061  path = socket_pa
-00011430: 7468 0a20 2020 2020 2020 2073 656c 662e  th.        self.
-00011440: 7265 7175 6573 7473 203d 205b 5d0a 2020  requests = [].  
-00011450: 2020 2020 2020 7365 6c66 2e72 6573 706f        self.respo
-00011460: 6e73 6573 203d 205b 5d0a 0a20 2020 2064  nses = []..    d
-00011470: 6566 2061 7574 6f73 7461 7274 5f73 6572  ef autostart_ser
-00011480: 7669 6365 7328 7365 6c66 293a 0a20 2020  vices(self):.   
-00011490: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-000114a0: 7473 2e61 7070 656e 6428 2827 6175 746f  ts.append(('auto
-000114b0: 7374 6172 7427 2c29 290a 0a20 2020 2064  start',))..    d
-000114c0: 6566 2067 6574 5f73 7973 7465 6d5f 696e  ef get_system_in
-000114d0: 666f 2873 656c 6629 3a0a 2020 2020 2020  fo(self):.      
-000114e0: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
-000114f0: 6170 7065 6e64 2828 2767 6574 5f73 7973  append(('get_sys
-00011500: 7465 6d5f 696e 666f 272c 2929 0a20 2020  tem_info',)).   
-00011510: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00011520: 2e72 6573 706f 6e73 6573 2e70 6f70 2830  .responses.pop(0
-00011530: 290a 0a20 2020 2064 6566 2072 6570 6c61  )..    def repla
-00011540: 6e5f 7365 7276 6963 6573 2873 656c 6629  n_services(self)
-00011550: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
-00011560: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
-00011570: 2772 6570 6c61 6e27 2c29 290a 0a20 2020  'replan',))..   
-00011580: 2064 6566 2073 7461 7274 5f73 6572 7669   def start_servi
-00011590: 6365 7328 7365 6c66 2c20 7365 7276 6963  ces(self, servic
-000115a0: 655f 6e61 6d65 7329 3a0a 2020 2020 2020  e_names):.      
-000115b0: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
-000115c0: 6170 7065 6e64 2828 2773 7461 7274 272c  append(('start',
-000115d0: 2073 6572 7669 6365 5f6e 616d 6573 2929   service_names))
-000115e0: 0a0a 2020 2020 6465 6620 7374 6f70 5f73  ..    def stop_s
-000115f0: 6572 7669 6365 7328 7365 6c66 2c20 7365  ervices(self, se
-00011600: 7276 6963 655f 6e61 6d65 7329 3a0a 2020  rvice_names):.  
-00011610: 2020 2020 2020 7365 6c66 2e72 6571 7565        self.reque
-00011620: 7374 732e 6170 7065 6e64 2828 2773 746f  sts.append(('sto
-00011630: 7027 2c20 7365 7276 6963 655f 6e61 6d65  p', service_name
-00011640: 7329 290a 0a20 2020 2064 6566 2072 6573  s))..    def res
-00011650: 7461 7274 5f73 6572 7669 6365 7328 7365  tart_services(se
-00011660: 6c66 2c20 7365 7276 6963 655f 6e61 6d65  lf, service_name
-00011670: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-00011680: 2e72 6571 7565 7374 732e 6170 7065 6e64  .requests.append
-00011690: 2828 2772 6573 7461 7274 272c 2073 6572  (('restart', ser
-000116a0: 7669 6365 5f6e 616d 6573 2929 0a0a 2020  vice_names))..  
-000116b0: 2020 6465 6620 6164 645f 6c61 7965 7228    def add_layer(
-000116c0: 7365 6c66 2c20 6c61 6265 6c2c 206c 6179  self, label, lay
-000116d0: 6572 2c20 636f 6d62 696e 653d 4661 6c73  er, combine=Fals
-000116e0: 6529 3a0a 2020 2020 2020 2020 6966 2069  e):.        if i
-000116f0: 7369 6e73 7461 6e63 6528 6c61 7965 722c  sinstance(layer,
-00011700: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
-00011710: 2020 2020 6c61 7965 7220 3d20 7065 6262      layer = pebb
-00011720: 6c65 2e4c 6179 6572 286c 6179 6572 292e  le.Layer(layer).
-00011730: 746f 5f79 616d 6c28 290a 2020 2020 2020  to_yaml().      
-00011740: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00011750: 6528 6c61 7965 722c 2070 6562 626c 652e  e(layer, pebble.
-00011760: 4c61 7965 7229 3a0a 2020 2020 2020 2020  Layer):.        
-00011770: 2020 2020 6c61 7965 7220 3d20 6c61 7965      layer = laye
-00011780: 722e 746f 5f79 616d 6c28 290a 2020 2020  r.to_yaml().    
-00011790: 2020 2020 7365 6c66 2e72 6571 7565 7374      self.request
-000117a0: 732e 6170 7065 6e64 2828 2761 6464 5f6c  s.append(('add_l
-000117b0: 6179 6572 272c 206c 6162 656c 2c20 6c61  ayer', label, la
-000117c0: 7965 722c 2063 6f6d 6269 6e65 2929 0a0a  yer, combine))..
-000117d0: 2020 2020 6465 6620 6765 745f 706c 616e      def get_plan
-000117e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000117f0: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
-00011800: 7065 6e64 2828 2767 6574 5f70 6c61 6e27  pend(('get_plan'
-00011810: 2c29 290a 2020 2020 2020 2020 7265 7475  ,)).        retu
-00011820: 726e 2073 656c 662e 7265 7370 6f6e 7365  rn self.response
-00011830: 732e 706f 7028 3029 0a0a 2020 2020 6465  s.pop(0)..    de
-00011840: 6620 6765 745f 7365 7276 6963 6573 2873  f get_services(s
-00011850: 656c 662c 206e 616d 6573 3d4e 6f6e 6529  elf, names=None)
-00011860: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
-00011870: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
-00011880: 2767 6574 5f73 6572 7669 6365 7327 2c20  'get_services', 
-00011890: 6e61 6d65 7329 290a 2020 2020 2020 2020  names)).        
-000118a0: 7265 7475 726e 2073 656c 662e 7265 7370  return self.resp
-000118b0: 6f6e 7365 732e 706f 7028 3029 0a0a 2020  onses.pop(0)..  
-000118c0: 2020 6465 6620 6765 745f 6368 6563 6b73    def get_checks
-000118d0: 2873 656c 662c 206c 6576 656c 3d4e 6f6e  (self, level=Non
-000118e0: 652c 206e 616d 6573 3d4e 6f6e 6529 3a0a  e, names=None):.
-000118f0: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-00011900: 7565 7374 732e 6170 7065 6e64 2828 2767  uests.append(('g
-00011910: 6574 5f63 6865 636b 7327 2c20 6c65 7665  et_checks', leve
-00011920: 6c2c 206e 616d 6573 2929 0a20 2020 2020  l, names)).     
-00011930: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
-00011940: 6573 706f 6e73 6573 2e70 6f70 2830 290a  esponses.pop(0).
-00011950: 0a20 2020 2064 6566 2070 756c 6c28 7365  .    def pull(se
-00011960: 6c66 2c20 7061 7468 2c20 2a2c 2065 6e63  lf, path, *, enc
-00011970: 6f64 696e 673d 2775 7466 2d38 2729 3a0a  oding='utf-8'):.
-00011980: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-00011990: 7565 7374 732e 6170 7065 6e64 2828 2770  uests.append(('p
-000119a0: 756c 6c27 2c20 7061 7468 2c20 656e 636f  ull', path, enco
-000119b0: 6469 6e67 2929 0a20 2020 2020 2020 2072  ding)).        r
-000119c0: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
-000119d0: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
-000119e0: 2064 6566 2070 7573 6828 7365 6c66 2c20   def push(self, 
-000119f0: 7061 7468 2c20 736f 7572 6365 2c20 2a2c  path, source, *,
-00011a00: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
-00011a10: 272c 206d 616b 655f 6469 7273 3d46 616c  ', make_dirs=Fal
-00011a20: 7365 2c20 7065 726d 6973 7369 6f6e 733d  se, permissions=
-00011a30: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00011a40: 2020 2075 7365 725f 6964 3d4e 6f6e 652c     user_id=None,
-00011a50: 2075 7365 723d 4e6f 6e65 2c20 6772 6f75   user=None, grou
-00011a60: 705f 6964 3d4e 6f6e 652c 2067 726f 7570  p_id=None, group
-00011a70: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-00011a80: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
-00011a90: 7065 6e64 2828 2770 7573 6827 2c20 7061  pend(('push', pa
-00011aa0: 7468 2c20 736f 7572 6365 2c20 656e 636f  th, source, enco
-00011ab0: 6469 6e67 2c20 6d61 6b65 5f64 6972 732c  ding, make_dirs,
-00011ac0: 2070 6572 6d69 7373 696f 6e73 2c0a 2020   permissions,.  
-00011ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ae0: 2020 2020 2020 2020 2020 2020 7573 6572              user
-00011af0: 5f69 642c 2075 7365 722c 2067 726f 7570  _id, user, group
-00011b00: 5f69 642c 2067 726f 7570 2929 0a0a 2020  _id, group))..  
-00011b10: 2020 6465 6620 6c69 7374 5f66 696c 6573    def list_files
-00011b20: 2873 656c 662c 2070 6174 682c 202a 2c20  (self, path, *, 
-00011b30: 7061 7474 6572 6e3d 4e6f 6e65 2c20 6974  pattern=None, it
-00011b40: 7365 6c66 3d46 616c 7365 293a 0a20 2020  self=False):.   
-00011b50: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
-00011b60: 7473 2e61 7070 656e 6428 2827 6c69 7374  ts.append(('list
-00011b70: 5f66 696c 6573 272c 2070 6174 682c 2070  _files', path, p
-00011b80: 6174 7465 726e 2c20 6974 7365 6c66 2929  attern, itself))
-00011b90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011ba0: 7365 6c66 2e72 6573 706f 6e73 6573 2e70  self.responses.p
-00011bb0: 6f70 2830 290a 0a20 2020 2064 6566 206d  op(0)..    def m
-00011bc0: 616b 655f 6469 7228 7365 6c66 2c20 7061  ake_dir(self, pa
-00011bd0: 7468 2c20 2a2c 206d 616b 655f 7061 7265  th, *, make_pare
-00011be0: 6e74 733d 4661 6c73 652c 2070 6572 6d69  nts=False, permi
-00011bf0: 7373 696f 6e73 3d4e 6f6e 652c 2075 7365  ssions=None, use
-00011c00: 725f 6964 3d4e 6f6e 652c 2075 7365 723d  r_id=None, user=
-00011c10: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00011c20: 2020 2020 2020 2067 726f 7570 5f69 643d         group_id=
-00011c30: 4e6f 6e65 2c20 6772 6f75 703d 4e6f 6e65  None, group=None
-00011c40: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011c50: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-00011c60: 2827 6d61 6b65 5f64 6972 272c 2070 6174  ('make_dir', pat
-00011c70: 682c 206d 616b 655f 7061 7265 6e74 732c  h, make_parents,
-00011c80: 2070 6572 6d69 7373 696f 6e73 2c20 7573   permissions, us
-00011c90: 6572 5f69 642c 2075 7365 722c 0a20 2020  er_id, user,.   
+0000f7c0: 7374 6174 7573 273a 2027 7570 272c 0a20  status': 'up',. 
+0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000f7e0: 6661 696c 7572 6573 273a 2030 2c0a 2020  failures': 0,.  
+0000f7f0: 2020 2020 2020 2020 2020 2020 2020 2774                't
+0000f800: 6872 6573 686f 6c64 273a 2033 2c0a 2020  hreshold': 3,.  
+0000f810: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
+0000f820: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
+0000f830: 6320 3d20 7365 6c66 2e63 6f6e 7461 696e  c = self.contain
+0000f840: 6572 2e67 6574 5f63 6865 636b 2827 6331  er.get_check('c1
+0000f850: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000f860: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000f870: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000f880: 2c20 5b28 2767 6574 5f63 6865 636b 7327  , [('get_checks'
+0000f890: 2c20 4e6f 6e65 2c20 2827 6331 272c 2029  , None, ('c1', )
+0000f8a0: 295d 290a 2020 2020 2020 2020 7365 6c66  )]).        self
+0000f8b0: 2e61 7373 6572 7445 7175 616c 2863 2e6e  .assertEqual(c.n
+0000f8c0: 616d 652c 2027 6331 2729 0a20 2020 2020  ame, 'c1').     
+0000f8d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f8e0: 7561 6c28 632e 6c65 7665 6c2c 2070 6562  ual(c.level, peb
+0000f8f0: 626c 652e 4368 6563 6b4c 6576 656c 2e55  ble.CheckLevel.U
+0000f900: 4e53 4554 290a 2020 2020 2020 2020 7365  NSET).        se
+0000f910: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000f920: 2e73 7461 7475 732c 2070 6562 626c 652e  .status, pebble.
+0000f930: 4368 6563 6b53 7461 7475 732e 5550 290a  CheckStatus.UP).
+0000f940: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000f950: 6572 7445 7175 616c 2863 2e66 6169 6c75  ertEqual(c.failu
+0000f960: 7265 732c 2030 290a 2020 2020 2020 2020  res, 0).        
+0000f970: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000f980: 2863 2e74 6872 6573 686f 6c64 2c20 3329  (c.threshold, 3)
+0000f990: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
+0000f9a0: 6562 626c 6520 7265 7475 726e 7320 6e6f  ebble returns no
+0000f9b0: 2063 6865 636b 732c 2073 686f 756c 6420   checks, should 
+0000f9c0: 6265 2061 206f 7073 2e4d 6f64 656c 4572  be a ops.ModelEr
+0000f9d0: 726f 720a 2020 2020 2020 2020 7365 6c66  ror.        self
+0000f9e0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+0000f9f0: 732e 6170 7065 6e64 285b 5d29 0a20 2020  s.append([]).   
+0000fa00: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000fa10: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+0000fa20: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
+0000fa30: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
+0000fa40: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
+0000fa50: 745f 6368 6563 6b28 2763 3227 290a 2020  t_check('c2').  
+0000fa60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000fa70: 7445 7175 616c 2873 7472 2863 6d2e 6578  tEqual(str(cm.ex
+0000fa80: 6365 7074 696f 6e29 2c20 2263 6865 636b  ception), "check
+0000fa90: 2027 6332 2720 6e6f 7420 666f 756e 6422   'c2' not found"
+0000faa0: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
+0000fab0: 5065 6262 6c65 2072 6574 7572 6e73 206d  Pebble returns m
+0000fac0: 6f72 6520 7468 616e 206f 6e65 2063 6865  ore than one che
+0000fad0: 636b 2c20 5275 6e74 696d 6545 7272 6f72  ck, RuntimeError
+0000fae0: 2069 7320 7261 6973 6564 0a20 2020 2020   is raised.     
+0000faf0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
+0000fb00: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000fb10: 5b0a 2020 2020 2020 2020 2020 2020 7065  [.            pe
+0000fb20: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
+0000fb30: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
+0000fb40: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
+0000fb50: 273a 2027 6331 272c 0a20 2020 2020 2020  ': 'c1',.       
+0000fb60: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+0000fb70: 273a 2027 7570 272c 0a20 2020 2020 2020  ': 'up',.       
+0000fb80: 2020 2020 2020 2020 2027 6661 696c 7572           'failur
+0000fb90: 6573 273a 2030 2c0a 2020 2020 2020 2020  es': 0,.        
+0000fba0: 2020 2020 2020 2020 2774 6872 6573 686f          'thresho
+0000fbb0: 6c64 273a 2033 2c0a 2020 2020 2020 2020  ld': 3,.        
+0000fbc0: 2020 2020 7d29 2c0a 2020 2020 2020 2020      }),.        
+0000fbd0: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
+0000fbe0: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+0000fbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc00: 2027 6e61 6d65 273a 2027 6332 272c 0a20   'name': 'c2',. 
+0000fc10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000fc20: 6c65 7665 6c27 3a20 2761 6c69 7665 272c  level': 'alive',
+0000fc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc40: 2027 7374 6174 7573 273a 2027 646f 776e   'status': 'down
+0000fc50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000fc60: 2020 2027 6661 696c 7572 6573 273a 2032     'failures': 2
+0000fc70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000fc80: 2020 2774 6872 6573 686f 6c64 273a 2032    'threshold': 2
+0000fc90: 2c0a 2020 2020 2020 2020 2020 2020 7d29  ,.            })
+0000fca0: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0000fcb0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000fcc0: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
+0000fcd0: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
+0000fce0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000fcf0: 6169 6e65 722e 6765 745f 6368 6563 6b28  ainer.get_check(
+0000fd00: 2763 3127 290a 0a20 2020 2064 6566 2074  'c1')..    def t
+0000fd10: 6573 745f 7075 6c6c 2873 656c 6629 3a0a  est_pull(self):.
+0000fd20: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000fd30: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000fd40: 7065 6e64 2827 6475 6d6d 7931 2729 0a20  pend('dummy1'). 
+0000fd50: 2020 2020 2020 2067 6f74 203d 2073 656c         got = sel
+0000fd60: 662e 636f 6e74 6169 6e65 722e 7075 6c6c  f.container.pull
+0000fd70: 2827 2f70 6174 682f 3127 290a 2020 2020  ('/path/1').    
+0000fd80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000fd90: 7175 616c 2867 6f74 2c20 2764 756d 6d79  qual(got, 'dummy
+0000fda0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+0000fdb0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000fdc0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000fdd0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+0000fde0: 2028 2770 756c 6c27 2c20 272f 7061 7468   ('pull', '/path
+0000fdf0: 2f31 272c 2027 7574 662d 3827 292c 0a20  /1', 'utf-8'),. 
+0000fe00: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+0000fe10: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
+0000fe20: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
+0000fe30: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000fe40: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000fe50: 6428 6227 6475 6d6d 7932 2729 0a20 2020  d(b'dummy2').   
+0000fe60: 2020 2020 2067 6f74 203d 2073 656c 662e       got = self.
+0000fe70: 636f 6e74 6169 6e65 722e 7075 6c6c 2827  container.pull('
+0000fe80: 2f70 6174 682f 3227 2c20 656e 636f 6469  /path/2', encodi
+0000fe90: 6e67 3d4e 6f6e 6529 0a20 2020 2020 2020  ng=None).       
+0000fea0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000feb0: 6c28 676f 742c 2062 2764 756d 6d79 3227  l(got, b'dummy2'
+0000fec0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000fed0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000fee0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000fef0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000ff00: 2770 756c 6c27 2c20 272f 7061 7468 2f32  'pull', '/path/2
+0000ff10: 272c 204e 6f6e 6529 2c0a 2020 2020 2020  ', None),.      
+0000ff20: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000ff30: 7374 5f70 7573 6828 7365 6c66 293a 0a20  st_push(self):. 
+0000ff40: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000ff50: 6169 6e65 722e 7075 7368 2827 2f70 6174  ainer.push('/pat
+0000ff60: 682f 3127 2c20 2763 6f6e 7465 6e74 3127  h/1', 'content1'
+0000ff70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000ff80: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000ff90: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000ffa0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000ffb0: 2770 7573 6827 2c20 272f 7061 7468 2f31  'push', '/path/1
+0000ffc0: 272c 2027 636f 6e74 656e 7431 272c 2027  ', 'content1', '
+0000ffd0: 7574 662d 3827 2c20 4661 6c73 652c 204e  utf-8', False, N
+0000ffe0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0000fff0: 2020 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f    None, None, No
+00010000: 6e65 2c20 4e6f 6e65 292c 0a20 2020 2020  ne, None),.     
+00010010: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00010020: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+00010030: 7473 203d 205b 5d0a 0a20 2020 2020 2020  ts = []..       
+00010040: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+00010050: 7075 7368 2827 2f70 6174 682f 3227 2c20  push('/path/2', 
+00010060: 6227 636f 6e74 656e 7432 272c 2065 6e63  b'content2', enc
+00010070: 6f64 696e 673d 4e6f 6e65 2c20 6d61 6b65  oding=None, make
+00010080: 5f64 6972 733d 5472 7565 2c0a 2020 2020  _dirs=True,.    
+00010090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100a0: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
+000100b0: 6f6e 733d 306f 3630 302c 2075 7365 725f  ons=0o600, user_
+000100c0: 6964 3d31 322c 2075 7365 723d 2762 6f62  id=12, user='bob
+000100d0: 272c 2067 726f 7570 5f69 643d 3334 2c20  ', group_id=34, 
+000100e0: 6772 6f75 703d 2773 7461 6666 2729 0a20  group='staff'). 
+000100f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00010100: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+00010110: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
+00010120: 2020 2020 2020 2020 2020 2020 2827 7075              ('pu
+00010130: 7368 272c 2027 2f70 6174 682f 3227 2c20  sh', '/path/2', 
+00010140: 6227 636f 6e74 656e 7432 272c 204e 6f6e  b'content2', Non
+00010150: 652c 2054 7275 652c 2030 6f36 3030 2c20  e, True, 0o600, 
+00010160: 3132 2c20 2762 6f62 272c 2033 342c 2027  12, 'bob', 34, '
+00010170: 7374 6166 6627 292c 0a20 2020 2020 2020  staff'),.       
+00010180: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00010190: 745f 6c69 7374 5f66 696c 6573 2873 656c  t_list_files(sel
+000101a0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+000101b0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+000101c0: 732e 6170 7065 6e64 2827 6475 6d6d 7931  s.append('dummy1
+000101d0: 2729 0a20 2020 2020 2020 2072 6574 203d  ').        ret =
+000101e0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+000101f0: 6c69 7374 5f66 696c 6573 2827 2f70 6174  list_files('/pat
+00010200: 682f 3127 290a 2020 2020 2020 2020 7365  h/1').        se
+00010210: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00010220: 6574 2c20 2764 756d 6d79 3127 290a 2020  et, 'dummy1').  
+00010230: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010240: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
+00010250: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
+00010260: 2020 2020 2020 2020 2020 2028 276c 6973             ('lis
+00010270: 745f 6669 6c65 7327 2c20 272f 7061 7468  t_files', '/path
+00010280: 2f31 272c 204e 6f6e 652c 2046 616c 7365  /1', None, False
+00010290: 292c 0a20 2020 2020 2020 205d 290a 2020  ),.        ]).  
+000102a0: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
+000102b0: 652e 7265 7175 6573 7473 203d 205b 5d0a  e.requests = [].
+000102c0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+000102d0: 6262 6c65 2e72 6573 706f 6e73 6573 2e61  bble.responses.a
+000102e0: 7070 656e 6428 2764 756d 6d79 3227 290a  ppend('dummy2').
+000102f0: 2020 2020 2020 2020 7265 7420 3d20 7365          ret = se
+00010300: 6c66 2e63 6f6e 7461 696e 6572 2e6c 6973  lf.container.lis
+00010310: 745f 6669 6c65 7328 272f 7061 7468 2f32  t_files('/path/2
+00010320: 272c 2070 6174 7465 726e 3d27 2a2e 7478  ', pattern='*.tx
+00010330: 7427 2c20 6974 7365 6c66 3d54 7275 6529  t', itself=True)
+00010340: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010350: 7365 7274 4571 7561 6c28 7265 742c 2027  sertEqual(ret, '
+00010360: 6475 6d6d 7932 2729 0a20 2020 2020 2020  dummy2').       
+00010370: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00010380: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
+00010390: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+000103a0: 2020 2020 2020 2827 6c69 7374 5f66 696c        ('list_fil
+000103b0: 6573 272c 2027 2f70 6174 682f 3227 2c20  es', '/path/2', 
+000103c0: 272a 2e74 7874 272c 2054 7275 6529 2c0a  '*.txt', True),.
+000103d0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+000103e0: 6465 6620 7465 7374 5f6d 616b 655f 6469  def test_make_di
+000103f0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+00010400: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+00010410: 6d61 6b65 5f64 6972 2827 2f70 6174 682f  make_dir('/path/
+00010420: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+00010430: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00010440: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+00010450: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00010460: 2028 276d 616b 655f 6469 7227 2c20 272f   ('make_dir', '/
+00010470: 7061 7468 2f31 272c 2046 616c 7365 2c20  path/1', False, 
+00010480: 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f 6e65  None, None, None
+00010490: 2c20 4e6f 6e65 2c20 4e6f 6e65 292c 0a20  , None, None),. 
+000104a0: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+000104b0: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
+000104c0: 7175 6573 7473 203d 205b 5d0a 0a20 2020  quests = []..   
+000104d0: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
+000104e0: 6e65 722e 6d61 6b65 5f64 6972 2827 2f70  ner.make_dir('/p
+000104f0: 6174 682f 3227 2c20 6d61 6b65 5f70 6172  ath/2', make_par
+00010500: 656e 7473 3d54 7275 652c 2070 6572 6d69  ents=True, permi
+00010510: 7373 696f 6e73 3d30 6f37 3030 2c0a 2020  ssions=0o700,.  
+00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010530: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00010540: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
+00010550: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
+00010560: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
+00010570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010580: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00010590: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+000105a0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+000105b0: 276d 616b 655f 6469 7227 2c20 272f 7061  'make_dir', '/pa
+000105c0: 7468 2f32 272c 2054 7275 652c 2030 6f37  th/2', True, 0o7
+000105d0: 3030 2c20 3132 2c20 2762 6f62 272c 2033  00, 12, 'bob', 3
+000105e0: 342c 2027 7374 6166 6627 292c 0a20 2020  4, 'staff'),.   
+000105f0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+00010600: 2074 6573 745f 7265 6d6f 7665 5f70 6174   test_remove_pat
+00010610: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+00010620: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+00010630: 7265 6d6f 7665 5f70 6174 6828 272f 7061  remove_path('/pa
+00010640: 7468 2f31 2729 0a20 2020 2020 2020 2073  th/1').        s
+00010650: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010660: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+00010670: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+00010680: 2020 2020 2827 7265 6d6f 7665 5f70 6174      ('remove_pat
+00010690: 6827 2c20 272f 7061 7468 2f31 272c 2046  h', '/path/1', F
+000106a0: 616c 7365 292c 0a20 2020 2020 2020 205d  alse),.        ]
+000106b0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+000106c0: 6562 626c 652e 7265 7175 6573 7473 203d  ebble.requests =
+000106d0: 205b 5d0a 0a20 2020 2020 2020 2073 656c   []..        sel
+000106e0: 662e 636f 6e74 6169 6e65 722e 7265 6d6f  f.container.remo
+000106f0: 7665 5f70 6174 6828 272f 7061 7468 2f32  ve_path('/path/2
+00010700: 272c 2072 6563 7572 7369 7665 3d54 7275  ', recursive=Tru
+00010710: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00010720: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+00010730: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+00010740: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00010750: 2827 7265 6d6f 7665 5f70 6174 6827 2c20  ('remove_path', 
+00010760: 272f 7061 7468 2f32 272c 2054 7275 6529  '/path/2', True)
+00010770: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+00010780: 2020 6465 6620 7465 7374 5f63 616e 5f63    def test_can_c
+00010790: 6f6e 6e65 6374 5f73 696d 706c 6528 7365  onnect_simple(se
+000107a0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000107b0: 662e 7065 6262 6c65 2e72 6573 706f 6e73  f.pebble.respons
+000107c0: 6573 2e61 7070 656e 6428 7065 6262 6c65  es.append(pebble
+000107d0: 2e53 7973 7465 6d49 6e66 6f2e 6672 6f6d  .SystemInfo.from
+000107e0: 5f64 6963 7428 7b27 7665 7273 696f 6e27  _dict({'version'
+000107f0: 3a20 2731 2e30 2e30 277d 2929 0a20 2020  : '1.0.0'})).   
+00010800: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010810: 5472 7565 2873 656c 662e 636f 6e74 6169  True(self.contai
+00010820: 6e65 722e 6361 6e5f 636f 6e6e 6563 7428  ner.can_connect(
+00010830: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+00010840: 5f63 616e 5f63 6f6e 6e65 6374 5f63 6f6e  _can_connect_con
+00010850: 6e65 6374 696f 6e5f 6572 726f 7228 7365  nection_error(se
+00010860: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
+00010870: 2072 6169 7365 5f65 7272 6f72 2829 3a0a   raise_error():.
+00010880: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00010890: 6520 7065 6262 6c65 2e43 6f6e 6e65 6374  e pebble.Connect
+000108a0: 696f 6e45 7272 6f72 2827 636f 6e6e 6563  ionError('connec
+000108b0: 7469 6f6e 2065 7272 6f72 2127 290a 2020  tion error!').  
+000108c0: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
+000108d0: 652e 6765 745f 7379 7374 656d 5f69 6e66  e.get_system_inf
+000108e0: 6f20 3d20 7261 6973 655f 6572 726f 720a  o = raise_error.
+000108f0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00010900: 662e 6173 7365 7274 4c6f 6773 2827 6f70  f.assertLogs('op
+00010910: 7327 2c20 6c65 7665 6c3d 2744 4542 5547  s', level='DEBUG
+00010920: 2729 2061 7320 636d 3a0a 2020 2020 2020  ') as cm:.      
+00010930: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010940: 7446 616c 7365 2873 656c 662e 636f 6e74  tFalse(self.cont
+00010950: 6169 6e65 722e 6361 6e5f 636f 6e6e 6563  ainer.can_connec
+00010960: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
+00010970: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00010980: 6e28 636d 2e6f 7574 7075 7429 2c20 3129  n(cm.output), 1)
+00010990: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000109a0: 7365 7274 5265 6765 7828 636d 2e6f 7574  sertRegex(cm.out
+000109b0: 7075 745b 305d 2c20 7227 4445 4255 473a  put[0], r'DEBUG:
+000109c0: 6f70 732e 6d6f 6465 6c3a 2e2a 3a20 636f  ops.model:.*: co
+000109d0: 6e6e 6563 7469 6f6e 2065 7272 6f72 2127  nnection error!'
+000109e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000109f0: 6361 6e5f 636f 6e6e 6563 745f 6669 6c65  can_connect_file
+00010a00: 5f6e 6f74 5f66 6f75 6e64 5f65 7272 6f72  _not_found_error
+00010a10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00010a20: 6465 6620 7261 6973 655f 6572 726f 7228  def raise_error(
+00010a30: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00010a40: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
+00010a50: 6445 7272 6f72 2827 6669 6c65 206e 6f74  dError('file not
+00010a60: 2066 6f75 6e64 2127 290a 2020 2020 2020   found!').      
+00010a70: 2020 7365 6c66 2e70 6562 626c 652e 6765    self.pebble.ge
+00010a80: 745f 7379 7374 656d 5f69 6e66 6f20 3d20  t_system_info = 
+00010a90: 7261 6973 655f 6572 726f 720a 2020 2020  raise_error.    
+00010aa0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00010ab0: 7365 7274 4c6f 6773 2827 6f70 7327 2c20  sertLogs('ops', 
+00010ac0: 6c65 7665 6c3d 2744 4542 5547 2729 2061  level='DEBUG') a
+00010ad0: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00010ae0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00010af0: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
+00010b00: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
+00010b10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010b20: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
+00010b30: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
+00010b40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010b50: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
+00010b60: 305d 2c20 7227 4445 4255 473a 6f70 732e  0], r'DEBUG:ops.
+00010b70: 6d6f 6465 6c3a 2e2a 3a20 6669 6c65 206e  model:.*: file n
+00010b80: 6f74 2066 6f75 6e64 2127 290a 0a20 2020  ot found!')..   
+00010b90: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
+00010ba0: 6e6e 6563 745f 6170 695f 6572 726f 7228  nnect_api_error(
+00010bb0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00010bc0: 6566 2072 6169 7365 5f65 7272 6f72 2829  ef raise_error()
+00010bd0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00010be0: 6973 6520 7065 6262 6c65 2e41 5049 4572  ise pebble.APIEr
+00010bf0: 726f 7228 2762 6f64 7927 2c20 3430 342c  ror('body', 404,
+00010c00: 2027 7374 6174 7573 272c 2027 6170 6920   'status', 'api 
+00010c10: 6572 726f 7221 2729 0a20 2020 2020 2020  error!').       
+00010c20: 2073 656c 662e 7065 6262 6c65 2e67 6574   self.pebble.get
+00010c30: 5f73 7973 7465 6d5f 696e 666f 203d 2072  _system_info = r
+00010c40: 6169 7365 5f65 7272 6f72 0a20 2020 2020  aise_error.     
+00010c50: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00010c60: 6572 744c 6f67 7328 276f 7073 2729 2061  ertLogs('ops') a
+00010c70: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00010c80: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00010c90: 7365 2873 656c 662e 636f 6e74 6169 6e65  se(self.containe
+00010ca0: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
+00010cb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010cc0: 7365 7274 4571 7561 6c28 6c65 6e28 636d  sertEqual(len(cm
+00010cd0: 2e6f 7574 7075 7429 2c20 3129 0a20 2020  .output), 1).   
+00010ce0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010cf0: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
+00010d00: 305d 2c20 7227 5741 524e 494e 473a 6f70  0], r'WARNING:op
+00010d10: 732e 6d6f 6465 6c3a 2e2a 3a20 6170 6920  s.model:.*: api 
+00010d20: 6572 726f 7221 2729 0a0a 2020 2020 4070  error!')..    @p
+00010d30: 6174 6368 2827 6d6f 6465 6c2e 4a75 6a75  atch('model.Juju
+00010d40: 5665 7273 696f 6e2e 6672 6f6d 5f65 6e76  Version.from_env
+00010d50: 6972 6f6e 272c 206e 6577 3d6c 616d 6264  iron', new=lambd
+00010d60: 613a 206f 7073 2e6d 6f64 656c 2e4a 756a  a: ops.model.Juj
+00010d70: 7556 6572 7369 6f6e 2827 332e 312e 3627  uVersion('3.1.6'
+00010d80: 2929 0a20 2020 2064 6566 2074 6573 745f  )).    def test_
+00010d90: 6578 6563 2873 656c 6629 3a0a 2020 2020  exec(self):.    
+00010da0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+00010db0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+00010dc0: 2827 6661 6b65 5f65 7865 635f 7072 6f63  ('fake_exec_proc
+00010dd0: 6573 7327 290a 2020 2020 2020 2020 7020  ess').        p 
+00010de0: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
+00010df0: 2e65 7865 6328 0a20 2020 2020 2020 2020  .exec(.         
+00010e00: 2020 205b 2765 6368 6f27 2c20 2766 6f6f     ['echo', 'foo
+00010e10: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00010e20: 7365 7276 6963 655f 636f 6e74 6578 743d  service_context=
+00010e30: 2773 7276 3127 2c0a 2020 2020 2020 2020  'srv1',.        
+00010e40: 2020 2020 656e 7669 726f 6e6d 656e 743d      environment=
+00010e50: 7b27 4b31 273a 2027 5631 272c 2027 4b32  {'K1': 'V1', 'K2
+00010e60: 273a 2027 5632 277d 2c0a 2020 2020 2020  ': 'V2'},.      
+00010e70: 2020 2020 2020 776f 726b 696e 675f 6469        working_di
+00010e80: 723d 2757 4427 2c0a 2020 2020 2020 2020  r='WD',.        
+00010e90: 2020 2020 7469 6d65 6f75 743d 3130 2e35      timeout=10.5
+00010ea0: 2c0a 2020 2020 2020 2020 2020 2020 7573  ,.            us
+00010eb0: 6572 5f69 643d 3130 3030 2c0a 2020 2020  er_id=1000,.    
+00010ec0: 2020 2020 2020 2020 7573 6572 3d27 626f          user='bo
+00010ed0: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00010ee0: 6772 6f75 705f 6964 3d31 3030 302c 0a20  group_id=1000,. 
+00010ef0: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00010f00: 3d27 7374 6166 6627 2c0a 2020 2020 2020  ='staff',.      
+00010f10: 2020 2020 2020 7374 6469 6e3d 2753 5444        stdin='STD
+00010f20: 494e 272c 0a20 2020 2020 2020 2020 2020  IN',.           
+00010f30: 2073 7464 6f75 743d 2753 5444 4f55 5427   stdout='STDOUT'
+00010f40: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00010f50: 6465 7272 3d27 5354 4445 5252 272c 0a20  derr='STDERR',. 
+00010f60: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+00010f70: 696e 673d 4e6f 6e65 2c0a 2020 2020 2020  ing=None,.      
+00010f80: 2020 2020 2020 636f 6d62 696e 655f 7374        combine_st
+00010f90: 6465 7272 3d54 7275 652c 0a20 2020 2020  derr=True,.     
+00010fa0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00010fb0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+00010fc0: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+00010fd0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+00010fe0: 2020 2827 6578 6563 272c 205b 2765 6368    ('exec', ['ech
+00010ff0: 6f27 2c20 2766 6f6f 275d 2c20 6469 6374  o', 'foo'], dict
+00011000: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011010: 2020 7365 7276 6963 655f 636f 6e74 6578    service_contex
+00011020: 743d 2773 7276 3127 2c0a 2020 2020 2020  t='srv1',.      
+00011030: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
+00011040: 6e6d 656e 743d 7b27 4b31 273a 2027 5631  nment={'K1': 'V1
+00011050: 272c 2027 4b32 273a 2027 5632 277d 2c0a  ', 'K2': 'V2'},.
+00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011070: 776f 726b 696e 675f 6469 723d 2757 4427  working_dir='WD'
+00011080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011090: 2020 7469 6d65 6f75 743d 3130 2e35 2c0a    timeout=10.5,.
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 7573 6572 5f69 643d 3130 3030 2c0a 2020  user_id=1000,.  
+000110c0: 2020 2020 2020 2020 2020 2020 2020 7573                us
+000110d0: 6572 3d27 626f 6227 2c0a 2020 2020 2020  er='bob',.      
+000110e0: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+000110f0: 6964 3d31 3030 302c 0a20 2020 2020 2020  id=1000,.       
+00011100: 2020 2020 2020 2020 2067 726f 7570 3d27           group='
+00011110: 7374 6166 6627 2c0a 2020 2020 2020 2020  staff',.        
+00011120: 2020 2020 2020 2020 7374 6469 6e3d 2753          stdin='S
+00011130: 5444 494e 272c 0a20 2020 2020 2020 2020  TDIN',.         
+00011140: 2020 2020 2020 2073 7464 6f75 743d 2753         stdout='S
+00011150: 5444 4f55 5427 2c0a 2020 2020 2020 2020  TDOUT',.        
+00011160: 2020 2020 2020 2020 7374 6465 7272 3d27          stderr='
+00011170: 5354 4445 5252 272c 0a20 2020 2020 2020  STDERR',.       
+00011180: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
+00011190: 673d 4e6f 6e65 2c0a 2020 2020 2020 2020  g=None,.        
+000111a0: 2020 2020 2020 2020 636f 6d62 696e 655f          combine_
+000111b0: 7374 6465 7272 3d54 7275 652c 0a20 2020  stderr=True,.   
+000111c0: 2020 2020 2020 2020 2029 290a 2020 2020           )).    
+000111d0: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
+000111e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000111f0: 702c 2027 6661 6b65 5f65 7865 635f 7072  p, 'fake_exec_pr
+00011200: 6f63 6573 7327 290a 0a20 2020 2040 7061  ocess')..    @pa
+00011210: 7463 6828 276d 6f64 656c 2e4a 756a 7556  tch('model.JujuV
+00011220: 6572 7369 6f6e 2e66 726f 6d5f 656e 7669  ersion.from_envi
+00011230: 726f 6e27 2c20 6e65 773d 6c61 6d62 6461  ron', new=lambda
+00011240: 3a20 6f70 732e 6d6f 6465 6c2e 4a75 6a75  : ops.model.Juju
+00011250: 5665 7273 696f 6e28 2733 2e31 2e35 2729  Version('3.1.5')
+00011260: 290a 2020 2020 6465 6620 7465 7374 5f65  ).    def test_e
+00011270: 7865 635f 7365 7276 6963 655f 636f 6e74  xec_service_cont
+00011280: 6578 745f 6e6f 745f 7375 7070 6f72 7465  ext_not_supporte
+00011290: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+000112a0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000112b0: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
+000112c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000112d0: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
+000112e0: 722e 6578 6563 285b 2766 6f6f 275d 2c20  r.exec(['foo'], 
+000112f0: 7365 7276 6963 655f 636f 6e74 6578 743d  service_context=
+00011300: 2773 7276 3127 290a 0a20 2020 2064 6566  'srv1')..    def
+00011310: 2074 6573 745f 7365 6e64 5f73 6967 6e61   test_send_signa
+00011320: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
+00011330: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00011340: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+00011350: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00011360: 7365 6c66 2e63 6f6e 7461 696e 6572 2e73  self.container.s
+00011370: 656e 645f 7369 676e 616c 2827 5349 4748  end_signal('SIGH
+00011380: 5550 2729 0a0a 2020 2020 2020 2020 7365  UP')..        se
+00011390: 6c66 2e63 6f6e 7461 696e 6572 2e73 656e  lf.container.sen
+000113a0: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
+000113b0: 272c 2027 7331 2729 0a20 2020 2020 2020  ', 's1').       
+000113c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000113d0: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
+000113e0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+000113f0: 2020 2020 2020 2827 7365 6e64 5f73 6967        ('send_sig
+00011400: 6e61 6c27 2c20 2753 4947 4855 5027 2c20  nal', 'SIGHUP', 
+00011410: 2827 7331 272c 2929 2c0a 2020 2020 2020  ('s1',)),.      
+00011420: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
+00011430: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+00011440: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+00011450: 7365 6c66 2e63 6f6e 7461 696e 6572 2e73  self.container.s
+00011460: 656e 645f 7369 676e 616c 2827 5349 4748  end_signal('SIGH
+00011470: 5550 272c 2027 7331 272c 2027 7332 2729  UP', 's1', 's2')
+00011480: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00011490: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+000114a0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+000114b0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+000114c0: 7365 6e64 5f73 6967 6e61 6c27 2c20 2753  send_signal', 'S
+000114d0: 4947 4855 5027 2c20 2827 7331 272c 2027  IGHUP', ('s1', '
+000114e0: 7332 2729 292c 0a20 2020 2020 2020 205d  s2')),.        ]
+000114f0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00011500: 6562 626c 652e 7265 7175 6573 7473 203d  ebble.requests =
+00011510: 205b 5d0a 0a0a 636c 6173 7320 4d6f 636b   []...class Mock
+00011520: 5065 6262 6c65 4261 636b 656e 6428 5f4d  PebbleBackend(_M
+00011530: 6f64 656c 4261 636b 656e 6429 3a0a 2020  odelBackend):.  
+00011540: 2020 6465 6620 6765 745f 7065 6262 6c65    def get_pebble
+00011550: 2873 656c 662c 2073 6f63 6b65 745f 7061  (self, socket_pa
+00011560: 7468 293a 0a20 2020 2020 2020 2072 6574  th):.        ret
+00011570: 7572 6e20 4d6f 636b 5065 6262 6c65 436c  urn MockPebbleCl
+00011580: 6965 6e74 2873 6f63 6b65 745f 7061 7468  ient(socket_path
+00011590: 290a 0a0a 636c 6173 7320 4d6f 636b 5065  )...class MockPe
+000115a0: 6262 6c65 436c 6965 6e74 3a0a 2020 2020  bbleClient:.    
+000115b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000115c0: 662c 2073 6f63 6b65 745f 7061 7468 293a  f, socket_path):
+000115d0: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+000115e0: 636b 6574 5f70 6174 6820 3d20 736f 636b  cket_path = sock
+000115f0: 6574 5f70 6174 680a 2020 2020 2020 2020  et_path.        
+00011600: 7365 6c66 2e72 6571 7565 7374 7320 3d20  self.requests = 
+00011610: 5b5d 0a20 2020 2020 2020 2073 656c 662e  [].        self.
+00011620: 7265 7370 6f6e 7365 7320 3d20 5b5d 0a0a  responses = []..
+00011630: 2020 2020 6465 6620 6175 746f 7374 6172      def autostar
+00011640: 745f 7365 7276 6963 6573 2873 656c 6629  t_services(self)
+00011650: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
+00011660: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
+00011670: 2761 7574 6f73 7461 7274 272c 2929 0a0a  'autostart',))..
+00011680: 2020 2020 6465 6620 6765 745f 7379 7374      def get_syst
+00011690: 656d 5f69 6e66 6f28 7365 6c66 293a 0a20  em_info(self):. 
+000116a0: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
+000116b0: 6573 7473 2e61 7070 656e 6428 2827 6765  ests.append(('ge
+000116c0: 745f 7379 7374 656d 5f69 6e66 6f27 2c29  t_system_info',)
+000116d0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000116e0: 2073 656c 662e 7265 7370 6f6e 7365 732e   self.responses.
+000116f0: 706f 7028 3029 0a0a 2020 2020 6465 6620  pop(0)..    def 
+00011700: 7265 706c 616e 5f73 6572 7669 6365 7328  replan_services(
+00011710: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00011720: 656c 662e 7265 7175 6573 7473 2e61 7070  elf.requests.app
+00011730: 656e 6428 2827 7265 706c 616e 272c 2929  end(('replan',))
+00011740: 0a0a 2020 2020 6465 6620 7374 6172 745f  ..    def start_
+00011750: 7365 7276 6963 6573 2873 656c 662c 2073  services(self, s
+00011760: 6572 7669 6365 5f6e 616d 6573 293a 0a20  ervice_names):. 
+00011770: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
+00011780: 6573 7473 2e61 7070 656e 6428 2827 7374  ests.append(('st
+00011790: 6172 7427 2c20 7365 7276 6963 655f 6e61  art', service_na
+000117a0: 6d65 7329 290a 0a20 2020 2064 6566 2073  mes))..    def s
+000117b0: 746f 705f 7365 7276 6963 6573 2873 656c  top_services(sel
+000117c0: 662c 2073 6572 7669 6365 5f6e 616d 6573  f, service_names
+000117d0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+000117e0: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+000117f0: 2827 7374 6f70 272c 2073 6572 7669 6365  ('stop', service
+00011800: 5f6e 616d 6573 2929 0a0a 2020 2020 6465  _names))..    de
+00011810: 6620 7265 7374 6172 745f 7365 7276 6963  f restart_servic
+00011820: 6573 2873 656c 662c 2073 6572 7669 6365  es(self, service
+00011830: 5f6e 616d 6573 293a 0a20 2020 2020 2020  _names):.       
+00011840: 2073 656c 662e 7265 7175 6573 7473 2e61   self.requests.a
+00011850: 7070 656e 6428 2827 7265 7374 6172 7427  ppend(('restart'
+00011860: 2c20 7365 7276 6963 655f 6e61 6d65 7329  , service_names)
+00011870: 290a 0a20 2020 2064 6566 2061 6464 5f6c  )..    def add_l
+00011880: 6179 6572 2873 656c 662c 206c 6162 656c  ayer(self, label
+00011890: 2c20 6c61 7965 722c 2063 6f6d 6269 6e65  , layer, combine
+000118a0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+000118b0: 2069 6620 6973 696e 7374 616e 6365 286c   if isinstance(l
+000118c0: 6179 6572 2c20 6469 6374 293a 0a20 2020  ayer, dict):.   
+000118d0: 2020 2020 2020 2020 206c 6179 6572 203d           layer =
+000118e0: 2070 6562 626c 652e 4c61 7965 7228 6c61   pebble.Layer(la
+000118f0: 7965 7229 2e74 6f5f 7961 6d6c 2829 0a20  yer).to_yaml(). 
+00011900: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+00011910: 7374 616e 6365 286c 6179 6572 2c20 7065  stance(layer, pe
+00011920: 6262 6c65 2e4c 6179 6572 293a 0a20 2020  bble.Layer):.   
+00011930: 2020 2020 2020 2020 206c 6179 6572 203d           layer =
+00011940: 206c 6179 6572 2e74 6f5f 7961 6d6c 2829   layer.to_yaml()
+00011950: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00011960: 7175 6573 7473 2e61 7070 656e 6428 2827  quests.append(('
+00011970: 6164 645f 6c61 7965 7227 2c20 6c61 6265  add_layer', labe
+00011980: 6c2c 206c 6179 6572 2c20 636f 6d62 696e  l, layer, combin
+00011990: 6529 290a 0a20 2020 2064 6566 2067 6574  e))..    def get
+000119a0: 5f70 6c61 6e28 7365 6c66 293a 0a20 2020  _plan(self):.   
+000119b0: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+000119c0: 7473 2e61 7070 656e 6428 2827 6765 745f  ts.append(('get_
+000119d0: 706c 616e 272c 2929 0a20 2020 2020 2020  plan',)).       
+000119e0: 2072 6574 7572 6e20 7365 6c66 2e72 6573   return self.res
+000119f0: 706f 6e73 6573 2e70 6f70 2830 290a 0a20  ponses.pop(0).. 
+00011a00: 2020 2064 6566 2067 6574 5f73 6572 7669     def get_servi
+00011a10: 6365 7328 7365 6c66 2c20 6e61 6d65 733d  ces(self, names=
+00011a20: 4e6f 6e65 293a 0a20 2020 2020 2020 2073  None):.        s
+00011a30: 656c 662e 7265 7175 6573 7473 2e61 7070  elf.requests.app
+00011a40: 656e 6428 2827 6765 745f 7365 7276 6963  end(('get_servic
+00011a50: 6573 272c 206e 616d 6573 2929 0a20 2020  es', names)).   
+00011a60: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00011a70: 2e72 6573 706f 6e73 6573 2e70 6f70 2830  .responses.pop(0
+00011a80: 290a 0a20 2020 2064 6566 2067 6574 5f63  )..    def get_c
+00011a90: 6865 636b 7328 7365 6c66 2c20 6c65 7665  hecks(self, leve
+00011aa0: 6c3d 4e6f 6e65 2c20 6e61 6d65 733d 4e6f  l=None, names=No
+00011ab0: 6e65 293a 0a20 2020 2020 2020 2073 656c  ne):.        sel
+00011ac0: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
+00011ad0: 6428 2827 6765 745f 6368 6563 6b73 272c  d(('get_checks',
+00011ae0: 206c 6576 656c 2c20 6e61 6d65 7329 290a   level, names)).
+00011af0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00011b00: 656c 662e 7265 7370 6f6e 7365 732e 706f  elf.responses.po
+00011b10: 7028 3029 0a0a 2020 2020 6465 6620 7075  p(0)..    def pu
+00011b20: 6c6c 2873 656c 662c 2070 6174 682c 202a  ll(self, path, *
+00011b30: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+00011b40: 3827 293a 0a20 2020 2020 2020 2073 656c  8'):.        sel
+00011b50: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
+00011b60: 6428 2827 7075 6c6c 272c 2070 6174 682c  d(('pull', path,
+00011b70: 2065 6e63 6f64 696e 6729 290a 2020 2020   encoding)).    
+00011b80: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00011b90: 7265 7370 6f6e 7365 732e 706f 7028 3029  responses.pop(0)
+00011ba0: 0a0a 2020 2020 6465 6620 7075 7368 2873  ..    def push(s
+00011bb0: 656c 662c 2070 6174 682c 2073 6f75 7263  elf, path, sourc
+00011bc0: 652c 202a 2c20 656e 636f 6469 6e67 3d27  e, *, encoding='
+00011bd0: 7574 662d 3827 2c20 6d61 6b65 5f64 6972  utf-8', make_dir
+00011be0: 733d 4661 6c73 652c 2070 6572 6d69 7373  s=False, permiss
+00011bf0: 696f 6e73 3d4e 6f6e 652c 0a20 2020 2020  ions=None,.     
+00011c00: 2020 2020 2020 2020 7573 6572 5f69 643d          user_id=
+00011c10: 4e6f 6e65 2c20 7573 6572 3d4e 6f6e 652c  None, user=None,
+00011c20: 2067 726f 7570 5f69 643d 4e6f 6e65 2c20   group_id=None, 
+00011c30: 6772 6f75 703d 4e6f 6e65 293a 0a20 2020  group=None):.   
+00011c40: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+00011c50: 7473 2e61 7070 656e 6428 2827 7075 7368  ts.append(('push
+00011c60: 272c 2070 6174 682c 2073 6f75 7263 652c  ', path, source,
+00011c70: 2065 6e63 6f64 696e 672c 206d 616b 655f   encoding, make_
+00011c80: 6469 7273 2c20 7065 726d 6973 7369 6f6e  dirs, permission
+00011c90: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
 00011ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011cb0: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00011cc0: 5f69 642c 2067 726f 7570 2929 0a0a 2020  _id, group))..  
-00011cd0: 2020 6465 6620 7265 6d6f 7665 5f70 6174    def remove_pat
-00011ce0: 6828 7365 6c66 2c20 7061 7468 2c20 2a2c  h(self, path, *,
-00011cf0: 2072 6563 7572 7369 7665 3d46 616c 7365   recursive=False
-00011d00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011d10: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-00011d20: 2827 7265 6d6f 7665 5f70 6174 6827 2c20  ('remove_path', 
-00011d30: 7061 7468 2c20 7265 6375 7273 6976 6529  path, recursive)
-00011d40: 290a 0a20 2020 2064 6566 2065 7865 6328  )..    def exec(
-00011d50: 7365 6c66 2c20 636f 6d6d 616e 642c 202a  self, command, *
-00011d60: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00011d70: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
-00011d80: 6170 7065 6e64 2828 2765 7865 6327 2c20  append(('exec', 
-00011d90: 636f 6d6d 616e 642c 206b 7761 7267 7329  command, kwargs)
-00011da0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00011db0: 2073 656c 662e 7265 7370 6f6e 7365 732e   self.responses.
-00011dc0: 706f 7028 3029 0a0a 2020 2020 6465 6620  pop(0)..    def 
-00011dd0: 7365 6e64 5f73 6967 6e61 6c28 7365 6c66  send_signal(self
-00011de0: 2c20 7369 676e 616c 2c20 7365 7276 6963  , signal, servic
-00011df0: 655f 6e61 6d65 7329 3a0a 2020 2020 2020  e_names):.      
-00011e00: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
-00011e10: 6170 7065 6e64 2828 2773 656e 645f 7369  append(('send_si
-00011e20: 676e 616c 272c 2073 6967 6e61 6c2c 2073  gnal', signal, s
-00011e30: 6572 7669 6365 5f6e 616d 6573 2929 0a0a  ervice_names))..
-00011e40: 0a63 6c61 7373 2054 6573 744d 6f64 656c  .class TestModel
-00011e50: 4269 6e64 696e 6773 2875 6e69 7474 6573  Bindings(unittes
-00011e60: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
-00011e70: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-00011e80: 293a 0a20 2020 2020 2020 206d 6574 6120  ):.        meta 
-00011e90: 3d20 6f70 732e 4368 6172 6d4d 6574 6128  = ops.CharmMeta(
-00011ea0: 290a 2020 2020 2020 2020 6d65 7461 2e72  ).        meta.r
-00011eb0: 656c 6174 696f 6e73 203d 207b 0a20 2020  elations = {.   
-00011ec0: 2020 2020 2020 2020 2027 6462 3027 3a20           'db0': 
-00011ed0: 6f70 732e 5265 6c61 7469 6f6e 4d65 7461  ops.RelationMeta
-00011ee0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011ef0: 2020 6f70 732e 5265 6c61 7469 6f6e 526f    ops.RelationRo
-00011f00: 6c65 2e70 726f 7669 6465 732c 2027 6462  le.provides, 'db
-00011f10: 3027 2c20 7b27 696e 7465 7266 6163 6527  0', {'interface'
-00011f20: 3a20 2764 6230 272c 2027 7363 6f70 6527  : 'db0', 'scope'
-00011f30: 3a20 2767 6c6f 6261 6c27 7d29 2c0a 2020  : 'global'}),.  
-00011f40: 2020 2020 2020 2020 2020 2764 6231 273a            'db1':
-00011f50: 206f 7073 2e52 656c 6174 696f 6e4d 6574   ops.RelationMet
-00011f60: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-00011f70: 2020 206f 7073 2e52 656c 6174 696f 6e52     ops.RelationR
-00011f80: 6f6c 652e 7265 7175 6972 6573 2c20 2764  ole.requires, 'd
-00011f90: 6231 272c 207b 2769 6e74 6572 6661 6365  b1', {'interface
-00011fa0: 273a 2027 6462 3127 2c20 2773 636f 7065  ': 'db1', 'scope
-00011fb0: 273a 2027 676c 6f62 616c 277d 292c 0a20  ': 'global'}),. 
-00011fc0: 2020 2020 2020 2020 2020 2027 6462 3227             'db2'
-00011fd0: 3a20 6f70 732e 5265 6c61 7469 6f6e 4d65  : ops.RelationMe
-00011fe0: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
-00011ff0: 2020 2020 6f70 732e 5265 6c61 7469 6f6e      ops.Relation
-00012000: 526f 6c65 2e70 6565 722c 2027 6462 3227  Role.peer, 'db2'
-00012010: 2c20 7b27 696e 7465 7266 6163 6527 3a20  , {'interface': 
-00012020: 2764 6232 272c 2027 7363 6f70 6527 3a20  'db2', 'scope': 
-00012030: 2767 6c6f 6261 6c27 7d29 2c0a 2020 2020  'global'}),.    
-00012040: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-00012050: 6c66 2e62 6163 6b65 6e64 203d 205f 4d6f  lf.backend = _Mo
-00012060: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
-00012070: 702f 3027 290a 2020 2020 2020 2020 7365  p/0').        se
-00012080: 6c66 2e6d 6f64 656c 203d 206f 7073 2e4d  lf.model = ops.M
-00012090: 6f64 656c 286d 6574 612c 2073 656c 662e  odel(meta, self.
-000120a0: 6261 636b 656e 6429 0a0a 2020 2020 2020  backend)..      
-000120b0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-000120c0: 6c66 2c20 2772 656c 6174 696f 6e2d 6964  lf, 'relation-id
-000120d0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000120e0: 2020 2020 2020 2020 2222 2228 5b20 2224          """([ "$
-000120f0: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00012100: 686f 2027 5b22 6462 303a 3422 5d27 2920  ho '["db0:4"]') 
-00012110: 7c7c 2065 6368 6f20 275b 5d27 2222 2229  || echo '[]'""")
-00012120: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00012130: 7269 7074 2873 656c 662c 2027 7265 6c61  ript(self, 'rela
-00012140: 7469 6f6e 2d6c 6973 7427 2c20 2222 225b  tion-list', """[
-00012150: 2022 2432 2220 3d20 3420 5d20 2626 2065   "$2" = 4 ] && e
-00012160: 6368 6f20 275b 2272 656d 6f74 6561 7070  cho '["remoteapp
-00012170: 312f 3022 5d27 207c 7c20 6578 6974 2032  1/0"]' || exit 2
-00012180: 2222 2229 0a20 2020 2020 2020 2073 656c  """).        sel
-00012190: 662e 6e65 7477 6f72 6b5f 6765 745f 6f75  f.network_get_ou
-000121a0: 7420 3d20 2727 277b 0a20 2022 6269 6e64  t = '''{.  "bind
-000121b0: 2d61 6464 7265 7373 6573 223a 205b 0a20  -addresses": [. 
-000121c0: 2020 207b 0a20 2020 2020 2022 6d61 632d     {.      "mac-
-000121d0: 6164 6472 6573 7322 3a20 2264 653a 6164  address": "de:ad
-000121e0: 3a62 653a 6566 3a63 613a 6665 222c 0a20  :be:ef:ca:fe",. 
-000121f0: 2020 2020 2022 696e 7465 7266 6163 652d       "interface-
-00012200: 6e61 6d65 223a 2022 6c6f 222c 0a20 2020  name": "lo",.   
-00012210: 2020 2022 6164 6472 6573 7365 7322 3a20     "addresses": 
-00012220: 5b0a 2020 2020 2020 2020 7b0a 2020 2020  [.        {.    
-00012230: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
-00012240: 3a20 2222 2c0a 2020 2020 2020 2020 2020  : "",.          
-00012250: 2276 616c 7565 223a 2022 3139 322e 302e  "value": "192.0.
-00012260: 322e 3222 2c0a 2020 2020 2020 2020 2020  2.2",.          
-00012270: 2263 6964 7222 3a20 2231 3932 2e30 2e32  "cidr": "192.0.2
-00012280: 2e30 2f32 3422 0a20 2020 2020 2020 207d  .0/24".        }
-00012290: 2c0a 2020 2020 2020 2020 7b0a 2020 2020  ,.        {.    
-000122a0: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
-000122b0: 3a20 2264 6561 6462 6565 662e 6578 616d  : "deadbeef.exam
-000122c0: 706c 6522 2c0a 2020 2020 2020 2020 2020  ple",.          
-000122d0: 2276 616c 7565 223a 2022 6465 6164 3a62  "value": "dead:b
-000122e0: 6565 663a 3a31 222c 0a20 2020 2020 2020  eef::1",.       
-000122f0: 2020 2022 6369 6472 223a 2022 6465 6164     "cidr": "dead
-00012300: 3a62 6565 663a 3a2f 3634 220a 2020 2020  :beef::/64".    
-00012310: 2020 2020 7d0a 2020 2020 2020 5d0a 2020      }.      ].  
-00012320: 2020 7d2c 0a20 2020 207b 0a20 2020 2020    },.    {.     
-00012330: 2022 6d61 632d 6164 6472 6573 7322 3a20   "mac-address": 
-00012340: 2222 2c0a 2020 2020 2020 2269 6e74 6572  "",.      "inter
-00012350: 6661 6365 2d6e 616d 6522 3a20 2274 756e  face-name": "tun
-00012360: 222c 0a20 2020 2020 2022 6164 6472 6573  ",.      "addres
-00012370: 7365 7322 3a20 5b0a 2020 2020 2020 2020  ses": [.        
-00012380: 7b0a 2020 2020 2020 2020 2020 2268 6f73  {.          "hos
-00012390: 746e 616d 6522 3a20 2222 2c0a 2020 2020  tname": "",.    
-000123a0: 2020 2020 2020 2276 616c 7565 223a 2022        "value": "
-000123b0: 3139 322e 302e 332e 3322 2c0a 2020 2020  192.0.3.3",.    
-000123c0: 2020 2020 2020 2263 6964 7222 3a20 2222        "cidr": ""
-000123d0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-000123e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000123f0: 2268 6f73 746e 616d 6522 3a20 2222 2c0a  "hostname": "",.
-00012400: 2020 2020 2020 2020 2020 2276 616c 7565            "value
-00012410: 223a 2022 3230 3031 3a64 6238 3a3a 3322  ": "2001:db8::3"
-00012420: 2c0a 2020 2020 2020 2020 2020 2263 6964  ,.          "cid
-00012430: 7222 3a20 2222 0a20 2020 2020 2020 207d  r": "".        }
-00012440: 2c0a 2020 2020 2020 2020 7b0a 2020 2020  ,.        {.    
-00012450: 2020 2020 2020 2268 6f73 746e 616d 6522        "hostname"
-00012460: 3a20 2264 6561 6462 6565 662e 6c6f 6361  : "deadbeef.loca
-00012470: 6c22 2c0a 2020 2020 2020 2020 2020 2276  l",.          "v
-00012480: 616c 7565 223a 2022 6665 3830 3a3a 313a  alue": "fe80::1:
-00012490: 3122 2c0a 2020 2020 2020 2020 2020 2263  1",.          "c
-000124a0: 6964 7222 3a20 2266 6538 303a 3a2f 3634  idr": "fe80::/64
-000124b0: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
-000124c0: 2020 5d0a 2020 2020 7d0a 2020 5d2c 0a20    ].    }.  ],. 
-000124d0: 2022 6567 7265 7373 2d73 7562 6e65 7473   "egress-subnets
-000124e0: 223a 205b 0a20 2020 2022 3139 322e 302e  ": [.    "192.0.
-000124f0: 322e 322f 3332 222c 0a20 2020 2022 3139  2.2/32",.    "19
-00012500: 322e 302e 332e 302f 3234 222c 0a20 2020  2.0.3.0/24",.   
-00012510: 2022 6465 6164 3a62 6565 663a 3a2f 3634   "dead:beef::/64
-00012520: 222c 0a20 2020 2022 3230 3031 3a64 6238  ",.    "2001:db8
-00012530: 3a3a 332f 3132 3822 0a20 205d 2c0a 2020  ::3/128".  ],.  
-00012540: 2269 6e67 7265 7373 2d61 6464 7265 7373  "ingress-address
-00012550: 6573 223a 205b 0a20 2020 2022 3139 322e  es": [.    "192.
-00012560: 302e 322e 3222 2c0a 2020 2020 2231 3932  0.2.2",.    "192
-00012570: 2e30 2e33 2e33 222c 0a20 2020 2022 6465  .0.3.3",.    "de
-00012580: 6164 3a62 6565 663a 3a31 222c 0a20 2020  ad:beef::1",.   
-00012590: 2022 3230 3031 3a64 6238 3a3a 3322 0a20   "2001:db8::3". 
-000125a0: 205d 0a7d 2727 270a 0a20 2020 2064 6566   ].}'''..    def
-000125b0: 205f 6368 6563 6b5f 6269 6e64 696e 675f   _check_binding_
-000125c0: 6461 7461 2873 656c 662c 2062 696e 6469  data(self, bindi
-000125d0: 6e67 5f6e 616d 652c 2062 696e 6469 6e67  ng_name, binding
-000125e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-000125f0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-00012600: 696e 672e 6e61 6d65 2c20 6269 6e64 696e  ing.name, bindin
-00012610: 675f 6e61 6d65 290a 2020 2020 2020 2020  g_name).        
-00012620: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00012630: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
-00012640: 2e62 696e 645f 6164 6472 6573 732c 2069  .bind_address, i
-00012650: 7061 6464 7265 7373 2e69 705f 6164 6472  paddress.ip_addr
-00012660: 6573 7328 2731 3932 2e30 2e32 2e32 2729  ess('192.0.2.2')
-00012670: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00012680: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-00012690: 6e67 2e6e 6574 776f 726b 2e69 6e67 7265  ng.network.ingre
-000126a0: 7373 5f61 6464 7265 7373 2c20 6970 6164  ss_address, ipad
-000126b0: 6472 6573 732e 6970 5f61 6464 7265 7373  dress.ip_address
-000126c0: 2827 3139 322e 302e 322e 3227 2929 0a20  ('192.0.2.2')). 
-000126d0: 2020 2020 2020 2023 202f 3332 2061 6e64         # /32 and
-000126e0: 202f 3132 3820 4349 4452 7320 6172 6520   /128 CIDRs are 
-000126f0: 7661 6c69 6420 6f6e 652d 6164 6472 6573  valid one-addres
-00012700: 7320 6e65 7477 6f72 6b73 2066 6f72 2049  s networks for I
-00012710: 5076 7b34 2c36 7d4e 6574 776f 726b 2074  Pv{4,6}Network t
-00012720: 7970 6573 2072 6573 7065 6374 6976 656c  ypes respectivel
-00012730: 792e 0a20 2020 2020 2020 2073 656c 662e  y..        self.
-00012740: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-00012750: 696e 672e 6e65 7477 6f72 6b2e 6567 7265  ing.network.egre
-00012760: 7373 5f73 7562 6e65 7473 2c20 5b69 7061  ss_subnets, [ipa
-00012770: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
-00012780: 6b28 2731 3932 2e30 2e32 2e32 2f33 3227  k('192.0.2.2/32'
-00012790: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 2020 2020 2020 2020 2020 2020 2069 7061               ipa
-000127d0: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
-000127e0: 6b28 2731 3932 2e30 2e33 2e30 2f32 3427  k('192.0.3.0/24'
-000127f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012820: 2020 2020 2020 2020 2020 2020 2069 7061               ipa
-00012830: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
-00012840: 6b28 2764 6561 643a 6265 6566 3a3a 2f36  k('dead:beef::/6
-00012850: 3427 292c 0a20 2020 2020 2020 2020 2020  4'),.           
-00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012880: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012890: 7061 6464 7265 7373 2e69 705f 6e65 7477  paddress.ip_netw
-000128a0: 6f72 6b28 2732 3030 313a 6462 383a 3a33  ork('2001:db8::3
-000128b0: 2f31 3238 2729 5d29 0a0a 2020 2020 2020  /128')])..      
-000128c0: 2020 666f 7220 2869 2c20 286e 616d 652c    for (i, (name,
-000128d0: 2061 6464 7265 7373 2c20 7375 626e 6574   address, subnet
-000128e0: 2929 2069 6e20 656e 756d 6572 6174 6528  )) in enumerate(
-000128f0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00012900: 2020 2827 6c6f 272c 2027 3139 322e 302e    ('lo', '192.0.
-00012910: 322e 3227 2c20 2731 3932 2e30 2e32 2e30  2.2', '192.0.2.0
-00012920: 2f32 3427 292c 0a20 2020 2020 2020 2020  /24'),.         
-00012930: 2020 2020 2020 2028 276c 6f27 2c20 2764         ('lo', 'd
-00012940: 6561 643a 6265 6566 3a3a 3127 2c20 2764  ead:beef::1', 'd
-00012950: 6561 643a 6265 6566 3a3a 2f36 3427 292c  ead:beef::/64'),
-00012960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012970: 2028 2774 756e 272c 2027 3139 322e 302e   ('tun', '192.0.
-00012980: 332e 3327 2c20 2731 3932 2e30 2e33 2e33  3.3', '192.0.3.3
-00012990: 2f33 3227 292c 0a20 2020 2020 2020 2020  /32'),.         
-000129a0: 2020 2020 2020 2028 2774 756e 272c 2027         ('tun', '
-000129b0: 3230 3031 3a64 6238 3a3a 3327 2c20 2732  2001:db8::3', '2
-000129c0: 3030 313a 6462 383a 3a33 2f31 3238 2729  001:db8::3/128')
-000129d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000129e0: 2020 2827 7475 6e27 2c20 2766 6538 303a    ('tun', 'fe80:
-000129f0: 3a31 3a31 272c 2027 6665 3830 3a3a 2f36  :1:1', 'fe80::/6
-00012a00: 3427 295d 293a 0a20 2020 2020 2020 2020  4')]):.         
-00012a10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00012a20: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
-00012a30: 6f72 6b2e 696e 7465 7266 6163 6573 5b69  ork.interfaces[i
-00012a40: 5d2e 6e61 6d65 2c20 6e61 6d65 290a 2020  ].name, name).  
-00012a50: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00012a60: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-00012a70: 6e67 2e6e 6574 776f 726b 2e69 6e74 6572  ng.network.inter
-00012a80: 6661 6365 735b 695d 2e61 6464 7265 7373  faces[i].address
-00012a90: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
-00012aa0: 6464 7265 7373 2861 6464 7265 7373 2929  ddress(address))
-00012ab0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012ac0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
-00012ad0: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
-00012ae0: 7465 7266 6163 6573 5b69 5d2e 7375 626e  terfaces[i].subn
-00012af0: 6574 2c20 6970 6164 6472 6573 732e 6970  et, ipaddress.ip
-00012b00: 5f6e 6574 776f 726b 2873 7562 6e65 7429  _network(subnet)
-00012b10: 290a 0a20 2020 2020 2020 2066 6f72 2028  )..        for (
-00012b20: 692c 2028 6e61 6d65 2c20 6164 6472 6573  i, (name, addres
-00012b30: 732c 2073 7562 6e65 7429 2920 696e 2065  s, subnet)) in e
-00012b40: 6e75 6d65 7261 7465 285b 0a20 2020 2020  numerate([.     
-00012b50: 2020 2020 2020 2020 2020 2028 276c 6f27             ('lo'
-00012b60: 2c20 2731 3932 2e30 2e32 2e32 272c 2027  , '192.0.2.2', '
-00012b70: 3139 322e 302e 322e 302f 3234 2729 2c0a  192.0.2.0/24'),.
-00012b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b90: 2827 6c6f 272c 2027 6465 6164 3a62 6565  ('lo', 'dead:bee
-00012ba0: 663a 3a31 272c 2027 6465 6164 3a62 6565  f::1', 'dead:bee
-00012bb0: 663a 3a2f 3634 2729 2c0a 2020 2020 2020  f::/64'),.      
-00012bc0: 2020 2020 2020 2020 2020 2827 7475 6e27            ('tun'
-00012bd0: 2c20 2731 3932 2e30 2e33 2e33 272c 2027  , '192.0.3.3', '
-00012be0: 3139 322e 302e 332e 332f 3332 2729 2c0a  192.0.3.3/32'),.
-00012bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c00: 2827 7475 6e27 2c20 2732 3030 313a 6462  ('tun', '2001:db
-00012c10: 383a 3a33 272c 2027 3230 3031 3a64 6238  8::3', '2001:db8
-00012c20: 3a3a 332f 3132 3827 292c 0a20 2020 2020  ::3/128'),.     
-00012c30: 2020 2020 2020 2020 2020 2028 2774 756e             ('tun
-00012c40: 272c 2027 6665 3830 3a3a 313a 3127 2c20  ', 'fe80::1:1', 
-00012c50: 2766 6538 303a 3a2f 3634 2729 5d29 3a0a  'fe80::/64')]):.
-00012c60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012c70: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
-00012c80: 6469 6e67 2e6e 6574 776f 726b 2e69 6e74  ding.network.int
-00012c90: 6572 6661 6365 735b 695d 2e6e 616d 652c  erfaces[i].name,
-00012ca0: 206e 616d 6529 0a20 2020 2020 2020 2020   name).         
-00012cb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00012cc0: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
-00012cd0: 6f72 6b2e 696e 7465 7266 6163 6573 5b69  ork.interfaces[i
-00012ce0: 5d2e 6164 6472 6573 732c 2069 7061 6464  ].address, ipadd
-00012cf0: 7265 7373 2e69 705f 6164 6472 6573 7328  ress.ip_address(
-00012d00: 6164 6472 6573 7329 290a 2020 2020 2020  address)).      
-00012d10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012d20: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
-00012d30: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
-00012d40: 735b 695d 2e73 7562 6e65 742c 2069 7061  s[i].subnet, ipa
-00012d50: 6464 7265 7373 2e69 705f 6e65 7477 6f72  ddress.ip_networ
-00012d60: 6b28 7375 626e 6574 2929 0a0a 2020 2020  k(subnet))..    
-00012d70: 6465 6620 7465 7374 5f69 6e76 616c 6964  def test_invalid
-00012d80: 5f6b 6579 7328 7365 6c66 293a 0a20 2020  _keys(self):.   
-00012d90: 2020 2020 2023 2042 6173 6963 2076 616c       # Basic val
-00012da0: 6964 6174 696f 6e20 666f 7220 7061 7373  idation for pass
-00012db0: 696e 6720 696e 7661 6c69 6420 6b65 7973  ing invalid keys
-00012dc0: 2e0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
-00012dd0: 6d65 2069 6e20 286f 626a 6563 742c 2030  me in (object, 0
-00012de0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
-00012df0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00012e00: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
-00012e10: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00012e20: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-00012e30: 6c2e 6765 745f 6269 6e64 696e 6728 6e61  l.get_binding(na
-00012e40: 6d65 290a 0a20 2020 2064 6566 2074 6573  me)..    def tes
-00012e50: 745f 6465 6164 5f72 656c 6174 696f 6e73  t_dead_relations
-00012e60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00012e70: 6661 6b65 5f73 6372 6970 7428 0a20 2020  fake_script(.   
-00012e80: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-00012e90: 2020 2020 2020 2020 2020 2027 6e65 7477             'netw
-00012ea0: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
-00012eb0: 2020 2020 2020 6627 2727 0a20 2020 2020        f'''.     
-00012ec0: 2020 2020 2020 2020 2020 2069 6620 5b20             if [ 
-00012ed0: 2224 3122 203d 2064 6230 205d 2026 2620  "$1" = db0 ] && 
-00012ee0: 5b20 2224 3222 203d 202d 2d66 6f72 6d61  [ "$2" = --forma
-00012ef0: 743d 6a73 6f6e 205d 3b20 7468 656e 0a20  t=json ]; then. 
-00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f10: 2020 2065 6368 6f20 277b 7365 6c66 2e6e     echo '{self.n
-00012f20: 6574 776f 726b 5f67 6574 5f6f 7574 7d27  etwork_get_out}'
-00012f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f40: 2065 6c73 650a 2020 2020 2020 2020 2020   else.          
-00012f50: 2020 2020 2020 2020 2020 6563 686f 2045            echo E
-00012f60: 5252 4f52 2069 6e76 616c 6964 2076 616c  RROR invalid val
-00012f70: 7565 2022 2432 2220 666f 7220 6f70 7469  ue "$2" for opti
-00012f80: 6f6e 202d 723a 2072 656c 6174 696f 6e20  on -r: relation 
-00012f90: 6e6f 7420 666f 756e 6420 3e26 320a 2020  not found >&2.  
-00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fb0: 2020 6578 6974 2032 0a20 2020 2020 2020    exit 2.       
-00012fc0: 2020 2020 2020 2020 2066 690a 2020 2020           fi.    
-00012fd0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00012fe0: 2020 2020 2023 2056 616c 6964 6174 6520       # Validate 
-00012ff0: 7468 6520 6265 6861 7669 6f72 2066 6f72  the behavior for
-00013000: 2064 6561 6420 7265 6c61 7469 6f6e 732e   dead relations.
-00013010: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
-00013020: 203d 206f 7073 2e42 696e 6469 6e67 2827   = ops.Binding('
-00013030: 6462 3027 2c20 3432 2c20 7365 6c66 2e6d  db0', 42, self.m
-00013040: 6f64 656c 2e5f 6261 636b 656e 6429 0a20  odel._backend). 
-00013050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00013060: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00013070: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
-00013080: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
-00013090: 6970 5f61 6464 7265 7373 2827 3139 322e  ip_address('192.
-000130a0: 302e 322e 3227 2929 0a20 2020 2020 2020  0.2.2')).       
-000130b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000130c0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-000130d0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-000130e0: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
-000130f0: 2020 2020 205b 276e 6574 776f 726b 2d67       ['network-g
-00013100: 6574 272c 2027 6462 3027 2c20 272d 7227  et', 'db0', '-r'
-00013110: 2c20 2734 3227 2c20 272d 2d66 6f72 6d61  , '42', '--forma
-00013120: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
-00013130: 2020 2020 2020 5b27 6e65 7477 6f72 6b2d        ['network-
-00013140: 6765 7427 2c20 2764 6230 272c 2027 2d2d  get', 'db0', '--
-00013150: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
-00013160: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00013170: 6566 2074 6573 745f 6269 6e64 696e 675f  ef test_binding_
-00013180: 6279 5f72 656c 6174 696f 6e5f 6e61 6d65  by_relation_name
-00013190: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000131a0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000131b0: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
-000131c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000131d0: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
-000131e0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
-000131f0: 277b 7365 6c66 2e6e 6574 776f 726b 5f67  '{self.network_g
-00013200: 6574 5f6f 7574 7d27 207c 7c20 6578 6974  et_out}' || exit
-00013210: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
-00013220: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
-00013230: 6230 270a 2020 2020 2020 2020 6578 7065  b0'.        expe
-00013240: 6374 6564 5f63 616c 6c73 203d 205b 5b27  cted_calls = [['
-00013250: 6e65 7477 6f72 6b2d 6765 7427 2c20 2764  network-get', 'd
-00013260: 6230 272c 2027 2d2d 666f 726d 6174 3d6a  b0', '--format=j
-00013270: 736f 6e27 5d5d 0a0a 2020 2020 2020 2020  son']]..        
-00013280: 6269 6e64 696e 6720 3d20 7365 6c66 2e6d  binding = self.m
-00013290: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
-000132a0: 2862 696e 6469 6e67 5f6e 616d 6529 0a20  (binding_name). 
-000132b0: 2020 2020 2020 2073 656c 662e 5f63 6865         self._che
-000132c0: 636b 5f62 696e 6469 6e67 5f64 6174 6128  ck_binding_data(
-000132d0: 6269 6e64 696e 675f 6e61 6d65 2c20 6269  binding_name, bi
-000132e0: 6e64 696e 6729 0a20 2020 2020 2020 2073  nding).        s
-000132f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00013300: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00013310: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-00013320: 7565 292c 2065 7870 6563 7465 645f 6361  ue), expected_ca
-00013330: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
-00013340: 7374 5f62 696e 6469 6e67 5f62 795f 7265  st_binding_by_re
-00013350: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
-00013360: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00013370: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
-00013380: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
-00013390: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
-000133a0: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
-000133b0: 2065 6368 6f20 277b 7365 6c66 2e6e 6574   echo '{self.net
-000133c0: 776f 726b 5f67 6574 5f6f 7574 7d27 207c  work_get_out}' |
-000133d0: 7c20 6578 6974 2031 2727 2729 0a20 2020  | exit 1''').   
-000133e0: 2020 2020 2062 696e 6469 6e67 5f6e 616d       binding_nam
-000133f0: 6520 3d20 2764 6230 270a 2020 2020 2020  e = 'db0'.      
-00013400: 2020 6578 7065 6374 6564 5f63 616c 6c73    expected_calls
-00013410: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00013420: 205b 2772 656c 6174 696f 6e2d 6964 7327   ['relation-ids'
-00013430: 2c20 2764 6230 272c 2027 2d2d 666f 726d  , 'db0', '--form
-00013440: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-00013450: 2020 2020 2020 2023 2054 6865 2074 776f         # The two
-00013460: 2069 6e76 6f63 6174 696f 6e73 2062 656c   invocations bel
-00013470: 6f77 2061 7265 2064 7565 2074 6f20 7468  ow are due to th
-00013480: 6520 6765 745f 7265 6c61 7469 6f6e 2063  e get_relation c
-00013490: 616c 6c2e 0a20 2020 2020 2020 2020 2020  all..           
-000134a0: 205b 2772 656c 6174 696f 6e2d 6c69 7374   ['relation-list
-000134b0: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
-000134c0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-000134d0: 2020 2020 2020 2020 2020 2020 5b27 6e65              ['ne
-000134e0: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
-000134f0: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
-00013500: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-00013510: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00013520: 2020 6269 6e64 696e 6720 3d20 7365 6c66    binding = self
-00013530: 2e6d 6f64 656c 2e67 6574 5f62 696e 6469  .model.get_bindi
-00013540: 6e67 2873 656c 662e 6d6f 6465 6c2e 6765  ng(self.model.ge
-00013550: 745f 7265 6c61 7469 6f6e 2862 696e 6469  t_relation(bindi
-00013560: 6e67 5f6e 616d 6529 290a 2020 2020 2020  ng_name)).      
-00013570: 2020 7365 6c66 2e5f 6368 6563 6b5f 6269    self._check_bi
-00013580: 6e64 696e 675f 6461 7461 2862 696e 6469  nding_data(bindi
-00013590: 6e67 5f6e 616d 652c 2062 696e 6469 6e67  ng_name, binding
-000135a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000135b0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-000135c0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-000135d0: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-000135e0: 6578 7065 6374 6564 5f63 616c 6c73 290a  expected_calls).
-000135f0: 0a20 2020 2064 6566 2074 6573 745f 6269  .    def test_bi
-00013600: 6e64 696e 675f 6e6f 5f69 6661 6365 5f6e  nding_no_iface_n
-00013610: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
-00013620: 2020 206e 6574 776f 726b 5f67 6574 5f6f     network_get_o
-00013630: 7574 5f6f 626a 203d 207b 0a20 2020 2020  ut_obj = {.     
-00013640: 2020 2020 2020 2027 6269 6e64 2d61 6464         'bind-add
-00013650: 7265 7373 6573 273a 205b 0a20 2020 2020  resses': [.     
-00013660: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013680: 2027 6d61 632d 6164 6472 6573 7327 3a20   'mac-address': 
-00013690: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
-000136a0: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
-000136b0: 6365 2d6e 616d 6527 3a20 2727 2c0a 2020  ce-name': '',.  
-000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136d0: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
-000136e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000136f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00013700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013710: 2020 2020 2020 2027 686f 7374 6e61 6d65         'hostname
-00013720: 273a 2027 272c 0a20 2020 2020 2020 2020  ': '',.         
-00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013740: 2020 2027 7661 6c75 6527 3a20 2731 302e     'value': '10.
-00013750: 312e 3839 2e33 3527 2c0a 2020 2020 2020  1.89.35',.      
-00013760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013770: 2020 2020 2020 2763 6964 7227 3a20 2727        'cidr': ''
-00013780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013790: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000137a0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-000137b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000137c0: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
-000137d0: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
-000137e0: 6772 6573 732d 7375 626e 6574 7327 3a20  gress-subnets': 
-000137f0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00013800: 2020 2731 302e 3135 322e 3138 332e 3135    '10.152.183.15
-00013810: 382f 3332 270a 2020 2020 2020 2020 2020  8/32'.          
-00013820: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-00013830: 2027 696e 6772 6573 732d 6164 6472 6573   'ingress-addres
-00013840: 7365 7327 3a20 5b0a 2020 2020 2020 2020  ses': [.        
-00013850: 2020 2020 2020 2020 2731 302e 3135 322e          '10.152.
-00013860: 3138 332e 3135 3827 0a20 2020 2020 2020  183.158'.       
-00013870: 2020 2020 205d 0a20 2020 2020 2020 207d       ].        }
-00013880: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-00013890: 5f67 6574 5f6f 7574 203d 206a 736f 6e2e  _get_out = json.
-000138a0: 6475 6d70 7328 6e65 7477 6f72 6b5f 6765  dumps(network_ge
-000138b0: 745f 6f75 745f 6f62 6a29 0a20 2020 2020  t_out_obj).     
-000138c0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-000138d0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-000138e0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-000138f0: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00013900: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00013910: 686f 2027 7b6e 6574 776f 726b 5f67 6574  ho '{network_get
-00013920: 5f6f 7574 7d27 207c 7c20 6578 6974 2031  _out}' || exit 1
-00013930: 2727 2729 0a20 2020 2020 2020 2062 696e  ''').        bin
-00013940: 6469 6e67 5f6e 616d 6520 3d20 2764 6230  ding_name = 'db0
-00013950: 270a 2020 2020 2020 2020 6578 7065 6374  '.        expect
-00013960: 6564 5f63 616c 6c73 203d 205b 5b27 6e65  ed_calls = [['ne
-00013970: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
-00013980: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-00013990: 6e27 5d5d 0a0a 2020 2020 2020 2020 6269  n']]..        bi
-000139a0: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
-000139b0: 656c 2e67 6574 5f62 696e 6469 6e67 2862  el.get_binding(b
-000139c0: 696e 6469 6e67 5f6e 616d 6529 0a20 2020  inding_name).   
-000139d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000139e0: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
-000139f0: 6d65 2c20 2764 6230 2729 0a20 2020 2020  me, 'db0').     
-00013a00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013a10: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
-00013a20: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
-00013a30: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
-00013a40: 6464 7265 7373 2827 3130 2e31 2e38 392e  ddress('10.1.89.
-00013a50: 3335 2729 290a 2020 2020 2020 2020 7365  35')).        se
-00013a60: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00013a70: 696e 6469 6e67 2e6e 6574 776f 726b 2e69  inding.network.i
-00013a80: 6e67 7265 7373 5f61 6464 7265 7373 2c20  ngress_address, 
-00013a90: 6970 6164 6472 6573 732e 6970 5f61 6464  ipaddress.ip_add
-00013aa0: 7265 7373 2827 3130 2e31 3532 2e31 3833  ress('10.152.183
-00013ab0: 2e31 3538 2729 290a 2020 2020 2020 2020  .158')).        
-00013ac0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013ad0: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-00013ae0: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-00013af0: 7275 6529 2c20 6578 7065 6374 6564 5f63  rue), expected_c
-00013b00: 616c 6c73 290a 0a20 2020 2064 6566 2074  alls)..    def t
-00013b10: 6573 745f 6d69 7373 696e 675f 6269 6e64  est_missing_bind
-00013b20: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
-00013b30: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
-00013b40: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-00013b50: 6d70 7328 7b7d 290a 2020 2020 2020 2020  mps({}).        
-00013b60: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00013b70: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
-00013b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013b90: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
-00013ba0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
-00013bb0: 277b 6e65 7477 6f72 6b5f 6461 7461 7d27  '{network_data}'
-00013bc0: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
-00013bd0: 2020 2020 2020 2062 696e 6469 6e67 5f6e         binding_n
-00013be0: 616d 6520 3d20 2764 6230 270a 2020 2020  ame = 'db0'.    
-00013bf0: 2020 2020 6269 6e64 696e 6720 3d20 7365      binding = se
-00013c00: 6c66 2e6d 6f64 656c 2e67 6574 5f62 696e  lf.model.get_bin
-00013c10: 6469 6e67 2873 656c 662e 6d6f 6465 6c2e  ding(self.model.
-00013c20: 6765 745f 7265 6c61 7469 6f6e 2862 696e  get_relation(bin
-00013c30: 6469 6e67 5f6e 616d 6529 290a 2020 2020  ding_name)).    
-00013c40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013c50: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
-00013c60: 776f 726b 2e69 6e74 6572 6661 6365 732c  work.interfaces,
-00013c70: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
-00013c80: 7374 5f65 6d70 7479 5f62 696e 645f 6164  st_empty_bind_ad
-00013c90: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
-00013ca0: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
-00013cb0: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00013cc0: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
-00013cd0: 7327 3a20 5b7b 7d5d 7d29 0a20 2020 2020  s': [{}]}).     
-00013ce0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00013cf0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-00013d00: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00013d10: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00013d20: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00013d30: 686f 2027 7b6e 6574 776f 726b 5f64 6174  ho '{network_dat
-00013d40: 617d 2720 7c7c 2065 7869 7420 3127 2727  a}' || exit 1'''
-00013d50: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
-00013d60: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
-00013d70: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
-00013d80: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00013d90: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
-00013da0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-00013db0: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
-00013dc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00013dd0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00013de0: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-00013df0: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
-00013e00: 2074 6573 745f 6e6f 5f62 696e 645f 6164   test_no_bind_ad
-00013e10: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
-00013e20: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
-00013e30: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00013e40: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
-00013e50: 7327 3a20 5b7b 2761 6464 7265 7373 6573  s': [{'addresses
-00013e60: 273a 204e 6f6e 657d 5d7d 290a 2020 2020  ': None}]}).    
-00013e70: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00013e80: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
-00013e90: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-00013ea0: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
-00013eb0: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
-00013ec0: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
-00013ed0: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
-00013ee0: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
-00013ef0: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
-00013f00: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
-00013f10: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00013f20: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
-00013f30: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00013f40: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
-00013f50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013f60: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00013f70: 2e6e 6574 776f 726b 2e69 6e74 6572 6661  .network.interfa
-00013f80: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
-00013f90: 6620 7465 7374 5f65 6d70 7479 5f69 6e74  f test_empty_int
-00013fa0: 6572 6661 6365 5f69 6e66 6f28 7365 6c66  erface_info(self
-00013fb0: 293a 0a20 2020 2020 2020 206e 6574 776f  ):.        netwo
-00013fc0: 726b 5f64 6174 6120 3d20 6a73 6f6e 2e64  rk_data = json.d
-00013fd0: 756d 7073 287b 0a20 2020 2020 2020 2020  umps({.         
-00013fe0: 2020 2027 6269 6e64 2d61 6464 7265 7373     'bind-address
-00013ff0: 6573 273a 205b 7b0a 2020 2020 2020 2020  es': [{.        
-00014000: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
-00014010: 6365 2d6e 616d 6527 3a20 2765 7468 3027  ce-name': 'eth0'
-00014020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014030: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
-00014040: 7b7d 5d2c 0a20 2020 2020 2020 2020 2020  {}],.           
-00014050: 207d 5d2c 0a20 2020 2020 2020 207d 290a   }],.        }).
-00014060: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00014070: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
-00014080: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
-00014090: 2020 2020 2020 2020 2020 2020 2066 2727               f''
-000140a0: 275b 2022 2431 2220 3d20 6462 3020 5d20  '[ "$1" = db0 ] 
-000140b0: 2626 2065 6368 6f20 277b 6e65 7477 6f72  && echo '{networ
-000140c0: 6b5f 6461 7461 7d27 207c 7c20 6578 6974  k_data}' || exit
-000140d0: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
-000140e0: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
-000140f0: 6230 270a 2020 2020 2020 2020 6269 6e64  b0'.        bind
-00014100: 696e 6720 3d20 7365 6c66 2e6d 6f64 656c  ing = self.model
-00014110: 2e67 6574 5f62 696e 6469 6e67 2873 656c  .get_binding(sel
-00014120: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
-00014130: 7469 6f6e 2862 696e 6469 6e67 5f6e 616d  tion(binding_nam
-00014140: 6529 290a 2020 2020 2020 2020 7365 6c66  e)).        self
-00014150: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00014160: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
-00014170: 2e69 6e74 6572 6661 6365 7329 2c20 3129  .interfaces), 1)
-00014180: 0a20 2020 2020 2020 2069 6e74 6572 6661  .        interfa
-00014190: 6365 203d 2062 696e 6469 6e67 2e6e 6574  ce = binding.net
-000141a0: 776f 726b 2e69 6e74 6572 6661 6365 735b  work.interfaces[
-000141b0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-000141c0: 6173 7365 7274 4973 4e6f 6e65 2869 6e74  assertIsNone(int
-000141d0: 6572 6661 6365 2e61 6464 7265 7373 290a  erface.address).
-000141e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000141f0: 6572 7449 734e 6f6e 6528 696e 7465 7266  ertIsNone(interf
-00014200: 6163 652e 7375 626e 6574 290a 0a20 2020  ace.subnet)..   
-00014210: 2064 6566 2074 6573 745f 6d69 7373 696e   def test_missin
-00014220: 675f 696e 6772 6573 735f 6164 6472 6573  g_ingress_addres
-00014230: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
-00014240: 2020 206e 6574 776f 726b 5f64 6174 6120     network_data 
-00014250: 3d20 6a73 6f6e 2e64 756d 7073 287b 0a20  = json.dumps({. 
-00014260: 2020 2020 2020 2020 2020 2027 6269 6e64             'bind
-00014270: 2d61 6464 7265 7373 6573 273a 205b 5d2c  -addresses': [],
-00014280: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00014290: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-000142a0: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
-000142b0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-000142c0: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
-000142d0: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
-000142e0: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
-000142f0: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
-00014300: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
-00014310: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
-00014320: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
-00014330: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00014340: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
-00014350: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00014360: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
-00014370: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014380: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00014390: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
-000143a0: 5f61 6464 7265 7373 6573 2c20 5b5d 290a  _addresses, []).
-000143b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000143c0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-000143d0: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
-000143e0: 5f61 6464 7265 7373 2c20 4e6f 6e65 290a  _address, None).
-000143f0: 0a20 2020 2064 6566 2074 6573 745f 6d69  .    def test_mi
-00014400: 7373 696e 675f 6567 7265 7373 5f73 7562  ssing_egress_sub
-00014410: 6e65 7473 2873 656c 6629 3a0a 2020 2020  nets(self):.    
-00014420: 2020 2020 6e65 7477 6f72 6b5f 6461 7461      network_data
-00014430: 203d 206a 736f 6e2e 6475 6d70 7328 7b0a   = json.dumps({.
-00014440: 2020 2020 2020 2020 2020 2020 2762 696e              'bin
-00014450: 642d 6164 6472 6573 7365 7327 3a20 5b5d  d-addresses': []
-00014460: 2c0a 2020 2020 2020 2020 2020 2020 2769  ,.            'i
-00014470: 6e67 7265 7373 2d61 6464 7265 7373 6573  ngress-addresses
-00014480: 273a 205b 5d2c 0a20 2020 2020 2020 207d  ': [],.        }
-00014490: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-000144a0: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
-000144b0: 776f 726b 2d67 6574 272c 0a20 2020 2020  work-get',.     
-000144c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000144d0: 2727 275b 2022 2431 2220 3d20 6462 3020  '''[ "$1" = db0 
-000144e0: 5d20 2626 2065 6368 6f20 277b 6e65 7477  ] && echo '{netw
-000144f0: 6f72 6b5f 6461 7461 7d27 207c 7c20 6578  ork_data}' || ex
-00014500: 6974 2031 2727 2729 0a20 2020 2020 2020  it 1''').       
-00014510: 2062 696e 6469 6e67 5f6e 616d 6520 3d20   binding_name = 
-00014520: 2764 6230 270a 2020 2020 2020 2020 6269  'db0'.        bi
-00014530: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
-00014540: 656c 2e67 6574 5f62 696e 6469 6e67 2873  el.get_binding(s
-00014550: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-00014560: 6c61 7469 6f6e 2862 696e 6469 6e67 5f6e  lation(binding_n
-00014570: 616d 6529 290a 2020 2020 2020 2020 7365  ame)).        se
-00014580: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00014590: 696e 6469 6e67 2e6e 6574 776f 726b 2e65  inding.network.e
-000145a0: 6772 6573 735f 7375 626e 6574 732c 205b  gress_subnets, [
-000145b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-000145c0: 5f75 6e72 6573 6f6c 7665 645f 696e 6772  _unresolved_ingr
-000145d0: 6573 735f 6164 6472 6573 7365 7328 7365  ess_addresses(se
-000145e0: 6c66 293a 0a20 2020 2020 2020 2023 2073  lf):.        # s
-000145f0: 6f6d 6574 696d 6573 206a 756a 7520 6661  ometimes juju fa
-00014600: 696c 7320 746f 2072 6573 6f6c 7665 2061  ils to resolve a
-00014610: 6e20 7572 6c20 746f 2061 6e20 4950 2c20  n url to an IP, 
-00014620: 696e 2077 6869 6368 2063 6173 650a 2020  in which case.  
-00014630: 2020 2020 2020 2320 696e 6772 6573 732d        # ingress-
-00014640: 6164 6472 6573 7365 7320 7769 6c6c 2062  addresses will b
-00014650: 6520 7468 6520 2772 6177 2720 7572 6c20  e the 'raw' url 
-00014660: 696e 7374 6561 6420 6f66 2061 6e20 4950  instead of an IP
-00014670: 2e0a 2020 2020 2020 2020 6e65 7477 6f72  ..        networ
-00014680: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-00014690: 6d70 7328 7b0a 2020 2020 2020 2020 2020  mps({.          
-000146a0: 2020 2769 6e67 7265 7373 2d61 6464 7265    'ingress-addre
-000146b0: 7373 6573 273a 205b 0a20 2020 2020 2020  sses': [.       
-000146c0: 2020 2020 2020 2020 2027 666f 6f2e 6261           'foo.ba
-000146d0: 722e 6261 7a2e 636f 6d27 0a20 2020 2020  r.baz.com'.     
-000146e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000146f0: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
-00014700: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00014710: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
-00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014730: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
-00014740: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
-00014750: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
-00014760: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
-00014770: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
-00014780: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
-00014790: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
-000147a0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-000147b0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
-000147c0: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
-000147d0: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
-000147e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000147f0: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
-00014800: 6b2e 696e 6772 6573 735f 6164 6472 6573  k.ingress_addres
-00014810: 7365 732c 205b 2766 6f6f 2e62 6172 2e62  ses, ['foo.bar.b
-00014820: 617a 2e63 6f6d 275d 290a 0a0a 636c 6173  az.com'])...clas
-00014830: 7320 5465 7374 4d6f 6465 6c42 6163 6b65  s TestModelBacke
-00014840: 6e64 2875 6e69 7474 6573 742e 5465 7374  nd(unittest.Test
-00014850: 4361 7365 293a 0a0a 2020 2020 6465 6620  Case):..    def 
-00014860: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
-00014870: 2020 2020 2073 656c 662e 5f62 6163 6b65       self._backe
-00014880: 6e64 203d 204e 6f6e 650a 0a20 2020 2040  nd = None..    @
-00014890: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000148a0: 2062 6163 6b65 6e64 2873 656c 6629 3a0a   backend(self):.
-000148b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000148c0: 5f62 6163 6b65 6e64 2069 7320 4e6f 6e65  _backend is None
-000148d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000148e0: 6c66 2e5f 6261 636b 656e 6420 3d20 5f4d  lf._backend = _M
-000148f0: 6f64 656c 4261 636b 656e 6428 276d 7961  odelBackend('mya
-00014900: 7070 2f30 2729 0a20 2020 2020 2020 2072  pp/0').        r
-00014910: 6574 7572 6e20 7365 6c66 2e5f 6261 636b  eturn self._back
-00014920: 656e 640a 0a20 2020 2064 6566 2074 6573  end..    def tes
-00014930: 745f 7265 6c61 7469 6f6e 5f67 6574 5f73  t_relation_get_s
-00014940: 6574 5f69 735f 6170 705f 6172 6728 7365  et_is_app_arg(se
-00014950: 6c66 293a 0a20 2020 2020 2020 2023 204e  lf):.        # N
-00014960: 6f20 6973 5f61 7070 2070 726f 7669 6465  o is_app provide
-00014970: 642e 0a20 2020 2020 2020 2077 6974 6820  d..        with 
-00014980: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00014990: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-000149a0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000149b0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-000149c0: 7365 7428 312c 2027 666f 6f6b 6579 272c  set(1, 'fookey',
-000149d0: 2027 6261 7276 616c 2729 0a0a 2020 2020   'barval')..    
-000149e0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-000149f0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-00014a00: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00014a10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00014a20: 7265 6c61 7469 6f6e 5f67 6574 2831 2c20  relation_get(1, 
-00014a30: 2766 6f6f 656e 7469 7479 2729 0a0a 2020  'fooentity')..  
-00014a40: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
-00014a50: 7479 7065 7320 666f 7220 6973 5f61 7070  types for is_app
-00014a60: 2e0a 2020 2020 2020 2020 666f 7220 6973  ..        for is
-00014a70: 5f61 7070 5f76 2069 6e20 5b4e 6f6e 652c  _app_v in [None,
-00014a80: 2031 2c20 322e 302c 2027 6127 2c20 6227   1, 2.0, 'a', b'
-00014a90: 6265 6566 275d 3a0a 2020 2020 2020 2020  beef']:.        
-00014aa0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00014ab0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-00014ac0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00014ad0: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-00014ae0: 656e 642e 7265 6c61 7469 6f6e 5f73 6574  end.relation_set
-00014af0: 2831 2c20 2766 6f6f 6b65 7927 2c20 2762  (1, 'fookey', 'b
-00014b00: 6172 7661 6c27 2c20 6973 5f61 7070 3d69  arval', is_app=i
-00014b10: 735f 6170 705f 7629 0a0a 2020 2020 2020  s_app_v)..      
-00014b20: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00014b30: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-00014b40: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00014b50: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00014b60: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00014b70: 6574 2831 2c20 2766 6f6f 656e 7469 7479  et(1, 'fooentity
-00014b80: 272c 2069 735f 6170 703d 6973 5f61 7070  ', is_app=is_app
-00014b90: 5f76 290a 0a20 2020 2064 6566 2074 6573  _v)..    def tes
-00014ba0: 745f 6973 5f6c 6561 6465 725f 7265 6672  t_is_leader_refr
-00014bb0: 6573 6828 7365 6c66 293a 0a20 2020 2020  esh(self):.     
-00014bc0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
-00014bd0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
-00014be0: 6c28 2727 270a 2020 2020 2020 2020 2020  l('''.          
-00014bf0: 2020 6e61 6d65 3a20 6d79 6170 700a 2020    name: myapp.  
-00014c00: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00014c10: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
-00014c20: 6f64 656c 286d 6574 612c 2073 656c 662e  odel(meta, self.
-00014c30: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
-00014c40: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00014c50: 662c 2027 6973 2d6c 6561 6465 7227 2c20  f, 'is-leader', 
-00014c60: 2765 6368 6f20 6661 6c73 6527 290a 2020  'echo false').  
-00014c70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00014c80: 7446 616c 7365 286d 6f64 656c 2e75 6e69  tFalse(model.uni
-00014c90: 742e 6973 5f6c 6561 6465 7228 2929 0a0a  t.is_leader())..
-00014ca0: 2020 2020 2020 2020 2320 4368 616e 6765          # Change
-00014cb0: 2074 6865 206c 6561 6465 7273 6869 7020   the leadership 
-00014cc0: 7374 6174 7573 0a20 2020 2020 2020 2066  status.        f
-00014cd0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00014ce0: 2027 6973 2d6c 6561 6465 7227 2c20 2765   'is-leader', 'e
-00014cf0: 6368 6f20 7472 7565 2729 0a20 2020 2020  cho true').     
-00014d00: 2020 2023 2049 6620 796f 7520 646f 6e27     # If you don'
-00014d10: 7420 666f 7263 6520 6974 2c20 7765 2064  t force it, we d
-00014d20: 6f6e 2774 2063 6865 636b 2c20 736f 2077  on't check, so w
-00014d30: 6520 776f 6e27 7420 7365 6520 7468 6520  e won't see the 
-00014d40: 6368 616e 6765 0a20 2020 2020 2020 2073  change.        s
-00014d50: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-00014d60: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
-00014d70: 6164 6572 2829 290a 2020 2020 2020 2020  ader()).        
-00014d80: 2320 4966 2077 6520 666f 7263 6520 6120  # If we force a 
-00014d90: 7265 6368 6563 6b2c 2074 6865 6e20 7765  recheck, then we
-00014da0: 206e 6f74 6963 650a 2020 2020 2020 2020   notice.        
-00014db0: 7365 6c66 2e62 6163 6b65 6e64 2e5f 6c65  self.backend._le
-00014dc0: 6164 6572 5f63 6865 636b 5f74 696d 6520  ader_check_time 
-00014dd0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-00014de0: 656c 662e 6173 7365 7274 5472 7565 286d  elf.assertTrue(m
-00014df0: 6f64 656c 2e75 6e69 742e 6973 5f6c 6561  odel.unit.is_lea
-00014e00: 6465 7228 2929 0a0a 2020 2020 2020 2020  der())..        
-00014e10: 2320 466f 7263 6520 6120 7265 6368 6563  # Force a rechec
-00014e20: 6b20 7769 7468 6f75 7420 6368 616e 6769  k without changi
-00014e30: 6e67 2074 6865 206c 6561 6465 7273 6869  ng the leadershi
-00014e40: 7020 7374 6174 7573 2e0a 2020 2020 2020  p status..      
-00014e50: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00014e60: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
-00014e70: 2027 6563 686f 2074 7275 6527 290a 2020   'echo true').  
-00014e80: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00014e90: 6e64 2e5f 6c65 6164 6572 5f63 6865 636b  nd._leader_check
-00014ea0: 5f74 696d 6520 3d20 4e6f 6e65 0a20 2020  _time = None.   
-00014eb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014ec0: 5472 7565 286d 6f64 656c 2e75 6e69 742e  True(model.unit.
-00014ed0: 6973 5f6c 6561 6465 7228 2929 0a0a 2020  is_leader())..  
-00014ee0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-00014ef0: 696f 6e5f 746f 6f6c 5f65 7272 6f72 7328  ion_tool_errors(
-00014f00: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00014f10: 656c 662e 6164 6443 6c65 616e 7570 286f  elf.addCleanup(o
-00014f20: 732e 656e 7669 726f 6e2e 706f 702c 2027  s.environ.pop, '
-00014f30: 4a55 4a55 5f56 4552 5349 4f4e 272c 204e  JUJU_VERSION', N
-00014f40: 6f6e 6529 0a20 2020 2020 2020 206f 732e  one).        os.
-00014f50: 656e 7669 726f 6e5b 274a 554a 555f 5645  environ['JUJU_VE
-00014f60: 5253 494f 4e27 5d20 3d20 2732 2e38 2e30  RSION'] = '2.8.0
-00014f70: 270a 2020 2020 2020 2020 6572 725f 6d73  '.        err_ms
-00014f80: 6720 3d20 2745 5252 4f52 2069 6e76 616c  g = 'ERROR inval
-00014f90: 6964 2076 616c 7565 2022 2432 2220 666f  id value "$2" fo
-00014fa0: 7220 6f70 7469 6f6e 202d 723a 2072 656c  r option -r: rel
-00014fb0: 6174 696f 6e20 6e6f 7420 666f 756e 6427  ation not found'
-00014fc0: 0a0a 2020 2020 2020 2020 7465 7374 5f63  ..        test_c
-00014fd0: 6173 6573 203d 205b 280a 2020 2020 2020  ases = [(.      
-00014fe0: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
-00014ff0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00015000: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
-00015010: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
-00015020: 3e26 3220 3b20 6578 6974 2031 2729 2c0a  >&2 ; exit 1'),.
-00015030: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00015040: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
-00015050: 2e72 656c 6174 696f 6e5f 6c69 7374 2833  .relation_list(3
-00015060: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-00015070: 7073 2e4d 6f64 656c 4572 726f 722c 0a20  ps.ModelError,. 
-00015080: 2020 2020 2020 2020 2020 205b 5b27 7265             [['re
-00015090: 6c61 7469 6f6e 2d6c 6973 7427 2c20 272d  lation-list', '-
-000150a0: 7227 2c20 2733 272c 2027 2d2d 666f 726d  r', '3', '--form
-000150b0: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
-000150c0: 2020 2020 292c 2028 0a20 2020 2020 2020      ), (.       
-000150d0: 2020 2020 206c 616d 6264 613a 2066 616b       lambda: fak
-000150e0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-000150f0: 7265 6c61 7469 6f6e 2d6c 6973 7427 2c20  relation-list', 
-00015100: 6627 6563 686f 207b 6572 725f 6d73 677d  f'echo {err_msg}
-00015110: 203e 2632 203b 2065 7869 7420 3227 292c   >&2 ; exit 2'),
-00015120: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00015130: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
-00015140: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
-00015150: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
-00015160: 6f70 732e 5265 6c61 7469 6f6e 4e6f 7446  ops.RelationNotF
-00015170: 6f75 6e64 4572 726f 722c 0a20 2020 2020  oundError,.     
-00015180: 2020 2020 2020 205b 5b27 7265 6c61 7469         [['relati
-00015190: 6f6e 2d6c 6973 7427 2c20 272d 7227 2c20  on-list', '-r', 
-000151a0: 2733 272c 2027 2d2d 666f 726d 6174 3d6a  '3', '--format=j
-000151b0: 736f 6e27 5d5d 2c0a 2020 2020 2020 2020  son']],.        
-000151c0: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-000151d0: 206c 616d 6264 613a 2066 616b 655f 7363   lambda: fake_sc
-000151e0: 7269 7074 2873 656c 662c 2027 7265 6c61  ript(self, 'rela
-000151f0: 7469 6f6e 2d73 6574 272c 2027 6563 686f  tion-set', 'echo
-00015200: 2066 6f6f 6572 726f 7220 3e26 3220 3b20   fooerror >&2 ; 
-00015210: 6578 6974 2031 2729 2c0a 2020 2020 2020  exit 1'),.      
-00015220: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
-00015230: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
-00015240: 696f 6e5f 7365 7428 332c 2027 666f 6f27  ion_set(3, 'foo'
-00015250: 2c20 2762 6172 272c 2069 735f 6170 703d  , 'bar', is_app=
-00015260: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-00015270: 2020 2020 6f70 732e 4d6f 6465 6c45 7272      ops.ModelErr
-00015280: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00015290: 5b5b 2772 656c 6174 696f 6e2d 7365 7427  [['relation-set'
-000152a0: 2c20 272d 7227 2c20 2733 272c 2027 2d2d  , '-r', '3', '--
-000152b0: 6669 6c65 272c 2027 2d27 5d5d 2c0a 2020  file', '-']],.  
-000152c0: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
-000152d0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-000152e0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-000152f0: 2027 7265 6c61 7469 6f6e 2d73 6574 272c   'relation-set',
-00015300: 2066 2765 6368 6f20 7b65 7272 5f6d 7367   f'echo {err_msg
-00015310: 7d20 3e26 3220 3b20 6578 6974 2032 2729  } >&2 ; exit 2')
-00015320: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-00015330: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
-00015340: 6e64 2e72 656c 6174 696f 6e5f 7365 7428  nd.relation_set(
-00015350: 332c 2027 666f 6f27 2c20 2762 6172 272c  3, 'foo', 'bar',
-00015360: 2069 735f 6170 703d 4661 6c73 6529 2c0a   is_app=False),.
-00015370: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00015380: 5265 6c61 7469 6f6e 4e6f 7446 6f75 6e64  RelationNotFound
-00015390: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-000153a0: 2020 205b 5b27 7265 6c61 7469 6f6e 2d73     [['relation-s
-000153b0: 6574 272c 2027 2d72 272c 2027 3327 2c20  et', '-r', '3', 
-000153c0: 272d 2d66 696c 6527 2c20 272d 275d 5d2c  '--file', '-']],
-000153d0: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
-000153e0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-000153f0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00015400: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-00015410: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
-00015420: 6e5f 7365 7428 332c 2027 666f 6f27 2c20  n_set(3, 'foo', 
-00015430: 2762 6172 272c 2069 735f 6170 703d 5472  'bar', is_app=Tr
-00015440: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-00015450: 206f 7073 2e52 656c 6174 696f 6e4e 6f74   ops.RelationNot
-00015460: 466f 756e 6445 7272 6f72 2c0a 2020 2020  FoundError,.    
-00015470: 2020 2020 2020 2020 5b5b 2772 656c 6174          [['relat
-00015480: 696f 6e2d 7365 7427 2c20 272d 7227 2c20  ion-set', '-r', 
-00015490: 2733 272c 2027 2d2d 6170 7027 2c20 272d  '3', '--app', '-
-000154a0: 2d66 696c 6527 2c20 272d 275d 5d2c 0a20  -file', '-']],. 
-000154b0: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
-000154c0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-000154d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000154e0: 2c20 2772 656c 6174 696f 6e2d 6765 7427  , 'relation-get'
-000154f0: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
-00015500: 203e 2632 203b 2065 7869 7420 3127 292c   >&2 ; exit 1'),
-00015510: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00015520: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
-00015530: 642e 7265 6c61 7469 6f6e 5f67 6574 2833  d.relation_get(3
-00015540: 2c20 2772 656d 6f74 652f 3027 2c20 6973  , 'remote/0', is
-00015550: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
-00015560: 2020 2020 2020 2020 206f 7073 2e4d 6f64           ops.Mod
-00015570: 656c 4572 726f 722c 0a20 2020 2020 2020  elError,.       
-00015580: 2020 2020 205b 5b27 7265 6c61 7469 6f6e       [['relation
-00015590: 2d67 6574 272c 2027 2d72 272c 2027 3327  -get', '-r', '3'
-000155a0: 2c20 272d 272c 2027 7265 6d6f 7465 2f30  , '-', 'remote/0
-000155b0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-000155c0: 6e27 5d5d 2c0a 2020 2020 2020 2020 292c  n']],.        ),
-000155d0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
-000155e0: 616d 6264 613a 2066 616b 655f 7363 7269  ambda: fake_scri
-000155f0: 7074 2873 656c 662c 2027 7265 6c61 7469  pt(self, 'relati
-00015600: 6f6e 2d67 6574 272c 2066 2765 6368 6f20  on-get', f'echo 
-00015610: 7b65 7272 5f6d 7367 7d20 3e26 3220 3b20  {err_msg} >&2 ; 
-00015620: 6578 6974 2032 2729 2c0a 2020 2020 2020  exit 2'),.      
-00015630: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
-00015640: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
-00015650: 696f 6e5f 6765 7428 332c 2027 7265 6d6f  ion_get(3, 'remo
-00015660: 7465 2f30 272c 2069 735f 6170 703d 4661  te/0', is_app=Fa
-00015670: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
-00015680: 2020 6f70 732e 5265 6c61 7469 6f6e 4e6f    ops.RelationNo
-00015690: 7446 6f75 6e64 4572 726f 722c 0a20 2020  tFoundError,.   
-000156a0: 2020 2020 2020 2020 205b 5b27 7265 6c61           [['rela
-000156b0: 7469 6f6e 2d67 6574 272c 2027 2d72 272c  tion-get', '-r',
-000156c0: 2027 3327 2c20 272d 272c 2027 7265 6d6f   '3', '-', 'remo
-000156d0: 7465 2f30 272c 2027 2d2d 666f 726d 6174  te/0', '--format
-000156e0: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
-000156f0: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
-00015700: 2020 206c 616d 6264 613a 204e 6f6e 652c     lambda: None,
-00015710: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00015720: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
-00015730: 642e 7265 6c61 7469 6f6e 5f67 6574 2833  d.relation_get(3
-00015740: 2c20 2772 656d 6f74 652f 3027 2c20 6973  , 'remote/0', is
-00015750: 5f61 7070 3d54 7275 6529 2c0a 2020 2020  _app=True),.    
-00015760: 2020 2020 2020 2020 6f70 732e 5265 6c61          ops.Rela
-00015770: 7469 6f6e 4e6f 7446 6f75 6e64 4572 726f  tionNotFoundErro
-00015780: 722c 0a20 2020 2020 2020 2020 2020 205b  r,.            [
-00015790: 5b27 7265 6c61 7469 6f6e 2d67 6574 272c  ['relation-get',
-000157a0: 2027 2d72 272c 2027 3327 2c20 272d 272c   '-r', '3', '-',
-000157b0: 2027 7265 6d6f 7465 2f30 272c 2027 2d2d   'remote/0', '--
-000157c0: 6170 7027 2c20 272d 2d66 6f72 6d61 743d  app', '--format=
-000157d0: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
-000157e0: 2029 5d0a 0a20 2020 2020 2020 2066 6f72   )]..        for
-000157f0: 2069 2c20 2864 6f5f 6661 6b65 2c20 7275   i, (do_fake, ru
-00015800: 6e2c 2065 7863 6570 7469 6f6e 2c20 6361  n, exception, ca
-00015810: 6c6c 7329 2069 6e20 656e 756d 6572 6174  lls) in enumerat
-00015820: 6528 7465 7374 5f63 6173 6573 293a 0a20  e(test_cases):. 
-00015830: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00015840: 7365 6c66 2e73 7562 5465 7374 2869 293a  self.subTest(i):
-00015850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015860: 2064 6f5f 6661 6b65 2829 0a20 2020 2020   do_fake().     
-00015870: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00015880: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00015890: 7328 6578 6365 7074 696f 6e29 3a0a 2020  s(exception):.  
-000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158b0: 2020 7275 6e28 290a 2020 2020 2020 2020    run().        
-000158c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000158d0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
-000158e0: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
-000158f0: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
-00015900: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
-00015910: 7374 5f72 656c 6174 696f 6e5f 6765 745f  st_relation_get_
-00015920: 6a75 6a75 5f76 6572 7369 6f6e 5f71 7569  juju_version_qui
-00015930: 726b 7328 7365 6c66 293a 0a20 2020 2020  rks(self):.     
-00015940: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00015950: 7570 286f 732e 656e 7669 726f 6e2e 706f  up(os.environ.po
-00015960: 702c 2027 4a55 4a55 5f56 4552 5349 4f4e  p, 'JUJU_VERSION
-00015970: 272c 204e 6f6e 6529 0a0a 2020 2020 2020  ', None)..      
-00015980: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00015990: 6c66 2c20 2772 656c 6174 696f 6e2d 6765  lf, 'relation-ge
-000159a0: 7427 2c20 2727 2765 6368 6f20 277b 2266  t', '''echo '{"f
-000159b0: 6f6f 223a 2022 6261 7222 7d27 2027 2727  oo": "bar"}' '''
-000159c0: 290a 0a20 2020 2020 2020 2023 206f 6e20  )..        # on 
-000159d0: 322e 372e 302b 2c20 7468 696e 6773 2070  2.7.0+, things p
-000159e0: 726f 6365 6564 2061 7320 6578 7065 6374  roceed as expect
-000159f0: 6564 0a20 2020 2020 2020 2066 6f72 2076  ed.        for v
-00015a00: 2069 6e20 5b27 322e 382e 3027 2c20 2732   in ['2.8.0', '2
-00015a10: 2e37 2e30 275d 3a0a 2020 2020 2020 2020  .7.0']:.        
-00015a20: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
-00015a30: 6254 6573 7428 7629 3a0a 2020 2020 2020  bTest(v):.      
-00015a40: 2020 2020 2020 2020 2020 6f73 2e65 6e76            os.env
-00015a50: 6972 6f6e 5b27 4a55 4a55 5f56 4552 5349  iron['JUJU_VERSI
-00015a60: 4f4e 275d 203d 2076 0a20 2020 2020 2020  ON'] = v.       
-00015a70: 2020 2020 2020 2020 2072 656c 5f64 6174           rel_dat
-00015a80: 6120 3d20 7365 6c66 2e62 6163 6b65 6e64  a = self.backend
-00015a90: 2e72 656c 6174 696f 6e5f 6765 7428 312c  .relation_get(1,
-00015aa0: 2027 666f 6f2f 3027 2c20 6973 5f61 7070   'foo/0', is_app
-00015ab0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00015ac0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015ad0: 7274 4571 7561 6c28 7265 6c5f 6461 7461  rtEqual(rel_data
-00015ae0: 2c20 7b22 666f 6f22 3a20 2262 6172 227d  , {"foo": "bar"}
-00015af0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015b00: 2020 6361 6c6c 7320 3d20 5b27 2027 2e6a    calls = [' '.j
-00015b10: 6f69 6e28 6929 2066 6f72 2069 2069 6e20  oin(i) for i in 
-00015b20: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00015b30: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-00015b40: 7565 295d 0a20 2020 2020 2020 2020 2020  ue)].           
-00015b50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00015b60: 4571 7561 6c28 6361 6c6c 732c 205b 2772  Equal(calls, ['r
-00015b70: 656c 6174 696f 6e2d 6765 7420 2d72 2031  elation-get -r 1
-00015b80: 202d 2066 6f6f 2f30 202d 2d61 7070 202d   - foo/0 --app -
-00015b90: 2d66 6f72 6d61 743d 6a73 6f6e 275d 290a  -format=json']).
-00015ba0: 0a20 2020 2020 2020 2023 2062 6566 6f72  .        # befor
-00015bb0: 6520 322e 372e 302c 2069 7420 6a75 7374  e 2.7.0, it just
-00015bc0: 2066 6169 6c73 2028 6e6f 202d 2d61 7070   fails (no --app
-00015bd0: 2073 7570 706f 7274 290a 2020 2020 2020   support).      
-00015be0: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
-00015bf0: 4a55 5f56 4552 5349 4f4e 275d 203d 2027  JU_VERSION'] = '
-00015c00: 322e 362e 3927 0a20 2020 2020 2020 2077  2.6.9'.        w
-00015c10: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00015c20: 6169 7365 7352 6567 6578 2852 756e 7469  aisesRegex(Runti
-00015c30: 6d65 4572 726f 722c 2027 6e6f 7420 7375  meError, 'not su
-00015c40: 7070 6f72 7465 6420 6f6e 204a 756a 7520  pported on Juju 
-00015c50: 7665 7273 696f 6e20 322e 362e 3927 293a  version 2.6.9'):
-00015c60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00015c70: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
-00015c80: 6f6e 5f67 6574 2831 2c20 2766 6f6f 2f30  on_get(1, 'foo/0
-00015c90: 272c 2069 735f 6170 703d 5472 7565 290a  ', is_app=True).
-00015ca0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015cb0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
-00015cc0: 7269 7074 5f63 616c 6c73 2873 656c 6629  ript_calls(self)
-00015cd0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
-00015ce0: 6573 745f 7265 6c61 7469 6f6e 5f73 6574  est_relation_set
-00015cf0: 5f6a 756a 755f 7665 7273 696f 6e5f 7175  _juju_version_qu
-00015d00: 6972 6b73 2873 656c 6629 3a0a 2020 2020  irks(self):.    
-00015d10: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00015d20: 6e75 7028 6f73 2e65 6e76 6972 6f6e 2e70  nup(os.environ.p
-00015d30: 6f70 2c20 274a 554a 555f 5645 5253 494f  op, 'JUJU_VERSIO
-00015d40: 4e27 2c20 4e6f 6e65 290a 0a20 2020 2020  N', None)..     
-00015d50: 2020 2023 206f 6e20 322e 372e 302b 2c20     # on 2.7.0+, 
-00015d60: 7468 696e 6773 2070 726f 6365 6564 2061  things proceed a
-00015d70: 7320 6578 7065 6374 6564 0a20 2020 2020  s expected.     
-00015d80: 2020 2066 6f72 2076 2069 6e20 5b27 322e     for v in ['2.
-00015d90: 382e 3027 2c20 2732 2e37 2e30 275d 3a0a  8.0', '2.7.0']:.
-00015da0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00015db0: 2073 656c 662e 7375 6254 6573 7428 7629   self.subTest(v)
-00015dc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015dd0: 2020 7420 3d20 7465 6d70 6669 6c65 2e4e    t = tempfile.N
-00015de0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-00015df0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00015e00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00015e10: 2020 2020 2020 2020 2020 2020 2066 616b               fak
-00015e20: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00015e30: 7265 6c61 7469 6f6e 2d73 6574 272c 2064  relation-set', d
-00015e40: 6564 656e 7428 2222 220a 2020 2020 2020  edent(""".      
-00015e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e60: 2020 6361 7420 3e3e 207b 7d0a 2020 2020    cat >> {}.    
-00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e80: 2020 2020 2222 2229 2e66 6f72 6d61 7428      """).format(
-00015e90: 7061 7468 6c69 622e 5061 7468 2874 2e6e  pathlib.Path(t.n
-00015ea0: 616d 6529 2e61 735f 706f 7369 7828 2929  ame).as_posix())
-00015eb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015ec0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
-00015ed0: 5b27 4a55 4a55 5f56 4552 5349 4f4e 275d  ['JUJU_VERSION']
-00015ee0: 203d 2076 0a20 2020 2020 2020 2020 2020   = v.           
-00015ef0: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00015f00: 636b 656e 642e 7265 6c61 7469 6f6e 5f73  ckend.relation_s
-00015f10: 6574 2831 2c20 2766 6f6f 272c 2027 6261  et(1, 'foo', 'ba
-00015f20: 7227 2c20 6973 5f61 7070 3d54 7275 6529  r', is_app=True)
-00015f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f40: 2020 2020 2063 616c 6c73 203d 205b 2720       calls = [' 
-00015f50: 272e 6a6f 696e 2869 2920 666f 7220 6920  '.join(i) for i 
-00015f60: 696e 2066 616b 655f 7363 7269 7074 5f63  in fake_script_c
-00015f70: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-00015f80: 3d54 7275 6529 5d0a 2020 2020 2020 2020  =True)].        
-00015f90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015fa0: 2e61 7373 6572 7445 7175 616c 2863 616c  .assertEqual(cal
-00015fb0: 6c73 2c20 5b27 7265 6c61 7469 6f6e 2d73  ls, ['relation-s
-00015fc0: 6574 202d 7220 3120 2d2d 6170 7020 2d2d  et -r 1 --app --
-00015fd0: 6669 6c65 202d 275d 290a 2020 2020 2020  file -']).      
-00015fe0: 2020 2020 2020 2020 2020 2020 2020 742e                t.
-00015ff0: 7365 656b 2830 290a 2020 2020 2020 2020  seek(0).        
-00016000: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00016010: 656e 7420 3d20 742e 7265 6164 2829 0a20  ent = t.read(). 
-00016020: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00016030: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00016040: 2020 2020 2020 2020 2020 2020 742e 636c              t.cl
-00016050: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
-00016060: 2020 2020 2020 6465 636f 6465 6420 3d20        decoded = 
-00016070: 636f 6e74 656e 742e 6465 636f 6465 2827  content.decode('
-00016080: 7574 662d 3827 292e 7265 706c 6163 6528  utf-8').replace(
-00016090: 275c 725c 6e27 2c20 275c 6e27 290a 2020  '\r\n', '\n').  
-000160a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000160b0: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
-000160c0: 6563 6f64 6564 2c20 2766 6f6f 3a20 6261  ecoded, 'foo: ba
-000160d0: 725c 6e27 290a 0a20 2020 2020 2020 2023  r\n')..        #
-000160e0: 2062 6566 6f72 6520 322e 372e 302c 2069   before 2.7.0, i
-000160f0: 7420 6a75 7374 2066 6169 6c73 2061 6c77  t just fails alw
-00016100: 6179 7320 286e 6f20 2d2d 6170 7020 7375  ays (no --app su
-00016110: 7070 6f72 7429 0a20 2020 2020 2020 206f  pport).        o
-00016120: 732e 656e 7669 726f 6e5b 274a 554a 555f  s.environ['JUJU_
-00016130: 5645 5253 494f 4e27 5d20 3d20 2732 2e36  VERSION'] = '2.6
-00016140: 2e39 270a 2020 2020 2020 2020 7769 7468  .9'.        with
-00016150: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00016160: 6573 5265 6765 7828 5275 6e74 696d 6545  esRegex(RuntimeE
-00016170: 7272 6f72 2c20 276e 6f74 2073 7570 706f  rror, 'not suppo
-00016180: 7274 6564 206f 6e20 4a75 6a75 2076 6572  rted on Juju ver
-00016190: 7369 6f6e 2032 2e36 2e39 2729 3a0a 2020  sion 2.6.9'):.  
-000161a0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000161b0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-000161c0: 7365 7428 312c 2027 666f 6f27 2c20 2762  set(1, 'foo', 'b
-000161d0: 6172 272c 2069 735f 6170 703d 5472 7565  ar', is_app=True
-000161e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000161f0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-00016200: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00016210: 6629 2c20 5b5d 290a 0a20 2020 2064 6566  f), [])..    def
-00016220: 2074 6573 745f 7374 6174 7573 5f67 6574   test_status_get
-00016230: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00016240: 2320 7461 6b65 6e20 6672 6f6d 2061 6374  # taken from act
-00016250: 7561 6c20 4a75 6a75 206f 7574 7075 740a  ual Juju output.
-00016260: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-00016270: 3d20 277b 226d 6573 7361 6765 223a 2022  = '{"message": "
-00016280: 222c 2022 7374 6174 7573 223a 2022 756e  ", "status": "un
-00016290: 6b6e 6f77 6e22 2c20 2273 7461 7475 732d  known", "status-
-000162a0: 6461 7461 223a 207b 7d7d 270a 2020 2020  data": {}}'.    
-000162b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-000162c0: 7365 6c66 2c20 2773 7461 7475 732d 6765  self, 'status-ge
-000162d0: 7427 2c20 6622 6563 686f 2027 7b63 6f6e  t', f"echo '{con
-000162e0: 7465 6e74 7d27 2229 0a20 2020 2020 2020  tent}'").       
-000162f0: 2073 203d 2073 656c 662e 6261 636b 656e   s = self.backen
-00016300: 642e 7374 6174 7573 5f67 6574 2869 735f  d.status_get(is_
-00016310: 6170 703d 4661 6c73 6529 0a20 2020 2020  app=False).     
-00016320: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00016330: 7561 6c28 735b 2773 7461 7475 7327 5d2c  ual(s['status'],
-00016340: 2022 756e 6b6e 6f77 6e22 290a 2020 2020   "unknown").    
-00016350: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016360: 7175 616c 2873 5b27 6d65 7373 6167 6527  qual(s['message'
-00016370: 5d2c 2022 2229 0a20 2020 2020 2020 2023  ], "").        #
-00016380: 2074 616b 656e 2066 726f 6d20 6163 7475   taken from actu
-00016390: 616c 204a 756a 7520 6f75 7470 7574 0a20  al Juju output. 
-000163a0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
-000163b0: 2064 6564 656e 7428 2222 220a 2020 2020   dedent(""".    
-000163c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000163d0: 2020 2020 2020 2020 2020 2261 7070 6c69            "appli
-000163e0: 6361 7469 6f6e 2d73 7461 7475 7322 3a20  cation-status": 
-000163f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00016400: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
-00016410: 2022 696e 7374 616c 6c69 6e67 222c 0a20   "installing",. 
-00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016430: 2020 2022 7374 6174 7573 223a 2022 6d61     "status": "ma
-00016440: 696e 7465 6e61 6e63 6522 2c0a 2020 2020  intenance",.    
-00016450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016460: 2273 7461 7475 732d 6461 7461 223a 207b  "status-data": {
-00016470: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00016480: 2020 2020 2020 2022 756e 6974 7322 3a20         "units": 
-00016490: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000164a0: 2020 2020 2020 2020 2020 2275 6f2f 3022            "uo/0"
-000164b0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164d0: 226d 6573 7361 6765 223a 2022 222c 0a20  "message": "",. 
-000164e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164f0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00016500: 7573 223a 2022 6163 7469 7665 222c 0a20  us": "active",. 
-00016510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016520: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00016530: 7573 2d64 6174 6122 3a20 7b7d 0a20 2020  us-data": {}.   
-00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016550: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00016560: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00016570: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00016580: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00016590: 2020 2020 2020 2020 2022 2222 290a 2020           """).  
-000165a0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-000165b0: 7428 7365 6c66 2c20 2773 7461 7475 732d  t(self, 'status-
-000165c0: 6765 7427 2c20 6622 6563 686f 2027 7b63  get', f"echo '{c
-000165d0: 6f6e 7465 6e74 7d27 2229 0a20 2020 2020  ontent}'").     
-000165e0: 2020 2073 203d 2073 656c 662e 6261 636b     s = self.back
-000165f0: 656e 642e 7374 6174 7573 5f67 6574 2869  end.status_get(i
-00016600: 735f 6170 703d 5472 7565 290a 2020 2020  s_app=True).    
-00016610: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016620: 7175 616c 2873 5b27 7374 6174 7573 275d  qual(s['status']
-00016630: 2c20 226d 6169 6e74 656e 616e 6365 2229  , "maintenance")
-00016640: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00016650: 7365 7274 4571 7561 6c28 735b 276d 6573  sertEqual(s['mes
-00016660: 7361 6765 275d 2c20 2269 6e73 7461 6c6c  sage'], "install
-00016670: 696e 6722 290a 2020 2020 2020 2020 7365  ing").        se
-00016680: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00016690: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-000166a0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-000166b0: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
-000166c0: 2020 5b27 7374 6174 7573 2d67 6574 272c    ['status-get',
-000166d0: 2027 2d2d 696e 636c 7564 652d 6461 7461   '--include-data
-000166e0: 272c 2027 2d2d 6170 706c 6963 6174 696f  ', '--applicatio
-000166f0: 6e3d 4661 6c73 6527 2c20 272d 2d66 6f72  n=False', '--for
-00016700: 6d61 743d 6a73 6f6e 275d 2c0a 2020 2020  mat=json'],.    
-00016710: 2020 2020 2020 2020 5b27 7374 6174 7573          ['status
-00016720: 2d67 6574 272c 2027 2d2d 696e 636c 7564  -get', '--includ
-00016730: 652d 6461 7461 272c 2027 2d2d 6170 706c  e-data', '--appl
-00016740: 6963 6174 696f 6e3d 5472 7565 272c 2027  ication=True', '
-00016750: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
-00016760: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-00016770: 2064 6566 2074 6573 745f 7374 6174 7573   def test_status
-00016780: 5f69 735f 6170 705f 666f 7263 6564 5f6b  _is_app_forced_k
-00016790: 7761 7267 7328 7365 6c66 293a 0a20 2020  wargs(self):.   
-000167a0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-000167b0: 2873 656c 662c 2027 7374 6174 7573 2d67  (self, 'status-g
-000167c0: 6574 272c 2027 6578 6974 2031 2729 0a20  et', 'exit 1'). 
-000167d0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-000167e0: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
-000167f0: 2d73 6574 272c 2027 6578 6974 2031 2729  -set', 'exit 1')
-00016800: 0a0a 2020 2020 2020 2020 7465 7374 5f63  ..        test_c
-00016810: 6173 6573 203d 2028 0a20 2020 2020 2020  ases = (.       
-00016820: 2020 2020 206c 616d 6264 613a 2073 656c       lambda: sel
-00016830: 662e 6261 636b 656e 642e 7374 6174 7573  f.backend.status
-00016840: 5f67 6574 2846 616c 7365 292c 0a20 2020  _get(False),.   
-00016850: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00016860: 2073 656c 662e 6261 636b 656e 642e 7374   self.backend.st
-00016870: 6174 7573 5f67 6574 2854 7275 6529 2c0a  atus_get(True),.
-00016880: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00016890: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
-000168a0: 2e73 7461 7475 735f 7365 7428 2761 6374  .status_set('act
-000168b0: 6976 6527 2c20 2727 2c20 4661 6c73 6529  ive', '', False)
-000168c0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-000168d0: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
-000168e0: 6e64 2e73 7461 7475 735f 7365 7428 2761  nd.status_set('a
-000168f0: 6374 6976 6527 2c20 2727 2c20 5472 7565  ctive', '', True
-00016900: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-00016910: 2020 2020 2020 666f 7220 6361 7365 2069        for case i
-00016920: 6e20 7465 7374 5f63 6173 6573 3a0a 2020  n test_cases:.  
-00016930: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-00016940: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00016950: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
-00016960: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00016970: 6528 290a 0a20 2020 2064 6566 2074 6573  e()..    def tes
-00016980: 745f 6c6f 6361 6c5f 7365 745f 696e 7661  t_local_set_inva
-00016990: 6c69 645f 7374 6174 7573 2873 656c 6629  lid_status(self)
-000169a0: 3a0a 2020 2020 2020 2020 2320 6a75 6a75  :.        # juju
-000169b0: 2072 6574 7572 6e73 2065 7869 7420 636f   returns exit co
-000169c0: 6465 2031 2069 6620 796f 7520 6173 6b20  de 1 if you ask 
-000169d0: 746f 2073 6574 2073 7461 7475 7320 746f  to set status to
-000169e0: 2027 756e 6b6e 6f77 6e27 206f 7220 2765   'unknown' or 'e
-000169f0: 7272 6f72 270a 2020 2020 2020 2020 6d65  rror'.        me
-00016a00: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
-00016a10: 7461 2e66 726f 6d5f 7961 6d6c 2827 2727  ta.from_yaml('''
-00016a20: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00016a30: 653a 206d 7961 7070 0a20 2020 2020 2020  e: myapp.       
-00016a40: 2027 2727 290a 2020 2020 2020 2020 6d6f   ''').        mo
-00016a50: 6465 6c20 3d20 6f70 732e 4d6f 6465 6c28  del = ops.Model(
-00016a60: 6d65 7461 2c20 7365 6c66 2e62 6163 6b65  meta, self.backe
-00016a70: 6e64 290a 2020 2020 2020 2020 6661 6b65  nd).        fake
-00016a80: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-00016a90: 7461 7475 732d 7365 7427 2c20 2765 7869  tatus-set', 'exi
-00016aa0: 7420 3127 290a 2020 2020 2020 2020 6661  t 1').        fa
-00016ab0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00016ac0: 2769 732d 6c65 6164 6572 272c 2027 6563  'is-leader', 'ec
-00016ad0: 686f 2074 7275 6527 290a 0a20 2020 2020  ho true')..     
-00016ae0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00016af0: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
-00016b00: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
-00016b10: 2020 2020 2020 206d 6f64 656c 2e75 6e69         model.uni
-00016b20: 742e 7374 6174 7573 203d 206f 7073 2e55  t.status = ops.U
-00016b30: 6e6b 6e6f 776e 5374 6174 7573 2829 0a20  nknownStatus(). 
-00016b40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00016b50: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-00016b60: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
-00016b70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-00016b80: 2e75 6e69 742e 7374 6174 7573 203d 206f  .unit.status = o
-00016b90: 7073 2e45 7272 6f72 5374 6174 7573 2829  ps.ErrorStatus()
-00016ba0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00016bb0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-00016bc0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00016bd0: 662c 2054 7275 6529 2c20 5b0a 2020 2020  f, True), [.    
-00016be0: 2020 2020 2020 2020 5b27 7374 6174 7573          ['status
-00016bf0: 2d73 6574 272c 2027 2d2d 6170 706c 6963  -set', '--applic
-00016c00: 6174 696f 6e3d 4661 6c73 6527 2c20 2775  ation=False', 'u
-00016c10: 6e6b 6e6f 776e 272c 2027 275d 2c0a 2020  nknown', ''],.  
-00016c20: 2020 2020 2020 2020 2020 5b27 7374 6174            ['stat
-00016c30: 7573 2d73 6574 272c 2027 2d2d 6170 706c  us-set', '--appl
-00016c40: 6963 6174 696f 6e3d 4661 6c73 6527 2c20  ication=False', 
-00016c50: 2765 7272 6f72 272c 2027 275d 2c0a 2020  'error', ''],.  
-00016c60: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
-00016c70: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00016c80: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
-00016c90: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
-00016ca0: 2020 2020 2020 6d6f 6465 6c2e 6170 702e        model.app.
-00016cb0: 7374 6174 7573 203d 206f 7073 2e55 6e6b  status = ops.Unk
-00016cc0: 6e6f 776e 5374 6174 7573 2829 0a20 2020  nownStatus().   
-00016cd0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00016ce0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00016cf0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-00016d00: 2020 2020 2020 2020 206d 6f64 656c 2e61           model.a
-00016d10: 7070 2e73 7461 7475 7320 3d20 6f70 732e  pp.status = ops.
-00016d20: 4572 726f 7253 7461 7475 7328 290a 0a20  ErrorStatus().. 
-00016d30: 2020 2020 2020 2023 2041 206c 6561 6465         # A leade
-00016d40: 7273 6869 7020 6368 6563 6b20 6973 206e  rship check is n
-00016d50: 6565 6465 6420 666f 7220 6170 706c 6963  eeded for applic
-00016d60: 6174 696f 6e20 7374 6174 7573 2e0a 2020  ation status..  
-00016d70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00016d80: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00016d90: 7074 5f63 616c 6c73 2873 656c 662c 2054  pt_calls(self, T
-00016da0: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
-00016db0: 2020 2020 5b27 6973 2d6c 6561 6465 7227      ['is-leader'
-00016dc0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
-00016dd0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00016de0: 5b27 7374 6174 7573 2d73 6574 272c 2027  ['status-set', '
-00016df0: 2d2d 6170 706c 6963 6174 696f 6e3d 5472  --application=Tr
-00016e00: 7565 272c 2027 756e 6b6e 6f77 6e27 2c20  ue', 'unknown', 
-00016e10: 2727 5d2c 0a20 2020 2020 2020 2020 2020  ''],.           
-00016e20: 205b 2773 7461 7475 732d 7365 7427 2c20   ['status-set', 
-00016e30: 272d 2d61 7070 6c69 6361 7469 6f6e 3d54  '--application=T
-00016e40: 7275 6527 2c20 2765 7272 6f72 272c 2027  rue', 'error', '
-00016e50: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
-00016e60: 2020 2020 6465 6620 7465 7374 5f6c 6f63      def test_loc
-00016e70: 616c 5f67 6574 5f73 7461 7475 7328 7365  al_get_status(se
-00016e80: 6c66 293a 0a20 2020 2020 2020 2066 6f72  lf):.        for
-00016e90: 206e 616d 652c 2065 7870 6563 7465 645f   name, expected_
-00016ea0: 636c 7320 696e 2028 0a20 2020 2020 2020  cls in (.       
-00016eb0: 2020 2020 2028 2261 6374 6976 6522 2c20       ("active", 
-00016ec0: 6f70 732e 4163 7469 7665 5374 6174 7573  ops.ActiveStatus
-00016ed0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00016ee0: 2277 6169 7469 6e67 222c 206f 7073 2e57  "waiting", ops.W
-00016ef0: 6169 7469 6e67 5374 6174 7573 292c 0a20  aitingStatus),. 
-00016f00: 2020 2020 2020 2020 2020 2028 2262 6c6f             ("blo
-00016f10: 636b 6564 222c 206f 7073 2e42 6c6f 636b  cked", ops.Block
-00016f20: 6564 5374 6174 7573 292c 0a20 2020 2020  edStatus),.     
-00016f30: 2020 2020 2020 2028 226d 6169 6e74 656e         ("mainten
-00016f40: 616e 6365 222c 206f 7073 2e4d 6169 6e74  ance", ops.Maint
-00016f50: 656e 616e 6365 5374 6174 7573 292c 0a20  enanceStatus),. 
-00016f60: 2020 2020 2020 2020 2020 2028 2265 7272             ("err
-00016f70: 6f72 222c 206f 7073 2e45 7272 6f72 5374  or", ops.ErrorSt
-00016f80: 6174 7573 292c 0a20 2020 2020 2020 2029  atus),.        )
-00016f90: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-00016fa0: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
-00016fb0: 7461 2e66 726f 6d5f 7961 6d6c 2827 2727  ta.from_yaml('''
-00016fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016fd0: 206e 616d 653a 206d 7961 7070 0a20 2020   name: myapp.   
-00016fe0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-00016ff0: 2020 2020 2020 2020 2020 6d6f 6465 6c20            model 
-00017000: 3d20 6f70 732e 4d6f 6465 6c28 6d65 7461  = ops.Model(meta
-00017010: 2c20 7365 6c66 2e62 6163 6b65 6e64 290a  , self.backend).
-00017020: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00017030: 6820 7365 6c66 2e73 7562 5465 7374 286e  h self.subTest(n
-00017040: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
-00017050: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
-00017060: 6a73 6f6e 2e64 756d 7073 287b 0a20 2020  json.dumps({.   
-00017070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017080: 2022 6d65 7373 6167 6522 3a20 2266 6f6f   "message": "foo
-00017090: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000170a0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
-000170b0: 206e 616d 652c 0a20 2020 2020 2020 2020   name,.         
-000170c0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-000170d0: 7573 2d64 6174 6122 3a20 7b7d 2c0a 2020  us-data": {},.  
-000170e0: 2020 2020 2020 2020 2020 2020 2020 7d29                })
-000170f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017100: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00017110: 662c 2027 7374 6174 7573 2d67 6574 272c  f, 'status-get',
-00017120: 2066 2265 6368 6f20 277b 636f 6e74 656e   f"echo '{conten
-00017130: 747d 2722 290a 0a20 2020 2020 2020 2020  t}'")..         
-00017140: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00017150: 7274 4973 496e 7374 616e 6365 286d 6f64  rtIsInstance(mod
-00017160: 656c 2e75 6e69 742e 7374 6174 7573 2c20  el.unit.status, 
-00017170: 6578 7065 6374 6564 5f63 6c73 290a 2020  expected_cls).  
-00017180: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00017190: 6c66 2e61 7373 6572 7445 7175 616c 286d  lf.assertEqual(m
-000171a0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-000171b0: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
-000171c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000171d0: 662e 6173 7365 7274 4571 7561 6c28 6d6f  f.assertEqual(mo
-000171e0: 6465 6c2e 756e 6974 2e73 7461 7475 732e  del.unit.status.
-000171f0: 6d65 7373 6167 652c 2022 666f 6f22 290a  message, "foo").
-00017200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017210: 2063 6f6e 7465 6e74 203d 206a 736f 6e2e   content = json.
-00017220: 6475 6d70 7328 7b0a 2020 2020 2020 2020  dumps({.        
-00017230: 2020 2020 2020 2020 2020 2020 2261 7070              "app
-00017240: 6c69 6361 7469 6f6e 2d73 7461 7475 7322  lication-status"
-00017250: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00017260: 2020 2020 2020 2020 2020 2020 226d 6573              "mes
-00017270: 7361 6765 223a 2022 6261 7222 2c0a 2020  sage": "bar",.  
+00011cb0: 2075 7365 725f 6964 2c20 7573 6572 2c20   user_id, user, 
+00011cc0: 6772 6f75 705f 6964 2c20 6772 6f75 7029  group_id, group)
+00011cd0: 290a 0a20 2020 2064 6566 206c 6973 745f  )..    def list_
+00011ce0: 6669 6c65 7328 7365 6c66 2c20 7061 7468  files(self, path
+00011cf0: 2c20 2a2c 2070 6174 7465 726e 3d4e 6f6e  , *, pattern=Non
+00011d00: 652c 2069 7473 656c 663d 4661 6c73 6529  e, itself=False)
+00011d10: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
+00011d20: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
+00011d30: 276c 6973 745f 6669 6c65 7327 2c20 7061  'list_files', pa
+00011d40: 7468 2c20 7061 7474 6572 6e2c 2069 7473  th, pattern, its
+00011d50: 656c 6629 290a 2020 2020 2020 2020 7265  elf)).        re
+00011d60: 7475 726e 2073 656c 662e 7265 7370 6f6e  turn self.respon
+00011d70: 7365 732e 706f 7028 3029 0a0a 2020 2020  ses.pop(0)..    
+00011d80: 6465 6620 6d61 6b65 5f64 6972 2873 656c  def make_dir(sel
+00011d90: 662c 2070 6174 682c 202a 2c20 6d61 6b65  f, path, *, make
+00011da0: 5f70 6172 656e 7473 3d46 616c 7365 2c20  _parents=False, 
+00011db0: 7065 726d 6973 7369 6f6e 733d 4e6f 6e65  permissions=None
+00011dc0: 2c20 7573 6572 5f69 643d 4e6f 6e65 2c20  , user_id=None, 
+00011dd0: 7573 6572 3d4e 6f6e 652c 0a20 2020 2020  user=None,.     
+00011de0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00011df0: 705f 6964 3d4e 6f6e 652c 2067 726f 7570  p_id=None, group
+00011e00: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+00011e10: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
+00011e20: 7065 6e64 2828 276d 616b 655f 6469 7227  pend(('make_dir'
+00011e30: 2c20 7061 7468 2c20 6d61 6b65 5f70 6172  , path, make_par
+00011e40: 656e 7473 2c20 7065 726d 6973 7369 6f6e  ents, permission
+00011e50: 732c 2075 7365 725f 6964 2c20 7573 6572  s, user_id, user
+00011e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e80: 6772 6f75 705f 6964 2c20 6772 6f75 7029  group_id, group)
+00011e90: 290a 0a20 2020 2064 6566 2072 656d 6f76  )..    def remov
+00011ea0: 655f 7061 7468 2873 656c 662c 2070 6174  e_path(self, pat
+00011eb0: 682c 202a 2c20 7265 6375 7273 6976 653d  h, *, recursive=
+00011ec0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+00011ed0: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
+00011ee0: 7065 6e64 2828 2772 656d 6f76 655f 7061  pend(('remove_pa
+00011ef0: 7468 272c 2070 6174 682c 2072 6563 7572  th', path, recur
+00011f00: 7369 7665 2929 0a0a 2020 2020 6465 6620  sive))..    def 
+00011f10: 6578 6563 2873 656c 662c 2063 6f6d 6d61  exec(self, comma
+00011f20: 6e64 2c20 2a2a 6b77 6172 6773 293a 0a20  nd, **kwargs):. 
+00011f30: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
+00011f40: 6573 7473 2e61 7070 656e 6428 2827 6578  ests.append(('ex
+00011f50: 6563 272c 2063 6f6d 6d61 6e64 2c20 6b77  ec', command, kw
+00011f60: 6172 6773 2929 0a20 2020 2020 2020 2072  args)).        r
+00011f70: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
+00011f80: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
+00011f90: 2064 6566 2073 656e 645f 7369 676e 616c   def send_signal
+00011fa0: 2873 656c 662c 2073 6967 6e61 6c2c 2073  (self, signal, s
+00011fb0: 6572 7669 6365 5f6e 616d 6573 293a 0a20  ervice_names):. 
+00011fc0: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
+00011fd0: 6573 7473 2e61 7070 656e 6428 2827 7365  ests.append(('se
+00011fe0: 6e64 5f73 6967 6e61 6c27 2c20 7369 676e  nd_signal', sign
+00011ff0: 616c 2c20 7365 7276 6963 655f 6e61 6d65  al, service_name
+00012000: 7329 290a 0a0a 636c 6173 7320 5465 7374  s))...class Test
+00012010: 4d6f 6465 6c42 696e 6469 6e67 7328 756e  ModelBindings(un
+00012020: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
+00012030: 3a0a 0a20 2020 2064 6566 2073 6574 5570  :..    def setUp
+00012040: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00012050: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
+00012060: 4d65 7461 2829 0a20 2020 2020 2020 206d  Meta().        m
+00012070: 6574 612e 7265 6c61 7469 6f6e 7320 3d20  eta.relations = 
+00012080: 7b0a 2020 2020 2020 2020 2020 2020 2764  {.            'd
+00012090: 6230 273a 206f 7073 2e52 656c 6174 696f  b0': ops.Relatio
+000120a0: 6e4d 6574 6128 0a20 2020 2020 2020 2020  nMeta(.         
+000120b0: 2020 2020 2020 206f 7073 2e52 656c 6174         ops.Relat
+000120c0: 696f 6e52 6f6c 652e 7072 6f76 6964 6573  ionRole.provides
+000120d0: 2c20 2764 6230 272c 207b 2769 6e74 6572  , 'db0', {'inter
+000120e0: 6661 6365 273a 2027 6462 3027 2c20 2773  face': 'db0', 's
+000120f0: 636f 7065 273a 2027 676c 6f62 616c 277d  cope': 'global'}
+00012100: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
+00012110: 6462 3127 3a20 6f70 732e 5265 6c61 7469  db1': ops.Relati
+00012120: 6f6e 4d65 7461 280a 2020 2020 2020 2020  onMeta(.        
+00012130: 2020 2020 2020 2020 6f70 732e 5265 6c61          ops.Rela
+00012140: 7469 6f6e 526f 6c65 2e72 6571 7569 7265  tionRole.require
+00012150: 732c 2027 6462 3127 2c20 7b27 696e 7465  s, 'db1', {'inte
+00012160: 7266 6163 6527 3a20 2764 6231 272c 2027  rface': 'db1', '
+00012170: 7363 6f70 6527 3a20 2767 6c6f 6261 6c27  scope': 'global'
+00012180: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00012190: 2764 6232 273a 206f 7073 2e52 656c 6174  'db2': ops.Relat
+000121a0: 696f 6e4d 6574 6128 0a20 2020 2020 2020  ionMeta(.       
+000121b0: 2020 2020 2020 2020 206f 7073 2e52 656c           ops.Rel
+000121c0: 6174 696f 6e52 6f6c 652e 7065 6572 2c20  ationRole.peer, 
+000121d0: 2764 6232 272c 207b 2769 6e74 6572 6661  'db2', {'interfa
+000121e0: 6365 273a 2027 6462 3227 2c20 2773 636f  ce': 'db2', 'sco
+000121f0: 7065 273a 2027 676c 6f62 616c 277d 292c  pe': 'global'}),
+00012200: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00012210: 2020 2073 656c 662e 6261 636b 656e 6420     self.backend 
+00012220: 3d20 5f4d 6f64 656c 4261 636b 656e 6428  = _ModelBackend(
+00012230: 276d 7961 7070 2f30 2729 0a20 2020 2020  'myapp/0').     
+00012240: 2020 2073 656c 662e 6d6f 6465 6c20 3d20     self.model = 
+00012250: 6f70 732e 4d6f 6465 6c28 6d65 7461 2c20  ops.Model(meta, 
+00012260: 7365 6c66 2e62 6163 6b65 6e64 290a 0a20  self.backend).. 
+00012270: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00012280: 7074 2873 656c 662c 2027 7265 6c61 7469  pt(self, 'relati
+00012290: 6f6e 2d69 6473 272c 0a20 2020 2020 2020  on-ids',.       
+000122a0: 2020 2020 2020 2020 2020 2020 2022 2222               """
+000122b0: 285b 2022 2431 2220 3d20 6462 3020 5d20  ([ "$1" = db0 ] 
+000122c0: 2626 2065 6368 6f20 275b 2264 6230 3a34  && echo '["db0:4
+000122d0: 225d 2729 207c 7c20 6563 686f 2027 5b5d  "]') || echo '[]
+000122e0: 2722 2222 290a 2020 2020 2020 2020 6661  '""").        fa
+000122f0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00012300: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
+00012310: 2022 2222 5b20 2224 3222 203d 2034 205d   """[ "$2" = 4 ]
+00012320: 2026 2620 6563 686f 2027 5b22 7265 6d6f   && echo '["remo
+00012330: 7465 6170 7031 2f30 225d 2720 7c7c 2065  teapp1/0"]' || e
+00012340: 7869 7420 3222 2222 290a 2020 2020 2020  xit 2""").      
+00012350: 2020 7365 6c66 2e6e 6574 776f 726b 5f67    self.network_g
+00012360: 6574 5f6f 7574 203d 2027 2727 7b0a 2020  et_out = '''{.  
+00012370: 2262 696e 642d 6164 6472 6573 7365 7322  "bind-addresses"
+00012380: 3a20 5b0a 2020 2020 7b0a 2020 2020 2020  : [.    {.      
+00012390: 226d 6163 2d61 6464 7265 7373 223a 2022  "mac-address": "
+000123a0: 6465 3a61 643a 6265 3a65 663a 6361 3a66  de:ad:be:ef:ca:f
+000123b0: 6522 2c0a 2020 2020 2020 2269 6e74 6572  e",.      "inter
+000123c0: 6661 6365 2d6e 616d 6522 3a20 226c 6f22  face-name": "lo"
+000123d0: 2c0a 2020 2020 2020 2261 6464 7265 7373  ,.      "address
+000123e0: 6573 223a 205b 0a20 2020 2020 2020 207b  es": [.        {
+000123f0: 0a20 2020 2020 2020 2020 2022 686f 7374  .          "host
+00012400: 6e61 6d65 223a 2022 222c 0a20 2020 2020  name": "",.     
+00012410: 2020 2020 2022 7661 6c75 6522 3a20 2231       "value": "1
+00012420: 3932 2e30 2e32 2e32 222c 0a20 2020 2020  92.0.2.2",.     
+00012430: 2020 2020 2022 6369 6472 223a 2022 3139       "cidr": "19
+00012440: 322e 302e 322e 302f 3234 220a 2020 2020  2.0.2.0/24".    
+00012450: 2020 2020 7d2c 0a20 2020 2020 2020 207b      },.        {
+00012460: 0a20 2020 2020 2020 2020 2022 686f 7374  .          "host
+00012470: 6e61 6d65 223a 2022 6465 6164 6265 6566  name": "deadbeef
+00012480: 2e65 7861 6d70 6c65 222c 0a20 2020 2020  .example",.     
+00012490: 2020 2020 2022 7661 6c75 6522 3a20 2264       "value": "d
+000124a0: 6561 643a 6265 6566 3a3a 3122 2c0a 2020  ead:beef::1",.  
+000124b0: 2020 2020 2020 2020 2263 6964 7222 3a20          "cidr": 
+000124c0: 2264 6561 643a 6265 6566 3a3a 2f36 3422  "dead:beef::/64"
+000124d0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000124e0: 205d 0a20 2020 207d 2c0a 2020 2020 7b0a   ].    },.    {.
+000124f0: 2020 2020 2020 226d 6163 2d61 6464 7265        "mac-addre
+00012500: 7373 223a 2022 222c 0a20 2020 2020 2022  ss": "",.      "
+00012510: 696e 7465 7266 6163 652d 6e61 6d65 223a  interface-name":
+00012520: 2022 7475 6e22 2c0a 2020 2020 2020 2261   "tun",.      "a
+00012530: 6464 7265 7373 6573 223a 205b 0a20 2020  ddresses": [.   
+00012540: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00012550: 2022 686f 7374 6e61 6d65 223a 2022 222c   "hostname": "",
+00012560: 0a20 2020 2020 2020 2020 2022 7661 6c75  .          "valu
+00012570: 6522 3a20 2231 3932 2e30 2e33 2e33 222c  e": "192.0.3.3",
+00012580: 0a20 2020 2020 2020 2020 2022 6369 6472  .          "cidr
+00012590: 223a 2022 220a 2020 2020 2020 2020 7d2c  ": "".        },
+000125a0: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
+000125b0: 2020 2020 2022 686f 7374 6e61 6d65 223a       "hostname":
+000125c0: 2022 222c 0a20 2020 2020 2020 2020 2022   "",.          "
+000125d0: 7661 6c75 6522 3a20 2232 3030 313a 6462  value": "2001:db
+000125e0: 383a 3a33 222c 0a20 2020 2020 2020 2020  8::3",.         
+000125f0: 2022 6369 6472 223a 2022 220a 2020 2020   "cidr": "".    
+00012600: 2020 2020 7d2c 0a20 2020 2020 2020 207b      },.        {
+00012610: 0a20 2020 2020 2020 2020 2022 686f 7374  .          "host
+00012620: 6e61 6d65 223a 2022 6465 6164 6265 6566  name": "deadbeef
+00012630: 2e6c 6f63 616c 222c 0a20 2020 2020 2020  .local",.       
+00012640: 2020 2022 7661 6c75 6522 3a20 2266 6538     "value": "fe8
+00012650: 303a 3a31 3a31 222c 0a20 2020 2020 2020  0::1:1",.       
+00012660: 2020 2022 6369 6472 223a 2022 6665 3830     "cidr": "fe80
+00012670: 3a3a 2f36 3422 0a20 2020 2020 2020 207d  ::/64".        }
+00012680: 0a20 2020 2020 205d 0a20 2020 207d 0a20  .      ].    }. 
+00012690: 205d 2c0a 2020 2265 6772 6573 732d 7375   ],.  "egress-su
+000126a0: 626e 6574 7322 3a20 5b0a 2020 2020 2231  bnets": [.    "1
+000126b0: 3932 2e30 2e32 2e32 2f33 3222 2c0a 2020  92.0.2.2/32",.  
+000126c0: 2020 2231 3932 2e30 2e33 2e30 2f32 3422    "192.0.3.0/24"
+000126d0: 2c0a 2020 2020 2264 6561 643a 6265 6566  ,.    "dead:beef
+000126e0: 3a3a 2f36 3422 2c0a 2020 2020 2232 3030  ::/64",.    "200
+000126f0: 313a 6462 383a 3a33 2f31 3238 220a 2020  1:db8::3/128".  
+00012700: 5d2c 0a20 2022 696e 6772 6573 732d 6164  ],.  "ingress-ad
+00012710: 6472 6573 7365 7322 3a20 5b0a 2020 2020  dresses": [.    
+00012720: 2231 3932 2e30 2e32 2e32 222c 0a20 2020  "192.0.2.2",.   
+00012730: 2022 3139 322e 302e 332e 3322 2c0a 2020   "192.0.3.3",.  
+00012740: 2020 2264 6561 643a 6265 6566 3a3a 3122    "dead:beef::1"
+00012750: 2c0a 2020 2020 2232 3030 313a 6462 383a  ,.    "2001:db8:
+00012760: 3a33 220a 2020 5d0a 7d27 2727 0a0a 2020  :3".  ].}'''..  
+00012770: 2020 6465 6620 5f63 6865 636b 5f62 696e    def _check_bin
+00012780: 6469 6e67 5f64 6174 6128 7365 6c66 2c20  ding_data(self, 
+00012790: 6269 6e64 696e 675f 6e61 6d65 2c20 6269  binding_name, bi
+000127a0: 6e64 696e 6729 3a0a 2020 2020 2020 2020  nding):.        
+000127b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000127c0: 2862 696e 6469 6e67 2e6e 616d 652c 2062  (binding.name, b
+000127d0: 696e 6469 6e67 5f6e 616d 6529 0a20 2020  inding_name).   
+000127e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000127f0: 4571 7561 6c28 6269 6e64 696e 672e 6e65  Equal(binding.ne
+00012800: 7477 6f72 6b2e 6269 6e64 5f61 6464 7265  twork.bind_addre
+00012810: 7373 2c20 6970 6164 6472 6573 732e 6970  ss, ipaddress.ip
+00012820: 5f61 6464 7265 7373 2827 3139 322e 302e  _address('192.0.
+00012830: 322e 3227 2929 0a20 2020 2020 2020 2073  2.2')).        s
+00012840: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012850: 6269 6e64 696e 672e 6e65 7477 6f72 6b2e  binding.network.
+00012860: 696e 6772 6573 735f 6164 6472 6573 732c  ingress_address,
+00012870: 2069 7061 6464 7265 7373 2e69 705f 6164   ipaddress.ip_ad
+00012880: 6472 6573 7328 2731 3932 2e30 2e32 2e32  dress('192.0.2.2
+00012890: 2729 290a 2020 2020 2020 2020 2320 2f33  ')).        # /3
+000128a0: 3220 616e 6420 2f31 3238 2043 4944 5273  2 and /128 CIDRs
+000128b0: 2061 7265 2076 616c 6964 206f 6e65 2d61   are valid one-a
+000128c0: 6464 7265 7373 206e 6574 776f 726b 7320  ddress networks 
+000128d0: 666f 7220 4950 767b 342c 367d 4e65 7477  for IPv{4,6}Netw
+000128e0: 6f72 6b20 7479 7065 7320 7265 7370 6563  ork types respec
+000128f0: 7469 7665 6c79 2e0a 2020 2020 2020 2020  tively..        
+00012900: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012910: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
+00012920: 2e65 6772 6573 735f 7375 626e 6574 732c  .egress_subnets,
+00012930: 205b 6970 6164 6472 6573 732e 6970 5f6e   [ipaddress.ip_n
+00012940: 6574 776f 726b 2827 3139 322e 302e 322e  etwork('192.0.2.
+00012950: 322f 3332 2729 2c0a 2020 2020 2020 2020  2/32'),.        
+00012960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012990: 2020 6970 6164 6472 6573 732e 6970 5f6e    ipaddress.ip_n
+000129a0: 6574 776f 726b 2827 3139 322e 302e 332e  etwork('192.0.3.
+000129b0: 302f 3234 2729 2c0a 2020 2020 2020 2020  0/24'),.        
+000129c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129f0: 2020 6970 6164 6472 6573 732e 6970 5f6e    ipaddress.ip_n
+00012a00: 6574 776f 726b 2827 6465 6164 3a62 6565  etwork('dead:bee
+00012a10: 663a 3a2f 3634 2729 2c0a 2020 2020 2020  f::/64'),.      
+00012a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2020 2020 6970 6164 6472 6573 732e 6970      ipaddress.ip
+00012a60: 5f6e 6574 776f 726b 2827 3230 3031 3a64  _network('2001:d
+00012a70: 6238 3a3a 332f 3132 3827 295d 290a 0a20  b8::3/128')]).. 
+00012a80: 2020 2020 2020 2066 6f72 2028 692c 2028         for (i, (
+00012a90: 6e61 6d65 2c20 6164 6472 6573 732c 2073  name, address, s
+00012aa0: 7562 6e65 7429 2920 696e 2065 6e75 6d65  ubnet)) in enume
+00012ab0: 7261 7465 285b 0a20 2020 2020 2020 2020  rate([.         
+00012ac0: 2020 2020 2020 2028 276c 6f27 2c20 2731         ('lo', '1
+00012ad0: 3932 2e30 2e32 2e32 272c 2027 3139 322e  92.0.2.2', '192.
+00012ae0: 302e 322e 302f 3234 2729 2c0a 2020 2020  0.2.0/24'),.    
+00012af0: 2020 2020 2020 2020 2020 2020 2827 6c6f              ('lo
+00012b00: 272c 2027 6465 6164 3a62 6565 663a 3a31  ', 'dead:beef::1
+00012b10: 272c 2027 6465 6164 3a62 6565 663a 3a2f  ', 'dead:beef::/
+00012b20: 3634 2729 2c0a 2020 2020 2020 2020 2020  64'),.          
+00012b30: 2020 2020 2020 2827 7475 6e27 2c20 2731        ('tun', '1
+00012b40: 3932 2e30 2e33 2e33 272c 2027 3139 322e  92.0.3.3', '192.
+00012b50: 302e 332e 332f 3332 2729 2c0a 2020 2020  0.3.3/32'),.    
+00012b60: 2020 2020 2020 2020 2020 2020 2827 7475              ('tu
+00012b70: 6e27 2c20 2732 3030 313a 6462 383a 3a33  n', '2001:db8::3
+00012b80: 272c 2027 3230 3031 3a64 6238 3a3a 332f  ', '2001:db8::3/
+00012b90: 3132 3827 292c 0a20 2020 2020 2020 2020  128'),.         
+00012ba0: 2020 2020 2020 2028 2774 756e 272c 2027         ('tun', '
+00012bb0: 6665 3830 3a3a 313a 3127 2c20 2766 6538  fe80::1:1', 'fe8
+00012bc0: 303a 3a2f 3634 2729 5d29 3a0a 2020 2020  0::/64')]):.    
+00012bd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00012be0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00012bf0: 2e6e 6574 776f 726b 2e69 6e74 6572 6661  .network.interfa
+00012c00: 6365 735b 695d 2e6e 616d 652c 206e 616d  ces[i].name, nam
+00012c10: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+00012c20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012c30: 6269 6e64 696e 672e 6e65 7477 6f72 6b2e  binding.network.
+00012c40: 696e 7465 7266 6163 6573 5b69 5d2e 6164  interfaces[i].ad
+00012c50: 6472 6573 732c 2069 7061 6464 7265 7373  dress, ipaddress
+00012c60: 2e69 705f 6164 6472 6573 7328 6164 6472  .ip_address(addr
+00012c70: 6573 7329 290a 2020 2020 2020 2020 2020  ess)).          
+00012c80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00012c90: 616c 2862 696e 6469 6e67 2e6e 6574 776f  al(binding.netwo
+00012ca0: 726b 2e69 6e74 6572 6661 6365 735b 695d  rk.interfaces[i]
+00012cb0: 2e73 7562 6e65 742c 2069 7061 6464 7265  .subnet, ipaddre
+00012cc0: 7373 2e69 705f 6e65 7477 6f72 6b28 7375  ss.ip_network(su
+00012cd0: 626e 6574 2929 0a0a 2020 2020 2020 2020  bnet))..        
+00012ce0: 666f 7220 2869 2c20 286e 616d 652c 2061  for (i, (name, a
+00012cf0: 6464 7265 7373 2c20 7375 626e 6574 2929  ddress, subnet))
+00012d00: 2069 6e20 656e 756d 6572 6174 6528 5b0a   in enumerate([.
+00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d20: 2827 6c6f 272c 2027 3139 322e 302e 322e  ('lo', '192.0.2.
+00012d30: 3227 2c20 2731 3932 2e30 2e32 2e30 2f32  2', '192.0.2.0/2
+00012d40: 3427 292c 0a20 2020 2020 2020 2020 2020  4'),.           
+00012d50: 2020 2020 2028 276c 6f27 2c20 2764 6561       ('lo', 'dea
+00012d60: 643a 6265 6566 3a3a 3127 2c20 2764 6561  d:beef::1', 'dea
+00012d70: 643a 6265 6566 3a3a 2f36 3427 292c 0a20  d:beef::/64'),. 
+00012d80: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00012d90: 2774 756e 272c 2027 3139 322e 302e 332e  'tun', '192.0.3.
+00012da0: 3327 2c20 2731 3932 2e30 2e33 2e33 2f33  3', '192.0.3.3/3
+00012db0: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+00012dc0: 2020 2020 2028 2774 756e 272c 2027 3230       ('tun', '20
+00012dd0: 3031 3a64 6238 3a3a 3327 2c20 2732 3030  01:db8::3', '200
+00012de0: 313a 6462 383a 3a33 2f31 3238 2729 2c0a  1:db8::3/128'),.
+00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e00: 2827 7475 6e27 2c20 2766 6538 303a 3a31  ('tun', 'fe80::1
+00012e10: 3a31 272c 2027 6665 3830 3a3a 2f36 3427  :1', 'fe80::/64'
+00012e20: 295d 293a 0a20 2020 2020 2020 2020 2020  )]):.           
+00012e30: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00012e40: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
+00012e50: 6b2e 696e 7465 7266 6163 6573 5b69 5d2e  k.interfaces[i].
+00012e60: 6e61 6d65 2c20 6e61 6d65 290a 2020 2020  name, name).    
+00012e70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00012e80: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00012e90: 2e6e 6574 776f 726b 2e69 6e74 6572 6661  .network.interfa
+00012ea0: 6365 735b 695d 2e61 6464 7265 7373 2c20  ces[i].address, 
+00012eb0: 6970 6164 6472 6573 732e 6970 5f61 6464  ipaddress.ip_add
+00012ec0: 7265 7373 2861 6464 7265 7373 2929 0a20  ress(address)). 
+00012ed0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00012ee0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+00012ef0: 696e 672e 6e65 7477 6f72 6b2e 696e 7465  ing.network.inte
+00012f00: 7266 6163 6573 5b69 5d2e 7375 626e 6574  rfaces[i].subnet
+00012f10: 2c20 6970 6164 6472 6573 732e 6970 5f6e  , ipaddress.ip_n
+00012f20: 6574 776f 726b 2873 7562 6e65 7429 290a  etwork(subnet)).
+00012f30: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
+00012f40: 7661 6c69 645f 6b65 7973 2873 656c 6629  valid_keys(self)
+00012f50: 3a0a 2020 2020 2020 2020 2320 4261 7369  :.        # Basi
+00012f60: 6320 7661 6c69 6461 7469 6f6e 2066 6f72  c validation for
+00012f70: 2070 6173 7369 6e67 2069 6e76 616c 6964   passing invalid
+00012f80: 206b 6579 732e 0a20 2020 2020 2020 2066   keys..        f
+00012f90: 6f72 206e 616d 6520 696e 2028 6f62 6a65  or name in (obje
+00012fa0: 6374 2c20 3029 3a0a 2020 2020 2020 2020  ct, 0):.        
+00012fb0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00012fc0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+00012fd0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+00012fe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012ff0: 2e6d 6f64 656c 2e67 6574 5f62 696e 6469  .model.get_bindi
+00013000: 6e67 286e 616d 6529 0a0a 2020 2020 6465  ng(name)..    de
+00013010: 6620 7465 7374 5f64 6561 645f 7265 6c61  f test_dead_rela
+00013020: 7469 6f6e 7328 7365 6c66 293a 0a20 2020  tions(self):.   
+00013030: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00013040: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00013050: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00013060: 276e 6574 776f 726b 2d67 6574 272c 0a20  'network-get',. 
+00013070: 2020 2020 2020 2020 2020 2066 2727 270a             f'''.
+00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013090: 6966 205b 2022 2431 2220 3d20 6462 3020  if [ "$1" = db0 
+000130a0: 5d20 2626 205b 2022 2432 2220 3d20 2d2d  ] && [ "$2" = --
+000130b0: 666f 726d 6174 3d6a 736f 6e20 5d3b 2074  format=json ]; t
+000130c0: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
+000130d0: 2020 2020 2020 2020 6563 686f 2027 7b73          echo '{s
+000130e0: 656c 662e 6e65 7477 6f72 6b5f 6765 745f  elf.network_get_
+000130f0: 6f75 747d 270a 2020 2020 2020 2020 2020  out}'.          
+00013100: 2020 2020 2020 656c 7365 0a20 2020 2020        else.     
+00013110: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00013120: 6368 6f20 4552 524f 5220 696e 7661 6c69  cho ERROR invali
+00013130: 6420 7661 6c75 6520 2224 3222 2066 6f72  d value "$2" for
+00013140: 206f 7074 696f 6e20 2d72 3a20 7265 6c61   option -r: rela
+00013150: 7469 6f6e 206e 6f74 2066 6f75 6e64 203e  tion not found >
+00013160: 2632 0a20 2020 2020 2020 2020 2020 2020  &2.             
+00013170: 2020 2020 2020 2065 7869 7420 320a 2020         exit 2.  
+00013180: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00013190: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+000131a0: 290a 2020 2020 2020 2020 2320 5661 6c69  ).        # Vali
+000131b0: 6461 7465 2074 6865 2062 6568 6176 696f  date the behavio
+000131c0: 7220 666f 7220 6465 6164 2072 656c 6174  r for dead relat
+000131d0: 696f 6e73 2e0a 2020 2020 2020 2020 6269  ions..        bi
+000131e0: 6e64 696e 6720 3d20 6f70 732e 4269 6e64  nding = ops.Bind
+000131f0: 696e 6728 2764 6230 272c 2034 322c 2073  ing('db0', 42, s
+00013200: 656c 662e 6d6f 6465 6c2e 5f62 6163 6b65  elf.model._backe
+00013210: 6e64 290a 2020 2020 2020 2020 7365 6c66  nd).        self
+00013220: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
+00013230: 6469 6e67 2e6e 6574 776f 726b 2e62 696e  ding.network.bin
+00013240: 645f 6164 6472 6573 732c 2069 7061 6464  d_address, ipadd
+00013250: 7265 7373 2e69 705f 6164 6472 6573 7328  ress.ip_address(
+00013260: 2731 3932 2e30 2e32 2e32 2729 290a 2020  '192.0.2.2')).  
+00013270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013280: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+00013290: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+000132a0: 6c65 6172 3d54 7275 6529 2c20 5b0a 2020  lear=True), [.  
+000132b0: 2020 2020 2020 2020 2020 5b27 6e65 7477            ['netw
+000132c0: 6f72 6b2d 6765 7427 2c20 2764 6230 272c  ork-get', 'db0',
+000132d0: 2027 2d72 272c 2027 3432 272c 2027 2d2d   '-r', '42', '--
+000132e0: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+000132f0: 2020 2020 2020 2020 2020 205b 276e 6574             ['net
+00013300: 776f 726b 2d67 6574 272c 2027 6462 3027  work-get', 'db0'
+00013310: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+00013320: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+00013330: 2020 2020 6465 6620 7465 7374 5f62 696e      def test_bin
+00013340: 6469 6e67 5f62 795f 7265 6c61 7469 6f6e  ding_by_relation
+00013350: 5f6e 616d 6528 7365 6c66 293a 0a20 2020  _name(self):.   
+00013360: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00013370: 2873 656c 662c 2027 6e65 7477 6f72 6b2d  (self, 'network-
+00013380: 6765 7427 2c0a 2020 2020 2020 2020 2020  get',.          
+00013390: 2020 2020 2020 2020 2020 6627 2727 5b20            f'''[ 
+000133a0: 2224 3122 203d 2064 6230 205d 2026 2620  "$1" = db0 ] && 
+000133b0: 6563 686f 2027 7b73 656c 662e 6e65 7477  echo '{self.netw
+000133c0: 6f72 6b5f 6765 745f 6f75 747d 2720 7c7c  ork_get_out}' ||
+000133d0: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
+000133e0: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
+000133f0: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
+00013400: 2065 7870 6563 7465 645f 6361 6c6c 7320   expected_calls 
+00013410: 3d20 5b5b 276e 6574 776f 726b 2d67 6574  = [['network-get
+00013420: 272c 2027 6462 3027 2c20 272d 2d66 6f72  ', 'db0', '--for
+00013430: 6d61 743d 6a73 6f6e 275d 5d0a 0a20 2020  mat=json']]..   
+00013440: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
+00013450: 656c 662e 6d6f 6465 6c2e 6765 745f 6269  elf.model.get_bi
+00013460: 6e64 696e 6728 6269 6e64 696e 675f 6e61  nding(binding_na
+00013470: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
+00013480: 2e5f 6368 6563 6b5f 6269 6e64 696e 675f  ._check_binding_
+00013490: 6461 7461 2862 696e 6469 6e67 5f6e 616d  data(binding_nam
+000134a0: 652c 2062 696e 6469 6e67 290a 2020 2020  e, binding).    
+000134b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000134c0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+000134d0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+000134e0: 6172 3d54 7275 6529 2c20 6578 7065 6374  ar=True), expect
+000134f0: 6564 5f63 616c 6c73 290a 0a20 2020 2064  ed_calls)..    d
+00013500: 6566 2074 6573 745f 6269 6e64 696e 675f  ef test_binding_
+00013510: 6279 5f72 656c 6174 696f 6e28 7365 6c66  by_relation(self
+00013520: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+00013530: 7363 7269 7074 2873 656c 662c 2027 6e65  script(self, 'ne
+00013540: 7477 6f72 6b2d 6765 7427 2c0a 2020 2020  twork-get',.    
+00013550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013560: 6627 2727 5b20 2224 3122 203d 2064 6230  f'''[ "$1" = db0
+00013570: 205d 2026 2620 6563 686f 2027 7b73 656c   ] && echo '{sel
+00013580: 662e 6e65 7477 6f72 6b5f 6765 745f 6f75  f.network_get_ou
+00013590: 747d 2720 7c7c 2065 7869 7420 3127 2727  t}' || exit 1'''
+000135a0: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
+000135b0: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
+000135c0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+000135d0: 6361 6c6c 7320 3d20 5b0a 2020 2020 2020  calls = [.      
+000135e0: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
+000135f0: 2d69 6473 272c 2027 6462 3027 2c20 272d  -ids', 'db0', '-
+00013600: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+00013610: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00013620: 6520 7477 6f20 696e 766f 6361 7469 6f6e  e two invocation
+00013630: 7320 6265 6c6f 7720 6172 6520 6475 6520  s below are due 
+00013640: 746f 2074 6865 2067 6574 5f72 656c 6174  to the get_relat
+00013650: 696f 6e20 6361 6c6c 2e0a 2020 2020 2020  ion call..      
+00013660: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
+00013670: 2d6c 6973 7427 2c20 272d 7227 2c20 2734  -list', '-r', '4
+00013680: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+00013690: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
+000136a0: 205b 276e 6574 776f 726b 2d67 6574 272c   ['network-get',
+000136b0: 2027 6462 3027 2c20 272d 7227 2c20 2734   'db0', '-r', '4
+000136c0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+000136d0: 6e27 5d2c 0a20 2020 2020 2020 205d 0a20  n'],.        ]. 
+000136e0: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
+000136f0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00013700: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
+00013710: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+00013720: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
+00013730: 2020 2020 2020 2073 656c 662e 5f63 6865         self._che
+00013740: 636b 5f62 696e 6469 6e67 5f64 6174 6128  ck_binding_data(
+00013750: 6269 6e64 696e 675f 6e61 6d65 2c20 6269  binding_name, bi
+00013760: 6e64 696e 6729 0a20 2020 2020 2020 2073  nding).        s
+00013770: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00013780: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+00013790: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+000137a0: 7565 292c 2065 7870 6563 7465 645f 6361  ue), expected_ca
+000137b0: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+000137c0: 7374 5f62 696e 6469 6e67 5f6e 6f5f 6966  st_binding_no_if
+000137d0: 6163 655f 6e61 6d65 2873 656c 6629 3a0a  ace_name(self):.
+000137e0: 2020 2020 2020 2020 6e65 7477 6f72 6b5f          network_
+000137f0: 6765 745f 6f75 745f 6f62 6a20 3d20 7b0a  get_out_obj = {.
+00013800: 2020 2020 2020 2020 2020 2020 2762 696e              'bin
+00013810: 642d 6164 6472 6573 7365 7327 3a20 5b0a  d-addresses': [.
+00013820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013830: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00013840: 2020 2020 2020 276d 6163 2d61 6464 7265        'mac-addre
+00013850: 7373 273a 2027 272c 0a20 2020 2020 2020  ss': '',.       
+00013860: 2020 2020 2020 2020 2020 2020 2027 696e               'in
+00013870: 7465 7266 6163 652d 6e61 6d65 273a 2027  terface-name': '
+00013880: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00013890: 2020 2020 2020 2027 6164 6472 6573 7365         'addresse
+000138a0: 7327 3a20 5b0a 2020 2020 2020 2020 2020  s': [.          
+000138b0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138d0: 2020 2020 2020 2020 2020 2020 2768 6f73              'hos
+000138e0: 746e 616d 6527 3a20 2727 2c0a 2020 2020  tname': '',.    
+000138f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013900: 2020 2020 2020 2020 2776 616c 7565 273a          'value':
+00013910: 2027 3130 2e31 2e38 392e 3335 272c 0a20   '10.1.89.35',. 
+00013920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013930: 2020 2020 2020 2020 2020 2027 6369 6472             'cidr
+00013940: 273a 2027 270a 2020 2020 2020 2020 2020  ': ''.          
+00013950: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00013960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013970: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00013980: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00013990: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+000139a0: 2020 2027 6567 7265 7373 2d73 7562 6e65     'egress-subne
+000139b0: 7473 273a 205b 0a20 2020 2020 2020 2020  ts': [.         
+000139c0: 2020 2020 2020 2027 3130 2e31 3532 2e31         '10.152.1
+000139d0: 3833 2e31 3538 2f33 3227 0a20 2020 2020  83.158/32'.     
+000139e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000139f0: 2020 2020 2020 2769 6e67 7265 7373 2d61        'ingress-a
+00013a00: 6464 7265 7373 6573 273a 205b 0a20 2020  ddresses': [.   
+00013a10: 2020 2020 2020 2020 2020 2020 2027 3130               '10
+00013a20: 2e31 3532 2e31 3833 2e31 3538 270a 2020  .152.183.158'.  
+00013a30: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+00013a40: 2020 2020 7d0a 2020 2020 2020 2020 6e65      }.        ne
+00013a50: 7477 6f72 6b5f 6765 745f 6f75 7420 3d20  twork_get_out = 
+00013a60: 6a73 6f6e 2e64 756d 7073 286e 6574 776f  json.dumps(netwo
+00013a70: 726b 5f67 6574 5f6f 7574 5f6f 626a 290a  rk_get_out_obj).
+00013a80: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00013a90: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
+00013aa0: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
+00013ab0: 2020 2020 2020 2020 2020 2020 2066 2727               f''
+00013ac0: 275b 2022 2431 2220 3d20 6462 3020 5d20  '[ "$1" = db0 ] 
+00013ad0: 2626 2065 6368 6f20 277b 6e65 7477 6f72  && echo '{networ
+00013ae0: 6b5f 6765 745f 6f75 747d 2720 7c7c 2065  k_get_out}' || e
+00013af0: 7869 7420 3127 2727 290a 2020 2020 2020  xit 1''').      
+00013b00: 2020 6269 6e64 696e 675f 6e61 6d65 203d    binding_name =
+00013b10: 2027 6462 3027 0a20 2020 2020 2020 2065   'db0'.        e
+00013b20: 7870 6563 7465 645f 6361 6c6c 7320 3d20  xpected_calls = 
+00013b30: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
+00013b40: 2027 6462 3027 2c20 272d 2d66 6f72 6d61   'db0', '--forma
+00013b50: 743d 6a73 6f6e 275d 5d0a 0a20 2020 2020  t=json']]..     
+00013b60: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
+00013b70: 662e 6d6f 6465 6c2e 6765 745f 6269 6e64  f.model.get_bind
+00013b80: 696e 6728 6269 6e64 696e 675f 6e61 6d65  ing(binding_name
+00013b90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013ba0: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+00013bb0: 6e67 2e6e 616d 652c 2027 6462 3027 290a  ng.name, 'db0').
+00013bc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013bd0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00013be0: 2e6e 6574 776f 726b 2e62 696e 645f 6164  .network.bind_ad
+00013bf0: 6472 6573 732c 2069 7061 6464 7265 7373  dress, ipaddress
+00013c00: 2e69 705f 6164 6472 6573 7328 2731 302e  .ip_address('10.
+00013c10: 312e 3839 2e33 3527 2929 0a20 2020 2020  1.89.35')).     
+00013c20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00013c30: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00013c40: 6f72 6b2e 696e 6772 6573 735f 6164 6472  ork.ingress_addr
+00013c50: 6573 732c 2069 7061 6464 7265 7373 2e69  ess, ipaddress.i
+00013c60: 705f 6164 6472 6573 7328 2731 302e 3135  p_address('10.15
+00013c70: 322e 3138 332e 3135 3827 2929 0a20 2020  2.183.158')).   
+00013c80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013c90: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+00013ca0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+00013cb0: 6561 723d 5472 7565 292c 2065 7870 6563  ear=True), expec
+00013cc0: 7465 645f 6361 6c6c 7329 0a0a 2020 2020  ted_calls)..    
+00013cd0: 6465 6620 7465 7374 5f6d 6973 7369 6e67  def test_missing
+00013ce0: 5f62 696e 645f 6164 6472 6573 7365 7328  _bind_addresses(
+00013cf0: 7365 6c66 293a 0a20 2020 2020 2020 206e  self):.        n
+00013d00: 6574 776f 726b 5f64 6174 6120 3d20 6a73  etwork_data = js
+00013d10: 6f6e 2e64 756d 7073 287b 7d29 0a20 2020  on.dumps({}).   
+00013d20: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00013d30: 2873 656c 662c 2027 6e65 7477 6f72 6b2d  (self, 'network-
+00013d40: 6765 7427 2c0a 2020 2020 2020 2020 2020  get',.          
+00013d50: 2020 2020 2020 2020 2020 6627 2727 5b20            f'''[ 
+00013d60: 2224 3122 203d 2064 6230 205d 2026 2620  "$1" = db0 ] && 
+00013d70: 6563 686f 2027 7b6e 6574 776f 726b 5f64  echo '{network_d
+00013d80: 6174 617d 2720 7c7c 2065 7869 7420 3127  ata}' || exit 1'
+00013d90: 2727 290a 2020 2020 2020 2020 6269 6e64  '').        bind
+00013da0: 696e 675f 6e61 6d65 203d 2027 6462 3027  ing_name = 'db0'
+00013db0: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
+00013dc0: 203d 2073 656c 662e 6d6f 6465 6c2e 6765   = self.model.ge
+00013dd0: 745f 6269 6e64 696e 6728 7365 6c66 2e6d  t_binding(self.m
+00013de0: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+00013df0: 6e28 6269 6e64 696e 675f 6e61 6d65 2929  n(binding_name))
+00013e00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00013e10: 7365 7274 4571 7561 6c28 6269 6e64 696e  sertEqual(bindin
+00013e20: 672e 6e65 7477 6f72 6b2e 696e 7465 7266  g.network.interf
+00013e30: 6163 6573 2c20 5b5d 290a 0a20 2020 2064  aces, [])..    d
+00013e40: 6566 2074 6573 745f 656d 7074 795f 6269  ef test_empty_bi
+00013e50: 6e64 5f61 6464 7265 7373 6573 2873 656c  nd_addresses(sel
+00013e60: 6629 3a0a 2020 2020 2020 2020 6e65 7477  f):.        netw
+00013e70: 6f72 6b5f 6461 7461 203d 206a 736f 6e2e  ork_data = json.
+00013e80: 6475 6d70 7328 7b27 6269 6e64 2d61 6464  dumps({'bind-add
+00013e90: 7265 7373 6573 273a 205b 7b7d 5d7d 290a  resses': [{}]}).
+00013ea0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00013eb0: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
+00013ec0: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
+00013ed0: 2020 2020 2020 2020 2020 2020 2066 2727               f''
+00013ee0: 275b 2022 2431 2220 3d20 6462 3020 5d20  '[ "$1" = db0 ] 
+00013ef0: 2626 2065 6368 6f20 277b 6e65 7477 6f72  && echo '{networ
+00013f00: 6b5f 6461 7461 7d27 207c 7c20 6578 6974  k_data}' || exit
+00013f10: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
+00013f20: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
+00013f30: 6230 270a 2020 2020 2020 2020 6269 6e64  b0'.        bind
+00013f40: 696e 6720 3d20 7365 6c66 2e6d 6f64 656c  ing = self.model
+00013f50: 2e67 6574 5f62 696e 6469 6e67 2873 656c  .get_binding(sel
+00013f60: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+00013f70: 7469 6f6e 2862 696e 6469 6e67 5f6e 616d  tion(binding_nam
+00013f80: 6529 290a 2020 2020 2020 2020 7365 6c66  e)).        self
+00013f90: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
+00013fa0: 6469 6e67 2e6e 6574 776f 726b 2e69 6e74  ding.network.int
+00013fb0: 6572 6661 6365 732c 205b 5d29 0a0a 2020  erfaces, [])..  
+00013fc0: 2020 6465 6620 7465 7374 5f6e 6f5f 6269    def test_no_bi
+00013fd0: 6e64 5f61 6464 7265 7373 6573 2873 656c  nd_addresses(sel
+00013fe0: 6629 3a0a 2020 2020 2020 2020 6e65 7477  f):.        netw
+00013ff0: 6f72 6b5f 6461 7461 203d 206a 736f 6e2e  ork_data = json.
+00014000: 6475 6d70 7328 7b27 6269 6e64 2d61 6464  dumps({'bind-add
+00014010: 7265 7373 6573 273a 205b 7b27 6164 6472  resses': [{'addr
+00014020: 6573 7365 7327 3a20 4e6f 6e65 7d5d 7d29  esses': None}]})
+00014030: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00014040: 7269 7074 2873 656c 662c 2027 6e65 7477  ript(self, 'netw
+00014050: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
+00014060: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014070: 2727 5b20 2224 3122 203d 2064 6230 205d  ''[ "$1" = db0 ]
+00014080: 2026 2620 6563 686f 2027 7b6e 6574 776f   && echo '{netwo
+00014090: 726b 5f64 6174 617d 2720 7c7c 2065 7869  rk_data}' || exi
+000140a0: 7420 3127 2727 290a 2020 2020 2020 2020  t 1''').        
+000140b0: 6269 6e64 696e 675f 6e61 6d65 203d 2027  binding_name = '
+000140c0: 6462 3027 0a20 2020 2020 2020 2062 696e  db0'.        bin
+000140d0: 6469 6e67 203d 2073 656c 662e 6d6f 6465  ding = self.mode
+000140e0: 6c2e 6765 745f 6269 6e64 696e 6728 7365  l.get_binding(se
+000140f0: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00014100: 6174 696f 6e28 6269 6e64 696e 675f 6e61  ation(binding_na
+00014110: 6d65 2929 0a20 2020 2020 2020 2073 656c  me)).        sel
+00014120: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+00014130: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+00014140: 7465 7266 6163 6573 2c20 5b5d 290a 0a20  terfaces, []).. 
+00014150: 2020 2064 6566 2074 6573 745f 656d 7074     def test_empt
+00014160: 795f 696e 7465 7266 6163 655f 696e 666f  y_interface_info
+00014170: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00014180: 6e65 7477 6f72 6b5f 6461 7461 203d 206a  network_data = j
+00014190: 736f 6e2e 6475 6d70 7328 7b0a 2020 2020  son.dumps({.    
+000141a0: 2020 2020 2020 2020 2762 696e 642d 6164          'bind-ad
+000141b0: 6472 6573 7365 7327 3a20 5b7b 0a20 2020  dresses': [{.   
+000141c0: 2020 2020 2020 2020 2020 2020 2027 696e               'in
+000141d0: 7465 7266 6163 652d 6e61 6d65 273a 2027  terface-name': '
+000141e0: 6574 6830 272c 0a20 2020 2020 2020 2020  eth0',.         
+000141f0: 2020 2020 2020 2027 6164 6472 6573 7365         'addresse
+00014200: 7327 3a20 5b7b 7d5d 2c0a 2020 2020 2020  s': [{}],.      
+00014210: 2020 2020 2020 7d5d 2c0a 2020 2020 2020        }],.      
+00014220: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
+00014230: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00014240: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
+00014250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014260: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
+00014270: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
+00014280: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
+00014290: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
+000142a0: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
+000142b0: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
+000142c0: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
+000142d0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+000142e0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
+000142f0: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
+00014300: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
+00014310: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00014320: 6c28 6c65 6e28 6269 6e64 696e 672e 6e65  l(len(binding.ne
+00014330: 7477 6f72 6b2e 696e 7465 7266 6163 6573  twork.interfaces
+00014340: 292c 2031 290a 2020 2020 2020 2020 696e  ), 1).        in
+00014350: 7465 7266 6163 6520 3d20 6269 6e64 696e  terface = bindin
+00014360: 672e 6e65 7477 6f72 6b2e 696e 7465 7266  g.network.interf
+00014370: 6163 6573 5b30 5d0a 2020 2020 2020 2020  aces[0].        
+00014380: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+00014390: 6528 696e 7465 7266 6163 652e 6164 6472  e(interface.addr
+000143a0: 6573 7329 0a20 2020 2020 2020 2073 656c  ess).        sel
+000143b0: 662e 6173 7365 7274 4973 4e6f 6e65 2869  f.assertIsNone(i
+000143c0: 6e74 6572 6661 6365 2e73 7562 6e65 7429  nterface.subnet)
+000143d0: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
+000143e0: 6973 7369 6e67 5f69 6e67 7265 7373 5f61  issing_ingress_a
+000143f0: 6464 7265 7373 6573 2873 656c 6629 3a0a  ddresses(self):.
+00014400: 2020 2020 2020 2020 6e65 7477 6f72 6b5f          network_
+00014410: 6461 7461 203d 206a 736f 6e2e 6475 6d70  data = json.dump
+00014420: 7328 7b0a 2020 2020 2020 2020 2020 2020  s({.            
+00014430: 2762 696e 642d 6164 6472 6573 7365 7327  'bind-addresses'
+00014440: 3a20 5b5d 2c0a 2020 2020 2020 2020 7d29  : [],.        })
+00014450: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00014460: 7269 7074 2873 656c 662c 2027 6e65 7477  ript(self, 'netw
+00014470: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
+00014480: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014490: 2727 5b20 2224 3122 203d 2064 6230 205d  ''[ "$1" = db0 ]
+000144a0: 2026 2620 6563 686f 2027 7b6e 6574 776f   && echo '{netwo
+000144b0: 726b 5f64 6174 617d 2720 7c7c 2065 7869  rk_data}' || exi
+000144c0: 7420 3127 2727 290a 2020 2020 2020 2020  t 1''').        
+000144d0: 6269 6e64 696e 675f 6e61 6d65 203d 2027  binding_name = '
+000144e0: 6462 3027 0a20 2020 2020 2020 2062 696e  db0'.        bin
+000144f0: 6469 6e67 203d 2073 656c 662e 6d6f 6465  ding = self.mode
+00014500: 6c2e 6765 745f 6269 6e64 696e 6728 7365  l.get_binding(se
+00014510: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00014520: 6174 696f 6e28 6269 6e64 696e 675f 6e61  ation(binding_na
+00014530: 6d65 2929 0a20 2020 2020 2020 2073 656c  me)).        sel
+00014540: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+00014550: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+00014560: 6772 6573 735f 6164 6472 6573 7365 732c  gress_addresses,
+00014570: 205b 5d29 0a20 2020 2020 2020 2073 656c   []).        sel
+00014580: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+00014590: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+000145a0: 6772 6573 735f 6164 6472 6573 732c 204e  gress_address, N
+000145b0: 6f6e 6529 0a0a 2020 2020 6465 6620 7465  one)..    def te
+000145c0: 7374 5f6d 6973 7369 6e67 5f65 6772 6573  st_missing_egres
+000145d0: 735f 7375 626e 6574 7328 7365 6c66 293a  s_subnets(self):
+000145e0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
+000145f0: 5f64 6174 6120 3d20 6a73 6f6e 2e64 756d  _data = json.dum
+00014600: 7073 287b 0a20 2020 2020 2020 2020 2020  ps({.           
+00014610: 2027 6269 6e64 2d61 6464 7265 7373 6573   'bind-addresses
+00014620: 273a 205b 5d2c 0a20 2020 2020 2020 2020  ': [],.         
+00014630: 2020 2027 696e 6772 6573 732d 6164 6472     'ingress-addr
+00014640: 6573 7365 7327 3a20 5b5d 2c0a 2020 2020  esses': [],.    
+00014650: 2020 2020 7d29 0a20 2020 2020 2020 2066      }).        f
+00014660: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00014670: 2027 6e65 7477 6f72 6b2d 6765 7427 2c0a   'network-get',.
+00014680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014690: 2020 2020 6627 2727 5b20 2224 3122 203d      f'''[ "$1" =
+000146a0: 2064 6230 205d 2026 2620 6563 686f 2027   db0 ] && echo '
+000146b0: 7b6e 6574 776f 726b 5f64 6174 617d 2720  {network_data}' 
+000146c0: 7c7c 2065 7869 7420 3127 2727 290a 2020  || exit 1''').  
+000146d0: 2020 2020 2020 6269 6e64 696e 675f 6e61        binding_na
+000146e0: 6d65 203d 2027 6462 3027 0a20 2020 2020  me = 'db0'.     
+000146f0: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
+00014700: 662e 6d6f 6465 6c2e 6765 745f 6269 6e64  f.model.get_bind
+00014710: 696e 6728 7365 6c66 2e6d 6f64 656c 2e67  ing(self.model.g
+00014720: 6574 5f72 656c 6174 696f 6e28 6269 6e64  et_relation(bind
+00014730: 696e 675f 6e61 6d65 2929 0a20 2020 2020  ing_name)).     
+00014740: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00014750: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00014760: 6f72 6b2e 6567 7265 7373 5f73 7562 6e65  ork.egress_subne
+00014770: 7473 2c20 5b5d 290a 0a20 2020 2064 6566  ts, [])..    def
+00014780: 2074 6573 745f 756e 7265 736f 6c76 6564   test_unresolved
+00014790: 5f69 6e67 7265 7373 5f61 6464 7265 7373  _ingress_address
+000147a0: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
+000147b0: 2020 2320 736f 6d65 7469 6d65 7320 6a75    # sometimes ju
+000147c0: 6a75 2066 6169 6c73 2074 6f20 7265 736f  ju fails to reso
+000147d0: 6c76 6520 616e 2075 726c 2074 6f20 616e  lve an url to an
+000147e0: 2049 502c 2069 6e20 7768 6963 6820 6361   IP, in which ca
+000147f0: 7365 0a20 2020 2020 2020 2023 2069 6e67  se.        # ing
+00014800: 7265 7373 2d61 6464 7265 7373 6573 2077  ress-addresses w
+00014810: 696c 6c20 6265 2074 6865 2027 7261 7727  ill be the 'raw'
+00014820: 2075 726c 2069 6e73 7465 6164 206f 6620   url instead of 
+00014830: 616e 2049 502e 0a20 2020 2020 2020 206e  an IP..        n
+00014840: 6574 776f 726b 5f64 6174 6120 3d20 6a73  etwork_data = js
+00014850: 6f6e 2e64 756d 7073 287b 0a20 2020 2020  on.dumps({.     
+00014860: 2020 2020 2020 2027 696e 6772 6573 732d         'ingress-
+00014870: 6164 6472 6573 7365 7327 3a20 5b0a 2020  addresses': [.  
+00014880: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00014890: 6f6f 2e62 6172 2e62 617a 2e63 6f6d 270a  oo.bar.baz.com'.
+000148a0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+000148b0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
+000148c0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+000148d0: 6c66 2c20 276e 6574 776f 726b 2d67 6574  lf, 'network-get
+000148e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000148f0: 2020 2020 2020 2066 2727 275b 2022 2431         f'''[ "$1
+00014900: 2220 3d20 6462 3020 5d20 2626 2065 6368  " = db0 ] && ech
+00014910: 6f20 277b 6e65 7477 6f72 6b5f 6461 7461  o '{network_data
+00014920: 7d27 207c 7c20 6578 6974 2031 2727 2729  }' || exit 1''')
+00014930: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
+00014940: 5f6e 616d 6520 3d20 2764 6230 270a 2020  _name = 'db0'.  
+00014950: 2020 2020 2020 6269 6e64 696e 6720 3d20        binding = 
+00014960: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f62  self.model.get_b
+00014970: 696e 6469 6e67 2873 656c 662e 6d6f 6465  inding(self.mode
+00014980: 6c2e 6765 745f 7265 6c61 7469 6f6e 2862  l.get_relation(b
+00014990: 696e 6469 6e67 5f6e 616d 6529 290a 2020  inding_name)).  
+000149a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000149b0: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
+000149c0: 6574 776f 726b 2e69 6e67 7265 7373 5f61  etwork.ingress_a
+000149d0: 6464 7265 7373 6573 2c20 5b27 666f 6f2e  ddresses, ['foo.
+000149e0: 6261 722e 6261 7a2e 636f 6d27 5d29 0a0a  bar.baz.com'])..
+000149f0: 0a63 6c61 7373 2054 6573 744d 6f64 656c  .class TestModel
+00014a00: 4261 636b 656e 6428 756e 6974 7465 7374  Backend(unittest
+00014a10: 2e54 6573 7443 6173 6529 3a0a 0a20 2020  .TestCase):..   
+00014a20: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
+00014a30: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
+00014a40: 6261 636b 656e 6420 3d20 4e6f 6e65 0a0a  backend = None..
+00014a50: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00014a60: 2020 6465 6620 6261 636b 656e 6428 7365    def backend(se
+00014a70: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
+00014a80: 7365 6c66 2e5f 6261 636b 656e 6420 6973  self._backend is
+00014a90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00014aa0: 2020 2073 656c 662e 5f62 6163 6b65 6e64     self._backend
+00014ab0: 203d 205f 4d6f 6465 6c42 6163 6b65 6e64   = _ModelBackend
+00014ac0: 2827 6d79 6170 702f 3027 290a 2020 2020  ('myapp/0').    
+00014ad0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00014ae0: 5f62 6163 6b65 6e64 0a0a 2020 2020 6465  _backend..    de
+00014af0: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+00014b00: 6765 745f 7365 745f 6973 5f61 7070 5f61  get_set_is_app_a
+00014b10: 7267 2873 656c 6629 3a0a 2020 2020 2020  rg(self):.      
+00014b20: 2020 2320 4e6f 2069 735f 6170 7020 7072    # No is_app pr
+00014b30: 6f76 6964 6564 2e0a 2020 2020 2020 2020  ovided..        
+00014b40: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00014b50: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+00014b60: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00014b70: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+00014b80: 7469 6f6e 5f73 6574 2831 2c20 2766 6f6f  tion_set(1, 'foo
+00014b90: 6b65 7927 2c20 2762 6172 7661 6c27 290a  key', 'barval').
+00014ba0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00014bb0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00014bc0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+00014bd0: 2020 2020 2020 2020 7365 6c66 2e62 6163          self.bac
+00014be0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00014bf0: 7428 312c 2027 666f 6f65 6e74 6974 7927  t(1, 'fooentity'
+00014c00: 290a 0a20 2020 2020 2020 2023 2049 6e76  )..        # Inv
+00014c10: 616c 6964 2074 7970 6573 2066 6f72 2069  alid types for i
+00014c20: 735f 6170 702e 0a20 2020 2020 2020 2066  s_app..        f
+00014c30: 6f72 2069 735f 6170 705f 7620 696e 205b  or is_app_v in [
+00014c40: 4e6f 6e65 2c20 312c 2032 2e30 2c20 2761  None, 1, 2.0, 'a
+00014c50: 272c 2062 2762 6565 6627 5d3a 0a20 2020  ', b'beef']:.   
+00014c60: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+00014c70: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00014c80: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+00014c90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014ca0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+00014cb0: 6e5f 7365 7428 312c 2027 666f 6f6b 6579  n_set(1, 'fookey
+00014cc0: 272c 2027 6261 7276 616c 272c 2069 735f  ', 'barval', is_
+00014cd0: 6170 703d 6973 5f61 7070 5f76 290a 0a20  app=is_app_v).. 
+00014ce0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00014cf0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00014d00: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
+00014d10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00014d20: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
+00014d30: 696f 6e5f 6765 7428 312c 2027 666f 6f65  ion_get(1, 'fooe
+00014d40: 6e74 6974 7927 2c20 6973 5f61 7070 3d69  ntity', is_app=i
+00014d50: 735f 6170 705f 7629 0a0a 2020 2020 6465  s_app_v)..    de
+00014d60: 6620 7465 7374 5f69 735f 6c65 6164 6572  f test_is_leader
+00014d70: 5f72 6566 7265 7368 2873 656c 6629 3a0a  _refresh(self):.
+00014d80: 2020 2020 2020 2020 6d65 7461 203d 206f          meta = o
+00014d90: 7073 2e43 6861 726d 4d65 7461 2e66 726f  ps.CharmMeta.fro
+00014da0: 6d5f 7961 6d6c 2827 2727 0a20 2020 2020  m_yaml('''.     
+00014db0: 2020 2020 2020 206e 616d 653a 206d 7961         name: mya
+00014dc0: 7070 0a20 2020 2020 2020 2027 2727 290a  pp.        ''').
+00014dd0: 2020 2020 2020 2020 6d6f 6465 6c20 3d20          model = 
+00014de0: 6f70 732e 4d6f 6465 6c28 6d65 7461 2c20  ops.Model(meta, 
+00014df0: 7365 6c66 2e62 6163 6b65 6e64 290a 2020  self.backend).  
+00014e00: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00014e10: 7428 7365 6c66 2c20 2769 732d 6c65 6164  t(self, 'is-lead
+00014e20: 6572 272c 2027 6563 686f 2066 616c 7365  er', 'echo false
+00014e30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00014e40: 6173 7365 7274 4661 6c73 6528 6d6f 6465  assertFalse(mode
+00014e50: 6c2e 756e 6974 2e69 735f 6c65 6164 6572  l.unit.is_leader
+00014e60: 2829 290a 0a20 2020 2020 2020 2023 2043  ())..        # C
+00014e70: 6861 6e67 6520 7468 6520 6c65 6164 6572  hange the leader
+00014e80: 7368 6970 2073 7461 7475 730a 2020 2020  ship status.    
+00014e90: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00014ea0: 7365 6c66 2c20 2769 732d 6c65 6164 6572  self, 'is-leader
+00014eb0: 272c 2027 6563 686f 2074 7275 6527 290a  ', 'echo true').
+00014ec0: 2020 2020 2020 2020 2320 4966 2079 6f75          # If you
+00014ed0: 2064 6f6e 2774 2066 6f72 6365 2069 742c   don't force it,
+00014ee0: 2077 6520 646f 6e27 7420 6368 6563 6b2c   we don't check,
+00014ef0: 2073 6f20 7765 2077 6f6e 2774 2073 6565   so we won't see
+00014f00: 2074 6865 2063 6861 6e67 650a 2020 2020   the change.    
+00014f10: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
+00014f20: 616c 7365 286d 6f64 656c 2e75 6e69 742e  alse(model.unit.
+00014f30: 6973 5f6c 6561 6465 7228 2929 0a20 2020  is_leader()).   
+00014f40: 2020 2020 2023 2049 6620 7765 2066 6f72       # If we for
+00014f50: 6365 2061 2072 6563 6865 636b 2c20 7468  ce a recheck, th
+00014f60: 656e 2077 6520 6e6f 7469 6365 0a20 2020  en we notice.   
+00014f70: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
+00014f80: 642e 5f6c 6561 6465 725f 6368 6563 6b5f  d._leader_check_
+00014f90: 7469 6d65 203d 204e 6f6e 650a 2020 2020  time = None.    
+00014fa0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00014fb0: 7275 6528 6d6f 6465 6c2e 756e 6974 2e69  rue(model.unit.i
+00014fc0: 735f 6c65 6164 6572 2829 290a 0a20 2020  s_leader())..   
+00014fd0: 2020 2020 2023 2046 6f72 6365 2061 2072       # Force a r
+00014fe0: 6563 6865 636b 2077 6974 686f 7574 2063  echeck without c
+00014ff0: 6861 6e67 696e 6720 7468 6520 6c65 6164  hanging the lead
+00015000: 6572 7368 6970 2073 7461 7475 732e 0a20  ership status.. 
+00015010: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00015020: 7074 2873 656c 662c 2027 6973 2d6c 6561  pt(self, 'is-lea
+00015030: 6465 7227 2c20 2765 6368 6f20 7472 7565  der', 'echo true
+00015040: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00015050: 6261 636b 656e 642e 5f6c 6561 6465 725f  backend._leader_
+00015060: 6368 6563 6b5f 7469 6d65 203d 204e 6f6e  check_time = Non
+00015070: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
+00015080: 7373 6572 7454 7275 6528 6d6f 6465 6c2e  ssertTrue(model.
+00015090: 756e 6974 2e69 735f 6c65 6164 6572 2829  unit.is_leader()
+000150a0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000150b0: 7265 6c61 7469 6f6e 5f74 6f6f 6c5f 6572  relation_tool_er
+000150c0: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
+000150d0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+000150e0: 6e75 7028 6f73 2e65 6e76 6972 6f6e 2e70  nup(os.environ.p
+000150f0: 6f70 2c20 274a 554a 555f 5645 5253 494f  op, 'JUJU_VERSIO
+00015100: 4e27 2c20 4e6f 6e65 290a 2020 2020 2020  N', None).      
+00015110: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
+00015120: 4a55 5f56 4552 5349 4f4e 275d 203d 2027  JU_VERSION'] = '
+00015130: 322e 382e 3027 0a20 2020 2020 2020 2065  2.8.0'.        e
+00015140: 7272 5f6d 7367 203d 2027 4552 524f 5220  rr_msg = 'ERROR 
+00015150: 696e 7661 6c69 6420 7661 6c75 6520 2224  invalid value "$
+00015160: 3222 2066 6f72 206f 7074 696f 6e20 2d72  2" for option -r
+00015170: 3a20 7265 6c61 7469 6f6e 206e 6f74 2066  : relation not f
+00015180: 6f75 6e64 270a 0a20 2020 2020 2020 2074  ound'..        t
+00015190: 6573 745f 6361 7365 7320 3d20 5b28 0a20  est_cases = [(. 
+000151a0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+000151b0: 613a 2066 616b 655f 7363 7269 7074 2873  a: fake_script(s
+000151c0: 656c 662c 2027 7265 6c61 7469 6f6e 2d6c  elf, 'relation-l
+000151d0: 6973 7427 2c20 2765 6368 6f20 666f 6f65  ist', 'echo fooe
+000151e0: 7272 6f72 203e 2632 203b 2065 7869 7420  rror >&2 ; exit 
+000151f0: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
+00015200: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
+00015210: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
+00015220: 6973 7428 3329 2c0a 2020 2020 2020 2020  ist(3),.        
+00015230: 2020 2020 6f70 732e 4d6f 6465 6c45 7272      ops.ModelErr
+00015240: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00015250: 5b5b 2772 656c 6174 696f 6e2d 6c69 7374  [['relation-list
+00015260: 272c 2027 2d72 272c 2027 3327 2c20 272d  ', '-r', '3', '-
+00015270: 2d66 6f72 6d61 743d 6a73 6f6e 275d 5d2c  -format=json']],
+00015280: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
+00015290: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000152a0: 3a20 6661 6b65 5f73 6372 6970 7428 7365  : fake_script(se
+000152b0: 6c66 2c20 2772 656c 6174 696f 6e2d 6c69  lf, 'relation-li
+000152c0: 7374 272c 2066 2765 6368 6f20 7b65 7272  st', f'echo {err
+000152d0: 5f6d 7367 7d20 3e26 3220 3b20 6578 6974  _msg} >&2 ; exit
+000152e0: 2032 2729 2c0a 2020 2020 2020 2020 2020   2'),.          
+000152f0: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
+00015300: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00015310: 6c69 7374 2833 292c 0a20 2020 2020 2020  list(3),.       
+00015320: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
+00015330: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
+00015340: 2020 2020 2020 2020 2020 2020 5b5b 2772              [['r
+00015350: 656c 6174 696f 6e2d 6c69 7374 272c 2027  elation-list', '
+00015360: 2d72 272c 2027 3327 2c20 272d 2d66 6f72  -r', '3', '--for
+00015370: 6d61 743d 6a73 6f6e 275d 5d2c 0a20 2020  mat=json']],.   
+00015380: 2020 2020 2029 2c20 280a 2020 2020 2020       ), (.      
+00015390: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
+000153a0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+000153b0: 2772 656c 6174 696f 6e2d 7365 7427 2c20  'relation-set', 
+000153c0: 2765 6368 6f20 666f 6f65 7272 6f72 203e  'echo fooerror >
+000153d0: 2632 203b 2065 7869 7420 3127 292c 0a20  &2 ; exit 1'),. 
+000153e0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+000153f0: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
+00015400: 7265 6c61 7469 6f6e 5f73 6574 2833 2c20  relation_set(3, 
+00015410: 2766 6f6f 272c 2027 6261 7227 2c20 6973  'foo', 'bar', is
+00015420: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
+00015430: 2020 2020 2020 2020 206f 7073 2e4d 6f64           ops.Mod
+00015440: 656c 4572 726f 722c 0a20 2020 2020 2020  elError,.       
+00015450: 2020 2020 205b 5b27 7265 6c61 7469 6f6e       [['relation
+00015460: 2d73 6574 272c 2027 2d72 272c 2027 3327  -set', '-r', '3'
+00015470: 2c20 272d 2d66 696c 6527 2c20 272d 275d  , '--file', '-']
+00015480: 5d2c 0a20 2020 2020 2020 2029 2c20 280a  ],.        ), (.
+00015490: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+000154a0: 6461 3a20 6661 6b65 5f73 6372 6970 7428  da: fake_script(
+000154b0: 7365 6c66 2c20 2772 656c 6174 696f 6e2d  self, 'relation-
+000154c0: 7365 7427 2c20 6627 6563 686f 207b 6572  set', f'echo {er
+000154d0: 725f 6d73 677d 203e 2632 203b 2065 7869  r_msg} >&2 ; exi
+000154e0: 7420 3227 292c 0a20 2020 2020 2020 2020  t 2'),.         
+000154f0: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
+00015500: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+00015510: 5f73 6574 2833 2c20 2766 6f6f 272c 2027  _set(3, 'foo', '
+00015520: 6261 7227 2c20 6973 5f61 7070 3d46 616c  bar', is_app=Fal
+00015530: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+00015540: 206f 7073 2e52 656c 6174 696f 6e4e 6f74   ops.RelationNot
+00015550: 466f 756e 6445 7272 6f72 2c0a 2020 2020  FoundError,.    
+00015560: 2020 2020 2020 2020 5b5b 2772 656c 6174          [['relat
+00015570: 696f 6e2d 7365 7427 2c20 272d 7227 2c20  ion-set', '-r', 
+00015580: 2733 272c 2027 2d2d 6669 6c65 272c 2027  '3', '--file', '
+00015590: 2d27 5d5d 2c0a 2020 2020 2020 2020 292c  -']],.        ),
+000155a0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
+000155b0: 616d 6264 613a 204e 6f6e 652c 0a20 2020  ambda: None,.   
+000155c0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+000155d0: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
+000155e0: 6c61 7469 6f6e 5f73 6574 2833 2c20 2766  lation_set(3, 'f
+000155f0: 6f6f 272c 2027 6261 7227 2c20 6973 5f61  oo', 'bar', is_a
+00015600: 7070 3d54 7275 6529 2c0a 2020 2020 2020  pp=True),.      
+00015610: 2020 2020 2020 6f70 732e 5265 6c61 7469        ops.Relati
+00015620: 6f6e 4e6f 7446 6f75 6e64 4572 726f 722c  onNotFoundError,
+00015630: 0a20 2020 2020 2020 2020 2020 205b 5b27  .            [['
+00015640: 7265 6c61 7469 6f6e 2d73 6574 272c 2027  relation-set', '
+00015650: 2d72 272c 2027 3327 2c20 272d 2d61 7070  -r', '3', '--app
+00015660: 272c 2027 2d2d 6669 6c65 272c 2027 2d27  ', '--file', '-'
+00015670: 5d5d 2c0a 2020 2020 2020 2020 292c 2028  ]],.        ), (
+00015680: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00015690: 6264 613a 2066 616b 655f 7363 7269 7074  bda: fake_script
+000156a0: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
+000156b0: 2d67 6574 272c 2027 6563 686f 2066 6f6f  -get', 'echo foo
+000156c0: 6572 726f 7220 3e26 3220 3b20 6578 6974  error >&2 ; exit
+000156d0: 2031 2729 2c0a 2020 2020 2020 2020 2020   1'),.          
+000156e0: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
+000156f0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00015700: 6765 7428 332c 2027 7265 6d6f 7465 2f30  get(3, 'remote/0
+00015710: 272c 2069 735f 6170 703d 4661 6c73 6529  ', is_app=False)
+00015720: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
+00015730: 732e 4d6f 6465 6c45 7272 6f72 2c0a 2020  s.ModelError,.  
+00015740: 2020 2020 2020 2020 2020 5b5b 2772 656c            [['rel
+00015750: 6174 696f 6e2d 6765 7427 2c20 272d 7227  ation-get', '-r'
+00015760: 2c20 2733 272c 2027 2d27 2c20 2772 656d  , '3', '-', 'rem
+00015770: 6f74 652f 3027 2c20 272d 2d66 6f72 6d61  ote/0', '--forma
+00015780: 743d 6a73 6f6e 275d 5d2c 0a20 2020 2020  t=json']],.     
+00015790: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+000157a0: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
+000157b0: 5f73 6372 6970 7428 7365 6c66 2c20 2772  _script(self, 'r
+000157c0: 656c 6174 696f 6e2d 6765 7427 2c20 6627  elation-get', f'
+000157d0: 6563 686f 207b 6572 725f 6d73 677d 203e  echo {err_msg} >
+000157e0: 2632 203b 2065 7869 7420 3227 292c 0a20  &2 ; exit 2'),. 
+000157f0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00015800: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
+00015810: 7265 6c61 7469 6f6e 5f67 6574 2833 2c20  relation_get(3, 
+00015820: 2772 656d 6f74 652f 3027 2c20 6973 5f61  'remote/0', is_a
+00015830: 7070 3d46 616c 7365 292c 0a20 2020 2020  pp=False),.     
+00015840: 2020 2020 2020 206f 7073 2e52 656c 6174         ops.Relat
+00015850: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
+00015860: 2c0a 2020 2020 2020 2020 2020 2020 5b5b  ,.            [[
+00015870: 2772 656c 6174 696f 6e2d 6765 7427 2c20  'relation-get', 
+00015880: 272d 7227 2c20 2733 272c 2027 2d27 2c20  '-r', '3', '-', 
+00015890: 2772 656d 6f74 652f 3027 2c20 272d 2d66  'remote/0', '--f
+000158a0: 6f72 6d61 743d 6a73 6f6e 275d 5d2c 0a20  ormat=json']],. 
+000158b0: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
+000158c0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+000158d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000158e0: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
+000158f0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00015900: 6765 7428 332c 2027 7265 6d6f 7465 2f30  get(3, 'remote/0
+00015910: 272c 2069 735f 6170 703d 5472 7565 292c  ', is_app=True),
+00015920: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+00015930: 2e52 656c 6174 696f 6e4e 6f74 466f 756e  .RelationNotFoun
+00015940: 6445 7272 6f72 2c0a 2020 2020 2020 2020  dError,.        
+00015950: 2020 2020 5b5b 2772 656c 6174 696f 6e2d      [['relation-
+00015960: 6765 7427 2c20 272d 7227 2c20 2733 272c  get', '-r', '3',
+00015970: 2027 2d27 2c20 2772 656d 6f74 652f 3027   '-', 'remote/0'
+00015980: 2c20 272d 2d61 7070 272c 2027 2d2d 666f  , '--app', '--fo
+00015990: 726d 6174 3d6a 736f 6e27 5d5d 2c0a 2020  rmat=json']],.  
+000159a0: 2020 2020 2020 295d 0a0a 2020 2020 2020        )]..      
+000159b0: 2020 666f 7220 692c 2028 646f 5f66 616b    for i, (do_fak
+000159c0: 652c 2072 756e 2c20 6578 6365 7074 696f  e, run, exceptio
+000159d0: 6e2c 2063 616c 6c73 2920 696e 2065 6e75  n, calls) in enu
+000159e0: 6d65 7261 7465 2874 6573 745f 6361 7365  merate(test_case
+000159f0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00015a00: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
+00015a10: 7428 6929 3a0a 2020 2020 2020 2020 2020  t(i):.          
+00015a20: 2020 2020 2020 646f 5f66 616b 6528 290a        do_fake().
+00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a40: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00015a50: 5261 6973 6573 2865 7863 6570 7469 6f6e  Raises(exception
+00015a60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00015a70: 2020 2020 2020 2072 756e 2829 0a20 2020         run().   
+00015a80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00015a90: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00015aa0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00015ab0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+00015ac0: 292c 2063 616c 6c73 290a 0a20 2020 2064  ), calls)..    d
+00015ad0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
+00015ae0: 5f67 6574 5f6a 756a 755f 7665 7273 696f  _get_juju_versio
+00015af0: 6e5f 7175 6972 6b73 2873 656c 6629 3a0a  n_quirks(self):.
+00015b00: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00015b10: 436c 6561 6e75 7028 6f73 2e65 6e76 6972  Cleanup(os.envir
+00015b20: 6f6e 2e70 6f70 2c20 274a 554a 555f 5645  on.pop, 'JUJU_VE
+00015b30: 5253 494f 4e27 2c20 4e6f 6e65 290a 0a20  RSION', None).. 
+00015b40: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00015b50: 7074 2873 656c 662c 2027 7265 6c61 7469  pt(self, 'relati
+00015b60: 6f6e 2d67 6574 272c 2027 2727 6563 686f  on-get', '''echo
+00015b70: 2027 7b22 666f 6f22 3a20 2262 6172 227d   '{"foo": "bar"}
+00015b80: 2720 2727 2729 0a0a 2020 2020 2020 2020  ' ''')..        
+00015b90: 2320 6f6e 2032 2e37 2e30 2b2c 2074 6869  # on 2.7.0+, thi
+00015ba0: 6e67 7320 7072 6f63 6565 6420 6173 2065  ngs proceed as e
+00015bb0: 7870 6563 7465 640a 2020 2020 2020 2020  xpected.        
+00015bc0: 666f 7220 7620 696e 205b 2732 2e38 2e30  for v in ['2.8.0
+00015bd0: 272c 2027 322e 372e 3027 5d3a 0a20 2020  ', '2.7.0']:.   
+00015be0: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+00015bf0: 6c66 2e73 7562 5465 7374 2876 293a 0a20  lf.subTest(v):. 
+00015c00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00015c10: 732e 656e 7669 726f 6e5b 274a 554a 555f  s.environ['JUJU_
+00015c20: 5645 5253 494f 4e27 5d20 3d20 760a 2020  VERSION'] = v.  
+00015c30: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00015c40: 6c5f 6461 7461 203d 2073 656c 662e 6261  l_data = self.ba
+00015c50: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00015c60: 6574 2831 2c20 2766 6f6f 2f30 272c 2069  et(1, 'foo/0', i
+00015c70: 735f 6170 703d 5472 7565 290a 2020 2020  s_app=True).    
+00015c80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015c90: 2e61 7373 6572 7445 7175 616c 2872 656c  .assertEqual(rel
+00015ca0: 5f64 6174 612c 207b 2266 6f6f 223a 2022  _data, {"foo": "
+00015cb0: 6261 7222 7d29 0a20 2020 2020 2020 2020  bar"}).         
+00015cc0: 2020 2020 2020 2063 616c 6c73 203d 205b         calls = [
+00015cd0: 2720 272e 6a6f 696e 2869 2920 666f 7220  ' '.join(i) for 
+00015ce0: 6920 696e 2066 616b 655f 7363 7269 7074  i in fake_script
+00015cf0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+00015d00: 6172 3d54 7275 6529 5d0a 2020 2020 2020  ar=True)].      
+00015d10: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00015d20: 7373 6572 7445 7175 616c 2863 616c 6c73  ssertEqual(calls
+00015d30: 2c20 5b27 7265 6c61 7469 6f6e 2d67 6574  , ['relation-get
+00015d40: 202d 7220 3120 2d20 666f 6f2f 3020 2d2d   -r 1 - foo/0 --
+00015d50: 6170 7020 2d2d 666f 726d 6174 3d6a 736f  app --format=jso
+00015d60: 6e27 5d29 0a0a 2020 2020 2020 2020 2320  n'])..        # 
+00015d70: 6265 666f 7265 2032 2e37 2e30 2c20 6974  before 2.7.0, it
+00015d80: 206a 7573 7420 6661 696c 7320 286e 6f20   just fails (no 
+00015d90: 2d2d 6170 7020 7375 7070 6f72 7429 0a20  --app support). 
+00015da0: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
+00015db0: 6e5b 274a 554a 555f 5645 5253 494f 4e27  n['JUJU_VERSION'
+00015dc0: 5d20 3d20 2732 2e36 2e39 270a 2020 2020  ] = '2.6.9'.    
+00015dd0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00015de0: 7365 7274 5261 6973 6573 5265 6765 7828  sertRaisesRegex(
+00015df0: 5275 6e74 696d 6545 7272 6f72 2c20 276e  RuntimeError, 'n
+00015e00: 6f74 2073 7570 706f 7274 6564 206f 6e20  ot supported on 
+00015e10: 4a75 6a75 2076 6572 7369 6f6e 2032 2e36  Juju version 2.6
+00015e20: 2e39 2729 3a0a 2020 2020 2020 2020 2020  .9'):.          
+00015e30: 2020 7365 6c66 2e62 6163 6b65 6e64 2e72    self.backend.r
+00015e40: 656c 6174 696f 6e5f 6765 7428 312c 2027  elation_get(1, '
+00015e50: 666f 6f2f 3027 2c20 6973 5f61 7070 3d54  foo/0', is_app=T
+00015e60: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00015e70: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00015e80: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00015e90: 7365 6c66 292c 205b 5d29 0a0a 2020 2020  self), [])..    
+00015ea0: 6465 6620 7465 7374 5f72 656c 6174 696f  def test_relatio
+00015eb0: 6e5f 7365 745f 6a75 6a75 5f76 6572 7369  n_set_juju_versi
+00015ec0: 6f6e 5f71 7569 726b 7328 7365 6c66 293a  on_quirks(self):
+00015ed0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00015ee0: 6443 6c65 616e 7570 286f 732e 656e 7669  dCleanup(os.envi
+00015ef0: 726f 6e2e 706f 702c 2027 4a55 4a55 5f56  ron.pop, 'JUJU_V
+00015f00: 4552 5349 4f4e 272c 204e 6f6e 6529 0a0a  ERSION', None)..
+00015f10: 2020 2020 2020 2020 2320 6f6e 2032 2e37          # on 2.7
+00015f20: 2e30 2b2c 2074 6869 6e67 7320 7072 6f63  .0+, things proc
+00015f30: 6565 6420 6173 2065 7870 6563 7465 640a  eed as expected.
+00015f40: 2020 2020 2020 2020 666f 7220 7620 696e          for v in
+00015f50: 205b 2732 2e38 2e30 272c 2027 322e 372e   ['2.8.0', '2.7.
+00015f60: 3027 5d3a 0a20 2020 2020 2020 2020 2020  0']:.           
+00015f70: 2077 6974 6820 7365 6c66 2e73 7562 5465   with self.subTe
+00015f80: 7374 2876 293a 0a20 2020 2020 2020 2020  st(v):.         
+00015f90: 2020 2020 2020 2074 203d 2074 656d 7066         t = tempf
+00015fa0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+00015fb0: 7279 4669 6c65 2829 0a20 2020 2020 2020  ryFile().       
+00015fc0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00015fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fe0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00015ff0: 6c66 2c20 2772 656c 6174 696f 6e2d 7365  lf, 'relation-se
+00016000: 7427 2c20 6465 6465 6e74 2822 2222 0a20  t', dedent(""". 
+00016010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016020: 2020 2020 2020 2063 6174 203e 3e20 7b7d         cat >> {}
+00016030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016040: 2020 2020 2020 2020 2022 2222 292e 666f           """).fo
+00016050: 726d 6174 2870 6174 686c 6962 2e50 6174  rmat(pathlib.Pat
+00016060: 6828 742e 6e61 6d65 292e 6173 5f70 6f73  h(t.name).as_pos
+00016070: 6978 2829 2929 0a20 2020 2020 2020 2020  ix())).         
+00016080: 2020 2020 2020 2020 2020 206f 732e 656e             os.en
+00016090: 7669 726f 6e5b 274a 554a 555f 5645 5253  viron['JUJU_VERS
+000160a0: 494f 4e27 5d20 3d20 760a 2020 2020 2020  ION'] = v.      
+000160b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000160c0: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
+000160d0: 696f 6e5f 7365 7428 312c 2027 666f 6f27  ion_set(1, 'foo'
+000160e0: 2c20 2762 6172 272c 2069 735f 6170 703d  , 'bar', is_app=
+000160f0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00016100: 2020 2020 2020 2020 2020 6361 6c6c 7320            calls 
+00016110: 3d20 5b27 2027 2e6a 6f69 6e28 6929 2066  = [' '.join(i) f
+00016120: 6f72 2069 2069 6e20 6661 6b65 5f73 6372  or i in fake_scr
+00016130: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
+00016140: 636c 6561 723d 5472 7565 295d 0a20 2020  clear=True)].   
+00016150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016160: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00016170: 6c28 6361 6c6c 732c 205b 2772 656c 6174  l(calls, ['relat
+00016180: 696f 6e2d 7365 7420 2d72 2031 202d 2d61  ion-set -r 1 --a
+00016190: 7070 202d 2d66 696c 6520 2d27 5d29 0a20  pp --file -']). 
+000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161b0: 2020 2074 2e73 6565 6b28 3029 0a20 2020     t.seek(0).   
+000161c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161d0: 2063 6f6e 7465 6e74 203d 2074 2e72 6561   content = t.rea
+000161e0: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
+000161f0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+00016200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016210: 2074 2e63 6c6f 7365 2829 0a20 2020 2020   t.close().     
+00016220: 2020 2020 2020 2020 2020 2064 6563 6f64             decod
+00016230: 6564 203d 2063 6f6e 7465 6e74 2e64 6563  ed = content.dec
+00016240: 6f64 6528 2775 7466 2d38 2729 2e72 6570  ode('utf-8').rep
+00016250: 6c61 6365 2827 5c72 5c6e 272c 2027 5c6e  lace('\r\n', '\n
+00016260: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00016270: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016280: 7561 6c28 6465 636f 6465 642c 2027 666f  ual(decoded, 'fo
+00016290: 6f3a 2062 6172 5c6e 2729 0a0a 2020 2020  o: bar\n')..    
+000162a0: 2020 2020 2320 6265 666f 7265 2032 2e37      # before 2.7
+000162b0: 2e30 2c20 6974 206a 7573 7420 6661 696c  .0, it just fail
+000162c0: 7320 616c 7761 7973 2028 6e6f 202d 2d61  s always (no --a
+000162d0: 7070 2073 7570 706f 7274 290a 2020 2020  pp support).    
+000162e0: 2020 2020 6f73 2e65 6e76 6972 6f6e 5b27      os.environ['
+000162f0: 4a55 4a55 5f56 4552 5349 4f4e 275d 203d  JUJU_VERSION'] =
+00016300: 2027 322e 362e 3927 0a20 2020 2020 2020   '2.6.9'.       
+00016310: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00016320: 7452 6169 7365 7352 6567 6578 2852 756e  tRaisesRegex(Run
+00016330: 7469 6d65 4572 726f 722c 2027 6e6f 7420  timeError, 'not 
+00016340: 7375 7070 6f72 7465 6420 6f6e 204a 756a  supported on Juj
+00016350: 7520 7665 7273 696f 6e20 322e 362e 3927  u version 2.6.9'
+00016360: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00016370: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+00016380: 7469 6f6e 5f73 6574 2831 2c20 2766 6f6f  tion_set(1, 'foo
+00016390: 272c 2027 6261 7227 2c20 6973 5f61 7070  ', 'bar', is_app
+000163a0: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
+000163b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000163c0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+000163d0: 7328 7365 6c66 292c 205b 5d29 0a0a 2020  s(self), [])..  
+000163e0: 2020 6465 6620 7465 7374 5f73 7461 7475    def test_statu
+000163f0: 735f 6765 7428 7365 6c66 293a 0a20 2020  s_get(self):.   
+00016400: 2020 2020 2023 2074 616b 656e 2066 726f       # taken fro
+00016410: 6d20 6163 7475 616c 204a 756a 7520 6f75  m actual Juju ou
+00016420: 7470 7574 0a20 2020 2020 2020 2063 6f6e  tput.        con
+00016430: 7465 6e74 203d 2027 7b22 6d65 7373 6167  tent = '{"messag
+00016440: 6522 3a20 2222 2c20 2273 7461 7475 7322  e": "", "status"
+00016450: 3a20 2275 6e6b 6e6f 776e 222c 2022 7374  : "unknown", "st
+00016460: 6174 7573 2d64 6174 6122 3a20 7b7d 7d27  atus-data": {}}'
+00016470: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00016480: 7269 7074 2873 656c 662c 2027 7374 6174  ript(self, 'stat
+00016490: 7573 2d67 6574 272c 2066 2265 6368 6f20  us-get', f"echo 
+000164a0: 277b 636f 6e74 656e 747d 2722 290a 2020  '{content}'").  
+000164b0: 2020 2020 2020 7320 3d20 7365 6c66 2e62        s = self.b
+000164c0: 6163 6b65 6e64 2e73 7461 7475 735f 6765  ackend.status_ge
+000164d0: 7428 6973 5f61 7070 3d46 616c 7365 290a  t(is_app=False).
+000164e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000164f0: 6572 7445 7175 616c 2873 5b27 7374 6174  ertEqual(s['stat
+00016500: 7573 275d 2c20 2275 6e6b 6e6f 776e 2229  us'], "unknown")
+00016510: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016520: 7365 7274 4571 7561 6c28 735b 276d 6573  sertEqual(s['mes
+00016530: 7361 6765 275d 2c20 2222 290a 2020 2020  sage'], "").    
+00016540: 2020 2020 2320 7461 6b65 6e20 6672 6f6d      # taken from
+00016550: 2061 6374 7561 6c20 4a75 6a75 206f 7574   actual Juju out
+00016560: 7075 740a 2020 2020 2020 2020 636f 6e74  put.        cont
+00016570: 656e 7420 3d20 6465 6465 6e74 2822 2222  ent = dedent("""
+00016580: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00016590: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000165a0: 6170 706c 6963 6174 696f 6e2d 7374 6174  application-stat
+000165b0: 7573 223a 207b 0a20 2020 2020 2020 2020  us": {.         
+000165c0: 2020 2020 2020 2020 2020 2022 6d65 7373             "mess
+000165d0: 6167 6522 3a20 2269 6e73 7461 6c6c 696e  age": "installin
+000165e0: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+000165f0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+00016600: 3a20 226d 6169 6e74 656e 616e 6365 222c  : "maintenance",
+00016610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016620: 2020 2020 2022 7374 6174 7573 2d64 6174       "status-dat
+00016630: 6122 3a20 7b7d 2c0a 2020 2020 2020 2020  a": {},.        
+00016640: 2020 2020 2020 2020 2020 2020 2275 6e69              "uni
+00016650: 7473 223a 207b 0a20 2020 2020 2020 2020  ts": {.         
+00016660: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00016670: 756f 2f30 223a 207b 0a20 2020 2020 2020  uo/0": {.       
+00016680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016690: 2020 2020 2022 6d65 7373 6167 6522 3a20       "message": 
+000166a0: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166c0: 2273 7461 7475 7322 3a20 2261 6374 6976  "status": "activ
+000166d0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000166e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166f0: 2273 7461 7475 732d 6461 7461 223a 207b  "status-data": {
+00016700: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00016710: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00016720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016730: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00016740: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00016750: 7d0a 2020 2020 2020 2020 2020 2020 2222  }.            ""
+00016760: 2229 0a20 2020 2020 2020 2066 616b 655f  ").        fake_
+00016770: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
+00016780: 6174 7573 2d67 6574 272c 2066 2265 6368  atus-get', f"ech
+00016790: 6f20 277b 636f 6e74 656e 747d 2722 290a  o '{content}'").
+000167a0: 2020 2020 2020 2020 7320 3d20 7365 6c66          s = self
+000167b0: 2e62 6163 6b65 6e64 2e73 7461 7475 735f  .backend.status_
+000167c0: 6765 7428 6973 5f61 7070 3d54 7275 6529  get(is_app=True)
+000167d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000167e0: 7365 7274 4571 7561 6c28 735b 2773 7461  sertEqual(s['sta
+000167f0: 7475 7327 5d2c 2022 6d61 696e 7465 6e61  tus'], "maintena
+00016800: 6e63 6522 290a 2020 2020 2020 2020 7365  nce").        se
+00016810: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00016820: 5b27 6d65 7373 6167 6527 5d2c 2022 696e  ['message'], "in
+00016830: 7374 616c 6c69 6e67 2229 0a20 2020 2020  stalling").     
+00016840: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016850: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00016860: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00016870: 723d 5472 7565 292c 205b 0a20 2020 2020  r=True), [.     
+00016880: 2020 2020 2020 205b 2773 7461 7475 732d         ['status-
+00016890: 6765 7427 2c20 272d 2d69 6e63 6c75 6465  get', '--include
+000168a0: 2d64 6174 6127 2c20 272d 2d61 7070 6c69  -data', '--appli
+000168b0: 6361 7469 6f6e 3d46 616c 7365 272c 2027  cation=False', '
+000168c0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
+000168d0: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
+000168e0: 7461 7475 732d 6765 7427 2c20 272d 2d69  tatus-get', '--i
+000168f0: 6e63 6c75 6465 2d64 6174 6127 2c20 272d  nclude-data', '-
+00016900: 2d61 7070 6c69 6361 7469 6f6e 3d54 7275  -application=Tru
+00016910: 6527 2c20 272d 2d66 6f72 6d61 743d 6a73  e', '--format=js
+00016920: 6f6e 275d 2c0a 2020 2020 2020 2020 5d29  on'],.        ])
+00016930: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00016940: 7461 7475 735f 6973 5f61 7070 5f66 6f72  tatus_is_app_for
+00016950: 6365 645f 6b77 6172 6773 2873 656c 6629  ced_kwargs(self)
+00016960: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+00016970: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
+00016980: 7475 732d 6765 7427 2c20 2765 7869 7420  tus-get', 'exit 
+00016990: 3127 290a 2020 2020 2020 2020 6661 6b65  1').        fake
+000169a0: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+000169b0: 7461 7475 732d 7365 7427 2c20 2765 7869  tatus-set', 'exi
+000169c0: 7420 3127 290a 0a20 2020 2020 2020 2074  t 1')..        t
+000169d0: 6573 745f 6361 7365 7320 3d20 280a 2020  est_cases = (.  
+000169e0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000169f0: 3a20 7365 6c66 2e62 6163 6b65 6e64 2e73  : self.backend.s
+00016a00: 7461 7475 735f 6765 7428 4661 6c73 6529  tatus_get(False)
+00016a10: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+00016a20: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
+00016a30: 6e64 2e73 7461 7475 735f 6765 7428 5472  nd.status_get(Tr
+00016a40: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+00016a50: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
+00016a60: 636b 656e 642e 7374 6174 7573 5f73 6574  ckend.status_set
+00016a70: 2827 6163 7469 7665 272c 2027 272c 2046  ('active', '', F
+00016a80: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+00016a90: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
+00016aa0: 6261 636b 656e 642e 7374 6174 7573 5f73  backend.status_s
+00016ab0: 6574 2827 6163 7469 7665 272c 2027 272c  et('active', '',
+00016ac0: 2054 7275 6529 2c0a 2020 2020 2020 2020   True),.        
+00016ad0: 290a 0a20 2020 2020 2020 2066 6f72 2063  )..        for c
+00016ae0: 6173 6520 696e 2074 6573 745f 6361 7365  ase in test_case
+00016af0: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
+00016b00: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00016b10: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+00016b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016b30: 2020 6361 7365 2829 0a0a 2020 2020 6465    case()..    de
+00016b40: 6620 7465 7374 5f6c 6f63 616c 5f73 6574  f test_local_set
+00016b50: 5f69 6e76 616c 6964 5f73 7461 7475 7328  _invalid_status(
+00016b60: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+00016b70: 206a 756a 7520 7265 7475 726e 7320 6578   juju returns ex
+00016b80: 6974 2063 6f64 6520 3120 6966 2079 6f75  it code 1 if you
+00016b90: 2061 736b 2074 6f20 7365 7420 7374 6174   ask to set stat
+00016ba0: 7573 2074 6f20 2775 6e6b 6e6f 776e 2720  us to 'unknown' 
+00016bb0: 6f72 2027 6572 726f 7227 0a20 2020 2020  or 'error'.     
+00016bc0: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
+00016bd0: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
+00016be0: 6c28 2727 270a 2020 2020 2020 2020 2020  l('''.          
+00016bf0: 2020 6e61 6d65 3a20 6d79 6170 700a 2020    name: myapp.  
+00016c00: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00016c10: 2020 206d 6f64 656c 203d 206f 7073 2e4d     model = ops.M
+00016c20: 6f64 656c 286d 6574 612c 2073 656c 662e  odel(meta, self.
+00016c30: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
+00016c40: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00016c50: 662c 2027 7374 6174 7573 2d73 6574 272c  f, 'status-set',
+00016c60: 2027 6578 6974 2031 2729 0a20 2020 2020   'exit 1').     
+00016c70: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00016c80: 656c 662c 2027 6973 2d6c 6561 6465 7227  elf, 'is-leader'
+00016c90: 2c20 2765 6368 6f20 7472 7565 2729 0a0a  , 'echo true')..
+00016ca0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00016cb0: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+00016cc0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+00016cd0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00016ce0: 6c2e 756e 6974 2e73 7461 7475 7320 3d20  l.unit.status = 
+00016cf0: 6f70 732e 556e 6b6e 6f77 6e53 7461 7475  ops.UnknownStatu
+00016d00: 7328 290a 2020 2020 2020 2020 7769 7468  s().        with
+00016d10: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00016d20: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00016d30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00016d40: 6d6f 6465 6c2e 756e 6974 2e73 7461 7475  model.unit.statu
+00016d50: 7320 3d20 6f70 732e 4572 726f 7253 7461  s = ops.ErrorSta
+00016d60: 7475 7328 290a 0a20 2020 2020 2020 2073  tus()..        s
+00016d70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00016d80: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+00016d90: 7328 7365 6c66 2c20 5472 7565 292c 205b  s(self, True), [
+00016da0: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
+00016db0: 7461 7475 732d 7365 7427 2c20 272d 2d61  tatus-set', '--a
+00016dc0: 7070 6c69 6361 7469 6f6e 3d46 616c 7365  pplication=False
+00016dd0: 272c 2027 756e 6b6e 6f77 6e27 2c20 2727  ', 'unknown', ''
+00016de0: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
+00016df0: 2773 7461 7475 732d 7365 7427 2c20 272d  'status-set', '-
+00016e00: 2d61 7070 6c69 6361 7469 6f6e 3d46 616c  -application=Fal
+00016e10: 7365 272c 2027 6572 726f 7227 2c20 2727  se', 'error', ''
+00016e20: 5d2c 0a20 2020 2020 2020 205d 290a 0a20  ],.        ]).. 
+00016e30: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00016e40: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00016e50: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+00016e60: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00016e70: 2e61 7070 2e73 7461 7475 7320 3d20 6f70  .app.status = op
+00016e80: 732e 556e 6b6e 6f77 6e53 7461 7475 7328  s.UnknownStatus(
+00016e90: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00016ea0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00016eb0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+00016ec0: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
+00016ed0: 6465 6c2e 6170 702e 7374 6174 7573 203d  del.app.status =
+00016ee0: 206f 7073 2e45 7272 6f72 5374 6174 7573   ops.ErrorStatus
+00016ef0: 2829 0a0a 2020 2020 2020 2020 2320 4120  ()..        # A 
+00016f00: 6c65 6164 6572 7368 6970 2063 6865 636b  leadership check
+00016f10: 2069 7320 6e65 6564 6564 2066 6f72 2061   is needed for a
+00016f20: 7070 6c69 6361 7469 6f6e 2073 7461 7475  pplication statu
+00016f30: 732e 0a20 2020 2020 2020 2073 656c 662e  s..        self.
+00016f40: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00016f50: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00016f60: 6c66 2c20 5472 7565 292c 205b 0a20 2020  lf, True), [.   
+00016f70: 2020 2020 2020 2020 205b 2769 732d 6c65           ['is-le
+00016f80: 6164 6572 272c 2027 2d2d 666f 726d 6174  ader', '--format
+00016f90: 3d6a 736f 6e27 5d2c 0a20 2020 2020 2020  =json'],.       
+00016fa0: 2020 2020 205b 2773 7461 7475 732d 7365       ['status-se
+00016fb0: 7427 2c20 272d 2d61 7070 6c69 6361 7469  t', '--applicati
+00016fc0: 6f6e 3d54 7275 6527 2c20 2775 6e6b 6e6f  on=True', 'unkno
+00016fd0: 776e 272c 2027 275d 2c0a 2020 2020 2020  wn', ''],.      
+00016fe0: 2020 2020 2020 5b27 7374 6174 7573 2d73        ['status-s
+00016ff0: 6574 272c 2027 2d2d 6170 706c 6963 6174  et', '--applicat
+00017000: 696f 6e3d 5472 7565 272c 2027 6572 726f  ion=True', 'erro
+00017010: 7227 2c20 2727 5d2c 0a20 2020 2020 2020  r', ''],.       
+00017020: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00017030: 745f 6c6f 6361 6c5f 6765 745f 7374 6174  t_local_get_stat
+00017040: 7573 2873 656c 6629 3a0a 2020 2020 2020  us(self):.      
+00017050: 2020 666f 7220 6e61 6d65 2c20 6578 7065    for name, expe
+00017060: 6374 6564 5f63 6c73 2069 6e20 280a 2020  cted_cls in (.  
+00017070: 2020 2020 2020 2020 2020 2822 6163 7469            ("acti
+00017080: 7665 222c 206f 7073 2e41 6374 6976 6553  ve", ops.ActiveS
+00017090: 7461 7475 7329 2c0a 2020 2020 2020 2020  tatus),.        
+000170a0: 2020 2020 2822 7761 6974 696e 6722 2c20      ("waiting", 
+000170b0: 6f70 732e 5761 6974 696e 6753 7461 7475  ops.WaitingStatu
+000170c0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000170d0: 2822 626c 6f63 6b65 6422 2c20 6f70 732e  ("blocked", ops.
+000170e0: 426c 6f63 6b65 6453 7461 7475 7329 2c0a  BlockedStatus),.
+000170f0: 2020 2020 2020 2020 2020 2020 2822 6d61              ("ma
+00017100: 696e 7465 6e61 6e63 6522 2c20 6f70 732e  intenance", ops.
+00017110: 4d61 696e 7465 6e61 6e63 6553 7461 7475  MaintenanceStatu
+00017120: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00017130: 2822 6572 726f 7222 2c20 6f70 732e 4572  ("error", ops.Er
+00017140: 726f 7253 7461 7475 7329 2c0a 2020 2020  rorStatus),.    
+00017150: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00017160: 2020 206d 6574 6120 3d20 6f70 732e 4368     meta = ops.Ch
+00017170: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
+00017180: 6c28 2727 270a 2020 2020 2020 2020 2020  l('''.          
+00017190: 2020 2020 2020 6e61 6d65 3a20 6d79 6170        name: myap
+000171a0: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
+000171b0: 2729 0a20 2020 2020 2020 2020 2020 206d  ').            m
+000171c0: 6f64 656c 203d 206f 7073 2e4d 6f64 656c  odel = ops.Model
+000171d0: 286d 6574 612c 2073 656c 662e 6261 636b  (meta, self.back
+000171e0: 656e 6429 0a0a 2020 2020 2020 2020 2020  end)..          
+000171f0: 2020 7769 7468 2073 656c 662e 7375 6254    with self.subT
+00017200: 6573 7428 6e61 6d65 293a 0a20 2020 2020  est(name):.     
+00017210: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00017220: 6e74 203d 206a 736f 6e2e 6475 6d70 7328  nt = json.dumps(
+00017230: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00017240: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
+00017250: 2022 666f 6f22 2c0a 2020 2020 2020 2020   "foo",.        
+00017260: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00017270: 7475 7322 3a20 6e61 6d65 2c0a 2020 2020  tus": name,.    
 00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017290: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-000172a0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-000172b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-000172c0: 7461 7475 732d 6461 7461 223a 207b 7d2c  tatus-data": {},
-000172d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000172e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000172f0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-00017300: 2020 2020 2020 2020 2020 6661 6b65 5f73            fake_s
-00017310: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
-00017320: 7475 732d 6765 7427 2c20 6622 6563 686f  tus-get', f"echo
-00017330: 2027 7b63 6f6e 7465 6e74 7d27 2229 0a20   '{content}'"). 
-00017340: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017350: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00017360: 2027 6973 2d6c 6561 6465 7227 2c20 2765   'is-leader', 'e
-00017370: 6368 6f20 7472 7565 2729 0a0a 2020 2020  cho true')..    
-00017380: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017390: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-000173a0: 6528 6d6f 6465 6c2e 6170 702e 7374 6174  e(model.app.stat
-000173b0: 7573 2c20 6578 7065 6374 6564 5f63 6c73  us, expected_cls
-000173c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000173d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000173e0: 616c 286d 6f64 656c 2e61 7070 2e73 7461  al(model.app.sta
-000173f0: 7475 732e 6e61 6d65 2c20 6e61 6d65 290a  tus.name, name).
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00017420: 286d 6f64 656c 2e61 7070 2e73 7461 7475  (model.app.statu
-00017430: 732e 6d65 7373 6167 652c 2022 6261 7222  s.message, "bar"
-00017440: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00017450: 7374 6174 7573 5f73 6574 5f69 735f 6170  status_set_is_ap
-00017460: 705f 6e6f 745f 626f 6f6c 5f72 6169 7365  p_not_bool_raise
-00017470: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00017480: 2066 6f72 2069 735f 6170 705f 7620 696e   for is_app_v in
-00017490: 205b 4e6f 6e65 2c20 312c 2032 2e30 2c20   [None, 1, 2.0, 
-000174a0: 2761 272c 2062 2762 6565 6627 2c20 6f62  'a', b'beef', ob
-000174b0: 6a65 6374 5d3a 0a20 2020 2020 2020 2020  ject]:.         
-000174c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-000174d0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-000174e0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000174f0: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00017500: 6e64 2e73 7461 7475 735f 7365 7428 6f70  nd.status_set(op
-00017510: 732e 4163 7469 7665 5374 6174 7573 2c20  s.ActiveStatus, 
-00017520: 6973 5f61 7070 3d69 735f 6170 705f 7629  is_app=is_app_v)
-00017530: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00017540: 746f 7261 6765 5f74 6f6f 6c5f 6572 726f  torage_tool_erro
-00017550: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
-00017560: 2020 7465 7374 5f63 6173 6573 203d 205b    test_cases = [
-00017570: 280a 2020 2020 2020 2020 2020 2020 6c61  (.            la
-00017580: 6d62 6461 3a20 6661 6b65 5f73 6372 6970  mbda: fake_scrip
-00017590: 7428 7365 6c66 2c20 2773 746f 7261 6765  t(self, 'storage
-000175a0: 2d6c 6973 7427 2c20 2765 6368 6f20 666f  -list', 'echo fo
-000175b0: 6f65 7272 6f72 203e 2632 203b 2065 7869  oerror >&2 ; exi
-000175c0: 7420 3127 292c 0a20 2020 2020 2020 2020  t 1'),.         
-000175d0: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
-000175e0: 6261 636b 656e 642e 7374 6f72 6167 655f  backend.storage_
-000175f0: 6c69 7374 2827 666f 6f62 6172 2729 2c0a  list('foobar'),.
-00017600: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00017610: 4d6f 6465 6c45 7272 6f72 2c0a 2020 2020  ModelError,.    
-00017620: 2020 2020 2020 2020 5b5b 2773 746f 7261          [['stora
-00017630: 6765 2d6c 6973 7427 2c20 2766 6f6f 6261  ge-list', 'fooba
-00017640: 7227 2c20 272d 2d66 6f72 6d61 743d 6a73  r', '--format=js
-00017650: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
-00017660: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00017670: 6c61 6d62 6461 3a20 6661 6b65 5f73 6372  lambda: fake_scr
-00017680: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
-00017690: 6765 2d67 6574 272c 2027 6563 686f 2066  ge-get', 'echo f
-000176a0: 6f6f 6572 726f 7220 3e26 3220 3b20 6578  ooerror >&2 ; ex
-000176b0: 6974 2031 2729 2c0a 2020 2020 2020 2020  it 1'),.        
-000176c0: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-000176d0: 2e62 6163 6b65 6e64 2e73 746f 7261 6765  .backend.storage
-000176e0: 5f67 6574 2827 666f 6f62 6172 272c 2027  _get('foobar', '
-000176f0: 736f 6d65 6174 7472 2729 2c0a 2020 2020  someattr'),.    
-00017700: 2020 2020 2020 2020 6f70 732e 4d6f 6465          ops.Mode
-00017710: 6c45 7272 6f72 2c0a 2020 2020 2020 2020  lError,.        
-00017720: 2020 2020 5b5b 2773 746f 7261 6765 2d67      [['storage-g
-00017730: 6574 272c 2027 2d73 272c 2027 666f 6f62  et', '-s', 'foob
-00017740: 6172 272c 2027 736f 6d65 6174 7472 272c  ar', 'someattr',
-00017750: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-00017760: 5d5d 2c0a 2020 2020 2020 2020 292c 2028  ]],.        ), (
-00017770: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-00017780: 6264 613a 2066 616b 655f 7363 7269 7074  bda: fake_script
-00017790: 2873 656c 662c 2027 7374 6f72 6167 652d  (self, 'storage-
-000177a0: 6164 6427 2c20 2765 6368 6f20 666f 6f65  add', 'echo fooe
-000177b0: 7272 6f72 203e 2632 203b 2065 7869 7420  rror >&2 ; exit 
-000177c0: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
-000177d0: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
-000177e0: 636b 656e 642e 7374 6f72 6167 655f 6164  ckend.storage_ad
-000177f0: 6428 2766 6f6f 6261 7227 2c20 636f 756e  d('foobar', coun
-00017800: 743d 3229 2c0a 2020 2020 2020 2020 2020  t=2),.          
-00017810: 2020 6f70 732e 4d6f 6465 6c45 7272 6f72    ops.ModelError
-00017820: 2c0a 2020 2020 2020 2020 2020 2020 5b5b  ,.            [[
-00017830: 2773 746f 7261 6765 2d61 6464 272c 2027  'storage-add', '
-00017840: 666f 6f62 6172 3d32 275d 5d2c 0a20 2020  foobar=2']],.   
-00017850: 2020 2020 2029 2c20 280a 2020 2020 2020       ), (.      
-00017860: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
-00017870: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00017880: 2773 746f 7261 6765 2d61 6464 272c 2027  'storage-add', '
-00017890: 6563 686f 2066 6f6f 6572 726f 7220 3e26  echo fooerror >&
-000178a0: 3220 3b20 6578 6974 2031 2729 2c0a 2020  2 ; exit 1'),.  
-000178b0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-000178c0: 3a20 7365 6c66 2e62 6163 6b65 6e64 2e73  : self.backend.s
-000178d0: 746f 7261 6765 5f61 6464 2827 666f 6f62  torage_add('foob
-000178e0: 6172 272c 2063 6f75 6e74 3d6f 626a 6563  ar', count=objec
-000178f0: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-00017900: 5479 7065 4572 726f 722c 0a20 2020 2020  TypeError,.     
-00017910: 2020 2020 2020 205b 5d2c 0a20 2020 2020         [],.     
-00017920: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
-00017930: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
-00017940: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-00017950: 746f 7261 6765 2d61 6464 272c 2027 6563  torage-add', 'ec
-00017960: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
-00017970: 3b20 6578 6974 2031 2729 2c0a 2020 2020  ; exit 1'),.    
-00017980: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00017990: 7365 6c66 2e62 6163 6b65 6e64 2e73 746f  self.backend.sto
-000179a0: 7261 6765 5f61 6464 2827 666f 6f62 6172  rage_add('foobar
-000179b0: 272c 2063 6f75 6e74 3d54 7275 6529 2c0a  ', count=True),.
-000179c0: 2020 2020 2020 2020 2020 2020 5479 7065              Type
-000179d0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-000179e0: 2020 205b 5d2c 0a20 2020 2020 2020 2029     [],.        )
-000179f0: 5d0a 2020 2020 2020 2020 666f 7220 646f  ].        for do
-00017a00: 5f66 616b 652c 2072 756e 2c20 6578 6365  _fake, run, exce
-00017a10: 7074 696f 6e2c 2063 616c 6c73 2069 6e20  ption, calls in 
-00017a20: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
-00017a30: 2020 2020 2020 2020 646f 5f66 616b 6528          do_fake(
-00017a40: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
-00017a50: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00017a60: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
-00017a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a80: 2072 756e 2829 0a20 2020 2020 2020 2020   run().         
-00017a90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00017aa0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-00017ab0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-00017ac0: 723d 5472 7565 292c 2063 616c 6c73 290a  r=True), calls).
-00017ad0: 0a20 2020 2064 6566 2074 6573 745f 6e65  .    def test_ne
-00017ae0: 7477 6f72 6b5f 6765 7428 7365 6c66 293a  twork_get(self):
-00017af0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-00017b00: 5f67 6574 5f6f 7574 203d 2027 2727 7b0a  _get_out = '''{.
-00017b10: 2020 2262 696e 642d 6164 6472 6573 7365    "bind-addresse
-00017b20: 7322 3a20 5b0a 2020 2020 7b0a 2020 2020  s": [.    {.    
-00017b30: 2020 226d 6163 2d61 6464 7265 7373 223a    "mac-address":
-00017b40: 2022 222c 0a20 2020 2020 2022 696e 7465   "",.      "inte
-00017b50: 7266 6163 652d 6e61 6d65 223a 2022 222c  rface-name": "",
-00017b60: 0a20 2020 2020 2022 6164 6472 6573 7365  .      "addresse
-00017b70: 7322 3a20 5b0a 2020 2020 2020 2020 7b0a  s": [.        {.
-00017b80: 2020 2020 2020 2020 2020 2268 6f73 746e            "hostn
-00017b90: 616d 6522 3a20 2222 2c0a 2020 2020 2020  ame": "",.      
-00017ba0: 2020 2020 2276 616c 7565 223a 2022 3139      "value": "19
-00017bb0: 322e 302e 322e 3222 2c0a 2020 2020 2020  2.0.2.2",.      
-00017bc0: 2020 2020 2263 6964 7222 3a20 2222 0a20      "cidr": "". 
-00017bd0: 2020 2020 2020 207d 0a20 2020 2020 205d         }.      ]
-00017be0: 0a20 2020 207d 0a20 205d 2c0a 2020 2265  .    }.  ],.  "e
-00017bf0: 6772 6573 732d 7375 626e 6574 7322 3a20  gress-subnets": 
-00017c00: 5b0a 2020 2020 2231 3932 2e30 2e32 2e32  [.    "192.0.2.2
-00017c10: 2f33 3222 0a20 205d 2c0a 2020 2269 6e67  /32".  ],.  "ing
-00017c20: 7265 7373 2d61 6464 7265 7373 6573 223a  ress-addresses":
-00017c30: 205b 0a20 2020 2022 3139 322e 302e 322e   [.    "192.0.2.
-00017c40: 3222 0a20 205d 0a7d 2727 270a 2020 2020  2".  ].}'''.    
-00017c50: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00017c60: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
-00017c70: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-00017c80: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
-00017c90: 2431 2220 3d20 6465 6164 6265 6566 205d  $1" = deadbeef ]
-00017ca0: 2026 2620 6563 686f 2027 7b6e 6574 776f   && echo '{netwo
-00017cb0: 726b 5f67 6574 5f6f 7574 7d27 207c 7c20  rk_get_out}' || 
-00017cc0: 6578 6974 2031 2727 2729 0a20 2020 2020  exit 1''').     
-00017cd0: 2020 206e 6574 776f 726b 5f69 6e66 6f20     network_info 
-00017ce0: 3d20 7365 6c66 2e62 6163 6b65 6e64 2e6e  = self.backend.n
-00017cf0: 6574 776f 726b 5f67 6574 2827 6465 6164  etwork_get('dead
-00017d00: 6265 6566 2729 0a20 2020 2020 2020 2073  beef').        s
-00017d10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00017d20: 6e65 7477 6f72 6b5f 696e 666f 2c20 6a73  network_info, js
-00017d30: 6f6e 2e6c 6f61 6473 286e 6574 776f 726b  on.loads(network
-00017d40: 5f67 6574 5f6f 7574 2929 0a20 2020 2020  _get_out)).     
-00017d50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00017d60: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-00017d70: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-00017d80: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
-00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017da0: 2020 5b5b 276e 6574 776f 726b 2d67 6574    [['network-get
-00017db0: 272c 2027 6465 6164 6265 6566 272c 2027  ', 'deadbeef', '
-00017dc0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
-00017dd0: 290a 0a20 2020 2020 2020 206e 6574 776f  )..        netwo
-00017de0: 726b 5f69 6e66 6f20 3d20 7365 6c66 2e62  rk_info = self.b
-00017df0: 6163 6b65 6e64 2e6e 6574 776f 726b 5f67  ackend.network_g
-00017e00: 6574 2827 6465 6164 6265 6566 272c 2031  et('deadbeef', 1
-00017e10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00017e20: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
-00017e30: 726b 5f69 6e66 6f2c 206a 736f 6e2e 6c6f  rk_info, json.lo
-00017e40: 6164 7328 6e65 7477 6f72 6b5f 6765 745f  ads(network_get_
-00017e50: 6f75 7429 290a 2020 2020 2020 2020 7365  out)).        se
-00017e60: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00017e70: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00017e80: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-00017e90: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00017ea0: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
-00017eb0: 6e65 7477 6f72 6b2d 6765 7427 2c20 2764  network-get', 'd
-00017ec0: 6561 6462 6565 6627 2c20 272d 7227 2c20  eadbeef', '-r', 
-00017ed0: 2731 272c 2027 2d2d 666f 726d 6174 3d6a  '1', '--format=j
-00017ee0: 736f 6e27 5d5d 290a 0a20 2020 2064 6566  son']])..    def
-00017ef0: 2074 6573 745f 6e65 7477 6f72 6b5f 6765   test_network_ge
-00017f00: 745f 6572 726f 7273 2873 656c 6629 3a0a  t_errors(self):.
-00017f10: 2020 2020 2020 2020 6572 725f 6e6f 5f65          err_no_e
-00017f20: 6e64 706f 696e 7420 3d20 2745 5252 4f52  ndpoint = 'ERROR
-00017f30: 206e 6f20 6e65 7477 6f72 6b20 636f 6e66   no network conf
-00017f40: 6967 2066 6f75 6e64 2066 6f72 2062 696e  ig found for bin
-00017f50: 6469 6e67 2022 2432 2227 0a20 2020 2020  ding "$2"'.     
-00017f60: 2020 2065 7272 5f6e 6f5f 7265 6c20 3d20     err_no_rel = 
-00017f70: 2745 5252 4f52 2069 6e76 616c 6964 2076  'ERROR invalid v
-00017f80: 616c 7565 2022 2433 2220 666f 7220 6f70  alue "$3" for op
-00017f90: 7469 6f6e 202d 723a 2072 656c 6174 696f  tion -r: relatio
-00017fa0: 6e20 6e6f 7420 666f 756e 6427 0a0a 2020  n not found'..  
-00017fb0: 2020 2020 2020 7465 7374 5f63 6173 6573        test_cases
-00017fc0: 203d 205b 280a 2020 2020 2020 2020 2020   = [(.          
-00017fd0: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
-00017fe0: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
-00017ff0: 776f 726b 2d67 6574 272c 0a20 2020 2020  work-get',.     
-00018000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018010: 2020 2020 2020 2020 2020 2066 2765 6368             f'ech
-00018020: 6f20 7b65 7272 5f6e 6f5f 656e 6470 6f69  o {err_no_endpoi
-00018030: 6e74 7d20 3e26 3220 3b20 6578 6974 2031  nt} >&2 ; exit 1
-00018040: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00018050: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
-00018060: 6b65 6e64 2e6e 6574 776f 726b 5f67 6574  kend.network_get
-00018070: 2822 6465 6164 6265 6566 2229 2c0a 2020  ("deadbeef"),.  
-00018080: 2020 2020 2020 2020 2020 6f70 732e 4d6f            ops.Mo
-00018090: 6465 6c45 7272 6f72 2c0a 2020 2020 2020  delError,.      
-000180a0: 2020 2020 2020 5b5b 276e 6574 776f 726b        [['network
-000180b0: 2d67 6574 272c 2027 6465 6164 6265 6566  -get', 'deadbeef
-000180c0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-000180d0: 6e27 5d5d 2c0a 2020 2020 2020 2020 292c  n']],.        ),
-000180e0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
-000180f0: 616d 6264 613a 2066 616b 655f 7363 7269  ambda: fake_scri
-00018100: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
-00018110: 6b2d 6765 7427 2c20 6627 6563 686f 207b  k-get', f'echo {
-00018120: 6572 725f 6e6f 5f72 656c 7d20 3e26 3220  err_no_rel} >&2 
-00018130: 3b20 6578 6974 2032 2729 2c0a 2020 2020  ; exit 2'),.    
-00018140: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00018150: 7365 6c66 2e62 6163 6b65 6e64 2e6e 6574  self.backend.net
-00018160: 776f 726b 5f67 6574 2822 6465 6164 6265  work_get("deadbe
-00018170: 6566 222c 2033 292c 0a20 2020 2020 2020  ef", 3),.       
-00018180: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
-00018190: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
-000181a0: 2020 2020 2020 2020 2020 2020 5b5b 276e              [['n
-000181b0: 6574 776f 726b 2d67 6574 272c 2027 6465  etwork-get', 'de
-000181c0: 6164 6265 6566 272c 2027 2d72 272c 2027  adbeef', '-r', '
-000181d0: 3327 2c20 272d 2d66 6f72 6d61 743d 6a73  3', '--format=js
-000181e0: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
-000181f0: 5d0a 2020 2020 2020 2020 666f 7220 646f  ].        for do
-00018200: 5f66 616b 652c 2072 756e 2c20 6578 6365  _fake, run, exce
-00018210: 7074 696f 6e2c 2063 616c 6c73 2069 6e20  ption, calls in 
-00018220: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
-00018230: 2020 2020 2020 2020 646f 5f66 616b 6528          do_fake(
-00018240: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
-00018250: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00018260: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
-00018270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018280: 2072 756e 2829 0a20 2020 2020 2020 2020   run().         
-00018290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000182a0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-000182b0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-000182c0: 723d 5472 7565 292c 2063 616c 6c73 290a  r=True), calls).
-000182d0: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
-000182e0: 7469 6f6e 5f67 6574 5f65 7272 6f72 2873  tion_get_error(s
-000182f0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-00018300: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00018310: 2761 6374 696f 6e2d 6765 7427 2c20 2727  'action-get', ''
-00018320: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-00018330: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
-00018340: 696f 6e2d 6765 7427 2c20 2765 6368 6f20  ion-get', 'echo 
-00018350: 666f 6f65 7272 6f72 203e 2632 203b 2065  fooerror >&2 ; e
-00018360: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-00018370: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00018380: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
-00018390: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000183a0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-000183b0: 2e61 6374 696f 6e5f 6765 7428 290a 2020  .action_get().  
-000183c0: 2020 2020 2020 6361 6c6c 7320 3d20 5b5b        calls = [[
-000183d0: 2761 6374 696f 6e2d 6765 7427 2c20 272d  'action-get', '-
-000183e0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 5d0a  -format=json']].
-000183f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00018400: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
-00018410: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
-00018420: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
-00018430: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
-00018440: 7374 5f61 6374 696f 6e5f 7365 745f 6572  st_action_set_er
-00018450: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
-00018460: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00018470: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
-00018480: 272c 2027 2729 0a20 2020 2020 2020 2066  ', '').        f
-00018490: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-000184a0: 2027 6163 7469 6f6e 2d73 6574 272c 2027   'action-set', '
-000184b0: 6563 686f 2066 6f6f 6572 726f 7220 3e26  echo fooerror >&
-000184c0: 3220 3b20 6578 6974 2031 2729 0a20 2020  2 ; exit 1').   
-000184d0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000184e0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-000184f0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-00018500: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00018510: 636b 656e 642e 6163 7469 6f6e 5f73 6574  ckend.action_set
-00018520: 284f 7264 6572 6564 4469 6374 285b 2827  (OrderedDict([('
-00018530: 666f 6f27 2c20 2762 6172 2729 2c20 2827  foo', 'bar'), ('
-00018540: 6465 6164 272c 2027 6265 6566 2063 6166  dead', 'beef caf
-00018550: 6527 295d 2929 0a20 2020 2020 2020 2073  e')])).        s
-00018560: 656c 662e 6173 7365 7274 436f 756e 7445  elf.assertCountE
-00018570: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00018580: 2020 5b22 6163 7469 6f6e 2d73 6574 222c    ["action-set",
-00018590: 2022 6465 6164 3d62 6565 6620 6361 6665   "dead=beef cafe
-000185a0: 222c 2022 666f 6f3d 6261 7222 5d2c 2066  ", "foo=bar"], f
-000185b0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-000185c0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-000185d0: 6529 5b30 5d29 0a0a 2020 2020 6465 6620  e)[0])..    def 
-000185e0: 7465 7374 5f61 6374 696f 6e5f 6c6f 675f  test_action_log_
-000185f0: 6572 726f 7228 7365 6c66 293a 0a20 2020  error(self):.   
-00018600: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00018610: 2873 656c 662c 2027 6163 7469 6f6e 2d67  (self, 'action-g
-00018620: 6574 272c 2027 2729 0a20 2020 2020 2020  et', '').       
-00018630: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00018640: 662c 2027 6163 7469 6f6e 2d6c 6f67 272c  f, 'action-log',
-00018650: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
-00018660: 3e26 3220 3b20 6578 6974 2031 2729 0a20  >&2 ; exit 1'). 
-00018670: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00018680: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-00018690: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
-000186a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000186b0: 6261 636b 656e 642e 6163 7469 6f6e 5f6c  backend.action_l
-000186c0: 6f67 2827 6c6f 672d 6d65 7373 6167 6527  og('log-message'
-000186d0: 290a 2020 2020 2020 2020 6361 6c6c 7320  ).        calls 
-000186e0: 3d20 5b5b 2261 6374 696f 6e2d 6c6f 6722  = [["action-log"
-000186f0: 2c20 226c 6f67 2d6d 6573 7361 6765 225d  , "log-message"]
-00018700: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00018710: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-00018720: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00018730: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-00018740: 6361 6c6c 7329 0a0a 2020 2020 6465 6620  calls)..    def 
-00018750: 7465 7374 5f61 6374 696f 6e5f 6765 7428  test_action_get(
-00018760: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-00018770: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00018780: 2027 6163 7469 6f6e 2d67 6574 272c 2022   'action-get', "
-00018790: 2222 6563 686f 2027 7b22 666f 6f2d 6e61  ""echo '{"foo-na
-000187a0: 6d65 223a 2022 6261 7222 2c20 2273 696c  me": "bar", "sil
-000187b0: 656e 7422 3a20 6661 6c73 657d 2722 2222  ent": false}'"""
-000187c0: 290a 2020 2020 2020 2020 7061 7261 6d73  ).        params
-000187d0: 203d 2073 656c 662e 6261 636b 656e 642e   = self.backend.
-000187e0: 6163 7469 6f6e 5f67 6574 2829 0a20 2020  action_get().   
-000187f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018800: 4571 7561 6c28 7061 7261 6d73 5b27 666f  Equal(params['fo
-00018810: 6f2d 6e61 6d65 275d 2c20 2762 6172 2729  o-name'], 'bar')
-00018820: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00018830: 7365 7274 4571 7561 6c28 7061 7261 6d73  sertEqual(params
-00018840: 5b27 7369 6c65 6e74 275d 2c20 4661 6c73  ['silent'], Fals
-00018850: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00018860: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-00018870: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-00018880: 6c66 292c 205b 5b27 6163 7469 6f6e 2d67  lf), [['action-g
-00018890: 6574 272c 2027 2d2d 666f 726d 6174 3d6a  et', '--format=j
-000188a0: 736f 6e27 5d5d 290a 0a20 2020 2064 6566  son']])..    def
-000188b0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
-000188c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000188d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000188e0: 2c20 2761 6374 696f 6e2d 6765 7427 2c20  , 'action-get', 
-000188f0: 2765 7869 7420 3127 290a 2020 2020 2020  'exit 1').      
-00018900: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018910: 6c66 2c20 2761 6374 696f 6e2d 7365 7427  lf, 'action-set'
-00018920: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
-00018930: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-00018940: 2e61 6374 696f 6e5f 7365 7428 7b27 7827  .action_set({'x'
-00018950: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
-00018960: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
-00018970: 7365 6c66 2e61 7373 6572 7443 6f75 6e74  self.assertCount
-00018980: 4571 7561 6c28 5b27 6163 7469 6f6e 2d73  Equal(['action-s
-00018990: 6574 272c 2027 783d 6465 6164 2062 6565  et', 'x=dead bee
-000189a0: 6627 2c20 2779 3d31 275d 2c20 6661 6b65  f', 'y=1'], fake
-000189b0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-000189c0: 6c66 295b 305d 290a 0a20 2020 2064 6566  lf)[0])..    def
-000189d0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
-000189e0: 5f6b 6579 5f76 616c 6964 6174 696f 6e28  _key_validation(
-000189f0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00018a00: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00018a10: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
-00018a20: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00018a30: 656c 662e 6261 636b 656e 642e 6163 7469  elf.backend.acti
-00018a40: 6f6e 5f73 6574 287b 2758 273a 2027 6465  on_set({'X': 'de
-00018a50: 6164 2062 6565 6627 2c20 2779 273a 2031  ad beef', 'y': 1
-00018a60: 7d29 0a20 2020 2020 2020 2077 6974 6820  }).        with 
-00018a70: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00018a80: 7328 5661 6c75 6545 7272 6f72 293a 0a20  s(ValueError):. 
-00018a90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00018aa0: 6261 636b 656e 642e 6163 7469 6f6e 5f73  backend.action_s
-00018ab0: 6574 287b 2773 6f6d 6526 6b65 7927 3a20  et({'some&key': 
-00018ac0: 2764 6561 6420 6265 6566 272c 2027 7927  'dead beef', 'y'
-00018ad0: 3a20 317d 290a 2020 2020 2020 2020 7769  : 1}).        wi
-00018ae0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00018af0: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
-00018b00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00018b10: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
-00018b20: 6e5f 7365 7428 7b27 736f 6d65 4b65 7927  n_set({'someKey'
-00018b30: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
-00018b40: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
-00018b50: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00018b60: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
-00018b70: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00018b80: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
-00018b90: 696f 6e5f 7365 7428 7b27 736f 6d65 5f6b  ion_set({'some_k
-00018ba0: 6579 273a 2027 6465 6164 2062 6565 6627  ey': 'dead beef'
-00018bb0: 2c20 2779 273a 2031 7d29 0a0a 2020 2020  , 'y': 1})..    
-00018bc0: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
-00018bd0: 7365 745f 6e65 7374 6564 2873 656c 6629  set_nested(self)
-00018be0: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-00018bf0: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
-00018c00: 696f 6e2d 6765 7427 2c20 2765 7869 7420  ion-get', 'exit 
-00018c10: 3127 290a 2020 2020 2020 2020 6661 6b65  1').        fake
-00018c20: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
-00018c30: 6374 696f 6e2d 7365 7427 2c20 2765 7869  ction-set', 'exi
-00018c40: 7420 3027 290a 2020 2020 2020 2020 7365  t 0').        se
-00018c50: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
-00018c60: 6e5f 7365 7428 7b27 6127 3a20 7b27 6227  n_set({'a': {'b'
-00018c70: 3a20 312c 2027 6327 3a20 327d 2c20 2764  : 1, 'c': 2}, 'd
-00018c80: 273a 2033 7d29 0a20 2020 2020 2020 2073  ': 3}).        s
-00018c90: 656c 662e 6173 7365 7274 436f 756e 7445  elf.assertCountE
-00018ca0: 7175 616c 285b 2761 6374 696f 6e2d 7365  qual(['action-se
-00018cb0: 7427 2c20 2761 2e62 3d31 272c 2027 612e  t', 'a.b=1', 'a.
-00018cc0: 633d 3227 2c20 2764 3d33 275d 2c20 6661  c=2', 'd=3'], fa
-00018cd0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00018ce0: 7365 6c66 295b 305d 290a 0a20 2020 2064  self)[0])..    d
-00018cf0: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
-00018d00: 6574 5f6d 6f72 655f 6e65 7374 6564 2873  et_more_nested(s
-00018d10: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-00018d20: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00018d30: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
-00018d40: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-00018d50: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00018d60: 2c20 2761 6374 696f 6e2d 7365 7427 2c20  , 'action-set', 
-00018d70: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
-00018d80: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-00018d90: 6374 696f 6e5f 7365 7428 7b27 6127 3a20  ction_set({'a': 
-00018da0: 7b27 6227 3a20 312c 2027 6327 3a20 322c  {'b': 1, 'c': 2,
-00018db0: 2027 6427 3a20 7b27 6527 3a20 337d 7d2c   'd': {'e': 3}},
-00018dc0: 2027 6627 3a20 347d 290a 2020 2020 2020   'f': 4}).      
-00018dd0: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
-00018de0: 6e74 4571 7561 6c28 0a20 2020 2020 2020  ntEqual(.       
-00018df0: 2020 2020 205b 2761 6374 696f 6e2d 7365       ['action-se
-00018e00: 7427 2c20 2761 2e62 3d31 272c 2027 612e  t', 'a.b=1', 'a.
-00018e10: 633d 3227 2c20 2761 2e64 2e65 3d33 272c  c=2', 'a.d.e=3',
-00018e20: 2027 663d 3427 5d2c 2066 616b 655f 7363   'f=4'], fake_sc
-00018e30: 7269 7074 5f63 616c 6c73 2873 656c 6629  ript_calls(self)
-00018e40: 5b30 5d29 0a0a 2020 2020 6465 6620 7465  [0])..    def te
-00018e50: 7374 5f61 6374 696f 6e5f 7365 745f 646f  st_action_set_do
-00018e60: 7474 6564 5f64 6963 7428 7365 6c66 293a  tted_dict(self):
-00018e70: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00018e80: 7269 7074 2873 656c 662c 2027 6163 7469  ript(self, 'acti
-00018e90: 6f6e 2d67 6574 272c 2027 6578 6974 2031  on-get', 'exit 1
-00018ea0: 2729 0a20 2020 2020 2020 2066 616b 655f  ').        fake_
-00018eb0: 7363 7269 7074 2873 656c 662c 2027 6163  script(self, 'ac
-00018ec0: 7469 6f6e 2d73 6574 272c 2027 6578 6974  tion-set', 'exit
-00018ed0: 2030 2729 0a20 2020 2020 2020 2073 656c   0').        sel
-00018ee0: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
-00018ef0: 5f73 6574 287b 2761 2e62 273a 2031 2c20  _set({'a.b': 1, 
-00018f00: 2761 273a 207b 2763 273a 2032 7d2c 2027  'a': {'c': 2}, '
-00018f10: 6427 3a20 337d 290a 2020 2020 2020 2020  d': 3}).        
-00018f20: 7365 6c66 2e61 7373 6572 7443 6f75 6e74  self.assertCount
-00018f30: 4571 7561 6c28 5b27 6163 7469 6f6e 2d73  Equal(['action-s
-00018f40: 6574 272c 2027 612e 623d 3127 2c20 2761  et', 'a.b=1', 'a
-00018f50: 2e63 3d32 272c 2027 643d 3327 5d2c 2066  .c=2', 'd=3'], f
-00018f60: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00018f70: 2873 656c 6629 5b30 5d29 0a0a 2020 2020  (self)[0])..    
-00018f80: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
-00018f90: 7365 745f 6475 706c 6963 6174 6564 5f6b  set_duplicated_k
-00018fa0: 6579 7328 7365 6c66 293a 0a20 2020 2020  eys(self):.     
-00018fb0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00018fc0: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
-00018fd0: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
-00018fe0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00018ff0: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
-00019000: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
-00019010: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00019020: 2e61 7373 6572 7452 6169 7365 7328 5661  .assertRaises(Va
-00019030: 6c75 6545 7272 6f72 293a 0a20 2020 2020  lueError):.     
-00019040: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
-00019050: 656e 642e 6163 7469 6f6e 5f73 6574 287b  end.action_set({
-00019060: 2761 2e62 273a 2031 2c20 2761 273a 207b  'a.b': 1, 'a': {
-00019070: 2762 273a 2032 7d2c 2027 6427 3a20 337d  'b': 2}, 'd': 3}
-00019080: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00019090: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-000190a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
-000190b0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000190c0: 6163 6b65 6e64 2e61 6374 696f 6e5f 7365  ackend.action_se
-000190d0: 7428 7b27 6127 3a20 7b27 6227 3a20 312c  t({'a': {'b': 1,
-000190e0: 2027 6327 3a20 322c 2027 6427 3a20 7b27   'c': 2, 'd': {'
-000190f0: 6527 3a20 337d 7d2c 2027 6627 3a20 342c  e': 3}}, 'f': 4,
-00019100: 2027 612e 642e 6527 3a20 2766 6f6f 277d   'a.d.e': 'foo'}
-00019110: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00019120: 6163 7469 6f6e 5f66 6169 6c28 7365 6c66  action_fail(self
-00019130: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-00019140: 7363 7269 7074 2873 656c 662c 2027 6163  script(self, 'ac
-00019150: 7469 6f6e 2d67 6574 272c 2027 6578 6974  tion-get', 'exit
-00019160: 2031 2729 0a20 2020 2020 2020 2066 616b   1').        fak
-00019170: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00019180: 6163 7469 6f6e 2d66 6169 6c27 2c20 2765  action-fail', 'e
-00019190: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
-000191a0: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
-000191b0: 696f 6e5f 6661 696c 2827 6572 726f 7220  ion_fail('error 
-000191c0: 3432 2729 0a20 2020 2020 2020 2073 656c  42').        sel
-000191d0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-000191e0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-000191f0: 7365 6c66 292c 205b 5b27 6163 7469 6f6e  self), [['action
-00019200: 2d66 6169 6c27 2c20 2765 7272 6f72 2034  -fail', 'error 4
-00019210: 3227 5d5d 290a 0a20 2020 2064 6566 2074  2']])..    def t
-00019220: 6573 745f 6163 7469 6f6e 5f6c 6f67 2873  est_action_log(s
-00019230: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-00019240: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00019250: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
-00019260: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-00019270: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00019280: 2c20 2761 6374 696f 6e2d 6c6f 6727 2c20  , 'action-log', 
-00019290: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
-000192a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-000192b0: 6374 696f 6e5f 6c6f 6728 2770 726f 6772  ction_log('progr
-000192c0: 6573 733a 2034 3225 2729 0a20 2020 2020  ess: 42%').     
-000192d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000192e0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-000192f0: 6361 6c6c 7328 7365 6c66 292c 205b 5b27  calls(self), [['
-00019300: 6163 7469 6f6e 2d6c 6f67 272c 2027 7072  action-log', 'pr
-00019310: 6f67 7265 7373 3a20 3432 2527 5d5d 290a  ogress: 42%']]).
-00019320: 0a20 2020 2064 6566 2074 6573 745f 6170  .    def test_ap
-00019330: 706c 6963 6174 696f 6e5f 7665 7273 696f  plication_versio
-00019340: 6e5f 7365 7428 7365 6c66 293a 0a20 2020  n_set(self):.   
-00019350: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00019360: 2873 656c 662c 2027 6170 706c 6963 6174  (self, 'applicat
-00019370: 696f 6e2d 7665 7273 696f 6e2d 7365 7427  ion-version-set'
-00019380: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
-00019390: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-000193a0: 2e61 7070 6c69 6361 7469 6f6e 5f76 6572  .application_ver
-000193b0: 7369 6f6e 5f73 6574 2827 312e 3262 3327  sion_set('1.2b3'
-000193c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000193d0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-000193e0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-000193f0: 6629 2c20 5b5b 2761 7070 6c69 6361 7469  f), [['applicati
-00019400: 6f6e 2d76 6572 7369 6f6e 2d73 6574 272c  on-version-set',
-00019410: 2027 2d2d 272c 2027 312e 3262 3327 5d5d   '--', '1.2b3']]
-00019420: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00019430: 6170 706c 6963 6174 696f 6e5f 7665 7273  application_vers
-00019440: 696f 6e5f 7365 745f 696e 7661 6c69 6428  ion_set_invalid(
-00019450: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-00019460: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00019470: 2027 6170 706c 6963 6174 696f 6e2d 7665   'application-ve
-00019480: 7273 696f 6e2d 7365 7427 2c20 2765 7869  rsion-set', 'exi
-00019490: 7420 3027 290a 2020 2020 2020 2020 7769  t 0').        wi
-000194a0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-000194b0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-000194c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000194d0: 662e 6261 636b 656e 642e 6170 706c 6963  f.backend.applic
-000194e0: 6174 696f 6e5f 7665 7273 696f 6e5f 7365  ation_version_se
-000194f0: 7428 3229 0a20 2020 2020 2020 2077 6974  t(2).        wit
-00019500: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00019510: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-00019520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019530: 2e62 6163 6b65 6e64 2e61 7070 6c69 6361  .backend.applica
-00019540: 7469 6f6e 5f76 6572 7369 6f6e 5f73 6574  tion_version_set
-00019550: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00019560: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-00019570: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-00019580: 6c66 292c 205b 5d29 0a0a 2020 2020 6465  lf), [])..    de
-00019590: 6620 7465 7374 5f6a 756a 755f 6c6f 6728  f test_juju_log(
-000195a0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-000195b0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-000195c0: 2027 6a75 6a75 2d6c 6f67 272c 2027 6578   'juju-log', 'ex
-000195d0: 6974 2030 2729 0a20 2020 2020 2020 2073  it 0').        s
-000195e0: 656c 662e 6261 636b 656e 642e 6a75 6a75  elf.backend.juju
-000195f0: 5f6c 6f67 2827 5741 524e 494e 4727 2c20  _log('WARNING', 
-00019600: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
-00019610: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019620: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00019630: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-00019640: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-00019650: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
-00019660: 276a 756a 752d 6c6f 6727 2c20 272d 2d6c  'juju-log', '--l
-00019670: 6f67 2d6c 6576 656c 272c 2027 5741 524e  og-level', 'WARN
-00019680: 494e 4727 2c20 272d 2d27 2c20 2766 6f6f  ING', '--', 'foo
-00019690: 275d 5d29 0a0a 2020 2020 2020 2020 7769  ']])..        wi
-000196a0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-000196b0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-000196c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000196d0: 662e 6261 636b 656e 642e 6a75 6a75 5f6c  f.backend.juju_l
-000196e0: 6f67 2827 4445 4255 4727 290a 2020 2020  og('DEBUG').    
-000196f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00019700: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-00019710: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-00019720: 6172 3d54 7275 6529 2c20 5b5d 290a 0a20  ar=True), []).. 
-00019730: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00019740: 7074 2873 656c 662c 2027 6a75 6a75 2d6c  pt(self, 'juju-l
-00019750: 6f67 272c 2027 6578 6974 2031 2729 0a20  og', 'exit 1'). 
-00019760: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00019770: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-00019780: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
-00019790: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000197a0: 6261 636b 656e 642e 6a75 6a75 5f6c 6f67  backend.juju_log
-000197b0: 2827 4241 5227 2c20 2766 6f6f 2729 0a20  ('BAR', 'foo'). 
-000197c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000197d0: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-000197e0: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-000197f0: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-00019800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019810: 2020 2020 2020 5b5b 276a 756a 752d 6c6f        [['juju-lo
-00019820: 6727 2c20 272d 2d6c 6f67 2d6c 6576 656c  g', '--log-level
-00019830: 272c 2027 4241 5227 2c20 272d 2d27 2c20  ', 'BAR', '--', 
-00019840: 2766 6f6f 275d 5d29 0a0a 2020 2020 6465  'foo']])..    de
-00019850: 6620 7465 7374 5f76 616c 6964 5f6d 6574  f test_valid_met
-00019860: 7269 6373 2873 656c 6629 3a0a 2020 2020  rics(self):.    
-00019870: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00019880: 7365 6c66 2c20 2761 6464 2d6d 6574 7269  self, 'add-metri
-00019890: 6327 2c20 2765 7869 7420 3027 290a 2020  c', 'exit 0').  
-000198a0: 2020 2020 2020 7465 7374 5f63 6173 6573        test_cases
-000198b0: 203d 205b 280a 2020 2020 2020 2020 2020   = [(.          
-000198c0: 2020 4f72 6465 7265 6444 6963 7428 5b28    OrderedDict([(
-000198d0: 2766 6f6f 272c 2034 3229 2c20 2827 622d  'foo', 42), ('b-
-000198e0: 6172 272c 2034 2e35 292c 2028 2762 615f  ar', 4.5), ('ba_
-000198f0: 2d7a 272c 2034 2e35 292c 2028 2761 272c  -z', 4.5), ('a',
-00019900: 2031 295d 292c 0a20 2020 2020 2020 2020   1)]),.         
-00019910: 2020 204f 7264 6572 6564 4469 6374 285b     OrderedDict([
-00019920: 2827 6465 272c 2027 6164 2729 2c20 2827  ('de', 'ad'), ('
-00019930: 6265 272c 2027 6566 5f20 2d27 295d 292c  be', 'ef_ -')]),
-00019940: 0a20 2020 2020 2020 2020 2020 205b 5b27  .            [['
-00019950: 6164 642d 6d65 7472 6963 272c 2027 2d2d  add-metric', '--
-00019960: 6c61 6265 6c73 272c 2027 6465 3d61 642c  labels', 'de=ad,
-00019970: 6265 3d65 665f 202d 272c 0a20 2020 2020  be=ef_ -',.     
-00019980: 2020 2020 2020 2020 2027 666f 6f3d 3432           'foo=42
-00019990: 272c 2027 622d 6172 3d34 2e35 272c 2027  ', 'b-ar=4.5', '
-000199a0: 6261 5f2d 7a3d 342e 3527 2c20 2761 3d31  ba_-z=4.5', 'a=1
-000199b0: 275d 5d0a 2020 2020 2020 2020 292c 2028  ']].        ), (
-000199c0: 0a20 2020 2020 2020 2020 2020 204f 7264  .            Ord
-000199d0: 6572 6564 4469 6374 285b 2827 666f 6f31  eredDict([('foo1
-000199e0: 272c 2030 292c 2028 2762 3272 272c 2034  ', 0), ('b2r', 4
-000199f0: 2e35 295d 292c 0a20 2020 2020 2020 2020  .5)]),.         
-00019a00: 2020 204f 7264 6572 6564 4469 6374 285b     OrderedDict([
-00019a10: 2827 6433 272c 2027 61d0 b427 292c 2028  ('d3', 'a..'), (
-00019a20: 2762 3333 6627 2c20 2733 5f20 2d27 295d  'b33f', '3_ -')]
-00019a30: 292c 0a20 2020 2020 2020 2020 2020 205b  ),.            [
-00019a40: 5b27 6164 642d 6d65 7472 6963 272c 2027  ['add-metric', '
-00019a50: 2d2d 6c61 6265 6c73 272c 2027 6433 3d61  --labels', 'd3=a
-00019a60: d0b4 2c62 3333 663d 335f 202d 272c 2027  ..,b33f=3_ -', '
-00019a70: 666f 6f31 3d30 272c 2027 6232 723d 342e  foo1=0', 'b2r=4.
-00019a80: 3527 5d5d 2c0a 2020 2020 2020 2020 295d  5']],.        )]
-00019a90: 0a20 2020 2020 2020 2066 6f72 206d 6574  .        for met
-00019aa0: 7269 6373 2c20 6c61 6265 6c73 2c20 6578  rics, labels, ex
-00019ab0: 7065 6374 6564 5f63 616c 6c73 2069 6e20  pected_calls in 
-00019ac0: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
-00019ad0: 2020 2020 2020 2020 7365 6c66 2e62 6163          self.bac
-00019ae0: 6b65 6e64 2e61 6464 5f6d 6574 7269 6373  kend.add_metrics
-00019af0: 286d 6574 7269 6373 2c20 6c61 6265 6c73  (metrics, labels
-00019b00: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00019b10: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00019b20: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00019b30: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-00019b40: 6529 2c20 6578 7065 6374 6564 5f63 616c  e), expected_cal
-00019b50: 6c73 290a 0a20 2020 2064 6566 2074 6573  ls)..    def tes
-00019b60: 745f 696e 7661 6c69 645f 6d65 7472 6963  t_invalid_metric
-00019b70: 5f6e 616d 6573 2873 656c 6629 3a0a 2020  _names(self):.  
-00019b80: 2020 2020 2020 696e 7661 6c69 645f 696e        invalid_in
-00019b90: 7075 7473 203d 205b 0a20 2020 2020 2020  puts = [.       
-00019ba0: 2020 2020 2028 7b27 273a 2034 2e32 7d2c       ({'': 4.2},
-00019bb0: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
-00019bc0: 2020 287b 2731 273a 2034 2e32 7d2c 207b    ({'1': 4.2}, {
-00019bd0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00019be0: 287b 2731 273a 202d 342e 327d 2c20 7b7d  ({'1': -4.2}, {}
-00019bf0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00019c00: 7b27 3132 3327 3a20 342e 327d 2c20 7b7d  {'123': 4.2}, {}
-00019c10: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00019c20: 7b27 3166 6f6f 273a 2034 2e32 7d2c 207b  {'1foo': 4.2}, {
-00019c30: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00019c40: 287b 272d 666f 6f27 3a20 342e 327d 2c20  ({'-foo': 4.2}, 
-00019c50: 7b7d 292c 0a20 2020 2020 2020 2020 2020  {}),.           
-00019c60: 2028 7b27 5f66 6f6f 273a 2034 2e32 7d2c   ({'_foo': 4.2},
-00019c70: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
-00019c80: 2020 287b 2766 6f6f 2d27 3a20 342e 327d    ({'foo-': 4.2}
-00019c90: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-00019ca0: 2020 2028 7b27 666f 6f5f 273a 2034 2e32     ({'foo_': 4.2
-00019cb0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
-00019cc0: 2020 2020 287b 2761 2d27 3a20 342e 327d      ({'a-': 4.2}
-00019cd0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-00019ce0: 2020 2028 7b27 615f 273a 2034 2e32 7d2c     ({'a_': 4.2},
-00019cf0: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
-00019d00: 2020 287b 2742 41d0 af27 3a20 342e 327d    ({'BA..': 4.2}
-00019d10: 2c20 7b7d 292c 0a20 2020 2020 2020 205d  , {}),.        ]
-00019d20: 0a20 2020 2020 2020 2066 6f72 206d 6574  .        for met
-00019d30: 7269 6373 2c20 6c61 6265 6c73 2069 6e20  rics, labels in 
-00019d40: 696e 7661 6c69 645f 696e 7075 7473 3a0a  invalid_inputs:.
-00019d50: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00019d60: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00019d70: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
-00019d80: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00019d90: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-00019da0: 2e61 6464 5f6d 6574 7269 6373 286d 6574  .add_metrics(met
-00019db0: 7269 6373 2c20 6c61 6265 6c73 290a 0a20  rics, labels).. 
-00019dc0: 2020 2064 6566 2074 6573 745f 696e 7661     def test_inva
-00019dd0: 6c69 645f 6d65 7472 6963 5f76 616c 7565  lid_metric_value
-00019de0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00019df0: 2069 6e76 616c 6964 5f69 6e70 7574 7320   invalid_inputs 
-00019e00: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00019e10: 287b 2761 273a 2066 6c6f 6174 2827 2b69  ({'a': float('+i
-00019e20: 6e66 2729 7d2c 207b 7d29 2c0a 2020 2020  nf')}, {}),.    
-00019e30: 2020 2020 2020 2020 287b 2761 273a 2066          ({'a': f
-00019e40: 6c6f 6174 2827 2d69 6e66 2729 7d2c 207b  loat('-inf')}, {
-00019e50: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00019e60: 287b 2761 273a 2066 6c6f 6174 2827 6e61  ({'a': float('na
-00019e70: 6e27 297d 2c20 7b7d 292c 0a20 2020 2020  n')}, {}),.     
-00019e80: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
-00019e90: 2762 6172 277d 2c20 7b7d 292c 0a20 2020  'bar'}, {}),.   
-00019ea0: 2020 2020 2020 2020 2028 7b27 666f 6f27           ({'foo'
-00019eb0: 3a20 2731 4f27 7d2c 207b 7d29 2c0a 2020  : '1O'}, {}),.  
-00019ec0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00019ed0: 666f 7220 6d65 7472 6963 732c 206c 6162  for metrics, lab
-00019ee0: 656c 7320 696e 2069 6e76 616c 6964 5f69  els in invalid_i
-00019ef0: 6e70 7574 733a 0a20 2020 2020 2020 2020  nputs:.         
-00019f00: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00019f10: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
-00019f20: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
-00019f30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019f40: 6261 636b 656e 642e 6164 645f 6d65 7472  backend.add_metr
-00019f50: 6963 7328 6d65 7472 6963 732c 206c 6162  ics(metrics, lab
-00019f60: 656c 7329 0a0a 2020 2020 6465 6620 7465  els)..    def te
-00019f70: 7374 5f69 6e76 616c 6964 5f6d 6574 7269  st_invalid_metri
-00019f80: 635f 6c61 6265 6c73 2873 656c 6629 3a0a  c_labels(self):.
-00019f90: 2020 2020 2020 2020 696e 7661 6c69 645f          invalid_
-00019fa0: 696e 7075 7473 203d 205b 0a20 2020 2020  inputs = [.     
-00019fb0: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
-00019fc0: 342e 327d 2c20 7b27 273a 2027 6261 7a27  4.2}, {'': 'baz'
-00019fd0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
-00019fe0: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
-00019ff0: 272c 6261 7227 3a20 2762 617a 277d 292c  ',bar': 'baz'}),
-0001a000: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
-0001a010: 666f 6f27 3a20 342e 327d 2c20 7b27 623d  foo': 4.2}, {'b=
-0001a020: 613d 7227 3a20 2762 617a 277d 292c 0a20  a=r': 'baz'}),. 
-0001a030: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
-0001a040: 6f27 3a20 342e 327d 2c20 7b27 4241 d0af  o': 4.2}, {'BA..
-0001a050: 273a 2027 6261 7a27 7d29 2c0a 2020 2020  ': 'baz'}),.    
-0001a060: 2020 2020 5d0a 2020 2020 2020 2020 666f      ].        fo
-0001a070: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
-0001a080: 7320 696e 2069 6e76 616c 6964 5f69 6e70  s in invalid_inp
-0001a090: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
-0001a0a0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0001a0b0: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
-0001a0c0: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
-0001a0d0: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-0001a0e0: 636b 656e 642e 6164 645f 6d65 7472 6963  ckend.add_metric
-0001a0f0: 7328 6d65 7472 6963 732c 206c 6162 656c  s(metrics, label
-0001a100: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
-0001a110: 5f69 6e76 616c 6964 5f6d 6574 7269 635f  _invalid_metric_
-0001a120: 6c61 6265 6c5f 7661 6c75 6573 2873 656c  label_values(sel
-0001a130: 6629 3a0a 2020 2020 2020 2020 696e 7661  f):.        inva
-0001a140: 6c69 645f 696e 7075 7473 203d 205b 0a20  lid_inputs = [. 
-0001a150: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
-0001a160: 6f27 3a20 342e 327d 2c20 7b27 6261 7227  o': 4.2}, {'bar'
-0001a170: 3a20 2727 7d29 2c0a 2020 2020 2020 2020  : ''}),.        
-0001a180: 2020 2020 287b 2766 6f6f 273a 2034 2e32      ({'foo': 4.2
-0001a190: 7d2c 207b 2762 6172 273a 2027 622c 617a  }, {'bar': 'b,az
-0001a1a0: 277d 292c 0a20 2020 2020 2020 2020 2020  '}),.           
-0001a1b0: 2028 7b27 666f 6f27 3a20 342e 327d 2c20   ({'foo': 4.2}, 
-0001a1c0: 7b27 6261 7227 3a20 2762 3d61 7a27 7d29  {'bar': 'b=az'})
-0001a1d0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
-0001a1e0: 2020 2020 666f 7220 6d65 7472 6963 732c      for metrics,
-0001a1f0: 206c 6162 656c 7320 696e 2069 6e76 616c   labels in inval
-0001a200: 6964 5f69 6e70 7574 733a 0a20 2020 2020  id_inputs:.     
-0001a210: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0001a220: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-0001a230: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
-0001a240: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001a250: 656c 662e 6261 636b 656e 642e 6164 645f  elf.backend.add_
-0001a260: 6d65 7472 6963 7328 6d65 7472 6963 732c  metrics(metrics,
-0001a270: 206c 6162 656c 7329 0a0a 2020 2020 6465   labels)..    de
-0001a280: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-0001a290: 7265 6d6f 7465 5f61 7070 5f6e 616d 655f  remote_app_name_
-0001a2a0: 656e 7628 7365 6c66 293a 0a20 2020 2020  env(self):.     
-0001a2b0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0001a2c0: 7570 286f 732e 656e 7669 726f 6e2e 706f  up(os.environ.po
-0001a2d0: 702c 2027 4a55 4a55 5f52 454c 4154 494f  p, 'JUJU_RELATIO
-0001a2e0: 4e5f 4944 272c 204e 6f6e 6529 0a20 2020  N_ID', None).   
-0001a2f0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0001a300: 616e 7570 286f 732e 656e 7669 726f 6e2e  anup(os.environ.
-0001a310: 706f 702c 2027 4a55 4a55 5f52 454d 4f54  pop, 'JUJU_REMOT
-0001a320: 455f 4150 5027 2c20 4e6f 6e65 290a 0a20  E_APP', None).. 
-0001a330: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
-0001a340: 6e5b 274a 554a 555f 5245 4c41 5449 4f4e  n['JUJU_RELATION
-0001a350: 5f49 4427 5d20 3d20 2778 3a35 270a 2020  _ID'] = 'x:5'.  
-0001a360: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
-0001a370: 5b27 4a55 4a55 5f52 454d 4f54 455f 4150  ['JUJU_REMOTE_AP
-0001a380: 5027 5d20 3d20 2772 656d 6f74 6561 7070  P'] = 'remoteapp
-0001a390: 3127 0a20 2020 2020 2020 2073 656c 662e  1'.        self.
-0001a3a0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0001a3b0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
-0001a3c0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
-0001a3d0: 6528 3529 2c20 2772 656d 6f74 6561 7070  e(5), 'remoteapp
-0001a3e0: 3127 290a 2020 2020 2020 2020 6f73 2e65  1').        os.e
-0001a3f0: 6e76 6972 6f6e 5b27 4a55 4a55 5f52 454c  nviron['JUJU_REL
-0001a400: 4154 494f 4e5f 4944 275d 203d 2027 3527  ATION_ID'] = '5'
-0001a410: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a420: 7365 7274 4571 7561 6c28 7365 6c66 2e62  sertEqual(self.b
-0001a430: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-0001a440: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
-0001a450: 3529 2c20 2772 656d 6f74 6561 7070 3127  5), 'remoteapp1'
-0001a460: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001a470: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-0001a480: 6170 705f 6e61 6d65 5f73 6372 6970 745f  app_name_script_
-0001a490: 7375 6363 6573 7328 7365 6c66 293a 0a20  success(self):. 
-0001a4a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0001a4b0: 6c65 616e 7570 286f 732e 656e 7669 726f  leanup(os.enviro
-0001a4c0: 6e2e 706f 702c 2027 4a55 4a55 5f52 454c  n.pop, 'JUJU_REL
-0001a4d0: 4154 494f 4e5f 4944 272c 204e 6f6e 6529  ATION_ID', None)
-0001a4e0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001a4f0: 6443 6c65 616e 7570 286f 732e 656e 7669  dCleanup(os.envi
-0001a500: 726f 6e2e 706f 702c 2027 4a55 4a55 5f52  ron.pop, 'JUJU_R
-0001a510: 454d 4f54 455f 4150 5027 2c20 4e6f 6e65  EMOTE_APP', None
-0001a520: 290a 0a20 2020 2020 2020 2023 204a 554a  )..        # JUJ
-0001a530: 555f 5245 4c41 5449 4f4e 5f49 4420 616e  U_RELATION_ID an
-0001a540: 6420 4a55 4a55 5f52 454d 4f54 455f 4150  d JUJU_REMOTE_AP
-0001a550: 5020 626f 7468 2075 6e73 6574 0a20 2020  P both unset.   
-0001a560: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001a570: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
-0001a580: 2d6c 6973 7427 2c20 7222 2222 0a65 6368  -list', r""".ech
-0001a590: 6f20 2722 7265 6d6f 7465 6170 7032 2227  o '"remoteapp2"'
-0001a5a0: 0a22 2222 290a 2020 2020 2020 2020 7365  .""").        se
-0001a5b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0001a5c0: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
-0001a5d0: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
-0001a5e0: 6e61 6d65 2831 292c 2027 7265 6d6f 7465  name(1), 'remote
-0001a5f0: 6170 7032 2729 0a20 2020 2020 2020 2073  app2').        s
-0001a600: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a610: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001a620: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001a630: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
-0001a640: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
-0001a650: 7374 272c 2027 2d72 272c 2027 3127 2c20  st', '-r', '1', 
-0001a660: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
-0001a670: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001a680: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
-0001a690: 204a 554a 555f 5245 4c41 5449 4f4e 5f49   JUJU_RELATION_I
-0001a6a0: 4420 7365 7420 6275 7420 4a55 4a55 5f52  D set but JUJU_R
-0001a6b0: 454d 4f54 455f 4150 5020 756e 7365 740a  EMOTE_APP unset.
-0001a6c0: 2020 2020 2020 2020 6f73 2e65 6e76 6972          os.envir
-0001a6d0: 6f6e 5b27 4a55 4a55 5f52 454c 4154 494f  on['JUJU_RELATIO
-0001a6e0: 4e5f 4944 275d 203d 2027 783a 3527 0a20  N_ID'] = 'x:5'. 
-0001a6f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001a700: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
-0001a710: 6b65 6e64 2e72 656c 6174 696f 6e5f 7265  kend.relation_re
-0001a720: 6d6f 7465 5f61 7070 5f6e 616d 6528 3529  mote_app_name(5)
-0001a730: 2c20 2772 656d 6f74 6561 7070 3227 290a  , 'remoteapp2').
-0001a740: 0a20 2020 2020 2020 2023 204a 554a 555f  .        # JUJU_
-0001a750: 5245 4c41 5449 4f4e 5f49 4420 756e 7365  RELATION_ID unse
-0001a760: 7420 6275 7420 4a55 4a55 5f52 454d 4f54  t but JUJU_REMOT
-0001a770: 455f 4150 5020 7365 740a 2020 2020 2020  E_APP set.      
-0001a780: 2020 6465 6c20 6f73 2e65 6e76 6972 6f6e    del os.environ
-0001a790: 5b27 4a55 4a55 5f52 454c 4154 494f 4e5f  ['JUJU_RELATION_
-0001a7a0: 4944 275d 0a20 2020 2020 2020 206f 732e  ID'].        os.
-0001a7b0: 656e 7669 726f 6e5b 274a 554a 555f 5245  environ['JUJU_RE
-0001a7c0: 4d4f 5445 5f41 5050 275d 203d 2027 7265  MOTE_APP'] = 're
-0001a7d0: 6d6f 7465 6170 7031 270a 2020 2020 2020  moteapp1'.      
-0001a7e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a7f0: 616c 2873 656c 662e 6261 636b 656e 642e  al(self.backend.
-0001a800: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-0001a810: 6170 705f 6e61 6d65 2835 292c 2027 7265  app_name(5), 're
-0001a820: 6d6f 7465 6170 7032 2729 0a0a 2020 2020  moteapp2')..    
-0001a830: 2020 2020 2320 426f 7468 2073 6574 2c20      # Both set, 
-0001a840: 6275 7420 4a55 4a55 5f52 454c 4154 494f  but JUJU_RELATIO
-0001a850: 4e5f 4944 2061 2064 6966 6665 7265 6e74  N_ID a different
-0001a860: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
-0001a870: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
-0001a880: 4a55 5f52 454c 4154 494f 4e5f 4944 275d  JU_RELATION_ID']
-0001a890: 203d 2027 783a 3627 0a20 2020 2020 2020   = 'x:6'.       
-0001a8a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001a8b0: 6c28 7365 6c66 2e62 6163 6b65 6e64 2e72  l(self.backend.r
-0001a8c0: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
-0001a8d0: 7070 5f6e 616d 6528 3529 2c20 2772 656d  pp_name(5), 'rem
-0001a8e0: 6f74 6561 7070 3227 290a 0a20 2020 2064  oteapp2')..    d
-0001a8f0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
-0001a900: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
-0001a910: 5f73 6372 6970 745f 6572 726f 7273 2873  _script_errors(s
-0001a920: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001a930: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001a940: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
-0001a950: 2072 2222 220a 6563 686f 2022 4552 524f   r""".echo "ERRO
-0001a960: 5220 696e 7661 6c69 6420 7661 6c75 6520  R invalid value 
-0001a970: 5c22 365c 2220 666f 7220 6f70 7469 6f6e  \"6\" for option
-0001a980: 202d 723a 2072 656c 6174 696f 6e20 6e6f   -r: relation no
-0001a990: 7420 666f 756e 6422 203e 2632 2020 2320  t found" >&2  # 
-0001a9a0: 4e4f 5141 0a65 7869 7420 320a 2222 2229  NOQA.exit 2.""")
-0001a9b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a9c0: 7365 7274 4973 2873 656c 662e 6261 636b  sertIs(self.back
-0001a9d0: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
-0001a9e0: 6f74 655f 6170 705f 6e61 6d65 2836 292c  ote_app_name(6),
-0001a9f0: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
-0001aa00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001aa10: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001aa20: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001aa30: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
-0001aa40: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
-0001aa50: 7374 272c 2027 2d72 272c 2027 3627 2c20  st', '-r', '6', 
-0001aa60: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
-0001aa70: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001aa80: 2020 205d 290a 0a20 2020 2020 2020 2066     ])..        f
-0001aa90: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001aaa0: 2027 7265 6c61 7469 6f6e 2d6c 6973 7427   'relation-list'
-0001aab0: 2c20 7222 2222 0a65 6368 6f20 2245 5252  , r""".echo "ERR
-0001aac0: 4f52 206f 7074 696f 6e20 7072 6f76 6964  OR option provid
-0001aad0: 6564 2062 7574 206e 6f74 2064 6566 696e  ed but not defin
-0001aae0: 6564 3a20 2d2d 6170 7022 203e 2632 0a65  ed: --app" >&2.e
-0001aaf0: 7869 7420 320a 2222 2229 0a20 2020 2020  xit 2.""").     
-0001ab00: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001ab10: 2873 656c 662e 6261 636b 656e 642e 7265  (self.backend.re
-0001ab20: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
-0001ab30: 705f 6e61 6d65 2836 292c 204e 6f6e 6529  p_name(6), None)
-0001ab40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ab50: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001ab60: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001ab70: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001ab80: 0a20 2020 2020 2020 2020 2020 205b 2772  .            ['r
-0001ab90: 656c 6174 696f 6e2d 6c69 7374 272c 2027  elation-list', '
-0001aba0: 2d72 272c 2027 3627 2c20 272d 2d61 7070  -r', '6', '--app
-0001abb0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-0001abc0: 6e27 5d2c 0a20 2020 2020 2020 205d 290a  n'],.        ]).
-0001abd0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
-0001abe0: 616e 6e65 645f 756e 6974 7328 7365 6c66  anned_units(self
-0001abf0: 293a 0a20 2020 2020 2020 2023 206e 6f20  ):.        # no 
-0001ac00: 756e 6974 730a 2020 2020 2020 2020 6661  units.        fa
-0001ac10: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001ac20: 2767 6f61 6c2d 7374 6174 6527 2c20 2222  'goal-state', ""
-0001ac30: 220a 6563 686f 2027 7b22 756e 6974 7322  ".echo '{"units"
-0001ac40: 3a7b 7d2c 2022 7265 6c61 7469 6f6e 7322  :{}, "relations"
-0001ac50: 3a7b 7d7d 270a 2222 2229 0a20 2020 2020  :{}}'.""").     
-0001ac60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001ac70: 7561 6c28 7365 6c66 2e62 6163 6b65 6e64  ual(self.backend
-0001ac80: 2e70 6c61 6e6e 6564 5f75 6e69 7473 2829  .planned_units()
-0001ac90: 2c20 3029 0a0a 2020 2020 2020 2020 2320  , 0)..        # 
-0001aca0: 6f6e 6c79 2061 6374 6976 6520 756e 6974  only active unit
-0001acb0: 730a 2020 2020 2020 2020 6661 6b65 5f73  s.        fake_s
-0001acc0: 6372 6970 7428 7365 6c66 2c20 2767 6f61  cript(self, 'goa
-0001acd0: 6c2d 7374 6174 6527 2c20 2222 220a 6563  l-state', """.ec
-0001ace0: 686f 2027 7b0a 2020 2020 2275 6e69 7473  ho '{.    "units
-0001acf0: 223a 7b0a 2020 2020 2020 2020 2261 7070  ":{.        "app
-0001ad00: 2f30 223a 207b 2273 7461 7475 7322 3a22  /0": {"status":"
-0001ad10: 6163 7469 7665 222c 2273 696e 6365 223a  active","since":
-0001ad20: 2232 3032 332d 3035 2d32 3320 3137 3a30  "2023-05-23 17:0
-0001ad30: 353a 3035 5a22 7d2c 0a20 2020 2020 2020  5:05Z"},.       
-0001ad40: 2022 6170 702f 3122 3a20 7b22 7374 6174   "app/1": {"stat
-0001ad50: 7573 223a 2261 6374 6976 6522 2c22 7369  us":"active","si
-0001ad60: 6e63 6522 3a22 3230 3233 2d30 352d 3233  nce":"2023-05-23
-0001ad70: 2031 373a 3537 3a30 355a 227d 0a20 2020   17:57:05Z"}.   
-0001ad80: 207d 2c0a 2020 2020 2272 656c 6174 696f   },.    "relatio
-0001ad90: 6e73 223a 207b 7d0a 7d27 2222 2229 0a20  ns": {}.}'"""). 
-0001ada0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001adb0: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
-0001adc0: 6b65 6e64 2e70 6c61 6e6e 6564 5f75 6e69  kend.planned_uni
-0001add0: 7473 2829 2c20 3229 0a0a 2020 2020 2020  ts(), 2)..      
-0001ade0: 2020 2320 6163 7469 7665 2061 6e64 2064    # active and d
-0001adf0: 7969 6e67 2075 6e69 7473 0a20 2020 2020  ying units.     
-0001ae00: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001ae10: 656c 662c 2027 676f 616c 2d73 7461 7465  elf, 'goal-state
-0001ae20: 272c 2022 2222 0a65 6368 6f20 277b 0a20  ', """.echo '{. 
-0001ae30: 2020 2022 756e 6974 7322 3a7b 0a20 2020     "units":{.   
-0001ae40: 2020 2020 2022 6170 702f 3022 3a20 7b22       "app/0": {"
-0001ae50: 7374 6174 7573 223a 2261 6374 6976 6522  status":"active"
-0001ae60: 2c22 7369 6e63 6522 3a22 3230 3233 2d30  ,"since":"2023-0
-0001ae70: 352d 3233 2031 373a 3035 3a30 355a 227d  5-23 17:05:05Z"}
-0001ae80: 2c0a 2020 2020 2020 2020 2261 7070 2f31  ,.        "app/1
-0001ae90: 223a 207b 2273 7461 7475 7322 3a22 6479  ": {"status":"dy
-0001aea0: 696e 6722 2c22 7369 6e63 6522 3a22 3230  ing","since":"20
-0001aeb0: 3233 2d30 352d 3233 2031 373a 3537 3a30  23-05-23 17:57:0
-0001aec0: 355a 227d 0a20 2020 207d 2c0a 2020 2020  5Z"}.    },.    
-0001aed0: 2272 656c 6174 696f 6e73 223a 207b 7d0a  "relations": {}.
-0001aee0: 7d27 2222 2229 0a20 2020 2020 2020 2073  }'""").        s
-0001aef0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001af00: 7365 6c66 2e62 6163 6b65 6e64 2e70 6c61  self.backend.pla
-0001af10: 6e6e 6564 5f75 6e69 7473 2829 2c20 3129  nned_units(), 1)
-0001af20: 0a0a 0a63 6c61 7373 2054 6573 744c 617a  ...class TestLaz
-0001af30: 794d 6170 7069 6e67 2875 6e69 7474 6573  yMapping(unittes
-0001af40: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
-0001af50: 2020 6465 6620 7465 7374 5f69 6e76 616c    def test_inval
-0001af60: 6964 6174 6528 7365 6c66 293a 0a20 2020  idate(self):.   
-0001af70: 2020 2020 206c 6f61 6465 6420 3d20 5b5d       loaded = []
-0001af80: 0a0a 2020 2020 2020 2020 636c 6173 7320  ..        class 
-0001af90: 4d79 4c61 7a79 4d61 7028 6f70 732e 4c61  MyLazyMap(ops.La
-0001afa0: 7a79 4d61 7070 696e 6729 3a0a 2020 2020  zyMapping):.    
-0001afb0: 2020 2020 2020 2020 6465 6620 5f6c 6f61          def _loa
-0001afc0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-0001afd0: 2020 2020 2020 2020 206c 6f61 6465 642e           loaded.
-0001afe0: 6170 7065 6e64 2831 290a 2020 2020 2020  append(1).      
-0001aff0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001b000: 207b 2766 6f6f 273a 2027 6261 7227 7d0a   {'foo': 'bar'}.
-0001b010: 0a20 2020 2020 2020 206d 6170 203d 204d  .        map = M
-0001b020: 794c 617a 794d 6170 2829 0a20 2020 2020  yLazyMap().     
-0001b030: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001b040: 7561 6c28 6d61 705b 2766 6f6f 275d 2c20  ual(map['foo'], 
-0001b050: 2762 6172 2729 0a20 2020 2020 2020 2073  'bar').        s
-0001b060: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001b070: 6c6f 6164 6564 2c20 5b31 5d29 0a20 2020  loaded, [1]).   
-0001b080: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001b090: 4571 7561 6c28 6d61 705b 2766 6f6f 275d  Equal(map['foo']
-0001b0a0: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
-0001b0b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001b0c0: 6c28 6c6f 6164 6564 2c20 5b31 5d29 0a20  l(loaded, [1]). 
-0001b0d0: 2020 2020 2020 206d 6170 2e5f 696e 7661         map._inva
-0001b0e0: 6c69 6461 7465 2829 0a20 2020 2020 2020  lidate().       
-0001b0f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001b100: 6c28 6d61 705b 2766 6f6f 275d 2c20 2762  l(map['foo'], 'b
-0001b110: 6172 2729 0a20 2020 2020 2020 2073 656c  ar').        sel
-0001b120: 662e 6173 7365 7274 4571 7561 6c28 6c6f  f.assertEqual(lo
-0001b130: 6164 6564 2c20 5b31 2c20 315d 290a 0a0a  aded, [1, 1])...
-0001b140: 636c 6173 7320 5465 7374 5365 6372 6574  class TestSecret
-0001b150: 7328 756e 6974 7465 7374 2e54 6573 7443  s(unittest.TestC
-0001b160: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
-0001b170: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
-0001b180: 2020 2073 656c 662e 6d6f 6465 6c20 3d20     self.model = 
-0001b190: 6f70 732e 4d6f 6465 6c28 6f70 732e 4368  ops.Model(ops.Ch
-0001b1a0: 6172 6d4d 6574 6128 292c 205f 4d6f 6465  armMeta(), _Mode
-0001b1b0: 6c42 6163 6b65 6e64 2827 6d79 6170 702f  lBackend('myapp/
-0001b1c0: 3027 2929 0a20 2020 2020 2020 2073 656c  0')).        sel
-0001b1d0: 662e 6170 7020 3d20 7365 6c66 2e6d 6f64  f.app = self.mod
-0001b1e0: 656c 2e61 7070 0a20 2020 2020 2020 2073  el.app.        s
-0001b1f0: 656c 662e 756e 6974 203d 2073 656c 662e  elf.unit = self.
-0001b200: 6d6f 6465 6c2e 756e 6974 0a0a 2020 2020  model.unit..    
-0001b210: 6465 6620 7465 7374 5f61 7070 5f61 6464  def test_app_add
-0001b220: 5f73 6563 7265 745f 7369 6d70 6c65 2873  _secret_simple(s
-0001b230: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001b240: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001b250: 2773 6563 7265 742d 6164 6427 2c20 2765  'secret-add', 'e
-0001b260: 6368 6f20 7365 6372 6574 3a31 3233 2729  cho secret:123')
-0001b270: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0001b280: 203d 2073 656c 662e 6170 702e 6164 645f   = self.app.add_
-0001b290: 7365 6372 6574 287b 2766 6f6f 273a 2027  secret({'foo': '
-0001b2a0: 7827 7d29 0a20 2020 2020 2020 2073 656c  x'}).        sel
-0001b2b0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0001b2c0: 6365 2873 6563 7265 742c 206f 7073 2e53  ce(secret, ops.S
-0001b2d0: 6563 7265 7429 0a20 2020 2020 2020 2073  ecret).        s
-0001b2e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001b2f0: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
-0001b300: 6574 3a31 3233 2729 0a20 2020 2020 2020  et:123').       
-0001b310: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001b320: 6e65 2873 6563 7265 742e 6c61 6265 6c29  ne(secret.label)
-0001b330: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0001b340: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-0001b350: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-0001b360: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
-0001b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b380: 2020 2020 2020 2020 205b 5b27 7365 6372           [['secr
-0001b390: 6574 2d61 6464 272c 2027 2d2d 6f77 6e65  et-add', '--owne
-0001b3a0: 7227 2c20 2761 7070 6c69 6361 7469 6f6e  r', 'application
-0001b3b0: 272c 2027 666f 6f3d 7827 5d5d 290a 0a20  ', 'foo=x']]).. 
-0001b3c0: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
-0001b3d0: 6164 645f 7365 6372 6574 5f61 7267 7328  add_secret_args(
-0001b3e0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001b3f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001b400: 2027 7365 6372 6574 2d61 6464 272c 2027   'secret-add', '
-0001b410: 6563 686f 2073 6563 7265 743a 3233 3427  echo secret:234'
-0001b420: 290a 0a20 2020 2020 2020 2065 7870 6972  )..        expir
-0001b430: 6520 3d20 6461 7465 7469 6d65 2e64 6174  e = datetime.dat
-0001b440: 6574 696d 6528 3230 3232 2c20 3132 2c20  etime(2022, 12, 
-0001b450: 392c 2031 362c 2031 372c 2030 290a 2020  9, 16, 17, 0).  
-0001b460: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001b470: 656c 662e 6170 702e 6164 645f 7365 6372  elf.app.add_secr
-0001b480: 6574 287b 2766 6f6f 273a 2027 7827 2c20  et({'foo': 'x', 
-0001b490: 2762 6172 273a 2027 7927 7d2c 206c 6162  'bar': 'y'}, lab
-0001b4a0: 656c 3d27 6c62 6c27 2c20 6465 7363 7269  el='lbl', descri
-0001b4b0: 7074 696f 6e3d 2764 6573 6327 2c0a 2020  ption='desc',.  
-0001b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4e0: 2020 2065 7870 6972 653d 6578 7069 7265     expire=expire
-0001b4f0: 2c20 726f 7461 7465 3d6f 7073 2e53 6563  , rotate=ops.Sec
-0001b500: 7265 7452 6f74 6174 652e 484f 5552 4c59  retRotate.HOURLY
-0001b510: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001b520: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
-0001b530: 742e 6964 2c20 2773 6563 7265 743a 3233  t.id, 'secret:23
-0001b540: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
-0001b550: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001b560: 7265 742e 6c61 6265 6c2c 2027 6c62 6c27  ret.label, 'lbl'
-0001b570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001b580: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
-0001b590: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
-0001b5a0: 207b 2766 6f6f 273a 2027 7827 2c20 2762   {'foo': 'x', 'b
-0001b5b0: 6172 273a 2027 7927 7d29 0a0a 2020 2020  ar': 'y'})..    
-0001b5c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b5d0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-0001b5e0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-0001b5f0: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
-0001b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b610: 2020 205b 5b27 7365 6372 6574 2d61 6464     [['secret-add
-0001b620: 272c 2027 2d2d 6c61 6265 6c27 2c20 276c  ', '--label', 'l
-0001b630: 626c 272c 2027 2d2d 6465 7363 7269 7074  bl', '--descript
-0001b640: 696f 6e27 2c20 2764 6573 6327 2c0a 2020  ion', 'desc',.  
-0001b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b660: 2020 2020 2020 2020 2027 2d2d 6578 7069           '--expi
-0001b670: 7265 272c 2027 3230 3232 2d31 322d 3039  re', '2022-12-09
-0001b680: 5431 363a 3137 3a30 3027 2c20 272d 2d72  T16:17:00', '--r
-0001b690: 6f74 6174 6527 2c20 2768 6f75 726c 7927  otate', 'hourly'
-0001b6a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b6b0: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
-0001b6c0: 6f77 6e65 7227 2c20 2761 7070 6c69 6361  owner', 'applica
-0001b6d0: 7469 6f6e 272c 2027 666f 6f3d 7827 2c20  tion', 'foo=x', 
-0001b6e0: 2762 6172 3d79 275d 5d29 0a0a 2020 2020  'bar=y']])..    
-0001b6f0: 6465 6620 7465 7374 5f75 6e69 745f 6164  def test_unit_ad
-0001b700: 645f 7365 6372 6574 5f73 696d 706c 6528  d_secret_simple(
-0001b710: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001b720: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001b730: 2027 7365 6372 6574 2d61 6464 272c 2027   'secret-add', '
-0001b740: 6563 686f 2073 6563 7265 743a 3334 3527  echo secret:345'
-0001b750: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001b760: 7420 3d20 7365 6c66 2e75 6e69 742e 6164  t = self.unit.ad
-0001b770: 645f 7365 6372 6574 287b 2766 6f6f 273a  d_secret({'foo':
-0001b780: 2027 7827 7d29 0a20 2020 2020 2020 2073   'x'}).        s
-0001b790: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-0001b7a0: 616e 6365 2873 6563 7265 742c 206f 7073  ance(secret, ops
-0001b7b0: 2e53 6563 7265 7429 0a20 2020 2020 2020  .Secret).       
-0001b7c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001b7d0: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
-0001b7e0: 6372 6574 3a33 3435 2729 0a20 2020 2020  cret:345').     
-0001b7f0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001b800: 4e6f 6e65 2873 6563 7265 742e 6c61 6265  None(secret.labe
-0001b810: 6c29 0a0a 2020 2020 2020 2020 7365 6c66  l)..        self
-0001b820: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-0001b830: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-0001b840: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-0001b850: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b860: 2020 2020 2020 2020 2020 205b 5b27 7365             [['se
-0001b870: 6372 6574 2d61 6464 272c 2027 2d2d 6f77  cret-add', '--ow
-0001b880: 6e65 7227 2c20 2775 6e69 7427 2c20 2766  ner', 'unit', 'f
-0001b890: 6f6f 3d78 275d 5d29 0a0a 2020 2020 6465  oo=x']])..    de
-0001b8a0: 6620 7465 7374 5f75 6e69 745f 6164 645f  f test_unit_add_
-0001b8b0: 7365 6372 6574 5f61 7267 7328 7365 6c66  secret_args(self
-0001b8c0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-0001b8d0: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001b8e0: 6372 6574 2d61 6464 272c 2027 6563 686f  cret-add', 'echo
-0001b8f0: 2073 6563 7265 743a 3435 3627 290a 0a20   secret:456').. 
-0001b900: 2020 2020 2020 2065 7870 6972 6520 3d20         expire = 
-0001b910: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-0001b920: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
-0001b930: 362c 2032 322c 2030 290a 2020 2020 2020  6, 22, 0).      
-0001b940: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
-0001b950: 756e 6974 2e61 6464 5f73 6563 7265 7428  unit.add_secret(
-0001b960: 7b27 666f 6f27 3a20 2777 272c 2027 6261  {'foo': 'w', 'ba
-0001b970: 7227 3a20 277a 277d 2c20 6c61 6265 6c3d  r': 'z'}, label=
-0001b980: 276c 3227 2c20 6465 7363 7269 7074 696f  'l2', descriptio
-0001b990: 6e3d 2778 797a 272c 0a20 2020 2020 2020  n='xyz',.       
-0001b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001b9c0: 7870 6972 653d 6578 7069 7265 2c20 726f  xpire=expire, ro
-0001b9d0: 7461 7465 3d6f 7073 2e53 6563 7265 7452  tate=ops.SecretR
-0001b9e0: 6f74 6174 652e 5945 4152 4c59 290a 2020  otate.YEARLY).  
-0001b9f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001ba00: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
-0001ba10: 2c20 2773 6563 7265 743a 3435 3627 290a  , 'secret:456').
-0001ba20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ba30: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001ba40: 6c61 6265 6c2c 2027 6c32 2729 0a20 2020  label, 'l2').   
-0001ba50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001ba60: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
-0001ba70: 5f63 6f6e 7465 6e74 2829 2c20 7b27 666f  _content(), {'fo
-0001ba80: 6f27 3a20 2777 272c 2027 6261 7227 3a20  o': 'w', 'bar': 
-0001ba90: 277a 277d 290a 0a20 2020 2020 2020 2073  'z'})..        s
-0001baa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001bab0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001bac0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001bad0: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0001bae0: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
-0001baf0: 2773 6563 7265 742d 6164 6427 2c20 272d  'secret-add', '-
-0001bb00: 2d6c 6162 656c 272c 2027 6c32 272c 2027  -label', 'l2', '
-0001bb10: 2d2d 6465 7363 7269 7074 696f 6e27 2c20  --description', 
-0001bb20: 2778 797a 272c 0a20 2020 2020 2020 2020  'xyz',.         
-0001bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb40: 2020 272d 2d65 7870 6972 6527 2c20 2732    '--expire', '2
-0001bb50: 3032 322d 3132 2d30 3954 3136 3a32 323a  022-12-09T16:22:
-0001bb60: 3030 272c 2027 2d2d 726f 7461 7465 272c  00', '--rotate',
-0001bb70: 2027 7965 6172 6c79 272c 0a20 2020 2020   'yearly',.     
-0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb90: 2020 2020 2020 272d 2d6f 776e 6572 272c        '--owner',
-0001bba0: 2027 756e 6974 272c 2027 666f 6f3d 7727   'unit', 'foo=w'
-0001bbb0: 2c20 2762 6172 3d7a 275d 5d29 0a0a 2020  , 'bar=z']])..  
-0001bbc0: 2020 6465 6620 7465 7374 5f75 6e69 745f    def test_unit_
-0001bbd0: 6164 645f 7365 6372 6574 5f65 7272 6f72  add_secret_error
-0001bbe0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001bbf0: 2023 2041 6464 6974 696f 6e61 6c20 6164   # Additional ad
-0001bc00: 645f 7365 6372 6574 2074 6573 7473 2061  d_secret tests a
-0001bc10: 7265 2064 6f6e 6520 696e 2054 6573 7441  re done in TestA
-0001bc20: 7070 6c69 6361 7469 6f6e 0a20 2020 2020  pplication.     
-0001bc30: 2020 2065 7272 6f72 7320 3d20 5b0a 2020     errors = [.  
-0001bc40: 2020 2020 2020 2020 2020 287b 2778 7927            ({'xy'
-0001bc50: 3a20 2762 6172 277d 2c20 7b7d 2c20 5661  : 'bar'}, {}, Va
-0001bc60: 6c75 6545 7272 6f72 292c 0a20 2020 2020  lueError),.     
-0001bc70: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
-0001bc80: 2778 277d 2c20 7b27 6578 7069 7265 273a  'x'}, {'expire':
-0001bc90: 2037 7d2c 2054 7970 6545 7272 6f72 292c   7}, TypeError),
-0001bca0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0001bcb0: 2020 2066 6f72 2063 6f6e 7465 6e74 2c20     for content, 
-0001bcc0: 6b77 6172 6773 2c20 6578 635f 7479 7065  kwargs, exc_type
-0001bcd0: 2069 6e20 6572 726f 7273 3a0a 2020 2020   in errors:.    
-0001bce0: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
-0001bcf0: 6578 7065 6374 6564 207b 6578 635f 7479  expected {exc_ty
-0001bd00: 7065 2e5f 5f6e 616d 655f 5f7d 2077 6865  pe.__name__} whe
-0001bd10: 6e20 6164 6469 6e67 2073 6563 7265 7420  n adding secret 
-0001bd20: 636f 6e74 656e 7420 7b63 6f6e 7465 6e74  content {content
-0001bd30: 7d27 0a20 2020 2020 2020 2020 2020 2077  }'.            w
-0001bd40: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0001bd50: 6169 7365 7328 6578 635f 7479 7065 2c20  aises(exc_type, 
-0001bd60: 6d73 673d 6d73 6729 3a0a 2020 2020 2020  msg=msg):.      
-0001bd70: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-0001bd80: 6e69 742e 6164 645f 7365 6372 6574 2863  nit.add_secret(c
-0001bd90: 6f6e 7465 6e74 2c20 2a2a 6b77 6172 6773  ontent, **kwargs
-0001bda0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001bdb0: 6164 645f 7365 6372 6574 5f65 7272 6f72  add_secret_error
-0001bdc0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001bdd0: 2065 7272 6f72 7320 3d20 5b0a 2020 2020   errors = [.    
-0001bde0: 2020 2020 2020 2020 2320 496e 7661 6c69          # Invali
-0001bdf0: 6420 636f 6e74 656e 7420 6469 6374 206f  d content dict o
-0001be00: 7220 7479 7065 730a 2020 2020 2020 2020  r types.        
-0001be10: 2020 2020 284e 6f6e 652c 207b 7d2c 2054      (None, {}, T
-0001be20: 7970 6545 7272 6f72 292c 0a20 2020 2020  ypeError),.     
-0001be30: 2020 2020 2020 2028 7b7d 2c20 7b7d 2c20         ({}, {}, 
-0001be40: 5661 6c75 6545 7272 6f72 292c 0a20 2020  ValueError),.   
-0001be50: 2020 2020 2020 2020 2028 7b62 2766 6f6f           ({b'foo
-0001be60: 272c 2027 6261 7227 7d2c 207b 7d2c 2054  ', 'bar'}, {}, T
-0001be70: 7970 6545 7272 6f72 292c 0a20 2020 2020  ypeError),.     
-0001be80: 2020 2020 2020 2028 7b33 3a20 2762 6172         ({3: 'bar
-0001be90: 277d 2c20 7b7d 2c20 5479 7065 4572 726f  '}, {}, TypeErro
-0001bea0: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
-0001beb0: 287b 2766 6f6f 273a 2031 2c20 2762 6172  ({'foo': 1, 'bar
-0001bec0: 273a 2032 7d2c 207b 7d2c 2054 7970 6545  ': 2}, {}, TypeE
-0001bed0: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001bee0: 2020 2023 2049 6e76 616c 6964 2063 6f6e     # Invalid con
-0001bef0: 7465 6e74 206b 6579 730a 2020 2020 2020  tent keys.      
-0001bf00: 2020 2020 2020 287b 2778 7927 3a20 2762        ({'xy': 'b
-0001bf10: 6172 277d 2c20 7b7d 2c20 5661 6c75 6545  ar'}, {}, ValueE
-0001bf20: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001bf30: 2020 2028 7b27 464f 4f27 3a20 2762 6172     ({'FOO': 'bar
-0001bf40: 277d 2c20 7b7d 2c20 5661 6c75 6545 7272  '}, {}, ValueErr
-0001bf50: 6f72 292c 0a20 2020 2020 2020 2020 2020  or),.           
-0001bf60: 2028 7b27 666f 6f2d 273a 2027 6261 7227   ({'foo-': 'bar'
-0001bf70: 7d2c 207b 7d2c 2056 616c 7565 4572 726f  }, {}, ValueErro
-0001bf80: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
-0001bf90: 287b 272d 666f 6f27 3a20 2762 6172 277d  ({'-foo': 'bar'}
-0001bfa0: 2c20 7b7d 2c20 5661 6c75 6545 7272 6f72  , {}, ValueError
-0001bfb0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
-0001bfc0: 2049 6e76 616c 6964 2022 6578 7069 7265   Invalid "expire
-0001bfd0: 2220 7479 7065 0a20 2020 2020 2020 2020  " type.         
-0001bfe0: 2020 2028 7b27 666f 6f27 3a20 2778 277d     ({'foo': 'x'}
-0001bff0: 2c20 7b27 6578 7069 7265 273a 2037 7d2c  , {'expire': 7},
-0001c000: 2054 7970 6545 7272 6f72 292c 0a20 2020   TypeError),.   
-0001c010: 2020 2020 205d 0a20 2020 2020 2020 2066       ].        f
-0001c020: 6f72 2063 6f6e 7465 6e74 2c20 6b77 6172  or content, kwar
-0001c030: 6773 2c20 6578 635f 7479 7065 2069 6e20  gs, exc_type in 
-0001c040: 6572 726f 7273 3a0a 2020 2020 2020 2020  errors:.        
-0001c050: 2020 2020 6d73 6720 3d20 6627 6578 7065      msg = f'expe
-0001c060: 6374 6564 207b 6578 635f 7479 7065 2e5f  cted {exc_type._
-0001c070: 5f6e 616d 655f 5f7d 2077 6865 6e20 6164  _name__} when ad
-0001c080: 6469 6e67 2073 6563 7265 7420 636f 6e74  ding secret cont
-0001c090: 656e 7420 7b63 6f6e 7465 6e74 7d27 0a20  ent {content}'. 
-0001c0a0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-0001c0b0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0001c0c0: 7328 6578 635f 7479 7065 2c20 6d73 673d  s(exc_type, msg=
-0001c0d0: 6d73 6729 3a0a 2020 2020 2020 2020 2020  msg):.          
-0001c0e0: 2020 2020 2020 7365 6c66 2e61 7070 2e61        self.app.a
-0001c0f0: 6464 5f73 6563 7265 7428 636f 6e74 656e  dd_secret(conten
-0001c100: 742c 202a 2a6b 7761 7267 7329 0a20 2020  t, **kwargs).   
-0001c110: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-0001c120: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0001c130: 6578 635f 7479 7065 2c20 6d73 673d 6d73  exc_type, msg=ms
-0001c140: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
-0001c150: 2020 2020 7365 6c66 2e75 6e69 742e 6164      self.unit.ad
-0001c160: 645f 7365 6372 6574 2863 6f6e 7465 6e74  d_secret(content
-0001c170: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-0001c180: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
-0001c190: 6372 6574 5f69 6428 7365 6c66 293a 0a20  cret_id(self):. 
-0001c1a0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001c1b0: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001c1c0: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
-0001c1d0: 7b22 666f 6f22 3a20 2267 227d 2722 2222  {"foo": "g"}'"""
-0001c1e0: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001c1f0: 7420 3d20 7365 6c66 2e6d 6f64 656c 2e67  t = self.model.g
-0001c200: 6574 5f73 6563 7265 7428 6964 3d27 3132  et_secret(id='12
-0001c210: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
-0001c220: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001c230: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001c240: 3132 3327 290a 2020 2020 2020 2020 7365  123').        se
-0001c250: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0001c260: 7365 6372 6574 2e6c 6162 656c 290a 2020  secret.label).  
-0001c270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001c280: 7445 7175 616c 2873 6563 7265 742e 6765  tEqual(secret.ge
-0001c290: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
-0001c2a0: 6f6f 273a 2027 6727 7d29 0a0a 2020 2020  oo': 'g'})..    
-0001c2b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001c2c0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-0001c2d0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-0001c2e0: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
-0001c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c300: 2020 205b 5b27 7365 6372 6574 2d67 6574     [['secret-get
-0001c310: 272c 2027 7365 6372 6574 3a31 3233 272c  ', 'secret:123',
-0001c320: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-0001c330: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
-0001c340: 745f 6765 745f 7365 6372 6574 5f6c 6162  t_get_secret_lab
-0001c350: 656c 2873 656c 6629 3a0a 2020 2020 2020  el(self):.      
-0001c360: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001c370: 6c66 2c20 2773 6563 7265 742d 6765 7427  lf, 'secret-get'
-0001c380: 2c20 2222 2265 6368 6f20 277b 2266 6f6f  , """echo '{"foo
-0001c390: 223a 2022 6722 7d27 2222 2229 0a0a 2020  ": "g"}'""")..  
-0001c3a0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001c3b0: 656c 662e 6d6f 6465 6c2e 6765 745f 7365  elf.model.get_se
-0001c3c0: 6372 6574 286c 6162 656c 3d27 6c62 6c27  cret(label='lbl'
-0001c3d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001c3e0: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
-0001c3f0: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
-0001c400: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001c410: 7365 6372 6574 2e6c 6162 656c 2c20 276c  secret.label, 'l
-0001c420: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
-0001c430: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001c440: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0001c450: 2829 2c20 7b27 666f 6f27 3a20 2767 277d  (), {'foo': 'g'}
-0001c460: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001c470: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-0001c480: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-0001c490: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
-0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c4b0: 2020 2020 2020 2020 2020 5b5b 2773 6563            [['sec
-0001c4c0: 7265 742d 6765 7427 2c20 272d 2d6c 6162  ret-get', '--lab
-0001c4d0: 656c 272c 2027 6c62 6c27 2c20 272d 2d66  el', 'lbl', '--f
-0001c4e0: 6f72 6d61 743d 6a73 6f6e 275d 5d29 0a0a  ormat=json']])..
-0001c4f0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0001c500: 5f73 6563 7265 745f 6964 5f61 6e64 5f6c  _secret_id_and_l
-0001c510: 6162 656c 2873 656c 6629 3a0a 2020 2020  abel(self):.    
-0001c520: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001c530: 7365 6c66 2c20 2773 6563 7265 742d 6765  self, 'secret-ge
-0001c540: 7427 2c20 2222 2265 6368 6f20 277b 2266  t', """echo '{"f
-0001c550: 6f6f 223a 2022 6822 7d27 2222 2229 0a0a  oo": "h"}'""")..
-0001c560: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001c570: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-0001c580: 7365 6372 6574 2869 643d 2731 3233 272c  secret(id='123',
-0001c590: 206c 6162 656c 3d27 6c27 290a 2020 2020   label='l').    
-0001c5a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001c5b0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
-0001c5c0: 2773 6563 7265 743a 3132 3327 290a 2020  'secret:123').  
-0001c5d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001c5e0: 7445 7175 616c 2873 6563 7265 742e 6c61  tEqual(secret.la
-0001c5f0: 6265 6c2c 2027 6c27 290a 2020 2020 2020  bel, 'l').      
-0001c600: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001c610: 616c 2873 6563 7265 742e 6765 745f 636f  al(secret.get_co
-0001c620: 6e74 656e 7428 292c 207b 2766 6f6f 273a  ntent(), {'foo':
-0001c630: 2027 6827 7d29 0a0a 2020 2020 2020 2020   'h'})..        
-0001c640: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001c650: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-0001c660: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-0001c670: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
-0001c680: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-0001c690: 5b27 7365 6372 6574 2d67 6574 272c 2027  ['secret-get', '
-0001c6a0: 7365 6372 6574 3a31 3233 272c 2027 2d2d  secret:123', '--
-0001c6b0: 6c61 6265 6c27 2c20 276c 272c 2027 2d2d  label', 'l', '--
-0001c6c0: 666f 726d 6174 3d6a 736f 6e27 5d5d 290a  format=json']]).
-0001c6d0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-0001c6e0: 745f 7365 6372 6574 5f6e 6f5f 6172 6773  t_secret_no_args
-0001c6f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001c700: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0001c710: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-0001c720: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-0001c730: 656c 662e 6d6f 6465 6c2e 6765 745f 7365  elf.model.get_se
-0001c740: 6372 6574 2829 0a0a 2020 2020 6465 6620  cret()..    def 
-0001c750: 7465 7374 5f67 6574 5f73 6563 7265 745f  test_get_secret_
-0001c760: 6e6f 745f 666f 756e 6428 7365 6c66 293a  not_found(self):
-0001c770: 0a20 2020 2020 2020 2073 6372 6970 7420  .        script 
-0001c780: 3d20 2222 2265 6368 6f20 2745 5252 4f52  = """echo 'ERROR
-0001c790: 2073 6563 7265 7420 2231 3233 2220 6e6f   secret "123" no
-0001c7a0: 7420 666f 756e 6427 203e 2632 3b20 6578  t found' >&2; ex
-0001c7b0: 6974 2031 2222 220a 2020 2020 2020 2020  it 1""".        
-0001c7c0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001c7d0: 2c20 2773 6563 7265 742d 6765 7427 2c20  , 'secret-get', 
-0001c7e0: 7363 7269 7074 290a 2020 2020 2020 2020  script).        
-0001c7f0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001c800: 2c20 2773 6563 7265 742d 696e 666f 2d67  , 'secret-info-g
-0001c810: 6574 272c 2073 6372 6970 7429 0a0a 2020  et', script)..  
-0001c820: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0001c830: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-0001c840: 2e53 6563 7265 744e 6f74 466f 756e 6445  .SecretNotFoundE
-0001c850: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0001c860: 2020 2073 656c 662e 6d6f 6465 6c2e 6765     self.model.ge
-0001c870: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
-0001c880: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-0001c890: 5f67 6574 5f73 6563 7265 745f 6f74 6865  _get_secret_othe
-0001c8a0: 725f 6572 726f 7228 7365 6c66 293a 0a20  r_error(self):. 
-0001c8b0: 2020 2020 2020 2073 6372 6970 7420 3d20         script = 
-0001c8c0: 2222 2265 6368 6f20 2745 5252 4f52 206f  """echo 'ERROR o
-0001c8d0: 7468 6572 2065 7272 6f72 2720 3e26 323b  ther error' >&2;
-0001c8e0: 2065 7869 7420 3122 2222 0a20 2020 2020   exit 1""".     
-0001c8f0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c900: 656c 662c 2027 7365 6372 6574 2d67 6574  elf, 'secret-get
-0001c910: 272c 2073 6372 6970 7429 0a20 2020 2020  ', script).     
-0001c920: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c930: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
-0001c940: 6f2d 6765 7427 2c20 7363 7269 7074 290a  o-get', script).
-0001c950: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0001c960: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0001c970: 6f70 732e 4d6f 6465 6c45 7272 6f72 2920  ops.ModelError) 
-0001c980: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-0001c990: 2020 2073 656c 662e 6d6f 6465 6c2e 6765     self.model.ge
-0001c9a0: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
-0001c9b0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001c9c0: 6173 7365 7274 4e6f 7449 7349 6e73 7461  assertNotIsInsta
-0001c9d0: 6e63 6528 636d 2e65 7863 6570 7469 6f6e  nce(cm.exception
-0001c9e0: 2c20 6f70 732e 5365 6372 6574 4e6f 7446  , ops.SecretNotF
-0001c9f0: 6f75 6e64 4572 726f 7229 0a0a 0a63 6c61  oundError)...cla
-0001ca00: 7373 2054 6573 7453 6563 7265 7449 6e66  ss TestSecretInf
-0001ca10: 6f28 756e 6974 7465 7374 2e54 6573 7443  o(unittest.TestC
-0001ca20: 6173 6529 3a0a 2020 2020 6465 6620 7465  ase):.    def te
-0001ca30: 7374 5f69 6e69 7428 7365 6c66 293a 0a20  st_init(self):. 
-0001ca40: 2020 2020 2020 2069 6e66 6f20 3d20 6f70         info = op
-0001ca50: 732e 5365 6372 6574 496e 666f 280a 2020  s.SecretInfo(.  
-0001ca60: 2020 2020 2020 2020 2020 6964 3d27 3327            id='3'
-0001ca70: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-0001ca80: 6265 6c3d 276c 626c 272c 0a20 2020 2020  bel='lbl',.     
-0001ca90: 2020 2020 2020 2072 6576 6973 696f 6e3d         revision=
-0001caa0: 372c 0a20 2020 2020 2020 2020 2020 2065  7,.            e
-0001cab0: 7870 6972 6573 3d64 6174 6574 696d 652e  xpires=datetime.
-0001cac0: 6461 7465 7469 6d65 2832 3032 322c 2031  datetime(2022, 1
-0001cad0: 322c 2039 2c20 3134 2c20 3130 2c20 3029  2, 9, 14, 10, 0)
-0001cae0: 2c0a 2020 2020 2020 2020 2020 2020 726f  ,.            ro
-0001caf0: 7461 7469 6f6e 3d6f 7073 2e53 6563 7265  tation=ops.Secre
-0001cb00: 7452 6f74 6174 652e 4d4f 4e54 484c 592c  tRotate.MONTHLY,
-0001cb10: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
-0001cb20: 6174 6573 3d64 6174 6574 696d 652e 6461  ates=datetime.da
-0001cb30: 7465 7469 6d65 2832 3032 332c 2031 2c20  tetime(2023, 1, 
-0001cb40: 392c 2031 342c 2031 302c 2030 292c 0a20  9, 14, 10, 0),. 
-0001cb50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001cb60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001cb70: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
-0001cb80: 6574 3a33 2729 0a20 2020 2020 2020 2073  et:3').        s
-0001cb90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001cba0: 696e 666f 2e6c 6162 656c 2c20 276c 626c  info.label, 'lbl
-0001cbb0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001cbc0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001cbd0: 2e72 6576 6973 696f 6e2c 2037 290a 2020  .revision, 7).  
-0001cbe0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001cbf0: 7445 7175 616c 2869 6e66 6f2e 6578 7069  tEqual(info.expi
-0001cc00: 7265 732c 2064 6174 6574 696d 652e 6461  res, datetime.da
-0001cc10: 7465 7469 6d65 2832 3032 322c 2031 322c  tetime(2022, 12,
-0001cc20: 2039 2c20 3134 2c20 3130 2c20 3029 290a   9, 14, 10, 0)).
-0001cc30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001cc40: 6572 7445 7175 616c 2869 6e66 6f2e 726f  ertEqual(info.ro
-0001cc50: 7461 7469 6f6e 2c20 6f70 732e 5365 6372  tation, ops.Secr
-0001cc60: 6574 526f 7461 7465 2e4d 4f4e 5448 4c59  etRotate.MONTHLY
-0001cc70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cc80: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
-0001cc90: 726f 7461 7465 732c 2064 6174 6574 696d  rotates, datetim
-0001cca0: 652e 6461 7465 7469 6d65 2832 3032 332c  e.datetime(2023,
-0001ccb0: 2031 2c20 392c 2031 342c 2031 302c 2030   1, 9, 14, 10, 0
-0001ccc0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-0001ccd0: 2e61 7373 6572 7454 7275 6528 7265 7072  .assertTrue(repr
-0001cce0: 2869 6e66 6f29 2e73 7461 7274 7377 6974  (info).startswit
-0001ccf0: 6828 2753 6563 7265 7449 6e66 6f28 2729  h('SecretInfo(')
-0001cd00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cd10: 7373 6572 7454 7275 6528 7265 7072 2869  ssertTrue(repr(i
-0001cd20: 6e66 6f29 2e65 6e64 7377 6974 6828 2729  nfo).endswith(')
-0001cd30: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
-0001cd40: 745f 6672 6f6d 5f64 6963 7428 7365 6c66  t_from_dict(self
-0001cd50: 293a 0a20 2020 2020 2020 2075 7463 203d  ):.        utc =
-0001cd60: 2064 6174 6574 696d 652e 7469 6d65 7a6f   datetime.timezo
-0001cd70: 6e65 2e75 7463 0a20 2020 2020 2020 2069  ne.utc.        i
-0001cd80: 6e66 6f20 3d20 6f70 732e 5365 6372 6574  nfo = ops.Secret
-0001cd90: 496e 666f 2e66 726f 6d5f 6469 6374 2827  Info.from_dict('
-0001cda0: 7365 6372 6574 3a34 272c 207b 0a20 2020  secret:4', {.   
-0001cdb0: 2020 2020 2020 2020 2027 6c61 6265 6c27           'label'
-0001cdc0: 3a20 2766 726f 6d64 6963 7427 2c0a 2020  : 'fromdict',.  
-0001cdd0: 2020 2020 2020 2020 2020 2772 6576 6973            'revis
-0001cde0: 696f 6e27 3a20 382c 0a20 2020 2020 2020  ion': 8,.       
-0001cdf0: 2020 2020 2027 6578 7069 7265 7327 3a20       'expires': 
-0001ce00: 2732 3032 322d 3132 2d30 3954 3134 3a31  '2022-12-09T14:1
-0001ce10: 303a 3030 5a27 2c0a 2020 2020 2020 2020  0:00Z',.        
-0001ce20: 2020 2020 2772 6f74 6174 696f 6e27 3a20      'rotation': 
-0001ce30: 2779 6561 726c 7927 2c0a 2020 2020 2020  'yearly',.      
-0001ce40: 2020 2020 2020 2772 6f74 6174 6573 273a        'rotates':
-0001ce50: 2027 3230 3233 2d30 312d 3039 5431 343a   '2023-01-09T14:
-0001ce60: 3130 3a30 305a 272c 0a20 2020 2020 2020  10:00Z',.       
-0001ce70: 207d 290a 2020 2020 2020 2020 7365 6c66   }).        self
-0001ce80: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001ce90: 6f2e 6964 2c20 2773 6563 7265 743a 3427  o.id, 'secret:4'
-0001cea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001ceb0: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
-0001cec0: 6c61 6265 6c2c 2027 6672 6f6d 6469 6374  label, 'fromdict
-0001ced0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001cee0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001cef0: 2e72 6576 6973 696f 6e2c 2038 290a 2020  .revision, 8).  
-0001cf00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001cf10: 7445 7175 616c 2869 6e66 6f2e 6578 7069  tEqual(info.expi
-0001cf20: 7265 732c 2064 6174 6574 696d 652e 6461  res, datetime.da
-0001cf30: 7465 7469 6d65 2832 3032 322c 2031 322c  tetime(2022, 12,
-0001cf40: 2039 2c20 3134 2c20 3130 2c20 302c 2074   9, 14, 10, 0, t
-0001cf50: 7a69 6e66 6f3d 7574 6329 290a 2020 2020  zinfo=utc)).    
-0001cf60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001cf70: 7175 616c 2869 6e66 6f2e 726f 7461 7469  qual(info.rotati
-0001cf80: 6f6e 2c20 6f70 732e 5365 6372 6574 526f  on, ops.SecretRo
-0001cf90: 7461 7465 2e59 4541 524c 5929 0a20 2020  tate.YEARLY).   
-0001cfa0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001cfb0: 4571 7561 6c28 696e 666f 2e72 6f74 6174  Equal(info.rotat
-0001cfc0: 6573 2c20 6461 7465 7469 6d65 2e64 6174  es, datetime.dat
-0001cfd0: 6574 696d 6528 3230 3233 2c20 312c 2039  etime(2023, 1, 9
-0001cfe0: 2c20 3134 2c20 3130 2c20 302c 2074 7a69  , 14, 10, 0, tzi
-0001cff0: 6e66 6f3d 7574 6329 290a 0a20 2020 2020  nfo=utc))..     
-0001d000: 2020 2069 6e66 6f20 3d20 6f70 732e 5365     info = ops.Se
-0001d010: 6372 6574 496e 666f 2e66 726f 6d5f 6469  cretInfo.from_di
-0001d020: 6374 2827 7365 6372 6574 3a34 272c 207b  ct('secret:4', {
-0001d030: 0a20 2020 2020 2020 2020 2020 2027 6c61  .            'la
-0001d040: 6265 6c27 3a20 2766 726f 6d64 6963 7427  bel': 'fromdict'
-0001d050: 2c0a 2020 2020 2020 2020 2020 2020 2772  ,.            'r
-0001d060: 6576 6973 696f 6e27 3a20 382c 0a20 2020  evision': 8,.   
-0001d070: 2020 2020 2020 2020 2027 726f 7461 7469           'rotati
-0001d080: 6f6e 273a 2027 6261 6476 616c 7565 272c  on': 'badvalue',
-0001d090: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-0001d0a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001d0b0: 7175 616c 2869 6e66 6f2e 6964 2c20 2773  qual(info.id, 's
-0001d0c0: 6563 7265 743a 3427 290a 2020 2020 2020  ecret:4').      
-0001d0d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001d0e0: 616c 2869 6e66 6f2e 6c61 6265 6c2c 2027  al(info.label, '
-0001d0f0: 6672 6f6d 6469 6374 2729 0a20 2020 2020  fromdict').     
-0001d100: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001d110: 7561 6c28 696e 666f 2e72 6576 6973 696f  ual(info.revisio
-0001d120: 6e2c 2038 290a 2020 2020 2020 2020 7365  n, 8).        se
-0001d130: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0001d140: 696e 666f 2e65 7870 6972 6573 290a 2020  info.expires).  
-0001d150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d160: 7449 734e 6f6e 6528 696e 666f 2e72 6f74  tIsNone(info.rot
-0001d170: 6174 696f 6e29 0a20 2020 2020 2020 2073  ation).        s
-0001d180: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
-0001d190: 2869 6e66 6f2e 726f 7461 7465 7329 0a0a  (info.rotates)..
-0001d1a0: 2020 2020 2020 2020 696e 666f 203d 206f          info = o
-0001d1b0: 7073 2e53 6563 7265 7449 6e66 6f2e 6672  ps.SecretInfo.fr
-0001d1c0: 6f6d 5f64 6963 7428 2735 272c 207b 2772  om_dict('5', {'r
-0001d1d0: 6576 6973 696f 6e27 3a20 397d 290a 2020  evision': 9}).  
-0001d1e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d1f0: 7445 7175 616c 2869 6e66 6f2e 6964 2c20  tEqual(info.id, 
-0001d200: 2773 6563 7265 743a 3527 290a 2020 2020  'secret:5').    
-0001d210: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001d220: 7175 616c 2869 6e66 6f2e 7265 7669 7369  qual(info.revisi
-0001d230: 6f6e 2c20 3929 0a0a 0a63 6c61 7373 2054  on, 9)...class T
-0001d240: 6573 7453 6563 7265 7443 6c61 7373 2875  estSecretClass(u
-0001d250: 6e69 7474 6573 742e 5465 7374 4361 7365  nittest.TestCase
-0001d260: 293a 0a20 2020 206d 6178 4469 6666 203d  ):.    maxDiff =
-0001d270: 2036 3420 2a20 3130 3234 0a0a 2020 2020   64 * 1024..    
-0001d280: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
-0001d290: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
-0001d2a0: 6465 6c20 3d20 6f70 732e 4d6f 6465 6c28  del = ops.Model(
-0001d2b0: 6f70 732e 4368 6172 6d4d 6574 6128 292c  ops.CharmMeta(),
-0001d2c0: 205f 4d6f 6465 6c42 6163 6b65 6e64 2827   _ModelBackend('
-0001d2d0: 6d79 6170 702f 3027 2929 0a0a 2020 2020  myapp/0'))..    
-0001d2e0: 6465 6620 6d61 6b65 5f73 6563 7265 7428  def make_secret(
-0001d2f0: 7365 6c66 2c20 6964 3d4e 6f6e 652c 206c  self, id=None, l
-0001d300: 6162 656c 3d4e 6f6e 652c 2063 6f6e 7465  abel=None, conte
-0001d310: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
-0001d320: 2020 7265 7475 726e 206f 7073 2e53 6563    return ops.Sec
-0001d330: 7265 7428 7365 6c66 2e6d 6f64 656c 2e5f  ret(self.model._
-0001d340: 6261 636b 656e 642c 2069 643d 6964 2c20  backend, id=id, 
-0001d350: 6c61 6265 6c3d 6c61 6265 6c2c 2063 6f6e  label=label, con
-0001d360: 7465 6e74 3d63 6f6e 7465 6e74 290a 0a20  tent=content).. 
-0001d370: 2020 2064 6566 2074 6573 745f 6964 5f61     def test_id_a
-0001d380: 6e64 5f6c 6162 656c 2873 656c 6629 3a0a  nd_label(self):.
-0001d390: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001d3a0: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
-0001d3b0: 7428 6964 3d27 2061 6263 2027 2c20 6c61  t(id=' abc ', la
-0001d3c0: 6265 6c3d 276c 626c 2729 0a20 2020 2020  bel='lbl').     
-0001d3d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001d3e0: 7561 6c28 7365 6372 6574 2e69 642c 2027  ual(secret.id, '
-0001d3f0: 7365 6372 6574 3a61 6263 2729 0a20 2020  secret:abc').   
-0001d400: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d410: 4571 7561 6c28 7365 6372 6574 2e6c 6162  Equal(secret.lab
-0001d420: 656c 2c20 276c 626c 2729 0a0a 2020 2020  el, 'lbl')..    
-0001d430: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
-0001d440: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
-0001d450: 3d27 7827 290a 2020 2020 2020 2020 7365  ='x').        se
-0001d460: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0001d470: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
-0001d480: 743a 7827 290a 2020 2020 2020 2020 7365  t:x').        se
-0001d490: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0001d4a0: 7365 6372 6574 2e6c 6162 656c 290a 0a20  secret.label).. 
-0001d4b0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001d4c0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001d4d0: 286c 6162 656c 3d27 7927 290a 2020 2020  (label='y').    
-0001d4e0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001d4f0: 734e 6f6e 6528 7365 6372 6574 2e69 6429  sNone(secret.id)
-0001d500: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d510: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001d520: 2e6c 6162 656c 2c20 2779 2729 0a0a 2020  .label, 'y')..  
-0001d530: 2020 6465 6620 7465 7374 5f67 6574 5f63    def test_get_c
-0001d540: 6f6e 7465 6e74 5f63 6163 6865 6428 7365  ontent_cached(se
-0001d550: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
-0001d560: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-0001d570: 7365 6372 6574 2d67 6574 272c 2022 2222  secret-get', """
-0001d580: 6578 6974 2031 2222 2229 0a0a 2020 2020  exit 1""")..    
-0001d590: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
-0001d5a0: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
-0001d5b0: 3d27 7827 2c20 6c61 6265 6c3d 2779 272c  ='x', label='y',
-0001d5c0: 2063 6f6e 7465 6e74 3d7b 2766 6f6f 273a   content={'foo':
-0001d5d0: 2027 6261 7227 7d29 0a20 2020 2020 2020   'bar'}).       
-0001d5e0: 2063 6f6e 7465 6e74 203d 2073 6563 7265   content = secre
-0001d5f0: 742e 6765 745f 636f 6e74 656e 7428 2920  t.get_content() 
-0001d600: 2023 2077 696c 6c20 7573 6520 6361 6368   # will use cach
-0001d610: 6564 2063 6f6e 7465 6e74 2c20 6e6f 7420  ed content, not 
-0001d620: 7275 6e20 7365 6372 6574 2d67 6574 0a20  run secret-get. 
-0001d630: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001d640: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
-0001d650: 207b 2766 6f6f 273a 2027 6261 7227 7d29   {'foo': 'bar'})
-0001d660: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0001d670: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-0001d680: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-0001d690: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-0001d6a0: 5b5d 290a 0a20 2020 2064 6566 2074 6573  [])..    def tes
-0001d6b0: 745f 6765 745f 636f 6e74 656e 745f 7265  t_get_content_re
-0001d6c0: 6672 6573 6828 7365 6c66 293a 0a20 2020  fresh(self):.   
-0001d6d0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001d6e0: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
-0001d6f0: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
-0001d700: 666f 6f22 3a20 2272 6566 7265 7368 6564  foo": "refreshed
-0001d710: 227d 2722 2222 290a 0a20 2020 2020 2020  "}'""")..       
-0001d720: 2073 6563 7265 7420 3d20 7365 6c66 2e6d   secret = self.m
-0001d730: 616b 655f 7365 6372 6574 2869 643d 2779  ake_secret(id='y
-0001d740: 272c 2063 6f6e 7465 6e74 3d7b 2766 6f6f  ', content={'foo
-0001d750: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
-0001d760: 2020 2063 6f6e 7465 6e74 203d 2073 6563     content = sec
-0001d770: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
-0001d780: 7265 6672 6573 683d 5472 7565 290a 2020  refresh=True).  
-0001d790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d7a0: 7445 7175 616c 2863 6f6e 7465 6e74 2c20  tEqual(content, 
-0001d7b0: 7b27 666f 6f27 3a20 2772 6566 7265 7368  {'foo': 'refresh
-0001d7c0: 6564 277d 290a 0a20 2020 2020 2020 2073  ed'})..        s
-0001d7d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d7e0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001d7f0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001d800: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0001d810: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
-0001d820: 2773 6563 7265 742d 6765 7427 2c20 2773  'secret-get', 's
-0001d830: 6563 7265 743a 7927 2c20 272d 2d72 6566  ecret:y', '--ref
-0001d840: 7265 7368 272c 2027 2d2d 666f 726d 6174  resh', '--format
-0001d850: 3d6a 736f 6e27 5d5d 290a 0a20 2020 2064  =json']])..    d
-0001d860: 6566 2074 6573 745f 6765 745f 636f 6e74  ef test_get_cont
-0001d870: 656e 745f 756e 6361 6368 6564 2873 656c  ent_uncached(sel
-0001d880: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001d890: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001d8a0: 6563 7265 742d 6765 7427 2c20 2222 2265  ecret-get', """e
-0001d8b0: 6368 6f20 277b 2266 6f6f 223a 2022 6e6f  cho '{"foo": "no
-0001d8c0: 7463 6163 6865 6422 7d27 2222 2229 0a0a  tcached"}'""")..
-0001d8d0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001d8e0: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
-0001d8f0: 7428 6964 3d27 7a27 290a 2020 2020 2020  t(id='z').      
-0001d900: 2020 636f 6e74 656e 7420 3d20 7365 6372    content = secr
-0001d910: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
-0001d920: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d930: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
-0001d940: 742c 207b 2766 6f6f 273a 2027 6e6f 7463  t, {'foo': 'notc
-0001d950: 6163 6865 6427 7d29 0a0a 2020 2020 2020  ached'})..      
-0001d960: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001d970: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001d980: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001d990: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9b0: 205b 5b27 7365 6372 6574 2d67 6574 272c   [['secret-get',
-0001d9c0: 2027 7365 6372 6574 3a7a 272c 2027 2d2d   'secret:z', '--
-0001d9d0: 666f 726d 6174 3d6a 736f 6e27 5d5d 290a  format=json']]).
-0001d9e0: 0a20 2020 2064 6566 2074 6573 745f 7065  .    def test_pe
-0001d9f0: 656b 5f63 6f6e 7465 6e74 2873 656c 6629  ek_content(self)
-0001da00: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-0001da10: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
-0001da20: 7265 742d 6765 7427 2c20 2222 2265 6368  ret-get', """ech
-0001da30: 6f20 277b 2266 6f6f 223a 2022 7065 656b  o '{"foo": "peek
-0001da40: 6564 227d 2722 2222 290a 0a20 2020 2020  ed"}'""")..     
-0001da50: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001da60: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
-0001da70: 2761 272c 206c 6162 656c 3d27 6227 290a  'a', label='b').
-0001da80: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-0001da90: 3d20 7365 6372 6574 2e70 6565 6b5f 636f  = secret.peek_co
-0001daa0: 6e74 656e 7428 290a 2020 2020 2020 2020  ntent().        
-0001dab0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001dac0: 2863 6f6e 7465 6e74 2c20 7b27 666f 6f27  (content, {'foo'
-0001dad0: 3a20 2770 6565 6b65 6427 7d29 0a0a 2020  : 'peeked'})..  
-0001dae0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001daf0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-0001db00: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-0001db10: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
-0001db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db30: 2020 2020 205b 5b27 7365 6372 6574 2d67       [['secret-g
-0001db40: 6574 272c 2027 7365 6372 6574 3a61 272c  et', 'secret:a',
-0001db50: 2027 2d2d 6c61 6265 6c27 2c20 2762 272c   '--label', 'b',
-0001db60: 2027 2d2d 7065 656b 272c 2027 2d2d 666f   '--peek', '--fo
-0001db70: 726d 6174 3d6a 736f 6e27 5d5d 290a 0a20  rmat=json']]).. 
-0001db80: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-0001db90: 696e 666f 2873 656c 6629 3a0a 2020 2020  info(self):.    
-0001dba0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001dbb0: 7365 6c66 2c20 2773 6563 7265 742d 696e  self, 'secret-in
-0001dbc0: 666f 2d67 6574 272c 2022 2222 6563 686f  fo-get', """echo
-0001dbd0: 2027 7b22 7822 3a20 7b22 6c61 6265 6c22   '{"x": {"label"
-0001dbe0: 3a20 2279 222c 2022 7265 7669 7369 6f6e  : "y", "revision
-0001dbf0: 223a 2037 7d7d 2722 2222 290a 0a20 2020  ": 7}}'""")..   
-0001dc00: 2020 2020 2023 2053 6563 7265 7420 7769       # Secret wi
-0001dc10: 7468 2049 4420 6f6e 6c79 0a20 2020 2020  th ID only.     
-0001dc20: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001dc30: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
-0001dc40: 2778 2729 0a20 2020 2020 2020 2069 6e66  'x').        inf
-0001dc50: 6f20 3d20 7365 6372 6574 2e67 6574 5f69  o = secret.get_i
-0001dc60: 6e66 6f28 290a 2020 2020 2020 2020 7365  nfo().        se
-0001dc70: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001dc80: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
-0001dc90: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
-0001dca0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001dcb0: 6f2e 6c61 6265 6c2c 2027 7927 290a 2020  o.label, 'y').  
-0001dcc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001dcd0: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
-0001dce0: 7369 6f6e 2c20 3729 0a0a 2020 2020 2020  sion, 7)..      
-0001dcf0: 2020 2320 5365 6372 6574 2077 6974 6820    # Secret with 
-0001dd00: 6c61 6265 6c20 6f6e 6c79 0a20 2020 2020  label only.     
-0001dd10: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001dd20: 2e6d 616b 655f 7365 6372 6574 286c 6162  .make_secret(lab
-0001dd30: 656c 3d27 7927 290a 2020 2020 2020 2020  el='y').        
-0001dd40: 696e 666f 203d 2073 6563 7265 742e 6765  info = secret.ge
-0001dd50: 745f 696e 666f 2829 0a20 2020 2020 2020  t_info().       
-0001dd60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001dd70: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
-0001dd80: 6574 3a78 2729 0a20 2020 2020 2020 2073  et:x').        s
-0001dd90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001dda0: 696e 666f 2e6c 6162 656c 2c20 2779 2729  info.label, 'y')
-0001ddb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ddc0: 7365 7274 4571 7561 6c28 696e 666f 2e72  sertEqual(info.r
-0001ddd0: 6576 6973 696f 6e2c 2037 290a 0a20 2020  evision, 7)..   
-0001dde0: 2020 2020 2023 2053 6563 7265 7420 7769       # Secret wi
-0001ddf0: 7468 2049 4420 616e 6420 6c61 6265 6c0a  th ID and label.
-0001de00: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0001de10: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
-0001de20: 7428 6964 3d27 7827 2c20 6c61 6265 6c3d  t(id='x', label=
-0001de30: 2779 2729 0a20 2020 2020 2020 2069 6e66  'y').        inf
-0001de40: 6f20 3d20 7365 6372 6574 2e67 6574 5f69  o = secret.get_i
-0001de50: 6e66 6f28 290a 2020 2020 2020 2020 7365  nfo().        se
-0001de60: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001de70: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
-0001de80: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
-0001de90: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001dea0: 6f2e 6c61 6265 6c2c 2027 7927 290a 2020  o.label, 'y').  
-0001deb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001dec0: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
-0001ded0: 7369 6f6e 2c20 3729 0a0a 2020 2020 2020  sion, 7)..      
-0001dee0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001def0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-0001df00: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001df10: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001df20: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0001df30: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001df40: 2020 205b 2773 6563 7265 742d 696e 666f     ['secret-info
-0001df50: 2d67 6574 272c 2027 7365 6372 6574 3a78  -get', 'secret:x
-0001df60: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-0001df70: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
-0001df80: 2020 2020 205b 2773 6563 7265 742d 696e       ['secret-in
-0001df90: 666f 2d67 6574 272c 2027 2d2d 6c61 6265  fo-get', '--labe
-0001dfa0: 6c27 2c20 2779 272c 2027 2d2d 666f 726d  l', 'y', '--form
-0001dfb0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001dfc0: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
-0001dfd0: 7265 742d 696e 666f 2d67 6574 272c 2027  ret-info-get', '
-0001dfe0: 7365 6372 6574 3a78 272c 2027 2d2d 666f  secret:x', '--fo
-0001dff0: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
-0001e000: 2020 2020 2020 2020 205d 290a 0a20 2020           ])..   
-0001e010: 2064 6566 2074 6573 745f 7365 745f 636f   def test_set_co
-0001e020: 6e74 656e 7428 7365 6c66 293a 0a20 2020  ntent(self):.   
-0001e030: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001e040: 2873 656c 662c 2027 7365 6372 6574 2d73  (self, 'secret-s
-0001e050: 6574 272c 2022 2222 6578 6974 2030 2222  et', """exit 0""
-0001e060: 2229 0a20 2020 2020 2020 2066 616b 655f  ").        fake_
-0001e070: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001e080: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
-0001e090: 2222 2265 6368 6f20 277b 227a 223a 207b  """echo '{"z": {
-0001e0a0: 226c 6162 656c 223a 2022 7922 2c20 2272  "label": "y", "r
-0001e0b0: 6576 6973 696f 6e22 3a20 377d 7d27 2222  evision": 7}}'""
-0001e0c0: 2229 0a0a 2020 2020 2020 2020 7365 6372  ")..        secr
-0001e0d0: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
-0001e0e0: 6563 7265 7428 6964 3d27 7827 290a 2020  ecret(id='x').  
-0001e0f0: 2020 2020 2020 7365 6372 6574 2e73 6574        secret.set
-0001e100: 5f63 6f6e 7465 6e74 287b 2766 6f6f 273a  _content({'foo':
-0001e110: 2027 6261 7227 7d29 0a0a 2020 2020 2020   'bar'})..      
-0001e120: 2020 2320 4966 2073 6563 7265 7420 646f    # If secret do
-0001e130: 6573 6e27 7420 6861 7665 2061 6e20 4944  esn't have an ID
-0001e140: 2c20 7765 276c 6c20 7275 6e20 7365 6372  , we'll run secr
-0001e150: 6574 2d69 6e66 6f2d 6765 7420 746f 2066  et-info-get to f
-0001e160: 6574 6368 2069 740a 2020 2020 2020 2020  etch it.        
-0001e170: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
-0001e180: 6b65 5f73 6563 7265 7428 6c61 6265 6c3d  ke_secret(label=
-0001e190: 2779 2729 0a20 2020 2020 2020 2073 656c  'y').        sel
-0001e1a0: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
-0001e1b0: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
-0001e1c0: 2020 7365 6372 6574 2e73 6574 5f63 6f6e    secret.set_con
-0001e1d0: 7465 6e74 287b 2762 6172 273a 2027 666f  tent({'bar': 'fo
-0001e1e0: 6f27 7d29 0a20 2020 2020 2020 2073 656c  o'}).        sel
-0001e1f0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001e200: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
-0001e210: 3a7a 2729 0a0a 2020 2020 2020 2020 7769  :z')..        wi
-0001e220: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001e230: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
-0001e240: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001e250: 6372 6574 2e73 6574 5f63 6f6e 7465 6e74  cret.set_content
-0001e260: 287b 2773 273a 2027 7427 7d29 2020 2320  ({'s': 't'})  # 
-0001e270: 656e 7375 7265 2069 7420 7661 6c69 6461  ensure it valida
-0001e280: 7465 7320 636f 6e74 656e 7420 286b 6579  tes content (key
-0001e290: 2074 6f6f 2073 686f 7274 290a 0a20 2020   too short)..   
-0001e2a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001e2b0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-0001e2c0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-0001e2d0: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
-0001e2e0: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
-0001e2f0: 742d 7365 7427 2c20 2773 6563 7265 743a  t-set', 'secret:
-0001e300: 7827 2c20 2766 6f6f 3d62 6172 275d 2c0a  x', 'foo=bar'],.
-0001e310: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
-0001e320: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
-0001e330: 272d 2d6c 6162 656c 272c 2027 7927 2c20  '--label', 'y', 
-0001e340: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-0001e350: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-0001e360: 7365 6372 6574 2d73 6574 272c 2027 7365  secret-set', 'se
-0001e370: 6372 6574 3a7a 272c 2027 6261 723d 666f  cret:z', 'bar=fo
-0001e380: 6f27 5d2c 0a20 2020 2020 2020 205d 290a  o'],.        ]).
-0001e390: 0a20 2020 2064 6566 2074 6573 745f 7365  .    def test_se
-0001e3a0: 745f 696e 666f 2873 656c 6629 3a0a 2020  t_info(self):.  
-0001e3b0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-0001e3c0: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
-0001e3d0: 7365 7427 2c20 2222 2265 7869 7420 3022  set', """exit 0"
-0001e3e0: 2222 290a 2020 2020 2020 2020 6661 6b65  "").        fake
-0001e3f0: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001e400: 6563 7265 742d 696e 666f 2d67 6574 272c  ecret-info-get',
-0001e410: 2022 2222 6563 686f 2027 7b22 7a22 3a20   """echo '{"z": 
-0001e420: 7b22 6c61 6265 6c22 3a20 2279 222c 2022  {"label": "y", "
-0001e430: 7265 7669 7369 6f6e 223a 2037 7d7d 2722  revision": 7}}'"
-0001e440: 2222 290a 0a20 2020 2020 2020 2073 6563  "")..        sec
-0001e450: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
-0001e460: 7365 6372 6574 2869 643d 2778 2729 0a20  secret(id='x'). 
-0001e470: 2020 2020 2020 2065 7870 6972 6520 3d20         expire = 
-0001e480: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-0001e490: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
-0001e4a0: 362c 2035 392c 2030 290a 2020 2020 2020  6, 59, 0).      
-0001e4b0: 2020 7365 6372 6574 2e73 6574 5f69 6e66    secret.set_inf
-0001e4c0: 6f28 0a20 2020 2020 2020 2020 2020 206c  o(.            l
-0001e4d0: 6162 656c 3d27 6c61 6227 2c0a 2020 2020  abel='lab',.    
-0001e4e0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-0001e4f0: 696f 6e3d 2764 6573 6327 2c0a 2020 2020  ion='desc',.    
-0001e500: 2020 2020 2020 2020 6578 7069 7265 3d65          expire=e
-0001e510: 7870 6972 652c 0a20 2020 2020 2020 2020  xpire,.         
-0001e520: 2020 2072 6f74 6174 653d 6f70 732e 5365     rotate=ops.Se
-0001e530: 6372 6574 526f 7461 7465 2e4d 4f4e 5448  cretRotate.MONTH
-0001e540: 4c59 2c0a 2020 2020 2020 2020 290a 0a20  LY,.        ).. 
-0001e550: 2020 2020 2020 2023 2049 6620 7365 6372         # If secr
-0001e560: 6574 2064 6f65 736e 2774 2068 6176 6520  et doesn't have 
-0001e570: 616e 2049 442c 2077 6527 6c6c 2072 756e  an ID, we'll run
-0001e580: 2073 6563 7265 742d 696e 666f 2d67 6574   secret-info-get
-0001e590: 2074 6f20 6665 7463 6820 6974 0a20 2020   to fetch it.   
-0001e5a0: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
-0001e5b0: 6c66 2e6d 616b 655f 7365 6372 6574 286c  lf.make_secret(l
-0001e5c0: 6162 656c 3d27 7927 290a 2020 2020 2020  abel='y').      
-0001e5d0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-0001e5e0: 6f6e 6528 7365 6372 6574 2e69 6429 0a20  one(secret.id). 
-0001e5f0: 2020 2020 2020 2073 6563 7265 742e 7365         secret.se
-0001e600: 745f 696e 666f 286c 6162 656c 3d27 6c62  t_info(label='lb
-0001e610: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-0001e620: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001e630: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001e640: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
-0001e650: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001e660: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001e670: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001e680: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-0001e690: 205b 2773 6563 7265 742d 7365 7427 2c20   ['secret-set', 
-0001e6a0: 2773 6563 7265 743a 7827 2c20 272d 2d6c  'secret:x', '--l
-0001e6b0: 6162 656c 272c 2027 6c61 6227 2c20 272d  abel', 'lab', '-
-0001e6c0: 2d64 6573 6372 6970 7469 6f6e 272c 2027  -description', '
-0001e6d0: 6465 7363 272c 0a20 2020 2020 2020 2020  desc',.         
-0001e6e0: 2020 2020 272d 2d65 7870 6972 6527 2c20      '--expire', 
-0001e6f0: 2732 3032 322d 3132 2d30 3954 3136 3a35  '2022-12-09T16:5
-0001e700: 393a 3030 272c 2027 2d2d 726f 7461 7465  9:00', '--rotate
-0001e710: 272c 2027 6d6f 6e74 686c 7927 5d2c 0a20  ', 'monthly'],. 
-0001e720: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
-0001e730: 7265 742d 696e 666f 2d67 6574 272c 2027  ret-info-get', '
-0001e740: 2d2d 6c61 6265 6c27 2c20 2779 272c 2027  --label', 'y', '
-0001e750: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
-0001e760: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
-0001e770: 6563 7265 742d 7365 7427 2c20 2773 6563  ecret-set', 'sec
-0001e780: 7265 743a 7a27 2c20 272d 2d6c 6162 656c  ret:z', '--label
-0001e790: 272c 2027 6c62 6c27 5d2c 0a20 2020 2020  ', 'lbl'],.     
-0001e7a0: 2020 205d 290a 0a20 2020 2020 2020 2077     ])..        w
-0001e7b0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0001e7c0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-0001e7d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001e7e0: 6372 6574 2e73 6574 5f69 6e66 6f28 2920  cret.set_info() 
-0001e7f0: 2023 206e 6f20 6172 6773 2070 726f 7669   # no args provi
-0001e800: 6465 640a 0a20 2020 2064 6566 2074 6573  ded..    def tes
-0001e810: 745f 6772 616e 7428 7365 6c66 293a 0a20  t_grant(self):. 
-0001e820: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001e830: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001e840: 2d67 7261 6e74 272c 2022 2222 6578 6974  -grant', """exit
-0001e850: 2030 2222 2229 0a20 2020 2020 2020 2066   0""").        f
-0001e860: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001e870: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
-0001e880: 7427 2c20 2222 2265 6368 6f20 277b 227a  t', """echo '{"z
-0001e890: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
-0001e8a0: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
-0001e8b0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
-0001e8c0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
-0001e8d0: 6b65 5f73 6563 7265 7428 6964 3d27 7827  ke_secret(id='x'
-0001e8e0: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
-0001e8f0: 2e67 7261 6e74 2874 7970 6573 2e53 696d  .grant(types.Sim
-0001e900: 706c 654e 616d 6573 7061 6365 2869 643d  pleNamespace(id=
-0001e910: 3132 3329 290a 2020 2020 2020 2020 7365  123)).        se
-0001e920: 6372 6574 2e67 7261 6e74 2874 7970 6573  cret.grant(types
-0001e930: 2e53 696d 706c 654e 616d 6573 7061 6365  .SimpleNamespace
-0001e940: 2869 643d 3233 3429 2c20 756e 6974 3d74  (id=234), unit=t
-0001e950: 7970 6573 2e53 696d 706c 654e 616d 6573  ypes.SimpleNames
-0001e960: 7061 6365 286e 616d 653d 2761 7070 2f30  pace(name='app/0
-0001e970: 2729 290a 0a20 2020 2020 2020 2023 2049  '))..        # I
-0001e980: 6620 7365 6372 6574 2064 6f65 736e 2774  f secret doesn't
-0001e990: 2068 6176 6520 616e 2049 442c 2077 6527   have an ID, we'
-0001e9a0: 6c6c 2072 756e 2073 6563 7265 742d 696e  ll run secret-in
-0001e9b0: 666f 2d67 6574 2074 6f20 6665 7463 6820  fo-get to fetch 
-0001e9c0: 6974 0a20 2020 2020 2020 2073 6563 7265  it.        secre
-0001e9d0: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
-0001e9e0: 6372 6574 286c 6162 656c 3d27 7927 290a  cret(label='y').
-0001e9f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ea00: 6572 7449 734e 6f6e 6528 7365 6372 6574  ertIsNone(secret
-0001ea10: 2e69 6429 0a20 2020 2020 2020 2073 6563  .id).        sec
-0001ea20: 7265 742e 6772 616e 7428 7479 7065 732e  ret.grant(types.
-0001ea30: 5369 6d70 6c65 4e61 6d65 7370 6163 6528  SimpleNamespace(
-0001ea40: 6964 3d33 3435 2929 0a20 2020 2020 2020  id=345)).       
-0001ea50: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001ea60: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
-0001ea70: 6372 6574 3a7a 2729 0a0a 2020 2020 2020  cret:z')..      
-0001ea80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001ea90: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001eaa0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001eab0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
-0001eac0: 2020 2020 2020 5b27 7365 6372 6574 2d67        ['secret-g
-0001ead0: 7261 6e74 272c 2027 7365 6372 6574 3a78  rant', 'secret:x
-0001eae0: 272c 2027 2d2d 7265 6c61 7469 6f6e 272c  ', '--relation',
-0001eaf0: 2027 3132 3327 5d2c 0a20 2020 2020 2020   '123'],.       
-0001eb00: 2020 2020 205b 2773 6563 7265 742d 6772       ['secret-gr
-0001eb10: 616e 7427 2c20 2773 6563 7265 743a 7827  ant', 'secret:x'
-0001eb20: 2c20 272d 2d72 656c 6174 696f 6e27 2c20  , '--relation', 
-0001eb30: 2732 3334 272c 2027 2d2d 756e 6974 272c  '234', '--unit',
-0001eb40: 2027 6170 702f 3027 5d2c 0a20 2020 2020   'app/0'],.     
-0001eb50: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
-0001eb60: 696e 666f 2d67 6574 272c 2027 2d2d 6c61  info-get', '--la
-0001eb70: 6265 6c27 2c20 2779 272c 2027 2d2d 666f  bel', 'y', '--fo
-0001eb80: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
-0001eb90: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
-0001eba0: 742d 6772 616e 7427 2c20 2773 6563 7265  t-grant', 'secre
-0001ebb0: 743a 7a27 2c20 272d 2d72 656c 6174 696f  t:z', '--relatio
-0001ebc0: 6e27 2c20 2733 3435 275d 2c0a 2020 2020  n', '345'],.    
-0001ebd0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0001ebe0: 7465 7374 5f72 6576 6f6b 6528 7365 6c66  test_revoke(self
-0001ebf0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-0001ec00: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001ec10: 6372 6574 2d72 6576 6f6b 6527 2c20 2222  cret-revoke', ""
-0001ec20: 2265 7869 7420 3022 2222 290a 2020 2020  "exit 0""").    
-0001ec30: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001ec40: 7365 6c66 2c20 2773 6563 7265 742d 696e  self, 'secret-in
-0001ec50: 666f 2d67 6574 272c 2022 2222 6563 686f  fo-get', """echo
-0001ec60: 2027 7b22 7a22 3a20 7b22 6c61 6265 6c22   '{"z": {"label"
-0001ec70: 3a20 2279 222c 2022 7265 7669 7369 6f6e  : "y", "revision
-0001ec80: 223a 2037 7d7d 2722 2222 290a 0a20 2020  ": 7}}'""")..   
-0001ec90: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
-0001eca0: 6c66 2e6d 616b 655f 7365 6372 6574 2869  lf.make_secret(i
-0001ecb0: 643d 2778 2729 0a20 2020 2020 2020 2073  d='x').        s
-0001ecc0: 6563 7265 742e 7265 766f 6b65 2874 7970  ecret.revoke(typ
-0001ecd0: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
-0001ece0: 6365 2869 643d 3132 3329 290a 2020 2020  ce(id=123)).    
-0001ecf0: 2020 2020 7365 6372 6574 2e72 6576 6f6b      secret.revok
-0001ed00: 6528 7479 7065 732e 5369 6d70 6c65 4e61  e(types.SimpleNa
-0001ed10: 6d65 7370 6163 6528 6964 3d32 3334 292c  mespace(id=234),
-0001ed20: 2075 6e69 743d 7479 7065 732e 5369 6d70   unit=types.Simp
-0001ed30: 6c65 4e61 6d65 7370 6163 6528 6e61 6d65  leNamespace(name
-0001ed40: 3d27 6170 702f 3027 2929 0a0a 2020 2020  ='app/0'))..    
-0001ed50: 2020 2020 2320 4966 2073 6563 7265 7420      # If secret 
-0001ed60: 646f 6573 6e27 7420 6861 7665 2061 6e20  doesn't have an 
-0001ed70: 4944 2c20 7765 276c 6c20 7275 6e20 7365  ID, we'll run se
-0001ed80: 6372 6574 2d69 6e66 6f2d 6765 7420 746f  cret-info-get to
-0001ed90: 2066 6574 6368 2069 740a 2020 2020 2020   fetch it.      
-0001eda0: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
-0001edb0: 6d61 6b65 5f73 6563 7265 7428 6c61 6265  make_secret(labe
-0001edc0: 6c3d 2779 2729 0a20 2020 2020 2020 2073  l='y').        s
-0001edd0: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
-0001ede0: 2873 6563 7265 742e 6964 290a 2020 2020  (secret.id).    
-0001edf0: 2020 2020 7365 6372 6574 2e72 6576 6f6b      secret.revok
-0001ee00: 6528 7479 7065 732e 5369 6d70 6c65 4e61  e(types.SimpleNa
-0001ee10: 6d65 7370 6163 6528 6964 3d33 3435 2929  mespace(id=345))
-0001ee20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ee30: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001ee40: 2e69 642c 2027 7365 6372 6574 3a7a 2729  .id, 'secret:z')
-0001ee50: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0001ee60: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-0001ee70: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-0001ee80: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-0001ee90: 5b0a 2020 2020 2020 2020 2020 2020 5b27  [.            ['
-0001eea0: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
-0001eeb0: 2773 6563 7265 743a 7827 2c20 272d 2d72  'secret:x', '--r
-0001eec0: 656c 6174 696f 6e27 2c20 2731 3233 275d  elation', '123']
-0001eed0: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-0001eee0: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
-0001eef0: 2773 6563 7265 743a 7827 2c20 272d 2d72  'secret:x', '--r
-0001ef00: 656c 6174 696f 6e27 2c20 2732 3334 272c  elation', '234',
-0001ef10: 2027 2d2d 756e 6974 272c 2027 6170 702f   '--unit', 'app/
-0001ef20: 3027 5d2c 0a20 2020 2020 2020 2020 2020  0'],.           
-0001ef30: 205b 2773 6563 7265 742d 696e 666f 2d67   ['secret-info-g
-0001ef40: 6574 272c 2027 2d2d 6c61 6265 6c27 2c20  et', '--label', 
-0001ef50: 2779 272c 2027 2d2d 666f 726d 6174 3d6a  'y', '--format=j
-0001ef60: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
-0001ef70: 2020 205b 2773 6563 7265 742d 7265 766f     ['secret-revo
-0001ef80: 6b65 272c 2027 7365 6372 6574 3a7a 272c  ke', 'secret:z',
-0001ef90: 2027 2d2d 7265 6c61 7469 6f6e 272c 2027   '--relation', '
-0001efa0: 3334 3527 5d2c 0a20 2020 2020 2020 205d  345'],.        ]
-0001efb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001efc0: 7265 6d6f 7665 5f72 6576 6973 696f 6e28  remove_revision(
-0001efd0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001efe0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001eff0: 2027 7365 6372 6574 2d72 656d 6f76 6527   'secret-remove'
-0001f000: 2c20 2222 2265 7869 7420 3022 2222 290a  , """exit 0""").
-0001f010: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001f020: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001f030: 742d 696e 666f 2d67 6574 272c 2022 2222  t-info-get', """
-0001f040: 6563 686f 2027 7b22 7a22 3a20 7b22 6c61  echo '{"z": {"la
-0001f050: 6265 6c22 3a20 2279 222c 2022 7265 7669  bel": "y", "revi
-0001f060: 7369 6f6e 223a 2037 7d7d 2722 2222 290a  sion": 7}}'""").
-0001f070: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
-0001f080: 3d20 7365 6c66 2e6d 616b 655f 7365 6372  = self.make_secr
-0001f090: 6574 2869 643d 2778 2729 0a20 2020 2020  et(id='x').     
-0001f0a0: 2020 2073 6563 7265 742e 7265 6d6f 7665     secret.remove
-0001f0b0: 5f72 6576 6973 696f 6e28 3132 3329 0a0a  _revision(123)..
-0001f0c0: 2020 2020 2020 2020 2320 4966 2073 6563          # If sec
-0001f0d0: 7265 7420 646f 6573 6e27 7420 6861 7665  ret doesn't have
-0001f0e0: 2061 6e20 4944 2c20 7765 276c 6c20 7275   an ID, we'll ru
-0001f0f0: 6e20 7365 6372 6574 2d69 6e66 6f2d 6765  n secret-info-ge
-0001f100: 7420 746f 2066 6574 6368 2069 740a 2020  t to fetch it.  
-0001f110: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001f120: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001f130: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
-0001f140: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001f150: 4e6f 6e65 2873 6563 7265 742e 6964 290a  None(secret.id).
-0001f160: 2020 2020 2020 2020 7365 6372 6574 2e72          secret.r
-0001f170: 656d 6f76 655f 7265 7669 7369 6f6e 2832  emove_revision(2
-0001f180: 3334 290a 2020 2020 2020 2020 7365 6c66  34).        self
-0001f190: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001f1a0: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001f1b0: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
-0001f1c0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001f1d0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001f1e0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001f1f0: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-0001f200: 205b 2773 6563 7265 742d 7265 6d6f 7665   ['secret-remove
-0001f210: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
-0001f220: 2d2d 7265 7669 7369 6f6e 272c 2027 3132  --revision', '12
-0001f230: 3327 5d2c 0a20 2020 2020 2020 2020 2020  3'],.           
-0001f240: 205b 2773 6563 7265 742d 696e 666f 2d67   ['secret-info-g
-0001f250: 6574 272c 2027 2d2d 6c61 6265 6c27 2c20  et', '--label', 
-0001f260: 2779 272c 2027 2d2d 666f 726d 6174 3d6a  'y', '--format=j
-0001f270: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
-0001f280: 2020 205b 2773 6563 7265 742d 7265 6d6f     ['secret-remo
-0001f290: 7665 272c 2027 7365 6372 6574 3a7a 272c  ve', 'secret:z',
-0001f2a0: 2027 2d2d 7265 7669 7369 6f6e 272c 2027   '--revision', '
-0001f2b0: 3233 3427 5d2c 0a20 2020 2020 2020 205d  234'],.        ]
-0001f2c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001f2d0: 7265 6d6f 7665 5f61 6c6c 5f72 6576 6973  remove_all_revis
-0001f2e0: 696f 6e73 2873 656c 6629 3a0a 2020 2020  ions(self):.    
-0001f2f0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001f300: 7365 6c66 2c20 2773 6563 7265 742d 7265  self, 'secret-re
-0001f310: 6d6f 7665 272c 2022 2222 6578 6974 2030  move', """exit 0
-0001f320: 2222 2229 0a20 2020 2020 2020 2066 616b  """).        fak
-0001f330: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-0001f340: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
-0001f350: 2c20 2222 2265 6368 6f20 277b 227a 223a  , """echo '{"z":
-0001f360: 207b 226c 6162 656c 223a 2022 7922 2c20   {"label": "y", 
-0001f370: 2272 6576 6973 696f 6e22 3a20 377d 7d27  "revision": 7}}'
-0001f380: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
-0001f390: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
-0001f3a0: 5f73 6563 7265 7428 6964 3d27 7827 290a  _secret(id='x').
-0001f3b0: 2020 2020 2020 2020 7365 6372 6574 2e72          secret.r
-0001f3c0: 656d 6f76 655f 616c 6c5f 7265 7669 7369  emove_all_revisi
-0001f3d0: 6f6e 7328 290a 0a20 2020 2020 2020 2023  ons()..        #
-0001f3e0: 2049 6620 7365 6372 6574 2064 6f65 736e   If secret doesn
-0001f3f0: 2774 2068 6176 6520 616e 2049 442c 2077  't have an ID, w
-0001f400: 6527 6c6c 2072 756e 2073 6563 7265 742d  e'll run secret-
-0001f410: 696e 666f 2d67 6574 2074 6f20 6665 7463  info-get to fetc
-0001f420: 6820 6974 0a20 2020 2020 2020 2073 6563  h it.        sec
-0001f430: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
-0001f440: 7365 6372 6574 286c 6162 656c 3d27 7927  secret(label='y'
-0001f450: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001f460: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
-0001f470: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
-0001f480: 6563 7265 742e 7265 6d6f 7665 5f61 6c6c  ecret.remove_all
-0001f490: 5f72 6576 6973 696f 6e73 2829 0a20 2020  _revisions().   
-0001f4a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f4b0: 4571 7561 6c28 7365 6372 6574 2e69 642c  Equal(secret.id,
-0001f4c0: 2027 7365 6372 6574 3a7a 2729 0a0a 2020   'secret:z')..  
-0001f4d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001f4e0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-0001f4f0: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-0001f500: 6c65 6172 3d54 7275 6529 2c20 5b0a 2020  lear=True), [.  
-0001f510: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
-0001f520: 6574 2d72 656d 6f76 6527 2c20 2773 6563  et-remove', 'sec
-0001f530: 7265 743a 7827 5d2c 0a20 2020 2020 2020  ret:x'],.       
-0001f540: 2020 2020 205b 2773 6563 7265 742d 696e       ['secret-in
-0001f550: 666f 2d67 6574 272c 2027 2d2d 6c61 6265  fo-get', '--labe
-0001f560: 6c27 2c20 2779 272c 2027 2d2d 666f 726d  l', 'y', '--form
-0001f570: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001f580: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
-0001f590: 7265 6d6f 7665 272c 2027 7365 6372 6574  remove', 'secret
-0001f5a0: 3a7a 275d 2c0a 2020 2020 2020 2020 5d29  :z'],.        ])
-0001f5b0: 0a0a 0a63 6c61 7373 2054 6573 7450 6f72  ...class TestPor
-0001f5c0: 7473 2875 6e69 7474 6573 742e 5465 7374  ts(unittest.Test
-0001f5d0: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
-0001f5e0: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
-0001f5f0: 2020 2020 7365 6c66 2e6d 6f64 656c 203d      self.model =
-0001f600: 206f 7073 2e6d 6f64 656c 2e4d 6f64 656c   ops.model.Model
-0001f610: 286f 7073 2e63 6861 726d 2e43 6861 726d  (ops.charm.Charm
-0001f620: 4d65 7461 2829 2c20 6f70 732e 6d6f 6465  Meta(), ops.mode
-0001f630: 6c2e 5f4d 6f64 656c 4261 636b 656e 6428  l._ModelBackend(
-0001f640: 276d 7961 7070 2f30 2729 290a 2020 2020  'myapp/0')).    
-0001f650: 2020 2020 7365 6c66 2e75 6e69 7420 3d20      self.unit = 
-0001f660: 7365 6c66 2e6d 6f64 656c 2e75 6e69 740a  self.model.unit.
-0001f670: 0a20 2020 2064 6566 2074 6573 745f 6f70  .    def test_op
-0001f680: 656e 5f70 6f72 7428 7365 6c66 293a 0a20  en_port(self):. 
-0001f690: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001f6a0: 7074 2873 656c 662c 2027 6f70 656e 2d70  pt(self, 'open-p
-0001f6b0: 6f72 7427 2c20 2765 7869 7420 3027 290a  ort', 'exit 0').
-0001f6c0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-0001f6d0: 6974 2e6f 7065 6e5f 706f 7274 2827 7463  it.open_port('tc
-0001f6e0: 7027 2c20 3830 3830 290a 2020 2020 2020  p', 8080).      
-0001f6f0: 2020 7365 6c66 2e75 6e69 742e 6f70 656e    self.unit.open
-0001f700: 5f70 6f72 7428 2755 4450 272c 2034 3030  _port('UDP', 400
-0001f710: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-0001f720: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
-0001f730: 6963 6d70 2729 0a0a 2020 2020 2020 2020  icmp')..        
-0001f740: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001f750: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-0001f760: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-0001f770: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
-0001f780: 2020 2020 5b27 6f70 656e 2d70 6f72 7427      ['open-port'
-0001f790: 2c20 2738 3038 302f 7463 7027 5d2c 0a20  , '8080/tcp'],. 
-0001f7a0: 2020 2020 2020 2020 2020 205b 276f 7065             ['ope
-0001f7b0: 6e2d 706f 7274 272c 2027 3430 3030 2f75  n-port', '4000/u
-0001f7c0: 6470 275d 2c0a 2020 2020 2020 2020 2020  dp'],.          
-0001f7d0: 2020 5b27 6f70 656e 2d70 6f72 7427 2c20    ['open-port', 
-0001f7e0: 2769 636d 7027 5d2c 0a20 2020 2020 2020  'icmp'],.       
-0001f7f0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-0001f800: 745f 6f70 656e 5f70 6f72 745f 6572 726f  t_open_port_erro
-0001f810: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-0001f820: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001f830: 662c 2027 6f70 656e 2d70 6f72 7427 2c20  f, 'open-port', 
-0001f840: 2265 6368 6f20 2745 5252 4f52 2062 6164  "echo 'ERROR bad
-0001f850: 2070 726f 746f 636f 6c27 203e 2632 3b20   protocol' >&2; 
-0001f860: 6578 6974 2031 2229 0a0a 2020 2020 2020  exit 1")..      
-0001f870: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001f880: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
-0001f890: 656c 4572 726f 7229 2061 7320 636d 3a0a  elError) as cm:.
-0001f8a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001f8b0: 2e75 6e69 742e 6f70 656e 5f70 6f72 7428  .unit.open_port(
-0001f8c0: 2766 7470 272c 2038 3038 3029 0a20 2020  'ftp', 8080).   
-0001f8d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f8e0: 4571 7561 6c28 7374 7228 636d 2e65 7863  Equal(str(cm.exc
-0001f8f0: 6570 7469 6f6e 292c 2027 4552 524f 5220  eption), 'ERROR 
-0001f900: 6261 6420 7072 6f74 6f63 6f6c 5c6e 2729  bad protocol\n')
-0001f910: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0001f920: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-0001f930: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-0001f940: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-0001f950: 5b0a 2020 2020 2020 2020 2020 2020 5b27  [.            ['
-0001f960: 6f70 656e 2d70 6f72 7427 2c20 2738 3038  open-port', '808
-0001f970: 302f 6674 7027 5d2c 0a20 2020 2020 2020  0/ftp'],.       
-0001f980: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-0001f990: 745f 636c 6f73 655f 706f 7274 2873 656c  t_close_port(sel
-0001f9a0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001f9b0: 5f73 6372 6970 7428 7365 6c66 2c20 2763  _script(self, 'c
-0001f9c0: 6c6f 7365 2d70 6f72 7427 2c20 2765 7869  lose-port', 'exi
-0001f9d0: 7420 3027 290a 0a20 2020 2020 2020 2073  t 0')..        s
-0001f9e0: 656c 662e 756e 6974 2e63 6c6f 7365 5f70  elf.unit.close_p
-0001f9f0: 6f72 7428 2774 6370 272c 2038 3038 3029  ort('tcp', 8080)
-0001fa00: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-0001fa10: 6974 2e63 6c6f 7365 5f70 6f72 7428 2755  it.close_port('U
-0001fa20: 4450 272c 2034 3030 3029 0a20 2020 2020  DP', 4000).     
-0001fa30: 2020 2073 656c 662e 756e 6974 2e63 6c6f     self.unit.clo
-0001fa40: 7365 5f70 6f72 7428 2769 636d 7027 290a  se_port('icmp').
-0001fa50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001fa60: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001fa70: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001fa80: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001fa90: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
-0001faa0: 6c6f 7365 2d70 6f72 7427 2c20 2738 3038  lose-port', '808
-0001fab0: 302f 7463 7027 5d2c 0a20 2020 2020 2020  0/tcp'],.       
-0001fac0: 2020 2020 205b 2763 6c6f 7365 2d70 6f72       ['close-por
-0001fad0: 7427 2c20 2734 3030 302f 7564 7027 5d2c  t', '4000/udp'],
-0001fae0: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
-0001faf0: 6c6f 7365 2d70 6f72 7427 2c20 2769 636d  lose-port', 'icm
-0001fb00: 7027 5d2c 0a20 2020 2020 2020 205d 290a  p'],.        ]).
-0001fb10: 0a20 2020 2064 6566 2074 6573 745f 636c  .    def test_cl
-0001fb20: 6f73 655f 706f 7274 5f65 7272 6f72 2873  ose_port_error(s
-0001fb30: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001fb40: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001fb50: 2763 6c6f 7365 2d70 6f72 7427 2c20 2265  'close-port', "e
-0001fb60: 6368 6f20 2745 5252 4f52 2062 6164 2070  cho 'ERROR bad p
-0001fb70: 726f 746f 636f 6c27 203e 2632 3b20 6578  rotocol' >&2; ex
-0001fb80: 6974 2031 2229 0a0a 2020 2020 2020 2020  it 1")..        
-0001fb90: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0001fba0: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
-0001fbb0: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-0001fbc0: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-0001fbd0: 6e69 742e 636c 6f73 655f 706f 7274 2827  nit.close_port('
-0001fbe0: 6674 7027 2c20 3830 3830 290a 2020 2020  ftp', 8080).    
-0001fbf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001fc00: 7175 616c 2873 7472 2863 6d2e 6578 6365  qual(str(cm.exce
-0001fc10: 7074 696f 6e29 2c20 2745 5252 4f52 2062  ption), 'ERROR b
-0001fc20: 6164 2070 726f 746f 636f 6c5c 6e27 290a  ad protocol\n').
-0001fc30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001fc40: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001fc50: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001fc60: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001fc70: 0a20 2020 2020 2020 2020 2020 205b 2763  .            ['c
-0001fc80: 6c6f 7365 2d70 6f72 7427 2c20 2738 3038  lose-port', '808
-0001fc90: 302f 6674 7027 5d2c 0a20 2020 2020 2020  0/ftp'],.       
-0001fca0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-0001fcb0: 745f 6f70 656e 6564 5f70 6f72 7473 2873  t_opened_ports(s
-0001fcc0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001fcd0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001fce0: 276f 7065 6e65 642d 706f 7274 7327 2c20  'opened-ports', 
-0001fcf0: 2222 2265 6368 6f20 3830 3830 2f74 6370  """echo 8080/tcp
-0001fd00: 3b20 6563 686f 2069 636d 7022 2222 290a  ; echo icmp""").
-0001fd10: 0a20 2020 2020 2020 2070 6f72 7473 5f73  .        ports_s
-0001fd20: 6574 203d 2073 656c 662e 756e 6974 2e6f  et = self.unit.o
-0001fd30: 7065 6e65 645f 706f 7274 7328 290a 2020  pened_ports().  
-0001fd40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001fd50: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
-0001fd60: 735f 7365 742c 2073 6574 290a 2020 2020  s_set, set).    
-0001fd70: 2020 2020 706f 7274 7320 3d20 736f 7274      ports = sort
-0001fd80: 6564 2870 6f72 7473 5f73 6574 2c20 6b65  ed(ports_set, ke
-0001fd90: 793d 6c61 6d62 6461 2070 3a20 2870 2e70  y=lambda p: (p.p
-0001fda0: 726f 746f 636f 6c2c 2070 2e70 6f72 7429  rotocol, p.port)
-0001fdb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001fdc0: 7373 6572 7445 7175 616c 286c 656e 2870  ssertEqual(len(p
-0001fdd0: 6f72 7473 292c 2032 290a 2020 2020 2020  orts), 2).      
-0001fde0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0001fdf0: 6e73 7461 6e63 6528 706f 7274 735b 305d  nstance(ports[0]
-0001fe00: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
-0001fe10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001fe20: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
-0001fe30: 5b30 5d2e 7072 6f74 6f63 6f6c 2c20 2769  [0].protocol, 'i
-0001fe40: 636d 7027 290a 2020 2020 2020 2020 7365  cmp').        se
-0001fe50: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0001fe60: 706f 7274 735b 305d 2e70 6f72 7429 0a20  ports[0].port). 
-0001fe70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001fe80: 7274 4973 496e 7374 616e 6365 2870 6f72  rtIsInstance(por
-0001fe90: 7473 5b31 5d2c 206f 7073 2e4f 7065 6e65  ts[1], ops.Opene
-0001fea0: 6450 6f72 7429 0a20 2020 2020 2020 2073  dPort).        s
-0001feb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001fec0: 706f 7274 735b 315d 2e70 726f 746f 636f  ports[1].protoco
-0001fed0: 6c2c 2027 7463 7027 290a 2020 2020 2020  l, 'tcp').      
-0001fee0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001fef0: 616c 2870 6f72 7473 5b31 5d2e 706f 7274  al(ports[1].port
-0001ff00: 2c20 3830 3830 290a 0a20 2020 2020 2020  , 8080)..       
-0001ff10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001ff20: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-0001ff30: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-0001ff40: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
-0001ff50: 2020 2020 205b 276f 7065 6e65 642d 706f       ['opened-po
-0001ff60: 7274 7327 2c20 2727 5d2c 0a20 2020 2020  rts', ''],.     
-0001ff70: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-0001ff80: 6573 745f 6f70 656e 6564 5f70 6f72 7473  est_opened_ports
-0001ff90: 5f77 6172 6e69 6e67 7328 7365 6c66 293a  _warnings(self):
-0001ffa0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-0001ffb0: 7269 7074 2873 656c 662c 2027 6f70 656e  ript(self, 'open
-0001ffc0: 6564 2d70 6f72 7473 272c 2022 2222 6563  ed-ports', """ec
-0001ffd0: 686f 2038 3038 302f 7463 703b 2065 6368  ho 8080/tcp; ech
-0001ffe0: 6f20 3132 3334 2f66 7470 3b20 6563 686f  o 1234/ftp; echo
-0001fff0: 2031 3030 302d 3230 3030 2f75 6470 2222   1000-2000/udp""
-00020000: 2229 0a0a 2020 2020 2020 2020 7769 7468  ")..        with
-00020010: 2073 656c 662e 6173 7365 7274 4c6f 6773   self.assertLogs
-00020020: 2827 6f70 732e 6d6f 6465 6c27 2c20 6c65  ('ops.model', le
-00020030: 7665 6c3d 2757 4152 4e49 4e47 2729 2061  vel='WARNING') a
-00020040: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-00020050: 2020 706f 7274 735f 7365 7420 3d20 7365    ports_set = se
-00020060: 6c66 2e75 6e69 742e 6f70 656e 6564 5f70  lf.unit.opened_p
-00020070: 6f72 7473 2829 0a20 2020 2020 2020 2073  orts().        s
-00020080: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00020090: 6c65 6e28 636d 2e6f 7574 7075 7429 2c20  len(cm.output), 
-000200a0: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
-000200b0: 6173 7365 7274 5265 6765 7828 636d 2e6f  assertRegex(cm.o
-000200c0: 7574 7075 745b 305d 2c20 7227 5741 524e  utput[0], r'WARN
-000200d0: 494e 473a 6f70 732e 6d6f 6465 6c3a 2e2a  ING:ops.model:.*
-000200e0: 7072 6f74 6f63 6f6c 2e2a 2729 0a20 2020  protocol.*').   
-000200f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00020100: 5265 6765 7828 636d 2e6f 7574 7075 745b  Regex(cm.output[
-00020110: 315d 2c20 7227 5741 524e 494e 473a 6f70  1], r'WARNING:op
-00020120: 732e 6d6f 6465 6c3a 2e2a 7261 6e67 652e  s.model:.*range.
-00020130: 2a27 290a 0a20 2020 2020 2020 2073 656c  *')..        sel
-00020140: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-00020150: 6365 2870 6f72 7473 5f73 6574 2c20 7365  ce(ports_set, se
-00020160: 7429 0a20 2020 2020 2020 2070 6f72 7473  t).        ports
-00020170: 203d 2073 6f72 7465 6428 706f 7274 735f   = sorted(ports_
-00020180: 7365 742c 206b 6579 3d6c 616d 6264 6120  set, key=lambda 
-00020190: 703a 2028 702e 7072 6f74 6f63 6f6c 2c20  p: (p.protocol, 
-000201a0: 702e 706f 7274 2929 0a20 2020 2020 2020  p.port)).       
-000201b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000201c0: 6c28 6c65 6e28 706f 7274 7329 2c20 3229  l(len(ports), 2)
-000201d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000201e0: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
-000201f0: 6f72 7473 5b30 5d2c 206f 7073 2e4f 7065  orts[0], ops.Ope
-00020200: 6e65 6450 6f72 7429 0a20 2020 2020 2020  nedPort).       
-00020210: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00020220: 6c28 706f 7274 735b 305d 2e70 726f 746f  l(ports[0].proto
-00020230: 636f 6c2c 2027 7463 7027 290a 2020 2020  col, 'tcp').    
-00020240: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00020250: 7175 616c 2870 6f72 7473 5b30 5d2e 706f  qual(ports[0].po
-00020260: 7274 2c20 3830 3830 290a 2020 2020 2020  rt, 8080).      
-00020270: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-00020280: 6e73 7461 6e63 6528 706f 7274 735b 315d  nstance(ports[1]
-00020290: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
-000202a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000202b0: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
-000202c0: 5b31 5d2e 7072 6f74 6f63 6f6c 2c20 2775  [1].protocol, 'u
-000202d0: 6470 2729 0a20 2020 2020 2020 2073 656c  dp').        sel
-000202e0: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
-000202f0: 7274 735b 315d 2e70 6f72 742c 2031 3030  rts[1].port, 100
-00020300: 3029 0a0a 2020 2020 2020 2020 7365 6c66  0)..        self
-00020310: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-00020320: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-00020330: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-00020340: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00020350: 5b27 6f70 656e 6564 2d70 6f72 7473 272c  ['opened-ports',
-00020360: 2027 275d 2c0a 2020 2020 2020 2020 5d29   ''],.        ])
-00020370: 0a0a 0a69 6620 5f5f 6e61 6d65 5f5f 203d  ...if __name__ =
-00020380: 3d20 225f 5f6d 6169 6e5f 5f22 3a0a 2020  = "__main__":.  
-00020390: 2020 756e 6974 7465 7374 2e6d 6169 6e28    unittest.main(
-000203a0: 290a                                     ).
+00017290: 2273 7461 7475 732d 6461 7461 223a 207b  "status-data": {
+000172a0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+000172b0: 2020 207d 290a 2020 2020 2020 2020 2020     }).          
+000172c0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+000172d0: 7428 7365 6c66 2c20 2773 7461 7475 732d  t(self, 'status-
+000172e0: 6765 7427 2c20 6622 6563 686f 2027 7b63  get', f"echo '{c
+000172f0: 6f6e 7465 6e74 7d27 2229 0a0a 2020 2020  ontent}'")..    
+00017300: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00017310: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+00017320: 6528 6d6f 6465 6c2e 756e 6974 2e73 7461  e(model.unit.sta
+00017330: 7475 732c 2065 7870 6563 7465 645f 636c  tus, expected_cl
+00017340: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00017350: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00017360: 7561 6c28 6d6f 6465 6c2e 756e 6974 2e73  ual(model.unit.s
+00017370: 7461 7475 732e 6e61 6d65 2c20 6e61 6d65  tatus.name, name
+00017380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017390: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000173a0: 616c 286d 6f64 656c 2e75 6e69 742e 7374  al(model.unit.st
+000173b0: 6174 7573 2e6d 6573 7361 6765 2c20 2266  atus.message, "f
+000173c0: 6f6f 2229 0a0a 2020 2020 2020 2020 2020  oo")..          
+000173d0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+000173e0: 6a73 6f6e 2e64 756d 7073 287b 0a20 2020  json.dumps({.   
+000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017400: 2022 6170 706c 6963 6174 696f 6e2d 7374   "application-st
+00017410: 6174 7573 223a 207b 0a20 2020 2020 2020  atus": {.       
+00017420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017430: 2022 6d65 7373 6167 6522 3a20 2262 6172   "message": "bar
+00017440: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00017450: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00017460: 7573 223a 206e 616d 652c 0a20 2020 2020  us": name,.     
+00017470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017480: 2020 2022 7374 6174 7573 2d64 6174 6122     "status-data"
+00017490: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+000174a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000174b0: 2020 2020 2020 2020 2020 2020 7d29 0a20              }). 
+000174c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000174d0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000174e0: 2027 7374 6174 7573 2d67 6574 272c 2066   'status-get', f
+000174f0: 2265 6368 6f20 277b 636f 6e74 656e 747d  "echo '{content}
+00017500: 2722 290a 2020 2020 2020 2020 2020 2020  '").            
+00017510: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00017520: 7365 6c66 2c20 2769 732d 6c65 6164 6572  self, 'is-leader
+00017530: 272c 2027 6563 686f 2074 7275 6527 290a  ', 'echo true').
+00017540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017550: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00017560: 7374 616e 6365 286d 6f64 656c 2e61 7070  stance(model.app
+00017570: 2e73 7461 7475 732c 2065 7870 6563 7465  .status, expecte
+00017580: 645f 636c 7329 0a20 2020 2020 2020 2020  d_cls).         
+00017590: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000175a0: 7274 4571 7561 6c28 6d6f 6465 6c2e 6170  rtEqual(model.ap
+000175b0: 702e 7374 6174 7573 2e6e 616d 652c 206e  p.status.name, n
+000175c0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+000175d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000175e0: 4571 7561 6c28 6d6f 6465 6c2e 6170 702e  Equal(model.app.
+000175f0: 7374 6174 7573 2e6d 6573 7361 6765 2c20  status.message, 
+00017600: 2262 6172 2229 0a0a 2020 2020 6465 6620  "bar")..    def 
+00017610: 7465 7374 5f73 7461 7475 735f 7365 745f  test_status_set_
+00017620: 6973 5f61 7070 5f6e 6f74 5f62 6f6f 6c5f  is_app_not_bool_
+00017630: 7261 6973 6573 2873 656c 6629 3a0a 2020  raises(self):.  
+00017640: 2020 2020 2020 666f 7220 6973 5f61 7070        for is_app
+00017650: 5f76 2069 6e20 5b4e 6f6e 652c 2031 2c20  _v in [None, 1, 
+00017660: 322e 302c 2027 6127 2c20 6227 6265 6566  2.0, 'a', b'beef
+00017670: 272c 206f 626a 6563 745d 3a0a 2020 2020  ', object]:.    
+00017680: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00017690: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
+000176a0: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
+000176b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000176c0: 6261 636b 656e 642e 7374 6174 7573 5f73  backend.status_s
+000176d0: 6574 286f 7073 2e41 6374 6976 6553 7461  et(ops.ActiveSta
+000176e0: 7475 732c 2069 735f 6170 703d 6973 5f61  tus, is_app=is_a
+000176f0: 7070 5f76 290a 0a20 2020 2064 6566 2074  pp_v)..    def t
+00017700: 6573 745f 7374 6f72 6167 655f 746f 6f6c  est_storage_tool
+00017710: 5f65 7272 6f72 7328 7365 6c66 293a 0a20  _errors(self):. 
+00017720: 2020 2020 2020 2074 6573 745f 6361 7365         test_case
+00017730: 7320 3d20 5b28 0a20 2020 2020 2020 2020  s = [(.         
+00017740: 2020 206c 616d 6264 613a 2066 616b 655f     lambda: fake_
+00017750: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
+00017760: 6f72 6167 652d 6c69 7374 272c 2027 6563  orage-list', 'ec
+00017770: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
+00017780: 3b20 6578 6974 2031 2729 2c0a 2020 2020  ; exit 1'),.    
+00017790: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+000177a0: 7365 6c66 2e62 6163 6b65 6e64 2e73 746f  self.backend.sto
+000177b0: 7261 6765 5f6c 6973 7428 2766 6f6f 6261  rage_list('fooba
+000177c0: 7227 292c 0a20 2020 2020 2020 2020 2020  r'),.           
+000177d0: 206f 7073 2e4d 6f64 656c 4572 726f 722c   ops.ModelError,
+000177e0: 0a20 2020 2020 2020 2020 2020 205b 5b27  .            [['
+000177f0: 7374 6f72 6167 652d 6c69 7374 272c 2027  storage-list', '
+00017800: 666f 6f62 6172 272c 2027 2d2d 666f 726d  foobar', '--form
+00017810: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
+00017820: 2020 2020 292c 2028 0a20 2020 2020 2020      ), (.       
+00017830: 2020 2020 206c 616d 6264 613a 2066 616b       lambda: fak
+00017840: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00017850: 7374 6f72 6167 652d 6765 7427 2c20 2765  storage-get', 'e
+00017860: 6368 6f20 666f 6f65 7272 6f72 203e 2632  cho fooerror >&2
+00017870: 203b 2065 7869 7420 3127 292c 0a20 2020   ; exit 1'),.   
+00017880: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00017890: 2073 656c 662e 6261 636b 656e 642e 7374   self.backend.st
+000178a0: 6f72 6167 655f 6765 7428 2766 6f6f 6261  orage_get('fooba
+000178b0: 7227 2c20 2773 6f6d 6561 7474 7227 292c  r', 'someattr'),
+000178c0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+000178d0: 2e4d 6f64 656c 4572 726f 722c 0a20 2020  .ModelError,.   
+000178e0: 2020 2020 2020 2020 205b 5b27 7374 6f72           [['stor
+000178f0: 6167 652d 6765 7427 2c20 272d 7327 2c20  age-get', '-s', 
+00017900: 2766 6f6f 6261 7227 2c20 2773 6f6d 6561  'foobar', 'somea
+00017910: 7474 7227 2c20 272d 2d66 6f72 6d61 743d  ttr', '--format=
+00017920: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
+00017930: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
+00017940: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
+00017950: 6372 6970 7428 7365 6c66 2c20 2773 746f  cript(self, 'sto
+00017960: 7261 6765 2d61 6464 272c 2027 6563 686f  rage-add', 'echo
+00017970: 2066 6f6f 6572 726f 7220 3e26 3220 3b20   fooerror >&2 ; 
+00017980: 6578 6974 2031 2729 2c0a 2020 2020 2020  exit 1'),.      
+00017990: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
+000179a0: 6c66 2e62 6163 6b65 6e64 2e73 746f 7261  lf.backend.stora
+000179b0: 6765 5f61 6464 2827 666f 6f62 6172 272c  ge_add('foobar',
+000179c0: 2063 6f75 6e74 3d32 292c 0a20 2020 2020   count=2),.     
+000179d0: 2020 2020 2020 206f 7073 2e4d 6f64 656c         ops.Model
+000179e0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+000179f0: 2020 205b 5b27 7374 6f72 6167 652d 6164     [['storage-ad
+00017a00: 6427 2c20 2766 6f6f 6261 723d 3227 5d5d  d', 'foobar=2']]
+00017a10: 2c0a 2020 2020 2020 2020 292c 2028 0a20  ,.        ), (. 
+00017a20: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00017a30: 613a 2066 616b 655f 7363 7269 7074 2873  a: fake_script(s
+00017a40: 656c 662c 2027 7374 6f72 6167 652d 6164  elf, 'storage-ad
+00017a50: 6427 2c20 2765 6368 6f20 666f 6f65 7272  d', 'echo fooerr
+00017a60: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
+00017a70: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
+00017a80: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
+00017a90: 656e 642e 7374 6f72 6167 655f 6164 6428  end.storage_add(
+00017aa0: 2766 6f6f 6261 7227 2c20 636f 756e 743d  'foobar', count=
+00017ab0: 6f62 6a65 6374 292c 0a20 2020 2020 2020  object),.       
+00017ac0: 2020 2020 2054 7970 6545 7272 6f72 2c0a       TypeError,.
+00017ad0: 2020 2020 2020 2020 2020 2020 5b5d 2c0a              [],.
+00017ae0: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
+00017af0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00017b00: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00017b10: 662c 2027 7374 6f72 6167 652d 6164 6427  f, 'storage-add'
+00017b20: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
+00017b30: 203e 2632 203b 2065 7869 7420 3127 292c   >&2 ; exit 1'),
+00017b40: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00017b50: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00017b60: 642e 7374 6f72 6167 655f 6164 6428 2766  d.storage_add('f
+00017b70: 6f6f 6261 7227 2c20 636f 756e 743d 5472  oobar', count=Tr
+00017b80: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+00017b90: 2054 7970 6545 7272 6f72 2c0a 2020 2020   TypeError,.    
+00017ba0: 2020 2020 2020 2020 5b5d 2c0a 2020 2020          [],.    
+00017bb0: 2020 2020 295d 0a20 2020 2020 2020 2066      )].        f
+00017bc0: 6f72 2064 6f5f 6661 6b65 2c20 7275 6e2c  or do_fake, run,
+00017bd0: 2065 7863 6570 7469 6f6e 2c20 6361 6c6c   exception, call
+00017be0: 7320 696e 2074 6573 745f 6361 7365 733a  s in test_cases:
+00017bf0: 0a20 2020 2020 2020 2020 2020 2064 6f5f  .            do_
+00017c00: 6661 6b65 2829 0a20 2020 2020 2020 2020  fake().         
+00017c10: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00017c20: 6572 7452 6169 7365 7328 6578 6365 7074  ertRaises(except
+00017c30: 696f 6e29 3a0a 2020 2020 2020 2020 2020  ion):.          
+00017c40: 2020 2020 2020 7275 6e28 290a 2020 2020        run().    
+00017c50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00017c60: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+00017c70: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+00017c80: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
+00017c90: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+00017ca0: 7374 5f6e 6574 776f 726b 5f67 6574 2873  st_network_get(s
+00017cb0: 656c 6629 3a0a 2020 2020 2020 2020 6e65  elf):.        ne
+00017cc0: 7477 6f72 6b5f 6765 745f 6f75 7420 3d20  twork_get_out = 
+00017cd0: 2727 277b 0a20 2022 6269 6e64 2d61 6464  '''{.  "bind-add
+00017ce0: 7265 7373 6573 223a 205b 0a20 2020 207b  resses": [.    {
+00017cf0: 0a20 2020 2020 2022 6d61 632d 6164 6472  .      "mac-addr
+00017d00: 6573 7322 3a20 2222 2c0a 2020 2020 2020  ess": "",.      
+00017d10: 2269 6e74 6572 6661 6365 2d6e 616d 6522  "interface-name"
+00017d20: 3a20 2222 2c0a 2020 2020 2020 2261 6464  : "",.      "add
+00017d30: 7265 7373 6573 223a 205b 0a20 2020 2020  resses": [.     
+00017d40: 2020 207b 0a20 2020 2020 2020 2020 2022     {.          "
+00017d50: 686f 7374 6e61 6d65 223a 2022 222c 0a20  hostname": "",. 
+00017d60: 2020 2020 2020 2020 2022 7661 6c75 6522           "value"
+00017d70: 3a20 2231 3932 2e30 2e32 2e32 222c 0a20  : "192.0.2.2",. 
+00017d80: 2020 2020 2020 2020 2022 6369 6472 223a           "cidr":
+00017d90: 2022 220a 2020 2020 2020 2020 7d0a 2020   "".        }.  
+00017da0: 2020 2020 5d0a 2020 2020 7d0a 2020 5d2c      ].    }.  ],
+00017db0: 0a20 2022 6567 7265 7373 2d73 7562 6e65  .  "egress-subne
+00017dc0: 7473 223a 205b 0a20 2020 2022 3139 322e  ts": [.    "192.
+00017dd0: 302e 322e 322f 3332 220a 2020 5d2c 0a20  0.2.2/32".  ],. 
+00017de0: 2022 696e 6772 6573 732d 6164 6472 6573   "ingress-addres
+00017df0: 7365 7322 3a20 5b0a 2020 2020 2231 3932  ses": [.    "192
+00017e00: 2e30 2e32 2e32 220a 2020 5d0a 7d27 2727  .0.2.2".  ].}'''
+00017e10: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00017e20: 7269 7074 2873 656c 662c 2027 6e65 7477  ript(self, 'netw
+00017e30: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
+00017e40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00017e50: 2727 5b20 2224 3122 203d 2064 6561 6462  ''[ "$1" = deadb
+00017e60: 6565 6620 5d20 2626 2065 6368 6f20 277b  eef ] && echo '{
+00017e70: 6e65 7477 6f72 6b5f 6765 745f 6f75 747d  network_get_out}
+00017e80: 2720 7c7c 2065 7869 7420 3127 2727 290a  ' || exit 1''').
+00017e90: 2020 2020 2020 2020 6e65 7477 6f72 6b5f          network_
+00017ea0: 696e 666f 203d 2073 656c 662e 6261 636b  info = self.back
+00017eb0: 656e 642e 6e65 7477 6f72 6b5f 6765 7428  end.network_get(
+00017ec0: 2764 6561 6462 6565 6627 290a 2020 2020  'deadbeef').    
+00017ed0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00017ee0: 7175 616c 286e 6574 776f 726b 5f69 6e66  qual(network_inf
+00017ef0: 6f2c 206a 736f 6e2e 6c6f 6164 7328 6e65  o, json.loads(ne
+00017f00: 7477 6f72 6b5f 6765 745f 6f75 7429 290a  twork_get_out)).
+00017f10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00017f20: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+00017f30: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+00017f40: 2063 6c65 6172 3d54 7275 6529 2c0a 2020   clear=True),.  
+00017f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f60: 2020 2020 2020 205b 5b27 6e65 7477 6f72         [['networ
+00017f70: 6b2d 6765 7427 2c20 2764 6561 6462 6565  k-get', 'deadbee
+00017f80: 6627 2c20 272d 2d66 6f72 6d61 743d 6a73  f', '--format=js
+00017f90: 6f6e 275d 5d29 0a0a 2020 2020 2020 2020  on']])..        
+00017fa0: 6e65 7477 6f72 6b5f 696e 666f 203d 2073  network_info = s
+00017fb0: 656c 662e 6261 636b 656e 642e 6e65 7477  elf.backend.netw
+00017fc0: 6f72 6b5f 6765 7428 2764 6561 6462 6565  ork_get('deadbee
+00017fd0: 6627 2c20 3129 0a20 2020 2020 2020 2073  f', 1).        s
+00017fe0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00017ff0: 6e65 7477 6f72 6b5f 696e 666f 2c20 6a73  network_info, js
+00018000: 6f6e 2e6c 6f61 6473 286e 6574 776f 726b  on.loads(network
+00018010: 5f67 6574 5f6f 7574 2929 0a20 2020 2020  _get_out)).     
+00018020: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00018030: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00018040: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00018050: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
+00018060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018070: 2020 5b5b 276e 6574 776f 726b 2d67 6574    [['network-get
+00018080: 272c 2027 6465 6164 6265 6566 272c 2027  ', 'deadbeef', '
+00018090: 2d72 272c 2027 3127 2c20 272d 2d66 6f72  -r', '1', '--for
+000180a0: 6d61 743d 6a73 6f6e 275d 5d29 0a0a 2020  mat=json']])..  
+000180b0: 2020 6465 6620 7465 7374 5f6e 6574 776f    def test_netwo
+000180c0: 726b 5f67 6574 5f65 7272 6f72 7328 7365  rk_get_errors(se
+000180d0: 6c66 293a 0a20 2020 2020 2020 2065 7272  lf):.        err
+000180e0: 5f6e 6f5f 656e 6470 6f69 6e74 203d 2027  _no_endpoint = '
+000180f0: 4552 524f 5220 6e6f 206e 6574 776f 726b  ERROR no network
+00018100: 2063 6f6e 6669 6720 666f 756e 6420 666f   config found fo
+00018110: 7220 6269 6e64 696e 6720 2224 3222 270a  r binding "$2"'.
+00018120: 2020 2020 2020 2020 6572 725f 6e6f 5f72          err_no_r
+00018130: 656c 203d 2027 4552 524f 5220 696e 7661  el = 'ERROR inva
+00018140: 6c69 6420 7661 6c75 6520 2224 3322 2066  lid value "$3" f
+00018150: 6f72 206f 7074 696f 6e20 2d72 3a20 7265  or option -r: re
+00018160: 6c61 7469 6f6e 206e 6f74 2066 6f75 6e64  lation not found
+00018170: 270a 0a20 2020 2020 2020 2074 6573 745f  '..        test_
+00018180: 6361 7365 7320 3d20 5b28 0a20 2020 2020  cases = [(.     
+00018190: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+000181a0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000181b0: 2027 6e65 7477 6f72 6b2d 6765 7427 2c0a   'network-get',.
+000181c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181e0: 6627 6563 686f 207b 6572 725f 6e6f 5f65  f'echo {err_no_e
+000181f0: 6e64 706f 696e 747d 203e 2632 203b 2065  ndpoint} >&2 ; e
+00018200: 7869 7420 3127 292c 0a20 2020 2020 2020  xit 1'),.       
+00018210: 2020 2020 206c 616d 6264 613a 2073 656c       lambda: sel
+00018220: 662e 6261 636b 656e 642e 6e65 7477 6f72  f.backend.networ
+00018230: 6b5f 6765 7428 2264 6561 6462 6565 6622  k_get("deadbeef"
+00018240: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+00018250: 7073 2e4d 6f64 656c 4572 726f 722c 0a20  ps.ModelError,. 
+00018260: 2020 2020 2020 2020 2020 205b 5b27 6e65             [['ne
+00018270: 7477 6f72 6b2d 6765 7427 2c20 2764 6561  twork-get', 'dea
+00018280: 6462 6565 6627 2c20 272d 2d66 6f72 6d61  dbeef', '--forma
+00018290: 743d 6a73 6f6e 275d 5d2c 0a20 2020 2020  t=json']],.     
+000182a0: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+000182b0: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
+000182c0: 5f73 6372 6970 7428 7365 6c66 2c20 276e  _script(self, 'n
+000182d0: 6574 776f 726b 2d67 6574 272c 2066 2765  etwork-get', f'e
+000182e0: 6368 6f20 7b65 7272 5f6e 6f5f 7265 6c7d  cho {err_no_rel}
+000182f0: 203e 2632 203b 2065 7869 7420 3227 292c   >&2 ; exit 2'),
+00018300: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00018310: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00018320: 642e 6e65 7477 6f72 6b5f 6765 7428 2264  d.network_get("d
+00018330: 6561 6462 6565 6622 2c20 3329 2c0a 2020  eadbeef", 3),.  
+00018340: 2020 2020 2020 2020 2020 6f70 732e 5265            ops.Re
+00018350: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
+00018360: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+00018370: 205b 5b27 6e65 7477 6f72 6b2d 6765 7427   [['network-get'
+00018380: 2c20 2764 6561 6462 6565 6627 2c20 272d  , 'deadbeef', '-
+00018390: 7227 2c20 2733 272c 2027 2d2d 666f 726d  r', '3', '--form
+000183a0: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
+000183b0: 2020 2020 295d 0a20 2020 2020 2020 2066      )].        f
+000183c0: 6f72 2064 6f5f 6661 6b65 2c20 7275 6e2c  or do_fake, run,
+000183d0: 2065 7863 6570 7469 6f6e 2c20 6361 6c6c   exception, call
+000183e0: 7320 696e 2074 6573 745f 6361 7365 733a  s in test_cases:
+000183f0: 0a20 2020 2020 2020 2020 2020 2064 6f5f  .            do_
+00018400: 6661 6b65 2829 0a20 2020 2020 2020 2020  fake().         
+00018410: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00018420: 6572 7452 6169 7365 7328 6578 6365 7074  ertRaises(except
+00018430: 696f 6e29 3a0a 2020 2020 2020 2020 2020  ion):.          
+00018440: 2020 2020 2020 7275 6e28 290a 2020 2020        run().    
+00018450: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018460: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+00018470: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+00018480: 2063 6c65 6172 3d54 7275 6529 2c20 6361   clear=True), ca
+00018490: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
+000184a0: 7374 5f61 6374 696f 6e5f 6765 745f 6572  st_action_get_er
+000184b0: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+000184c0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+000184d0: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+000184e0: 272c 2027 2729 0a20 2020 2020 2020 2066  ', '').        f
+000184f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00018500: 2027 6163 7469 6f6e 2d67 6574 272c 2027   'action-get', '
+00018510: 6563 686f 2066 6f6f 6572 726f 7220 3e26  echo fooerror >&
+00018520: 3220 3b20 6578 6974 2031 2729 0a20 2020  2 ; exit 1').   
+00018530: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00018540: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00018550: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00018560: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00018570: 636b 656e 642e 6163 7469 6f6e 5f67 6574  ckend.action_get
+00018580: 2829 0a20 2020 2020 2020 2063 616c 6c73  ().        calls
+00018590: 203d 205b 5b27 6163 7469 6f6e 2d67 6574   = [['action-get
+000185a0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+000185b0: 6e27 5d5d 0a20 2020 2020 2020 2073 656c  n']].        sel
+000185c0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+000185d0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+000185e0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+000185f0: 292c 2063 616c 6c73 290a 0a20 2020 2064  ), calls)..    d
+00018600: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
+00018610: 6574 5f65 7272 6f72 2873 656c 6629 3a0a  et_error(self):.
+00018620: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00018630: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
+00018640: 6e2d 6765 7427 2c20 2727 290a 2020 2020  n-get', '').    
+00018650: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00018660: 7365 6c66 2c20 2761 6374 696f 6e2d 7365  self, 'action-se
+00018670: 7427 2c20 2765 6368 6f20 666f 6f65 7272  t', 'echo fooerr
+00018680: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
+00018690: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000186a0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000186b0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+000186c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000186d0: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
+000186e0: 6e5f 7365 7428 4f72 6465 7265 6444 6963  n_set(OrderedDic
+000186f0: 7428 5b28 2766 6f6f 272c 2027 6261 7227  t([('foo', 'bar'
+00018700: 292c 2028 2764 6561 6427 2c20 2762 6565  ), ('dead', 'bee
+00018710: 6620 6361 6665 2729 5d29 290a 2020 2020  f cafe')])).    
+00018720: 2020 2020 7365 6c66 2e61 7373 6572 7443      self.assertC
+00018730: 6f75 6e74 4571 7561 6c28 0a20 2020 2020  ountEqual(.     
+00018740: 2020 2020 2020 205b 2261 6374 696f 6e2d         ["action-
+00018750: 7365 7422 2c20 2264 6561 643d 6265 6566  set", "dead=beef
+00018760: 2063 6166 6522 2c20 2266 6f6f 3d62 6172   cafe", "foo=bar
+00018770: 225d 2c20 6661 6b65 5f73 6372 6970 745f  "], fake_script_
+00018780: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00018790: 723d 5472 7565 295b 305d 290a 0a20 2020  r=True)[0])..   
+000187a0: 2064 6566 2074 6573 745f 6163 7469 6f6e   def test_action
+000187b0: 5f6c 6f67 5f65 7272 6f72 2873 656c 6629  _log_error(self)
+000187c0: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+000187d0: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
+000187e0: 696f 6e2d 6765 7427 2c20 2727 290a 2020  ion-get', '').  
+000187f0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00018800: 7428 7365 6c66 2c20 2761 6374 696f 6e2d  t(self, 'action-
+00018810: 6c6f 6727 2c20 2765 6368 6f20 666f 6f65  log', 'echo fooe
+00018820: 7272 6f72 203e 2632 203b 2065 7869 7420  rror >&2 ; exit 
+00018830: 3127 290a 2020 2020 2020 2020 7769 7468  1').        with
+00018840: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00018850: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00018860: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00018870: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
+00018880: 696f 6e5f 6c6f 6728 276c 6f67 2d6d 6573  ion_log('log-mes
+00018890: 7361 6765 2729 0a20 2020 2020 2020 2063  sage').        c
+000188a0: 616c 6c73 203d 205b 5b22 6163 7469 6f6e  alls = [["action
+000188b0: 2d6c 6f67 222c 2022 6c6f 672d 6d65 7373  -log", "log-mess
+000188c0: 6167 6522 5d5d 0a20 2020 2020 2020 2073  age"]].        s
+000188d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000188e0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+000188f0: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+00018900: 7565 292c 2063 616c 6c73 290a 0a20 2020  ue), calls)..   
+00018910: 2064 6566 2074 6573 745f 6163 7469 6f6e   def test_action
+00018920: 5f67 6574 2873 656c 6629 3a0a 2020 2020  _get(self):.    
+00018930: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00018940: 7365 6c66 2c20 2761 6374 696f 6e2d 6765  self, 'action-ge
+00018950: 7427 2c20 2222 2265 6368 6f20 277b 2266  t', """echo '{"f
+00018960: 6f6f 2d6e 616d 6522 3a20 2262 6172 222c  oo-name": "bar",
+00018970: 2022 7369 6c65 6e74 223a 2066 616c 7365   "silent": false
+00018980: 7d27 2222 2229 0a20 2020 2020 2020 2070  }'""").        p
+00018990: 6172 616d 7320 3d20 7365 6c66 2e62 6163  arams = self.bac
+000189a0: 6b65 6e64 2e61 6374 696f 6e5f 6765 7428  kend.action_get(
+000189b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000189c0: 7373 6572 7445 7175 616c 2870 6172 616d  ssertEqual(param
+000189d0: 735b 2766 6f6f 2d6e 616d 6527 5d2c 2027  s['foo-name'], '
+000189e0: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
+000189f0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00018a00: 6172 616d 735b 2773 696c 656e 7427 5d2c  arams['silent'],
+00018a10: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
+00018a20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018a30: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+00018a40: 6c73 2873 656c 6629 2c20 5b5b 2761 6374  ls(self), [['act
+00018a50: 696f 6e2d 6765 7427 2c20 272d 2d66 6f72  ion-get', '--for
+00018a60: 6d61 743d 6a73 6f6e 275d 5d29 0a0a 2020  mat=json']])..  
+00018a70: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
+00018a80: 6e5f 7365 7428 7365 6c66 293a 0a20 2020  n_set(self):.   
+00018a90: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00018aa0: 2873 656c 662c 2027 6163 7469 6f6e 2d67  (self, 'action-g
+00018ab0: 6574 272c 2027 6578 6974 2031 2729 0a20  et', 'exit 1'). 
+00018ac0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00018ad0: 7074 2873 656c 662c 2027 6163 7469 6f6e  pt(self, 'action
+00018ae0: 2d73 6574 272c 2027 6578 6974 2030 2729  -set', 'exit 0')
+00018af0: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00018b00: 636b 656e 642e 6163 7469 6f6e 5f73 6574  ckend.action_set
+00018b10: 287b 2778 273a 2027 6465 6164 2062 6565  ({'x': 'dead bee
+00018b20: 6627 2c20 2779 273a 2031 7d29 0a20 2020  f', 'y': 1}).   
+00018b30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018b40: 436f 756e 7445 7175 616c 285b 2761 6374  CountEqual(['act
+00018b50: 696f 6e2d 7365 7427 2c20 2778 3d64 6561  ion-set', 'x=dea
+00018b60: 6420 6265 6566 272c 2027 793d 3127 5d2c  d beef', 'y=1'],
+00018b70: 2066 616b 655f 7363 7269 7074 5f63 616c   fake_script_cal
+00018b80: 6c73 2873 656c 6629 5b30 5d29 0a0a 2020  ls(self)[0])..  
+00018b90: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
+00018ba0: 6e5f 7365 745f 6b65 795f 7661 6c69 6461  n_set_key_valida
+00018bb0: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+00018bc0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00018bd0: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
+00018be0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00018bf0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+00018c00: 2e61 6374 696f 6e5f 7365 7428 7b27 5827  .action_set({'X'
+00018c10: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
+00018c20: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
+00018c30: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00018c40: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
+00018c50: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00018c60: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
+00018c70: 696f 6e5f 7365 7428 7b27 736f 6d65 266b  ion_set({'some&k
+00018c80: 6579 273a 2027 6465 6164 2062 6565 6627  ey': 'dead beef'
+00018c90: 2c20 2779 273a 2031 7d29 0a20 2020 2020  , 'y': 1}).     
+00018ca0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00018cb0: 6572 7452 6169 7365 7328 5661 6c75 6545  ertRaises(ValueE
+00018cc0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00018cd0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00018ce0: 6163 7469 6f6e 5f73 6574 287b 2773 6f6d  action_set({'som
+00018cf0: 654b 6579 273a 2027 6465 6164 2062 6565  eKey': 'dead bee
+00018d00: 6627 2c20 2779 273a 2031 7d29 0a20 2020  f', 'y': 1}).   
+00018d10: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00018d20: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
+00018d30: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00018d40: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
+00018d50: 642e 6163 7469 6f6e 5f73 6574 287b 2773  d.action_set({'s
+00018d60: 6f6d 655f 6b65 7927 3a20 2764 6561 6420  ome_key': 'dead 
+00018d70: 6265 6566 272c 2027 7927 3a20 317d 290a  beef', 'y': 1}).
+00018d80: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
+00018d90: 7469 6f6e 5f73 6574 5f6e 6573 7465 6428  tion_set_nested(
+00018da0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+00018db0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00018dc0: 2027 6163 7469 6f6e 2d67 6574 272c 2027   'action-get', '
+00018dd0: 6578 6974 2031 2729 0a20 2020 2020 2020  exit 1').       
+00018de0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00018df0: 662c 2027 6163 7469 6f6e 2d73 6574 272c  f, 'action-set',
+00018e00: 2027 6578 6974 2030 2729 0a20 2020 2020   'exit 0').     
+00018e10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00018e20: 6163 7469 6f6e 5f73 6574 287b 2761 273a  action_set({'a':
+00018e30: 207b 2762 273a 2031 2c20 2763 273a 2032   {'b': 1, 'c': 2
+00018e40: 7d2c 2027 6427 3a20 337d 290a 2020 2020  }, 'd': 3}).    
+00018e50: 2020 2020 7365 6c66 2e61 7373 6572 7443      self.assertC
+00018e60: 6f75 6e74 4571 7561 6c28 5b27 6163 7469  ountEqual(['acti
+00018e70: 6f6e 2d73 6574 272c 2027 612e 623d 3127  on-set', 'a.b=1'
+00018e80: 2c20 2761 2e63 3d32 272c 2027 643d 3327  , 'a.c=2', 'd=3'
+00018e90: 5d2c 2066 616b 655f 7363 7269 7074 5f63  ], fake_script_c
+00018ea0: 616c 6c73 2873 656c 6629 5b30 5d29 0a0a  alls(self)[0])..
+00018eb0: 2020 2020 6465 6620 7465 7374 5f61 6374      def test_act
+00018ec0: 696f 6e5f 7365 745f 6d6f 7265 5f6e 6573  ion_set_more_nes
+00018ed0: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
+00018ee0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00018ef0: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+00018f00: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
+00018f10: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00018f20: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
+00018f30: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
+00018f40: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00018f50: 656e 642e 6163 7469 6f6e 5f73 6574 287b  end.action_set({
+00018f60: 2761 273a 207b 2762 273a 2031 2c20 2763  'a': {'b': 1, 'c
+00018f70: 273a 2032 2c20 2764 273a 207b 2765 273a  ': 2, 'd': {'e':
+00018f80: 2033 7d7d 2c20 2766 273a 2034 7d29 0a20   3}}, 'f': 4}). 
+00018f90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018fa0: 7274 436f 756e 7445 7175 616c 280a 2020  rtCountEqual(.  
+00018fb0: 2020 2020 2020 2020 2020 5b27 6163 7469            ['acti
+00018fc0: 6f6e 2d73 6574 272c 2027 612e 623d 3127  on-set', 'a.b=1'
+00018fd0: 2c20 2761 2e63 3d32 272c 2027 612e 642e  , 'a.c=2', 'a.d.
+00018fe0: 653d 3327 2c20 2766 3d34 275d 2c20 6661  e=3', 'f=4'], fa
+00018ff0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00019000: 7365 6c66 295b 305d 290a 0a20 2020 2064  self)[0])..    d
+00019010: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
+00019020: 6574 5f64 6f74 7465 645f 6469 6374 2873  et_dotted_dict(s
+00019030: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+00019040: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00019050: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
+00019060: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
+00019070: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00019080: 2c20 2761 6374 696f 6e2d 7365 7427 2c20  , 'action-set', 
+00019090: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
+000190a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+000190b0: 6374 696f 6e5f 7365 7428 7b27 612e 6227  ction_set({'a.b'
+000190c0: 3a20 312c 2027 6127 3a20 7b27 6327 3a20  : 1, 'a': {'c': 
+000190d0: 327d 2c20 2764 273a 2033 7d29 0a20 2020  2}, 'd': 3}).   
+000190e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000190f0: 436f 756e 7445 7175 616c 285b 2761 6374  CountEqual(['act
+00019100: 696f 6e2d 7365 7427 2c20 2761 2e62 3d31  ion-set', 'a.b=1
+00019110: 272c 2027 612e 633d 3227 2c20 2764 3d33  ', 'a.c=2', 'd=3
+00019120: 275d 2c20 6661 6b65 5f73 6372 6970 745f  '], fake_script_
+00019130: 6361 6c6c 7328 7365 6c66 295b 305d 290a  calls(self)[0]).
+00019140: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
+00019150: 7469 6f6e 5f73 6574 5f64 7570 6c69 6361  tion_set_duplica
+00019160: 7465 645f 6b65 7973 2873 656c 6629 3a0a  ted_keys(self):.
+00019170: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00019180: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
+00019190: 6e2d 6765 7427 2c20 2765 7869 7420 3127  n-get', 'exit 1'
+000191a0: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+000191b0: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
+000191c0: 696f 6e2d 7365 7427 2c20 2765 7869 7420  ion-set', 'exit 
+000191d0: 3027 290a 2020 2020 2020 2020 7769 7468  0').        with
+000191e0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+000191f0: 6573 2856 616c 7565 4572 726f 7229 3a0a  es(ValueError):.
+00019200: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019210: 2e62 6163 6b65 6e64 2e61 6374 696f 6e5f  .backend.action_
+00019220: 7365 7428 7b27 612e 6227 3a20 312c 2027  set({'a.b': 1, '
+00019230: 6127 3a20 7b27 6227 3a20 327d 2c20 2764  a': {'b': 2}, 'd
+00019240: 273a 2033 7d29 0a20 2020 2020 2020 2077  ': 3}).        w
+00019250: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00019260: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
+00019270: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00019280: 656c 662e 6261 636b 656e 642e 6163 7469  elf.backend.acti
+00019290: 6f6e 5f73 6574 287b 2761 273a 207b 2762  on_set({'a': {'b
+000192a0: 273a 2031 2c20 2763 273a 2032 2c20 2764  ': 1, 'c': 2, 'd
+000192b0: 273a 207b 2765 273a 2033 7d7d 2c20 2766  ': {'e': 3}}, 'f
+000192c0: 273a 2034 2c20 2761 2e64 2e65 273a 2027  ': 4, 'a.d.e': '
+000192d0: 666f 6f27 7d29 0a0a 2020 2020 6465 6620  foo'})..    def 
+000192e0: 7465 7374 5f61 6374 696f 6e5f 6661 696c  test_action_fail
+000192f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00019300: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00019310: 2c20 2761 6374 696f 6e2d 6765 7427 2c20  , 'action-get', 
+00019320: 2765 7869 7420 3127 290a 2020 2020 2020  'exit 1').      
+00019330: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00019340: 6c66 2c20 2761 6374 696f 6e2d 6661 696c  lf, 'action-fail
+00019350: 272c 2027 6578 6974 2030 2729 0a20 2020  ', 'exit 0').   
+00019360: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
+00019370: 642e 6163 7469 6f6e 5f66 6169 6c28 2765  d.action_fail('e
+00019380: 7272 6f72 2034 3227 290a 2020 2020 2020  rror 42').      
+00019390: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000193a0: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+000193b0: 616c 6c73 2873 656c 6629 2c20 5b5b 2761  alls(self), [['a
+000193c0: 6374 696f 6e2d 6661 696c 272c 2027 6572  ction-fail', 'er
+000193d0: 726f 7220 3432 275d 5d29 0a0a 2020 2020  ror 42']])..    
+000193e0: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
+000193f0: 6c6f 6728 7365 6c66 293a 0a20 2020 2020  log(self):.     
+00019400: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00019410: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+00019420: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
+00019430: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00019440: 2873 656c 662c 2027 6163 7469 6f6e 2d6c  (self, 'action-l
+00019450: 6f67 272c 2027 6578 6974 2030 2729 0a20  og', 'exit 0'). 
+00019460: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00019470: 656e 642e 6163 7469 6f6e 5f6c 6f67 2827  end.action_log('
+00019480: 7072 6f67 7265 7373 3a20 3432 2527 290a  progress: 42%').
+00019490: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000194a0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+000194b0: 7269 7074 5f63 616c 6c73 2873 656c 6629  ript_calls(self)
+000194c0: 2c20 5b5b 2761 6374 696f 6e2d 6c6f 6727  , [['action-log'
+000194d0: 2c20 2770 726f 6772 6573 733a 2034 3225  , 'progress: 42%
+000194e0: 275d 5d29 0a0a 2020 2020 6465 6620 7465  ']])..    def te
+000194f0: 7374 5f61 7070 6c69 6361 7469 6f6e 5f76  st_application_v
+00019500: 6572 7369 6f6e 5f73 6574 2873 656c 6629  ersion_set(self)
+00019510: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+00019520: 6372 6970 7428 7365 6c66 2c20 2761 7070  cript(self, 'app
+00019530: 6c69 6361 7469 6f6e 2d76 6572 7369 6f6e  lication-version
+00019540: 2d73 6574 272c 2027 6578 6974 2030 2729  -set', 'exit 0')
+00019550: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00019560: 636b 656e 642e 6170 706c 6963 6174 696f  ckend.applicatio
+00019570: 6e5f 7665 7273 696f 6e5f 7365 7428 2731  n_version_set('1
+00019580: 2e32 6233 2729 0a20 2020 2020 2020 2073  .2b3').        s
+00019590: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000195a0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+000195b0: 7328 7365 6c66 292c 205b 5b27 6170 706c  s(self), [['appl
+000195c0: 6963 6174 696f 6e2d 7665 7273 696f 6e2d  ication-version-
+000195d0: 7365 7427 2c20 272d 2d27 2c20 2731 2e32  set', '--', '1.2
+000195e0: 6233 275d 5d29 0a0a 2020 2020 6465 6620  b3']])..    def 
+000195f0: 7465 7374 5f61 7070 6c69 6361 7469 6f6e  test_application
+00019600: 5f76 6572 7369 6f6e 5f73 6574 5f69 6e76  _version_set_inv
+00019610: 616c 6964 2873 656c 6629 3a0a 2020 2020  alid(self):.    
+00019620: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00019630: 7365 6c66 2c20 2761 7070 6c69 6361 7469  self, 'applicati
+00019640: 6f6e 2d76 6572 7369 6f6e 2d73 6574 272c  on-version-set',
+00019650: 2027 6578 6974 2030 2729 0a20 2020 2020   'exit 0').     
+00019660: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00019670: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+00019680: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00019690: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+000196a0: 7070 6c69 6361 7469 6f6e 5f76 6572 7369  pplication_versi
+000196b0: 6f6e 5f73 6574 2832 290a 2020 2020 2020  on_set(2).      
+000196c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+000196d0: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+000196e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000196f0: 2073 656c 662e 6261 636b 656e 642e 6170   self.backend.ap
+00019700: 706c 6963 6174 696f 6e5f 7665 7273 696f  plication_versio
+00019710: 6e5f 7365 7428 290a 2020 2020 2020 2020  n_set().        
+00019720: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00019730: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+00019740: 6c73 2873 656c 6629 2c20 5b5d 290a 0a20  ls(self), []).. 
+00019750: 2020 2064 6566 2074 6573 745f 6a75 6a75     def test_juju
+00019760: 5f6c 6f67 2873 656c 6629 3a0a 2020 2020  _log(self):.    
+00019770: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00019780: 7365 6c66 2c20 276a 756a 752d 6c6f 6727  self, 'juju-log'
+00019790: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
+000197a0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+000197b0: 2e6a 756a 755f 6c6f 6728 2757 4152 4e49  .juju_log('WARNI
+000197c0: 4e47 272c 2027 666f 6f27 290a 2020 2020  NG', 'foo').    
+000197d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000197e0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+000197f0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+00019800: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
+00019810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019820: 2020 205b 5b27 6a75 6a75 2d6c 6f67 272c     [['juju-log',
+00019830: 2027 2d2d 6c6f 672d 6c65 7665 6c27 2c20   '--log-level', 
+00019840: 2757 4152 4e49 4e47 272c 2027 2d2d 272c  'WARNING', '--',
+00019850: 2027 666f 6f27 5d5d 290a 0a20 2020 2020   'foo']])..     
+00019860: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00019870: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+00019880: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00019890: 2020 7365 6c66 2e62 6163 6b65 6e64 2e6a    self.backend.j
+000198a0: 756a 755f 6c6f 6728 2744 4542 5547 2729  uju_log('DEBUG')
+000198b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000198c0: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+000198d0: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+000198e0: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
+000198f0: 5d29 0a0a 2020 2020 2020 2020 6661 6b65  ])..        fake
+00019900: 5f73 6372 6970 7428 7365 6c66 2c20 276a  _script(self, 'j
+00019910: 756a 752d 6c6f 6727 2c20 2765 7869 7420  uju-log', 'exit 
+00019920: 3127 290a 2020 2020 2020 2020 7769 7468  1').        with
+00019930: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00019940: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00019950: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00019960: 7365 6c66 2e62 6163 6b65 6e64 2e6a 756a  self.backend.juj
+00019970: 755f 6c6f 6728 2742 4152 272c 2027 666f  u_log('BAR', 'fo
+00019980: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
+00019990: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+000199a0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+000199b0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+000199c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000199d0: 2020 2020 2020 2020 2020 205b 5b27 6a75             [['ju
+000199e0: 6a75 2d6c 6f67 272c 2027 2d2d 6c6f 672d  ju-log', '--log-
+000199f0: 6c65 7665 6c27 2c20 2742 4152 272c 2027  level', 'BAR', '
+00019a00: 2d2d 272c 2027 666f 6f27 5d5d 290a 0a20  --', 'foo']]).. 
+00019a10: 2020 2064 6566 2074 6573 745f 7661 6c69     def test_vali
+00019a20: 645f 6d65 7472 6963 7328 7365 6c66 293a  d_metrics(self):
+00019a30: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00019a40: 7269 7074 2873 656c 662c 2027 6164 642d  ript(self, 'add-
+00019a50: 6d65 7472 6963 272c 2027 6578 6974 2030  metric', 'exit 0
+00019a60: 2729 0a20 2020 2020 2020 2074 6573 745f  ').        test_
+00019a70: 6361 7365 7320 3d20 5b28 0a20 2020 2020  cases = [(.     
+00019a80: 2020 2020 2020 204f 7264 6572 6564 4469         OrderedDi
+00019a90: 6374 285b 2827 666f 6f27 2c20 3432 292c  ct([('foo', 42),
+00019aa0: 2028 2762 2d61 7227 2c20 342e 3529 2c20   ('b-ar', 4.5), 
+00019ab0: 2827 6261 5f2d 7a27 2c20 342e 3529 2c20  ('ba_-z', 4.5), 
+00019ac0: 2827 6127 2c20 3129 5d29 2c0a 2020 2020  ('a', 1)]),.    
+00019ad0: 2020 2020 2020 2020 4f72 6465 7265 6444          OrderedD
+00019ae0: 6963 7428 5b28 2764 6527 2c20 2761 6427  ict([('de', 'ad'
+00019af0: 292c 2028 2762 6527 2c20 2765 665f 202d  ), ('be', 'ef_ -
+00019b00: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
+00019b10: 2020 5b5b 2761 6464 2d6d 6574 7269 6327    [['add-metric'
+00019b20: 2c20 272d 2d6c 6162 656c 7327 2c20 2764  , '--labels', 'd
+00019b30: 653d 6164 2c62 653d 6566 5f20 2d27 2c0a  e=ad,be=ef_ -',.
+00019b40: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00019b50: 6f6f 3d34 3227 2c20 2762 2d61 723d 342e  oo=42', 'b-ar=4.
+00019b60: 3527 2c20 2762 615f 2d7a 3d34 2e35 272c  5', 'ba_-z=4.5',
+00019b70: 2027 613d 3127 5d5d 0a20 2020 2020 2020   'a=1']].       
+00019b80: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
+00019b90: 2020 4f72 6465 7265 6444 6963 7428 5b28    OrderedDict([(
+00019ba0: 2766 6f6f 3127 2c20 3029 2c20 2827 6232  'foo1', 0), ('b2
+00019bb0: 7227 2c20 342e 3529 5d29 2c0a 2020 2020  r', 4.5)]),.    
+00019bc0: 2020 2020 2020 2020 4f72 6465 7265 6444          OrderedD
+00019bd0: 6963 7428 5b28 2764 3327 2c20 2761 d0b4  ict([('d3', 'a..
+00019be0: 2729 2c20 2827 6233 3366 272c 2027 335f  '), ('b33f', '3_
+00019bf0: 202d 2729 5d29 2c0a 2020 2020 2020 2020   -')]),.        
+00019c00: 2020 2020 5b5b 2761 6464 2d6d 6574 7269      [['add-metri
+00019c10: 6327 2c20 272d 2d6c 6162 656c 7327 2c20  c', '--labels', 
+00019c20: 2764 333d 61d0 b42c 6233 3366 3d33 5f20  'd3=a..,b33f=3_ 
+00019c30: 2d27 2c20 2766 6f6f 313d 3027 2c20 2762  -', 'foo1=0', 'b
+00019c40: 3272 3d34 2e35 275d 5d2c 0a20 2020 2020  2r=4.5']],.     
+00019c50: 2020 2029 5d0a 2020 2020 2020 2020 666f     )].        fo
+00019c60: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
+00019c70: 732c 2065 7870 6563 7465 645f 6361 6c6c  s, expected_call
+00019c80: 7320 696e 2074 6573 745f 6361 7365 733a  s in test_cases:
+00019c90: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00019ca0: 662e 6261 636b 656e 642e 6164 645f 6d65  f.backend.add_me
+00019cb0: 7472 6963 7328 6d65 7472 6963 732c 206c  trics(metrics, l
+00019cc0: 6162 656c 7329 0a20 2020 2020 2020 2020  abels).         
+00019cd0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00019ce0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00019cf0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00019d00: 723d 5472 7565 292c 2065 7870 6563 7465  r=True), expecte
+00019d10: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
+00019d20: 6620 7465 7374 5f69 6e76 616c 6964 5f6d  f test_invalid_m
+00019d30: 6574 7269 635f 6e61 6d65 7328 7365 6c66  etric_names(self
+00019d40: 293a 0a20 2020 2020 2020 2069 6e76 616c  ):.        inval
+00019d50: 6964 5f69 6e70 7574 7320 3d20 5b0a 2020  id_inputs = [.  
+00019d60: 2020 2020 2020 2020 2020 287b 2727 3a20            ({'': 
+00019d70: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
+00019d80: 2020 2020 2020 2028 7b27 3127 3a20 342e         ({'1': 4.
+00019d90: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
+00019da0: 2020 2020 2028 7b27 3127 3a20 2d34 2e32       ({'1': -4.2
+00019db0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
+00019dc0: 2020 2020 287b 2731 3233 273a 2034 2e32      ({'123': 4.2
+00019dd0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
+00019de0: 2020 2020 287b 2731 666f 6f27 3a20 342e      ({'1foo': 4.
+00019df0: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
+00019e00: 2020 2020 2028 7b27 2d66 6f6f 273a 2034       ({'-foo': 4
+00019e10: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
+00019e20: 2020 2020 2020 287b 275f 666f 6f27 3a20        ({'_foo': 
+00019e30: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
+00019e40: 2020 2020 2020 2028 7b27 666f 6f2d 273a         ({'foo-':
+00019e50: 2034 2e32 7d2c 207b 7d29 2c0a 2020 2020   4.2}, {}),.    
+00019e60: 2020 2020 2020 2020 287b 2766 6f6f 5f27          ({'foo_'
+00019e70: 3a20 342e 327d 2c20 7b7d 292c 0a20 2020  : 4.2}, {}),.   
+00019e80: 2020 2020 2020 2020 2028 7b27 612d 273a           ({'a-':
+00019e90: 2034 2e32 7d2c 207b 7d29 2c0a 2020 2020   4.2}, {}),.    
+00019ea0: 2020 2020 2020 2020 287b 2761 5f27 3a20          ({'a_': 
+00019eb0: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
+00019ec0: 2020 2020 2020 2028 7b27 4241 d0af 273a         ({'BA..':
+00019ed0: 2034 2e32 7d2c 207b 7d29 2c0a 2020 2020   4.2}, {}),.    
+00019ee0: 2020 2020 5d0a 2020 2020 2020 2020 666f      ].        fo
+00019ef0: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
+00019f00: 7320 696e 2069 6e76 616c 6964 5f69 6e70  s in invalid_inp
+00019f10: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
+00019f20: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00019f30: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
+00019f40: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
+00019f50: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00019f60: 636b 656e 642e 6164 645f 6d65 7472 6963  ckend.add_metric
+00019f70: 7328 6d65 7472 6963 732c 206c 6162 656c  s(metrics, label
+00019f80: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
+00019f90: 5f69 6e76 616c 6964 5f6d 6574 7269 635f  _invalid_metric_
+00019fa0: 7661 6c75 6573 2873 656c 6629 3a0a 2020  values(self):.  
+00019fb0: 2020 2020 2020 696e 7661 6c69 645f 696e        invalid_in
+00019fc0: 7075 7473 203d 205b 0a20 2020 2020 2020  puts = [.       
+00019fd0: 2020 2020 2028 7b27 6127 3a20 666c 6f61       ({'a': floa
+00019fe0: 7428 272b 696e 6627 297d 2c20 7b7d 292c  t('+inf')}, {}),
+00019ff0: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
+0001a000: 6127 3a20 666c 6f61 7428 272d 696e 6627  a': float('-inf'
+0001a010: 297d 2c20 7b7d 292c 0a20 2020 2020 2020  )}, {}),.       
+0001a020: 2020 2020 2028 7b27 6127 3a20 666c 6f61       ({'a': floa
+0001a030: 7428 276e 616e 2729 7d2c 207b 7d29 2c0a  t('nan')}, {}),.
+0001a040: 2020 2020 2020 2020 2020 2020 287b 2766              ({'f
+0001a050: 6f6f 273a 2027 6261 7227 7d2c 207b 7d29  oo': 'bar'}, {})
+0001a060: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
+0001a070: 2766 6f6f 273a 2027 314f 277d 2c20 7b7d  'foo': '1O'}, {}
+0001a080: 292c 0a20 2020 2020 2020 205d 0a20 2020  ),.        ].   
+0001a090: 2020 2020 2066 6f72 206d 6574 7269 6373       for metrics
+0001a0a0: 2c20 6c61 6265 6c73 2069 6e20 696e 7661  , labels in inva
+0001a0b0: 6c69 645f 696e 7075 7473 3a0a 2020 2020  lid_inputs:.    
+0001a0c0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0001a0d0: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0001a0e0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+0001a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a100: 7365 6c66 2e62 6163 6b65 6e64 2e61 6464  self.backend.add
+0001a110: 5f6d 6574 7269 6373 286d 6574 7269 6373  _metrics(metrics
+0001a120: 2c20 6c61 6265 6c73 290a 0a20 2020 2064  , labels)..    d
+0001a130: 6566 2074 6573 745f 696e 7661 6c69 645f  ef test_invalid_
+0001a140: 6d65 7472 6963 5f6c 6162 656c 7328 7365  metric_labels(se
+0001a150: 6c66 293a 0a20 2020 2020 2020 2069 6e76  lf):.        inv
+0001a160: 616c 6964 5f69 6e70 7574 7320 3d20 5b0a  alid_inputs = [.
+0001a170: 2020 2020 2020 2020 2020 2020 287b 2766              ({'f
+0001a180: 6f6f 273a 2034 2e32 7d2c 207b 2727 3a20  oo': 4.2}, {'': 
+0001a190: 2762 617a 277d 292c 0a20 2020 2020 2020  'baz'}),.       
+0001a1a0: 2020 2020 2028 7b27 666f 6f27 3a20 342e       ({'foo': 4.
+0001a1b0: 327d 2c20 7b27 2c62 6172 273a 2027 6261  2}, {',bar': 'ba
+0001a1c0: 7a27 7d29 2c0a 2020 2020 2020 2020 2020  z'}),.          
+0001a1d0: 2020 287b 2766 6f6f 273a 2034 2e32 7d2c    ({'foo': 4.2},
+0001a1e0: 207b 2762 3d61 3d72 273a 2027 6261 7a27   {'b=a=r': 'baz'
+0001a1f0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+0001a200: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
+0001a210: 2742 41d0 af27 3a20 2762 617a 277d 292c  'BA..': 'baz'}),
+0001a220: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+0001a230: 2020 2066 6f72 206d 6574 7269 6373 2c20     for metrics, 
+0001a240: 6c61 6265 6c73 2069 6e20 696e 7661 6c69  labels in invali
+0001a250: 645f 696e 7075 7473 3a0a 2020 2020 2020  d_inputs:.      
+0001a260: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0001a270: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+0001a280: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+0001a290: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001a2a0: 6c66 2e62 6163 6b65 6e64 2e61 6464 5f6d  lf.backend.add_m
+0001a2b0: 6574 7269 6373 286d 6574 7269 6373 2c20  etrics(metrics, 
+0001a2c0: 6c61 6265 6c73 290a 0a20 2020 2064 6566  labels)..    def
+0001a2d0: 2074 6573 745f 696e 7661 6c69 645f 6d65   test_invalid_me
+0001a2e0: 7472 6963 5f6c 6162 656c 5f76 616c 7565  tric_label_value
+0001a2f0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001a300: 2069 6e76 616c 6964 5f69 6e70 7574 7320   invalid_inputs 
+0001a310: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001a320: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
+0001a330: 2762 6172 273a 2027 277d 292c 0a20 2020  'bar': ''}),.   
+0001a340: 2020 2020 2020 2020 2028 7b27 666f 6f27           ({'foo'
+0001a350: 3a20 342e 327d 2c20 7b27 6261 7227 3a20  : 4.2}, {'bar': 
+0001a360: 2762 2c61 7a27 7d29 2c0a 2020 2020 2020  'b,az'}),.      
+0001a370: 2020 2020 2020 287b 2766 6f6f 273a 2034        ({'foo': 4
+0001a380: 2e32 7d2c 207b 2762 6172 273a 2027 623d  .2}, {'bar': 'b=
+0001a390: 617a 277d 292c 0a20 2020 2020 2020 205d  az'}),.        ]
+0001a3a0: 0a20 2020 2020 2020 2066 6f72 206d 6574  .        for met
+0001a3b0: 7269 6373 2c20 6c61 6265 6c73 2069 6e20  rics, labels in 
+0001a3c0: 696e 7661 6c69 645f 696e 7075 7473 3a0a  invalid_inputs:.
+0001a3d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0001a3e0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0001a3f0: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+0001a400: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001a410: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
+0001a420: 2e61 6464 5f6d 6574 7269 6373 286d 6574  .add_metrics(met
+0001a430: 7269 6373 2c20 6c61 6265 6c73 290a 0a20  rics, labels).. 
+0001a440: 2020 2064 6566 2074 6573 745f 7265 6c61     def test_rela
+0001a450: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
+0001a460: 6e61 6d65 5f65 6e76 2873 656c 6629 3a0a  name_env(self):.
+0001a470: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0001a480: 436c 6561 6e75 7028 6f73 2e65 6e76 6972  Cleanup(os.envir
+0001a490: 6f6e 2e70 6f70 2c20 274a 554a 555f 5245  on.pop, 'JUJU_RE
+0001a4a0: 4c41 5449 4f4e 5f49 4427 2c20 4e6f 6e65  LATION_ID', None
+0001a4b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001a4c0: 6464 436c 6561 6e75 7028 6f73 2e65 6e76  ddCleanup(os.env
+0001a4d0: 6972 6f6e 2e70 6f70 2c20 274a 554a 555f  iron.pop, 'JUJU_
+0001a4e0: 5245 4d4f 5445 5f41 5050 272c 204e 6f6e  REMOTE_APP', Non
+0001a4f0: 6529 0a0a 2020 2020 2020 2020 6f73 2e65  e)..        os.e
+0001a500: 6e76 6972 6f6e 5b27 4a55 4a55 5f52 454c  nviron['JUJU_REL
+0001a510: 4154 494f 4e5f 4944 275d 203d 2027 783a  ATION_ID'] = 'x:
+0001a520: 3527 0a20 2020 2020 2020 206f 732e 656e  5'.        os.en
+0001a530: 7669 726f 6e5b 274a 554a 555f 5245 4d4f  viron['JUJU_REMO
+0001a540: 5445 5f41 5050 275d 203d 2027 7265 6d6f  TE_APP'] = 'remo
+0001a550: 7465 6170 7031 270a 2020 2020 2020 2020  teapp1'.        
+0001a560: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001a570: 2873 656c 662e 6261 636b 656e 642e 7265  (self.backend.re
+0001a580: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
+0001a590: 705f 6e61 6d65 2835 292c 2027 7265 6d6f  p_name(5), 'remo
+0001a5a0: 7465 6170 7031 2729 0a20 2020 2020 2020  teapp1').       
+0001a5b0: 206f 732e 656e 7669 726f 6e5b 274a 554a   os.environ['JUJ
+0001a5c0: 555f 5245 4c41 5449 4f4e 5f49 4427 5d20  U_RELATION_ID'] 
+0001a5d0: 3d20 2735 270a 2020 2020 2020 2020 7365  = '5'.        se
+0001a5e0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001a5f0: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+0001a600: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
+0001a610: 6e61 6d65 2835 292c 2027 7265 6d6f 7465  name(5), 'remote
+0001a620: 6170 7031 2729 0a0a 2020 2020 6465 6620  app1')..    def 
+0001a630: 7465 7374 5f72 656c 6174 696f 6e5f 7265  test_relation_re
+0001a640: 6d6f 7465 5f61 7070 5f6e 616d 655f 7363  mote_app_name_sc
+0001a650: 7269 7074 5f73 7563 6365 7373 2873 656c  ript_success(sel
+0001a660: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0001a670: 2e61 6464 436c 6561 6e75 7028 6f73 2e65  .addCleanup(os.e
+0001a680: 6e76 6972 6f6e 2e70 6f70 2c20 274a 554a  nviron.pop, 'JUJ
+0001a690: 555f 5245 4c41 5449 4f4e 5f49 4427 2c20  U_RELATION_ID', 
+0001a6a0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+0001a6b0: 6c66 2e61 6464 436c 6561 6e75 7028 6f73  lf.addCleanup(os
+0001a6c0: 2e65 6e76 6972 6f6e 2e70 6f70 2c20 274a  .environ.pop, 'J
+0001a6d0: 554a 555f 5245 4d4f 5445 5f41 5050 272c  UJU_REMOTE_APP',
+0001a6e0: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
+0001a6f0: 2320 4a55 4a55 5f52 454c 4154 494f 4e5f  # JUJU_RELATION_
+0001a700: 4944 2061 6e64 204a 554a 555f 5245 4d4f  ID and JUJU_REMO
+0001a710: 5445 5f41 5050 2062 6f74 6820 756e 7365  TE_APP both unse
+0001a720: 740a 2020 2020 2020 2020 6661 6b65 5f73  t.        fake_s
+0001a730: 6372 6970 7428 7365 6c66 2c20 2772 656c  cript(self, 'rel
+0001a740: 6174 696f 6e2d 6c69 7374 272c 2072 2222  ation-list', r""
+0001a750: 220a 6563 686f 2027 2272 656d 6f74 6561  ".echo '"remotea
+0001a760: 7070 3222 270a 2222 2229 0a20 2020 2020  pp2"'.""").     
+0001a770: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a780: 7561 6c28 7365 6c66 2e62 6163 6b65 6e64  ual(self.backend
+0001a790: 2e72 656c 6174 696f 6e5f 7265 6d6f 7465  .relation_remote
+0001a7a0: 5f61 7070 5f6e 616d 6528 3129 2c20 2772  _app_name(1), 'r
+0001a7b0: 656d 6f74 6561 7070 3227 290a 2020 2020  emoteapp2').    
+0001a7c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001a7d0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001a7e0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001a7f0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+0001a800: 2020 2020 2020 2020 5b27 7265 6c61 7469          ['relati
+0001a810: 6f6e 2d6c 6973 7427 2c20 272d 7227 2c20  on-list', '-r', 
+0001a820: 2731 272c 2027 2d2d 6170 7027 2c20 272d  '1', '--app', '-
+0001a830: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+0001a840: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0001a850: 2020 2020 2320 4a55 4a55 5f52 454c 4154      # JUJU_RELAT
+0001a860: 494f 4e5f 4944 2073 6574 2062 7574 204a  ION_ID set but J
+0001a870: 554a 555f 5245 4d4f 5445 5f41 5050 2075  UJU_REMOTE_APP u
+0001a880: 6e73 6574 0a20 2020 2020 2020 206f 732e  nset.        os.
+0001a890: 656e 7669 726f 6e5b 274a 554a 555f 5245  environ['JUJU_RE
+0001a8a0: 4c41 5449 4f4e 5f49 4427 5d20 3d20 2778  LATION_ID'] = 'x
+0001a8b0: 3a35 270a 2020 2020 2020 2020 7365 6c66  :5'.        self
+0001a8c0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0001a8d0: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
+0001a8e0: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
+0001a8f0: 6d65 2835 292c 2027 7265 6d6f 7465 6170  me(5), 'remoteap
+0001a900: 7032 2729 0a0a 2020 2020 2020 2020 2320  p2')..        # 
+0001a910: 4a55 4a55 5f52 454c 4154 494f 4e5f 4944  JUJU_RELATION_ID
+0001a920: 2075 6e73 6574 2062 7574 204a 554a 555f   unset but JUJU_
+0001a930: 5245 4d4f 5445 5f41 5050 2073 6574 0a20  REMOTE_APP set. 
+0001a940: 2020 2020 2020 2064 656c 206f 732e 656e         del os.en
+0001a950: 7669 726f 6e5b 274a 554a 555f 5245 4c41  viron['JUJU_RELA
+0001a960: 5449 4f4e 5f49 4427 5d0a 2020 2020 2020  TION_ID'].      
+0001a970: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
+0001a980: 4a55 5f52 454d 4f54 455f 4150 5027 5d20  JU_REMOTE_APP'] 
+0001a990: 3d20 2772 656d 6f74 6561 7070 3127 0a20  = 'remoteapp1'. 
+0001a9a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001a9b0: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
+0001a9c0: 6b65 6e64 2e72 656c 6174 696f 6e5f 7265  kend.relation_re
+0001a9d0: 6d6f 7465 5f61 7070 5f6e 616d 6528 3529  mote_app_name(5)
+0001a9e0: 2c20 2772 656d 6f74 6561 7070 3227 290a  , 'remoteapp2').
+0001a9f0: 0a20 2020 2020 2020 2023 2042 6f74 6820  .        # Both 
+0001aa00: 7365 742c 2062 7574 204a 554a 555f 5245  set, but JUJU_RE
+0001aa10: 4c41 5449 4f4e 5f49 4420 6120 6469 6666  LATION_ID a diff
+0001aa20: 6572 656e 7420 7265 6c61 7469 6f6e 0a20  erent relation. 
+0001aa30: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
+0001aa40: 6e5b 274a 554a 555f 5245 4c41 5449 4f4e  n['JUJU_RELATION
+0001aa50: 5f49 4427 5d20 3d20 2778 3a36 270a 2020  _ID'] = 'x:6'.  
+0001aa60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001aa70: 7445 7175 616c 2873 656c 662e 6261 636b  tEqual(self.back
+0001aa80: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
+0001aa90: 6f74 655f 6170 705f 6e61 6d65 2835 292c  ote_app_name(5),
+0001aaa0: 2027 7265 6d6f 7465 6170 7032 2729 0a0a   'remoteapp2')..
+0001aab0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+0001aac0: 6174 696f 6e5f 7265 6d6f 7465 5f61 7070  ation_remote_app
+0001aad0: 5f6e 616d 655f 7363 7269 7074 5f65 7272  _name_script_err
+0001aae0: 6f72 7328 7365 6c66 293a 0a20 2020 2020  ors(self):.     
+0001aaf0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001ab00: 656c 662c 2027 7265 6c61 7469 6f6e 2d6c  elf, 'relation-l
+0001ab10: 6973 7427 2c20 7222 2222 0a65 6368 6f20  ist', r""".echo 
+0001ab20: 2245 5252 4f52 2069 6e76 616c 6964 2076  "ERROR invalid v
+0001ab30: 616c 7565 205c 2236 5c22 2066 6f72 206f  alue \"6\" for o
+0001ab40: 7074 696f 6e20 2d72 3a20 7265 6c61 7469  ption -r: relati
+0001ab50: 6f6e 206e 6f74 2066 6f75 6e64 2220 3e26  on not found" >&
+0001ab60: 3220 2023 204e 4f51 410a 6578 6974 2032  2  # NOQA.exit 2
+0001ab70: 0a22 2222 290a 2020 2020 2020 2020 7365  .""").        se
+0001ab80: 6c66 2e61 7373 6572 7449 7328 7365 6c66  lf.assertIs(self
+0001ab90: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+0001aba0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
+0001abb0: 6528 3629 2c20 4e6f 6e65 290a 2020 2020  e(6), None).    
+0001abc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001abd0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001abe0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001abf0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+0001ac00: 2020 2020 2020 2020 5b27 7265 6c61 7469          ['relati
+0001ac10: 6f6e 2d6c 6973 7427 2c20 272d 7227 2c20  on-list', '-r', 
+0001ac20: 2736 272c 2027 2d2d 6170 7027 2c20 272d  '6', '--app', '-
+0001ac30: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+0001ac40: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0001ac50: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001ac60: 7365 6c66 2c20 2772 656c 6174 696f 6e2d  self, 'relation-
+0001ac70: 6c69 7374 272c 2072 2222 220a 6563 686f  list', r""".echo
+0001ac80: 2022 4552 524f 5220 6f70 7469 6f6e 2070   "ERROR option p
+0001ac90: 726f 7669 6465 6420 6275 7420 6e6f 7420  rovided but not 
+0001aca0: 6465 6669 6e65 643a 202d 2d61 7070 2220  defined: --app" 
+0001acb0: 3e26 320a 6578 6974 2032 0a22 2222 290a  >&2.exit 2.""").
+0001acc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001acd0: 6572 7449 7328 7365 6c66 2e62 6163 6b65  ertIs(self.backe
+0001ace0: 6e64 2e72 656c 6174 696f 6e5f 7265 6d6f  nd.relation_remo
+0001acf0: 7465 5f61 7070 5f6e 616d 6528 3629 2c20  te_app_name(6), 
+0001ad00: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+0001ad10: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+0001ad20: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+0001ad30: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+0001ad40: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
+0001ad50: 2020 5b27 7265 6c61 7469 6f6e 2d6c 6973    ['relation-lis
+0001ad60: 7427 2c20 272d 7227 2c20 2736 272c 2027  t', '-r', '6', '
+0001ad70: 2d2d 6170 7027 2c20 272d 2d66 6f72 6d61  --app', '--forma
+0001ad80: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
+0001ad90: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0001ada0: 7374 5f70 6c61 6e6e 6564 5f75 6e69 7473  st_planned_units
+0001adb0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001adc0: 2320 6e6f 2075 6e69 7473 0a20 2020 2020  # no units.     
+0001add0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001ade0: 656c 662c 2027 676f 616c 2d73 7461 7465  elf, 'goal-state
+0001adf0: 272c 2022 2222 0a65 6368 6f20 277b 2275  ', """.echo '{"u
+0001ae00: 6e69 7473 223a 7b7d 2c20 2272 656c 6174  nits":{}, "relat
+0001ae10: 696f 6e73 223a 7b7d 7d27 0a22 2222 290a  ions":{}}'.""").
+0001ae20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ae30: 6572 7445 7175 616c 2873 656c 662e 6261  ertEqual(self.ba
+0001ae40: 636b 656e 642e 706c 616e 6e65 645f 756e  ckend.planned_un
+0001ae50: 6974 7328 292c 2030 290a 0a20 2020 2020  its(), 0)..     
+0001ae60: 2020 2023 206f 6e6c 7920 6163 7469 7665     # only active
+0001ae70: 2075 6e69 7473 0a20 2020 2020 2020 2066   units.        f
+0001ae80: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001ae90: 2027 676f 616c 2d73 7461 7465 272c 2022   'goal-state', "
+0001aea0: 2222 0a65 6368 6f20 277b 0a20 2020 2022  "".echo '{.    "
+0001aeb0: 756e 6974 7322 3a7b 0a20 2020 2020 2020  units":{.       
+0001aec0: 2022 6170 702f 3022 3a20 7b22 7374 6174   "app/0": {"stat
+0001aed0: 7573 223a 2261 6374 6976 6522 2c22 7369  us":"active","si
+0001aee0: 6e63 6522 3a22 3230 3233 2d30 352d 3233  nce":"2023-05-23
+0001aef0: 2031 373a 3035 3a30 355a 227d 2c0a 2020   17:05:05Z"},.  
+0001af00: 2020 2020 2020 2261 7070 2f31 223a 207b        "app/1": {
+0001af10: 2273 7461 7475 7322 3a22 6163 7469 7665  "status":"active
+0001af20: 222c 2273 696e 6365 223a 2232 3032 332d  ","since":"2023-
+0001af30: 3035 2d32 3320 3137 3a35 373a 3035 5a22  05-23 17:57:05Z"
+0001af40: 7d0a 2020 2020 7d2c 0a20 2020 2022 7265  }.    },.    "re
+0001af50: 6c61 7469 6f6e 7322 3a20 7b7d 0a7d 2722  lations": {}.}'"
+0001af60: 2222 290a 2020 2020 2020 2020 7365 6c66  "").        self
+0001af70: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0001af80: 662e 6261 636b 656e 642e 706c 616e 6e65  f.backend.planne
+0001af90: 645f 756e 6974 7328 292c 2032 290a 0a20  d_units(), 2).. 
+0001afa0: 2020 2020 2020 2023 2061 6374 6976 6520         # active 
+0001afb0: 616e 6420 6479 696e 6720 756e 6974 730a  and dying units.
+0001afc0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+0001afd0: 6970 7428 7365 6c66 2c20 2767 6f61 6c2d  ipt(self, 'goal-
+0001afe0: 7374 6174 6527 2c20 2222 220a 6563 686f  state', """.echo
+0001aff0: 2027 7b0a 2020 2020 2275 6e69 7473 223a   '{.    "units":
+0001b000: 7b0a 2020 2020 2020 2020 2261 7070 2f30  {.        "app/0
+0001b010: 223a 207b 2273 7461 7475 7322 3a22 6163  ": {"status":"ac
+0001b020: 7469 7665 222c 2273 696e 6365 223a 2232  tive","since":"2
+0001b030: 3032 332d 3035 2d32 3320 3137 3a30 353a  023-05-23 17:05:
+0001b040: 3035 5a22 7d2c 0a20 2020 2020 2020 2022  05Z"},.        "
+0001b050: 6170 702f 3122 3a20 7b22 7374 6174 7573  app/1": {"status
+0001b060: 223a 2264 7969 6e67 222c 2273 696e 6365  ":"dying","since
+0001b070: 223a 2232 3032 332d 3035 2d32 3320 3137  ":"2023-05-23 17
+0001b080: 3a35 373a 3035 5a22 7d0a 2020 2020 7d2c  :57:05Z"}.    },
+0001b090: 0a20 2020 2022 7265 6c61 7469 6f6e 7322  .    "relations"
+0001b0a0: 3a20 7b7d 0a7d 2722 2222 290a 2020 2020  : {}.}'""").    
+0001b0b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b0c0: 7175 616c 2873 656c 662e 6261 636b 656e  qual(self.backen
+0001b0d0: 642e 706c 616e 6e65 645f 756e 6974 7328  d.planned_units(
+0001b0e0: 292c 2031 290a 0a0a 636c 6173 7320 5465  ), 1)...class Te
+0001b0f0: 7374 4c61 7a79 4d61 7070 696e 6728 756e  stLazyMapping(un
+0001b100: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
+0001b110: 3a0a 0a20 2020 2064 6566 2074 6573 745f  :..    def test_
+0001b120: 696e 7661 6c69 6461 7465 2873 656c 6629  invalidate(self)
+0001b130: 3a0a 2020 2020 2020 2020 6c6f 6164 6564  :.        loaded
+0001b140: 203d 205b 5d0a 0a20 2020 2020 2020 2063   = []..        c
+0001b150: 6c61 7373 204d 794c 617a 794d 6170 286f  lass MyLazyMap(o
+0001b160: 7073 2e4c 617a 794d 6170 7069 6e67 293a  ps.LazyMapping):
+0001b170: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+0001b180: 205f 6c6f 6164 2873 656c 6629 3a0a 2020   _load(self):.  
+0001b190: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001b1a0: 6164 6564 2e61 7070 656e 6428 3129 0a20  aded.append(1). 
+0001b1b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001b1c0: 6574 7572 6e20 7b27 666f 6f27 3a20 2762  eturn {'foo': 'b
+0001b1d0: 6172 277d 0a0a 2020 2020 2020 2020 6d61  ar'}..        ma
+0001b1e0: 7020 3d20 4d79 4c61 7a79 4d61 7028 290a  p = MyLazyMap().
+0001b1f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001b200: 6572 7445 7175 616c 286d 6170 5b27 666f  ertEqual(map['fo
+0001b210: 6f27 5d2c 2027 6261 7227 290a 2020 2020  o'], 'bar').    
+0001b220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b230: 7175 616c 286c 6f61 6465 642c 205b 315d  qual(loaded, [1]
+0001b240: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001b250: 7373 6572 7445 7175 616c 286d 6170 5b27  ssertEqual(map['
+0001b260: 666f 6f27 5d2c 2027 6261 7227 290a 2020  foo'], 'bar').  
+0001b270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b280: 7445 7175 616c 286c 6f61 6465 642c 205b  tEqual(loaded, [
+0001b290: 315d 290a 2020 2020 2020 2020 6d61 702e  1]).        map.
+0001b2a0: 5f69 6e76 616c 6964 6174 6528 290a 2020  _invalidate().  
+0001b2b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b2c0: 7445 7175 616c 286d 6170 5b27 666f 6f27  tEqual(map['foo'
+0001b2d0: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
+0001b2e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001b2f0: 616c 286c 6f61 6465 642c 205b 312c 2031  al(loaded, [1, 1
+0001b300: 5d29 0a0a 0a63 6c61 7373 2054 6573 7453  ])...class TestS
+0001b310: 6563 7265 7473 2875 6e69 7474 6573 742e  ecrets(unittest.
+0001b320: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
+0001b330: 6566 2073 6574 5570 2873 656c 6629 3a0a  ef setUp(self):.
+0001b340: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
+0001b350: 656c 203d 206f 7073 2e4d 6f64 656c 286f  el = ops.Model(o
+0001b360: 7073 2e43 6861 726d 4d65 7461 2829 2c20  ps.CharmMeta(), 
+0001b370: 5f4d 6f64 656c 4261 636b 656e 6428 276d  _ModelBackend('m
+0001b380: 7961 7070 2f30 2729 290a 2020 2020 2020  yapp/0')).      
+0001b390: 2020 7365 6c66 2e61 7070 203d 2073 656c    self.app = sel
+0001b3a0: 662e 6d6f 6465 6c2e 6170 700a 2020 2020  f.model.app.    
+0001b3b0: 2020 2020 7365 6c66 2e75 6e69 7420 3d20      self.unit = 
+0001b3c0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 740a  self.model.unit.
+0001b3d0: 0a20 2020 2064 6566 2074 6573 745f 6170  .    def test_ap
+0001b3e0: 705f 6164 645f 7365 6372 6574 5f73 696d  p_add_secret_sim
+0001b3f0: 706c 6528 7365 6c66 293a 0a20 2020 2020  ple(self):.     
+0001b400: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001b410: 656c 662c 2027 7365 6372 6574 2d61 6464  elf, 'secret-add
+0001b420: 272c 2027 6563 686f 2073 6563 7265 743a  ', 'echo secret:
+0001b430: 3132 3327 290a 0a20 2020 2020 2020 2073  123')..        s
+0001b440: 6563 7265 7420 3d20 7365 6c66 2e61 7070  ecret = self.app
+0001b450: 2e61 6464 5f73 6563 7265 7428 7b27 666f  .add_secret({'fo
+0001b460: 6f27 3a20 2778 277d 290a 2020 2020 2020  o': 'x'}).      
+0001b470: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0001b480: 6e73 7461 6e63 6528 7365 6372 6574 2c20  nstance(secret, 
+0001b490: 6f70 732e 5365 6372 6574 290a 2020 2020  ops.Secret).    
+0001b4a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b4b0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
+0001b4c0: 2773 6563 7265 743a 3132 3327 290a 2020  'secret:123').  
+0001b4d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b4e0: 7449 734e 6f6e 6528 7365 6372 6574 2e6c  tIsNone(secret.l
+0001b4f0: 6162 656c 290a 0a20 2020 2020 2020 2073  abel)..        s
+0001b500: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b510: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001b520: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001b530: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
+0001b540: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
+0001b550: 2773 6563 7265 742d 6164 6427 2c20 272d  'secret-add', '-
+0001b560: 2d6f 776e 6572 272c 2027 6170 706c 6963  -owner', 'applic
+0001b570: 6174 696f 6e27 2c20 2766 6f6f 3d78 275d  ation', 'foo=x']
+0001b580: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+0001b590: 5f61 7070 5f61 6464 5f73 6563 7265 745f  _app_add_secret_
+0001b5a0: 6172 6773 2873 656c 6629 3a0a 2020 2020  args(self):.    
+0001b5b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001b5c0: 7365 6c66 2c20 2773 6563 7265 742d 6164  self, 'secret-ad
+0001b5d0: 6427 2c20 2765 6368 6f20 7365 6372 6574  d', 'echo secret
+0001b5e0: 3a32 3334 2729 0a0a 2020 2020 2020 2020  :234')..        
+0001b5f0: 6578 7069 7265 203d 2064 6174 6574 696d  expire = datetim
+0001b600: 652e 6461 7465 7469 6d65 2832 3032 322c  e.datetime(2022,
+0001b610: 2031 322c 2039 2c20 3136 2c20 3137 2c20   12, 9, 16, 17, 
+0001b620: 3029 0a20 2020 2020 2020 2073 6563 7265  0).        secre
+0001b630: 7420 3d20 7365 6c66 2e61 7070 2e61 6464  t = self.app.add
+0001b640: 5f73 6563 7265 7428 7b27 666f 6f27 3a20  _secret({'foo': 
+0001b650: 2778 272c 2027 6261 7227 3a20 2779 277d  'x', 'bar': 'y'}
+0001b660: 2c20 6c61 6265 6c3d 276c 626c 272c 2064  , label='lbl', d
+0001b670: 6573 6372 6970 7469 6f6e 3d27 6465 7363  escription='desc
+0001b680: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6a0: 2020 2020 2020 2020 6578 7069 7265 3d65          expire=e
+0001b6b0: 7870 6972 652c 2072 6f74 6174 653d 6f70  xpire, rotate=op
+0001b6c0: 732e 5365 6372 6574 526f 7461 7465 2e48  s.SecretRotate.H
+0001b6d0: 4f55 524c 5929 0a20 2020 2020 2020 2073  OURLY).        s
+0001b6e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b6f0: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
+0001b700: 6574 3a32 3334 2729 0a20 2020 2020 2020  et:234').       
+0001b710: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b720: 6c28 7365 6372 6574 2e6c 6162 656c 2c20  l(secret.label, 
+0001b730: 276c 626c 2729 0a20 2020 2020 2020 2073  'lbl').        s
+0001b740: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b750: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
+0001b760: 6e74 2829 2c20 7b27 666f 6f27 3a20 2778  nt(), {'foo': 'x
+0001b770: 272c 2027 6261 7227 3a20 2779 277d 290a  ', 'bar': 'y'}).
+0001b780: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001b790: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+0001b7a0: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+0001b7b0: 2c20 636c 6561 723d 5472 7565 292c 0a20  , clear=True),. 
+0001b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7d0: 2020 2020 2020 2020 5b5b 2773 6563 7265          [['secre
+0001b7e0: 742d 6164 6427 2c20 272d 2d6c 6162 656c  t-add', '--label
+0001b7f0: 272c 2027 6c62 6c27 2c20 272d 2d64 6573  ', 'lbl', '--des
+0001b800: 6372 6970 7469 6f6e 272c 2027 6465 7363  cription', 'desc
+0001b810: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001b820: 2020 2020 2020 2020 2020 2020 2020 272d                '-
+0001b830: 2d65 7870 6972 6527 2c20 2732 3032 322d  -expire', '2022-
+0001b840: 3132 2d30 3954 3136 3a31 373a 3030 272c  12-09T16:17:00',
+0001b850: 2027 2d2d 726f 7461 7465 272c 2027 686f   '--rotate', 'ho
+0001b860: 7572 6c79 272c 0a20 2020 2020 2020 2020  urly',.         
+0001b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b880: 2020 272d 2d6f 776e 6572 272c 2027 6170    '--owner', 'ap
+0001b890: 706c 6963 6174 696f 6e27 2c20 2766 6f6f  plication', 'foo
+0001b8a0: 3d78 272c 2027 6261 723d 7927 5d5d 290a  =x', 'bar=y']]).
+0001b8b0: 0a20 2020 2064 6566 2074 6573 745f 756e  .    def test_un
+0001b8c0: 6974 5f61 6464 5f73 6563 7265 745f 7369  it_add_secret_si
+0001b8d0: 6d70 6c65 2873 656c 6629 3a0a 2020 2020  mple(self):.    
+0001b8e0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001b8f0: 7365 6c66 2c20 2773 6563 7265 742d 6164  self, 'secret-ad
+0001b900: 6427 2c20 2765 6368 6f20 7365 6372 6574  d', 'echo secret
+0001b910: 3a33 3435 2729 0a0a 2020 2020 2020 2020  :345')..        
+0001b920: 7365 6372 6574 203d 2073 656c 662e 756e  secret = self.un
+0001b930: 6974 2e61 6464 5f73 6563 7265 7428 7b27  it.add_secret({'
+0001b940: 666f 6f27 3a20 2778 277d 290a 2020 2020  foo': 'x'}).    
+0001b950: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0001b960: 7349 6e73 7461 6e63 6528 7365 6372 6574  sInstance(secret
+0001b970: 2c20 6f70 732e 5365 6372 6574 290a 2020  , ops.Secret).  
+0001b980: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b990: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
+0001b9a0: 2c20 2773 6563 7265 743a 3334 3527 290a  , 'secret:345').
+0001b9b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001b9c0: 6572 7449 734e 6f6e 6528 7365 6372 6574  ertIsNone(secret
+0001b9d0: 2e6c 6162 656c 290a 0a20 2020 2020 2020  .label)..       
+0001b9e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b9f0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001ba00: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001ba10: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba30: 5b5b 2773 6563 7265 742d 6164 6427 2c20  [['secret-add', 
+0001ba40: 272d 2d6f 776e 6572 272c 2027 756e 6974  '--owner', 'unit
+0001ba50: 272c 2027 666f 6f3d 7827 5d5d 290a 0a20  ', 'foo=x']]).. 
+0001ba60: 2020 2064 6566 2074 6573 745f 756e 6974     def test_unit
+0001ba70: 5f61 6464 5f73 6563 7265 745f 6172 6773  _add_secret_args
+0001ba80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001ba90: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001baa0: 2c20 2773 6563 7265 742d 6164 6427 2c20  , 'secret-add', 
+0001bab0: 2765 6368 6f20 7365 6372 6574 3a34 3536  'echo secret:456
+0001bac0: 2729 0a0a 2020 2020 2020 2020 6578 7069  ')..        expi
+0001bad0: 7265 203d 2064 6174 6574 696d 652e 6461  re = datetime.da
+0001bae0: 7465 7469 6d65 2832 3032 322c 2031 322c  tetime(2022, 12,
+0001baf0: 2039 2c20 3136 2c20 3232 2c20 3029 0a20   9, 16, 22, 0). 
+0001bb00: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
+0001bb10: 7365 6c66 2e75 6e69 742e 6164 645f 7365  self.unit.add_se
+0001bb20: 6372 6574 287b 2766 6f6f 273a 2027 7727  cret({'foo': 'w'
+0001bb30: 2c20 2762 6172 273a 2027 7a27 7d2c 206c  , 'bar': 'z'}, l
+0001bb40: 6162 656c 3d27 6c32 272c 2064 6573 6372  abel='l2', descr
+0001bb50: 6970 7469 6f6e 3d27 7879 7a27 2c0a 2020  iption='xyz',.  
+0001bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb80: 2020 2020 6578 7069 7265 3d65 7870 6972      expire=expir
+0001bb90: 652c 2072 6f74 6174 653d 6f70 732e 5365  e, rotate=ops.Se
+0001bba0: 6372 6574 526f 7461 7465 2e59 4541 524c  cretRotate.YEARL
+0001bbb0: 5929 0a20 2020 2020 2020 2073 656c 662e  Y).        self.
+0001bbc0: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0001bbd0: 6574 2e69 642c 2027 7365 6372 6574 3a34  et.id, 'secret:4
+0001bbe0: 3536 2729 0a20 2020 2020 2020 2073 656c  56').        sel
+0001bbf0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0001bc00: 6372 6574 2e6c 6162 656c 2c20 276c 3227  cret.label, 'l2'
+0001bc10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001bc20: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
+0001bc30: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0001bc40: 207b 2766 6f6f 273a 2027 7727 2c20 2762   {'foo': 'w', 'b
+0001bc50: 6172 273a 2027 7a27 7d29 0a0a 2020 2020  ar': 'z'})..    
+0001bc60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001bc70: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001bc80: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001bc90: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
+0001bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcb0: 2020 205b 5b27 7365 6372 6574 2d61 6464     [['secret-add
+0001bcc0: 272c 2027 2d2d 6c61 6265 6c27 2c20 276c  ', '--label', 'l
+0001bcd0: 3227 2c20 272d 2d64 6573 6372 6970 7469  2', '--descripti
+0001bce0: 6f6e 272c 2027 7879 7a27 2c0a 2020 2020  on', 'xyz',.    
+0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd00: 2020 2020 2020 2027 2d2d 6578 7069 7265         '--expire
+0001bd10: 272c 2027 3230 3232 2d31 322d 3039 5431  ', '2022-12-09T1
+0001bd20: 363a 3232 3a30 3027 2c20 272d 2d72 6f74  6:22:00', '--rot
+0001bd30: 6174 6527 2c20 2779 6561 726c 7927 2c0a  ate', 'yearly',.
+0001bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd50: 2020 2020 2020 2020 2020 2027 2d2d 6f77             '--ow
+0001bd60: 6e65 7227 2c20 2775 6e69 7427 2c20 2766  ner', 'unit', 'f
+0001bd70: 6f6f 3d77 272c 2027 6261 723d 7a27 5d5d  oo=w', 'bar=z']]
+0001bd80: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001bd90: 756e 6974 5f61 6464 5f73 6563 7265 745f  unit_add_secret_
+0001bda0: 6572 726f 7273 2873 656c 6629 3a0a 2020  errors(self):.  
+0001bdb0: 2020 2020 2020 2320 4164 6469 7469 6f6e        # Addition
+0001bdc0: 616c 2061 6464 5f73 6563 7265 7420 7465  al add_secret te
+0001bdd0: 7374 7320 6172 6520 646f 6e65 2069 6e20  sts are done in 
+0001bde0: 5465 7374 4170 706c 6963 6174 696f 6e0a  TestApplication.
+0001bdf0: 2020 2020 2020 2020 6572 726f 7273 203d          errors =
+0001be00: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0001be10: 7b27 7879 273a 2027 6261 7227 7d2c 207b  {'xy': 'bar'}, {
+0001be20: 7d2c 2056 616c 7565 4572 726f 7229 2c0a  }, ValueError),.
+0001be30: 2020 2020 2020 2020 2020 2020 287b 2766              ({'f
+0001be40: 6f6f 273a 2027 7827 7d2c 207b 2765 7870  oo': 'x'}, {'exp
+0001be50: 6972 6527 3a20 377d 2c20 5479 7065 4572  ire': 7}, TypeEr
+0001be60: 726f 7229 2c0a 2020 2020 2020 2020 5d0a  ror),.        ].
+0001be70: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
+0001be80: 656e 742c 206b 7761 7267 732c 2065 7863  ent, kwargs, exc
+0001be90: 5f74 7970 6520 696e 2065 7272 6f72 733a  _type in errors:
+0001bea0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0001beb0: 203d 2066 2765 7870 6563 7465 6420 7b65   = f'expected {e
+0001bec0: 7863 5f74 7970 652e 5f5f 6e61 6d65 5f5f  xc_type.__name__
+0001bed0: 7d20 7768 656e 2061 6464 696e 6720 7365  } when adding se
+0001bee0: 6372 6574 2063 6f6e 7465 6e74 207b 636f  cret content {co
+0001bef0: 6e74 656e 747d 270a 2020 2020 2020 2020  ntent}'.        
+0001bf00: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0001bf10: 7365 7274 5261 6973 6573 2865 7863 5f74  sertRaises(exc_t
+0001bf20: 7970 652c 206d 7367 3d6d 7367 293a 0a20  ype, msg=msg):. 
+0001bf30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001bf40: 656c 662e 756e 6974 2e61 6464 5f73 6563  elf.unit.add_sec
+0001bf50: 7265 7428 636f 6e74 656e 742c 202a 2a6b  ret(content, **k
+0001bf60: 7761 7267 7329 0a0a 2020 2020 6465 6620  wargs)..    def 
+0001bf70: 7465 7374 5f61 6464 5f73 6563 7265 745f  test_add_secret_
+0001bf80: 6572 726f 7273 2873 656c 6629 3a0a 2020  errors(self):.  
+0001bf90: 2020 2020 2020 6572 726f 7273 203d 205b        errors = [
+0001bfa0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+0001bfb0: 6e76 616c 6964 2063 6f6e 7465 6e74 2064  nvalid content d
+0001bfc0: 6963 7420 6f72 2074 7970 6573 0a20 2020  ict or types.   
+0001bfd0: 2020 2020 2020 2020 2028 4e6f 6e65 2c20           (None, 
+0001bfe0: 7b7d 2c20 5479 7065 4572 726f 7229 2c0a  {}, TypeError),.
+0001bff0: 2020 2020 2020 2020 2020 2020 287b 7d2c              ({},
+0001c000: 207b 7d2c 2056 616c 7565 4572 726f 7229   {}, ValueError)
+0001c010: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
+0001c020: 6227 666f 6f27 2c20 2762 6172 277d 2c20  b'foo', 'bar'}, 
+0001c030: 7b7d 2c20 5479 7065 4572 726f 7229 2c0a  {}, TypeError),.
+0001c040: 2020 2020 2020 2020 2020 2020 287b 333a              ({3:
+0001c050: 2027 6261 7227 7d2c 207b 7d2c 2054 7970   'bar'}, {}, Typ
+0001c060: 6545 7272 6f72 292c 0a20 2020 2020 2020  eError),.       
+0001c070: 2020 2020 2028 7b27 666f 6f27 3a20 312c       ({'foo': 1,
+0001c080: 2027 6261 7227 3a20 327d 2c20 7b7d 2c20   'bar': 2}, {}, 
+0001c090: 5479 7065 4572 726f 7229 2c0a 2020 2020  TypeError),.    
+0001c0a0: 2020 2020 2020 2020 2320 496e 7661 6c69          # Invali
+0001c0b0: 6420 636f 6e74 656e 7420 6b65 7973 0a20  d content keys. 
+0001c0c0: 2020 2020 2020 2020 2020 2028 7b27 7879             ({'xy
+0001c0d0: 273a 2027 6261 7227 7d2c 207b 7d2c 2056  ': 'bar'}, {}, V
+0001c0e0: 616c 7565 4572 726f 7229 2c0a 2020 2020  alueError),.    
+0001c0f0: 2020 2020 2020 2020 287b 2746 4f4f 273a          ({'FOO':
+0001c100: 2027 6261 7227 7d2c 207b 7d2c 2056 616c   'bar'}, {}, Val
+0001c110: 7565 4572 726f 7229 2c0a 2020 2020 2020  ueError),.      
+0001c120: 2020 2020 2020 287b 2766 6f6f 2d27 3a20        ({'foo-': 
+0001c130: 2762 6172 277d 2c20 7b7d 2c20 5661 6c75  'bar'}, {}, Valu
+0001c140: 6545 7272 6f72 292c 0a20 2020 2020 2020  eError),.       
+0001c150: 2020 2020 2028 7b27 2d66 6f6f 273a 2027       ({'-foo': '
+0001c160: 6261 7227 7d2c 207b 7d2c 2056 616c 7565  bar'}, {}, Value
+0001c170: 4572 726f 7229 2c0a 2020 2020 2020 2020  Error),.        
+0001c180: 2020 2020 2320 496e 7661 6c69 6420 2265      # Invalid "e
+0001c190: 7870 6972 6522 2074 7970 650a 2020 2020  xpire" type.    
+0001c1a0: 2020 2020 2020 2020 287b 2766 6f6f 273a          ({'foo':
+0001c1b0: 2027 7827 7d2c 207b 2765 7870 6972 6527   'x'}, {'expire'
+0001c1c0: 3a20 377d 2c20 5479 7065 4572 726f 7229  : 7}, TypeError)
+0001c1d0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0001c1e0: 2020 2020 666f 7220 636f 6e74 656e 742c      for content,
+0001c1f0: 206b 7761 7267 732c 2065 7863 5f74 7970   kwargs, exc_typ
+0001c200: 6520 696e 2065 7272 6f72 733a 0a20 2020  e in errors:.   
+0001c210: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+0001c220: 2765 7870 6563 7465 6420 7b65 7863 5f74  'expected {exc_t
+0001c230: 7970 652e 5f5f 6e61 6d65 5f5f 7d20 7768  ype.__name__} wh
+0001c240: 656e 2061 6464 696e 6720 7365 6372 6574  en adding secret
+0001c250: 2063 6f6e 7465 6e74 207b 636f 6e74 656e   content {conten
+0001c260: 747d 270a 2020 2020 2020 2020 2020 2020  t}'.            
+0001c270: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0001c280: 5261 6973 6573 2865 7863 5f74 7970 652c  Raises(exc_type,
+0001c290: 206d 7367 3d6d 7367 293a 0a20 2020 2020   msg=msg):.     
+0001c2a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001c2b0: 6170 702e 6164 645f 7365 6372 6574 2863  app.add_secret(c
+0001c2c0: 6f6e 7465 6e74 2c20 2a2a 6b77 6172 6773  ontent, **kwargs
+0001c2d0: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
+0001c2e0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0001c2f0: 6973 6573 2865 7863 5f74 7970 652c 206d  ises(exc_type, m
+0001c300: 7367 3d6d 7367 293a 0a20 2020 2020 2020  sg=msg):.       
+0001c310: 2020 2020 2020 2020 2073 656c 662e 756e           self.un
+0001c320: 6974 2e61 6464 5f73 6563 7265 7428 636f  it.add_secret(co
+0001c330: 6e74 656e 742c 202a 2a6b 7761 7267 7329  ntent, **kwargs)
+0001c340: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0001c350: 6574 5f73 6563 7265 745f 6964 2873 656c  et_secret_id(sel
+0001c360: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+0001c370: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+0001c380: 6563 7265 742d 6765 7427 2c20 2222 2265  ecret-get', """e
+0001c390: 6368 6f20 277b 2266 6f6f 223a 2022 6722  cho '{"foo": "g"
+0001c3a0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
+0001c3b0: 7365 6372 6574 203d 2073 656c 662e 6d6f  secret = self.mo
+0001c3c0: 6465 6c2e 6765 745f 7365 6372 6574 2869  del.get_secret(i
+0001c3d0: 643d 2731 3233 2729 0a20 2020 2020 2020  d='123').       
+0001c3e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001c3f0: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
+0001c400: 6372 6574 3a31 3233 2729 0a20 2020 2020  cret:123').     
+0001c410: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001c420: 4e6f 6e65 2873 6563 7265 742e 6c61 6265  None(secret.labe
+0001c430: 6c29 0a20 2020 2020 2020 2073 656c 662e  l).        self.
+0001c440: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0001c450: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
+0001c460: 2c20 7b27 666f 6f27 3a20 2767 277d 290a  , {'foo': 'g'}).
+0001c470: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001c480: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+0001c490: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+0001c4a0: 2c20 636c 6561 723d 5472 7565 292c 0a20  , clear=True),. 
+0001c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4c0: 2020 2020 2020 2020 5b5b 2773 6563 7265          [['secre
+0001c4d0: 742d 6765 7427 2c20 2773 6563 7265 743a  t-get', 'secret:
+0001c4e0: 3132 3327 2c20 272d 2d66 6f72 6d61 743d  123', '--format=
+0001c4f0: 6a73 6f6e 275d 5d29 0a0a 2020 2020 6465  json']])..    de
+0001c500: 6620 7465 7374 5f67 6574 5f73 6563 7265  f test_get_secre
+0001c510: 745f 6c61 6265 6c28 7365 6c66 293a 0a20  t_label(self):. 
+0001c520: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001c530: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001c540: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+0001c550: 7b22 666f 6f22 3a20 2267 227d 2722 2222  {"foo": "g"}'"""
+0001c560: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
+0001c570: 7420 3d20 7365 6c66 2e6d 6f64 656c 2e67  t = self.model.g
+0001c580: 6574 5f73 6563 7265 7428 6c61 6265 6c3d  et_secret(label=
+0001c590: 276c 626c 2729 0a20 2020 2020 2020 2073  'lbl').        s
+0001c5a0: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001c5b0: 2873 6563 7265 742e 6964 290a 2020 2020  (secret.id).    
+0001c5c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c5d0: 7175 616c 2873 6563 7265 742e 6c61 6265  qual(secret.labe
+0001c5e0: 6c2c 2027 6c62 6c27 290a 2020 2020 2020  l, 'lbl').      
+0001c5f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001c600: 616c 2873 6563 7265 742e 6765 745f 636f  al(secret.get_co
+0001c610: 6e74 656e 7428 292c 207b 2766 6f6f 273a  ntent(), {'foo':
+0001c620: 2027 6727 7d29 0a0a 2020 2020 2020 2020   'g'})..        
+0001c630: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001c640: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+0001c650: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
+0001c660: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
+0001c670: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0001c680: 5b27 7365 6372 6574 2d67 6574 272c 2027  ['secret-get', '
+0001c690: 2d2d 6c61 6265 6c27 2c20 276c 626c 272c  --label', 'lbl',
+0001c6a0: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+0001c6b0: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
+0001c6c0: 745f 6765 745f 7365 6372 6574 5f69 645f  t_get_secret_id_
+0001c6d0: 616e 645f 6c61 6265 6c28 7365 6c66 293a  and_label(self):
+0001c6e0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001c6f0: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
+0001c700: 6574 2d67 6574 272c 2022 2222 6563 686f  et-get', """echo
+0001c710: 2027 7b22 666f 6f22 3a20 2268 227d 2722   '{"foo": "h"}'"
+0001c720: 2222 290a 0a20 2020 2020 2020 2073 6563  "")..        sec
+0001c730: 7265 7420 3d20 7365 6c66 2e6d 6f64 656c  ret = self.model
+0001c740: 2e67 6574 5f73 6563 7265 7428 6964 3d27  .get_secret(id='
+0001c750: 3132 3327 2c20 6c61 6265 6c3d 276c 2729  123', label='l')
+0001c760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001c770: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
+0001c780: 2e69 642c 2027 7365 6372 6574 3a31 3233  .id, 'secret:123
+0001c790: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001c7a0: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0001c7b0: 6574 2e6c 6162 656c 2c20 276c 2729 0a20  et.label, 'l'). 
+0001c7c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c7d0: 7274 4571 7561 6c28 7365 6372 6574 2e67  rtEqual(secret.g
+0001c7e0: 6574 5f63 6f6e 7465 6e74 2829 2c20 7b27  et_content(), {'
+0001c7f0: 666f 6f27 3a20 2768 277d 290a 0a20 2020  foo': 'h'})..   
+0001c800: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001c810: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+0001c820: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+0001c830: 6561 723d 5472 7565 292c 0a20 2020 2020  ear=True),.     
+0001c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c850: 2020 2020 5b5b 2773 6563 7265 742d 6765      [['secret-ge
+0001c860: 7427 2c20 2773 6563 7265 743a 3132 3327  t', 'secret:123'
+0001c870: 2c20 272d 2d6c 6162 656c 272c 2027 6c27  , '--label', 'l'
+0001c880: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+0001c890: 275d 5d29 0a0a 2020 2020 6465 6620 7465  ']])..    def te
+0001c8a0: 7374 5f67 6574 5f73 6563 7265 745f 6e6f  st_get_secret_no
+0001c8b0: 5f61 7267 7328 7365 6c66 293a 0a20 2020  _args(self):.   
+0001c8c0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0001c8d0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0001c8e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0001c8f0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
+0001c900: 6574 5f73 6563 7265 7428 290a 0a20 2020  et_secret()..   
+0001c910: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
+0001c920: 6372 6574 5f6e 6f74 5f66 6f75 6e64 2873  cret_not_found(s
+0001c930: 656c 6629 3a0a 2020 2020 2020 2020 7363  elf):.        sc
+0001c940: 7269 7074 203d 2022 2222 6563 686f 2027  ript = """echo '
+0001c950: 4552 524f 5220 7365 6372 6574 2022 3132  ERROR secret "12
+0001c960: 3322 206e 6f74 2066 6f75 6e64 2720 3e26  3" not found' >&
+0001c970: 323b 2065 7869 7420 3122 2222 0a20 2020  2; exit 1""".   
+0001c980: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001c990: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
+0001c9a0: 6574 272c 2073 6372 6970 7429 0a0a 2020  et', script)..  
+0001c9b0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0001c9c0: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+0001c9d0: 2e53 6563 7265 744e 6f74 466f 756e 6445  .SecretNotFoundE
+0001c9e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0001c9f0: 2020 2073 656c 662e 6d6f 6465 6c2e 6765     self.model.ge
+0001ca00: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
+0001ca10: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+0001ca20: 5f67 6574 5f73 6563 7265 745f 6f74 6865  _get_secret_othe
+0001ca30: 725f 6572 726f 7228 7365 6c66 293a 0a20  r_error(self):. 
+0001ca40: 2020 2020 2020 2073 6372 6970 7420 3d20         script = 
+0001ca50: 2222 2265 6368 6f20 2745 5252 4f52 206f  """echo 'ERROR o
+0001ca60: 7468 6572 2065 7272 6f72 2720 3e26 323b  ther error' >&2;
+0001ca70: 2065 7869 7420 3122 2222 0a20 2020 2020   exit 1""".     
+0001ca80: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001ca90: 656c 662c 2027 7365 6372 6574 2d67 6574  elf, 'secret-get
+0001caa0: 272c 2073 6372 6970 7429 0a0a 2020 2020  ', script)..    
+0001cab0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0001cac0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0001cad0: 6f64 656c 4572 726f 7229 2061 7320 636d  odelError) as cm
+0001cae0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001caf0: 6c66 2e6d 6f64 656c 2e67 6574 5f73 6563  lf.model.get_sec
+0001cb00: 7265 7428 6964 3d27 3132 3327 290a 2020  ret(id='123').  
+0001cb10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001cb20: 744e 6f74 4973 496e 7374 616e 6365 2863  tNotIsInstance(c
+0001cb30: 6d2e 6578 6365 7074 696f 6e2c 206f 7073  m.exception, ops
+0001cb40: 2e53 6563 7265 744e 6f74 466f 756e 6445  .SecretNotFoundE
+0001cb50: 7272 6f72 290a 0a0a 636c 6173 7320 5465  rror)...class Te
+0001cb60: 7374 5365 6372 6574 496e 666f 2875 6e69  stSecretInfo(uni
+0001cb70: 7474 6573 742e 5465 7374 4361 7365 293a  ttest.TestCase):
+0001cb80: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
+0001cb90: 6974 2873 656c 6629 3a0a 2020 2020 2020  it(self):.      
+0001cba0: 2020 696e 666f 203d 206f 7073 2e53 6563    info = ops.Sec
+0001cbb0: 7265 7449 6e66 6f28 0a20 2020 2020 2020  retInfo(.       
+0001cbc0: 2020 2020 2069 643d 2733 272c 0a20 2020       id='3',.   
+0001cbd0: 2020 2020 2020 2020 206c 6162 656c 3d27           label='
+0001cbe0: 6c62 6c27 2c0a 2020 2020 2020 2020 2020  lbl',.          
+0001cbf0: 2020 7265 7669 7369 6f6e 3d37 2c0a 2020    revision=7,.  
+0001cc00: 2020 2020 2020 2020 2020 6578 7069 7265            expire
+0001cc10: 733d 6461 7465 7469 6d65 2e64 6174 6574  s=datetime.datet
+0001cc20: 696d 6528 3230 3232 2c20 3132 2c20 392c  ime(2022, 12, 9,
+0001cc30: 2031 342c 2031 302c 2030 292c 0a20 2020   14, 10, 0),.   
+0001cc40: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
+0001cc50: 6e3d 6f70 732e 5365 6372 6574 526f 7461  n=ops.SecretRota
+0001cc60: 7465 2e4d 4f4e 5448 4c59 2c0a 2020 2020  te.MONTHLY,.    
+0001cc70: 2020 2020 2020 2020 726f 7461 7465 733d          rotates=
+0001cc80: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
+0001cc90: 6528 3230 3233 2c20 312c 2039 2c20 3134  e(2023, 1, 9, 14
+0001cca0: 2c20 3130 2c20 3029 2c0a 2020 2020 2020  , 10, 0),.      
+0001ccb0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001ccc0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001ccd0: 6f2e 6964 2c20 2773 6563 7265 743a 3327  o.id, 'secret:3'
+0001cce0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ccf0: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+0001cd00: 6c61 6265 6c2c 2027 6c62 6c27 290a 2020  label, 'lbl').  
+0001cd10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001cd20: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
+0001cd30: 7369 6f6e 2c20 3729 0a20 2020 2020 2020  sion, 7).       
+0001cd40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001cd50: 6c28 696e 666f 2e65 7870 6972 6573 2c20  l(info.expires, 
+0001cd60: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
+0001cd70: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
+0001cd80: 342c 2031 302c 2030 2929 0a20 2020 2020  4, 10, 0)).     
+0001cd90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001cda0: 7561 6c28 696e 666f 2e72 6f74 6174 696f  ual(info.rotatio
+0001cdb0: 6e2c 206f 7073 2e53 6563 7265 7452 6f74  n, ops.SecretRot
+0001cdc0: 6174 652e 4d4f 4e54 484c 5929 0a20 2020  ate.MONTHLY).   
+0001cdd0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001cde0: 4571 7561 6c28 696e 666f 2e72 6f74 6174  Equal(info.rotat
+0001cdf0: 6573 2c20 6461 7465 7469 6d65 2e64 6174  es, datetime.dat
+0001ce00: 6574 696d 6528 3230 3233 2c20 312c 2039  etime(2023, 1, 9
+0001ce10: 2c20 3134 2c20 3130 2c20 3029 290a 0a20  , 14, 10, 0)).. 
+0001ce20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001ce30: 7274 5472 7565 2872 6570 7228 696e 666f  rtTrue(repr(info
+0001ce40: 292e 7374 6172 7473 7769 7468 2827 5365  ).startswith('Se
+0001ce50: 6372 6574 496e 666f 2827 2929 0a20 2020  cretInfo(')).   
+0001ce60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ce70: 5472 7565 2872 6570 7228 696e 666f 292e  True(repr(info).
+0001ce80: 656e 6473 7769 7468 2827 2927 2929 0a0a  endswith(')'))..
+0001ce90: 2020 2020 6465 6620 7465 7374 5f66 726f      def test_fro
+0001cea0: 6d5f 6469 6374 2873 656c 6629 3a0a 2020  m_dict(self):.  
+0001ceb0: 2020 2020 2020 7574 6320 3d20 6461 7465        utc = date
+0001cec0: 7469 6d65 2e74 696d 657a 6f6e 652e 7574  time.timezone.ut
+0001ced0: 630a 2020 2020 2020 2020 696e 666f 203d  c.        info =
+0001cee0: 206f 7073 2e53 6563 7265 7449 6e66 6f2e   ops.SecretInfo.
+0001cef0: 6672 6f6d 5f64 6963 7428 2773 6563 7265  from_dict('secre
+0001cf00: 743a 3427 2c20 7b0a 2020 2020 2020 2020  t:4', {.        
+0001cf10: 2020 2020 276c 6162 656c 273a 2027 6672      'label': 'fr
+0001cf20: 6f6d 6469 6374 272c 0a20 2020 2020 2020  omdict',.       
+0001cf30: 2020 2020 2027 7265 7669 7369 6f6e 273a       'revision':
+0001cf40: 2038 2c0a 2020 2020 2020 2020 2020 2020   8,.            
+0001cf50: 2765 7870 6972 6573 273a 2027 3230 3232  'expires': '2022
+0001cf60: 2d31 322d 3039 5431 343a 3130 3a30 305a  -12-09T14:10:00Z
+0001cf70: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001cf80: 726f 7461 7469 6f6e 273a 2027 7965 6172  rotation': 'year
+0001cf90: 6c79 272c 0a20 2020 2020 2020 2020 2020  ly',.           
+0001cfa0: 2027 726f 7461 7465 7327 3a20 2732 3032   'rotates': '202
+0001cfb0: 332d 3031 2d30 3954 3134 3a31 303a 3030  3-01-09T14:10:00
+0001cfc0: 5a27 2c0a 2020 2020 2020 2020 7d29 0a20  Z',.        }). 
+0001cfd0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001cfe0: 7274 4571 7561 6c28 696e 666f 2e69 642c  rtEqual(info.id,
+0001cff0: 2027 7365 6372 6574 3a34 2729 0a20 2020   'secret:4').   
+0001d000: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001d010: 4571 7561 6c28 696e 666f 2e6c 6162 656c  Equal(info.label
+0001d020: 2c20 2766 726f 6d64 6963 7427 290a 2020  , 'fromdict').  
+0001d030: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d040: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
+0001d050: 7369 6f6e 2c20 3829 0a20 2020 2020 2020  sion, 8).       
+0001d060: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d070: 6c28 696e 666f 2e65 7870 6972 6573 2c20  l(info.expires, 
+0001d080: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
+0001d090: 6528 3230 3232 2c20 3132 2c20 392c 2031  e(2022, 12, 9, 1
+0001d0a0: 342c 2031 302c 2030 2c20 747a 696e 666f  4, 10, 0, tzinfo
+0001d0b0: 3d75 7463 2929 0a20 2020 2020 2020 2073  =utc)).        s
+0001d0c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d0d0: 696e 666f 2e72 6f74 6174 696f 6e2c 206f  info.rotation, o
+0001d0e0: 7073 2e53 6563 7265 7452 6f74 6174 652e  ps.SecretRotate.
+0001d0f0: 5945 4152 4c59 290a 2020 2020 2020 2020  YEARLY).        
+0001d100: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d110: 2869 6e66 6f2e 726f 7461 7465 732c 2064  (info.rotates, d
+0001d120: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
+0001d130: 2832 3032 332c 2031 2c20 392c 2031 342c  (2023, 1, 9, 14,
+0001d140: 2031 302c 2030 2c20 747a 696e 666f 3d75   10, 0, tzinfo=u
+0001d150: 7463 2929 0a0a 2020 2020 2020 2020 696e  tc))..        in
+0001d160: 666f 203d 206f 7073 2e53 6563 7265 7449  fo = ops.SecretI
+0001d170: 6e66 6f2e 6672 6f6d 5f64 6963 7428 2773  nfo.from_dict('s
+0001d180: 6563 7265 743a 3427 2c20 7b0a 2020 2020  ecret:4', {.    
+0001d190: 2020 2020 2020 2020 276c 6162 656c 273a          'label':
+0001d1a0: 2027 6672 6f6d 6469 6374 272c 0a20 2020   'fromdict',.   
+0001d1b0: 2020 2020 2020 2020 2027 7265 7669 7369           'revisi
+0001d1c0: 6f6e 273a 2038 2c0a 2020 2020 2020 2020  on': 8,.        
+0001d1d0: 2020 2020 2772 6f74 6174 696f 6e27 3a20      'rotation': 
+0001d1e0: 2762 6164 7661 6c75 6527 2c0a 2020 2020  'badvalue',.    
+0001d1f0: 2020 2020 7d29 0a20 2020 2020 2020 2073      }).        s
+0001d200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d210: 696e 666f 2e69 642c 2027 7365 6372 6574  info.id, 'secret
+0001d220: 3a34 2729 0a20 2020 2020 2020 2073 656c  :4').        sel
+0001d230: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
+0001d240: 666f 2e6c 6162 656c 2c20 2766 726f 6d64  fo.label, 'fromd
+0001d250: 6963 7427 290a 2020 2020 2020 2020 7365  ict').        se
+0001d260: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001d270: 6e66 6f2e 7265 7669 7369 6f6e 2c20 3829  nfo.revision, 8)
+0001d280: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d290: 7365 7274 4973 4e6f 6e65 2869 6e66 6f2e  sertIsNone(info.
+0001d2a0: 6578 7069 7265 7329 0a20 2020 2020 2020  expires).       
+0001d2b0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0001d2c0: 6e65 2869 6e66 6f2e 726f 7461 7469 6f6e  ne(info.rotation
+0001d2d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001d2e0: 7373 6572 7449 734e 6f6e 6528 696e 666f  ssertIsNone(info
+0001d2f0: 2e72 6f74 6174 6573 290a 0a20 2020 2020  .rotates)..     
+0001d300: 2020 2069 6e66 6f20 3d20 6f70 732e 5365     info = ops.Se
+0001d310: 6372 6574 496e 666f 2e66 726f 6d5f 6469  cretInfo.from_di
+0001d320: 6374 2827 3527 2c20 7b27 7265 7669 7369  ct('5', {'revisi
+0001d330: 6f6e 273a 2039 7d29 0a20 2020 2020 2020  on': 9}).       
+0001d340: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d350: 6c28 696e 666f 2e69 642c 2027 7365 6372  l(info.id, 'secr
+0001d360: 6574 3a35 2729 0a20 2020 2020 2020 2073  et:5').        s
+0001d370: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d380: 696e 666f 2e72 6576 6973 696f 6e2c 2039  info.revision, 9
+0001d390: 290a 0a0a 636c 6173 7320 5465 7374 5365  )...class TestSe
+0001d3a0: 6372 6574 436c 6173 7328 756e 6974 7465  cretClass(unitte
+0001d3b0: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
+0001d3c0: 2020 6d61 7844 6966 6620 3d20 3634 202a    maxDiff = 64 *
+0001d3d0: 2031 3032 340a 0a20 2020 2064 6566 2073   1024..    def s
+0001d3e0: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
+0001d3f0: 2020 2020 7365 6c66 2e6d 6f64 656c 203d      self.model =
+0001d400: 206f 7073 2e4d 6f64 656c 286f 7073 2e43   ops.Model(ops.C
+0001d410: 6861 726d 4d65 7461 2829 2c20 5f4d 6f64  harmMeta(), _Mod
+0001d420: 656c 4261 636b 656e 6428 276d 7961 7070  elBackend('myapp
+0001d430: 2f30 2729 290a 0a20 2020 2064 6566 206d  /0'))..    def m
+0001d440: 616b 655f 7365 6372 6574 2873 656c 662c  ake_secret(self,
+0001d450: 2069 643d 4e6f 6e65 2c20 6c61 6265 6c3d   id=None, label=
+0001d460: 4e6f 6e65 2c20 636f 6e74 656e 743d 4e6f  None, content=No
+0001d470: 6e65 293a 0a20 2020 2020 2020 2072 6574  ne):.        ret
+0001d480: 7572 6e20 6f70 732e 5365 6372 6574 2873  urn ops.Secret(s
+0001d490: 656c 662e 6d6f 6465 6c2e 5f62 6163 6b65  elf.model._backe
+0001d4a0: 6e64 2c20 6964 3d69 642c 206c 6162 656c  nd, id=id, label
+0001d4b0: 3d6c 6162 656c 2c20 636f 6e74 656e 743d  =label, content=
+0001d4c0: 636f 6e74 656e 7429 0a0a 2020 2020 6465  content)..    de
+0001d4d0: 6620 7465 7374 5f69 645f 616e 645f 6c61  f test_id_and_la
+0001d4e0: 6265 6c28 7365 6c66 293a 0a20 2020 2020  bel(self):.     
+0001d4f0: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001d500: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001d510: 2720 6162 6320 272c 206c 6162 656c 3d27  ' abc ', label='
+0001d520: 6c62 6c27 290a 2020 2020 2020 2020 7365  lbl').        se
+0001d530: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001d540: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
+0001d550: 743a 6162 6327 290a 2020 2020 2020 2020  t:abc').        
+0001d560: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d570: 2873 6563 7265 742e 6c61 6265 6c2c 2027  (secret.label, '
+0001d580: 6c62 6c27 290a 0a20 2020 2020 2020 2073  lbl')..        s
+0001d590: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
+0001d5a0: 655f 7365 6372 6574 2869 643d 2778 2729  e_secret(id='x')
+0001d5b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d5c0: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
+0001d5d0: 2e69 642c 2027 7365 6372 6574 3a78 2729  .id, 'secret:x')
+0001d5e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d5f0: 7365 7274 4973 4e6f 6e65 2873 6563 7265  sertIsNone(secre
+0001d600: 742e 6c61 6265 6c29 0a0a 2020 2020 2020  t.label)..      
+0001d610: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
+0001d620: 6d61 6b65 5f73 6563 7265 7428 6c61 6265  make_secret(labe
+0001d630: 6c3d 2779 2729 0a20 2020 2020 2020 2073  l='y').        s
+0001d640: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001d650: 2873 6563 7265 742e 6964 290a 2020 2020  (secret.id).    
+0001d660: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d670: 7175 616c 2873 6563 7265 742e 6c61 6265  qual(secret.labe
+0001d680: 6c2c 2027 7927 290a 0a20 2020 2064 6566  l, 'y')..    def
+0001d690: 2074 6573 745f 6765 745f 636f 6e74 656e   test_get_conten
+0001d6a0: 745f 6361 6368 6564 2873 656c 6629 3a0a  t_cached(self):.
+0001d6b0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+0001d6c0: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
+0001d6d0: 742d 6765 7427 2c20 2222 2265 7869 7420  t-get', """exit 
+0001d6e0: 3122 2222 290a 0a20 2020 2020 2020 2073  1""")..        s
+0001d6f0: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
+0001d700: 655f 7365 6372 6574 2869 643d 2778 272c  e_secret(id='x',
+0001d710: 206c 6162 656c 3d27 7927 2c20 636f 6e74   label='y', cont
+0001d720: 656e 743d 7b27 666f 6f27 3a20 2762 6172  ent={'foo': 'bar
+0001d730: 277d 290a 2020 2020 2020 2020 636f 6e74  '}).        cont
+0001d740: 656e 7420 3d20 7365 6372 6574 2e67 6574  ent = secret.get
+0001d750: 5f63 6f6e 7465 6e74 2829 2020 2320 7769  _content()  # wi
+0001d760: 6c6c 2075 7365 2063 6163 6865 6420 636f  ll use cached co
+0001d770: 6e74 656e 742c 206e 6f74 2072 756e 2073  ntent, not run s
+0001d780: 6563 7265 742d 6765 740a 2020 2020 2020  ecret-get.      
+0001d790: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001d7a0: 616c 2863 6f6e 7465 6e74 2c20 7b27 666f  al(content, {'fo
+0001d7b0: 6f27 3a20 2762 6172 277d 290a 0a20 2020  o': 'bar'})..   
+0001d7c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001d7d0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+0001d7e0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+0001d7f0: 6561 723d 5472 7565 292c 205b 5d29 0a0a  ear=True), [])..
+0001d800: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0001d810: 5f63 6f6e 7465 6e74 5f72 6566 7265 7368  _content_refresh
+0001d820: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001d830: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001d840: 2c20 2773 6563 7265 742d 6765 7427 2c20  , 'secret-get', 
+0001d850: 2222 2265 6368 6f20 277b 2266 6f6f 223a  """echo '{"foo":
+0001d860: 2022 7265 6672 6573 6865 6422 7d27 2222   "refreshed"}'""
+0001d870: 2229 0a0a 2020 2020 2020 2020 7365 6372  ")..        secr
+0001d880: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
+0001d890: 6563 7265 7428 6964 3d27 7927 2c20 636f  ecret(id='y', co
+0001d8a0: 6e74 656e 743d 7b27 666f 6f27 3a20 2762  ntent={'foo': 'b
+0001d8b0: 6172 277d 290a 2020 2020 2020 2020 636f  ar'}).        co
+0001d8c0: 6e74 656e 7420 3d20 7365 6372 6574 2e67  ntent = secret.g
+0001d8d0: 6574 5f63 6f6e 7465 6e74 2872 6566 7265  et_content(refre
+0001d8e0: 7368 3d54 7275 6529 0a20 2020 2020 2020  sh=True).       
+0001d8f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d900: 6c28 636f 6e74 656e 742c 207b 2766 6f6f  l(content, {'foo
+0001d910: 273a 2027 7265 6672 6573 6865 6427 7d29  ': 'refreshed'})
+0001d920: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001d930: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+0001d940: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001d950: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
+0001d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d970: 2020 2020 2020 2020 205b 5b27 7365 6372           [['secr
+0001d980: 6574 2d67 6574 272c 2027 7365 6372 6574  et-get', 'secret
+0001d990: 3a79 272c 2027 2d2d 7265 6672 6573 6827  :y', '--refresh'
+0001d9a0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+0001d9b0: 275d 5d29 0a0a 2020 2020 6465 6620 7465  ']])..    def te
+0001d9c0: 7374 5f67 6574 5f63 6f6e 7465 6e74 5f75  st_get_content_u
+0001d9d0: 6e63 6163 6865 6428 7365 6c66 293a 0a20  ncached(self):. 
+0001d9e0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001d9f0: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001da00: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+0001da10: 7b22 666f 6f22 3a20 226e 6f74 6361 6368  {"foo": "notcach
+0001da20: 6564 227d 2722 2222 290a 0a20 2020 2020  ed"}'""")..     
+0001da30: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001da40: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001da50: 277a 2729 0a20 2020 2020 2020 2063 6f6e  'z').        con
+0001da60: 7465 6e74 203d 2073 6563 7265 742e 6765  tent = secret.ge
+0001da70: 745f 636f 6e74 656e 7428 290a 2020 2020  t_content().    
+0001da80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001da90: 7175 616c 2863 6f6e 7465 6e74 2c20 7b27  qual(content, {'
+0001daa0: 666f 6f27 3a20 276e 6f74 6361 6368 6564  foo': 'notcached
+0001dab0: 277d 290a 0a20 2020 2020 2020 2073 656c  '})..        sel
+0001dac0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+0001dad0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+0001dae0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+0001daf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001db00: 2020 2020 2020 2020 2020 2020 5b5b 2773              [['s
+0001db10: 6563 7265 742d 6765 7427 2c20 2773 6563  ecret-get', 'sec
+0001db20: 7265 743a 7a27 2c20 272d 2d66 6f72 6d61  ret:z', '--forma
+0001db30: 743d 6a73 6f6e 275d 5d29 0a0a 2020 2020  t=json']])..    
+0001db40: 6465 6620 7465 7374 5f70 6565 6b5f 636f  def test_peek_co
+0001db50: 6e74 656e 7428 7365 6c66 293a 0a20 2020  ntent(self):.   
+0001db60: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001db70: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
+0001db80: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
+0001db90: 666f 6f22 3a20 2270 6565 6b65 6422 7d27  foo": "peeked"}'
+0001dba0: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
+0001dbb0: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
+0001dbc0: 5f73 6563 7265 7428 6964 3d27 6127 2c20  _secret(id='a', 
+0001dbd0: 6c61 6265 6c3d 2762 2729 0a20 2020 2020  label='b').     
+0001dbe0: 2020 2063 6f6e 7465 6e74 203d 2073 6563     content = sec
+0001dbf0: 7265 742e 7065 656b 5f63 6f6e 7465 6e74  ret.peek_content
+0001dc00: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001dc10: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
+0001dc20: 656e 742c 207b 2766 6f6f 273a 2027 7065  ent, {'foo': 'pe
+0001dc30: 656b 6564 277d 290a 0a20 2020 2020 2020  eked'})..       
+0001dc40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001dc50: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001dc60: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001dc70: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+0001dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc90: 5b5b 2773 6563 7265 742d 6765 7427 2c20  [['secret-get', 
+0001dca0: 2773 6563 7265 743a 6127 2c20 272d 2d6c  'secret:a', '--l
+0001dcb0: 6162 656c 272c 2027 6227 2c20 272d 2d70  abel', 'b', '--p
+0001dcc0: 6565 6b27 2c20 272d 2d66 6f72 6d61 743d  eek', '--format=
+0001dcd0: 6a73 6f6e 275d 5d29 0a0a 2020 2020 6465  json']])..    de
+0001dce0: 6620 7465 7374 5f67 6574 5f69 6e66 6f28  f test_get_info(
+0001dcf0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001dd00: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001dd10: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
+0001dd20: 7427 2c20 2222 2265 6368 6f20 277b 2278  t', """echo '{"x
+0001dd30: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
+0001dd40: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
+0001dd50: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
+0001dd60: 2320 5365 6372 6574 2077 6974 6820 4944  # Secret with ID
+0001dd70: 206f 6e6c 790a 2020 2020 2020 2020 7365   only.        se
+0001dd80: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
+0001dd90: 5f73 6563 7265 7428 6964 3d27 7827 290a  _secret(id='x').
+0001dda0: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
+0001ddb0: 6563 7265 742e 6765 745f 696e 666f 2829  ecret.get_info()
+0001ddc0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ddd0: 7365 7274 4571 7561 6c28 696e 666f 2e69  sertEqual(info.i
+0001dde0: 642c 2027 7365 6372 6574 3a78 2729 0a20  d, 'secret:x'). 
+0001ddf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001de00: 7274 4571 7561 6c28 696e 666f 2e6c 6162  rtEqual(info.lab
+0001de10: 656c 2c20 2779 2729 0a20 2020 2020 2020  el, 'y').       
+0001de20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001de30: 6c28 696e 666f 2e72 6576 6973 696f 6e2c  l(info.revision,
+0001de40: 2037 290a 0a20 2020 2020 2020 2023 2053   7)..        # S
+0001de50: 6563 7265 7420 7769 7468 206c 6162 656c  ecret with label
+0001de60: 206f 6e6c 790a 2020 2020 2020 2020 7365   only.        se
+0001de70: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
+0001de80: 5f73 6563 7265 7428 6c61 6265 6c3d 2779  _secret(label='y
+0001de90: 2729 0a20 2020 2020 2020 2069 6e66 6f20  ').        info 
+0001dea0: 3d20 7365 6372 6574 2e67 6574 5f69 6e66  = secret.get_inf
+0001deb0: 6f28 290a 2020 2020 2020 2020 7365 6c66  o().        self
+0001dec0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001ded0: 6f2e 6964 2c20 2773 6563 7265 743a 7827  o.id, 'secret:x'
+0001dee0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001def0: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+0001df00: 6c61 6265 6c2c 2027 7927 290a 2020 2020  label, 'y').    
+0001df10: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001df20: 7175 616c 2869 6e66 6f2e 7265 7669 7369  qual(info.revisi
+0001df30: 6f6e 2c20 3729 0a0a 2020 2020 2020 2020  on, 7)..        
+0001df40: 2320 5365 6372 6574 2077 6974 6820 4944  # Secret with ID
+0001df50: 2061 6e64 206c 6162 656c 0a20 2020 2020   and label.     
+0001df60: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001df70: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001df80: 2778 272c 206c 6162 656c 3d27 7927 290a  'x', label='y').
+0001df90: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
+0001dfa0: 6563 7265 742e 6765 745f 696e 666f 2829  ecret.get_info()
+0001dfb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001dfc0: 7365 7274 4571 7561 6c28 696e 666f 2e69  sertEqual(info.i
+0001dfd0: 642c 2027 7365 6372 6574 3a78 2729 0a20  d, 'secret:x'). 
+0001dfe0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001dff0: 7274 4571 7561 6c28 696e 666f 2e6c 6162  rtEqual(info.lab
+0001e000: 656c 2c20 2779 2729 0a20 2020 2020 2020  el, 'y').       
+0001e010: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001e020: 6c28 696e 666f 2e72 6576 6973 696f 6e2c  l(info.revision,
+0001e030: 2037 290a 0a20 2020 2020 2020 2073 656c   7)..        sel
+0001e040: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+0001e050: 2020 2020 2020 2020 2020 2066 616b 655f             fake_
+0001e060: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+0001e070: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
+0001e080: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+0001e090: 2020 2020 2020 2020 2020 2020 2020 5b27                ['
+0001e0a0: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
+0001e0b0: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
+0001e0c0: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+0001e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0e0: 5b27 7365 6372 6574 2d69 6e66 6f2d 6765  ['secret-info-ge
+0001e0f0: 7427 2c20 272d 2d6c 6162 656c 272c 2027  t', '--label', '
+0001e100: 7927 2c20 272d 2d66 6f72 6d61 743d 6a73  y', '--format=js
+0001e110: 6f6e 275d 2c0a 2020 2020 2020 2020 2020  on'],.          
+0001e120: 2020 2020 2020 5b27 7365 6372 6574 2d69        ['secret-i
+0001e130: 6e66 6f2d 6765 7427 2c20 2773 6563 7265  nfo-get', 'secre
+0001e140: 743a 7827 2c20 272d 2d66 6f72 6d61 743d  t:x', '--format=
+0001e150: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
+0001e160: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0001e170: 7465 7374 5f73 6574 5f63 6f6e 7465 6e74  test_set_content
+0001e180: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001e190: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001e1a0: 2c20 2773 6563 7265 742d 7365 7427 2c20  , 'secret-set', 
+0001e1b0: 2222 2265 7869 7420 3022 2222 290a 2020  """exit 0""").  
+0001e1c0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001e1d0: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001e1e0: 696e 666f 2d67 6574 272c 2022 2222 6563  info-get', """ec
+0001e1f0: 686f 2027 7b22 7a22 3a20 7b22 6c61 6265  ho '{"z": {"labe
+0001e200: 6c22 3a20 2279 222c 2022 7265 7669 7369  l": "y", "revisi
+0001e210: 6f6e 223a 2037 7d7d 2722 2222 290a 0a20  on": 7}}'""").. 
+0001e220: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
+0001e230: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
+0001e240: 2869 643d 2778 2729 0a20 2020 2020 2020  (id='x').       
+0001e250: 2073 6563 7265 742e 7365 745f 636f 6e74   secret.set_cont
+0001e260: 656e 7428 7b27 666f 6f27 3a20 2762 6172  ent({'foo': 'bar
+0001e270: 277d 290a 0a20 2020 2020 2020 2023 2049  '})..        # I
+0001e280: 6620 7365 6372 6574 2064 6f65 736e 2774  f secret doesn't
+0001e290: 2068 6176 6520 616e 2049 442c 2077 6527   have an ID, we'
+0001e2a0: 6c6c 2072 756e 2073 6563 7265 742d 696e  ll run secret-in
+0001e2b0: 666f 2d67 6574 2074 6f20 6665 7463 6820  fo-get to fetch 
+0001e2c0: 6974 0a20 2020 2020 2020 2073 6563 7265  it.        secre
+0001e2d0: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
+0001e2e0: 6372 6574 286c 6162 656c 3d27 7927 290a  cret(label='y').
+0001e2f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001e300: 6572 7449 734e 6f6e 6528 7365 6372 6574  ertIsNone(secret
+0001e310: 2e69 6429 0a20 2020 2020 2020 2073 6563  .id).        sec
+0001e320: 7265 742e 7365 745f 636f 6e74 656e 7428  ret.set_content(
+0001e330: 7b27 6261 7227 3a20 2766 6f6f 277d 290a  {'bar': 'foo'}).
+0001e340: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001e350: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0001e360: 6964 2c20 2773 6563 7265 743a 7a27 290a  id, 'secret:z').
+0001e370: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001e380: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001e390: 5661 6c75 6545 7272 6f72 293a 0a20 2020  ValueError):.   
+0001e3a0: 2020 2020 2020 2020 2073 6563 7265 742e           secret.
+0001e3b0: 7365 745f 636f 6e74 656e 7428 7b27 7327  set_content({'s'
+0001e3c0: 3a20 2774 277d 2920 2023 2065 6e73 7572  : 't'})  # ensur
+0001e3d0: 6520 6974 2076 616c 6964 6174 6573 2063  e it validates c
+0001e3e0: 6f6e 7465 6e74 2028 6b65 7920 746f 6f20  ontent (key too 
+0001e3f0: 7368 6f72 7429 0a0a 2020 2020 2020 2020  short)..        
+0001e400: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001e410: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+0001e420: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
+0001e430: 7275 6529 2c20 5b0a 2020 2020 2020 2020  rue), [.        
+0001e440: 2020 2020 5b27 7365 6372 6574 2d73 6574      ['secret-set
+0001e450: 272c 2027 7365 6372 6574 3a78 272c 2027  ', 'secret:x', '
+0001e460: 666f 6f3d 6261 7227 5d2c 0a20 2020 2020  foo=bar'],.     
+0001e470: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001e480: 696e 666f 2d67 6574 272c 2027 2d2d 6c61  info-get', '--la
+0001e490: 6265 6c27 2c20 2779 272c 2027 2d2d 666f  bel', 'y', '--fo
+0001e4a0: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+0001e4b0: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001e4c0: 742d 7365 7427 2c20 2773 6563 7265 743a  t-set', 'secret:
+0001e4d0: 7a27 2c20 2762 6172 3d66 6f6f 275d 2c0a  z', 'bar=foo'],.
+0001e4e0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0001e4f0: 6465 6620 7465 7374 5f73 6574 5f69 6e66  def test_set_inf
+0001e500: 6f28 7365 6c66 293a 0a20 2020 2020 2020  o(self):.       
+0001e510: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001e520: 662c 2027 7365 6372 6574 2d73 6574 272c  f, 'secret-set',
+0001e530: 2022 2222 6578 6974 2030 2222 2229 0a20   """exit 0"""). 
+0001e540: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001e550: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001e560: 2d69 6e66 6f2d 6765 7427 2c20 2222 2265  -info-get', """e
+0001e570: 6368 6f20 277b 227a 223a 207b 226c 6162  cho '{"z": {"lab
+0001e580: 656c 223a 2022 7922 2c20 2272 6576 6973  el": "y", "revis
+0001e590: 696f 6e22 3a20 377d 7d27 2222 2229 0a0a  ion": 7}}'""")..
+0001e5a0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001e5b0: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001e5c0: 7428 6964 3d27 7827 290a 2020 2020 2020  t(id='x').      
+0001e5d0: 2020 6578 7069 7265 203d 2064 6174 6574    expire = datet
+0001e5e0: 696d 652e 6461 7465 7469 6d65 2832 3032  ime.datetime(202
+0001e5f0: 322c 2031 322c 2039 2c20 3136 2c20 3539  2, 12, 9, 16, 59
+0001e600: 2c20 3029 0a20 2020 2020 2020 2073 6563  , 0).        sec
+0001e610: 7265 742e 7365 745f 696e 666f 280a 2020  ret.set_info(.  
+0001e620: 2020 2020 2020 2020 2020 6c61 6265 6c3d            label=
+0001e630: 276c 6162 272c 0a20 2020 2020 2020 2020  'lab',.         
+0001e640: 2020 2064 6573 6372 6970 7469 6f6e 3d27     description='
+0001e650: 6465 7363 272c 0a20 2020 2020 2020 2020  desc',.         
+0001e660: 2020 2065 7870 6972 653d 6578 7069 7265     expire=expire
+0001e670: 2c0a 2020 2020 2020 2020 2020 2020 726f  ,.            ro
+0001e680: 7461 7465 3d6f 7073 2e53 6563 7265 7452  tate=ops.SecretR
+0001e690: 6f74 6174 652e 4d4f 4e54 484c 592c 0a20  otate.MONTHLY,. 
+0001e6a0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001e6b0: 2020 2320 4966 2073 6563 7265 7420 646f    # If secret do
+0001e6c0: 6573 6e27 7420 6861 7665 2061 6e20 4944  esn't have an ID
+0001e6d0: 2c20 7765 276c 6c20 7275 6e20 7365 6372  , we'll run secr
+0001e6e0: 6574 2d69 6e66 6f2d 6765 7420 746f 2066  et-info-get to f
+0001e6f0: 6574 6368 2069 740a 2020 2020 2020 2020  etch it.        
+0001e700: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
+0001e710: 6b65 5f73 6563 7265 7428 6c61 6265 6c3d  ke_secret(label=
+0001e720: 2779 2729 0a20 2020 2020 2020 2073 656c  'y').        sel
+0001e730: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
+0001e740: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
+0001e750: 2020 7365 6372 6574 2e73 6574 5f69 6e66    secret.set_inf
+0001e760: 6f28 6c61 6265 6c3d 276c 626c 2729 0a20  o(label='lbl'). 
+0001e770: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001e780: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
+0001e790: 642c 2027 7365 6372 6574 3a7a 2729 0a0a  d, 'secret:z')..
+0001e7a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001e7b0: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+0001e7c0: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+0001e7d0: 2063 6c65 6172 3d54 7275 6529 2c20 5b0a   clear=True), [.
+0001e7e0: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001e7f0: 6372 6574 2d73 6574 272c 2027 7365 6372  cret-set', 'secr
+0001e800: 6574 3a78 272c 2027 2d2d 6c61 6265 6c27  et:x', '--label'
+0001e810: 2c20 276c 6162 272c 2027 2d2d 6465 7363  , 'lab', '--desc
+0001e820: 7269 7074 696f 6e27 2c20 2764 6573 6327  ription', 'desc'
+0001e830: 2c0a 2020 2020 2020 2020 2020 2020 2027  ,.             '
+0001e840: 2d2d 6578 7069 7265 272c 2027 3230 3232  --expire', '2022
+0001e850: 2d31 322d 3039 5431 363a 3539 3a30 3027  -12-09T16:59:00'
+0001e860: 2c20 272d 2d72 6f74 6174 6527 2c20 276d  , '--rotate', 'm
+0001e870: 6f6e 7468 6c79 275d 2c0a 2020 2020 2020  onthly'],.      
+0001e880: 2020 2020 2020 5b27 7365 6372 6574 2d69        ['secret-i
+0001e890: 6e66 6f2d 6765 7427 2c20 272d 2d6c 6162  nfo-get', '--lab
+0001e8a0: 656c 272c 2027 7927 2c20 272d 2d66 6f72  el', 'y', '--for
+0001e8b0: 6d61 743d 6a73 6f6e 275d 2c0a 2020 2020  mat=json'],.    
+0001e8c0: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
+0001e8d0: 2d73 6574 272c 2027 7365 6372 6574 3a7a  -set', 'secret:z
+0001e8e0: 272c 2027 2d2d 6c61 6265 6c27 2c20 276c  ', '--label', 'l
+0001e8f0: 626c 275d 2c0a 2020 2020 2020 2020 5d29  bl'],.        ])
+0001e900: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+0001e910: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0001e920: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0001e930: 2020 2020 2020 2020 2073 6563 7265 742e           secret.
+0001e940: 7365 745f 696e 666f 2829 2020 2320 6e6f  set_info()  # no
+0001e950: 2061 7267 7320 7072 6f76 6964 6564 0a0a   args provided..
+0001e960: 2020 2020 6465 6620 7465 7374 5f67 7261      def test_gra
+0001e970: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
+0001e980: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001e990: 6c66 2c20 2773 6563 7265 742d 6772 616e  lf, 'secret-gran
+0001e9a0: 7427 2c20 2222 2265 7869 7420 3022 2222  t', """exit 0"""
+0001e9b0: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+0001e9c0: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
+0001e9d0: 7265 742d 696e 666f 2d67 6574 272c 2022  ret-info-get', "
+0001e9e0: 2222 6563 686f 2027 7b22 7a22 3a20 7b22  ""echo '{"z": {"
+0001e9f0: 6c61 6265 6c22 3a20 2279 222c 2022 7265  label": "y", "re
+0001ea00: 7669 7369 6f6e 223a 2037 7d7d 2722 2222  vision": 7}}'"""
+0001ea10: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
+0001ea20: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
+0001ea30: 6372 6574 2869 643d 2778 2729 0a20 2020  cret(id='x').   
+0001ea40: 2020 2020 2073 6563 7265 742e 6772 616e       secret.gran
+0001ea50: 7428 7479 7065 732e 5369 6d70 6c65 4e61  t(types.SimpleNa
+0001ea60: 6d65 7370 6163 6528 6964 3d31 3233 2929  mespace(id=123))
+0001ea70: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
+0001ea80: 6772 616e 7428 7479 7065 732e 5369 6d70  grant(types.Simp
+0001ea90: 6c65 4e61 6d65 7370 6163 6528 6964 3d32  leNamespace(id=2
+0001eaa0: 3334 292c 2075 6e69 743d 7479 7065 732e  34), unit=types.
+0001eab0: 5369 6d70 6c65 4e61 6d65 7370 6163 6528  SimpleNamespace(
+0001eac0: 6e61 6d65 3d27 6170 702f 3027 2929 0a0a  name='app/0'))..
+0001ead0: 2020 2020 2020 2020 2320 4966 2073 6563          # If sec
+0001eae0: 7265 7420 646f 6573 6e27 7420 6861 7665  ret doesn't have
+0001eaf0: 2061 6e20 4944 2c20 7765 276c 6c20 7275   an ID, we'll ru
+0001eb00: 6e20 7365 6372 6574 2d69 6e66 6f2d 6765  n secret-info-ge
+0001eb10: 7420 746f 2066 6574 6368 2069 740a 2020  t to fetch it.  
+0001eb20: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001eb30: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
+0001eb40: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
+0001eb50: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001eb60: 4e6f 6e65 2873 6563 7265 742e 6964 290a  None(secret.id).
+0001eb70: 2020 2020 2020 2020 7365 6372 6574 2e67          secret.g
+0001eb80: 7261 6e74 2874 7970 6573 2e53 696d 706c  rant(types.Simpl
+0001eb90: 654e 616d 6573 7061 6365 2869 643d 3334  eNamespace(id=34
+0001eba0: 3529 290a 2020 2020 2020 2020 7365 6c66  5)).        self
+0001ebb0: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001ebc0: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
+0001ebd0: 7a27 290a 0a20 2020 2020 2020 2073 656c  z')..        sel
+0001ebe0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+0001ebf0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+0001ec00: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+0001ec10: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
+0001ec20: 205b 2773 6563 7265 742d 6772 616e 7427   ['secret-grant'
+0001ec30: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
+0001ec40: 2d72 656c 6174 696f 6e27 2c20 2731 3233  -relation', '123
+0001ec50: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0001ec60: 5b27 7365 6372 6574 2d67 7261 6e74 272c  ['secret-grant',
+0001ec70: 2027 7365 6372 6574 3a78 272c 2027 2d2d   'secret:x', '--
+0001ec80: 7265 6c61 7469 6f6e 272c 2027 3233 3427  relation', '234'
+0001ec90: 2c20 272d 2d75 6e69 7427 2c20 2761 7070  , '--unit', 'app
+0001eca0: 2f30 275d 2c0a 2020 2020 2020 2020 2020  /0'],.          
+0001ecb0: 2020 5b27 7365 6372 6574 2d69 6e66 6f2d    ['secret-info-
+0001ecc0: 6765 7427 2c20 272d 2d6c 6162 656c 272c  get', '--label',
+0001ecd0: 2027 7927 2c20 272d 2d66 6f72 6d61 743d   'y', '--format=
+0001ece0: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
+0001ecf0: 2020 2020 5b27 7365 6372 6574 2d67 7261      ['secret-gra
+0001ed00: 6e74 272c 2027 7365 6372 6574 3a7a 272c  nt', 'secret:z',
+0001ed10: 2027 2d2d 7265 6c61 7469 6f6e 272c 2027   '--relation', '
+0001ed20: 3334 3527 5d2c 0a20 2020 2020 2020 205d  345'],.        ]
+0001ed30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001ed40: 7265 766f 6b65 2873 656c 6629 3a0a 2020  revoke(self):.  
+0001ed50: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001ed60: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001ed70: 7265 766f 6b65 272c 2022 2222 6578 6974  revoke', """exit
+0001ed80: 2030 2222 2229 0a20 2020 2020 2020 2066   0""").        f
+0001ed90: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001eda0: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
+0001edb0: 7427 2c20 2222 2265 6368 6f20 277b 227a  t', """echo '{"z
+0001edc0: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
+0001edd0: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
+0001ede0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
+0001edf0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
+0001ee00: 6b65 5f73 6563 7265 7428 6964 3d27 7827  ke_secret(id='x'
+0001ee10: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0001ee20: 2e72 6576 6f6b 6528 7479 7065 732e 5369  .revoke(types.Si
+0001ee30: 6d70 6c65 4e61 6d65 7370 6163 6528 6964  mpleNamespace(id
+0001ee40: 3d31 3233 2929 0a20 2020 2020 2020 2073  =123)).        s
+0001ee50: 6563 7265 742e 7265 766f 6b65 2874 7970  ecret.revoke(typ
+0001ee60: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
+0001ee70: 6365 2869 643d 3233 3429 2c20 756e 6974  ce(id=234), unit
+0001ee80: 3d74 7970 6573 2e53 696d 706c 654e 616d  =types.SimpleNam
+0001ee90: 6573 7061 6365 286e 616d 653d 2761 7070  espace(name='app
+0001eea0: 2f30 2729 290a 0a20 2020 2020 2020 2023  /0'))..        #
+0001eeb0: 2049 6620 7365 6372 6574 2064 6f65 736e   If secret doesn
+0001eec0: 2774 2068 6176 6520 616e 2049 442c 2077  't have an ID, w
+0001eed0: 6527 6c6c 2072 756e 2073 6563 7265 742d  e'll run secret-
+0001eee0: 696e 666f 2d67 6574 2074 6f20 6665 7463  info-get to fetc
+0001eef0: 6820 6974 0a20 2020 2020 2020 2073 6563  h it.        sec
+0001ef00: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
+0001ef10: 7365 6372 6574 286c 6162 656c 3d27 7927  secret(label='y'
+0001ef20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ef30: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
+0001ef40: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
+0001ef50: 6563 7265 742e 7265 766f 6b65 2874 7970  ecret.revoke(typ
+0001ef60: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
+0001ef70: 6365 2869 643d 3334 3529 290a 2020 2020  ce(id=345)).    
+0001ef80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001ef90: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
+0001efa0: 2773 6563 7265 743a 7a27 290a 0a20 2020  'secret:z')..   
+0001efb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001efc0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+0001efd0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+0001efe0: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
+0001eff0: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001f000: 742d 7265 766f 6b65 272c 2027 7365 6372  t-revoke', 'secr
+0001f010: 6574 3a78 272c 2027 2d2d 7265 6c61 7469  et:x', '--relati
+0001f020: 6f6e 272c 2027 3132 3327 5d2c 0a20 2020  on', '123'],.   
+0001f030: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001f040: 742d 7265 766f 6b65 272c 2027 7365 6372  t-revoke', 'secr
+0001f050: 6574 3a78 272c 2027 2d2d 7265 6c61 7469  et:x', '--relati
+0001f060: 6f6e 272c 2027 3233 3427 2c20 272d 2d75  on', '234', '--u
+0001f070: 6e69 7427 2c20 2761 7070 2f30 275d 2c0a  nit', 'app/0'],.
+0001f080: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001f090: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
+0001f0a0: 272d 2d6c 6162 656c 272c 2027 7927 2c20  '--label', 'y', 
+0001f0b0: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
+0001f0c0: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
+0001f0d0: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
+0001f0e0: 2773 6563 7265 743a 7a27 2c20 272d 2d72  'secret:z', '--r
+0001f0f0: 656c 6174 696f 6e27 2c20 2733 3435 275d  elation', '345']
+0001f100: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+0001f110: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
+0001f120: 655f 7265 7669 7369 6f6e 2873 656c 6629  e_revision(self)
+0001f130: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
+0001f140: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
+0001f150: 7265 742d 7265 6d6f 7665 272c 2022 2222  ret-remove', """
+0001f160: 6578 6974 2030 2222 2229 0a20 2020 2020  exit 0""").     
+0001f170: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001f180: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
+0001f190: 6f2d 6765 7427 2c20 2222 2265 6368 6f20  o-get', """echo 
+0001f1a0: 277b 227a 223a 207b 226c 6162 656c 223a  '{"z": {"label":
+0001f1b0: 2022 7922 2c20 2272 6576 6973 696f 6e22   "y", "revision"
+0001f1c0: 3a20 377d 7d27 2222 2229 0a0a 2020 2020  : 7}}'""")..    
+0001f1d0: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
+0001f1e0: 662e 6d61 6b65 5f73 6563 7265 7428 6964  f.make_secret(id
+0001f1f0: 3d27 7827 290a 2020 2020 2020 2020 7365  ='x').        se
+0001f200: 6372 6574 2e72 656d 6f76 655f 7265 7669  cret.remove_revi
+0001f210: 7369 6f6e 2831 3233 290a 0a20 2020 2020  sion(123)..     
+0001f220: 2020 2023 2049 6620 7365 6372 6574 2064     # If secret d
+0001f230: 6f65 736e 2774 2068 6176 6520 616e 2049  oesn't have an I
+0001f240: 442c 2077 6527 6c6c 2072 756e 2073 6563  D, we'll run sec
+0001f250: 7265 742d 696e 666f 2d67 6574 2074 6f20  ret-info-get to 
+0001f260: 6665 7463 6820 6974 0a20 2020 2020 2020  fetch it.       
+0001f270: 2073 6563 7265 7420 3d20 7365 6c66 2e6d   secret = self.m
+0001f280: 616b 655f 7365 6372 6574 286c 6162 656c  ake_secret(label
+0001f290: 3d27 7927 290a 2020 2020 2020 2020 7365  ='y').        se
+0001f2a0: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+0001f2b0: 7365 6372 6574 2e69 6429 0a20 2020 2020  secret.id).     
+0001f2c0: 2020 2073 6563 7265 742e 7265 6d6f 7665     secret.remove
+0001f2d0: 5f72 6576 6973 696f 6e28 3233 3429 0a20  _revision(234). 
+0001f2e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001f2f0: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
+0001f300: 642c 2027 7365 6372 6574 3a7a 2729 0a0a  d, 'secret:z')..
+0001f310: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001f320: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+0001f330: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+0001f340: 2063 6c65 6172 3d54 7275 6529 2c20 5b0a   clear=True), [.
+0001f350: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001f360: 6372 6574 2d72 656d 6f76 6527 2c20 2773  cret-remove', 's
+0001f370: 6563 7265 743a 7827 2c20 272d 2d72 6576  ecret:x', '--rev
+0001f380: 6973 696f 6e27 2c20 2731 3233 275d 2c0a  ision', '123'],.
+0001f390: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001f3a0: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
+0001f3b0: 272d 2d6c 6162 656c 272c 2027 7927 2c20  '--label', 'y', 
+0001f3c0: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
+0001f3d0: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
+0001f3e0: 7365 6372 6574 2d72 656d 6f76 6527 2c20  secret-remove', 
+0001f3f0: 2773 6563 7265 743a 7a27 2c20 272d 2d72  'secret:z', '--r
+0001f400: 6576 6973 696f 6e27 2c20 2732 3334 275d  evision', '234']
+0001f410: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+0001f420: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
+0001f430: 655f 616c 6c5f 7265 7669 7369 6f6e 7328  e_all_revisions(
+0001f440: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001f450: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001f460: 2027 7365 6372 6574 2d72 656d 6f76 6527   'secret-remove'
+0001f470: 2c20 2222 2265 7869 7420 3022 2222 290a  , """exit 0""").
+0001f480: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+0001f490: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
+0001f4a0: 742d 696e 666f 2d67 6574 272c 2022 2222  t-info-get', """
+0001f4b0: 6563 686f 2027 7b22 7a22 3a20 7b22 6c61  echo '{"z": {"la
+0001f4c0: 6265 6c22 3a20 2279 222c 2022 7265 7669  bel": "y", "revi
+0001f4d0: 7369 6f6e 223a 2037 7d7d 2722 2222 290a  sion": 7}}'""").
+0001f4e0: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
+0001f4f0: 3d20 7365 6c66 2e6d 616b 655f 7365 6372  = self.make_secr
+0001f500: 6574 2869 643d 2778 2729 0a20 2020 2020  et(id='x').     
+0001f510: 2020 2073 6563 7265 742e 7265 6d6f 7665     secret.remove
+0001f520: 5f61 6c6c 5f72 6576 6973 696f 6e73 2829  _all_revisions()
+0001f530: 0a0a 2020 2020 2020 2020 2320 4966 2073  ..        # If s
+0001f540: 6563 7265 7420 646f 6573 6e27 7420 6861  ecret doesn't ha
+0001f550: 7665 2061 6e20 4944 2c20 7765 276c 6c20  ve an ID, we'll 
+0001f560: 7275 6e20 7365 6372 6574 2d69 6e66 6f2d  run secret-info-
+0001f570: 6765 7420 746f 2066 6574 6368 2069 740a  get to fetch it.
+0001f580: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001f590: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001f5a0: 7428 6c61 6265 6c3d 2779 2729 0a20 2020  t(label='y').   
+0001f5b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001f5c0: 4973 4e6f 6e65 2873 6563 7265 742e 6964  IsNone(secret.id
+0001f5d0: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0001f5e0: 2e72 656d 6f76 655f 616c 6c5f 7265 7669  .remove_all_revi
+0001f5f0: 7369 6f6e 7328 290a 2020 2020 2020 2020  sions().        
+0001f600: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001f610: 2873 6563 7265 742e 6964 2c20 2773 6563  (secret.id, 'sec
+0001f620: 7265 743a 7a27 290a 0a20 2020 2020 2020  ret:z')..       
+0001f630: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001f640: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001f650: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001f660: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
+0001f670: 2020 2020 205b 2773 6563 7265 742d 7265       ['secret-re
+0001f680: 6d6f 7665 272c 2027 7365 6372 6574 3a78  move', 'secret:x
+0001f690: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0001f6a0: 5b27 7365 6372 6574 2d69 6e66 6f2d 6765  ['secret-info-ge
+0001f6b0: 7427 2c20 272d 2d6c 6162 656c 272c 2027  t', '--label', '
+0001f6c0: 7927 2c20 272d 2d66 6f72 6d61 743d 6a73  y', '--format=js
+0001f6d0: 6f6e 275d 2c0a 2020 2020 2020 2020 2020  on'],.          
+0001f6e0: 2020 5b27 7365 6372 6574 2d72 656d 6f76    ['secret-remov
+0001f6f0: 6527 2c20 2773 6563 7265 743a 7a27 5d2c  e', 'secret:z'],
+0001f700: 0a20 2020 2020 2020 205d 290a 0a0a 636c  .        ])...cl
+0001f710: 6173 7320 5465 7374 506f 7274 7328 756e  ass TestPorts(un
+0001f720: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
+0001f730: 3a0a 2020 2020 6465 6620 7365 7455 7028  :.    def setUp(
+0001f740: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001f750: 656c 662e 6d6f 6465 6c20 3d20 6f70 732e  elf.model = ops.
+0001f760: 6d6f 6465 6c2e 4d6f 6465 6c28 6f70 732e  model.Model(ops.
+0001f770: 6368 6172 6d2e 4368 6172 6d4d 6574 6128  charm.CharmMeta(
+0001f780: 292c 206f 7073 2e6d 6f64 656c 2e5f 4d6f  ), ops.model._Mo
+0001f790: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+0001f7a0: 702f 3027 2929 0a20 2020 2020 2020 2073  p/0')).        s
+0001f7b0: 656c 662e 756e 6974 203d 2073 656c 662e  elf.unit = self.
+0001f7c0: 6d6f 6465 6c2e 756e 6974 0a0a 2020 2020  model.unit..    
+0001f7d0: 6465 6620 7465 7374 5f6f 7065 6e5f 706f  def test_open_po
+0001f7e0: 7274 2873 656c 6629 3a0a 2020 2020 2020  rt(self):.      
+0001f7f0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001f800: 6c66 2c20 276f 7065 6e2d 706f 7274 272c  lf, 'open-port',
+0001f810: 2027 6578 6974 2030 2729 0a0a 2020 2020   'exit 0')..    
+0001f820: 2020 2020 7365 6c66 2e75 6e69 742e 6f70      self.unit.op
+0001f830: 656e 5f70 6f72 7428 2774 6370 272c 2038  en_port('tcp', 8
+0001f840: 3038 3029 0a20 2020 2020 2020 2073 656c  080).        sel
+0001f850: 662e 756e 6974 2e6f 7065 6e5f 706f 7274  f.unit.open_port
+0001f860: 2827 5544 5027 2c20 3430 3030 290a 2020  ('UDP', 4000).  
+0001f870: 2020 2020 2020 7365 6c66 2e75 6e69 742e        self.unit.
+0001f880: 6f70 656e 5f70 6f72 7428 2769 636d 7027  open_port('icmp'
+0001f890: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001f8a0: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+0001f8b0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+0001f8c0: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+0001f8d0: 205b 0a20 2020 2020 2020 2020 2020 205b   [.            [
+0001f8e0: 276f 7065 6e2d 706f 7274 272c 2027 3830  'open-port', '80
+0001f8f0: 3830 2f74 6370 275d 2c0a 2020 2020 2020  80/tcp'],.      
+0001f900: 2020 2020 2020 5b27 6f70 656e 2d70 6f72        ['open-por
+0001f910: 7427 2c20 2734 3030 302f 7564 7027 5d2c  t', '4000/udp'],
+0001f920: 0a20 2020 2020 2020 2020 2020 205b 276f  .            ['o
+0001f930: 7065 6e2d 706f 7274 272c 2027 6963 6d70  pen-port', 'icmp
+0001f940: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+0001f950: 2020 2020 6465 6620 7465 7374 5f6f 7065      def test_ope
+0001f960: 6e5f 706f 7274 5f65 7272 6f72 2873 656c  n_port_error(sel
+0001f970: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+0001f980: 5f73 6372 6970 7428 7365 6c66 2c20 276f  _script(self, 'o
+0001f990: 7065 6e2d 706f 7274 272c 2022 6563 686f  pen-port', "echo
+0001f9a0: 2027 4552 524f 5220 6261 6420 7072 6f74   'ERROR bad prot
+0001f9b0: 6f63 6f6c 2720 3e26 323b 2065 7869 7420  ocol' >&2; exit 
+0001f9c0: 3122 290a 0a20 2020 2020 2020 2077 6974  1")..        wit
+0001f9d0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0001f9e0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+0001f9f0: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+0001fa00: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
+0001fa10: 2e6f 7065 6e5f 706f 7274 2827 6674 7027  .open_port('ftp'
+0001fa20: 2c20 3830 3830 290a 2020 2020 2020 2020  , 8080).        
+0001fa30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001fa40: 2873 7472 2863 6d2e 6578 6365 7074 696f  (str(cm.exceptio
+0001fa50: 6e29 2c20 2745 5252 4f52 2062 6164 2070  n), 'ERROR bad p
+0001fa60: 726f 746f 636f 6c5c 6e27 290a 0a20 2020  rotocol\n')..   
+0001fa70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001fa80: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+0001fa90: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+0001faa0: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
+0001fab0: 2020 2020 2020 2020 205b 276f 7065 6e2d           ['open-
+0001fac0: 706f 7274 272c 2027 3830 3830 2f66 7470  port', '8080/ftp
+0001fad0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+0001fae0: 2020 2020 6465 6620 7465 7374 5f63 6c6f      def test_clo
+0001faf0: 7365 5f70 6f72 7428 7365 6c66 293a 0a20  se_port(self):. 
+0001fb00: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001fb10: 7074 2873 656c 662c 2027 636c 6f73 652d  pt(self, 'close-
+0001fb20: 706f 7274 272c 2027 6578 6974 2030 2729  port', 'exit 0')
+0001fb30: 0a0a 2020 2020 2020 2020 7365 6c66 2e75  ..        self.u
+0001fb40: 6e69 742e 636c 6f73 655f 706f 7274 2827  nit.close_port('
+0001fb50: 7463 7027 2c20 3830 3830 290a 2020 2020  tcp', 8080).    
+0001fb60: 2020 2020 7365 6c66 2e75 6e69 742e 636c      self.unit.cl
+0001fb70: 6f73 655f 706f 7274 2827 5544 5027 2c20  ose_port('UDP', 
+0001fb80: 3430 3030 290a 2020 2020 2020 2020 7365  4000).        se
+0001fb90: 6c66 2e75 6e69 742e 636c 6f73 655f 706f  lf.unit.close_po
+0001fba0: 7274 2827 6963 6d70 2729 0a0a 2020 2020  rt('icmp')..    
+0001fbb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001fbc0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001fbd0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001fbe0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+0001fbf0: 2020 2020 2020 2020 5b27 636c 6f73 652d          ['close-
+0001fc00: 706f 7274 272c 2027 3830 3830 2f74 6370  port', '8080/tcp
+0001fc10: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0001fc20: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
+0001fc30: 3430 3030 2f75 6470 275d 2c0a 2020 2020  4000/udp'],.    
+0001fc40: 2020 2020 2020 2020 5b27 636c 6f73 652d          ['close-
+0001fc50: 706f 7274 272c 2027 6963 6d70 275d 2c0a  port', 'icmp'],.
+0001fc60: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0001fc70: 6465 6620 7465 7374 5f63 6c6f 7365 5f70  def test_close_p
+0001fc80: 6f72 745f 6572 726f 7228 7365 6c66 293a  ort_error(self):
+0001fc90: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001fca0: 7269 7074 2873 656c 662c 2027 636c 6f73  ript(self, 'clos
+0001fcb0: 652d 706f 7274 272c 2022 6563 686f 2027  e-port', "echo '
+0001fcc0: 4552 524f 5220 6261 6420 7072 6f74 6f63  ERROR bad protoc
+0001fcd0: 6f6c 2720 3e26 323b 2065 7869 7420 3122  ol' >&2; exit 1"
+0001fce0: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+0001fcf0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0001fd00: 7328 6f70 732e 4d6f 6465 6c45 7272 6f72  s(ops.ModelError
+0001fd10: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+0001fd20: 2020 2020 2073 656c 662e 756e 6974 2e63       self.unit.c
+0001fd30: 6c6f 7365 5f70 6f72 7428 2766 7470 272c  lose_port('ftp',
+0001fd40: 2038 3038 3029 0a20 2020 2020 2020 2073   8080).        s
+0001fd50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001fd60: 7374 7228 636d 2e65 7863 6570 7469 6f6e  str(cm.exception
+0001fd70: 292c 2027 4552 524f 5220 6261 6420 7072  ), 'ERROR bad pr
+0001fd80: 6f74 6f63 6f6c 5c6e 2729 0a0a 2020 2020  otocol\n')..    
+0001fd90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001fda0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001fdb0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001fdc0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+0001fdd0: 2020 2020 2020 2020 5b27 636c 6f73 652d          ['close-
+0001fde0: 706f 7274 272c 2027 3830 3830 2f66 7470  port', '8080/ftp
+0001fdf0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+0001fe00: 2020 2020 6465 6620 7465 7374 5f6f 7065      def test_ope
+0001fe10: 6e65 645f 706f 7274 7328 7365 6c66 293a  ned_ports(self):
+0001fe20: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001fe30: 7269 7074 2873 656c 662c 2027 6f70 656e  ript(self, 'open
+0001fe40: 6564 2d70 6f72 7473 272c 2022 2222 6563  ed-ports', """ec
+0001fe50: 686f 2038 3038 302f 7463 703b 2065 6368  ho 8080/tcp; ech
+0001fe60: 6f20 6963 6d70 2222 2229 0a0a 2020 2020  o icmp""")..    
+0001fe70: 2020 2020 706f 7274 735f 7365 7420 3d20      ports_set = 
+0001fe80: 7365 6c66 2e75 6e69 742e 6f70 656e 6564  self.unit.opened
+0001fe90: 5f70 6f72 7473 2829 0a20 2020 2020 2020  _ports().       
+0001fea0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+0001feb0: 7374 616e 6365 2870 6f72 7473 5f73 6574  stance(ports_set
+0001fec0: 2c20 7365 7429 0a20 2020 2020 2020 2070  , set).        p
+0001fed0: 6f72 7473 203d 2073 6f72 7465 6428 706f  orts = sorted(po
+0001fee0: 7274 735f 7365 742c 206b 6579 3d6c 616d  rts_set, key=lam
+0001fef0: 6264 6120 703a 2028 702e 7072 6f74 6f63  bda p: (p.protoc
+0001ff00: 6f6c 2c20 702e 706f 7274 2929 0a20 2020  ol, p.port)).   
+0001ff10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ff20: 4571 7561 6c28 6c65 6e28 706f 7274 7329  Equal(len(ports)
+0001ff30: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
+0001ff40: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+0001ff50: 6365 2870 6f72 7473 5b30 5d2c 206f 7073  ce(ports[0], ops
+0001ff60: 2e4f 7065 6e65 6450 6f72 7429 0a20 2020  .OpenedPort).   
+0001ff70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ff80: 4571 7561 6c28 706f 7274 735b 305d 2e70  Equal(ports[0].p
+0001ff90: 726f 746f 636f 6c2c 2027 6963 6d70 2729  rotocol, 'icmp')
+0001ffa0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ffb0: 7365 7274 4973 4e6f 6e65 2870 6f72 7473  sertIsNone(ports
+0001ffc0: 5b30 5d2e 706f 7274 290a 2020 2020 2020  [0].port).      
+0001ffd0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0001ffe0: 6e73 7461 6e63 6528 706f 7274 735b 315d  nstance(ports[1]
+0001fff0: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
+00020000: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00020010: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
+00020020: 5b31 5d2e 7072 6f74 6f63 6f6c 2c20 2774  [1].protocol, 't
+00020030: 6370 2729 0a20 2020 2020 2020 2073 656c  cp').        sel
+00020040: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
+00020050: 7274 735b 315d 2e70 6f72 742c 2038 3038  rts[1].port, 808
+00020060: 3029 0a0a 2020 2020 2020 2020 7365 6c66  0)..        self
+00020070: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+00020080: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+00020090: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+000200a0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+000200b0: 5b27 6f70 656e 6564 2d70 6f72 7473 272c  ['opened-ports',
+000200c0: 2027 275d 2c0a 2020 2020 2020 2020 5d29   ''],.        ])
+000200d0: 0a0a 2020 2020 6465 6620 7465 7374 5f6f  ..    def test_o
+000200e0: 7065 6e65 645f 706f 7274 735f 7761 726e  pened_ports_warn
+000200f0: 696e 6773 2873 656c 6629 3a0a 2020 2020  ings(self):.    
+00020100: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00020110: 7365 6c66 2c20 276f 7065 6e65 642d 706f  self, 'opened-po
+00020120: 7274 7327 2c20 2222 2265 6368 6f20 3830  rts', """echo 80
+00020130: 3830 2f74 6370 3b20 6563 686f 2031 3233  80/tcp; echo 123
+00020140: 342f 6674 703b 2065 6368 6f20 3130 3030  4/ftp; echo 1000
+00020150: 2d32 3030 302f 7564 7022 2222 290a 0a20  -2000/udp""").. 
+00020160: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00020170: 2e61 7373 6572 744c 6f67 7328 276f 7073  .assertLogs('ops
+00020180: 2e6d 6f64 656c 272c 206c 6576 656c 3d27  .model', level='
+00020190: 5741 524e 494e 4727 2920 6173 2063 6d3a  WARNING') as cm:
+000201a0: 0a20 2020 2020 2020 2020 2020 2070 6f72  .            por
+000201b0: 7473 5f73 6574 203d 2073 656c 662e 756e  ts_set = self.un
+000201c0: 6974 2e6f 7065 6e65 645f 706f 7274 7328  it.opened_ports(
+000201d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000201e0: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
+000201f0: 6d2e 6f75 7470 7574 292c 2032 290a 2020  m.output), 2).  
+00020200: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00020210: 7452 6567 6578 2863 6d2e 6f75 7470 7574  tRegex(cm.output
+00020220: 5b30 5d2c 2072 2757 4152 4e49 4e47 3a6f  [0], r'WARNING:o
+00020230: 7073 2e6d 6f64 656c 3a2e 2a70 726f 746f  ps.model:.*proto
+00020240: 636f 6c2e 2a27 290a 2020 2020 2020 2020  col.*').        
+00020250: 7365 6c66 2e61 7373 6572 7452 6567 6578  self.assertRegex
+00020260: 2863 6d2e 6f75 7470 7574 5b31 5d2c 2072  (cm.output[1], r
+00020270: 2757 4152 4e49 4e47 3a6f 7073 2e6d 6f64  'WARNING:ops.mod
+00020280: 656c 3a2e 2a72 616e 6765 2e2a 2729 0a0a  el:.*range.*')..
+00020290: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000202a0: 6572 7449 7349 6e73 7461 6e63 6528 706f  ertIsInstance(po
+000202b0: 7274 735f 7365 742c 2073 6574 290a 2020  rts_set, set).  
+000202c0: 2020 2020 2020 706f 7274 7320 3d20 736f        ports = so
+000202d0: 7274 6564 2870 6f72 7473 5f73 6574 2c20  rted(ports_set, 
+000202e0: 6b65 793d 6c61 6d62 6461 2070 3a20 2870  key=lambda p: (p
+000202f0: 2e70 726f 746f 636f 6c2c 2070 2e70 6f72  .protocol, p.por
+00020300: 7429 290a 2020 2020 2020 2020 7365 6c66  t)).        self
+00020310: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00020320: 2870 6f72 7473 292c 2032 290a 2020 2020  (ports), 2).    
+00020330: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00020340: 7349 6e73 7461 6e63 6528 706f 7274 735b  sInstance(ports[
+00020350: 305d 2c20 6f70 732e 4f70 656e 6564 506f  0], ops.OpenedPo
+00020360: 7274 290a 2020 2020 2020 2020 7365 6c66  rt).        self
+00020370: 2e61 7373 6572 7445 7175 616c 2870 6f72  .assertEqual(por
+00020380: 7473 5b30 5d2e 7072 6f74 6f63 6f6c 2c20  ts[0].protocol, 
+00020390: 2774 6370 2729 0a20 2020 2020 2020 2073  'tcp').        s
+000203a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000203b0: 706f 7274 735b 305d 2e70 6f72 742c 2038  ports[0].port, 8
+000203c0: 3038 3029 0a20 2020 2020 2020 2073 656c  080).        sel
+000203d0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+000203e0: 6365 2870 6f72 7473 5b31 5d2c 206f 7073  ce(ports[1], ops
+000203f0: 2e4f 7065 6e65 6450 6f72 7429 0a20 2020  .OpenedPort).   
+00020400: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00020410: 4571 7561 6c28 706f 7274 735b 315d 2e70  Equal(ports[1].p
+00020420: 726f 746f 636f 6c2c 2027 7564 7027 290a  rotocol, 'udp').
+00020430: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00020440: 6572 7445 7175 616c 2870 6f72 7473 5b31  ertEqual(ports[1
+00020450: 5d2e 706f 7274 2c20 3130 3030 290a 0a20  ].port, 1000).. 
+00020460: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00020470: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
+00020480: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
+00020490: 636c 6561 723d 5472 7565 292c 205b 0a20  clear=True), [. 
+000204a0: 2020 2020 2020 2020 2020 205b 276f 7065             ['ope
+000204b0: 6e65 642d 706f 7274 7327 2c20 2727 5d2c  ned-ports', ''],
+000204c0: 0a20 2020 2020 2020 205d 290a 0a0a 6966  .        ])...if
+000204d0: 205f 5f6e 616d 655f 5f20 3d3d 2022 5f5f   __name__ == "__
+000204e0: 6d61 696e 5f5f 223a 0a20 2020 2075 6e69  main__":.    uni
+000204f0: 7474 6573 742e 6d61 696e 2829 0a         ttest.main().
```

### Comparing `ops-2.4.1/test/test_pebble.py` & `ops-2.5.0/test/test_pebble.py`

 * *Files 0% similar despite different names*

```diff
@@ -1577,6243 +1577,6265 @@
 00006280: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
 00006290: 7445 7175 616c 2873 6572 7669 6365 2e67  tEqual(service.g
 000062a0: 726f 7570 2c20 2727 290a 2020 2020 2020  roup, '').      
 000062b0: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
 000062c0: 7365 7276 6963 652e 6772 6f75 705f 6964  service.group_id
 000062d0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
 000062e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000062f0: 2873 6572 7669 6365 2e6f 6e5f 7375 6363  (service.on_succ
-00006300: 6573 732c 2027 2729 0a20 2020 2020 2020  ess, '').       
-00006310: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00006320: 6c28 7365 7276 6963 652e 6f6e 5f66 6169  l(service.on_fai
-00006330: 6c75 7265 2c20 2727 290a 2020 2020 2020  lure, '').      
-00006340: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00006350: 616c 2873 6572 7669 6365 2e6f 6e5f 6368  al(service.on_ch
-00006360: 6563 6b5f 6661 696c 7572 652c 207b 7d29  eck_failure, {})
-00006370: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00006380: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-00006390: 652e 6261 636b 6f66 665f 6465 6c61 792c  e.backoff_delay,
-000063a0: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
-000063b0: 662e 6173 7365 7274 4973 2873 6572 7669  f.assertIs(servi
-000063c0: 6365 2e62 6163 6b6f 6666 5f66 6163 746f  ce.backoff_facto
-000063d0: 722c 204e 6f6e 6529 0a20 2020 2020 2020  r, None).       
-000063e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000063f0: 6c28 7365 7276 6963 652e 6261 636b 6f66  l(service.backof
-00006400: 665f 6c69 6d69 742c 2027 2729 0a20 2020  f_limit, '').   
-00006410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006420: 4571 7561 6c28 7365 7276 6963 652e 746f  Equal(service.to
-00006430: 5f64 6963 7428 292c 207b 7d29 0a0a 2020  _dict(), {})..  
-00006440: 2020 6465 6620 7465 7374 5f6e 616d 655f    def test_name_
-00006450: 6f6e 6c79 2873 656c 6629 3a0a 2020 2020  only(self):.    
-00006460: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
-00006470: 6572 7669 6365 2827 4e61 6d65 2030 2729  ervice('Name 0')
-00006480: 0a20 2020 2020 2020 2073 656c 662e 5f61  .        self._a
-00006490: 7373 6572 745f 656d 7074 7928 732c 2027  ssert_empty(s, '
-000064a0: 4e61 6d65 2030 2729 0a0a 2020 2020 6465  Name 0')..    de
-000064b0: 6620 7465 7374 5f64 6963 7428 7365 6c66  f test_dict(self
-000064c0: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
-000064d0: 6562 626c 652e 5365 7276 6963 6528 274e  ebble.Service('N
-000064e0: 616d 6520 3127 2c20 7b7d 290a 2020 2020  ame 1', {}).    
-000064f0: 2020 2020 7365 6c66 2e5f 6173 7365 7274      self._assert
-00006500: 5f65 6d70 7479 2873 2c20 274e 616d 6520  _empty(s, 'Name 
-00006510: 3127 290a 0a20 2020 2020 2020 2064 203d  1')..        d =
-00006520: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00006530: 7375 6d6d 6172 7927 3a20 2753 756d 204d  summary': 'Sum M
-00006540: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
-00006550: 2020 2764 6573 6372 6970 7469 6f6e 273a    'description':
-00006560: 2027 5468 6520 6c61 7a79 2071 7569 636b   'The lazy quick
-00006570: 2062 726f 776e 272c 0a20 2020 2020 2020   brown',.       
-00006580: 2020 2020 2027 7374 6172 7475 7027 3a20       'startup': 
-00006590: 2753 7461 7274 2055 7027 2c0a 2020 2020  'Start Up',.    
-000065a0: 2020 2020 2020 2020 276f 7665 7272 6964          'overrid
-000065b0: 6527 3a20 276f 7665 7272 6964 6527 2c0a  e': 'override',.
-000065c0: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
-000065d0: 6d61 6e64 273a 2027 6563 686f 2073 756d  mand': 'echo sum
-000065e0: 206d 6172 7927 2c0a 2020 2020 2020 2020   mary',.        
-000065f0: 2020 2020 2761 6674 6572 273a 205b 2761      'after': ['a
-00006600: 3127 2c20 2761 3227 5d2c 0a20 2020 2020  1', 'a2'],.     
-00006610: 2020 2020 2020 2027 6265 666f 7265 273a         'before':
-00006620: 205b 2762 3127 2c20 2762 3227 5d2c 0a20   ['b1', 'b2'],. 
-00006630: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
-00006640: 6972 6573 273a 205b 2772 3127 2c20 2772  ires': ['r1', 'r
-00006650: 3227 5d2c 0a20 2020 2020 2020 2020 2020  2'],.           
-00006660: 2027 656e 7669 726f 6e6d 656e 7427 3a20   'environment': 
-00006670: 7b27 6b31 273a 2027 7631 272c 2027 6b32  {'k1': 'v1', 'k2
-00006680: 273a 2027 7632 277d 2c0a 2020 2020 2020  ': 'v2'},.      
-00006690: 2020 2020 2020 2775 7365 7227 3a20 2762        'user': 'b
-000066a0: 6f62 272c 0a20 2020 2020 2020 2020 2020  ob',.           
-000066b0: 2027 7573 6572 2d69 6427 3a20 3130 3030   'user-id': 1000
-000066c0: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
-000066d0: 726f 7570 273a 2027 7374 6166 6627 2c0a  roup': 'staff',.
-000066e0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
-000066f0: 7570 2d69 6427 3a20 3230 3030 2c0a 2020  up-id': 2000,.  
-00006700: 2020 2020 2020 2020 2020 276f 6e2d 7375            'on-su
-00006710: 6363 6573 7327 3a20 2772 6573 7461 7274  ccess': 'restart
-00006720: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00006730: 6f6e 2d66 6169 6c75 7265 273a 2027 6967  on-failure': 'ig
-00006740: 6e6f 7265 272c 0a20 2020 2020 2020 2020  nore',.         
-00006750: 2020 2027 6f6e 2d63 6865 636b 2d66 6169     'on-check-fai
-00006760: 6c75 7265 273a 207b 2763 686b 3127 3a20  lure': {'chk1': 
-00006770: 2768 616c 7427 7d2c 0a20 2020 2020 2020  'halt'},.       
-00006780: 2020 2020 2027 6261 636b 6f66 662d 6465       'backoff-de
-00006790: 6c61 7927 3a20 2731 7327 2c0a 2020 2020  lay': '1s',.    
-000067a0: 2020 2020 2020 2020 2762 6163 6b6f 6666          'backoff
-000067b0: 2d66 6163 746f 7227 3a20 342c 0a20 2020  -factor': 4,.   
-000067c0: 2020 2020 2020 2020 2027 6261 636b 6f66           'backof
-000067d0: 662d 6c69 6d69 7427 3a20 2731 3073 272c  f-limit': '10s',
-000067e0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000067f0: 2020 2073 203d 2070 6562 626c 652e 5365     s = pebble.Se
-00006800: 7276 6963 6528 274e 616d 6520 3227 2c20  rvice('Name 2', 
-00006810: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-00006820: 6173 7365 7274 4571 7561 6c28 732e 6e61  assertEqual(s.na
-00006830: 6d65 2c20 274e 616d 6520 3227 290a 2020  me, 'Name 2').  
-00006840: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006850: 7445 7175 616c 2873 2e64 6573 6372 6970  tEqual(s.descrip
-00006860: 7469 6f6e 2c20 2754 6865 206c 617a 7920  tion, 'The lazy 
-00006870: 7175 6963 6b20 6272 6f77 6e27 290a 2020  quick brown').  
-00006880: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006890: 7445 7175 616c 2873 2e73 7461 7274 7570  tEqual(s.startup
-000068a0: 2c20 2753 7461 7274 2055 7027 290a 2020  , 'Start Up').  
-000068b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000068c0: 7445 7175 616c 2873 2e6f 7665 7272 6964  tEqual(s.overrid
-000068d0: 652c 2027 6f76 6572 7269 6465 2729 0a20  e, 'override'). 
-000068e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000068f0: 7274 4571 7561 6c28 732e 636f 6d6d 616e  rtEqual(s.comman
-00006900: 642c 2027 6563 686f 2073 756d 206d 6172  d, 'echo sum mar
-00006910: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
-00006920: 2e61 7373 6572 7445 7175 616c 2873 2e61  .assertEqual(s.a
-00006930: 6674 6572 2c20 5b27 6131 272c 2027 6132  fter, ['a1', 'a2
-00006940: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
-00006950: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
-00006960: 6566 6f72 652c 205b 2762 3127 2c20 2762  efore, ['b1', 'b
-00006970: 3227 5d29 0a20 2020 2020 2020 2073 656c  2']).        sel
-00006980: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
-00006990: 7265 7175 6972 6573 2c20 5b27 7231 272c  requires, ['r1',
-000069a0: 2027 7232 275d 290a 2020 2020 2020 2020   'r2']).        
-000069b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000069c0: 2873 2e65 6e76 6972 6f6e 6d65 6e74 2c20  (s.environment, 
-000069d0: 7b27 6b31 273a 2027 7631 272c 2027 6b32  {'k1': 'v1', 'k2
-000069e0: 273a 2027 7632 277d 290a 2020 2020 2020  ': 'v2'}).      
-000069f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00006a00: 616c 2873 2e75 7365 722c 2027 626f 6227  al(s.user, 'bob'
-00006a10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006a20: 7373 6572 7445 7175 616c 2873 2e75 7365  ssertEqual(s.use
-00006a30: 725f 6964 2c20 3130 3030 290a 2020 2020  r_id, 1000).    
-00006a40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00006a50: 7175 616c 2873 2e67 726f 7570 2c20 2773  qual(s.group, 's
-00006a60: 7461 6666 2729 0a20 2020 2020 2020 2073  taff').        s
-00006a70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006a80: 732e 6772 6f75 705f 6964 2c20 3230 3030  s.group_id, 2000
-00006a90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006aa0: 7373 6572 7445 7175 616c 2873 2e6f 6e5f  ssertEqual(s.on_
-00006ab0: 7375 6363 6573 732c 2027 7265 7374 6172  success, 'restar
-00006ac0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-00006ad0: 2e61 7373 6572 7445 7175 616c 2873 2e6f  .assertEqual(s.o
-00006ae0: 6e5f 6661 696c 7572 652c 2027 6967 6e6f  n_failure, 'igno
-00006af0: 7265 2729 0a20 2020 2020 2020 2073 656c  re').        sel
-00006b00: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
-00006b10: 6f6e 5f63 6865 636b 5f66 6169 6c75 7265  on_check_failure
-00006b20: 2c20 7b27 6368 6b31 273a 2027 6861 6c74  , {'chk1': 'halt
-00006b30: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-00006b40: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
-00006b50: 6163 6b6f 6666 5f64 656c 6179 2c20 2731  ackoff_delay, '1
-00006b60: 7327 290a 2020 2020 2020 2020 7365 6c66  s').        self
-00006b70: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
-00006b80: 6163 6b6f 6666 5f66 6163 746f 722c 2034  ackoff_factor, 4
-00006b90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006ba0: 7373 6572 7445 7175 616c 2873 2e62 6163  ssertEqual(s.bac
-00006bb0: 6b6f 6666 5f6c 696d 6974 2c20 2731 3073  koff_limit, '10s
-00006bc0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00006bd0: 2e61 7373 6572 7445 7175 616c 2873 2e74  .assertEqual(s.t
-00006be0: 6f5f 6469 6374 2829 2c20 6429 0a0a 2020  o_dict(), d)..  
-00006bf0: 2020 2020 2020 2320 456e 7375 7265 2070        # Ensure p
-00006c00: 6562 626c 652e 5365 7276 6963 6520 6861  ebble.Service ha
-00006c10: 7320 6d61 6465 2063 6f70 6965 7320 6f66  s made copies of
-00006c20: 206d 7574 6162 6c65 206f 626a 6563 7473   mutable objects
-00006c30: 0a20 2020 2020 2020 2073 2e61 6674 6572  .        s.after
-00006c40: 2e61 7070 656e 6428 2761 3327 290a 2020  .append('a3').  
-00006c50: 2020 2020 2020 732e 6265 666f 7265 2e61        s.before.a
-00006c60: 7070 656e 6428 2762 3327 290a 2020 2020  ppend('b3').    
-00006c70: 2020 2020 732e 7265 7175 6972 6573 2e61      s.requires.a
-00006c80: 7070 656e 6428 2772 3327 290a 2020 2020  ppend('r3').    
-00006c90: 2020 2020 732e 656e 7669 726f 6e6d 656e      s.environmen
-00006ca0: 745b 276b 3327 5d20 3d20 2776 3327 0a20  t['k3'] = 'v3'. 
-00006cb0: 2020 2020 2020 2073 2e6f 6e5f 6368 6563         s.on_chec
-00006cc0: 6b5f 6661 696c 7572 655b 2763 686b 3227  k_failure['chk2'
-00006cd0: 5d20 3d20 2769 676e 6f72 6527 0a20 2020  ] = 'ignore'.   
-00006ce0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006cf0: 4571 7561 6c28 732e 6166 7465 722c 205b  Equal(s.after, [
-00006d00: 2761 3127 2c20 2761 3227 2c20 2761 3327  'a1', 'a2', 'a3'
-00006d10: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00006d20: 6173 7365 7274 4571 7561 6c28 732e 6265  assertEqual(s.be
-00006d30: 666f 7265 2c20 5b27 6231 272c 2027 6232  fore, ['b1', 'b2
-00006d40: 272c 2027 6233 275d 290a 2020 2020 2020  ', 'b3']).      
-00006d50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00006d60: 616c 2873 2e72 6571 7569 7265 732c 205b  al(s.requires, [
-00006d70: 2772 3127 2c20 2772 3227 2c20 2772 3327  'r1', 'r2', 'r3'
-00006d80: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00006d90: 6173 7365 7274 4571 7561 6c28 732e 656e  assertEqual(s.en
-00006da0: 7669 726f 6e6d 656e 742c 207b 276b 3127  vironment, {'k1'
-00006db0: 3a20 2776 3127 2c20 276b 3227 3a20 2776  : 'v1', 'k2': 'v
-00006dc0: 3227 2c20 276b 3327 3a20 2776 3327 7d29  2', 'k3': 'v3'})
-00006dd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00006de0: 7365 7274 4571 7561 6c28 645b 2761 6674  sertEqual(d['aft
-00006df0: 6572 275d 2c20 5b27 6131 272c 2027 6132  er'], ['a1', 'a2
-00006e00: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
-00006e10: 2e61 7373 6572 7445 7175 616c 2864 5b27  .assertEqual(d['
-00006e20: 6265 666f 7265 275d 2c20 5b27 6231 272c  before'], ['b1',
-00006e30: 2027 6232 275d 290a 2020 2020 2020 2020   'b2']).        
-00006e40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006e50: 2864 5b27 7265 7175 6972 6573 275d 2c20  (d['requires'], 
-00006e60: 5b27 7231 272c 2027 7232 275d 290a 2020  ['r1', 'r2']).  
-00006e70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006e80: 7445 7175 616c 2864 5b27 656e 7669 726f  tEqual(d['enviro
-00006e90: 6e6d 656e 7427 5d2c 207b 276b 3127 3a20  nment'], {'k1': 
-00006ea0: 2776 3127 2c20 276b 3227 3a20 2776 3227  'v1', 'k2': 'v2'
-00006eb0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00006ec0: 6173 7365 7274 4571 7561 6c28 645b 276f  assertEqual(d['o
-00006ed0: 6e2d 6368 6563 6b2d 6661 696c 7572 6527  n-check-failure'
-00006ee0: 5d2c 207b 2763 686b 3127 3a20 2768 616c  ], {'chk1': 'hal
-00006ef0: 7427 7d29 0a0a 2020 2020 6465 6620 7465  t'})..    def te
-00006f00: 7374 5f65 7175 616c 6974 7928 7365 6c66  st_equality(self
-00006f10: 293a 0a20 2020 2020 2020 2064 203d 207b  ):.        d = {
-00006f20: 0a20 2020 2020 2020 2020 2020 2027 7375  .            'su
-00006f30: 6d6d 6172 7927 3a20 2753 756d 204d 6172  mmary': 'Sum Mar
-00006f40: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-00006f50: 2764 6573 6372 6970 7469 6f6e 273a 2027  'description': '
-00006f60: 5468 6520 6c61 7a79 2071 7569 636b 2062  The lazy quick b
-00006f70: 726f 776e 272c 0a20 2020 2020 2020 2020  rown',.         
-00006f80: 2020 2027 7374 6172 7475 7027 3a20 2753     'startup': 'S
-00006f90: 7461 7274 2055 7027 2c0a 2020 2020 2020  tart Up',.      
-00006fa0: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
-00006fb0: 3a20 276f 7665 7272 6964 6527 2c0a 2020  : 'override',.  
-00006fc0: 2020 2020 2020 2020 2020 2763 6f6d 6d61            'comma
-00006fd0: 6e64 273a 2027 6563 686f 2073 756d 206d  nd': 'echo sum m
-00006fe0: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
-00006ff0: 2020 2761 6674 6572 273a 205b 2761 3127    'after': ['a1'
-00007000: 2c20 2761 3227 5d2c 0a20 2020 2020 2020  , 'a2'],.       
-00007010: 2020 2020 2027 6265 666f 7265 273a 205b       'before': [
-00007020: 2762 3127 2c20 2762 3227 5d2c 0a20 2020  'b1', 'b2'],.   
-00007030: 2020 2020 2020 2020 2027 7265 7175 6972           'requir
-00007040: 6573 273a 205b 2772 3127 2c20 2772 3227  es': ['r1', 'r2'
-00007050: 5d2c 0a20 2020 2020 2020 2020 2020 2027  ],.            '
-00007060: 656e 7669 726f 6e6d 656e 7427 3a20 7b27  environment': {'
-00007070: 6b31 273a 2027 7631 272c 2027 6b32 273a  k1': 'v1', 'k2':
-00007080: 2027 7632 277d 2c0a 2020 2020 2020 2020   'v2'},.        
-00007090: 2020 2020 2775 7365 7227 3a20 2762 6f62      'user': 'bob
-000070a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000070b0: 7573 6572 2d69 6427 3a20 3130 3030 2c0a  user-id': 1000,.
-000070c0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
-000070d0: 7570 273a 2027 7374 6166 6627 2c0a 2020  up': 'staff',.  
-000070e0: 2020 2020 2020 2020 2020 2767 726f 7570            'group
-000070f0: 2d69 6427 3a20 3230 3030 2c0a 2020 2020  -id': 2000,.    
-00007100: 2020 2020 7d0a 2020 2020 2020 2020 6f6e      }.        on
-00007110: 6520 3d20 7065 6262 6c65 2e53 6572 7669  e = pebble.Servi
-00007120: 6365 2822 4e61 6d65 2031 222c 2064 290a  ce("Name 1", d).
-00007130: 2020 2020 2020 2020 7477 6f20 3d20 7065          two = pe
-00007140: 6262 6c65 2e53 6572 7669 6365 2822 4e61  bble.Service("Na
-00007150: 6d65 2031 222c 2064 290a 2020 2020 2020  me 1", d).      
-00007160: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007170: 616c 286f 6e65 2c20 7477 6f29 0a0a 2020  al(one, two)..  
-00007180: 2020 2020 2020 6173 5f64 6963 7420 3d20        as_dict = 
-00007190: 7b0a 2020 2020 2020 2020 2020 2020 2773  {.            's
-000071a0: 756d 6d61 7279 273a 2027 5375 6d20 4d61  ummary': 'Sum Ma
-000071b0: 7279 272c 0a20 2020 2020 2020 2020 2020  ry',.           
-000071c0: 2027 6465 7363 7269 7074 696f 6e27 3a20   'description': 
-000071d0: 2754 6865 206c 617a 7920 7175 6963 6b20  'The lazy quick 
-000071e0: 6272 6f77 6e27 2c0a 2020 2020 2020 2020  brown',.        
-000071f0: 2020 2020 2773 7461 7274 7570 273a 2027      'startup': '
-00007200: 5374 6172 7420 5570 272c 0a20 2020 2020  Start Up',.     
-00007210: 2020 2020 2020 2027 6f76 6572 7269 6465         'override
-00007220: 273a 2027 6f76 6572 7269 6465 272c 0a20  ': 'override',. 
-00007230: 2020 2020 2020 2020 2020 2027 636f 6d6d             'comm
-00007240: 616e 6427 3a20 2765 6368 6f20 7375 6d20  and': 'echo sum 
-00007250: 6d61 7279 272c 0a20 2020 2020 2020 2020  mary',.         
-00007260: 2020 2027 6166 7465 7227 3a20 5b27 6131     'after': ['a1
-00007270: 272c 2027 6132 275d 2c0a 2020 2020 2020  ', 'a2'],.      
-00007280: 2020 2020 2020 2762 6566 6f72 6527 3a20        'before': 
-00007290: 5b27 6231 272c 2027 6232 275d 2c0a 2020  ['b1', 'b2'],.  
-000072a0: 2020 2020 2020 2020 2020 2772 6571 7569            'requi
-000072b0: 7265 7327 3a20 5b27 7231 272c 2027 7232  res': ['r1', 'r2
-000072c0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-000072d0: 2765 6e76 6972 6f6e 6d65 6e74 273a 207b  'environment': {
-000072e0: 276b 3127 3a20 2776 3127 2c20 276b 3227  'k1': 'v1', 'k2'
-000072f0: 3a20 2776 3227 7d2c 0a20 2020 2020 2020  : 'v2'},.       
-00007300: 2020 2020 2027 7573 6572 273a 2027 626f       'user': 'bo
-00007310: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00007320: 2775 7365 722d 6964 273a 2031 3030 302c  'user-id': 1000,
-00007330: 0a20 2020 2020 2020 2020 2020 2027 6772  .            'gr
-00007340: 6f75 7027 3a20 2773 7461 6666 272c 0a20  oup': 'staff',. 
-00007350: 2020 2020 2020 2020 2020 2027 6772 6f75             'grou
-00007360: 702d 6964 273a 2032 3030 302c 0a20 2020  p-id': 2000,.   
-00007370: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
-00007380: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00007390: 6f6e 652c 2061 735f 6469 6374 290a 0a20  one, as_dict).. 
-000073a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000073b0: 7274 4e6f 7445 7175 616c 286f 6e65 2c20  rtNotEqual(one, 
-000073c0: 3529 0a0a 0a63 6c61 7373 2054 6573 7443  5)...class TestC
-000073d0: 6865 636b 2875 6e69 7474 6573 742e 5465  heck(unittest.Te
-000073e0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-000073f0: 205f 6173 7365 7274 5f65 6d70 7479 2873   _assert_empty(s
-00007400: 656c 662c 2063 6865 636b 2c20 6e61 6d65  elf, check, name
-00007410: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00007420: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-00007430: 6b2e 6e61 6d65 2c20 6e61 6d65 290a 2020  k.name, name).  
-00007440: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007450: 7445 7175 616c 2863 6865 636b 2e6f 7665  tEqual(check.ove
-00007460: 7272 6964 652c 2027 2729 0a20 2020 2020  rride, '').     
-00007470: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00007480: 7561 6c28 6368 6563 6b2e 6c65 7665 6c2c  ual(check.level,
-00007490: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
-000074a0: 656c 2e55 4e53 4554 290a 2020 2020 2020  el.UNSET).      
-000074b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000074c0: 616c 2863 6865 636b 2e70 6572 696f 642c  al(check.period,
-000074d0: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
-000074e0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-000074f0: 6563 6b2e 7469 6d65 6f75 742c 2027 2729  eck.timeout, '')
-00007500: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00007510: 7365 7274 4973 2863 6865 636b 2e74 6872  sertIs(check.thr
-00007520: 6573 686f 6c64 2c20 4e6f 6e65 290a 2020  eshold, None).  
-00007530: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007540: 7449 7328 6368 6563 6b2e 6874 7470 2c20  tIs(check.http, 
-00007550: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
-00007560: 6c66 2e61 7373 6572 7449 7328 6368 6563  lf.assertIs(chec
-00007570: 6b2e 7463 702c 204e 6f6e 6529 0a20 2020  k.tcp, None).   
-00007580: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007590: 4973 2863 6865 636b 2e65 7865 632c 204e  Is(check.exec, N
-000075a0: 6f6e 6529 0a0a 2020 2020 6465 6620 7465  one)..    def te
-000075b0: 7374 5f6e 616d 655f 6f6e 6c79 2873 656c  st_name_only(sel
-000075c0: 6629 3a0a 2020 2020 2020 2020 6368 6563  f):.        chec
-000075d0: 6b20 3d20 7065 6262 6c65 2e43 6865 636b  k = pebble.Check
-000075e0: 2827 6368 6b27 290a 2020 2020 2020 2020  ('chk').        
-000075f0: 7365 6c66 2e5f 6173 7365 7274 5f65 6d70  self._assert_emp
-00007600: 7479 2863 6865 636b 2c20 2763 686b 2729  ty(check, 'chk')
-00007610: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
-00007620: 6963 7428 7365 6c66 293a 0a20 2020 2020  ict(self):.     
-00007630: 2020 2064 203d 207b 0a20 2020 2020 2020     d = {.       
-00007640: 2020 2020 2027 6f76 6572 7269 6465 273a       'override':
-00007650: 2027 7265 706c 6163 6527 2c0a 2020 2020   'replace',.    
-00007660: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
-00007670: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
-00007680: 2020 2020 2020 2770 6572 696f 6427 3a20        'period': 
-00007690: 2731 3073 272c 0a20 2020 2020 2020 2020  '10s',.         
-000076a0: 2020 2027 7469 6d65 6f75 7427 3a20 2733     'timeout': '3
-000076b0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000076c0: 2774 6872 6573 686f 6c64 273a 2035 2c0a  'threshold': 5,.
-000076d0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-000076e0: 7420 7661 6c69 6420 666f 7220 5065 6262  t valid for Pebb
-000076f0: 6c65 2074 6f20 6861 7665 206d 6f72 6520  le to have more 
-00007700: 7468 616e 206f 6e65 206f 6620 6874 7470  than one of http
-00007710: 2c20 7463 702c 2061 6e64 2065 7865 632c  , tcp, and exec,
-00007720: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-00007730: 7574 2069 7420 6d61 6b65 7320 7468 696e  ut it makes thin
-00007740: 6773 2073 696d 706c 6572 2066 6f72 2074  gs simpler for t
-00007750: 6865 2075 6e69 7420 7465 7374 732e 0a20  he unit tests.. 
-00007760: 2020 2020 2020 2020 2020 2027 6874 7470             'http
-00007770: 273a 207b 2775 726c 273a 2027 6874 7470  ': {'url': 'http
-00007780: 733a 2f2f 6578 616d 706c 652e 636f 6d2f  s://example.com/
-00007790: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-000077a0: 2774 6370 273a 207b 2770 6f72 7427 3a20  'tcp': {'port': 
-000077b0: 3830 7d2c 0a20 2020 2020 2020 2020 2020  80},.           
-000077c0: 2027 6578 6563 273a 207b 2763 6f6d 6d61   'exec': {'comma
-000077d0: 6e64 273a 2027 6563 686f 2066 6f6f 277d  nd': 'echo foo'}
-000077e0: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-000077f0: 2020 2020 6368 6563 6b20 3d20 7065 6262      check = pebb
-00007800: 6c65 2e43 6865 636b 2827 6368 6b2d 6874  le.Check('chk-ht
-00007810: 7470 272c 2064 290a 2020 2020 2020 2020  tp', d).        
-00007820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00007830: 2863 6865 636b 2e6e 616d 652c 2027 6368  (check.name, 'ch
-00007840: 6b2d 6874 7470 2729 0a20 2020 2020 2020  k-http').       
-00007850: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007860: 6c28 6368 6563 6b2e 6f76 6572 7269 6465  l(check.override
-00007870: 2c20 2772 6570 6c61 6365 2729 0a20 2020  , 'replace').   
-00007880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007890: 4571 7561 6c28 6368 6563 6b2e 6c65 7665  Equal(check.leve
-000078a0: 6c2c 2070 6562 626c 652e 4368 6563 6b4c  l, pebble.CheckL
-000078b0: 6576 656c 2e41 4c49 5645 290a 2020 2020  evel.ALIVE).    
-000078c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000078d0: 7175 616c 2863 6865 636b 2e70 6572 696f  qual(check.perio
-000078e0: 642c 2027 3130 7327 290a 2020 2020 2020  d, '10s').      
-000078f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007900: 616c 2863 6865 636b 2e74 696d 656f 7574  al(check.timeout
-00007910: 2c20 2733 7327 290a 2020 2020 2020 2020  , '3s').        
-00007920: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00007930: 2863 6865 636b 2e74 6872 6573 686f 6c64  (check.threshold
-00007940: 2c20 3529 0a20 2020 2020 2020 2073 656c  , 5).        sel
-00007950: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00007960: 6563 6b2e 6874 7470 2c20 7b27 7572 6c27  eck.http, {'url'
-00007970: 3a20 2768 7474 7073 3a2f 2f65 7861 6d70  : 'https://examp
-00007980: 6c65 2e63 6f6d 2f27 7d29 0a20 2020 2020  le.com/'}).     
-00007990: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000079a0: 7561 6c28 6368 6563 6b2e 7463 702c 207b  ual(check.tcp, {
-000079b0: 2770 6f72 7427 3a20 3830 7d29 0a20 2020  'port': 80}).   
-000079c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000079d0: 4571 7561 6c28 6368 6563 6b2e 6578 6563  Equal(check.exec
-000079e0: 2c20 7b27 636f 6d6d 616e 6427 3a20 2765  , {'command': 'e
-000079f0: 6368 6f20 666f 6f27 7d29 0a0a 2020 2020  cho foo'})..    
-00007a00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007a10: 7175 616c 2863 6865 636b 2e74 6f5f 6469  qual(check.to_di
-00007a20: 6374 2829 2c20 6429 0a0a 2020 2020 2020  ct(), d)..      
-00007a30: 2020 2320 456e 7375 7265 2070 6562 626c    # Ensure pebbl
-00007a40: 652e 4368 6563 6b20 6861 7320 6d61 6465  e.Check has made
-00007a50: 2063 6f70 6965 7320 6f66 206d 7574 6162   copies of mutab
-00007a60: 6c65 206f 626a 6563 7473 0a20 2020 2020  le objects.     
-00007a70: 2020 2063 6865 636b 2e68 7474 705b 2775     check.http['u
-00007a80: 726c 275d 203d 2027 6874 7470 733a 2f2f  rl'] = 'https://
-00007a90: 7777 772e 676f 6f67 6c65 2e63 6f6d 270a  www.google.com'.
-00007aa0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007ab0: 6572 7445 7175 616c 2864 5b27 6874 7470  ertEqual(d['http
-00007ac0: 275d 2c20 7b27 7572 6c27 3a20 2768 7474  '], {'url': 'htt
-00007ad0: 7073 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  ps://example.com
-00007ae0: 2f27 7d29 0a20 2020 2020 2020 2063 6865  /'}).        che
-00007af0: 636b 2e74 6370 5b27 706f 7274 275d 203d  ck.tcp['port'] =
-00007b00: 2038 310a 2020 2020 2020 2020 7365 6c66   81.        self
-00007b10: 2e61 7373 6572 7445 7175 616c 2864 5b27  .assertEqual(d['
-00007b20: 7463 7027 5d2c 207b 2770 6f72 7427 3a20  tcp'], {'port': 
-00007b30: 3830 7d29 0a20 2020 2020 2020 2063 6865  80}).        che
-00007b40: 636b 2e65 7865 635b 2763 6f6d 6d61 6e64  ck.exec['command
-00007b50: 275d 203d 2027 666f 6f27 0a20 2020 2020  '] = 'foo'.     
-00007b60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00007b70: 7561 6c28 645b 2765 7865 6327 5d2c 207b  ual(d['exec'], {
-00007b80: 2763 6f6d 6d61 6e64 273a 2027 6563 686f  'command': 'echo
-00007b90: 2066 6f6f 277d 290a 0a20 2020 2064 6566   foo'})..    def
-00007ba0: 2074 6573 745f 6c65 7665 6c5f 7261 7728   test_level_raw(
-00007bb0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-00007bc0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00007bd0: 2027 6f76 6572 7269 6465 273a 2027 7265   'override': 're
-00007be0: 706c 6163 6527 2c0a 2020 2020 2020 2020  place',.        
-00007bf0: 2020 2020 276c 6576 656c 273a 2027 666f      'level': 'fo
-00007c00: 6f62 6172 2127 2c0a 2020 2020 2020 2020  obar!',.        
-00007c10: 2020 2020 2770 6572 696f 6427 3a20 2731      'period': '1
-00007c20: 3073 272c 0a20 2020 2020 2020 2020 2020  0s',.           
-00007c30: 2027 7469 6d65 6f75 7427 3a20 2733 7327   'timeout': '3s'
-00007c40: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
-00007c50: 6872 6573 686f 6c64 273a 2035 2c0a 2020  hreshold': 5,.  
-00007c60: 2020 2020 2020 2020 2020 2768 7474 7027            'http'
-00007c70: 3a20 7b27 7572 6c27 3a20 2768 7474 7073  : {'url': 'https
-00007c80: 3a2f 2f65 7861 6d70 6c65 2e63 6f6d 2f27  ://example.com/'
-00007c90: 7d2c 0a20 2020 2020 2020 207d 0a20 2020  },.        }.   
-00007ca0: 2020 2020 2063 6865 636b 203d 2070 6562       check = peb
-00007cb0: 626c 652e 4368 6563 6b28 2763 686b 2d68  ble.Check('chk-h
-00007cc0: 7474 7027 2c20 6429 0a20 2020 2020 2020  ttp', d).       
-00007cd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007ce0: 6c28 6368 6563 6b2e 6c65 7665 6c2c 2027  l(check.level, '
-00007cf0: 666f 6f62 6172 2127 2920 2023 2072 656d  foobar!')  # rem
-00007d00: 6169 6e73 2061 2073 7472 696e 670a 0a20  ains a string.. 
-00007d10: 2020 2064 6566 2074 6573 745f 6571 7561     def test_equa
-00007d20: 6c69 7479 2873 656c 6629 3a0a 2020 2020  lity(self):.    
-00007d30: 2020 2020 6420 3d20 7b0a 2020 2020 2020      d = {.      
-00007d40: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
-00007d50: 3a20 2772 6570 6c61 6365 272c 0a20 2020  : 'replace',.   
-00007d60: 2020 2020 2020 2020 2027 6c65 7665 6c27           'level'
-00007d70: 3a20 2761 6c69 7665 272c 0a20 2020 2020  : 'alive',.     
-00007d80: 2020 2020 2020 2027 7065 7269 6f64 273a         'period':
-00007d90: 2027 3130 7327 2c0a 2020 2020 2020 2020   '10s',.        
-00007da0: 2020 2020 2774 696d 656f 7574 273a 2027      'timeout': '
-00007db0: 3373 272c 0a20 2020 2020 2020 2020 2020  3s',.           
-00007dc0: 2027 7468 7265 7368 6f6c 6427 3a20 352c   'threshold': 5,
-00007dd0: 0a20 2020 2020 2020 2020 2020 2027 6874  .            'ht
-00007de0: 7470 273a 207b 2775 726c 273a 2027 6874  tp': {'url': 'ht
-00007df0: 7470 733a 2f2f 6578 616d 706c 652e 636f  tps://example.co
-00007e00: 6d2f 277d 2c0a 2020 2020 2020 2020 7d0a  m/'},.        }.
-00007e10: 2020 2020 2020 2020 6f6e 6520 3d20 7065          one = pe
-00007e20: 6262 6c65 2e43 6865 636b 2827 6f6e 6527  bble.Check('one'
-00007e30: 2c20 6429 0a20 2020 2020 2020 2074 776f  , d).        two
-00007e40: 203d 2070 6562 626c 652e 4368 6563 6b28   = pebble.Check(
-00007e50: 2774 776f 272c 2064 290a 2020 2020 2020  'two', d).      
-00007e60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007e70: 616c 286f 6e65 2c20 7477 6f29 0a20 2020  al(one, two).   
-00007e80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007e90: 4571 7561 6c28 6f6e 652c 2064 290a 2020  Equal(one, d).  
-00007ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007eb0: 7445 7175 616c 2874 776f 2c20 6429 0a20  tEqual(two, d). 
-00007ec0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007ed0: 7274 4571 7561 6c28 6f6e 652c 206f 6e65  rtEqual(one, one
-00007ee0: 2e74 6f5f 6469 6374 2829 290a 2020 2020  .to_dict()).    
-00007ef0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007f00: 7175 616c 2874 776f 2c20 7477 6f2e 746f  qual(two, two.to
-00007f10: 5f64 6963 7428 2929 0a20 2020 2020 2020  _dict()).       
-00007f20: 2064 5b27 6c65 7665 6c27 5d20 3d20 2772   d['level'] = 'r
-00007f30: 6561 6479 270a 2020 2020 2020 2020 7365  eady'.        se
-00007f40: 6c66 2e61 7373 6572 744e 6f74 4571 7561  lf.assertNotEqua
-00007f50: 6c28 6f6e 652c 2064 290a 0a20 2020 2020  l(one, d)..     
-00007f60: 2020 2073 656c 662e 6173 7365 7274 4e6f     self.assertNo
-00007f70: 7445 7175 616c 286f 6e65 2c20 3529 0a0a  tEqual(one, 5)..
-00007f80: 0a63 6c61 7373 2054 6573 7453 6572 7669  .class TestServi
-00007f90: 6365 496e 666f 2875 6e69 7474 6573 742e  ceInfo(unittest.
-00007fa0: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
-00007fb0: 6566 2074 6573 745f 7365 7276 6963 655f  ef test_service_
-00007fc0: 7374 6172 7475 7028 7365 6c66 293a 0a20  startup(self):. 
-00007fd0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007fe0: 7274 4571 7561 6c28 6c69 7374 2870 6562  rtEqual(list(peb
-00007ff0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00008000: 7570 292c 205b 0a20 2020 2020 2020 2020  up), [.         
-00008010: 2020 2070 6562 626c 652e 5365 7276 6963     pebble.Servic
-00008020: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
-00008030: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
-00008040: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
-00008050: 7475 702e 4449 5341 424c 4544 2c0a 2020  tup.DISABLED,.  
-00008060: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-00008070: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008080: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
-00008090: 5374 6172 7475 702e 454e 4142 4c45 442e  Startup.ENABLED.
-000080a0: 7661 6c75 652c 2027 656e 6162 6c65 6427  value, 'enabled'
-000080b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000080c0: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-000080d0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-000080e0: 2e44 4953 4142 4c45 442e 7661 6c75 652c  .DISABLED.value,
-000080f0: 2027 6469 7361 626c 6564 2729 0a0a 2020   'disabled')..  
-00008100: 2020 6465 6620 7465 7374 5f73 6572 7669    def test_servi
-00008110: 6365 5f73 7461 7475 7328 7365 6c66 293a  ce_status(self):
-00008120: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008130: 7365 7274 4571 7561 6c28 6c69 7374 2870  sertEqual(list(p
-00008140: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-00008150: 7475 7329 2c20 5b0a 2020 2020 2020 2020  tus), [.        
-00008160: 2020 2020 7065 6262 6c65 2e53 6572 7669      pebble.Servi
-00008170: 6365 5374 6174 7573 2e41 4354 4956 452c  ceStatus.ACTIVE,
-00008180: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
-00008190: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-000081a0: 732e 494e 4143 5449 5645 2c0a 2020 2020  s.INACTIVE,.    
-000081b0: 2020 2020 2020 2020 7065 6262 6c65 2e53          pebble.S
-000081c0: 6572 7669 6365 5374 6174 7573 2e45 5252  erviceStatus.ERR
-000081d0: 4f52 2c0a 2020 2020 2020 2020 5d29 0a20  OR,.        ]). 
-000081e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000081f0: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
-00008200: 6572 7669 6365 5374 6174 7573 2e41 4354  erviceStatus.ACT
-00008210: 4956 452e 7661 6c75 652c 2027 6163 7469  IVE.value, 'acti
-00008220: 7665 2729 0a20 2020 2020 2020 2073 656c  ve').        sel
-00008230: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00008240: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-00008250: 7573 2e49 4e41 4354 4956 452e 7661 6c75  us.INACTIVE.valu
-00008260: 652c 2027 696e 6163 7469 7665 2729 0a20  e, 'inactive'). 
-00008270: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008280: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
-00008290: 6572 7669 6365 5374 6174 7573 2e45 5252  erviceStatus.ERR
-000082a0: 4f52 2e76 616c 7565 2c20 2765 7272 6f72  OR.value, 'error
-000082b0: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-000082c0: 5f73 6572 7669 6365 5f69 6e66 6f28 7365  _service_info(se
-000082d0: 6c66 293a 0a20 2020 2020 2020 2073 203d  lf):.        s =
-000082e0: 2070 6562 626c 652e 5365 7276 6963 6549   pebble.ServiceI
-000082f0: 6e66 6f28 2773 7663 3127 2c20 7065 6262  nfo('svc1', pebb
-00008300: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
-00008310: 702e 454e 4142 4c45 442c 2070 6562 626c  p.ENABLED, pebbl
-00008320: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
-00008330: 4143 5449 5645 290a 2020 2020 2020 2020  ACTIVE).        
-00008340: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00008350: 2873 2e6e 616d 652c 2027 7376 6331 2729  (s.name, 'svc1')
-00008360: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008370: 7365 7274 4571 7561 6c28 732e 7374 6172  sertEqual(s.star
-00008380: 7475 702c 2070 6562 626c 652e 5365 7276  tup, pebble.Serv
-00008390: 6963 6553 7461 7274 7570 2e45 4e41 424c  iceStartup.ENABL
-000083a0: 4544 290a 2020 2020 2020 2020 7365 6c66  ED).        self
-000083b0: 2e61 7373 6572 7445 7175 616c 2873 2e63  .assertEqual(s.c
-000083c0: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
-000083d0: 6572 7669 6365 5374 6174 7573 2e41 4354  erviceStatus.ACT
-000083e0: 4956 4529 0a0a 2020 2020 2020 2020 7320  IVE)..        s 
-000083f0: 3d20 7065 6262 6c65 2e53 6572 7669 6365  = pebble.Service
-00008400: 496e 666f 280a 2020 2020 2020 2020 2020  Info(.          
-00008410: 2020 2773 7663 3127 2c0a 2020 2020 2020    'svc1',.      
-00008420: 2020 2020 2020 7065 6262 6c65 2e53 6572        pebble.Ser
-00008430: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
-00008440: 4c45 442c 0a20 2020 2020 2020 2020 2020  LED,.           
-00008450: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
-00008460: 7461 7475 732e 4143 5449 5645 290a 2020  tatus.ACTIVE).  
-00008470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00008480: 7445 7175 616c 2873 2e6e 616d 652c 2027  tEqual(s.name, '
-00008490: 7376 6331 2729 0a20 2020 2020 2020 2073  svc1').        s
-000084a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000084b0: 732e 7374 6172 7475 702c 2070 6562 626c  s.startup, pebbl
-000084c0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-000084d0: 2e45 4e41 424c 4544 290a 2020 2020 2020  .ENABLED).      
-000084e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000084f0: 616c 2873 2e63 7572 7265 6e74 2c20 7065  al(s.current, pe
-00008500: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-00008510: 7573 2e41 4354 4956 4529 0a0a 2020 2020  us.ACTIVE)..    
-00008520: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
-00008530: 6572 7669 6365 496e 666f 2e66 726f 6d5f  erviceInfo.from_
-00008540: 6469 6374 287b 0a20 2020 2020 2020 2020  dict({.         
-00008550: 2020 2027 6e61 6d65 273a 2027 7376 6332     'name': 'svc2
-00008560: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00008570: 7374 6172 7475 7027 3a20 2764 6973 6162  startup': 'disab
-00008580: 6c65 6427 2c0a 2020 2020 2020 2020 2020  led',.          
-00008590: 2020 2763 7572 7265 6e74 273a 2027 696e    'current': 'in
-000085a0: 6163 7469 7665 272c 0a20 2020 2020 2020  active',.       
-000085b0: 207d 290a 2020 2020 2020 2020 7365 6c66   }).        self
-000085c0: 2e61 7373 6572 7445 7175 616c 2873 2e6e  .assertEqual(s.n
-000085d0: 616d 652c 2027 7376 6332 2729 0a20 2020  ame, 'svc2').   
-000085e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000085f0: 4571 7561 6c28 732e 7374 6172 7475 702c  Equal(s.startup,
-00008600: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
-00008610: 7461 7274 7570 2e44 4953 4142 4c45 4429  tartup.DISABLED)
-00008620: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008630: 7365 7274 4571 7561 6c28 732e 6375 7272  sertEqual(s.curr
-00008640: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
-00008650: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
-00008660: 5645 290a 0a20 2020 2020 2020 2073 203d  VE)..        s =
-00008670: 2070 6562 626c 652e 5365 7276 6963 6549   pebble.ServiceI
-00008680: 6e66 6f2e 6672 6f6d 5f64 6963 7428 7b0a  nfo.from_dict({.
-00008690: 2020 2020 2020 2020 2020 2020 276e 616d              'nam
-000086a0: 6527 3a20 2773 7663 3227 2c0a 2020 2020  e': 'svc2',.    
-000086b0: 2020 2020 2020 2020 2773 7461 7274 7570          'startup
-000086c0: 273a 2027 7468 696e 6779 272c 0a20 2020  ': 'thingy',.   
-000086d0: 2020 2020 2020 2020 2027 6375 7272 656e           'curren
-000086e0: 7427 3a20 2762 6f62 272c 0a20 2020 2020  t': 'bob',.     
-000086f0: 2020 207d 290a 2020 2020 2020 2020 7365     }).        se
-00008700: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00008710: 2e6e 616d 652c 2027 7376 6332 2729 0a20  .name, 'svc2'). 
-00008720: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008730: 7274 4571 7561 6c28 732e 7374 6172 7475  rtEqual(s.startu
-00008740: 702c 2027 7468 696e 6779 2729 0a20 2020  p, 'thingy').   
-00008750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008760: 4571 7561 6c28 732e 6375 7272 656e 742c  Equal(s.current,
-00008770: 2027 626f 6227 290a 0a20 2020 2064 6566   'bob')..    def
-00008780: 2074 6573 745f 6973 5f72 756e 6e69 6e67   test_is_running
-00008790: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000087a0: 7320 3d20 7065 6262 6c65 2e53 6572 7669  s = pebble.Servi
-000087b0: 6365 496e 666f 2827 7327 2c20 7065 6262  ceInfo('s', pebb
-000087c0: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
-000087d0: 702e 454e 4142 4c45 442c 2070 6562 626c  p.ENABLED, pebbl
-000087e0: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
-000087f0: 4143 5449 5645 290a 2020 2020 2020 2020  ACTIVE).        
-00008800: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00008810: 732e 6973 5f72 756e 6e69 6e67 2829 290a  s.is_running()).
-00008820: 2020 2020 2020 2020 666f 7220 6375 7272          for curr
-00008830: 656e 7420 696e 205b 7065 6262 6c65 2e53  ent in [pebble.S
-00008840: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-00008850: 4354 4956 452c 2070 6562 626c 652e 5365  CTIVE, pebble.Se
-00008860: 7276 6963 6553 7461 7475 732e 4552 524f  rviceStatus.ERRO
-00008870: 522c 2027 6f74 6865 7227 5d3a 0a20 2020  R, 'other']:.   
-00008880: 2020 2020 2020 2020 2073 203d 2070 6562           s = peb
-00008890: 626c 652e 5365 7276 6963 6549 6e66 6f28  ble.ServiceInfo(
-000088a0: 2773 272c 2070 6562 626c 652e 5365 7276  's', pebble.Serv
-000088b0: 6963 6553 7461 7274 7570 2e45 4e41 424c  iceStartup.ENABL
-000088c0: 4544 2c20 6375 7272 656e 7429 0a20 2020  ED, current).   
-000088d0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-000088e0: 7365 7274 4661 6c73 6528 732e 6973 5f72  sertFalse(s.is_r
-000088f0: 756e 6e69 6e67 2829 290a 0a0a 636c 6173  unning())...clas
-00008900: 7320 5465 7374 4368 6563 6b49 6e66 6f28  s TestCheckInfo(
-00008910: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
-00008920: 6529 3a0a 2020 2020 6465 6620 7465 7374  e):.    def test
-00008930: 5f63 6865 636b 5f6c 6576 656c 2873 656c  _check_level(sel
-00008940: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00008950: 2e61 7373 6572 7445 7175 616c 286c 6973  .assertEqual(lis
-00008960: 7428 7065 6262 6c65 2e43 6865 636b 4c65  t(pebble.CheckLe
-00008970: 7665 6c29 2c20 5b0a 2020 2020 2020 2020  vel), [.        
-00008980: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
-00008990: 4c65 7665 6c2e 554e 5345 542c 0a20 2020  Level.UNSET,.   
-000089a0: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
-000089b0: 4368 6563 6b4c 6576 656c 2e41 4c49 5645  CheckLevel.ALIVE
-000089c0: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
-000089d0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
-000089e0: 5245 4144 592c 0a20 2020 2020 2020 205d  READY,.        ]
-000089f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008a00: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-00008a10: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
-00008a20: 4554 2e76 616c 7565 2c20 2727 290a 2020  ET.value, '').  
-00008a30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00008a40: 7445 7175 616c 2870 6562 626c 652e 4368  tEqual(pebble.Ch
-00008a50: 6563 6b4c 6576 656c 2e41 4c49 5645 2e76  eckLevel.ALIVE.v
-00008a60: 616c 7565 2c20 2761 6c69 7665 2729 0a20  alue, 'alive'). 
-00008a70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008a80: 7274 4571 7561 6c28 7065 6262 6c65 2e43  rtEqual(pebble.C
-00008a90: 6865 636b 4c65 7665 6c2e 5245 4144 592e  heckLevel.READY.
-00008aa0: 7661 6c75 652c 2027 7265 6164 7927 290a  value, 'ready').
-00008ab0: 0a20 2020 2064 6566 2074 6573 745f 6368  .    def test_ch
-00008ac0: 6563 6b5f 7374 6174 7573 2873 656c 6629  eck_status(self)
-00008ad0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-00008ae0: 7373 6572 7445 7175 616c 286c 6973 7428  ssertEqual(list(
-00008af0: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
-00008b00: 7573 292c 205b 0a20 2020 2020 2020 2020  us), [.         
-00008b10: 2020 2070 6562 626c 652e 4368 6563 6b53     pebble.CheckS
-00008b20: 7461 7475 732e 5550 2c0a 2020 2020 2020  tatus.UP,.      
-00008b30: 2020 2020 2020 7065 6262 6c65 2e43 6865        pebble.Che
-00008b40: 636b 5374 6174 7573 2e44 4f57 4e2c 0a20  ckStatus.DOWN,. 
-00008b50: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-00008b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008b70: 616c 2870 6562 626c 652e 4368 6563 6b53  al(pebble.CheckS
-00008b80: 7461 7475 732e 5550 2e76 616c 7565 2c20  tatus.UP.value, 
-00008b90: 2775 7027 290a 2020 2020 2020 2020 7365  'up').        se
-00008ba0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00008bb0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-00008bc0: 732e 444f 574e 2e76 616c 7565 2c20 2764  s.DOWN.value, 'd
-00008bd0: 6f77 6e27 290a 0a20 2020 2064 6566 2074  own')..    def t
-00008be0: 6573 745f 6368 6563 6b5f 696e 666f 2873  est_check_info(s
-00008bf0: 656c 6629 3a0a 2020 2020 2020 2020 6368  elf):.        ch
-00008c00: 6563 6b20 3d20 7065 6262 6c65 2e43 6865  eck = pebble.Che
-00008c10: 636b 496e 666f 280a 2020 2020 2020 2020  ckInfo(.        
-00008c20: 2020 2020 6e61 6d65 3d27 6368 6b31 272c      name='chk1',
-00008c30: 0a20 2020 2020 2020 2020 2020 206c 6576  .            lev
-00008c40: 656c 3d70 6562 626c 652e 4368 6563 6b4c  el=pebble.CheckL
-00008c50: 6576 656c 2e52 4541 4459 2c0a 2020 2020  evel.READY,.    
-00008c60: 2020 2020 2020 2020 7374 6174 7573 3d70          status=p
-00008c70: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-00008c80: 732e 5550 2c0a 2020 2020 2020 2020 2020  s.UP,.          
-00008c90: 2020 7468 7265 7368 6f6c 643d 332c 0a20    threshold=3,. 
-00008ca0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008cb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008cc0: 6c28 6368 6563 6b2e 6e61 6d65 2c20 2763  l(check.name, 'c
-00008cd0: 686b 3127 290a 2020 2020 2020 2020 7365  hk1').        se
-00008ce0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00008cf0: 6865 636b 2e6c 6576 656c 2c20 7065 6262  heck.level, pebb
-00008d00: 6c65 2e43 6865 636b 4c65 7665 6c2e 5245  le.CheckLevel.RE
-00008d10: 4144 5929 0a20 2020 2020 2020 2073 656c  ADY).        sel
-00008d20: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00008d30: 6563 6b2e 7374 6174 7573 2c20 7065 6262  eck.status, pebb
-00008d40: 6c65 2e43 6865 636b 5374 6174 7573 2e55  le.CheckStatus.U
-00008d50: 5029 0a20 2020 2020 2020 2073 656c 662e  P).        self.
-00008d60: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-00008d70: 6b2e 6661 696c 7572 6573 2c20 3029 0a20  k.failures, 0). 
-00008d80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008d90: 7274 4571 7561 6c28 6368 6563 6b2e 7468  rtEqual(check.th
-00008da0: 7265 7368 6f6c 642c 2033 290a 0a20 2020  reshold, 3)..   
-00008db0: 2020 2020 2063 6865 636b 203d 2070 6562       check = peb
-00008dc0: 626c 652e 4368 6563 6b49 6e66 6f28 0a20  ble.CheckInfo(. 
-00008dd0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00008de0: 2763 686b 3227 2c0a 2020 2020 2020 2020  'chk2',.        
-00008df0: 2020 2020 6c65 7665 6c3d 7065 6262 6c65      level=pebble
-00008e00: 2e43 6865 636b 4c65 7665 6c2e 414c 4956  .CheckLevel.ALIV
-00008e10: 452c 0a20 2020 2020 2020 2020 2020 2073  E,.            s
-00008e20: 7461 7475 733d 7065 6262 6c65 2e43 6865  tatus=pebble.Che
-00008e30: 636b 5374 6174 7573 2e44 4f57 4e2c 0a20  ckStatus.DOWN,. 
-00008e40: 2020 2020 2020 2020 2020 2066 6169 6c75             failu
-00008e50: 7265 733d 352c 0a20 2020 2020 2020 2020  res=5,.         
-00008e60: 2020 2074 6872 6573 686f 6c64 3d33 2c0a     threshold=3,.
-00008e70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00008e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008e90: 616c 2863 6865 636b 2e6e 616d 652c 2027  al(check.name, '
-00008ea0: 6368 6b32 2729 0a20 2020 2020 2020 2073  chk2').        s
-00008eb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008ec0: 6368 6563 6b2e 6c65 7665 6c2c 2070 6562  check.level, peb
-00008ed0: 626c 652e 4368 6563 6b4c 6576 656c 2e41  ble.CheckLevel.A
-00008ee0: 4c49 5645 290a 2020 2020 2020 2020 7365  LIVE).        se
-00008ef0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00008f00: 6865 636b 2e73 7461 7475 732c 2070 6562  heck.status, peb
-00008f10: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-00008f20: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
-00008f30: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00008f40: 6865 636b 2e66 6169 6c75 7265 732c 2035  heck.failures, 5
-00008f50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008f60: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-00008f70: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
-00008f80: 2020 2020 2020 2020 6368 6563 6b20 3d20          check = 
-00008f90: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
-00008fa0: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
-00008fb0: 2020 2020 2020 2020 2027 6e61 6d65 273a           'name':
-00008fc0: 2027 6368 6b33 272c 0a20 2020 2020 2020   'chk3',.       
-00008fd0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
-00008fe0: 7570 272c 0a20 2020 2020 2020 2020 2020  up',.           
-00008ff0: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
-00009000: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00009010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00009020: 7175 616c 2863 6865 636b 2e6e 616d 652c  qual(check.name,
-00009030: 2027 6368 6b33 2729 0a20 2020 2020 2020   'chk3').       
-00009040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00009050: 6c28 6368 6563 6b2e 6c65 7665 6c2c 2070  l(check.level, p
-00009060: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
-00009070: 2e55 4e53 4554 290a 2020 2020 2020 2020  .UNSET).        
-00009080: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00009090: 2863 6865 636b 2e73 7461 7475 732c 2070  (check.status, p
-000090a0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-000090b0: 732e 5550 290a 2020 2020 2020 2020 7365  s.UP).        se
-000090c0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-000090d0: 6865 636b 2e66 6169 6c75 7265 732c 2030  heck.failures, 0
-000090e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000090f0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-00009100: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
-00009110: 2020 2020 2020 2020 6368 6563 6b20 3d20          check = 
-00009120: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
-00009130: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
-00009140: 2020 2020 2020 2020 2027 6e61 6d65 273a           'name':
-00009150: 2027 6368 6b34 272c 0a20 2020 2020 2020   'chk4',.       
-00009160: 2020 2020 2027 6c65 7665 6c27 3a20 7065       'level': pe
-00009170: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
-00009180: 554e 5345 542c 0a20 2020 2020 2020 2020  UNSET,.         
-00009190: 2020 2027 7374 6174 7573 273a 2070 6562     'status': peb
-000091a0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-000091b0: 444f 574e 2c0a 2020 2020 2020 2020 2020  DOWN,.          
-000091c0: 2020 2766 6169 6c75 7265 7327 3a20 332c    'failures': 3,
-000091d0: 0a20 2020 2020 2020 2020 2020 2027 7468  .            'th
-000091e0: 7265 7368 6f6c 6427 3a20 332c 0a20 2020  reshold': 3,.   
-000091f0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
-00009200: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00009210: 2863 6865 636b 2e6e 616d 652c 2027 6368  (check.name, 'ch
-00009220: 6b34 2729 0a20 2020 2020 2020 2073 656c  k4').        sel
-00009230: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00009240: 6563 6b2e 6c65 7665 6c2c 2070 6562 626c  eck.level, pebbl
-00009250: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
-00009260: 4554 290a 2020 2020 2020 2020 7365 6c66  ET).        self
-00009270: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00009280: 636b 2e73 7461 7475 732c 2070 6562 626c  ck.status, pebbl
-00009290: 652e 4368 6563 6b53 7461 7475 732e 444f  e.CheckStatus.DO
-000092a0: 574e 290a 2020 2020 2020 2020 7365 6c66  WN).        self
-000092b0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-000092c0: 636b 2e66 6169 6c75 7265 732c 2033 290a  ck.failures, 3).
-000092d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000092e0: 6572 7445 7175 616c 2863 6865 636b 2e74  ertEqual(check.t
-000092f0: 6872 6573 686f 6c64 2c20 3329 0a0a 0a63  hreshold, 3)...c
-00009300: 6c61 7373 204d 6f63 6b43 6c69 656e 7428  lass MockClient(
-00009310: 7065 6262 6c65 2e43 6c69 656e 7429 3a0a  pebble.Client):.
-00009320: 2020 2020 2222 224d 6f63 6b20 5065 6262      """Mock Pebb
-00009330: 6c65 2063 6c69 656e 7420 7468 6174 2073  le client that s
-00009340: 696d 706c 7920 7265 636f 7264 7320 7265  imply records re
-00009350: 7175 6573 7473 2061 6e64 2072 6574 7572  quests and retur
-00009360: 6e73 2073 746f 7265 6420 7265 7370 6f6e  ns stored respon
-00009370: 7365 732e 2222 220a 0a20 2020 2064 6566  ses."""..    def
-00009380: 205f 5f69 6e69 745f 5f28 7365 6c66 293a   __init__(self):
-00009390: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-000093a0: 7175 6573 7473 203d 205b 5d0a 2020 2020  quests = [].    
-000093b0: 2020 2020 7365 6c66 2e72 6573 706f 6e73      self.respons
-000093c0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-000093d0: 7365 6c66 2e74 696d 656f 7574 203d 2035  self.timeout = 5
-000093e0: 0a20 2020 2020 2020 2073 656c 662e 7765  .        self.we
-000093f0: 6273 6f63 6b65 7473 203d 207b 7d0a 0a20  bsockets = {}.. 
-00009400: 2020 2064 6566 205f 7265 7175 6573 7428     def _request(
-00009410: 7365 6c66 2c20 6d65 7468 6f64 2c20 7061  self, method, pa
-00009420: 7468 2c20 7175 6572 793d 4e6f 6e65 2c20  th, query=None, 
-00009430: 626f 6479 3d4e 6f6e 6529 3a0a 2020 2020  body=None):.    
-00009440: 2020 2020 7365 6c66 2e72 6571 7565 7374      self.request
-00009450: 732e 6170 7065 6e64 2828 6d65 7468 6f64  s.append((method
-00009460: 2c20 7061 7468 2c20 7175 6572 792c 2062  , path, query, b
-00009470: 6f64 7929 290a 2020 2020 2020 2020 7265  ody)).        re
-00009480: 7370 203d 2073 656c 662e 7265 7370 6f6e  sp = self.respon
-00009490: 7365 732e 706f 7028 3029 0a20 2020 2020  ses.pop(0).     
-000094a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000094b0: 2872 6573 702c 2045 7863 6570 7469 6f6e  (resp, Exception
-000094c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000094d0: 6169 7365 2072 6573 700a 2020 2020 2020  aise resp.      
-000094e0: 2020 6966 2063 616c 6c61 626c 6528 7265    if callable(re
-000094f0: 7370 293a 0a20 2020 2020 2020 2020 2020  sp):.           
-00009500: 2072 6573 7020 3d20 7265 7370 2829 0a20   resp = resp(). 
-00009510: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00009520: 7370 0a0a 2020 2020 6465 6620 5f72 6571  sp..    def _req
-00009530: 7565 7374 5f72 6177 2873 656c 662c 206d  uest_raw(self, m
-00009540: 6574 686f 642c 2070 6174 682c 2071 7565  ethod, path, que
-00009550: 7279 3d4e 6f6e 652c 2068 6561 6465 7273  ry=None, headers
-00009560: 3d4e 6f6e 652c 2064 6174 613d 4e6f 6e65  =None, data=None
-00009570: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00009580: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-00009590: 286d 6574 686f 642c 2070 6174 682c 2071  (method, path, q
-000095a0: 7565 7279 2c20 6865 6164 6572 732c 2064  uery, headers, d
-000095b0: 6174 6129 290a 2020 2020 2020 2020 6865  ata)).        he
-000095c0: 6164 6572 732c 2062 6f64 7920 3d20 7365  aders, body = se
-000095d0: 6c66 2e72 6573 706f 6e73 6573 2e70 6f70  lf.responses.pop
-000095e0: 2830 290a 2020 2020 2020 2020 7265 7475  (0).        retu
-000095f0: 726e 204d 6f63 6b48 5454 5052 6573 706f  rn MockHTTPRespo
-00009600: 6e73 6528 6865 6164 6572 732c 2062 6f64  nse(headers, bod
-00009610: 7929 0a0a 2020 2020 6465 6620 5f63 6f6e  y)..    def _con
-00009620: 6e65 6374 5f77 6562 736f 636b 6574 2873  nect_websocket(s
-00009630: 656c 662c 2074 6173 6b5f 6964 2c20 7765  elf, task_id, we
-00009640: 6273 6f63 6b65 745f 6964 293a 0a20 2020  bsocket_id):.   
-00009650: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00009660: 2e77 6562 736f 636b 6574 735b 7461 736b  .websockets[task
-00009670: 5f69 642c 2077 6562 736f 636b 6574 5f69  _id, websocket_i
-00009680: 645d 0a0a 0a63 6c61 7373 204d 6f63 6b48  d]...class MockH
-00009690: 5454 5052 6573 706f 6e73 653a 0a20 2020  TTPResponse:.   
-000096a0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-000096b0: 6c66 2c20 6865 6164 6572 732c 2062 6f64  lf, headers, bod
-000096c0: 7929 3a0a 2020 2020 2020 2020 7365 6c66  y):.        self
-000096d0: 2e68 6561 6465 7273 203d 2068 6561 6465  .headers = heade
-000096e0: 7273 0a20 2020 2020 2020 2072 6561 6465  rs.        reade
-000096f0: 7220 3d20 696f 2e42 7974 6573 494f 2862  r = io.BytesIO(b
-00009700: 6f64 7929 0a20 2020 2020 2020 2073 656c  ody).        sel
-00009710: 662e 7265 6164 203d 2072 6561 6465 722e  f.read = reader.
-00009720: 7265 6164 0a0a 0a63 6c61 7373 204d 6f63  read...class Moc
-00009730: 6b54 696d 653a 0a20 2020 2022 2222 4d6f  kTime:.    """Mo
-00009740: 636b 6564 2076 6572 7369 6f6e 7320 6f66  cked versions of
-00009750: 2074 696d 652e 7469 6d65 2829 2061 6e64   time.time() and
-00009760: 2074 696d 652e 736c 6565 7028 292e 0a0a   time.sleep()...
-00009770: 2020 2020 4d6f 636b 5469 6d65 2e73 6c65      MockTime.sle
-00009780: 6570 2829 2061 6476 616e 6365 7320 7468  ep() advances th
-00009790: 6520 636c 6f63 6b20 616e 6420 4d6f 636b  e clock and Mock
-000097a0: 5469 6d65 2e74 696d 6528 2920 7265 7475  Time.time() retu
-000097b0: 726e 7320 7468 6520 6375 7272 656e 7420  rns the current 
-000097c0: 7469 6d65 2e0a 2020 2020 2222 220a 0a20  time..    """.. 
-000097d0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-000097e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-000097f0: 656c 662e 5f74 696d 6520 3d20 300a 0a20  elf._time = 0.. 
-00009800: 2020 2064 6566 2074 696d 6528 7365 6c66     def time(self
-00009810: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00009820: 6e20 7365 6c66 2e5f 7469 6d65 0a0a 2020  n self._time..  
-00009830: 2020 6465 6620 736c 6565 7028 7365 6c66    def sleep(self
-00009840: 2c20 6465 6c61 7929 3a0a 2020 2020 2020  , delay):.      
-00009850: 2020 7365 6c66 2e5f 7469 6d65 202b 3d20    self._time += 
-00009860: 6465 6c61 790a 0a0a 6465 6620 6275 696c  delay...def buil
-00009870: 645f 6d6f 636b 5f63 6861 6e67 655f 6469  d_mock_change_di
-00009880: 6374 2863 6861 6e67 655f 6964 3d27 3730  ct(change_id='70
-00009890: 2729 3a0a 2020 2020 7265 7475 726e 207b  '):.    return {
-000098a0: 0a20 2020 2020 2020 2022 6964 223a 2063  .        "id": c
-000098b0: 6861 6e67 655f 6964 2c0a 2020 2020 2020  hange_id,.      
-000098c0: 2020 226b 696e 6422 3a20 2261 7574 6f73    "kind": "autos
-000098d0: 7461 7274 222c 0a20 2020 2020 2020 2022  tart",.        "
-000098e0: 7265 6164 7922 3a20 5472 7565 2c0a 2020  ready": True,.  
-000098f0: 2020 2020 2020 2272 6561 6479 2d74 696d        "ready-tim
-00009900: 6522 3a20 2232 3032 312d 3031 2d32 3854  e": "2021-01-28T
-00009910: 3134 3a33 373a 3034 2e32 3931 3531 3737  14:37:04.2915177
-00009920: 3638 2b31 333a 3030 222c 0a20 2020 2020  68+13:00",.     
-00009930: 2020 2022 7370 6177 6e2d 7469 6d65 223a     "spawn-time":
-00009940: 2022 3230 3231 2d30 312d 3238 5431 343a   "2021-01-28T14:
-00009950: 3337 3a30 322e 3234 3732 3032 3130 352b  37:02.247202105+
-00009960: 3133 3a30 3022 2c0a 2020 2020 2020 2020  13:00",.        
-00009970: 2273 7461 7475 7322 3a20 2244 6f6e 6522  "status": "Done"
-00009980: 2c0a 2020 2020 2020 2020 2273 756d 6d61  ,.        "summa
-00009990: 7279 223a 2027 4175 746f 7374 6172 7420  ry": 'Autostart 
-000099a0: 7365 7276 6963 6520 2273 7663 2227 2c0a  service "svc"',.
-000099b0: 2020 2020 2020 2020 2274 6173 6b73 223a          "tasks":
-000099c0: 205b 0a20 2020 2020 2020 2020 2020 207b   [.            {
-000099d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000099e0: 2022 6964 223a 2022 3738 222c 0a20 2020   "id": "78",.   
-000099f0: 2020 2020 2020 2020 2020 2020 2022 6b69               "ki
-00009a00: 6e64 223a 2022 7374 6172 7422 2c0a 2020  nd": "start",.  
-00009a10: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-00009a20: 726f 6772 6573 7322 3a20 7b0a 2020 2020  rogress": {.    
-00009a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a40: 2264 6f6e 6522 3a20 312c 0a20 2020 2020  "done": 1,.     
-00009a50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00009a60: 6c61 6265 6c22 3a20 2222 2c0a 2020 2020  label": "",.    
-00009a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a80: 2274 6f74 616c 223a 2031 2c0a 2020 2020  "total": 1,.    
-00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009aa0: 2265 7874 7261 2d66 6965 6c64 223a 2022  "extra-field": "
-00009ab0: 666f 6f22 2c0a 2020 2020 2020 2020 2020  foo",.          
-00009ac0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00009ad0: 2020 2020 2020 2020 2022 7265 6164 792d           "ready-
-00009ae0: 7469 6d65 223a 2022 3230 3231 2d30 312d  time": "2021-01-
-00009af0: 3238 5431 343a 3337 3a30 332e 3237 3032  28T14:37:03.2702
-00009b00: 3138 3737 382b 3133 3a30 3022 2c0a 2020  18778+13:00",.  
-00009b10: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00009b20: 7061 776e 2d74 696d 6522 3a20 2232 3032  pawn-time": "202
-00009b30: 312d 3031 2d32 3854 3134 3a33 373a 3032  1-01-28T14:37:02
-00009b40: 2e32 3437 3135 3831 3632 2b31 333a 3030  .247158162+13:00
-00009b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00009b60: 2020 2022 7374 6174 7573 223a 2022 446f     "status": "Do
-00009b70: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
-00009b80: 2020 2020 2022 7375 6d6d 6172 7922 3a20       "summary": 
-00009b90: 2753 7461 7274 2073 6572 7669 6365 2022  'Start service "
-00009ba0: 7376 6322 272c 0a20 2020 2020 2020 2020  svc"',.         
-00009bb0: 2020 2020 2020 2022 6578 7472 612d 6669         "extra-fi
-00009bc0: 656c 6422 3a20 2266 6f6f 222c 0a20 2020  eld": "foo",.   
-00009bd0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00009be0: 2020 2020 5d2c 0a20 2020 2020 2020 2022      ],.        "
-00009bf0: 6578 7472 612d 6669 656c 6422 3a20 2266  extra-field": "f
-00009c00: 6f6f 222c 0a20 2020 207d 0a0a 0a63 6c61  oo",.    }...cla
-00009c10: 7373 2054 6573 744d 756c 7469 7061 7274  ss TestMultipart
-00009c20: 5061 7273 6572 2875 6e69 7474 6573 742e  Parser(unittest.
-00009c30: 5465 7374 4361 7365 293a 0a20 2020 2063  TestCase):.    c
-00009c40: 6c61 7373 205f 4361 7365 3a0a 2020 2020  lass _Case:.    
-00009c50: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00009c60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00009c70: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00009c80: 2020 2020 2020 2020 6e61 6d65 2c0a 2020          name,.  
-00009c90: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00009ca0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00009cb0: 2020 2020 7761 6e74 5f68 6561 6465 7273      want_headers
-00009cc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009cd0: 2020 7761 6e74 5f62 6f64 6965 732c 0a20    want_bodies,. 
-00009ce0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00009cf0: 616e 745f 626f 6469 6573 5f64 6f6e 652c  ant_bodies_done,
-00009d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009d10: 206d 6178 5f62 6f75 6e64 6172 793d 3134   max_boundary=14
-00009d20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009d30: 2020 6d61 785f 6c6f 6f6b 6168 6561 643d    max_lookahead=
-00009d40: 3820 2a20 3130 3234 2c0a 2020 2020 2020  8 * 1024,.      
-00009d50: 2020 2020 2020 2020 2020 6572 726f 723d            error=
-00009d60: 2727 293a 0a20 2020 2020 2020 2020 2020  ''):.           
-00009d70: 2073 656c 662e 6e61 6d65 203d 206e 616d   self.name = nam
-00009d80: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
-00009d90: 6c66 2e64 6174 6120 3d20 6461 7461 0a20  lf.data = data. 
-00009da0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00009db0: 7761 6e74 5f68 6561 6465 7273 203d 2077  want_headers = w
-00009dc0: 616e 745f 6865 6164 6572 730a 2020 2020  ant_headers.    
-00009dd0: 2020 2020 2020 2020 7365 6c66 2e77 616e          self.wan
-00009de0: 745f 626f 6469 6573 203d 2077 616e 745f  t_bodies = want_
-00009df0: 626f 6469 6573 0a20 2020 2020 2020 2020  bodies.         
-00009e00: 2020 2073 656c 662e 7761 6e74 5f62 6f64     self.want_bod
-00009e10: 6965 735f 646f 6e65 203d 2077 616e 745f  ies_done = want_
-00009e20: 626f 6469 6573 5f64 6f6e 650a 2020 2020  bodies_done.    
-00009e30: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
-00009e40: 5f62 6f75 6e64 6172 7920 3d20 6d61 785f  _boundary = max_
-00009e50: 626f 756e 6461 7279 0a20 2020 2020 2020  boundary.       
-00009e60: 2020 2020 2073 656c 662e 6d61 785f 6c6f       self.max_lo
-00009e70: 6f6b 6168 6561 6420 3d20 6d61 785f 6c6f  okahead = max_lo
-00009e80: 6f6b 6168 6561 640a 2020 2020 2020 2020  okahead.        
-00009e90: 2020 2020 7365 6c66 2e65 7272 6f72 203d      self.error =
-00009ea0: 2065 7272 6f72 0a0a 2020 2020 6465 6620   error..    def 
-00009eb0: 7465 7374 5f6d 756c 7469 7061 7274 5f70  test_multipart_p
-00009ec0: 6172 7365 7228 7365 6c66 293a 0a20 2020  arser(self):.   
-00009ed0: 2020 2020 2074 6573 7473 203d 205b 0a20       tests = [. 
-00009ee0: 2020 2020 2020 2020 2020 2054 6573 744d             TestM
-00009ef0: 756c 7469 7061 7274 5061 7273 6572 2e5f  ultipartParser._
-00009f00: 4361 7365 280a 2020 2020 2020 2020 2020  Case(.          
-00009f10: 2020 2020 2020 2762 6173 656c 696e 6527        'baseline'
-00009f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009f30: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
-00009f40: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
-00009f50: 5c6e 5c72 5c6e 666f 6f20 6261 725c 6e66  \n\r\nfoo bar\nf
-00009f60: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
-00009f70: 7479 2d2d 5c72 5c6e 272c 0a20 2020 2020  ty--\r\n',.     
-00009f80: 2020 2020 2020 2020 2020 205b 6227 6865             [b'he
-00009f90: 6164 6572 2066 6f6f 5c72 5c6e 5c72 5c6e  ader foo\r\n\r\n
-00009fa0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00009fb0: 2020 2020 5b62 2766 6f6f 2062 6172 5c6e      [b'foo bar\n
-00009fc0: 666f 6f20 6261 7227 5d2c 0a20 2020 2020  foo bar'],.     
-00009fd0: 2020 2020 2020 2020 2020 2077 616e 745f             want_
-00009fe0: 626f 6469 6573 5f64 6f6e 653d 5b54 7275  bodies_done=[Tru
-00009ff0: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
-0000a000: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
-0000a010: 6573 744d 756c 7469 7061 7274 5061 7273  estMultipartPars
-0000a020: 6572 2e5f 4361 7365 280a 2020 2020 2020  er._Case(.      
-0000a030: 2020 2020 2020 2020 2020 2769 6e63 6f6d            'incom
-0000a040: 706c 6574 6520 6865 6164 6572 272c 0a20  plete header',. 
-0000a050: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000a060: 275c 725c 6e2d 2d71 7765 7274 795c 725c  '\r\n--qwerty\r\
-0000a070: 6e68 6561 6465 7220 666f 6f5c 725c 6e27  nheader foo\r\n'
-0000a080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a090: 2020 5b5d 2c0a 2020 2020 2020 2020 2020    [],.          
-0000a0a0: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
-0000a0b0: 2020 2020 2020 2020 2020 7761 6e74 5f62            want_b
-0000a0c0: 6f64 6965 735f 646f 6e65 3d5b 5d2c 0a20  odies_done=[],. 
-0000a0d0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0000a0e0: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
-0000a0f0: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
-0000a100: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
-0000a110: 2020 2020 2027 6d69 7373 696e 6720 6865       'missing he
-0000a120: 6164 6572 272c 0a20 2020 2020 2020 2020  ader',.         
-0000a130: 2020 2020 2020 2062 275c 725c 6e2d 2d71         b'\r\n--q
-0000a140: 7765 7274 795c 725c 6e68 6561 6465 7220  werty\r\nheader 
-0000a150: 666f 6f5c 725c 6e27 202b 2034 3020 2a20  foo\r\n' + 40 * 
-0000a160: 6227 2027 2c0a 2020 2020 2020 2020 2020  b' ',.          
-0000a170: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
-0000a180: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
-0000a190: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-0000a1a0: 6e74 5f62 6f64 6965 735f 646f 6e65 3d5b  nt_bodies_done=[
-0000a1b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000a1c0: 2020 206d 6178 5f6c 6f6f 6b61 6865 6164     max_lookahead
-0000a1d0: 3d34 302c 0a20 2020 2020 2020 2020 2020  =40,.           
-0000a1e0: 2020 2020 2065 7272 6f72 3d27 6865 6164       error='head
-0000a1f0: 6572 2074 6572 6d69 6e61 746f 7220 6e6f  er terminator no
-0000a200: 7420 666f 756e 6427 2c0a 2020 2020 2020  t found',.      
-0000a210: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-0000a220: 2020 2020 2054 6573 744d 756c 7469 7061       TestMultipa
-0000a230: 7274 5061 7273 6572 2e5f 4361 7365 280a  rtParser._Case(.
-0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a250: 2769 6e63 6f6d 706c 6574 6520 626f 6479  'incomplete body
-0000a260: 2074 6572 6d69 6e61 746f 7227 2c0a 2020   terminator',.  
-0000a270: 2020 2020 2020 2020 2020 2020 2020 6227                b'
-0000a280: 5c72 5c6e 2d2d 7177 6572 7479 5c72 5c6e  \r\n--qwerty\r\n
-0000a290: 6865 6164 6572 2066 6f6f 5c72 5c6e 5c72  header foo\r\n\r
-0000a2a0: 5c6e 666f 6f20 6261 725c 725c 6e2d 2d71  \nfoo bar\r\n--q
-0000a2b0: 7765 7274 795c 7268 656c 6c6f 206d 7920  werty\rhello my 
-0000a2c0: 6e61 6d65 2069 7320 6a6f 6520 616e 6420  name is joe and 
-0000a2d0: 4920 776f 726b 2069 6e20 6120 6275 7474  I work in a butt
-0000a2e0: 6f6e 2066 6163 746f 7279 272c 2020 2320  on factory',  # 
-0000a2f0: 6e6f 7161 0a20 2020 2020 2020 2020 2020  noqa.           
-0000a300: 2020 2020 205b 6227 6865 6164 6572 2066       [b'header f
-0000a310: 6f6f 5c72 5c6e 5c72 5c6e 275d 2c0a 2020  oo\r\n\r\n'],.  
-0000a320: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
-0000a330: 2766 6f6f 2062 6172 5c72 5c6e 2d2d 7177  'foo bar\r\n--qw
-0000a340: 6572 7479 5c72 6865 6c6c 6f20 6d79 206e  erty\rhello my n
-0000a350: 616d 6520 6973 206a 6f65 2061 6e64 2049  ame is joe and I
-0000a360: 2077 6f72 6b20 696e 2061 2027 5d2c 0a20   work in a '],. 
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000a380: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
-0000a390: 5b46 616c 7365 5d2c 0a20 2020 2020 2020  [False],.       
-0000a3a0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0000a3b0: 2020 2020 5465 7374 4d75 6c74 6970 6172      TestMultipar
-0000a3c0: 7450 6172 7365 722e 5f43 6173 6528 0a20  tParser._Case(. 
-0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000a3e0: 656d 7074 7920 626f 6479 272c 0a20 2020  empty body',.   
-0000a3f0: 2020 2020 2020 2020 2020 2020 2062 275c               b'\
-0000a400: 725c 6e2d 2d71 7765 7274 795c 725c 6e68  r\n--qwerty\r\nh
-0000a410: 6561 6465 7220 666f 6f5c 725c 6e5c 725c  eader foo\r\n\r\
-0000a420: 6e5c 725c 6e2d 2d71 7765 7274 795c 725c  n\r\n--qwerty\r\
-0000a430: 6e27 2c0a 2020 2020 2020 2020 2020 2020  n',.            
-0000a440: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
-0000a450: 6f5c 725c 6e5c 725c 6e27 5d2c 0a20 2020  o\r\n\r\n'],.   
-0000a460: 2020 2020 2020 2020 2020 2020 205b 6227               [b'
-0000a470: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0000a480: 2020 2020 7761 6e74 5f62 6f64 6965 735f      want_bodies_
-0000a490: 646f 6e65 3d5b 5472 7565 5d2c 0a20 2020  done=[True],.   
-0000a4a0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0000a4b0: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
-0000a4c0: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
-0000a4d0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0000a4e0: 2020 2027 6967 6e6f 7265 206c 6561 6469     'ignore leadi
-0000a4f0: 6e67 2067 6172 6261 6765 272c 0a20 2020  ng garbage',.   
-0000a500: 2020 2020 2020 2020 2020 2020 2062 2768               b'h
-0000a510: 656c 6c6f 206d 7920 6e61 6d65 2069 7320  ello my name is 
-0000a520: 6a6f 655c 725c 6e5c 6e5c 6e5c 6e5c 725c  joe\r\n\n\n\n\r\
-0000a530: 6e2d 2d71 7765 7274 795c 725c 6e68 6561  n--qwerty\r\nhea
-0000a540: 6465 7220 666f 6f5c 725c 6e5c 725c 6e66  der foo\r\n\r\nf
-0000a550: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
-0000a560: 7479 5c72 5c6e 272c 2020 2320 6e6f 7161  ty\r\n',  # noqa
+000062f0: 2873 6572 7669 6365 2e77 6f72 6b69 6e67  (service.working
+00006300: 5f64 6972 2c20 2727 290a 2020 2020 2020  _dir, '').      
+00006310: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006320: 616c 2873 6572 7669 6365 2e6f 6e5f 7375  al(service.on_su
+00006330: 6363 6573 732c 2027 2729 0a20 2020 2020  ccess, '').     
+00006340: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006350: 7561 6c28 7365 7276 6963 652e 6f6e 5f66  ual(service.on_f
+00006360: 6169 6c75 7265 2c20 2727 290a 2020 2020  ailure, '').    
+00006370: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00006380: 7175 616c 2873 6572 7669 6365 2e6f 6e5f  qual(service.on_
+00006390: 6368 6563 6b5f 6661 696c 7572 652c 207b  check_failure, {
+000063a0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000063b0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
+000063c0: 6963 652e 6261 636b 6f66 665f 6465 6c61  ice.backoff_dela
+000063d0: 792c 2027 2729 0a20 2020 2020 2020 2073  y, '').        s
+000063e0: 656c 662e 6173 7365 7274 4973 2873 6572  elf.assertIs(ser
+000063f0: 7669 6365 2e62 6163 6b6f 6666 5f66 6163  vice.backoff_fac
+00006400: 746f 722c 204e 6f6e 6529 0a20 2020 2020  tor, None).     
+00006410: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006420: 7561 6c28 7365 7276 6963 652e 6261 636b  ual(service.back
+00006430: 6f66 665f 6c69 6d69 742c 2027 2729 0a20  off_limit, ''). 
+00006440: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006450: 7274 4973 2873 6572 7669 6365 2e6b 696c  rtIs(service.kil
+00006460: 6c5f 6465 6c61 792c 2027 2729 0a20 2020  l_delay, '').   
+00006470: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006480: 4571 7561 6c28 7365 7276 6963 652e 746f  Equal(service.to
+00006490: 5f64 6963 7428 292c 207b 7d29 0a0a 2020  _dict(), {})..  
+000064a0: 2020 6465 6620 7465 7374 5f6e 616d 655f    def test_name_
+000064b0: 6f6e 6c79 2873 656c 6629 3a0a 2020 2020  only(self):.    
+000064c0: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
+000064d0: 6572 7669 6365 2827 4e61 6d65 2030 2729  ervice('Name 0')
+000064e0: 0a20 2020 2020 2020 2073 656c 662e 5f61  .        self._a
+000064f0: 7373 6572 745f 656d 7074 7928 732c 2027  ssert_empty(s, '
+00006500: 4e61 6d65 2030 2729 0a0a 2020 2020 6465  Name 0')..    de
+00006510: 6620 7465 7374 5f64 6963 7428 7365 6c66  f test_dict(self
+00006520: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
+00006530: 6562 626c 652e 5365 7276 6963 6528 274e  ebble.Service('N
+00006540: 616d 6520 3127 2c20 7b7d 290a 2020 2020  ame 1', {}).    
+00006550: 2020 2020 7365 6c66 2e5f 6173 7365 7274      self._assert
+00006560: 5f65 6d70 7479 2873 2c20 274e 616d 6520  _empty(s, 'Name 
+00006570: 3127 290a 0a20 2020 2020 2020 2064 203d  1')..        d =
+00006580: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00006590: 7375 6d6d 6172 7927 3a20 2753 756d 204d  summary': 'Sum M
+000065a0: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
+000065b0: 2020 2764 6573 6372 6970 7469 6f6e 273a    'description':
+000065c0: 2027 5468 6520 6c61 7a79 2071 7569 636b   'The lazy quick
+000065d0: 2062 726f 776e 272c 0a20 2020 2020 2020   brown',.       
+000065e0: 2020 2020 2027 7374 6172 7475 7027 3a20       'startup': 
+000065f0: 2753 7461 7274 2055 7027 2c0a 2020 2020  'Start Up',.    
+00006600: 2020 2020 2020 2020 276f 7665 7272 6964          'overrid
+00006610: 6527 3a20 276f 7665 7272 6964 6527 2c0a  e': 'override',.
+00006620: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
+00006630: 6d61 6e64 273a 2027 6563 686f 2073 756d  mand': 'echo sum
+00006640: 206d 6172 7927 2c0a 2020 2020 2020 2020   mary',.        
+00006650: 2020 2020 2761 6674 6572 273a 205b 2761      'after': ['a
+00006660: 3127 2c20 2761 3227 5d2c 0a20 2020 2020  1', 'a2'],.     
+00006670: 2020 2020 2020 2027 6265 666f 7265 273a         'before':
+00006680: 205b 2762 3127 2c20 2762 3227 5d2c 0a20   ['b1', 'b2'],. 
+00006690: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
+000066a0: 6972 6573 273a 205b 2772 3127 2c20 2772  ires': ['r1', 'r
+000066b0: 3227 5d2c 0a20 2020 2020 2020 2020 2020  2'],.           
+000066c0: 2027 656e 7669 726f 6e6d 656e 7427 3a20   'environment': 
+000066d0: 7b27 6b31 273a 2027 7631 272c 2027 6b32  {'k1': 'v1', 'k2
+000066e0: 273a 2027 7632 277d 2c0a 2020 2020 2020  ': 'v2'},.      
+000066f0: 2020 2020 2020 2775 7365 7227 3a20 2762        'user': 'b
+00006700: 6f62 272c 0a20 2020 2020 2020 2020 2020  ob',.           
+00006710: 2027 7573 6572 2d69 6427 3a20 3130 3030   'user-id': 1000
+00006720: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
+00006730: 726f 7570 273a 2027 7374 6166 6627 2c0a  roup': 'staff',.
+00006740: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+00006750: 7570 2d69 6427 3a20 3230 3030 2c0a 2020  up-id': 2000,.  
+00006760: 2020 2020 2020 2020 2020 2777 6f72 6b69            'worki
+00006770: 6e67 2d64 6972 273a 2027 2f77 6f72 6b69  ng-dir': '/worki
+00006780: 6e67 2f64 6972 272c 0a20 2020 2020 2020  ng/dir',.       
+00006790: 2020 2020 2027 6f6e 2d73 7563 6365 7373       'on-success
+000067a0: 273a 2027 7265 7374 6172 7427 2c0a 2020  ': 'restart',.  
+000067b0: 2020 2020 2020 2020 2020 276f 6e2d 6661            'on-fa
+000067c0: 696c 7572 6527 3a20 2769 676e 6f72 6527  ilure': 'ignore'
+000067d0: 2c0a 2020 2020 2020 2020 2020 2020 276f  ,.            'o
+000067e0: 6e2d 6368 6563 6b2d 6661 696c 7572 6527  n-check-failure'
+000067f0: 3a20 7b27 6368 6b31 273a 2027 6861 6c74  : {'chk1': 'halt
+00006800: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00006810: 2762 6163 6b6f 6666 2d64 656c 6179 273a  'backoff-delay':
+00006820: 2027 3173 272c 0a20 2020 2020 2020 2020   '1s',.         
+00006830: 2020 2027 6261 636b 6f66 662d 6661 6374     'backoff-fact
+00006840: 6f72 273a 2034 2c0a 2020 2020 2020 2020  or': 4,.        
+00006850: 2020 2020 2762 6163 6b6f 6666 2d6c 696d      'backoff-lim
+00006860: 6974 273a 2027 3130 7327 2c0a 2020 2020  it': '10s',.    
+00006870: 2020 2020 2020 2020 276b 696c 6c2d 6465          'kill-de
+00006880: 6c61 7927 3a20 2734 3230 7327 2c0a 2020  lay': '420s',.  
+00006890: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000068a0: 7320 3d20 7065 6262 6c65 2e53 6572 7669  s = pebble.Servi
+000068b0: 6365 2827 4e61 6d65 2032 272c 2064 290a  ce('Name 2', d).
+000068c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000068d0: 6572 7445 7175 616c 2873 2e6e 616d 652c  ertEqual(s.name,
+000068e0: 2027 4e61 6d65 2032 2729 0a20 2020 2020   'Name 2').     
+000068f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006900: 7561 6c28 732e 6465 7363 7269 7074 696f  ual(s.descriptio
+00006910: 6e2c 2027 5468 6520 6c61 7a79 2071 7569  n, 'The lazy qui
+00006920: 636b 2062 726f 776e 2729 0a20 2020 2020  ck brown').     
+00006930: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006940: 7561 6c28 732e 7374 6172 7475 702c 2027  ual(s.startup, '
+00006950: 5374 6172 7420 5570 2729 0a20 2020 2020  Start Up').     
+00006960: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006970: 7561 6c28 732e 6f76 6572 7269 6465 2c20  ual(s.override, 
+00006980: 276f 7665 7272 6964 6527 290a 2020 2020  'override').    
+00006990: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000069a0: 7175 616c 2873 2e63 6f6d 6d61 6e64 2c20  qual(s.command, 
+000069b0: 2765 6368 6f20 7375 6d20 6d61 7279 2729  'echo sum mary')
+000069c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000069d0: 7365 7274 4571 7561 6c28 732e 6166 7465  sertEqual(s.afte
+000069e0: 722c 205b 2761 3127 2c20 2761 3227 5d29  r, ['a1', 'a2'])
+000069f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006a00: 7365 7274 4571 7561 6c28 732e 6265 666f  sertEqual(s.befo
+00006a10: 7265 2c20 5b27 6231 272c 2027 6232 275d  re, ['b1', 'b2']
+00006a20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006a30: 7373 6572 7445 7175 616c 2873 2e72 6571  ssertEqual(s.req
+00006a40: 7569 7265 732c 205b 2772 3127 2c20 2772  uires, ['r1', 'r
+00006a50: 3227 5d29 0a20 2020 2020 2020 2073 656c  2']).        sel
+00006a60: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00006a70: 656e 7669 726f 6e6d 656e 742c 207b 276b  environment, {'k
+00006a80: 3127 3a20 2776 3127 2c20 276b 3227 3a20  1': 'v1', 'k2': 
+00006a90: 2776 3227 7d29 0a20 2020 2020 2020 2073  'v2'}).        s
+00006aa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006ab0: 732e 7573 6572 2c20 2762 6f62 2729 0a20  s.user, 'bob'). 
+00006ac0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006ad0: 7274 4571 7561 6c28 732e 7573 6572 5f69  rtEqual(s.user_i
+00006ae0: 642c 2031 3030 3029 0a20 2020 2020 2020  d, 1000).       
+00006af0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00006b00: 6c28 732e 6772 6f75 702c 2027 7374 6166  l(s.group, 'staf
+00006b10: 6627 290a 2020 2020 2020 2020 7365 6c66  f').        self
+00006b20: 2e61 7373 6572 7445 7175 616c 2873 2e67  .assertEqual(s.g
+00006b30: 726f 7570 5f69 642c 2032 3030 3029 0a20  roup_id, 2000). 
+00006b40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006b50: 7274 4571 7561 6c28 732e 776f 726b 696e  rtEqual(s.workin
+00006b60: 675f 6469 722c 2027 2f77 6f72 6b69 6e67  g_dir, '/working
+00006b70: 2f64 6972 2729 0a20 2020 2020 2020 2073  /dir').        s
+00006b80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006b90: 732e 6f6e 5f73 7563 6365 7373 2c20 2772  s.on_success, 'r
+00006ba0: 6573 7461 7274 2729 0a20 2020 2020 2020  estart').       
+00006bb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00006bc0: 6c28 732e 6f6e 5f66 6169 6c75 7265 2c20  l(s.on_failure, 
+00006bd0: 2769 676e 6f72 6527 290a 2020 2020 2020  'ignore').      
+00006be0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006bf0: 616c 2873 2e6f 6e5f 6368 6563 6b5f 6661  al(s.on_check_fa
+00006c00: 696c 7572 652c 207b 2763 686b 3127 3a20  ilure, {'chk1': 
+00006c10: 2768 616c 7427 7d29 0a20 2020 2020 2020  'halt'}).       
+00006c20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00006c30: 6c28 732e 6261 636b 6f66 665f 6465 6c61  l(s.backoff_dela
+00006c40: 792c 2027 3173 2729 0a20 2020 2020 2020  y, '1s').       
+00006c50: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00006c60: 6c28 732e 6261 636b 6f66 665f 6661 6374  l(s.backoff_fact
+00006c70: 6f72 2c20 3429 0a20 2020 2020 2020 2073  or, 4).        s
+00006c80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006c90: 732e 6261 636b 6f66 665f 6c69 6d69 742c  s.backoff_limit,
+00006ca0: 2027 3130 7327 290a 2020 2020 2020 2020   '10s').        
+00006cb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00006cc0: 2873 2e6b 696c 6c5f 6465 6c61 792c 2027  (s.kill_delay, '
+00006cd0: 3432 3073 2729 0a0a 2020 2020 2020 2020  420s')..        
+00006ce0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00006cf0: 2873 2e74 6f5f 6469 6374 2829 2c20 6429  (s.to_dict(), d)
+00006d00: 0a0a 2020 2020 2020 2020 2320 456e 7375  ..        # Ensu
+00006d10: 7265 2070 6562 626c 652e 5365 7276 6963  re pebble.Servic
+00006d20: 6520 6861 7320 6d61 6465 2063 6f70 6965  e has made copie
+00006d30: 7320 6f66 206d 7574 6162 6c65 206f 626a  s of mutable obj
+00006d40: 6563 7473 0a20 2020 2020 2020 2073 2e61  ects.        s.a
+00006d50: 6674 6572 2e61 7070 656e 6428 2761 3327  fter.append('a3'
+00006d60: 290a 2020 2020 2020 2020 732e 6265 666f  ).        s.befo
+00006d70: 7265 2e61 7070 656e 6428 2762 3327 290a  re.append('b3').
+00006d80: 2020 2020 2020 2020 732e 7265 7175 6972          s.requir
+00006d90: 6573 2e61 7070 656e 6428 2772 3327 290a  es.append('r3').
+00006da0: 2020 2020 2020 2020 732e 656e 7669 726f          s.enviro
+00006db0: 6e6d 656e 745b 276b 3327 5d20 3d20 2776  nment['k3'] = 'v
+00006dc0: 3327 0a20 2020 2020 2020 2073 2e6f 6e5f  3'.        s.on_
+00006dd0: 6368 6563 6b5f 6661 696c 7572 655b 2763  check_failure['c
+00006de0: 686b 3227 5d20 3d20 2769 676e 6f72 6527  hk2'] = 'ignore'
+00006df0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006e00: 7365 7274 4571 7561 6c28 732e 6166 7465  sertEqual(s.afte
+00006e10: 722c 205b 2761 3127 2c20 2761 3227 2c20  r, ['a1', 'a2', 
+00006e20: 2761 3327 5d29 0a20 2020 2020 2020 2073  'a3']).        s
+00006e30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006e40: 732e 6265 666f 7265 2c20 5b27 6231 272c  s.before, ['b1',
+00006e50: 2027 6232 272c 2027 6233 275d 290a 2020   'b2', 'b3']).  
+00006e60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006e70: 7445 7175 616c 2873 2e72 6571 7569 7265  tEqual(s.require
+00006e80: 732c 205b 2772 3127 2c20 2772 3227 2c20  s, ['r1', 'r2', 
+00006e90: 2772 3327 5d29 0a20 2020 2020 2020 2073  'r3']).        s
+00006ea0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006eb0: 732e 656e 7669 726f 6e6d 656e 742c 207b  s.environment, {
+00006ec0: 276b 3127 3a20 2776 3127 2c20 276b 3227  'k1': 'v1', 'k2'
+00006ed0: 3a20 2776 3227 2c20 276b 3327 3a20 2776  : 'v2', 'k3': 'v
+00006ee0: 3327 7d29 0a20 2020 2020 2020 2073 656c  3'}).        sel
+00006ef0: 662e 6173 7365 7274 4571 7561 6c28 645b  f.assertEqual(d[
+00006f00: 2761 6674 6572 275d 2c20 5b27 6131 272c  'after'], ['a1',
+00006f10: 2027 6132 275d 290a 2020 2020 2020 2020   'a2']).        
+00006f20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00006f30: 2864 5b27 6265 666f 7265 275d 2c20 5b27  (d['before'], ['
+00006f40: 6231 272c 2027 6232 275d 290a 2020 2020  b1', 'b2']).    
+00006f50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00006f60: 7175 616c 2864 5b27 7265 7175 6972 6573  qual(d['requires
+00006f70: 275d 2c20 5b27 7231 272c 2027 7232 275d  '], ['r1', 'r2']
+00006f80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006f90: 7373 6572 7445 7175 616c 2864 5b27 656e  ssertEqual(d['en
+00006fa0: 7669 726f 6e6d 656e 7427 5d2c 207b 276b  vironment'], {'k
+00006fb0: 3127 3a20 2776 3127 2c20 276b 3227 3a20  1': 'v1', 'k2': 
+00006fc0: 2776 3227 7d29 0a20 2020 2020 2020 2073  'v2'}).        s
+00006fd0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006fe0: 645b 276f 6e2d 6368 6563 6b2d 6661 696c  d['on-check-fail
+00006ff0: 7572 6527 5d2c 207b 2763 686b 3127 3a20  ure'], {'chk1': 
+00007000: 2768 616c 7427 7d29 0a0a 2020 2020 6465  'halt'})..    de
+00007010: 6620 7465 7374 5f65 7175 616c 6974 7928  f test_equality(
+00007020: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00007030: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00007040: 2027 7375 6d6d 6172 7927 3a20 2753 756d   'summary': 'Sum
+00007050: 204d 6172 7927 2c0a 2020 2020 2020 2020   Mary',.        
+00007060: 2020 2020 2764 6573 6372 6970 7469 6f6e      'description
+00007070: 273a 2027 5468 6520 6c61 7a79 2071 7569  ': 'The lazy qui
+00007080: 636b 2062 726f 776e 272c 0a20 2020 2020  ck brown',.     
+00007090: 2020 2020 2020 2027 7374 6172 7475 7027         'startup'
+000070a0: 3a20 2753 7461 7274 2055 7027 2c0a 2020  : 'Start Up',.  
+000070b0: 2020 2020 2020 2020 2020 276f 7665 7272            'overr
+000070c0: 6964 6527 3a20 276f 7665 7272 6964 6527  ide': 'override'
+000070d0: 2c0a 2020 2020 2020 2020 2020 2020 2763  ,.            'c
+000070e0: 6f6d 6d61 6e64 273a 2027 6563 686f 2073  ommand': 'echo s
+000070f0: 756d 206d 6172 7927 2c0a 2020 2020 2020  um mary',.      
+00007100: 2020 2020 2020 2761 6674 6572 273a 205b        'after': [
+00007110: 2761 3127 2c20 2761 3227 5d2c 0a20 2020  'a1', 'a2'],.   
+00007120: 2020 2020 2020 2020 2027 6265 666f 7265           'before
+00007130: 273a 205b 2762 3127 2c20 2762 3227 5d2c  ': ['b1', 'b2'],
+00007140: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
+00007150: 7175 6972 6573 273a 205b 2772 3127 2c20  quires': ['r1', 
+00007160: 2772 3227 5d2c 0a20 2020 2020 2020 2020  'r2'],.         
+00007170: 2020 2027 656e 7669 726f 6e6d 656e 7427     'environment'
+00007180: 3a20 7b27 6b31 273a 2027 7631 272c 2027  : {'k1': 'v1', '
+00007190: 6b32 273a 2027 7632 277d 2c0a 2020 2020  k2': 'v2'},.    
+000071a0: 2020 2020 2020 2020 2775 7365 7227 3a20          'user': 
+000071b0: 2762 6f62 272c 0a20 2020 2020 2020 2020  'bob',.         
+000071c0: 2020 2027 7573 6572 2d69 6427 3a20 3130     'user-id': 10
+000071d0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+000071e0: 2767 726f 7570 273a 2027 7374 6166 6627  'group': 'staff'
+000071f0: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
+00007200: 726f 7570 2d69 6427 3a20 3230 3030 2c0a  roup-id': 2000,.
+00007210: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00007220: 2020 6f6e 6520 3d20 7065 6262 6c65 2e53    one = pebble.S
+00007230: 6572 7669 6365 2822 4e61 6d65 2031 222c  ervice("Name 1",
+00007240: 2064 290a 2020 2020 2020 2020 7477 6f20   d).        two 
+00007250: 3d20 7065 6262 6c65 2e53 6572 7669 6365  = pebble.Service
+00007260: 2822 4e61 6d65 2031 222c 2064 290a 2020  ("Name 1", d).  
+00007270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007280: 7445 7175 616c 286f 6e65 2c20 7477 6f29  tEqual(one, two)
+00007290: 0a0a 2020 2020 2020 2020 6173 5f64 6963  ..        as_dic
+000072a0: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
+000072b0: 2020 2773 756d 6d61 7279 273a 2027 5375    'summary': 'Su
+000072c0: 6d20 4d61 7279 272c 0a20 2020 2020 2020  m Mary',.       
+000072d0: 2020 2020 2027 6465 7363 7269 7074 696f       'descriptio
+000072e0: 6e27 3a20 2754 6865 206c 617a 7920 7175  n': 'The lazy qu
+000072f0: 6963 6b20 6272 6f77 6e27 2c0a 2020 2020  ick brown',.    
+00007300: 2020 2020 2020 2020 2773 7461 7274 7570          'startup
+00007310: 273a 2027 5374 6172 7420 5570 272c 0a20  ': 'Start Up',. 
+00007320: 2020 2020 2020 2020 2020 2027 6f76 6572             'over
+00007330: 7269 6465 273a 2027 6f76 6572 7269 6465  ride': 'override
+00007340: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00007350: 636f 6d6d 616e 6427 3a20 2765 6368 6f20  command': 'echo 
+00007360: 7375 6d20 6d61 7279 272c 0a20 2020 2020  sum mary',.     
+00007370: 2020 2020 2020 2027 6166 7465 7227 3a20         'after': 
+00007380: 5b27 6131 272c 2027 6132 275d 2c0a 2020  ['a1', 'a2'],.  
+00007390: 2020 2020 2020 2020 2020 2762 6566 6f72            'befor
+000073a0: 6527 3a20 5b27 6231 272c 2027 6232 275d  e': ['b1', 'b2']
+000073b0: 2c0a 2020 2020 2020 2020 2020 2020 2772  ,.            'r
+000073c0: 6571 7569 7265 7327 3a20 5b27 7231 272c  equires': ['r1',
+000073d0: 2027 7232 275d 2c0a 2020 2020 2020 2020   'r2'],.        
+000073e0: 2020 2020 2765 6e76 6972 6f6e 6d65 6e74      'environment
+000073f0: 273a 207b 276b 3127 3a20 2776 3127 2c20  ': {'k1': 'v1', 
+00007400: 276b 3227 3a20 2776 3227 7d2c 0a20 2020  'k2': 'v2'},.   
+00007410: 2020 2020 2020 2020 2027 7573 6572 273a           'user':
+00007420: 2027 626f 6227 2c0a 2020 2020 2020 2020   'bob',.        
+00007430: 2020 2020 2775 7365 722d 6964 273a 2031      'user-id': 1
+00007440: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
+00007450: 2027 6772 6f75 7027 3a20 2773 7461 6666   'group': 'staff
+00007460: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00007470: 6772 6f75 702d 6964 273a 2032 3030 302c  group-id': 2000,
+00007480: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00007490: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000074a0: 7561 6c28 6f6e 652c 2061 735f 6469 6374  ual(one, as_dict
+000074b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000074c0: 6173 7365 7274 4e6f 7445 7175 616c 286f  assertNotEqual(o
+000074d0: 6e65 2c20 3529 0a0a 0a63 6c61 7373 2054  ne, 5)...class T
+000074e0: 6573 7443 6865 636b 2875 6e69 7474 6573  estCheck(unittes
+000074f0: 742e 5465 7374 4361 7365 293a 0a20 2020  t.TestCase):.   
+00007500: 2064 6566 205f 6173 7365 7274 5f65 6d70   def _assert_emp
+00007510: 7479 2873 656c 662c 2063 6865 636b 2c20  ty(self, check, 
+00007520: 6e61 6d65 293a 0a20 2020 2020 2020 2073  name):.        s
+00007530: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00007540: 6368 6563 6b2e 6e61 6d65 2c20 6e61 6d65  check.name, name
+00007550: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007560: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+00007570: 2e6f 7665 7272 6964 652c 2027 2729 0a20  .override, ''). 
+00007580: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007590: 7274 4571 7561 6c28 6368 6563 6b2e 6c65  rtEqual(check.le
+000075a0: 7665 6c2c 2070 6562 626c 652e 4368 6563  vel, pebble.Chec
+000075b0: 6b4c 6576 656c 2e55 4e53 4554 290a 2020  kLevel.UNSET).  
+000075c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000075d0: 7445 7175 616c 2863 6865 636b 2e70 6572  tEqual(check.per
+000075e0: 696f 642c 2027 2729 0a20 2020 2020 2020  iod, '').       
+000075f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007600: 6c28 6368 6563 6b2e 7469 6d65 6f75 742c  l(check.timeout,
+00007610: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
+00007620: 662e 6173 7365 7274 4973 2863 6865 636b  f.assertIs(check
+00007630: 2e74 6872 6573 686f 6c64 2c20 4e6f 6e65  .threshold, None
+00007640: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007650: 7373 6572 7449 7328 6368 6563 6b2e 6874  ssertIs(check.ht
+00007660: 7470 2c20 4e6f 6e65 290a 2020 2020 2020  tp, None).      
+00007670: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
+00007680: 6368 6563 6b2e 7463 702c 204e 6f6e 6529  check.tcp, None)
+00007690: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000076a0: 7365 7274 4973 2863 6865 636b 2e65 7865  sertIs(check.exe
+000076b0: 632c 204e 6f6e 6529 0a0a 2020 2020 6465  c, None)..    de
+000076c0: 6620 7465 7374 5f6e 616d 655f 6f6e 6c79  f test_name_only
+000076d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000076e0: 6368 6563 6b20 3d20 7065 6262 6c65 2e43  check = pebble.C
+000076f0: 6865 636b 2827 6368 6b27 290a 2020 2020  heck('chk').    
+00007700: 2020 2020 7365 6c66 2e5f 6173 7365 7274      self._assert
+00007710: 5f65 6d70 7479 2863 6865 636b 2c20 2763  _empty(check, 'c
+00007720: 686b 2729 0a0a 2020 2020 6465 6620 7465  hk')..    def te
+00007730: 7374 5f64 6963 7428 7365 6c66 293a 0a20  st_dict(self):. 
+00007740: 2020 2020 2020 2064 203d 207b 0a20 2020         d = {.   
+00007750: 2020 2020 2020 2020 2027 6f76 6572 7269           'overri
+00007760: 6465 273a 2027 7265 706c 6163 6527 2c0a  de': 'replace',.
+00007770: 2020 2020 2020 2020 2020 2020 276c 6576              'lev
+00007780: 656c 273a 2027 616c 6976 6527 2c0a 2020  el': 'alive',.  
+00007790: 2020 2020 2020 2020 2020 2770 6572 696f            'perio
+000077a0: 6427 3a20 2731 3073 272c 0a20 2020 2020  d': '10s',.     
+000077b0: 2020 2020 2020 2027 7469 6d65 6f75 7427         'timeout'
+000077c0: 3a20 2733 7327 2c0a 2020 2020 2020 2020  : '3s',.        
+000077d0: 2020 2020 2774 6872 6573 686f 6c64 273a      'threshold':
+000077e0: 2035 2c0a 2020 2020 2020 2020 2020 2020   5,.            
+000077f0: 2320 4e6f 7420 7661 6c69 6420 666f 7220  # Not valid for 
+00007800: 5065 6262 6c65 2074 6f20 6861 7665 206d  Pebble to have m
+00007810: 6f72 6520 7468 616e 206f 6e65 206f 6620  ore than one of 
+00007820: 6874 7470 2c20 7463 702c 2061 6e64 2065  http, tcp, and e
+00007830: 7865 632c 0a20 2020 2020 2020 2020 2020  xec,.           
+00007840: 2023 2062 7574 2069 7420 6d61 6b65 7320   # but it makes 
+00007850: 7468 696e 6773 2073 696d 706c 6572 2066  things simpler f
+00007860: 6f72 2074 6865 2075 6e69 7420 7465 7374  or the unit test
+00007870: 732e 0a20 2020 2020 2020 2020 2020 2027  s..            '
+00007880: 6874 7470 273a 207b 2775 726c 273a 2027  http': {'url': '
+00007890: 6874 7470 733a 2f2f 6578 616d 706c 652e  https://example.
+000078a0: 636f 6d2f 277d 2c0a 2020 2020 2020 2020  com/'},.        
+000078b0: 2020 2020 2774 6370 273a 207b 2770 6f72      'tcp': {'por
+000078c0: 7427 3a20 3830 7d2c 0a20 2020 2020 2020  t': 80},.       
+000078d0: 2020 2020 2027 6578 6563 273a 207b 2763       'exec': {'c
+000078e0: 6f6d 6d61 6e64 273a 2027 6563 686f 2066  ommand': 'echo f
+000078f0: 6f6f 277d 2c0a 2020 2020 2020 2020 7d0a  oo'},.        }.
+00007900: 2020 2020 2020 2020 6368 6563 6b20 3d20          check = 
+00007910: 7065 6262 6c65 2e43 6865 636b 2827 6368  pebble.Check('ch
+00007920: 6b2d 6874 7470 272c 2064 290a 2020 2020  k-http', d).    
+00007930: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007940: 7175 616c 2863 6865 636b 2e6e 616d 652c  qual(check.name,
+00007950: 2027 6368 6b2d 6874 7470 2729 0a20 2020   'chk-http').   
+00007960: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00007970: 4571 7561 6c28 6368 6563 6b2e 6f76 6572  Equal(check.over
+00007980: 7269 6465 2c20 2772 6570 6c61 6365 2729  ride, 'replace')
+00007990: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000079a0: 7365 7274 4571 7561 6c28 6368 6563 6b2e  sertEqual(check.
+000079b0: 6c65 7665 6c2c 2070 6562 626c 652e 4368  level, pebble.Ch
+000079c0: 6563 6b4c 6576 656c 2e41 4c49 5645 290a  eckLevel.ALIVE).
+000079d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000079e0: 6572 7445 7175 616c 2863 6865 636b 2e70  ertEqual(check.p
+000079f0: 6572 696f 642c 2027 3130 7327 290a 2020  eriod, '10s').  
+00007a00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007a10: 7445 7175 616c 2863 6865 636b 2e74 696d  tEqual(check.tim
+00007a20: 656f 7574 2c20 2733 7327 290a 2020 2020  eout, '3s').    
+00007a30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007a40: 7175 616c 2863 6865 636b 2e74 6872 6573  qual(check.thres
+00007a50: 686f 6c64 2c20 3529 0a20 2020 2020 2020  hold, 5).       
+00007a60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007a70: 6c28 6368 6563 6b2e 6874 7470 2c20 7b27  l(check.http, {'
+00007a80: 7572 6c27 3a20 2768 7474 7073 3a2f 2f65  url': 'https://e
+00007a90: 7861 6d70 6c65 2e63 6f6d 2f27 7d29 0a20  xample.com/'}). 
+00007aa0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007ab0: 7274 4571 7561 6c28 6368 6563 6b2e 7463  rtEqual(check.tc
+00007ac0: 702c 207b 2770 6f72 7427 3a20 3830 7d29  p, {'port': 80})
+00007ad0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007ae0: 7365 7274 4571 7561 6c28 6368 6563 6b2e  sertEqual(check.
+00007af0: 6578 6563 2c20 7b27 636f 6d6d 616e 6427  exec, {'command'
+00007b00: 3a20 2765 6368 6f20 666f 6f27 7d29 0a0a  : 'echo foo'})..
+00007b10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007b20: 6572 7445 7175 616c 2863 6865 636b 2e74  ertEqual(check.t
+00007b30: 6f5f 6469 6374 2829 2c20 6429 0a0a 2020  o_dict(), d)..  
+00007b40: 2020 2020 2020 2320 456e 7375 7265 2070        # Ensure p
+00007b50: 6562 626c 652e 4368 6563 6b20 6861 7320  ebble.Check has 
+00007b60: 6d61 6465 2063 6f70 6965 7320 6f66 206d  made copies of m
+00007b70: 7574 6162 6c65 206f 626a 6563 7473 0a20  utable objects. 
+00007b80: 2020 2020 2020 2063 6865 636b 2e68 7474         check.htt
+00007b90: 705b 2775 726c 275d 203d 2027 6874 7470  p['url'] = 'http
+00007ba0: 733a 2f2f 7777 772e 676f 6f67 6c65 2e63  s://www.google.c
+00007bb0: 6f6d 270a 2020 2020 2020 2020 7365 6c66  om'.        self
+00007bc0: 2e61 7373 6572 7445 7175 616c 2864 5b27  .assertEqual(d['
+00007bd0: 6874 7470 275d 2c20 7b27 7572 6c27 3a20  http'], {'url': 
+00007be0: 2768 7474 7073 3a2f 2f65 7861 6d70 6c65  'https://example
+00007bf0: 2e63 6f6d 2f27 7d29 0a20 2020 2020 2020  .com/'}).       
+00007c00: 2063 6865 636b 2e74 6370 5b27 706f 7274   check.tcp['port
+00007c10: 275d 203d 2038 310a 2020 2020 2020 2020  '] = 81.        
+00007c20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00007c30: 2864 5b27 7463 7027 5d2c 207b 2770 6f72  (d['tcp'], {'por
+00007c40: 7427 3a20 3830 7d29 0a20 2020 2020 2020  t': 80}).       
+00007c50: 2063 6865 636b 2e65 7865 635b 2763 6f6d   check.exec['com
+00007c60: 6d61 6e64 275d 203d 2027 666f 6f27 0a20  mand'] = 'foo'. 
+00007c70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007c80: 7274 4571 7561 6c28 645b 2765 7865 6327  rtEqual(d['exec'
+00007c90: 5d2c 207b 2763 6f6d 6d61 6e64 273a 2027  ], {'command': '
+00007ca0: 6563 686f 2066 6f6f 277d 290a 0a20 2020  echo foo'})..   
+00007cb0: 2064 6566 2074 6573 745f 6c65 7665 6c5f   def test_level_
+00007cc0: 7261 7728 7365 6c66 293a 0a20 2020 2020  raw(self):.     
+00007cd0: 2020 2064 203d 207b 0a20 2020 2020 2020     d = {.       
+00007ce0: 2020 2020 2027 6f76 6572 7269 6465 273a       'override':
+00007cf0: 2027 7265 706c 6163 6527 2c0a 2020 2020   'replace',.    
+00007d00: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+00007d10: 2027 666f 6f62 6172 2127 2c0a 2020 2020   'foobar!',.    
+00007d20: 2020 2020 2020 2020 2770 6572 696f 6427          'period'
+00007d30: 3a20 2731 3073 272c 0a20 2020 2020 2020  : '10s',.       
+00007d40: 2020 2020 2027 7469 6d65 6f75 7427 3a20       'timeout': 
+00007d50: 2733 7327 2c0a 2020 2020 2020 2020 2020  '3s',.          
+00007d60: 2020 2774 6872 6573 686f 6c64 273a 2035    'threshold': 5
+00007d70: 2c0a 2020 2020 2020 2020 2020 2020 2768  ,.            'h
+00007d80: 7474 7027 3a20 7b27 7572 6c27 3a20 2768  ttp': {'url': 'h
+00007d90: 7474 7073 3a2f 2f65 7861 6d70 6c65 2e63  ttps://example.c
+00007da0: 6f6d 2f27 7d2c 0a20 2020 2020 2020 207d  om/'},.        }
+00007db0: 0a20 2020 2020 2020 2063 6865 636b 203d  .        check =
+00007dc0: 2070 6562 626c 652e 4368 6563 6b28 2763   pebble.Check('c
+00007dd0: 686b 2d68 7474 7027 2c20 6429 0a20 2020  hk-http', d).   
+00007de0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00007df0: 4571 7561 6c28 6368 6563 6b2e 6c65 7665  Equal(check.leve
+00007e00: 6c2c 2027 666f 6f62 6172 2127 2920 2023  l, 'foobar!')  #
+00007e10: 2072 656d 6169 6e73 2061 2073 7472 696e   remains a strin
+00007e20: 670a 0a20 2020 2064 6566 2074 6573 745f  g..    def test_
+00007e30: 6571 7561 6c69 7479 2873 656c 6629 3a0a  equality(self):.
+00007e40: 2020 2020 2020 2020 6420 3d20 7b0a 2020          d = {.  
+00007e50: 2020 2020 2020 2020 2020 276f 7665 7272            'overr
+00007e60: 6964 6527 3a20 2772 6570 6c61 6365 272c  ide': 'replace',
+00007e70: 0a20 2020 2020 2020 2020 2020 2027 6c65  .            'le
+00007e80: 7665 6c27 3a20 2761 6c69 7665 272c 0a20  vel': 'alive',. 
+00007e90: 2020 2020 2020 2020 2020 2027 7065 7269             'peri
+00007ea0: 6f64 273a 2027 3130 7327 2c0a 2020 2020  od': '10s',.    
+00007eb0: 2020 2020 2020 2020 2774 696d 656f 7574          'timeout
+00007ec0: 273a 2027 3373 272c 0a20 2020 2020 2020  ': '3s',.       
+00007ed0: 2020 2020 2027 7468 7265 7368 6f6c 6427       'threshold'
+00007ee0: 3a20 352c 0a20 2020 2020 2020 2020 2020  : 5,.           
+00007ef0: 2027 6874 7470 273a 207b 2775 726c 273a   'http': {'url':
+00007f00: 2027 6874 7470 733a 2f2f 6578 616d 706c   'https://exampl
+00007f10: 652e 636f 6d2f 277d 2c0a 2020 2020 2020  e.com/'},.      
+00007f20: 2020 7d0a 2020 2020 2020 2020 6f6e 6520    }.        one 
+00007f30: 3d20 7065 6262 6c65 2e43 6865 636b 2827  = pebble.Check('
+00007f40: 6f6e 6527 2c20 6429 0a20 2020 2020 2020  one', d).       
+00007f50: 2074 776f 203d 2070 6562 626c 652e 4368   two = pebble.Ch
+00007f60: 6563 6b28 2774 776f 272c 2064 290a 2020  eck('two', d).  
+00007f70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007f80: 7445 7175 616c 286f 6e65 2c20 7477 6f29  tEqual(one, two)
+00007f90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007fa0: 7365 7274 4571 7561 6c28 6f6e 652c 2064  sertEqual(one, d
+00007fb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007fc0: 7373 6572 7445 7175 616c 2874 776f 2c20  ssertEqual(two, 
+00007fd0: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+00007fe0: 6173 7365 7274 4571 7561 6c28 6f6e 652c  assertEqual(one,
+00007ff0: 206f 6e65 2e74 6f5f 6469 6374 2829 290a   one.to_dict()).
+00008000: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00008010: 6572 7445 7175 616c 2874 776f 2c20 7477  ertEqual(two, tw
+00008020: 6f2e 746f 5f64 6963 7428 2929 0a20 2020  o.to_dict()).   
+00008030: 2020 2020 2064 5b27 6c65 7665 6c27 5d20       d['level'] 
+00008040: 3d20 2772 6561 6479 270a 2020 2020 2020  = 'ready'.      
+00008050: 2020 7365 6c66 2e61 7373 6572 744e 6f74    self.assertNot
+00008060: 4571 7561 6c28 6f6e 652c 2064 290a 0a20  Equal(one, d).. 
+00008070: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00008080: 7274 4e6f 7445 7175 616c 286f 6e65 2c20  rtNotEqual(one, 
+00008090: 3529 0a0a 0a63 6c61 7373 2054 6573 7453  5)...class TestS
+000080a0: 6572 7669 6365 496e 666f 2875 6e69 7474  erviceInfo(unitt
+000080b0: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+000080c0: 2020 2064 6566 2074 6573 745f 7365 7276     def test_serv
+000080d0: 6963 655f 7374 6172 7475 7028 7365 6c66  ice_startup(self
+000080e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+000080f0: 6173 7365 7274 4571 7561 6c28 6c69 7374  assertEqual(list
+00008100: 2870 6562 626c 652e 5365 7276 6963 6553  (pebble.ServiceS
+00008110: 7461 7274 7570 292c 205b 0a20 2020 2020  tartup), [.     
+00008120: 2020 2020 2020 2070 6562 626c 652e 5365         pebble.Se
+00008130: 7276 6963 6553 7461 7274 7570 2e45 4e41  rviceStartup.ENA
+00008140: 424c 4544 2c0a 2020 2020 2020 2020 2020  BLED,.          
+00008150: 2020 7065 6262 6c65 2e53 6572 7669 6365    pebble.Service
+00008160: 5374 6172 7475 702e 4449 5341 424c 4544  Startup.DISABLED
+00008170: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+00008180: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008190: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
+000081a0: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
+000081b0: 4c45 442e 7661 6c75 652c 2027 656e 6162  LED.value, 'enab
+000081c0: 6c65 6427 290a 2020 2020 2020 2020 7365  led').        se
+000081d0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+000081e0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+000081f0: 7274 7570 2e44 4953 4142 4c45 442e 7661  rtup.DISABLED.va
+00008200: 6c75 652c 2027 6469 7361 626c 6564 2729  lue, 'disabled')
+00008210: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00008220: 6572 7669 6365 5f73 7461 7475 7328 7365  ervice_status(se
+00008230: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00008240: 662e 6173 7365 7274 4571 7561 6c28 6c69  f.assertEqual(li
+00008250: 7374 2870 6562 626c 652e 5365 7276 6963  st(pebble.Servic
+00008260: 6553 7461 7475 7329 2c20 5b0a 2020 2020  eStatus), [.    
+00008270: 2020 2020 2020 2020 7065 6262 6c65 2e53          pebble.S
+00008280: 6572 7669 6365 5374 6174 7573 2e41 4354  erviceStatus.ACT
+00008290: 4956 452c 0a20 2020 2020 2020 2020 2020  IVE,.           
+000082a0: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
+000082b0: 7461 7475 732e 494e 4143 5449 5645 2c0a  tatus.INACTIVE,.
+000082c0: 2020 2020 2020 2020 2020 2020 7065 6262              pebb
+000082d0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+000082e0: 2e45 5252 4f52 2c0a 2020 2020 2020 2020  .ERROR,.        
+000082f0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00008300: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
+00008310: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+00008320: 2e41 4354 4956 452e 7661 6c75 652c 2027  .ACTIVE.value, '
+00008330: 6163 7469 7665 2729 0a20 2020 2020 2020  active').       
+00008340: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008350: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
+00008360: 5374 6174 7573 2e49 4e41 4354 4956 452e  Status.INACTIVE.
+00008370: 7661 6c75 652c 2027 696e 6163 7469 7665  value, 'inactive
+00008380: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00008390: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
+000083a0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+000083b0: 2e45 5252 4f52 2e76 616c 7565 2c20 2765  .ERROR.value, 'e
+000083c0: 7272 6f72 2729 0a0a 2020 2020 6465 6620  rror')..    def 
+000083d0: 7465 7374 5f73 6572 7669 6365 5f69 6e66  test_service_inf
+000083e0: 6f28 7365 6c66 293a 0a20 2020 2020 2020  o(self):.       
+000083f0: 2073 203d 2070 6562 626c 652e 5365 7276   s = pebble.Serv
+00008400: 6963 6549 6e66 6f28 2773 7663 3127 2c20  iceInfo('svc1', 
+00008410: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+00008420: 6172 7475 702e 454e 4142 4c45 442c 2070  artup.ENABLED, p
+00008430: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00008440: 7475 732e 4143 5449 5645 290a 2020 2020  tus.ACTIVE).    
+00008450: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008460: 7175 616c 2873 2e6e 616d 652c 2027 7376  qual(s.name, 'sv
+00008470: 6331 2729 0a20 2020 2020 2020 2073 656c  c1').        sel
+00008480: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00008490: 7374 6172 7475 702c 2070 6562 626c 652e  startup, pebble.
+000084a0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
+000084b0: 4e41 424c 4544 290a 2020 2020 2020 2020  NABLED).        
+000084c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000084d0: 2873 2e63 7572 7265 6e74 2c20 7065 6262  (s.current, pebb
+000084e0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+000084f0: 2e41 4354 4956 4529 0a0a 2020 2020 2020  .ACTIVE)..      
+00008500: 2020 7320 3d20 7065 6262 6c65 2e53 6572    s = pebble.Ser
+00008510: 7669 6365 496e 666f 280a 2020 2020 2020  viceInfo(.      
+00008520: 2020 2020 2020 2773 7663 3127 2c0a 2020        'svc1',.  
+00008530: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+00008540: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
+00008550: 454e 4142 4c45 442c 0a20 2020 2020 2020  ENABLED,.       
+00008560: 2020 2020 2070 6562 626c 652e 5365 7276       pebble.Serv
+00008570: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
+00008580: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00008590: 7373 6572 7445 7175 616c 2873 2e6e 616d  ssertEqual(s.nam
+000085a0: 652c 2027 7376 6331 2729 0a20 2020 2020  e, 'svc1').     
+000085b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000085c0: 7561 6c28 732e 7374 6172 7475 702c 2070  ual(s.startup, p
+000085d0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+000085e0: 7274 7570 2e45 4e41 424c 4544 290a 2020  rtup.ENABLED).  
+000085f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008600: 7445 7175 616c 2873 2e63 7572 7265 6e74  tEqual(s.current
+00008610: 2c20 7065 6262 6c65 2e53 6572 7669 6365  , pebble.Service
+00008620: 5374 6174 7573 2e41 4354 4956 4529 0a0a  Status.ACTIVE)..
+00008630: 2020 2020 2020 2020 7320 3d20 7065 6262          s = pebb
+00008640: 6c65 2e53 6572 7669 6365 496e 666f 2e66  le.ServiceInfo.f
+00008650: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
+00008660: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
+00008670: 7376 6332 272c 0a20 2020 2020 2020 2020  svc2',.         
+00008680: 2020 2027 7374 6172 7475 7027 3a20 2764     'startup': 'd
+00008690: 6973 6162 6c65 6427 2c0a 2020 2020 2020  isabled',.      
+000086a0: 2020 2020 2020 2763 7572 7265 6e74 273a        'current':
+000086b0: 2027 696e 6163 7469 7665 272c 0a20 2020   'inactive',.   
+000086c0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+000086d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000086e0: 2873 2e6e 616d 652c 2027 7376 6332 2729  (s.name, 'svc2')
+000086f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008700: 7365 7274 4571 7561 6c28 732e 7374 6172  sertEqual(s.star
+00008710: 7475 702c 2070 6562 626c 652e 5365 7276  tup, pebble.Serv
+00008720: 6963 6553 7461 7274 7570 2e44 4953 4142  iceStartup.DISAB
+00008730: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
+00008740: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00008750: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+00008760: 5365 7276 6963 6553 7461 7475 732e 494e  ServiceStatus.IN
+00008770: 4143 5449 5645 290a 0a20 2020 2020 2020  ACTIVE)..       
+00008780: 2073 203d 2070 6562 626c 652e 5365 7276   s = pebble.Serv
+00008790: 6963 6549 6e66 6f2e 6672 6f6d 5f64 6963  iceInfo.from_dic
+000087a0: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
+000087b0: 276e 616d 6527 3a20 2773 7663 3227 2c0a  'name': 'svc2',.
+000087c0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+000087d0: 7274 7570 273a 2027 7468 696e 6779 272c  rtup': 'thingy',
+000087e0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
+000087f0: 7272 656e 7427 3a20 2762 6f62 272c 0a20  rrent': 'bob',. 
+00008800: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
+00008810: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008820: 616c 2873 2e6e 616d 652c 2027 7376 6332  al(s.name, 'svc2
+00008830: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00008840: 6173 7365 7274 4571 7561 6c28 732e 7374  assertEqual(s.st
+00008850: 6172 7475 702c 2027 7468 696e 6779 2729  artup, 'thingy')
+00008860: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008870: 7365 7274 4571 7561 6c28 732e 6375 7272  sertEqual(s.curr
+00008880: 656e 742c 2027 626f 6227 290a 0a20 2020  ent, 'bob')..   
+00008890: 2064 6566 2074 6573 745f 6973 5f72 756e   def test_is_run
+000088a0: 6e69 6e67 2873 656c 6629 3a0a 2020 2020  ning(self):.    
+000088b0: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
+000088c0: 6572 7669 6365 496e 666f 2827 7327 2c20  erviceInfo('s', 
+000088d0: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+000088e0: 6172 7475 702e 454e 4142 4c45 442c 2070  artup.ENABLED, p
+000088f0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00008900: 7475 732e 4143 5449 5645 290a 2020 2020  tus.ACTIVE).    
+00008910: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00008920: 7275 6528 732e 6973 5f72 756e 6e69 6e67  rue(s.is_running
+00008930: 2829 290a 2020 2020 2020 2020 666f 7220  ()).        for 
+00008940: 6375 7272 656e 7420 696e 205b 7065 6262  current in [pebb
+00008950: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+00008960: 2e49 4e41 4354 4956 452c 2070 6562 626c  .INACTIVE, pebbl
+00008970: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
+00008980: 4552 524f 522c 2027 6f74 6865 7227 5d3a  ERROR, 'other']:
+00008990: 0a20 2020 2020 2020 2020 2020 2073 203d  .            s =
+000089a0: 2070 6562 626c 652e 5365 7276 6963 6549   pebble.ServiceI
+000089b0: 6e66 6f28 2773 272c 2070 6562 626c 652e  nfo('s', pebble.
+000089c0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
+000089d0: 4e41 424c 4544 2c20 6375 7272 656e 7429  NABLED, current)
+000089e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000089f0: 662e 6173 7365 7274 4661 6c73 6528 732e  f.assertFalse(s.
+00008a00: 6973 5f72 756e 6e69 6e67 2829 290a 0a0a  is_running())...
+00008a10: 636c 6173 7320 5465 7374 4368 6563 6b49  class TestCheckI
+00008a20: 6e66 6f28 756e 6974 7465 7374 2e54 6573  nfo(unittest.Tes
+00008a30: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+00008a40: 7465 7374 5f63 6865 636b 5f6c 6576 656c  test_check_level
+00008a50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00008a60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00008a70: 286c 6973 7428 7065 6262 6c65 2e43 6865  (list(pebble.Che
+00008a80: 636b 4c65 7665 6c29 2c20 5b0a 2020 2020  ckLevel), [.    
+00008a90: 2020 2020 2020 2020 7065 6262 6c65 2e43          pebble.C
+00008aa0: 6865 636b 4c65 7665 6c2e 554e 5345 542c  heckLevel.UNSET,
+00008ab0: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+00008ac0: 626c 652e 4368 6563 6b4c 6576 656c 2e41  ble.CheckLevel.A
+00008ad0: 4c49 5645 2c0a 2020 2020 2020 2020 2020  LIVE,.          
+00008ae0: 2020 7065 6262 6c65 2e43 6865 636b 4c65    pebble.CheckLe
+00008af0: 7665 6c2e 5245 4144 592c 0a20 2020 2020  vel.READY,.     
+00008b00: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00008b10: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00008b20: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
+00008b30: 2e55 4e53 4554 2e76 616c 7565 2c20 2727  .UNSET.value, ''
+00008b40: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00008b50: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+00008b60: 652e 4368 6563 6b4c 6576 656c 2e41 4c49  e.CheckLevel.ALI
+00008b70: 5645 2e76 616c 7565 2c20 2761 6c69 7665  VE.value, 'alive
+00008b80: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00008b90: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
+00008ba0: 6c65 2e43 6865 636b 4c65 7665 6c2e 5245  le.CheckLevel.RE
+00008bb0: 4144 592e 7661 6c75 652c 2027 7265 6164  ADY.value, 'read
+00008bc0: 7927 290a 0a20 2020 2064 6566 2074 6573  y')..    def tes
+00008bd0: 745f 6368 6563 6b5f 7374 6174 7573 2873  t_check_status(s
+00008be0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+00008bf0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+00008c00: 6973 7428 7065 6262 6c65 2e43 6865 636b  ist(pebble.Check
+00008c10: 5374 6174 7573 292c 205b 0a20 2020 2020  Status), [.     
+00008c20: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
+00008c30: 6563 6b53 7461 7475 732e 5550 2c0a 2020  eckStatus.UP,.  
+00008c40: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+00008c50: 2e43 6865 636b 5374 6174 7573 2e44 4f57  .CheckStatus.DOW
+00008c60: 4e2c 0a20 2020 2020 2020 205d 290a 2020  N,.        ]).  
+00008c70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008c80: 7445 7175 616c 2870 6562 626c 652e 4368  tEqual(pebble.Ch
+00008c90: 6563 6b53 7461 7475 732e 5550 2e76 616c  eckStatus.UP.val
+00008ca0: 7565 2c20 2775 7027 290a 2020 2020 2020  ue, 'up').      
+00008cb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008cc0: 616c 2870 6562 626c 652e 4368 6563 6b53  al(pebble.CheckS
+00008cd0: 7461 7475 732e 444f 574e 2e76 616c 7565  tatus.DOWN.value
+00008ce0: 2c20 2764 6f77 6e27 290a 0a20 2020 2064  , 'down')..    d
+00008cf0: 6566 2074 6573 745f 6368 6563 6b5f 696e  ef test_check_in
+00008d00: 666f 2873 656c 6629 3a0a 2020 2020 2020  fo(self):.      
+00008d10: 2020 6368 6563 6b20 3d20 7065 6262 6c65    check = pebble
+00008d20: 2e43 6865 636b 496e 666f 280a 2020 2020  .CheckInfo(.    
+00008d30: 2020 2020 2020 2020 6e61 6d65 3d27 6368          name='ch
+00008d40: 6b31 272c 0a20 2020 2020 2020 2020 2020  k1',.           
+00008d50: 206c 6576 656c 3d70 6562 626c 652e 4368   level=pebble.Ch
+00008d60: 6563 6b4c 6576 656c 2e52 4541 4459 2c0a  eckLevel.READY,.
+00008d70: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00008d80: 7573 3d70 6562 626c 652e 4368 6563 6b53  us=pebble.CheckS
+00008d90: 7461 7475 732e 5550 2c0a 2020 2020 2020  tatus.UP,.      
+00008da0: 2020 2020 2020 7468 7265 7368 6f6c 643d        threshold=
+00008db0: 332c 0a20 2020 2020 2020 2029 0a20 2020  3,.        ).   
+00008dc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008dd0: 4571 7561 6c28 6368 6563 6b2e 6e61 6d65  Equal(check.name
+00008de0: 2c20 2763 686b 3127 290a 2020 2020 2020  , 'chk1').      
+00008df0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008e00: 616c 2863 6865 636b 2e6c 6576 656c 2c20  al(check.level, 
+00008e10: 7065 6262 6c65 2e43 6865 636b 4c65 7665  pebble.CheckLeve
+00008e20: 6c2e 5245 4144 5929 0a20 2020 2020 2020  l.READY).       
+00008e30: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008e40: 6c28 6368 6563 6b2e 7374 6174 7573 2c20  l(check.status, 
+00008e50: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
+00008e60: 7573 2e55 5029 0a20 2020 2020 2020 2073  us.UP).        s
+00008e70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00008e80: 6368 6563 6b2e 6661 696c 7572 6573 2c20  check.failures, 
+00008e90: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00008ea0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+00008eb0: 6b2e 7468 7265 7368 6f6c 642c 2033 290a  k.threshold, 3).
+00008ec0: 0a20 2020 2020 2020 2063 6865 636b 203d  .        check =
+00008ed0: 2070 6562 626c 652e 4368 6563 6b49 6e66   pebble.CheckInf
+00008ee0: 6f28 0a20 2020 2020 2020 2020 2020 206e  o(.            n
+00008ef0: 616d 653d 2763 686b 3227 2c0a 2020 2020  ame='chk2',.    
+00008f00: 2020 2020 2020 2020 6c65 7665 6c3d 7065          level=pe
+00008f10: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+00008f20: 414c 4956 452c 0a20 2020 2020 2020 2020  ALIVE,.         
+00008f30: 2020 2073 7461 7475 733d 7065 6262 6c65     status=pebble
+00008f40: 2e43 6865 636b 5374 6174 7573 2e44 4f57  .CheckStatus.DOW
+00008f50: 4e2c 0a20 2020 2020 2020 2020 2020 2066  N,.            f
+00008f60: 6169 6c75 7265 733d 352c 0a20 2020 2020  ailures=5,.     
+00008f70: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
+00008f80: 3d33 2c0a 2020 2020 2020 2020 290a 2020  =3,.        ).  
+00008f90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008fa0: 7445 7175 616c 2863 6865 636b 2e6e 616d  tEqual(check.nam
+00008fb0: 652c 2027 6368 6b32 2729 0a20 2020 2020  e, 'chk2').     
+00008fc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00008fd0: 7561 6c28 6368 6563 6b2e 6c65 7665 6c2c  ual(check.level,
+00008fe0: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
+00008ff0: 656c 2e41 4c49 5645 290a 2020 2020 2020  el.ALIVE).      
+00009000: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009010: 616c 2863 6865 636b 2e73 7461 7475 732c  al(check.status,
+00009020: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
+00009030: 7475 732e 444f 574e 290a 2020 2020 2020  tus.DOWN).      
+00009040: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009050: 616c 2863 6865 636b 2e66 6169 6c75 7265  al(check.failure
+00009060: 732c 2035 290a 2020 2020 2020 2020 7365  s, 5).        se
+00009070: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00009080: 6865 636b 2e74 6872 6573 686f 6c64 2c20  heck.threshold, 
+00009090: 3329 0a0a 2020 2020 2020 2020 6368 6563  3)..        chec
+000090a0: 6b20 3d20 7065 6262 6c65 2e43 6865 636b  k = pebble.Check
+000090b0: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+000090c0: 0a20 2020 2020 2020 2020 2020 2027 6e61  .            'na
+000090d0: 6d65 273a 2027 6368 6b33 272c 0a20 2020  me': 'chk3',.   
+000090e0: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+000090f0: 273a 2027 7570 272c 0a20 2020 2020 2020  ': 'up',.       
+00009100: 2020 2020 2027 7468 7265 7368 6f6c 6427       'threshold'
+00009110: 3a20 332c 0a20 2020 2020 2020 207d 290a  : 3,.        }).
+00009120: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00009130: 6572 7445 7175 616c 2863 6865 636b 2e6e  ertEqual(check.n
+00009140: 616d 652c 2027 6368 6b33 2729 0a20 2020  ame, 'chk3').   
+00009150: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00009160: 4571 7561 6c28 6368 6563 6b2e 6c65 7665  Equal(check.leve
+00009170: 6c2c 2070 6562 626c 652e 4368 6563 6b4c  l, pebble.CheckL
+00009180: 6576 656c 2e55 4e53 4554 290a 2020 2020  evel.UNSET).    
+00009190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000091a0: 7175 616c 2863 6865 636b 2e73 7461 7475  qual(check.statu
+000091b0: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
+000091c0: 7461 7475 732e 5550 290a 2020 2020 2020  tatus.UP).      
+000091d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000091e0: 616c 2863 6865 636b 2e66 6169 6c75 7265  al(check.failure
+000091f0: 732c 2030 290a 2020 2020 2020 2020 7365  s, 0).        se
+00009200: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00009210: 6865 636b 2e74 6872 6573 686f 6c64 2c20  heck.threshold, 
+00009220: 3329 0a0a 2020 2020 2020 2020 6368 6563  3)..        chec
+00009230: 6b20 3d20 7065 6262 6c65 2e43 6865 636b  k = pebble.Check
+00009240: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
+00009250: 0a20 2020 2020 2020 2020 2020 2027 6e61  .            'na
+00009260: 6d65 273a 2027 6368 6b34 272c 0a20 2020  me': 'chk4',.   
+00009270: 2020 2020 2020 2020 2027 6c65 7665 6c27           'level'
+00009280: 3a20 7065 6262 6c65 2e43 6865 636b 4c65  : pebble.CheckLe
+00009290: 7665 6c2e 554e 5345 542c 0a20 2020 2020  vel.UNSET,.     
+000092a0: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
+000092b0: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
+000092c0: 7475 732e 444f 574e 2c0a 2020 2020 2020  tus.DOWN,.      
+000092d0: 2020 2020 2020 2766 6169 6c75 7265 7327        'failures'
+000092e0: 3a20 332c 0a20 2020 2020 2020 2020 2020  : 3,.           
+000092f0: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
+00009300: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00009310: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00009320: 7175 616c 2863 6865 636b 2e6e 616d 652c  qual(check.name,
+00009330: 2027 6368 6b34 2729 0a20 2020 2020 2020   'chk4').       
+00009340: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009350: 6c28 6368 6563 6b2e 6c65 7665 6c2c 2070  l(check.level, p
+00009360: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
+00009370: 2e55 4e53 4554 290a 2020 2020 2020 2020  .UNSET).        
+00009380: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00009390: 2863 6865 636b 2e73 7461 7475 732c 2070  (check.status, p
+000093a0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+000093b0: 732e 444f 574e 290a 2020 2020 2020 2020  s.DOWN).        
+000093c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000093d0: 2863 6865 636b 2e66 6169 6c75 7265 732c  (check.failures,
+000093e0: 2033 290a 2020 2020 2020 2020 7365 6c66   3).        self
+000093f0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+00009400: 636b 2e74 6872 6573 686f 6c64 2c20 3329  ck.threshold, 3)
+00009410: 0a0a 0a63 6c61 7373 204d 6f63 6b43 6c69  ...class MockCli
+00009420: 656e 7428 7065 6262 6c65 2e43 6c69 656e  ent(pebble.Clien
+00009430: 7429 3a0a 2020 2020 2222 224d 6f63 6b20  t):.    """Mock 
+00009440: 5065 6262 6c65 2063 6c69 656e 7420 7468  Pebble client th
+00009450: 6174 2073 696d 706c 7920 7265 636f 7264  at simply record
+00009460: 7320 7265 7175 6573 7473 2061 6e64 2072  s requests and r
+00009470: 6574 7572 6e73 2073 746f 7265 6420 7265  eturns stored re
+00009480: 7370 6f6e 7365 732e 2222 220a 0a20 2020  sponses."""..   
+00009490: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000094a0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000094b0: 662e 7265 7175 6573 7473 203d 205b 5d0a  f.requests = [].
+000094c0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+000094d0: 706f 6e73 6573 203d 205b 5d0a 2020 2020  ponses = [].    
+000094e0: 2020 2020 7365 6c66 2e74 696d 656f 7574      self.timeout
+000094f0: 203d 2035 0a20 2020 2020 2020 2073 656c   = 5.        sel
+00009500: 662e 7765 6273 6f63 6b65 7473 203d 207b  f.websockets = {
+00009510: 7d0a 0a20 2020 2064 6566 205f 7265 7175  }..    def _requ
+00009520: 6573 7428 7365 6c66 2c20 6d65 7468 6f64  est(self, method
+00009530: 2c20 7061 7468 2c20 7175 6572 793d 4e6f  , path, query=No
+00009540: 6e65 2c20 626f 6479 3d4e 6f6e 6529 3a0a  ne, body=None):.
+00009550: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+00009560: 7565 7374 732e 6170 7065 6e64 2828 6d65  uests.append((me
+00009570: 7468 6f64 2c20 7061 7468 2c20 7175 6572  thod, path, quer
+00009580: 792c 2062 6f64 7929 290a 2020 2020 2020  y, body)).      
+00009590: 2020 7265 7370 203d 2073 656c 662e 7265    resp = self.re
+000095a0: 7370 6f6e 7365 732e 706f 7028 3029 0a20  sponses.pop(0). 
+000095b0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000095c0: 616e 6365 2872 6573 702c 2045 7863 6570  ance(resp, Excep
+000095d0: 7469 6f6e 293a 0a20 2020 2020 2020 2020  tion):.         
+000095e0: 2020 2072 6169 7365 2072 6573 700a 2020     raise resp.  
+000095f0: 2020 2020 2020 6966 2063 616c 6c61 626c        if callabl
+00009600: 6528 7265 7370 293a 0a20 2020 2020 2020  e(resp):.       
+00009610: 2020 2020 2072 6573 7020 3d20 7265 7370       resp = resp
+00009620: 2829 0a20 2020 2020 2020 2072 6574 7572  ().        retur
+00009630: 6e20 7265 7370 0a0a 2020 2020 6465 6620  n resp..    def 
+00009640: 5f72 6571 7565 7374 5f72 6177 2873 656c  _request_raw(sel
+00009650: 662c 206d 6574 686f 642c 2070 6174 682c  f, method, path,
+00009660: 2071 7565 7279 3d4e 6f6e 652c 2068 6561   query=None, hea
+00009670: 6465 7273 3d4e 6f6e 652c 2064 6174 613d  ders=None, data=
+00009680: 4e6f 6e65 293a 0a20 2020 2020 2020 2073  None):.        s
+00009690: 656c 662e 7265 7175 6573 7473 2e61 7070  elf.requests.app
+000096a0: 656e 6428 286d 6574 686f 642c 2070 6174  end((method, pat
+000096b0: 682c 2071 7565 7279 2c20 6865 6164 6572  h, query, header
+000096c0: 732c 2064 6174 6129 290a 2020 2020 2020  s, data)).      
+000096d0: 2020 6865 6164 6572 732c 2062 6f64 7920    headers, body 
+000096e0: 3d20 7365 6c66 2e72 6573 706f 6e73 6573  = self.responses
+000096f0: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
+00009700: 7265 7475 726e 204d 6f63 6b48 5454 5052  return MockHTTPR
+00009710: 6573 706f 6e73 6528 6865 6164 6572 732c  esponse(headers,
+00009720: 2062 6f64 7929 0a0a 2020 2020 6465 6620   body)..    def 
+00009730: 5f63 6f6e 6e65 6374 5f77 6562 736f 636b  _connect_websock
+00009740: 6574 2873 656c 662c 2074 6173 6b5f 6964  et(self, task_id
+00009750: 2c20 7765 6273 6f63 6b65 745f 6964 293a  , websocket_id):
+00009760: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00009770: 7365 6c66 2e77 6562 736f 636b 6574 735b  self.websockets[
+00009780: 7461 736b 5f69 642c 2077 6562 736f 636b  task_id, websock
+00009790: 6574 5f69 645d 0a0a 0a63 6c61 7373 204d  et_id]...class M
+000097a0: 6f63 6b48 5454 5052 6573 706f 6e73 653a  ockHTTPResponse:
+000097b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000097c0: 5f28 7365 6c66 2c20 6865 6164 6572 732c  _(self, headers,
+000097d0: 2062 6f64 7929 3a0a 2020 2020 2020 2020   body):.        
+000097e0: 7365 6c66 2e68 6561 6465 7273 203d 2068  self.headers = h
+000097f0: 6561 6465 7273 0a20 2020 2020 2020 2072  eaders.        r
+00009800: 6561 6465 7220 3d20 696f 2e42 7974 6573  eader = io.Bytes
+00009810: 494f 2862 6f64 7929 0a20 2020 2020 2020  IO(body).       
+00009820: 2073 656c 662e 7265 6164 203d 2072 6561   self.read = rea
+00009830: 6465 722e 7265 6164 0a0a 0a63 6c61 7373  der.read...class
+00009840: 204d 6f63 6b54 696d 653a 0a20 2020 2022   MockTime:.    "
+00009850: 2222 4d6f 636b 6564 2076 6572 7369 6f6e  ""Mocked version
+00009860: 7320 6f66 2074 696d 652e 7469 6d65 2829  s of time.time()
+00009870: 2061 6e64 2074 696d 652e 736c 6565 7028   and time.sleep(
+00009880: 292e 0a0a 2020 2020 4d6f 636b 5469 6d65  )...    MockTime
+00009890: 2e73 6c65 6570 2829 2061 6476 616e 6365  .sleep() advance
+000098a0: 7320 7468 6520 636c 6f63 6b20 616e 6420  s the clock and 
+000098b0: 4d6f 636b 5469 6d65 2e74 696d 6528 2920  MockTime.time() 
+000098c0: 7265 7475 726e 7320 7468 6520 6375 7272  returns the curr
+000098d0: 656e 7420 7469 6d65 2e0a 2020 2020 2222  ent time..    ""
+000098e0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+000098f0: 745f 5f28 7365 6c66 293a 0a20 2020 2020  t__(self):.     
+00009900: 2020 2073 656c 662e 5f74 696d 6520 3d20     self._time = 
+00009910: 300a 0a20 2020 2064 6566 2074 696d 6528  0..    def time(
+00009920: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00009930: 6574 7572 6e20 7365 6c66 2e5f 7469 6d65  eturn self._time
+00009940: 0a0a 2020 2020 6465 6620 736c 6565 7028  ..    def sleep(
+00009950: 7365 6c66 2c20 6465 6c61 7929 3a0a 2020  self, delay):.  
+00009960: 2020 2020 2020 7365 6c66 2e5f 7469 6d65        self._time
+00009970: 202b 3d20 6465 6c61 790a 0a0a 6465 6620   += delay...def 
+00009980: 6275 696c 645f 6d6f 636b 5f63 6861 6e67  build_mock_chang
+00009990: 655f 6469 6374 2863 6861 6e67 655f 6964  e_dict(change_id
+000099a0: 3d27 3730 2729 3a0a 2020 2020 7265 7475  ='70'):.    retu
+000099b0: 726e 207b 0a20 2020 2020 2020 2022 6964  rn {.        "id
+000099c0: 223a 2063 6861 6e67 655f 6964 2c0a 2020  ": change_id,.  
+000099d0: 2020 2020 2020 226b 696e 6422 3a20 2261        "kind": "a
+000099e0: 7574 6f73 7461 7274 222c 0a20 2020 2020  utostart",.     
+000099f0: 2020 2022 7265 6164 7922 3a20 5472 7565     "ready": True
+00009a00: 2c0a 2020 2020 2020 2020 2272 6561 6479  ,.        "ready
+00009a10: 2d74 696d 6522 3a20 2232 3032 312d 3031  -time": "2021-01
+00009a20: 2d32 3854 3134 3a33 373a 3034 2e32 3931  -28T14:37:04.291
+00009a30: 3531 3737 3638 2b31 333a 3030 222c 0a20  517768+13:00",. 
+00009a40: 2020 2020 2020 2022 7370 6177 6e2d 7469         "spawn-ti
+00009a50: 6d65 223a 2022 3230 3231 2d30 312d 3238  me": "2021-01-28
+00009a60: 5431 343a 3337 3a30 322e 3234 3732 3032  T14:37:02.247202
+00009a70: 3130 352b 3133 3a30 3022 2c0a 2020 2020  105+13:00",.    
+00009a80: 2020 2020 2273 7461 7475 7322 3a20 2244      "status": "D
+00009a90: 6f6e 6522 2c0a 2020 2020 2020 2020 2273  one",.        "s
+00009aa0: 756d 6d61 7279 223a 2027 4175 746f 7374  ummary": 'Autost
+00009ab0: 6172 7420 7365 7276 6963 6520 2273 7663  art service "svc
+00009ac0: 2227 2c0a 2020 2020 2020 2020 2274 6173  "',.        "tas
+00009ad0: 6b73 223a 205b 0a20 2020 2020 2020 2020  ks": [.         
+00009ae0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00009af0: 2020 2020 2022 6964 223a 2022 3738 222c       "id": "78",
+00009b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009b10: 2022 6b69 6e64 223a 2022 7374 6172 7422   "kind": "start"
+00009b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009b30: 2020 2270 726f 6772 6573 7322 3a20 7b0a    "progress": {.
+00009b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b50: 2020 2020 2264 6f6e 6522 3a20 312c 0a20      "done": 1,. 
+00009b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b70: 2020 2022 6c61 6265 6c22 3a20 2222 2c0a     "label": "",.
+00009b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b90: 2020 2020 2274 6f74 616c 223a 2031 2c0a      "total": 1,.
+00009ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bb0: 2020 2020 2265 7874 7261 2d66 6965 6c64      "extra-field
+00009bc0: 223a 2022 666f 6f22 2c0a 2020 2020 2020  ": "foo",.      
+00009bd0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00009be0: 2020 2020 2020 2020 2020 2020 2022 7265               "re
+00009bf0: 6164 792d 7469 6d65 223a 2022 3230 3231  ady-time": "2021
+00009c00: 2d30 312d 3238 5431 343a 3337 3a30 332e  -01-28T14:37:03.
+00009c10: 3237 3032 3138 3737 382b 3133 3a30 3022  270218778+13:00"
+00009c20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009c30: 2020 2273 7061 776e 2d74 696d 6522 3a20    "spawn-time": 
+00009c40: 2232 3032 312d 3031 2d32 3854 3134 3a33  "2021-01-28T14:3
+00009c50: 373a 3032 2e32 3437 3135 3831 3632 2b31  7:02.247158162+1
+00009c60: 333a 3030 222c 0a20 2020 2020 2020 2020  3:00",.         
+00009c70: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+00009c80: 2022 446f 6e65 222c 0a20 2020 2020 2020   "Done",.       
+00009c90: 2020 2020 2020 2020 2022 7375 6d6d 6172           "summar
+00009ca0: 7922 3a20 2753 7461 7274 2073 6572 7669  y": 'Start servi
+00009cb0: 6365 2022 7376 6322 272c 0a20 2020 2020  ce "svc"',.     
+00009cc0: 2020 2020 2020 2020 2020 2022 6578 7472             "extr
+00009cd0: 612d 6669 656c 6422 3a20 2266 6f6f 222c  a-field": "foo",
+00009ce0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+00009cf0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00009d00: 2020 2022 6578 7472 612d 6669 656c 6422     "extra-field"
+00009d10: 3a20 2266 6f6f 222c 0a20 2020 207d 0a0a  : "foo",.    }..
+00009d20: 0a63 6c61 7373 2054 6573 744d 756c 7469  .class TestMulti
+00009d30: 7061 7274 5061 7273 6572 2875 6e69 7474  partParser(unitt
+00009d40: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+00009d50: 2020 2063 6c61 7373 205f 4361 7365 3a0a     class _Case:.
+00009d60: 2020 2020 2020 2020 6465 6620 5f5f 696e          def __in
+00009d70: 6974 5f5f 280a 2020 2020 2020 2020 2020  it__(.          
+00009d80: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00009d90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00009da0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009db0: 2020 6461 7461 2c0a 2020 2020 2020 2020    data,.        
+00009dc0: 2020 2020 2020 2020 7761 6e74 5f68 6561          want_hea
+00009dd0: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+00009de0: 2020 2020 2020 7761 6e74 5f62 6f64 6965        want_bodie
+00009df0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00009e00: 2020 2077 616e 745f 626f 6469 6573 5f64     want_bodies_d
+00009e10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00009e20: 2020 2020 206d 6178 5f62 6f75 6e64 6172       max_boundar
+00009e30: 793d 3134 2c0a 2020 2020 2020 2020 2020  y=14,.          
+00009e40: 2020 2020 2020 6d61 785f 6c6f 6f6b 6168        max_lookah
+00009e50: 6561 643d 3820 2a20 3130 3234 2c0a 2020  ead=8 * 1024,.  
+00009e60: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00009e70: 726f 723d 2727 293a 0a20 2020 2020 2020  ror=''):.       
+00009e80: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+00009e90: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
+00009ea0: 2020 7365 6c66 2e64 6174 6120 3d20 6461    self.data = da
+00009eb0: 7461 0a20 2020 2020 2020 2020 2020 2073  ta.            s
+00009ec0: 656c 662e 7761 6e74 5f68 6561 6465 7273  elf.want_headers
+00009ed0: 203d 2077 616e 745f 6865 6164 6572 730a   = want_headers.
+00009ee0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00009ef0: 2e77 616e 745f 626f 6469 6573 203d 2077  .want_bodies = w
+00009f00: 616e 745f 626f 6469 6573 0a20 2020 2020  ant_bodies.     
+00009f10: 2020 2020 2020 2073 656c 662e 7761 6e74         self.want
+00009f20: 5f62 6f64 6965 735f 646f 6e65 203d 2077  _bodies_done = w
+00009f30: 616e 745f 626f 6469 6573 5f64 6f6e 650a  ant_bodies_done.
+00009f40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00009f50: 2e6d 6178 5f62 6f75 6e64 6172 7920 3d20  .max_boundary = 
+00009f60: 6d61 785f 626f 756e 6461 7279 0a20 2020  max_boundary.   
+00009f70: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00009f80: 785f 6c6f 6f6b 6168 6561 6420 3d20 6d61  x_lookahead = ma
+00009f90: 785f 6c6f 6f6b 6168 6561 640a 2020 2020  x_lookahead.    
+00009fa0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
+00009fb0: 6f72 203d 2065 7272 6f72 0a0a 2020 2020  or = error..    
+00009fc0: 6465 6620 7465 7374 5f6d 756c 7469 7061  def test_multipa
+00009fd0: 7274 5f70 6172 7365 7228 7365 6c66 293a  rt_parser(self):
+00009fe0: 0a20 2020 2020 2020 2074 6573 7473 203d  .        tests =
+00009ff0: 205b 0a20 2020 2020 2020 2020 2020 2054   [.            T
+0000a000: 6573 744d 756c 7469 7061 7274 5061 7273  estMultipartPars
+0000a010: 6572 2e5f 4361 7365 280a 2020 2020 2020  er._Case(.      
+0000a020: 2020 2020 2020 2020 2020 2762 6173 656c            'basel
+0000a030: 696e 6527 2c0a 2020 2020 2020 2020 2020  ine',.          
+0000a040: 2020 2020 2020 6227 5c72 5c6e 2d2d 7177        b'\r\n--qw
+0000a050: 6572 7479 5c72 5c6e 6865 6164 6572 2066  erty\r\nheader f
+0000a060: 6f6f 5c72 5c6e 5c72 5c6e 666f 6f20 6261  oo\r\n\r\nfoo ba
+0000a070: 725c 6e66 6f6f 2062 6172 5c72 5c6e 2d2d  r\nfoo bar\r\n--
+0000a080: 7177 6572 7479 2d2d 5c72 5c6e 272c 0a20  qwerty--\r\n',. 
+0000a090: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0000a0a0: 6227 6865 6164 6572 2066 6f6f 5c72 5c6e  b'header foo\r\n
+0000a0b0: 5c72 5c6e 275d 2c0a 2020 2020 2020 2020  \r\n'],.        
+0000a0c0: 2020 2020 2020 2020 5b62 2766 6f6f 2062          [b'foo b
+0000a0d0: 6172 5c6e 666f 6f20 6261 7227 5d2c 0a20  ar\nfoo bar'],. 
+0000a0e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a0f0: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
+0000a100: 5b54 7275 655d 2c0a 2020 2020 2020 2020  [True],.        
+0000a110: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+0000a120: 2020 2054 6573 744d 756c 7469 7061 7274     TestMultipart
+0000a130: 5061 7273 6572 2e5f 4361 7365 280a 2020  Parser._Case(.  
+0000a140: 2020 2020 2020 2020 2020 2020 2020 2769                'i
+0000a150: 6e63 6f6d 706c 6574 6520 6865 6164 6572  ncomplete header
+0000a160: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000a170: 2020 2062 275c 725c 6e2d 2d71 7765 7274     b'\r\n--qwert
+0000a180: 795c 725c 6e68 6561 6465 7220 666f 6f5c  y\r\nheader foo\
+0000a190: 725c 6e27 2c0a 2020 2020 2020 2020 2020  r\n',.          
+0000a1a0: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
+0000a1b0: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
+0000a1c0: 2020 2020 2020 2020 2020 2020 2020 7761                wa
+0000a1d0: 6e74 5f62 6f64 6965 735f 646f 6e65 3d5b  nt_bodies_done=[
+0000a1e0: 5d2c 0a20 2020 2020 2020 2020 2020 2029  ],.            )
+0000a1f0: 2c0a 2020 2020 2020 2020 2020 2020 5465  ,.            Te
+0000a200: 7374 4d75 6c74 6970 6172 7450 6172 7365  stMultipartParse
+0000a210: 722e 5f43 6173 6528 0a20 2020 2020 2020  r._Case(.       
+0000a220: 2020 2020 2020 2020 2027 6d69 7373 696e           'missin
+0000a230: 6720 6865 6164 6572 272c 0a20 2020 2020  g header',.     
+0000a240: 2020 2020 2020 2020 2020 2062 275c 725c             b'\r\
+0000a250: 6e2d 2d71 7765 7274 795c 725c 6e68 6561  n--qwerty\r\nhea
+0000a260: 6465 7220 666f 6f5c 725c 6e27 202b 2034  der foo\r\n' + 4
+0000a270: 3020 2a20 6227 2027 2c0a 2020 2020 2020  0 * b' ',.      
+0000a280: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
+0000a290: 2020 2020 2020 2020 2020 2020 2020 5b5d                []
+0000a2a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a2b0: 2020 7761 6e74 5f62 6f64 6965 735f 646f    want_bodies_do
+0000a2c0: 6e65 3d5b 5d2c 0a20 2020 2020 2020 2020  ne=[],.         
+0000a2d0: 2020 2020 2020 206d 6178 5f6c 6f6f 6b61         max_looka
+0000a2e0: 6865 6164 3d34 302c 0a20 2020 2020 2020  head=40,.       
+0000a2f0: 2020 2020 2020 2020 2065 7272 6f72 3d27           error='
+0000a300: 6865 6164 6572 2074 6572 6d69 6e61 746f  header terminato
+0000a310: 7220 6e6f 7420 666f 756e 6427 2c0a 2020  r not found',.  
+0000a320: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+0000a330: 2020 2020 2020 2020 2054 6573 744d 756c           TestMul
+0000a340: 7469 7061 7274 5061 7273 6572 2e5f 4361  tipartParser._Ca
+0000a350: 7365 280a 2020 2020 2020 2020 2020 2020  se(.            
+0000a360: 2020 2020 2769 6e63 6f6d 706c 6574 6520      'incomplete 
+0000a370: 626f 6479 2074 6572 6d69 6e61 746f 7227  body terminator'
+0000a380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a390: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
+0000a3a0: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
+0000a3b0: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
+0000a3c0: 6e2d 2d71 7765 7274 795c 7268 656c 6c6f  n--qwerty\rhello
+0000a3d0: 206d 7920 6e61 6d65 2069 7320 6a6f 6520   my name is joe 
+0000a3e0: 616e 6420 4920 776f 726b 2069 6e20 6120  and I work in a 
+0000a3f0: 6275 7474 6f6e 2066 6163 746f 7279 272c  button factory',
+0000a400: 2020 2320 6e6f 7161 0a20 2020 2020 2020    # noqa.       
+0000a410: 2020 2020 2020 2020 205b 6227 6865 6164           [b'head
+0000a420: 6572 2066 6f6f 5c72 5c6e 5c72 5c6e 275d  er foo\r\n\r\n']
+0000a430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a440: 2020 5b62 2766 6f6f 2062 6172 5c72 5c6e    [b'foo bar\r\n
+0000a450: 2d2d 7177 6572 7479 5c72 6865 6c6c 6f20  --qwerty\rhello 
+0000a460: 6d79 206e 616d 6520 6973 206a 6f65 2061  my name is joe a
+0000a470: 6e64 2049 2077 6f72 6b20 696e 2061 2027  nd I work in a '
+0000a480: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000a490: 2020 2077 616e 745f 626f 6469 6573 5f64     want_bodies_d
+0000a4a0: 6f6e 653d 5b46 616c 7365 5d2c 0a20 2020  one=[False],.   
+0000a4b0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0000a4c0: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
+0000a4d0: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
+0000a4e0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000a4f0: 2020 2027 656d 7074 7920 626f 6479 272c     'empty body',
+0000a500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a510: 2062 275c 725c 6e2d 2d71 7765 7274 795c   b'\r\n--qwerty\
+0000a520: 725c 6e68 6561 6465 7220 666f 6f5c 725c  r\nheader foo\r\
+0000a530: 6e5c 725c 6e5c 725c 6e2d 2d71 7765 7274  n\r\n\r\n--qwert
+0000a540: 795c 725c 6e27 2c0a 2020 2020 2020 2020  y\r\n',.        
+0000a550: 2020 2020 2020 2020 5b62 2768 6561 6465          [b'heade
+0000a560: 7220 666f 6f5c 725c 6e5c 725c 6e27 5d2c  r foo\r\n\r\n'],
 0000a570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a580: 205b 6227 6865 6164 6572 2066 6f6f 5c72   [b'header foo\r
-0000a590: 5c6e 5c72 5c6e 275d 2c0a 2020 2020 2020  \n\r\n'],.      
-0000a5a0: 2020 2020 2020 2020 2020 5b62 2766 6f6f            [b'foo
-0000a5b0: 2062 6172 275d 2c0a 2020 2020 2020 2020   bar'],.        
-0000a5c0: 2020 2020 2020 2020 7761 6e74 5f62 6f64          want_bod
-0000a5d0: 6965 735f 646f 6e65 3d5b 5472 7565 5d2c  ies_done=[True],
-0000a5e0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-0000a5f0: 2020 2020 2020 2020 2020 2020 5465 7374              Test
-0000a600: 4d75 6c74 6970 6172 7450 6172 7365 722e  MultipartParser.
-0000a610: 5f43 6173 6528 0a20 2020 2020 2020 2020  _Case(.         
-0000a620: 2020 2020 2020 2027 6967 6e6f 7265 2074         'ignore t
-0000a630: 7261 696c 696e 6720 6761 7262 6167 6527  railing garbage'
-0000a640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a650: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
-0000a660: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
-0000a670: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
-0000a680: 6e2d 2d71 7765 7274 795c 725c 6e68 656c  n--qwerty\r\nhel
-0000a690: 6c6f 206d 7920 6e61 6d65 2069 7320 6a6f  lo my name is jo
-0000a6a0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-0000a6b0: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
-0000a6c0: 6f5c 725c 6e5c 725c 6e27 5d2c 0a20 2020  o\r\n\r\n'],.   
-0000a6d0: 2020 2020 2020 2020 2020 2020 205b 6227               [b'
-0000a6e0: 666f 6f20 6261 7227 5d2c 0a20 2020 2020  foo bar'],.     
-0000a6f0: 2020 2020 2020 2020 2020 2077 616e 745f             want_
-0000a700: 626f 6469 6573 5f64 6f6e 653d 5b54 7275  bodies_done=[Tru
-0000a710: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
-0000a720: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
-0000a730: 6573 744d 756c 7469 7061 7274 5061 7273  estMultipartPars
-0000a740: 6572 2e5f 4361 7365 280a 2020 2020 2020  er._Case(.      
-0000a750: 2020 2020 2020 2020 2020 2762 6f75 6e64            'bound
-0000a760: 6172 7920 616c 6c6f 7720 6c69 6e65 6172  ary allow linear
-0000a770: 2077 6869 7465 7370 6163 6527 2c0a 2020   whitespace',.  
-0000a780: 2020 2020 2020 2020 2020 2020 2020 6227                b'
-0000a790: 5c72 5c6e 2d2d 7177 6572 7479 205c 7420  \r\n--qwerty \t 
-0000a7a0: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
-0000a7b0: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
-0000a7c0: 6e2d 2d71 7765 7274 795c 725c 6e27 2c0a  n--qwerty\r\n',.
-0000a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7e0: 5b62 2768 6561 6465 7220 666f 6f5c 725c  [b'header foo\r\
-0000a7f0: 6e5c 725c 6e27 5d2c 0a20 2020 2020 2020  n\r\n'],.       
-0000a800: 2020 2020 2020 2020 205b 6227 666f 6f20           [b'foo 
-0000a810: 6261 7227 5d2c 0a20 2020 2020 2020 2020  bar'],.         
-0000a820: 2020 2020 2020 2077 616e 745f 626f 6469         want_bodi
-0000a830: 6573 5f64 6f6e 653d 5b54 7275 655d 2c0a  es_done=[True],.
-0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a850: 6d61 785f 626f 756e 6461 7279 3d32 302c  max_boundary=20,
-0000a860: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-0000a870: 2020 2020 2020 2020 2020 2020 5465 7374              Test
-0000a880: 4d75 6c74 6970 6172 7450 6172 7365 722e  MultipartParser.
-0000a890: 5f43 6173 6528 0a20 2020 2020 2020 2020  _Case(.         
-0000a8a0: 2020 2020 2020 2027 7465 726d 696e 616c         'terminal
-0000a8b0: 2062 6f75 6e64 6172 7920 616c 6c6f 7720   boundary allow 
-0000a8c0: 6c69 6e65 6172 2077 6869 7465 7370 6163  linear whitespac
-0000a8d0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-0000a8e0: 2020 2020 6227 5c72 5c6e 2d2d 7177 6572      b'\r\n--qwer
-0000a8f0: 7479 5c72 5c6e 6865 6164 6572 2066 6f6f  ty\r\nheader foo
-0000a900: 5c72 5c6e 5c72 5c6e 666f 6f20 6261 725c  \r\n\r\nfoo bar\
-0000a910: 725c 6e2d 2d71 7765 7274 792d 2d20 5c74  r\n--qwerty-- \t
-0000a920: 205c 725c 6e27 2c0a 2020 2020 2020 2020   \r\n',.        
-0000a930: 2020 2020 2020 2020 5b62 2768 6561 6465          [b'heade
-0000a940: 7220 666f 6f5c 725c 6e5c 725c 6e27 5d2c  r foo\r\n\r\n'],
-0000a950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a960: 205b 6227 666f 6f20 6261 7227 5d2c 0a20   [b'foo bar'],. 
-0000a970: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000a980: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
-0000a990: 5b54 7275 655d 2c0a 2020 2020 2020 2020  [True],.        
-0000a9a0: 2020 2020 2020 2020 6d61 785f 626f 756e          max_boun
-0000a9b0: 6461 7279 3d32 302c 0a20 2020 2020 2020  dary=20,.       
-0000a9c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0000a9d0: 2020 2020 5465 7374 4d75 6c74 6970 6172      TestMultipar
-0000a9e0: 7450 6172 7365 722e 5f43 6173 6528 0a20  tParser._Case(. 
-0000a9f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000aa00: 6d75 6c74 6970 6c65 2070 6172 7473 272c  multiple parts',
-0000aa10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aa20: 2062 275c 725c 6e2d 2d71 7765 7274 7920   b'\r\n--qwerty 
-0000aa30: 5c74 205c 725c 6e68 6561 6465 7220 666f  \t \r\nheader fo
-0000aa40: 6f5c 725c 6e5c 725c 6e66 6f6f 2062 6172  o\r\n\r\nfoo bar
-0000aa50: 5c72 5c6e 2d2d 7177 6572 7479 5c72 5c6e  \r\n--qwerty\r\n
-0000aa60: 6865 6164 6572 2062 6172 5c72 5c6e 5c72  header bar\r\n\r
-0000aa70: 5c6e 666f 6f20 6261 7a5c 725c 6e2d 2d71  \nfoo baz\r\n--q
-0000aa80: 7765 7274 792d 2d5c 725c 6e27 2c20 2023  werty--\r\n',  #
-0000aa90: 206e 6f71 610a 2020 2020 2020 2020 2020   noqa.          
-0000aaa0: 2020 2020 2020 5b62 2768 6561 6465 7220        [b'header 
-0000aab0: 666f 6f5c 725c 6e5c 725c 6e27 2c20 6227  foo\r\n\r\n', b'
-0000aac0: 6865 6164 6572 2062 6172 5c72 5c6e 5c72  header bar\r\n\r
-0000aad0: 5c6e 275d 2c0a 2020 2020 2020 2020 2020  \n'],.          
-0000aae0: 2020 2020 2020 5b62 2766 6f6f 2062 6172        [b'foo bar
-0000aaf0: 272c 2062 2766 6f6f 2062 617a 275d 2c0a  ', b'foo baz'],.
-0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab10: 7761 6e74 5f62 6f64 6965 735f 646f 6e65  want_bodies_done
-0000ab20: 3d5b 5472 7565 2c20 5472 7565 5d2c 0a20  =[True, True],. 
-0000ab30: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0000ab40: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
-0000ab50: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
-0000ab60: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
-0000ab70: 2020 2020 2027 6967 6e6f 7265 2061 6674       'ignore aft
-0000ab80: 6572 2074 6572 6d69 6e61 6c20 626f 756e  er terminal boun
-0000ab90: 6461 7279 272c 0a20 2020 2020 2020 2020  dary',.         
-0000aba0: 2020 2020 2020 2062 275c 725c 6e2d 2d71         b'\r\n--q
-0000abb0: 7765 7274 7920 5c74 205c 725c 6e68 6561  werty \t \r\nhea
-0000abc0: 6465 7220 666f 6f5c 725c 6e5c 725c 6e66  der foo\r\n\r\nf
-0000abd0: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
-0000abe0: 7479 2d2d 5c72 5c6e 6865 6164 6572 2062  ty--\r\nheader b
-0000abf0: 6172 5c72 5c6e 5c72 5c6e 666f 6f20 6261  ar\r\n\r\nfoo ba
-0000ac00: 7a5c 725c 6e2d 2d71 7765 7274 792d 2d5c  z\r\n--qwerty--\
-0000ac10: 725c 6e27 2c20 2023 206e 6f71 610a 2020  r\n',  # noqa.  
-0000ac20: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
-0000ac30: 2768 6561 6465 7220 666f 6f5c 725c 6e5c  'header foo\r\n\
-0000ac40: 725c 6e27 5d2c 0a20 2020 2020 2020 2020  r\n'],.         
-0000ac50: 2020 2020 2020 205b 6227 666f 6f20 6261         [b'foo ba
-0000ac60: 7227 5d2c 0a20 2020 2020 2020 2020 2020  r'],.           
-0000ac70: 2020 2020 2077 616e 745f 626f 6469 6573       want_bodies
-0000ac80: 5f64 6f6e 653d 5b54 7275 655d 2c0a 2020  _done=[True],.  
-0000ac90: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0000aca0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-0000acb0: 6368 756e 6b5f 7369 7a65 7320 3d20 5b31  chunk_sizes = [1
-0000acc0: 2c20 322c 2033 2c20 342c 2035 2c20 372c  , 2, 3, 4, 5, 7,
-0000acd0: 2031 332c 2031 372c 2031 392c 2032 332c   13, 17, 19, 23,
-0000ace0: 2032 392c 2033 312c 2033 372c 2034 322c   29, 31, 37, 42,
-0000acf0: 2035 302c 2031 3030 2c20 3130 3030 5d0a   50, 100, 1000].
-0000ad00: 2020 2020 2020 2020 6d61 726b 6572 203d          marker =
-0000ad10: 2062 2771 7765 7274 7927 0a20 2020 2020   b'qwerty'.     
-0000ad20: 2020 2066 6f72 2069 2c20 7465 7374 2069     for i, test i
-0000ad30: 6e20 656e 756d 6572 6174 6528 7465 7374  n enumerate(test
-0000ad40: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000ad50: 666f 7220 6368 756e 6b5f 7369 7a65 2069  for chunk_size i
-0000ad60: 6e20 6368 756e 6b5f 7369 7a65 733a 0a20  n chunk_sizes:. 
-0000ad70: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000ad80: 6561 6465 7273 203d 205b 5d0a 2020 2020  eaders = [].    
-0000ad90: 2020 2020 2020 2020 2020 2020 626f 6469              bodi
-0000ada0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-0000adb0: 2020 2020 2020 2020 626f 6469 6573 5f64          bodies_d
-0000adc0: 6f6e 6520 3d20 5b5d 0a0a 2020 2020 2020  one = []..      
-0000add0: 2020 2020 2020 2020 2020 6465 6620 6861            def ha
-0000ade0: 6e64 6c65 5f68 6561 6465 7228 6461 7461  ndle_header(data
-0000adf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000ae00: 2020 2020 2020 2068 6561 6465 7273 2e61         headers.a
-0000ae10: 7070 656e 6428 6279 7465 7328 6461 7461  ppend(bytes(data
-0000ae20: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0000ae30: 2020 2020 2020 2062 6f64 6965 732e 6170         bodies.ap
-0000ae40: 7065 6e64 2862 2727 290a 2020 2020 2020  pend(b'').      
-0000ae50: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000ae60: 6469 6573 5f64 6f6e 652e 6170 7065 6e64  dies_done.append
-0000ae70: 2846 616c 7365 290a 0a20 2020 2020 2020  (False)..       
-0000ae80: 2020 2020 2020 2020 2064 6566 2068 616e           def han
-0000ae90: 646c 655f 626f 6479 2864 6174 612c 2064  dle_body(data, d
-0000aea0: 6f6e 653d 4661 6c73 6529 3a0a 2020 2020  one=False):.    
-0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aec0: 626f 6469 6573 5b2d 315d 202b 3d20 6461  bodies[-1] += da
-0000aed0: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
-0000aee0: 2020 2020 2020 2062 6f64 6965 735f 646f         bodies_do
-0000aef0: 6e65 5b2d 315d 203d 2064 6f6e 650a 0a20  ne[-1] = done.. 
-0000af00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000af10: 6172 7365 7220 3d20 7065 6262 6c65 2e5f  arser = pebble._
-0000af20: 4d75 6c74 6970 6172 7450 6172 7365 7228  MultipartParser(
-0000af30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af40: 2020 2020 206d 6172 6b65 722c 0a20 2020       marker,.   
-0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af60: 2068 616e 646c 655f 6865 6164 6572 2c0a   handle_header,.
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af80: 2020 2020 6861 6e64 6c65 5f62 6f64 792c      handle_body,
-0000af90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000afa0: 2020 2020 206d 6178 5f62 6f75 6e64 6172       max_boundar
-0000afb0: 795f 6c65 6e67 7468 3d74 6573 742e 6d61  y_length=test.ma
-0000afc0: 785f 626f 756e 6461 7279 2c0a 2020 2020  x_boundary,.    
-0000afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afe0: 6d61 785f 6c6f 6f6b 6168 6561 643d 7465  max_lookahead=te
-0000aff0: 7374 2e6d 6178 5f6c 6f6f 6b61 6865 6164  st.max_lookahead
-0000b000: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000b010: 2020 7372 6320 3d20 696f 2e42 7974 6573    src = io.Bytes
-0000b020: 494f 2874 6573 742e 6461 7461 290a 0a20  IO(test.data).. 
-0000b030: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000b040: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000b050: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
-0000b060: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-0000b070: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0000b080: 203d 2073 7263 2e72 6561 6428 6368 756e   = src.read(chun
-0000b090: 6b5f 7369 7a65 290a 2020 2020 2020 2020  k_size).        
-0000b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0b0: 6966 206e 6f74 2064 6174 613a 0a20 2020  if not data:.   
-0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0d0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0000a580: 205b 6227 275d 2c0a 2020 2020 2020 2020   [b''],.        
+0000a590: 2020 2020 2020 2020 7761 6e74 5f62 6f64          want_bod
+0000a5a0: 6965 735f 646f 6e65 3d5b 5472 7565 5d2c  ies_done=[True],
+0000a5b0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0000a5c0: 2020 2020 2020 2020 2020 2020 5465 7374              Test
+0000a5d0: 4d75 6c74 6970 6172 7450 6172 7365 722e  MultipartParser.
+0000a5e0: 5f43 6173 6528 0a20 2020 2020 2020 2020  _Case(.         
+0000a5f0: 2020 2020 2020 2027 6967 6e6f 7265 206c         'ignore l
+0000a600: 6561 6469 6e67 2067 6172 6261 6765 272c  eading garbage',
+0000a610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a620: 2062 2768 656c 6c6f 206d 7920 6e61 6d65   b'hello my name
+0000a630: 2069 7320 6a6f 655c 725c 6e5c 6e5c 6e5c   is joe\r\n\n\n\
+0000a640: 6e5c 725c 6e2d 2d71 7765 7274 795c 725c  n\r\n--qwerty\r\
+0000a650: 6e68 6561 6465 7220 666f 6f5c 725c 6e5c  nheader foo\r\n\
+0000a660: 725c 6e66 6f6f 2062 6172 5c72 5c6e 2d2d  r\nfoo bar\r\n--
+0000a670: 7177 6572 7479 5c72 5c6e 272c 2020 2320  qwerty\r\n',  # 
+0000a680: 6e6f 7161 0a20 2020 2020 2020 2020 2020  noqa.           
+0000a690: 2020 2020 205b 6227 6865 6164 6572 2066       [b'header f
+0000a6a0: 6f6f 5c72 5c6e 5c72 5c6e 275d 2c0a 2020  oo\r\n\r\n'],.  
+0000a6b0: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
+0000a6c0: 2766 6f6f 2062 6172 275d 2c0a 2020 2020  'foo bar'],.    
+0000a6d0: 2020 2020 2020 2020 2020 2020 7761 6e74              want
+0000a6e0: 5f62 6f64 6965 735f 646f 6e65 3d5b 5472  _bodies_done=[Tr
+0000a6f0: 7565 5d2c 0a20 2020 2020 2020 2020 2020  ue],.           
+0000a700: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0000a710: 5465 7374 4d75 6c74 6970 6172 7450 6172  TestMultipartPar
+0000a720: 7365 722e 5f43 6173 6528 0a20 2020 2020  ser._Case(.     
+0000a730: 2020 2020 2020 2020 2020 2027 6967 6e6f             'igno
+0000a740: 7265 2074 7261 696c 696e 6720 6761 7262  re trailing garb
+0000a750: 6167 6527 2c0a 2020 2020 2020 2020 2020  age',.          
+0000a760: 2020 2020 2020 6227 5c72 5c6e 2d2d 7177        b'\r\n--qw
+0000a770: 6572 7479 5c72 5c6e 6865 6164 6572 2066  erty\r\nheader f
+0000a780: 6f6f 5c72 5c6e 5c72 5c6e 666f 6f20 6261  oo\r\n\r\nfoo ba
+0000a790: 725c 725c 6e2d 2d71 7765 7274 795c 725c  r\r\n--qwerty\r\
+0000a7a0: 6e68 656c 6c6f 206d 7920 6e61 6d65 2069  nhello my name i
+0000a7b0: 7320 6a6f 6527 2c0a 2020 2020 2020 2020  s joe',.        
+0000a7c0: 2020 2020 2020 2020 5b62 2768 6561 6465          [b'heade
+0000a7d0: 7220 666f 6f5c 725c 6e5c 725c 6e27 5d2c  r foo\r\n\r\n'],
+0000a7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a7f0: 205b 6227 666f 6f20 6261 7227 5d2c 0a20   [b'foo bar'],. 
+0000a800: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a810: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
+0000a820: 5b54 7275 655d 2c0a 2020 2020 2020 2020  [True],.        
+0000a830: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+0000a840: 2020 2054 6573 744d 756c 7469 7061 7274     TestMultipart
+0000a850: 5061 7273 6572 2e5f 4361 7365 280a 2020  Parser._Case(.  
+0000a860: 2020 2020 2020 2020 2020 2020 2020 2762                'b
+0000a870: 6f75 6e64 6172 7920 616c 6c6f 7720 6c69  oundary allow li
+0000a880: 6e65 6172 2077 6869 7465 7370 6163 6527  near whitespace'
+0000a890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a8a0: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
+0000a8b0: 205c 7420 5c72 5c6e 6865 6164 6572 2066   \t \r\nheader f
+0000a8c0: 6f6f 5c72 5c6e 5c72 5c6e 666f 6f20 6261  oo\r\n\r\nfoo ba
+0000a8d0: 725c 725c 6e2d 2d71 7765 7274 795c 725c  r\r\n--qwerty\r\
+0000a8e0: 6e27 2c0a 2020 2020 2020 2020 2020 2020  n',.            
+0000a8f0: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
+0000a900: 6f5c 725c 6e5c 725c 6e27 5d2c 0a20 2020  o\r\n\r\n'],.   
+0000a910: 2020 2020 2020 2020 2020 2020 205b 6227               [b'
+0000a920: 666f 6f20 6261 7227 5d2c 0a20 2020 2020  foo bar'],.     
+0000a930: 2020 2020 2020 2020 2020 2077 616e 745f             want_
+0000a940: 626f 6469 6573 5f64 6f6e 653d 5b54 7275  bodies_done=[Tru
+0000a950: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+0000a960: 2020 2020 6d61 785f 626f 756e 6461 7279      max_boundary
+0000a970: 3d32 302c 0a20 2020 2020 2020 2020 2020  =20,.           
+0000a980: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0000a990: 5465 7374 4d75 6c74 6970 6172 7450 6172  TestMultipartPar
+0000a9a0: 7365 722e 5f43 6173 6528 0a20 2020 2020  ser._Case(.     
+0000a9b0: 2020 2020 2020 2020 2020 2027 7465 726d             'term
+0000a9c0: 696e 616c 2062 6f75 6e64 6172 7920 616c  inal boundary al
+0000a9d0: 6c6f 7720 6c69 6e65 6172 2077 6869 7465  low linear white
+0000a9e0: 7370 6163 6527 2c0a 2020 2020 2020 2020  space',.        
+0000a9f0: 2020 2020 2020 2020 6227 5c72 5c6e 2d2d          b'\r\n--
+0000aa00: 7177 6572 7479 5c72 5c6e 6865 6164 6572  qwerty\r\nheader
+0000aa10: 2066 6f6f 5c72 5c6e 5c72 5c6e 666f 6f20   foo\r\n\r\nfoo 
+0000aa20: 6261 725c 725c 6e2d 2d71 7765 7274 792d  bar\r\n--qwerty-
+0000aa30: 2d20 5c74 205c 725c 6e27 2c0a 2020 2020  - \t \r\n',.    
+0000aa40: 2020 2020 2020 2020 2020 2020 5b62 2768              [b'h
+0000aa50: 6561 6465 7220 666f 6f5c 725c 6e5c 725c  eader foo\r\n\r\
+0000aa60: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
+0000aa70: 2020 2020 205b 6227 666f 6f20 6261 7227       [b'foo bar'
+0000aa80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000aa90: 2020 2077 616e 745f 626f 6469 6573 5f64     want_bodies_d
+0000aaa0: 6f6e 653d 5b54 7275 655d 2c0a 2020 2020  one=[True],.    
+0000aab0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+0000aac0: 626f 756e 6461 7279 3d32 302c 0a20 2020  boundary=20,.   
+0000aad0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0000aae0: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
+0000aaf0: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
+0000ab00: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000ab10: 2020 2027 6d75 6c74 6970 6c65 2070 6172     'multiple par
+0000ab20: 7473 272c 0a20 2020 2020 2020 2020 2020  ts',.           
+0000ab30: 2020 2020 2062 275c 725c 6e2d 2d71 7765       b'\r\n--qwe
+0000ab40: 7274 7920 5c74 205c 725c 6e68 6561 6465  rty \t \r\nheade
+0000ab50: 7220 666f 6f5c 725c 6e5c 725c 6e66 6f6f  r foo\r\n\r\nfoo
+0000ab60: 2062 6172 5c72 5c6e 2d2d 7177 6572 7479   bar\r\n--qwerty
+0000ab70: 5c72 5c6e 6865 6164 6572 2062 6172 5c72  \r\nheader bar\r
+0000ab80: 5c6e 5c72 5c6e 666f 6f20 6261 7a5c 725c  \n\r\nfoo baz\r\
+0000ab90: 6e2d 2d71 7765 7274 792d 2d5c 725c 6e27  n--qwerty--\r\n'
+0000aba0: 2c20 2023 206e 6f71 610a 2020 2020 2020  ,  # noqa.      
+0000abb0: 2020 2020 2020 2020 2020 5b62 2768 6561            [b'hea
+0000abc0: 6465 7220 666f 6f5c 725c 6e5c 725c 6e27  der foo\r\n\r\n'
+0000abd0: 2c20 6227 6865 6164 6572 2062 6172 5c72  , b'header bar\r
+0000abe0: 5c6e 5c72 5c6e 275d 2c0a 2020 2020 2020  \n\r\n'],.      
+0000abf0: 2020 2020 2020 2020 2020 5b62 2766 6f6f            [b'foo
+0000ac00: 2062 6172 272c 2062 2766 6f6f 2062 617a   bar', b'foo baz
+0000ac10: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0000ac20: 2020 2020 7761 6e74 5f62 6f64 6965 735f      want_bodies_
+0000ac30: 646f 6e65 3d5b 5472 7565 2c20 5472 7565  done=[True, True
+0000ac40: 5d2c 0a20 2020 2020 2020 2020 2020 2029  ],.            )
+0000ac50: 2c0a 2020 2020 2020 2020 2020 2020 5465  ,.            Te
+0000ac60: 7374 4d75 6c74 6970 6172 7450 6172 7365  stMultipartParse
+0000ac70: 722e 5f43 6173 6528 0a20 2020 2020 2020  r._Case(.       
+0000ac80: 2020 2020 2020 2020 2027 6967 6e6f 7265           'ignore
+0000ac90: 2061 6674 6572 2074 6572 6d69 6e61 6c20   after terminal 
+0000aca0: 626f 756e 6461 7279 272c 0a20 2020 2020  boundary',.     
+0000acb0: 2020 2020 2020 2020 2020 2062 275c 725c             b'\r\
+0000acc0: 6e2d 2d71 7765 7274 7920 5c74 205c 725c  n--qwerty \t \r\
+0000acd0: 6e68 6561 6465 7220 666f 6f5c 725c 6e5c  nheader foo\r\n\
+0000ace0: 725c 6e66 6f6f 2062 6172 5c72 5c6e 2d2d  r\nfoo bar\r\n--
+0000acf0: 7177 6572 7479 2d2d 5c72 5c6e 6865 6164  qwerty--\r\nhead
+0000ad00: 6572 2062 6172 5c72 5c6e 5c72 5c6e 666f  er bar\r\n\r\nfo
+0000ad10: 6f20 6261 7a5c 725c 6e2d 2d71 7765 7274  o baz\r\n--qwert
+0000ad20: 792d 2d5c 725c 6e27 2c20 2023 206e 6f71  y--\r\n',  # noq
+0000ad30: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0000ad40: 2020 5b62 2768 6561 6465 7220 666f 6f5c    [b'header foo\
+0000ad50: 725c 6e5c 725c 6e27 5d2c 0a20 2020 2020  r\n\r\n'],.     
+0000ad60: 2020 2020 2020 2020 2020 205b 6227 666f             [b'fo
+0000ad70: 6f20 6261 7227 5d2c 0a20 2020 2020 2020  o bar'],.       
+0000ad80: 2020 2020 2020 2020 2077 616e 745f 626f           want_bo
+0000ad90: 6469 6573 5f64 6f6e 653d 5b54 7275 655d  dies_done=[True]
+0000ada0: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
+0000adb0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
+0000adc0: 2020 2020 6368 756e 6b5f 7369 7a65 7320      chunk_sizes 
+0000add0: 3d20 5b31 2c20 322c 2033 2c20 342c 2035  = [1, 2, 3, 4, 5
+0000ade0: 2c20 372c 2031 332c 2031 372c 2031 392c  , 7, 13, 17, 19,
+0000adf0: 2032 332c 2032 392c 2033 312c 2033 372c   23, 29, 31, 37,
+0000ae00: 2034 322c 2035 302c 2031 3030 2c20 3130   42, 50, 100, 10
+0000ae10: 3030 5d0a 2020 2020 2020 2020 6d61 726b  00].        mark
+0000ae20: 6572 203d 2062 2771 7765 7274 7927 0a20  er = b'qwerty'. 
+0000ae30: 2020 2020 2020 2066 6f72 2069 2c20 7465         for i, te
+0000ae40: 7374 2069 6e20 656e 756d 6572 6174 6528  st in enumerate(
+0000ae50: 7465 7374 7329 3a0a 2020 2020 2020 2020  tests):.        
+0000ae60: 2020 2020 666f 7220 6368 756e 6b5f 7369      for chunk_si
+0000ae70: 7a65 2069 6e20 6368 756e 6b5f 7369 7a65  ze in chunk_size
+0000ae80: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000ae90: 2020 2068 6561 6465 7273 203d 205b 5d0a     headers = [].
+0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aeb0: 626f 6469 6573 203d 205b 5d0a 2020 2020  bodies = [].    
+0000aec0: 2020 2020 2020 2020 2020 2020 626f 6469              bodi
+0000aed0: 6573 5f64 6f6e 6520 3d20 5b5d 0a0a 2020  es_done = []..  
+0000aee0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000aef0: 6620 6861 6e64 6c65 5f68 6561 6465 7228  f handle_header(
+0000af00: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
+0000af10: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0000af20: 7273 2e61 7070 656e 6428 6279 7465 7328  rs.append(bytes(
+0000af30: 6461 7461 2929 0a20 2020 2020 2020 2020  data)).         
+0000af40: 2020 2020 2020 2020 2020 2062 6f64 6965             bodie
+0000af50: 732e 6170 7065 6e64 2862 2727 290a 2020  s.append(b'').  
+0000af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af70: 2020 626f 6469 6573 5f64 6f6e 652e 6170    bodies_done.ap
+0000af80: 7065 6e64 2846 616c 7365 290a 0a20 2020  pend(False)..   
+0000af90: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000afa0: 2068 616e 646c 655f 626f 6479 2864 6174   handle_body(dat
+0000afb0: 612c 2064 6f6e 653d 4661 6c73 6529 3a0a  a, done=False):.
+0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afd0: 2020 2020 626f 6469 6573 5b2d 315d 202b      bodies[-1] +
+0000afe0: 3d20 6461 7461 0a20 2020 2020 2020 2020  = data.         
+0000aff0: 2020 2020 2020 2020 2020 2062 6f64 6965             bodie
+0000b000: 735f 646f 6e65 5b2d 315d 203d 2064 6f6e  s_done[-1] = don
+0000b010: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000b020: 2020 2070 6172 7365 7220 3d20 7065 6262     parser = pebb
+0000b030: 6c65 2e5f 4d75 6c74 6970 6172 7450 6172  le._MultipartPar
+0000b040: 7365 7228 0a20 2020 2020 2020 2020 2020  ser(.           
+0000b050: 2020 2020 2020 2020 206d 6172 6b65 722c           marker,
+0000b060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b070: 2020 2020 2068 616e 646c 655f 6865 6164       handle_head
+0000b080: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0000b090: 2020 2020 2020 2020 6861 6e64 6c65 5f62          handle_b
+0000b0a0: 6f64 792c 0a20 2020 2020 2020 2020 2020  ody,.           
+0000b0b0: 2020 2020 2020 2020 206d 6178 5f62 6f75           max_bou
+0000b0c0: 6e64 6172 795f 6c65 6e67 7468 3d74 6573  ndary_length=tes
+0000b0d0: 742e 6d61 785f 626f 756e 6461 7279 2c0a  t.max_boundary,.
 0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0f0: 2020 2020 2020 2070 6172 7365 722e 6665         parser.fe
-0000b100: 6564 2864 6174 6129 0a20 2020 2020 2020  ed(data).       
-0000b110: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000b120: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-0000b130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b140: 2020 2020 2020 6966 206e 6f74 2074 6573        if not tes
-0000b150: 742e 6572 726f 723a 0a20 2020 2020 2020  t.error:.       
-0000b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b170: 2073 656c 662e 6661 696c 2827 756e 6578   self.fail('unex
-0000b180: 7065 6374 6564 2065 7272 6f72 3a27 2c20  pected error:', 
-0000b190: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
-0000b1a0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0000b1b0: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
-0000b1c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000b1d0: 7274 4571 7561 6c28 7465 7374 2e65 7272  rtEqual(test.err
-0000b1e0: 6f72 2c20 7374 7228 6572 7229 290a 2020  or, str(err)).  
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000b200: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000b210: 2020 2020 2020 2020 6966 2074 6573 742e          if test.
-0000b220: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
-0000b230: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b240: 656c 662e 6661 696c 2866 276d 6973 7369  elf.fail(f'missi
-0000b250: 6e67 2065 7870 6563 7465 6420 6572 726f  ng expected erro
-0000b260: 723a 207b 7465 7374 2e65 7272 6f72 2172  r: {test.error!r
-0000b270: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
-0000b280: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
-0000b290: 2774 6573 7420 6361 7365 207b 6920 2b20  'test case {i + 
-0000b2a0: 317d 2028 7b74 6573 742e 6e61 6d65 7d29  1} ({test.name})
-0000b2b0: 2c20 6368 756e 6b20 7369 7a65 207b 6368  , chunk size {ch
-0000b2c0: 756e 6b5f 7369 7a65 7d27 0a20 2020 2020  unk_size}'.     
-0000b2d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b2e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000b2f0: 7465 7374 2e77 616e 745f 6865 6164 6572  test.want_header
-0000b300: 732c 2068 6561 6465 7273 2c20 6d73 6729  s, headers, msg)
-0000b310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b320: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b330: 4571 7561 6c28 7465 7374 2e77 616e 745f  Equal(test.want_
-0000b340: 626f 6469 6573 2c20 626f 6469 6573 2c20  bodies, bodies, 
-0000b350: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-0000b360: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-0000b370: 7365 7274 4571 7561 6c28 7465 7374 2e77  sertEqual(test.w
-0000b380: 616e 745f 626f 6469 6573 5f64 6f6e 652c  ant_bodies_done,
-0000b390: 2062 6f64 6965 735f 646f 6e65 2c20 6d73   bodies_done, ms
-0000b3a0: 6729 0a0a 0a63 6c61 7373 2054 6573 7443  g)...class TestC
-0000b3b0: 6c69 656e 7428 756e 6974 7465 7374 2e54  lient(unittest.T
-0000b3c0: 6573 7443 6173 6529 3a0a 2020 2020 6d61  estCase):.    ma
-0000b3d0: 7844 6966 6620 3d20 4e6f 6e65 0a0a 2020  xDiff = None..  
-0000b3e0: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-0000b3f0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000b400: 636c 6965 6e74 203d 204d 6f63 6b43 6c69  client = MockCli
-0000b410: 656e 7428 290a 2020 2020 2020 2020 7365  ent().        se
-0000b420: 6c66 2e74 696d 6520 3d20 4d6f 636b 5469  lf.time = MockTi
-0000b430: 6d65 2829 0a20 2020 2020 2020 2074 696d  me().        tim
-0000b440: 655f 7061 7463 6865 7220 3d20 756e 6974  e_patcher = unit
-0000b450: 7465 7374 2e6d 6f63 6b2e 7061 7463 6828  test.mock.patch(
-0000b460: 276f 7073 2e70 6562 626c 652e 7469 6d65  'ops.pebble.time
-0000b470: 272c 2073 656c 662e 7469 6d65 290a 2020  ', self.time).  
-0000b480: 2020 2020 2020 7469 6d65 5f70 6174 6368        time_patch
-0000b490: 6572 2e73 7461 7274 2829 0a20 2020 2020  er.start().     
-0000b4a0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000b4b0: 7570 2874 696d 655f 7061 7463 6865 722e  up(time_patcher.
-0000b4c0: 7374 6f70 290a 0a20 2020 2064 6566 2074  stop)..    def t
-0000b4d0: 6573 745f 636c 6965 6e74 5f69 6e69 7428  est_client_init(
-0000b4e0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-0000b4f0: 6562 626c 652e 436c 6965 6e74 2873 6f63  ebble.Client(soc
-0000b500: 6b65 745f 7061 7468 3d27 666f 6f27 2920  ket_path='foo') 
-0000b510: 2023 2074 6573 7420 7468 6174 2063 6f6e   # test that con
-0000b520: 7374 7275 6374 6f72 2072 756e 730a 2020  structor runs.  
-0000b530: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000b540: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-0000b550: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000b560: 2020 2020 2070 6562 626c 652e 436c 6965       pebble.Clie
-0000b570: 6e74 2829 2020 2320 736f 636b 6574 5f70  nt()  # socket_p
-0000b580: 6174 6820 6172 6720 7265 7175 6972 6564  ath arg required
-0000b590: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0000b5a0: 6574 5f73 7973 7465 6d5f 696e 666f 2873  et_system_info(s
-0000b5b0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000b5c0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000b5d0: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
-0000b5e0: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
-0000b5f0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-0000b600: 2020 2020 2022 7665 7273 696f 6e22 3a20       "version": 
-0000b610: 2231 2e32 2e33 222c 0a20 2020 2020 2020  "1.2.3",.       
-0000b620: 2020 2020 2020 2020 2022 6578 7472 612d           "extra-
-0000b630: 6669 656c 6422 3a20 2266 6f6f 222c 0a20  field": "foo",. 
-0000b640: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-0000b650: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000b660: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-0000b670: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000b680: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-0000b690: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-0000b6a0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-0000b6b0: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
-0000b6c0: 656c 662e 636c 6965 6e74 2e67 6574 5f73  elf.client.get_s
-0000b6d0: 7973 7465 6d5f 696e 666f 2829 0a20 2020  ystem_info().   
-0000b6e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b6f0: 4571 7561 6c28 696e 666f 2e76 6572 7369  Equal(info.versi
-0000b700: 6f6e 2c20 2731 2e32 2e33 2729 0a20 2020  on, '1.2.3').   
-0000b710: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b720: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
-0000b730: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
-0000b740: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-0000b750: 2c20 272f 7631 2f73 7973 7465 6d2d 696e  , '/v1/system-in
-0000b760: 666f 272c 204e 6f6e 652c 204e 6f6e 6529  fo', None, None)
-0000b770: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-0000b780: 2020 6465 6620 7465 7374 5f67 6574 5f77    def test_get_w
-0000b790: 6172 6e69 6e67 7328 7365 6c66 293a 0a20  arnings(self):. 
-0000b7a0: 2020 2020 2020 2065 6d70 7479 203d 207b         empty = {
-0000b7b0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-0000b7c0: 7375 6c74 223a 205b 5d2c 0a20 2020 2020  sult": [],.     
-0000b7d0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
-0000b7e0: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
-0000b7f0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-0000b800: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-0000b810: 2020 2022 7479 7065 223a 2022 7379 6e63     "type": "sync
-0000b820: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
-0000b830: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000b840: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000b850: 2865 6d70 7479 290a 2020 2020 2020 2020  (empty).        
-0000b860: 7761 726e 696e 6773 203d 2073 656c 662e  warnings = self.
-0000b870: 636c 6965 6e74 2e67 6574 5f77 6172 6e69  client.get_warni
-0000b880: 6e67 7328 290a 2020 2020 2020 2020 7365  ngs().        se
-0000b890: 6c66 2e61 7373 6572 7445 7175 616c 2877  lf.assertEqual(w
-0000b8a0: 6172 6e69 6e67 732c 205b 5d29 0a0a 2020  arnings, [])..  
-0000b8b0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000b8c0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-0000b8d0: 6e64 2865 6d70 7479 290a 2020 2020 2020  nd(empty).      
-0000b8e0: 2020 7761 726e 696e 6773 203d 2073 656c    warnings = sel
-0000b8f0: 662e 636c 6965 6e74 2e67 6574 5f77 6172  f.client.get_war
-0000b900: 6e69 6e67 7328 7365 6c65 6374 3d70 6562  nings(select=peb
-0000b910: 626c 652e 5761 726e 696e 6753 7461 7465  ble.WarningState
-0000b920: 2e41 4c4c 290a 2020 2020 2020 2020 7365  .ALL).        se
-0000b930: 6c66 2e61 7373 6572 7445 7175 616c 2877  lf.assertEqual(w
-0000b940: 6172 6e69 6e67 732c 205b 5d29 0a0a 2020  arnings, [])..  
-0000b950: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000b960: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-0000b970: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-0000b980: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000b990: 272c 2027 2f76 312f 7761 726e 696e 6773  ', '/v1/warnings
-0000b9a0: 272c 207b 2773 656c 6563 7427 3a20 2770  ', {'select': 'p
-0000b9b0: 656e 6469 6e67 277d 2c20 4e6f 6e65 292c  ending'}, None),
-0000b9c0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-0000b9d0: 4554 272c 2027 2f76 312f 7761 726e 696e  ET', '/v1/warnin
-0000b9e0: 6773 272c 207b 2773 656c 6563 7427 3a20  gs', {'select': 
-0000b9f0: 2761 6c6c 277d 2c20 4e6f 6e65 292c 0a20  'all'}, None),. 
-0000ba00: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-0000ba10: 6566 2074 6573 745f 6163 6b5f 7761 726e  ef test_ack_warn
-0000ba20: 696e 6773 2873 656c 6629 3a0a 2020 2020  ings(self):.    
-0000ba30: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000ba40: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000ba50: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-0000ba60: 7265 7375 6c74 223a 2030 2c0a 2020 2020  result": 0,.    
-0000ba70: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000ba80: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000ba90: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000baa0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000bab0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000bac0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000bad0: 2020 2020 2020 6e75 6d20 3d20 7365 6c66        num = self
-0000bae0: 2e63 6c69 656e 742e 6163 6b5f 7761 726e  .client.ack_warn
-0000baf0: 696e 6773 2864 6174 6574 696d 655f 6e7a  ings(datetime_nz
-0000bb00: 6474 2832 3032 312c 2031 2c20 3238 2c20  dt(2021, 1, 28, 
-0000bb10: 3135 2c20 3131 2c20 3029 290a 2020 2020  15, 11, 0)).    
-0000bb20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000bb30: 7175 616c 286e 756d 2c20 3029 0a20 2020  qual(num, 0).   
-0000bb40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bb50: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
-0000bb60: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
-0000bb70: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
-0000bb80: 272c 2027 2f76 312f 7761 726e 696e 6773  ', '/v1/warnings
-0000bb90: 272c 204e 6f6e 652c 207b 0a20 2020 2020  ', None, {.     
-0000bba0: 2020 2020 2020 2020 2020 2027 6163 7469             'acti
-0000bbb0: 6f6e 273a 2027 6f6b 6179 272c 0a20 2020  on': 'okay',.   
-0000bbc0: 2020 2020 2020 2020 2020 2020 2027 7469               'ti
-0000bbd0: 6d65 7374 616d 7027 3a20 2732 3032 312d  mestamp': '2021-
-0000bbe0: 3031 2d32 3854 3135 3a31 313a 3030 2b31  01-28T15:11:00+1
-0000bbf0: 333a 3030 272c 0a20 2020 2020 2020 2020  3:00',.         
-0000bc00: 2020 207d 292c 0a20 2020 2020 2020 205d     }),.        ]
-0000bc10: 290a 0a20 2020 2064 6566 2061 7373 6572  )..    def asser
-0000bc20: 745f 6d6f 636b 5f63 6861 6e67 6528 7365  t_mock_change(se
-0000bc30: 6c66 2c20 6368 616e 6765 293a 0a20 2020  lf, change):.   
-0000bc40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bc50: 4571 7561 6c28 6368 616e 6765 2e69 642c  Equal(change.id,
-0000bc60: 2027 3730 2729 0a20 2020 2020 2020 2073   '70').        s
-0000bc70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000bc80: 6368 616e 6765 2e6b 696e 642c 2027 6175  change.kind, 'au
-0000bc90: 746f 7374 6172 7427 290a 2020 2020 2020  tostart').      
-0000bca0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000bcb0: 616c 2863 6861 6e67 652e 7375 6d6d 6172  al(change.summar
-0000bcc0: 792c 2027 4175 746f 7374 6172 7420 7365  y, 'Autostart se
-0000bcd0: 7276 6963 6520 2273 7663 2227 290a 2020  rvice "svc"').  
-0000bce0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bcf0: 7445 7175 616c 2863 6861 6e67 652e 7374  tEqual(change.st
-0000bd00: 6174 7573 2c20 2744 6f6e 6527 290a 2020  atus, 'Done').  
-0000bd10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bd20: 7445 7175 616c 286c 656e 2863 6861 6e67  tEqual(len(chang
-0000bd30: 652e 7461 736b 7329 2c20 3129 0a20 2020  e.tasks), 1).   
-0000bd40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bd50: 4571 7561 6c28 6368 616e 6765 2e74 6173  Equal(change.tas
-0000bd60: 6b73 5b30 5d2e 6964 2c20 2737 3827 290a  ks[0].id, '78').
-0000bd70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000bd80: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
-0000bd90: 7461 736b 735b 305d 2e6b 696e 642c 2027  tasks[0].kind, '
-0000bda0: 7374 6172 7427 290a 2020 2020 2020 2020  start').        
-0000bdb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000bdc0: 2863 6861 6e67 652e 7461 736b 735b 305d  (change.tasks[0]
-0000bdd0: 2e73 756d 6d61 7279 2c20 2753 7461 7274  .summary, 'Start
-0000bde0: 2073 6572 7669 6365 2022 7376 6322 2729   service "svc"')
-0000bdf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000be00: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
-0000be10: 2e74 6173 6b73 5b30 5d2e 7374 6174 7573  .tasks[0].status
-0000be20: 2c20 2744 6f6e 6527 290a 2020 2020 2020  , 'Done').      
-0000be30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000be40: 616c 2863 6861 6e67 652e 7461 736b 735b  al(change.tasks[
-0000be50: 305d 2e6c 6f67 2c20 5b5d 290a 2020 2020  0].log, []).    
-0000be60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000be70: 7175 616c 2863 6861 6e67 652e 7461 736b  qual(change.task
-0000be80: 735b 305d 2e70 726f 6772 6573 732e 646f  s[0].progress.do
-0000be90: 6e65 2c20 3129 0a20 2020 2020 2020 2073  ne, 1).        s
-0000bea0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000beb0: 6368 616e 6765 2e74 6173 6b73 5b30 5d2e  change.tasks[0].
-0000bec0: 7072 6f67 7265 7373 2e6c 6162 656c 2c20  progress.label, 
-0000bed0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-0000bee0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
-0000bef0: 6e67 652e 7461 736b 735b 305d 2e70 726f  nge.tasks[0].pro
-0000bf00: 6772 6573 732e 746f 7461 6c2c 2031 290a  gress.total, 1).
-0000bf10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000bf20: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
-0000bf30: 7461 736b 735b 305d 2e72 6561 6479 5f74  tasks[0].ready_t
-0000bf40: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
-0000bf50: 2020 2020 2020 2020 2020 2020 2020 6461                da
-0000bf60: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-0000bf70: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-0000bf80: 2033 2c20 3237 3032 3139 2929 0a20 2020   3, 270219)).   
-0000bf90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bfa0: 4571 7561 6c28 6368 616e 6765 2e74 6173  Equal(change.tas
-0000bfb0: 6b73 5b30 5d2e 7370 6177 6e5f 7469 6d65  ks[0].spawn_time
-0000bfc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000bfd0: 2020 2020 2020 2020 2020 2064 6174 6574             datet
-0000bfe0: 696d 655f 6e7a 6474 2832 3032 312c 2031  ime_nzdt(2021, 1
-0000bff0: 2c20 3238 2c20 3134 2c20 3337 2c20 322c  , 28, 14, 37, 2,
-0000c000: 2032 3437 3135 3829 290a 2020 2020 2020   247158)).      
-0000c010: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000c020: 616c 2863 6861 6e67 652e 7265 6164 792c  al(change.ready,
-0000c030: 2054 7275 6529 0a20 2020 2020 2020 2073   True).        s
-0000c040: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000c050: 6368 616e 6765 2e65 7272 2c20 4e6f 6e65  change.err, None
-0000c060: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c070: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-0000c080: 652e 7265 6164 795f 7469 6d65 2c20 6461  e.ready_time, da
-0000c090: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-0000c0a0: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-0000c0b0: 2034 2c20 3239 3135 3138 2929 0a20 2020   4, 291518)).   
-0000c0c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000c0d0: 4571 7561 6c28 6368 616e 6765 2e73 7061  Equal(change.spa
-0000c0e0: 776e 5f74 696d 652c 2064 6174 6574 696d  wn_time, datetim
-0000c0f0: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
-0000c100: 3238 2c20 3134 2c20 3337 2c20 322c 2032  28, 14, 37, 2, 2
-0000c110: 3437 3230 3229 290a 0a20 2020 2064 6566  47202))..    def
-0000c120: 2074 6573 745f 6765 745f 6368 616e 6765   test_get_change
-0000c130: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0000c140: 2065 6d70 7479 203d 207b 0a20 2020 2020   empty = {.     
-0000c150: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
-0000c160: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-0000c170: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
-0000c180: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0000c190: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
-0000c1a0: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
-0000c1b0: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
-0000c1c0: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-0000c1d0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000c1e0: 7365 732e 6170 7065 6e64 2865 6d70 7479  ses.append(empty
-0000c1f0: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
-0000c200: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
-0000c210: 6765 745f 6368 616e 6765 7328 290a 2020  get_changes().  
-0000c220: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000c230: 7445 7175 616c 2863 6861 6e67 6573 2c20  tEqual(changes, 
-0000c240: 5b5d 290a 0a20 2020 2020 2020 2073 656c  [])..        sel
-0000c250: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-0000c260: 6573 2e61 7070 656e 6428 656d 7074 7929  es.append(empty)
-0000c270: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
-0000c280: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-0000c290: 6574 5f63 6861 6e67 6573 2873 656c 6563  et_changes(selec
-0000c2a0: 743d 7065 6262 6c65 2e43 6861 6e67 6553  t=pebble.ChangeS
-0000c2b0: 7461 7465 2e41 4c4c 290a 2020 2020 2020  tate.ALL).      
-0000c2c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000c2d0: 616c 2863 6861 6e67 6573 2c20 5b5d 290a  al(changes, []).
-0000c2e0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0000c2f0: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-0000c300: 7070 656e 6428 656d 7074 7929 0a20 2020  ppend(empty).   
-0000c310: 2020 2020 2063 6861 6e67 6573 203d 2073       changes = s
-0000c320: 656c 662e 636c 6965 6e74 2e67 6574 5f63  elf.client.get_c
-0000c330: 6861 6e67 6573 2873 656c 6563 743d 7065  hanges(select=pe
-0000c340: 6262 6c65 2e43 6861 6e67 6553 7461 7465  bble.ChangeState
-0000c350: 2e41 4c4c 2c20 7365 7276 6963 653d 2766  .ALL, service='f
-0000c360: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
-0000c370: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000c380: 616e 6765 732c 205b 5d29 0a0a 2020 2020  anges, [])..    
-0000c390: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000c3a0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000c3b0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-0000c3c0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
-0000c3d0: 2020 2020 2020 2020 2020 2062 7569 6c64             build
-0000c3e0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
-0000c3f0: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
-0000c400: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0000c410: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
-0000c420: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0000c430: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
-0000c440: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-0000c450: 6522 3a20 2273 796e 6322 0a20 2020 2020  e": "sync".     
-0000c460: 2020 207d 290a 2020 2020 2020 2020 6368     }).        ch
-0000c470: 616e 6765 7320 3d20 7365 6c66 2e63 6c69  anges = self.cli
-0000c480: 656e 742e 6765 745f 6368 616e 6765 7328  ent.get_changes(
-0000c490: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c4a0: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
-0000c4b0: 6861 6e67 6573 292c 2031 290a 2020 2020  hanges), 1).    
-0000c4c0: 2020 2020 7365 6c66 2e61 7373 6572 745f      self.assert_
-0000c4d0: 6d6f 636b 5f63 6861 6e67 6528 6368 616e  mock_change(chan
-0000c4e0: 6765 735b 305d 290a 0a20 2020 2020 2020  ges[0])..       
-0000c4f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000c500: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-0000c510: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000c520: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-0000c530: 7631 2f63 6861 6e67 6573 272c 207b 2773  v1/changes', {'s
-0000c540: 656c 6563 7427 3a20 2769 6e2d 7072 6f67  elect': 'in-prog
-0000c550: 7265 7373 277d 2c20 4e6f 6e65 292c 0a20  ress'}, None),. 
-0000c560: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000c570: 272c 2027 2f76 312f 6368 616e 6765 7327  ', '/v1/changes'
-0000c580: 2c20 7b27 7365 6c65 6374 273a 2027 616c  , {'select': 'al
-0000c590: 6c27 7d2c 204e 6f6e 6529 2c0a 2020 2020  l'}, None),.    
-0000c5a0: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-0000c5b0: 272f 7631 2f63 6861 6e67 6573 272c 207b  '/v1/changes', {
-0000c5c0: 2773 656c 6563 7427 3a20 2761 6c6c 272c  'select': 'all',
-0000c5d0: 2027 666f 7227 3a20 2766 6f6f 277d 2c20   'for': 'foo'}, 
-0000c5e0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
-0000c5f0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-0000c600: 6368 616e 6765 7327 2c20 7b27 7365 6c65  changes', {'sele
-0000c610: 6374 273a 2027 696e 2d70 726f 6772 6573  ct': 'in-progres
-0000c620: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
-0000c630: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0000c640: 7465 7374 5f67 6574 5f63 6861 6e67 6528  test_get_change(
-0000c650: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000c660: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000c670: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-0000c680: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-0000c690: 7422 3a20 6275 696c 645f 6d6f 636b 5f63  t": build_mock_c
-0000c6a0: 6861 6e67 655f 6469 6374 2829 2c0a 2020  hange_dict(),.  
-0000c6b0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000c6c0: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-0000c6d0: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000c6e0: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-0000c6f0: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-0000c700: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-0000c710: 2020 2020 2020 2020 6368 616e 6765 203d          change =
-0000c720: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
-0000c730: 5f63 6861 6e67 6528 2737 3027 290a 2020  _change('70').  
-0000c740: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000c750: 745f 6d6f 636b 5f63 6861 6e67 6528 6368  t_mock_change(ch
-0000c760: 616e 6765 290a 2020 2020 2020 2020 7365  ange).        se
-0000c770: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000c780: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0000c790: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000c7a0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-0000c7b0: 6368 616e 6765 732f 3730 272c 204e 6f6e  changes/70', Non
-0000c7c0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
-0000c7d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000c7e0: 7374 5f61 626f 7274 5f63 6861 6e67 6528  st_abort_change(
-0000c7f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000c800: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000c810: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-0000c820: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-0000c830: 7422 3a20 6275 696c 645f 6d6f 636b 5f63  t": build_mock_c
-0000c840: 6861 6e67 655f 6469 6374 2829 2c0a 2020  hange_dict(),.  
-0000c850: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000c860: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-0000c870: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000c880: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-0000c890: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-0000c8a0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-0000c8b0: 2020 2020 2020 2020 6368 616e 6765 203d          change =
-0000c8c0: 2073 656c 662e 636c 6965 6e74 2e61 626f   self.client.abo
-0000c8d0: 7274 5f63 6861 6e67 6528 2737 3027 290a  rt_change('70').
-0000c8e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c8f0: 6572 745f 6d6f 636b 5f63 6861 6e67 6528  ert_mock_change(
-0000c900: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
-0000c910: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c920: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-0000c930: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-0000c940: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
-0000c950: 7631 2f63 6861 6e67 6573 2f37 3027 2c20  v1/changes/70', 
-0000c960: 4e6f 6e65 2c20 7b27 6163 7469 6f6e 273a  None, {'action':
-0000c970: 2027 6162 6f72 7427 7d29 2c0a 2020 2020   'abort'}),.    
-0000c980: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0000c990: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
-0000c9a0: 5f68 656c 7065 7228 7365 6c66 2c20 6163  _helper(self, ac
-0000c9b0: 7469 6f6e 2c20 6170 695f 6675 6e63 2c20  tion, api_func, 
-0000c9c0: 7365 7276 6963 6573 293a 0a20 2020 2020  services):.     
-0000c9d0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-0000c9e0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-0000c9f0: 7b0a 2020 2020 2020 2020 2020 2020 2263  {.            "c
-0000ca00: 6861 6e67 6522 3a20 2237 3022 2c0a 2020  hange": "70",.  
-0000ca10: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-0000ca20: 7422 3a20 4e6f 6e65 2c0a 2020 2020 2020  t": None,.      
-0000ca30: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-0000ca40: 2241 6363 6570 7465 6422 2c0a 2020 2020  "Accepted",.    
-0000ca50: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
-0000ca60: 636f 6465 223a 2032 3032 2c0a 2020 2020  code": 202,.    
-0000ca70: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-0000ca80: 2261 7379 6e63 220a 2020 2020 2020 2020  "async".        
-0000ca90: 7d29 0a20 2020 2020 2020 2063 6861 6e67  }).        chang
-0000caa0: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
-0000cab0: 6861 6e67 655f 6469 6374 2829 0a20 2020  hange_dict().   
-0000cac0: 2020 2020 2063 6861 6e67 655b 2772 6561       change['rea
-0000cad0: 6479 275d 203d 2054 7275 650a 2020 2020  dy'] = True.    
-0000cae0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000caf0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000cb00: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-0000cb10: 7265 7375 6c74 223a 2063 6861 6e67 652c  result": change,
-0000cb20: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0000cb30: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-0000cb40: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-0000cb50: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
-0000cb60: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
-0000cb70: 2022 7379 6e63 220a 2020 2020 2020 2020   "sync".        
-0000cb80: 7d29 0a20 2020 2020 2020 2063 6861 6e67  }).        chang
-0000cb90: 655f 6964 203d 2061 7069 5f66 756e 6328  e_id = api_func(
-0000cba0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000cbb0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-0000cbc0: 655f 6964 2c20 2737 3027 290a 2020 2020  e_id, '70').    
-0000cbd0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000cbe0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-0000cbf0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0000cc00: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-0000cc10: 2c20 272f 7631 2f73 6572 7669 6365 7327  , '/v1/services'
-0000cc20: 2c20 4e6f 6e65 2c20 7b27 6163 7469 6f6e  , None, {'action
-0000cc30: 273a 2061 6374 696f 6e2c 2027 7365 7276  ': action, 'serv
-0000cc40: 6963 6573 273a 2073 6572 7669 6365 737d  ices': services}
-0000cc50: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-0000cc60: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-0000cc70: 6765 732f 3730 2f77 6169 7427 2c20 7b27  ges/70/wait', {'
-0000cc80: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
-0000cc90: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
-0000cca0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0000ccb0: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
-0000ccc0: 5f61 7379 6e63 5f68 656c 7065 7228 7365  _async_helper(se
-0000ccd0: 6c66 2c20 6163 7469 6f6e 2c20 6170 695f  lf, action, api_
-0000cce0: 6675 6e63 2c20 7365 7276 6963 6573 293a  func, services):
-0000ccf0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0000cd00: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-0000cd10: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
-0000cd20: 2020 2020 2263 6861 6e67 6522 3a20 2237      "change": "7
-0000cd30: 3022 2c0a 2020 2020 2020 2020 2020 2020  0",.            
-0000cd40: 2272 6573 756c 7422 3a20 4e6f 6e65 2c0a  "result": None,.
-0000cd50: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0000cd60: 7475 7322 3a20 2241 6363 6570 7465 6422  tus": "Accepted"
-0000cd70: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0000cd80: 7461 7475 732d 636f 6465 223a 2032 3032  tatus-code": 202
-0000cd90: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-0000cda0: 7970 6522 3a20 2261 7379 6e63 220a 2020  ype": "async".  
-0000cdb0: 2020 2020 2020 7d29 0a20 2020 2020 2020        }).       
-0000cdc0: 2063 6861 6e67 655f 6964 203d 2061 7069   change_id = api
-0000cdd0: 5f66 756e 6328 7469 6d65 6f75 743d 3029  _func(timeout=0)
-0000cde0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000cdf0: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
-0000ce00: 5f69 642c 2027 3730 2729 0a20 2020 2020  _id, '70').     
-0000ce10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ce20: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0000ce30: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000ce40: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
-0000ce50: 2027 2f76 312f 7365 7276 6963 6573 272c   '/v1/services',
-0000ce60: 204e 6f6e 652c 207b 2761 6374 696f 6e27   None, {'action'
-0000ce70: 3a20 6163 7469 6f6e 2c20 2773 6572 7669  : action, 'servi
-0000ce80: 6365 7327 3a20 7365 7276 6963 6573 7d29  ces': services})
-0000ce90: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-0000cea0: 2020 6465 6620 7465 7374 5f61 7574 6f73    def test_autos
-0000ceb0: 7461 7274 5f73 6572 7669 6365 7328 7365  tart_services(se
-0000cec0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000ced0: 662e 5f73 6572 7669 6365 735f 6163 7469  f._services_acti
-0000cee0: 6f6e 5f68 656c 7065 7228 2761 7574 6f73  on_helper('autos
-0000cef0: 7461 7274 272c 2073 656c 662e 636c 6965  tart', self.clie
-0000cf00: 6e74 2e61 7574 6f73 7461 7274 5f73 6572  nt.autostart_ser
-0000cf10: 7669 6365 732c 205b 5d29 0a0a 2020 2020  vices, [])..    
-0000cf20: 6465 6620 7465 7374 5f61 7574 6f73 7461  def test_autosta
-0000cf30: 7274 5f73 6572 7669 6365 735f 6173 796e  rt_services_asyn
-0000cf40: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
-0000cf50: 2073 656c 662e 5f73 6572 7669 6365 735f   self._services_
-0000cf60: 6163 7469 6f6e 5f61 7379 6e63 5f68 656c  action_async_hel
-0000cf70: 7065 7228 2761 7574 6f73 7461 7274 272c  per('autostart',
-0000cf80: 2073 656c 662e 636c 6965 6e74 2e61 7574   self.client.aut
-0000cf90: 6f73 7461 7274 5f73 6572 7669 6365 732c  ostart_services,
-0000cfa0: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
-0000cfb0: 7374 5f72 6570 6c61 6e5f 7365 7276 6963  st_replan_servic
-0000cfc0: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-0000cfd0: 2020 7365 6c66 2e5f 7365 7276 6963 6573    self._services
-0000cfe0: 5f61 6374 696f 6e5f 6865 6c70 6572 2827  _action_helper('
-0000cff0: 7265 706c 616e 272c 2073 656c 662e 636c  replan', self.cl
-0000d000: 6965 6e74 2e72 6570 6c61 6e5f 7365 7276  ient.replan_serv
-0000d010: 6963 6573 2c20 5b5d 290a 0a20 2020 2064  ices, [])..    d
-0000d020: 6566 2074 6573 745f 7265 706c 616e 5f73  ef test_replan_s
-0000d030: 6572 7669 6365 735f 6173 796e 6328 7365  ervices_async(se
-0000d040: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000d050: 662e 5f73 6572 7669 6365 735f 6163 7469  f._services_acti
-0000d060: 6f6e 5f61 7379 6e63 5f68 656c 7065 7228  on_async_helper(
-0000d070: 2772 6570 6c61 6e27 2c20 7365 6c66 2e63  'replan', self.c
-0000d080: 6c69 656e 742e 7265 706c 616e 5f73 6572  lient.replan_ser
-0000d090: 7669 6365 732c 205b 5d29 0a0a 2020 2020  vices, [])..    
-0000d0a0: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
-0000d0b0: 6572 7669 6365 7328 7365 6c66 293a 0a20  ervices(self):. 
-0000d0c0: 2020 2020 2020 2064 6566 2061 7069 5f66         def api_f
-0000d0d0: 756e 6328 293a 0a20 2020 2020 2020 2020  unc():.         
-0000d0e0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-0000d0f0: 6c69 656e 742e 7374 6172 745f 7365 7276  lient.start_serv
-0000d100: 6963 6573 285b 2773 7663 275d 290a 2020  ices(['svc']).  
-0000d110: 2020 2020 2020 7365 6c66 2e5f 7365 7276        self._serv
-0000d120: 6963 6573 5f61 6374 696f 6e5f 6865 6c70  ices_action_help
-0000d130: 6572 2827 7374 6172 7427 2c20 6170 695f  er('start', api_
-0000d140: 6675 6e63 2c20 5b27 7376 6327 5d29 0a0a  func, ['svc'])..
-0000d150: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000d160: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
-0000d170: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
-0000d180: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000d190: 6e74 2e73 7461 7274 5f73 6572 7669 6365  nt.start_service
-0000d1a0: 7328 3129 0a0a 2020 2020 2020 2020 7769  s(1)..        wi
-0000d1b0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000d1c0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-0000d1d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000d1e0: 662e 636c 6965 6e74 2e73 7461 7274 5f73  f.client.start_s
-0000d1f0: 6572 7669 6365 7328 5b31 5d29 0a0a 2020  ervices([1])..  
-0000d200: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000d210: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-0000d220: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000d230: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0000d240: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
-0000d250: 5b5b 2766 6f6f 275d 5d29 0a0a 2020 2020  [['foo']])..    
-0000d260: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
-0000d270: 6572 7669 6365 735f 6173 796e 6328 7365  ervices_async(se
-0000d280: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
-0000d290: 2061 7069 5f66 756e 6328 7469 6d65 6f75   api_func(timeou
-0000d2a0: 743d 3330 293a 0a20 2020 2020 2020 2020  t=30):.         
-0000d2b0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-0000d2c0: 6c69 656e 742e 7374 6172 745f 7365 7276  lient.start_serv
-0000d2d0: 6963 6573 285b 2773 7663 275d 2c20 7469  ices(['svc'], ti
-0000d2e0: 6d65 6f75 743d 7469 6d65 6f75 7429 0a20  meout=timeout). 
-0000d2f0: 2020 2020 2020 2073 656c 662e 5f73 6572         self._ser
-0000d300: 7669 6365 735f 6163 7469 6f6e 5f61 7379  vices_action_asy
-0000d310: 6e63 5f68 656c 7065 7228 2773 7461 7274  nc_helper('start
-0000d320: 272c 2061 7069 5f66 756e 632c 205b 2773  ', api_func, ['s
-0000d330: 7663 275d 290a 0a20 2020 2064 6566 2074  vc'])..    def t
-0000d340: 6573 745f 7374 6f70 5f73 6572 7669 6365  est_stop_service
-0000d350: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0000d360: 2064 6566 2061 7069 5f66 756e 6328 293a   def api_func():
-0000d370: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000d380: 7572 6e20 7365 6c66 2e63 6c69 656e 742e  urn self.client.
-0000d390: 7374 6f70 5f73 6572 7669 6365 7328 5b27  stop_services(['
-0000d3a0: 7376 6327 5d29 0a20 2020 2020 2020 2073  svc']).        s
-0000d3b0: 656c 662e 5f73 6572 7669 6365 735f 6163  elf._services_ac
-0000d3c0: 7469 6f6e 5f68 656c 7065 7228 2773 746f  tion_helper('sto
-0000d3d0: 7027 2c20 6170 695f 6675 6e63 2c20 5b27  p', api_func, ['
-0000d3e0: 7376 6327 5d29 0a0a 2020 2020 2020 2020  svc'])..        
-0000d3f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000d400: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-0000d410: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-0000d420: 656c 662e 636c 6965 6e74 2e73 746f 705f  elf.client.stop_
-0000d430: 7365 7276 6963 6573 2831 290a 0a20 2020  services(1)..   
-0000d440: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000d450: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0000d460: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000d470: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000d480: 7374 6f70 5f73 6572 7669 6365 7328 5b31  stop_services([1
-0000d490: 5d29 0a0a 2020 2020 2020 2020 7769 7468  ])..        with
-0000d4a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000d4b0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-0000d4c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000d4d0: 636c 6965 6e74 2e73 746f 705f 7365 7276  client.stop_serv
-0000d4e0: 6963 6573 285b 5b27 666f 6f27 5d5d 290a  ices([['foo']]).
-0000d4f0: 0a20 2020 2064 6566 2074 6573 745f 7374  .    def test_st
-0000d500: 6f70 5f73 6572 7669 6365 735f 6173 796e  op_services_asyn
-0000d510: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
-0000d520: 2064 6566 2061 7069 5f66 756e 6328 7469   def api_func(ti
-0000d530: 6d65 6f75 743d 3330 293a 0a20 2020 2020  meout=30):.     
-0000d540: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000d550: 6c66 2e63 6c69 656e 742e 7374 6f70 5f73  lf.client.stop_s
-0000d560: 6572 7669 6365 7328 5b27 7376 6327 5d2c  ervices(['svc'],
-0000d570: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
-0000d580: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0000d590: 7365 7276 6963 6573 5f61 6374 696f 6e5f  services_action_
-0000d5a0: 6173 796e 635f 6865 6c70 6572 2827 7374  async_helper('st
-0000d5b0: 6f70 272c 2061 7069 5f66 756e 632c 205b  op', api_func, [
-0000d5c0: 2773 7663 275d 290a 0a20 2020 2064 6566  'svc'])..    def
-0000d5d0: 2074 6573 745f 7265 7374 6172 745f 7365   test_restart_se
-0000d5e0: 7276 6963 6573 2873 656c 6629 3a0a 2020  rvices(self):.  
-0000d5f0: 2020 2020 2020 6465 6620 6170 695f 6675        def api_fu
-0000d600: 6e63 2829 3a0a 2020 2020 2020 2020 2020  nc():.          
-0000d610: 2020 7265 7475 726e 2073 656c 662e 636c    return self.cl
-0000d620: 6965 6e74 2e72 6573 7461 7274 5f73 6572  ient.restart_ser
-0000d630: 7669 6365 7328 5b27 7376 6327 5d29 0a20  vices(['svc']). 
-0000d640: 2020 2020 2020 2073 656c 662e 5f73 6572         self._ser
-0000d650: 7669 6365 735f 6163 7469 6f6e 5f68 656c  vices_action_hel
-0000d660: 7065 7228 2772 6573 7461 7274 272c 2061  per('restart', a
-0000d670: 7069 5f66 756e 632c 205b 2773 7663 275d  pi_func, ['svc']
-0000d680: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-0000d690: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000d6a0: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-0000d6b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0000d6c0: 6c69 656e 742e 7265 7374 6172 745f 7365  lient.restart_se
-0000d6d0: 7276 6963 6573 2831 290a 0a20 2020 2020  rvices(1)..     
-0000d6e0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000d6f0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0000d700: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000d710: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000d720: 7374 6172 745f 7365 7276 6963 6573 285b  start_services([
-0000d730: 315d 290a 0a20 2020 2020 2020 2077 6974  1])..        wit
-0000d740: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000d750: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-0000d760: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000d770: 2e63 6c69 656e 742e 7265 7374 6172 745f  .client.restart_
-0000d780: 7365 7276 6963 6573 285b 5b27 666f 6f27  services([['foo'
-0000d790: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
-0000d7a0: 745f 7265 7374 6172 745f 7365 7276 6963  t_restart_servic
-0000d7b0: 6573 5f61 7379 6e63 2873 656c 6629 3a0a  es_async(self):.
-0000d7c0: 2020 2020 2020 2020 6465 6620 6170 695f          def api_
-0000d7d0: 6675 6e63 2874 696d 656f 7574 3d33 3029  func(timeout=30)
-0000d7e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000d7f0: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
-0000d800: 2e72 6573 7461 7274 5f73 6572 7669 6365  .restart_service
-0000d810: 7328 5b27 7376 6327 5d2c 2074 696d 656f  s(['svc'], timeo
-0000d820: 7574 3d74 696d 656f 7574 290a 2020 2020  ut=timeout).    
-0000d830: 2020 2020 7365 6c66 2e5f 7365 7276 6963      self._servic
-0000d840: 6573 5f61 6374 696f 6e5f 6173 796e 635f  es_action_async_
-0000d850: 6865 6c70 6572 2827 7265 7374 6172 7427  helper('restart'
-0000d860: 2c20 6170 695f 6675 6e63 2c20 5b27 7376  , api_func, ['sv
-0000d870: 6327 5d29 0a0a 2020 2020 6465 6620 7465  c'])..    def te
-0000d880: 7374 5f63 6861 6e67 655f 6572 726f 7228  st_change_error(
-0000d890: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000d8a0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000d8b0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-0000d8c0: 2020 2020 2020 2020 2020 2263 6861 6e67            "chang
-0000d8d0: 6522 3a20 2237 3022 2c0a 2020 2020 2020  e": "70",.      
-0000d8e0: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
-0000d8f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0000d900: 2020 2273 7461 7475 7322 3a20 2241 6363    "status": "Acc
-0000d910: 6570 7465 6422 2c0a 2020 2020 2020 2020  epted",.        
-0000d920: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000d930: 223a 2032 3032 2c0a 2020 2020 2020 2020  ": 202,.        
-0000d940: 2020 2020 2274 7970 6522 3a20 2261 7379      "type": "asy
-0000d950: 6e63 220a 2020 2020 2020 2020 7d29 0a20  nc".        }). 
-0000d960: 2020 2020 2020 2063 6861 6e67 6520 3d20         change = 
-0000d970: 6275 696c 645f 6d6f 636b 5f63 6861 6e67  build_mock_chang
-0000d980: 655f 6469 6374 2829 0a20 2020 2020 2020  e_dict().       
-0000d990: 2063 6861 6e67 655b 2765 7272 275d 203d   change['err'] =
-0000d9a0: 2027 536f 6d65 206b 696e 6420 6f66 2073   'Some kind of s
-0000d9b0: 6572 7669 6365 2065 7272 6f72 270a 2020  ervice error'.  
-0000d9c0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000d9d0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-0000d9e0: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
-0000d9f0: 2022 7265 7375 6c74 223a 2063 6861 6e67   "result": chang
-0000da00: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-0000da10: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-0000da20: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-0000da30: 7573 2d63 6f64 6522 3a20 3230 302c 0a20  us-code": 200,. 
-0000da40: 2020 2020 2020 2020 2020 2022 7479 7065             "type
-0000da50: 223a 2022 7379 6e63 220a 2020 2020 2020  ": "sync".      
-0000da60: 2020 7d29 0a20 2020 2020 2020 2077 6974    }).        wit
-0000da70: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000da80: 7365 7328 7065 6262 6c65 2e43 6861 6e67  ses(pebble.Chang
-0000da90: 6545 7272 6f72 2920 6173 2063 6d3a 0a20  eError) as cm:. 
-0000daa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000dab0: 636c 6965 6e74 2e61 7574 6f73 7461 7274  client.autostart
-0000dac0: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
-0000dad0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0000dae0: 7349 6e73 7461 6e63 6528 636d 2e65 7863  sInstance(cm.exc
-0000daf0: 6570 7469 6f6e 2c20 7065 6262 6c65 2e45  eption, pebble.E
-0000db00: 7272 6f72 290a 2020 2020 2020 2020 7365  rror).        se
-0000db10: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000db20: 6d2e 6578 6365 7074 696f 6e2e 6572 722c  m.exception.err,
-0000db30: 2027 536f 6d65 206b 696e 6420 6f66 2073   'Some kind of s
-0000db40: 6572 7669 6365 2065 7272 6f72 2729 0a20  ervice error'). 
-0000db50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000db60: 7274 4973 496e 7374 616e 6365 2863 6d2e  rtIsInstance(cm.
-0000db70: 6578 6365 7074 696f 6e2e 6368 616e 6765  exception.change
-0000db80: 2c20 7065 6262 6c65 2e43 6861 6e67 6529  , pebble.Change)
-0000db90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000dba0: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
-0000dbb0: 6570 7469 6f6e 2e63 6861 6e67 652e 6964  eption.change.id
-0000dbc0: 2c20 2737 3027 290a 0a20 2020 2020 2020  , '70')..       
-0000dbd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000dbe0: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-0000dbf0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000dc00: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
-0000dc10: 2f76 312f 7365 7276 6963 6573 272c 204e  /v1/services', N
-0000dc20: 6f6e 652c 207b 2761 6374 696f 6e27 3a20  one, {'action': 
-0000dc30: 2761 7574 6f73 7461 7274 272c 2027 7365  'autostart', 'se
-0000dc40: 7276 6963 6573 273a 205b 5d7d 292c 0a20  rvices': []}),. 
-0000dc50: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000dc60: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-0000dc70: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
-0000dc80: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-0000dc90: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000dca0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000dcb0: 5f77 6169 745f 6368 616e 6765 5f73 7563  _wait_change_suc
-0000dcc0: 6365 7373 2873 656c 662c 2074 696d 656f  cess(self, timeo
-0000dcd0: 7574 3d33 302e 3029 3a0a 2020 2020 2020  ut=30.0):.      
-0000dce0: 2020 6368 616e 6765 203d 2062 7569 6c64    change = build
-0000dcf0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
-0000dd00: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000dd10: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000dd20: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
-0000dd30: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
-0000dd40: 2063 6861 6e67 652c 0a20 2020 2020 2020   change,.       
-0000dd50: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-0000dd60: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
-0000dd70: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-0000dd80: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-0000dd90: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-0000dda0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-0000ddb0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
-0000ddc0: 656c 662e 636c 6965 6e74 2e77 6169 745f  elf.client.wait_
-0000ddd0: 6368 616e 6765 2827 3730 272c 2074 696d  change('70', tim
-0000dde0: 656f 7574 3d74 696d 656f 7574 290a 2020  eout=timeout).  
-0000ddf0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000de00: 7445 7175 616c 2872 6573 706f 6e73 652e  tEqual(response.
-0000de10: 6964 2c20 2737 3027 290a 2020 2020 2020  id, '70').      
-0000de20: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000de30: 6528 7265 7370 6f6e 7365 2e72 6561 6479  e(response.ready
-0000de40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000de50: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000de60: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-0000de70: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000de80: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0000de90: 6e67 6573 2f37 302f 7761 6974 272c 207b  nges/70/wait', {
-0000dea0: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
-0000deb0: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
-0000dec0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-0000ded0: 2074 6573 745f 7761 6974 5f63 6861 6e67   test_wait_chang
-0000dee0: 655f 7375 6363 6573 735f 7469 6d65 6f75  e_success_timeou
-0000def0: 745f 6e6f 6e65 2873 656c 6629 3a0a 2020  t_none(self):.  
-0000df00: 2020 2020 2020 7365 6c66 2e74 6573 745f        self.test_
-0000df10: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
-0000df20: 6573 7328 7469 6d65 6f75 743d 4e6f 6e65  ess(timeout=None
-0000df30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000df40: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
-0000df50: 6573 735f 6d75 6c74 6970 6c65 5f63 616c  ess_multiple_cal
-0000df60: 6c73 2873 656c 6629 3a0a 2020 2020 2020  ls(self):.      
-0000df70: 2020 6465 6620 7469 6d65 6f75 745f 7265    def timeout_re
-0000df80: 7370 6f6e 7365 286e 293a 0a20 2020 2020  sponse(n):.     
-0000df90: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
-0000dfa0: 2e73 6c65 6570 286e 2920 2023 2073 696d  .sleep(n)  # sim
-0000dfb0: 756c 6174 6520 7061 7373 696e 6720 6f66  ulate passing of
-0000dfc0: 2074 696d 6520 6475 6520 746f 2077 6169   time due to wai
-0000dfd0: 745f 6368 616e 6765 2063 616c 6c0a 2020  t_change call.  
-0000dfe0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000dff0: 7065 6262 6c65 2e41 5049 4572 726f 7228  pebble.APIError(
-0000e000: 7b7d 2c20 3530 342c 2022 4761 7465 7761  {}, 504, "Gatewa
-0000e010: 7920 5469 6d65 6f75 7422 2c20 2274 696d  y Timeout", "tim
-0000e020: 6564 206f 7574 2229 0a0a 2020 2020 2020  ed out")..      
-0000e030: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000e040: 7370 6f6e 7365 732e 6170 7065 6e64 286c  sponses.append(l
-0000e050: 616d 6264 613a 2074 696d 656f 7574 5f72  ambda: timeout_r
-0000e060: 6573 706f 6e73 6528 3429 290a 0a20 2020  esponse(4))..   
-0000e070: 2020 2020 2063 6861 6e67 6520 3d20 6275       change = bu
-0000e080: 696c 645f 6d6f 636b 5f63 6861 6e67 655f  ild_mock_change_
-0000e090: 6469 6374 2829 0a20 2020 2020 2020 2073  dict().        s
-0000e0a0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000e0b0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-0000e0c0: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-0000e0d0: 7422 3a20 6368 616e 6765 2c0a 2020 2020  t": change,.    
-0000e0e0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000e0f0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000e100: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000e110: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000e120: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000e130: 6322 0a20 2020 2020 2020 207d 290a 0a20  c".        }).. 
-0000e140: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-0000e150: 3d20 7365 6c66 2e63 6c69 656e 742e 7761  = self.client.wa
-0000e160: 6974 5f63 6861 6e67 6528 2737 3027 290a  it_change('70').
-0000e170: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000e180: 6572 7445 7175 616c 2872 6573 706f 6e73  ertEqual(respons
-0000e190: 652e 6964 2c20 2737 3027 290a 2020 2020  e.id, '70').    
-0000e1a0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000e1b0: 7275 6528 7265 7370 6f6e 7365 2e72 6561  rue(response.rea
-0000e1c0: 6479 290a 0a20 2020 2020 2020 2073 656c  dy)..        sel
-0000e1d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e1e0: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-0000e1f0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0000e200: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0000e210: 6861 6e67 6573 2f37 302f 7761 6974 272c  hanges/70/wait',
-0000e220: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
-0000e230: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
-0000e240: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000e250: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-0000e260: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
-0000e270: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-0000e280: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000e290: 5d29 0a0a 2020 2020 2020 2020 7365 6c66  ])..        self
-0000e2a0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000e2b0: 662e 7469 6d65 2e74 696d 6528 292c 2034  f.time.time(), 4
-0000e2c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000e2d0: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
-0000e2e0: 6573 735f 706f 6c6c 6564 2873 656c 662c  ess_polled(self,
-0000e2f0: 2074 696d 656f 7574 3d33 302e 3029 3a0a   timeout=30.0):.
-0000e300: 2020 2020 2020 2020 2320 5472 6967 6765          # Trigge
-0000e310: 7220 706f 6c6c 6564 206d 6f64 650a 2020  r polled mode.  
-0000e320: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000e330: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-0000e340: 6e64 2870 6562 626c 652e 4150 4945 7272  nd(pebble.APIErr
-0000e350: 6f72 287b 7d2c 2034 3034 2c20 224e 6f74  or({}, 404, "Not
-0000e360: 2046 6f75 6e64 222c 2022 6e6f 7420 666f   Found", "not fo
-0000e370: 756e 6422 2929 0a0a 2020 2020 2020 2020  und"))..        
-0000e380: 666f 7220 6920 696e 2072 616e 6765 2833  for i in range(3
-0000e390: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-0000e3a0: 6861 6e67 6520 3d20 6275 696c 645f 6d6f  hange = build_mo
-0000e3b0: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
-0000e3c0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-0000e3d0: 6e67 655b 2772 6561 6479 275d 203d 2069  nge['ready'] = i
-0000e3e0: 203d 3d20 320a 2020 2020 2020 2020 2020   == 2.          
-0000e3f0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000e400: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-0000e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e420: 2022 7265 7375 6c74 223a 2063 6861 6e67   "result": chang
-0000e430: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e440: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-0000e450: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000e460: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-0000e470: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-0000e480: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
-0000e490: 7379 6e63 220a 2020 2020 2020 2020 2020  sync".          
-0000e4a0: 2020 7d29 0a0a 2020 2020 2020 2020 7265    })..        re
-0000e4b0: 7370 6f6e 7365 203d 2073 656c 662e 636c  sponse = self.cl
-0000e4c0: 6965 6e74 2e77 6169 745f 6368 616e 6765  ient.wait_change
-0000e4d0: 2827 3730 272c 2074 696d 656f 7574 3d74  ('70', timeout=t
-0000e4e0: 696d 656f 7574 2c20 6465 6c61 793d 3129  imeout, delay=1)
-0000e4f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e500: 7365 7274 4571 7561 6c28 7265 7370 6f6e  sertEqual(respon
-0000e510: 7365 2e69 642c 2027 3730 2729 0a20 2020  se.id, '70').   
-0000e520: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000e530: 5472 7565 2872 6573 706f 6e73 652e 7265  True(response.re
-0000e540: 6164 7929 0a0a 2020 2020 2020 2020 7365  ady)..        se
-0000e550: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000e560: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0000e570: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000e580: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-0000e590: 6368 616e 6765 732f 3730 2f77 6169 7427  changes/70/wait'
-0000e5a0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
-0000e5b0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
-0000e5c0: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
-0000e5d0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
-0000e5e0: 2f37 3027 2c20 4e6f 6e65 2c20 4e6f 6e65  /70', None, None
-0000e5f0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-0000e600: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-0000e610: 6765 732f 3730 272c 204e 6f6e 652c 204e  ges/70', None, N
-0000e620: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-0000e630: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0000e640: 6861 6e67 6573 2f37 3027 2c20 4e6f 6e65  hanges/70', None
-0000e650: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-0000e660: 205d 290a 0a20 2020 2020 2020 2073 656c   ])..        sel
-0000e670: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e680: 6c66 2e74 696d 652e 7469 6d65 2829 2c20  lf.time.time(), 
-0000e690: 3229 0a0a 2020 2020 6465 6620 7465 7374  2)..    def test
-0000e6a0: 5f77 6169 745f 6368 616e 6765 5f73 7563  _wait_change_suc
-0000e6b0: 6365 7373 5f70 6f6c 6c65 645f 7469 6d65  cess_polled_time
-0000e6c0: 6f75 745f 6e6f 6e65 2873 656c 6629 3a0a  out_none(self):.
-0000e6d0: 2020 2020 2020 2020 7365 6c66 2e74 6573          self.tes
-0000e6e0: 745f 7761 6974 5f63 6861 6e67 655f 7375  t_wait_change_su
-0000e6f0: 6363 6573 735f 706f 6c6c 6564 2874 696d  ccess_polled(tim
-0000e700: 656f 7574 3d4e 6f6e 6529 0a0a 2020 2020  eout=None)..    
-0000e710: 6465 6620 7465 7374 5f77 6169 745f 6368  def test_wait_ch
-0000e720: 616e 6765 5f74 696d 656f 7574 2873 656c  ange_timeout(sel
-0000e730: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
-0000e740: 7469 6d65 6f75 745f 7265 7370 6f6e 7365  timeout_response
-0000e750: 286e 293a 0a20 2020 2020 2020 2020 2020  (n):.           
-0000e760: 2073 656c 662e 7469 6d65 2e73 6c65 6570   self.time.sleep
-0000e770: 286e 2920 2023 2073 696d 756c 6174 6520  (n)  # simulate 
-0000e780: 7061 7373 696e 6720 6f66 2074 696d 6520  passing of time 
-0000e790: 6475 6520 746f 2077 6169 745f 6368 616e  due to wait_chan
-0000e7a0: 6765 2063 616c 6c0a 2020 2020 2020 2020  ge call.        
-0000e7b0: 2020 2020 7261 6973 6520 7065 6262 6c65      raise pebble
-0000e7c0: 2e41 5049 4572 726f 7228 7b7d 2c20 3530  .APIError({}, 50
-0000e7d0: 342c 2022 4761 7465 7761 7920 5469 6d65  4, "Gateway Time
-0000e7e0: 6f75 7422 2c20 2274 696d 6564 206f 7574  out", "timed out
-0000e7f0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
-0000e800: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000e810: 732e 6170 7065 6e64 286c 616d 6264 613a  s.append(lambda:
-0000e820: 2074 696d 656f 7574 5f72 6573 706f 6e73   timeout_respons
-0000e830: 6528 3429 290a 2020 2020 2020 2020 7365  e(4)).        se
-0000e840: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000e850: 7365 732e 6170 7065 6e64 286c 616d 6264  ses.append(lambd
-0000e860: 613a 2074 696d 656f 7574 5f72 6573 706f  a: timeout_respo
-0000e870: 6e73 6528 3229 290a 0a20 2020 2020 2020  nse(2))..       
-0000e880: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000e890: 7452 6169 7365 7328 7065 6262 6c65 2e54  tRaises(pebble.T
-0000e8a0: 696d 656f 7574 4572 726f 7229 2061 7320  imeoutError) as 
-0000e8b0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-0000e8c0: 7365 6c66 2e63 6c69 656e 742e 7761 6974  self.client.wait
-0000e8d0: 5f63 6861 6e67 6528 2737 3027 2c20 7469  _change('70', ti
-0000e8e0: 6d65 6f75 743d 3629 0a20 2020 2020 2020  meout=6).       
-0000e8f0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0000e900: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
-0000e910: 696f 6e2c 2070 6562 626c 652e 4572 726f  ion, pebble.Erro
-0000e920: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-0000e930: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-0000e940: 2863 6d2e 6578 6365 7074 696f 6e2c 2054  (cm.exception, T
-0000e950: 696d 656f 7574 4572 726f 7229 0a0a 2020  imeoutError)..  
-0000e960: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e970: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-0000e980: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-0000e990: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000e9a0: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-0000e9b0: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
-0000e9c0: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-0000e9d0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000e9e0: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-0000e9f0: 2f63 6861 6e67 6573 2f37 302f 7761 6974  /changes/70/wait
-0000ea00: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
-0000ea10: 322e 3030 3073 277d 2c20 4e6f 6e65 292c  2.000s'}, None),
-0000ea20: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-0000ea30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000ea40: 4571 7561 6c28 7365 6c66 2e74 696d 652e  Equal(self.time.
-0000ea50: 7469 6d65 2829 2c20 3629 0a0a 2020 2020  time(), 6)..    
-0000ea60: 6465 6620 7465 7374 5f77 6169 745f 6368  def test_wait_ch
-0000ea70: 616e 6765 5f74 696d 656f 7574 5f70 6f6c  ange_timeout_pol
-0000ea80: 6c65 6428 7365 6c66 293a 0a20 2020 2020  led(self):.     
-0000ea90: 2020 2023 2054 7269 6767 6572 2070 6f6c     # Trigger pol
-0000eaa0: 6c65 6420 6d6f 6465 0a20 2020 2020 2020  led mode.       
-0000eab0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-0000eac0: 706f 6e73 6573 2e61 7070 656e 6428 7065  ponses.append(pe
-0000ead0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
-0000eae0: 2c20 3430 342c 2022 4e6f 7420 466f 756e  , 404, "Not Foun
-0000eaf0: 6422 2c20 226e 6f74 2066 6f75 6e64 2229  d", "not found")
-0000eb00: 290a 0a20 2020 2020 2020 2063 6861 6e67  )..        chang
-0000eb10: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
-0000eb20: 6861 6e67 655f 6469 6374 2829 0a20 2020  hange_dict().   
-0000eb30: 2020 2020 2063 6861 6e67 655b 2772 6561       change['rea
-0000eb40: 6479 275d 203d 2046 616c 7365 0a20 2020  dy'] = False.   
-0000eb50: 2020 2020 2066 6f72 205f 2069 6e20 7261       for _ in ra
-0000eb60: 6e67 6528 3329 3a0a 2020 2020 2020 2020  nge(3):.        
-0000eb70: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000eb80: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000eb90: 287b 0a20 2020 2020 2020 2020 2020 2020  ({.             
-0000eba0: 2020 2022 7265 7375 6c74 223a 2063 6861     "result": cha
-0000ebb0: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
-0000ebc0: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-0000ebd0: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
-0000ebe0: 2020 2020 2022 7374 6174 7573 2d63 6f64       "status-cod
-0000ebf0: 6522 3a20 3230 302c 0a20 2020 2020 2020  e": 200,.       
-0000ec00: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
-0000ec10: 2022 7379 6e63 220a 2020 2020 2020 2020   "sync".        
-0000ec20: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
-0000ec30: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000ec40: 5261 6973 6573 2870 6562 626c 652e 5469  Raises(pebble.Ti
-0000ec50: 6d65 6f75 7445 7272 6f72 2920 6173 2063  meoutError) as c
-0000ec60: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0000ec70: 656c 662e 636c 6965 6e74 2e77 6169 745f  elf.client.wait_
-0000ec80: 6368 616e 6765 2827 3730 272c 2074 696d  change('70', tim
-0000ec90: 656f 7574 3d33 2c20 6465 6c61 793d 3129  eout=3, delay=1)
-0000eca0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000ecb0: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
-0000ecc0: 6d2e 6578 6365 7074 696f 6e2c 2070 6562  m.exception, peb
-0000ecd0: 626c 652e 4572 726f 7229 0a20 2020 2020  ble.Error).     
-0000ece0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0000ecf0: 496e 7374 616e 6365 2863 6d2e 6578 6365  Instance(cm.exce
-0000ed00: 7074 696f 6e2c 2054 696d 656f 7574 4572  ption, TimeoutEr
-0000ed10: 726f 7229 0a0a 2020 2020 2020 2020 7365  ror)..        se
-0000ed20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000ed30: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0000ed40: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000ed50: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-0000ed60: 6368 616e 6765 732f 3730 2f77 6169 7427  changes/70/wait'
-0000ed70: 2c20 7b27 7469 6d65 6f75 7427 3a20 2733  , {'timeout': '3
-0000ed80: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
-0000ed90: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
-0000eda0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
-0000edb0: 2f37 3027 2c20 4e6f 6e65 2c20 4e6f 6e65  /70', None, None
-0000edc0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-0000edd0: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-0000ede0: 6765 732f 3730 272c 204e 6f6e 652c 204e  ges/70', None, N
-0000edf0: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-0000ee00: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0000ee10: 6861 6e67 6573 2f37 3027 2c20 4e6f 6e65  hanges/70', None
-0000ee20: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-0000ee30: 205d 290a 0a20 2020 2020 2020 2073 656c   ])..        sel
-0000ee40: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000ee50: 6c66 2e74 696d 652e 7469 6d65 2829 2c20  lf.time.time(), 
-0000ee60: 3329 0a0a 2020 2020 6465 6620 7465 7374  3)..    def test
-0000ee70: 5f77 6169 745f 6368 616e 6765 5f65 7272  _wait_change_err
-0000ee80: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-0000ee90: 2020 6368 616e 6765 203d 2062 7569 6c64    change = build
-0000eea0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
-0000eeb0: 7428 290a 2020 2020 2020 2020 6368 616e  t().        chan
-0000eec0: 6765 5b27 6572 7227 5d20 3d20 2753 6f6d  ge['err'] = 'Som
-0000eed0: 6520 6b69 6e64 206f 6620 7365 7276 6963  e kind of servic
-0000eee0: 6520 6572 726f 7227 0a20 2020 2020 2020  e error'.       
-0000eef0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-0000ef00: 706f 6e73 6573 2e61 7070 656e 6428 7b0a  ponses.append({.
-0000ef10: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-0000ef20: 756c 7422 3a20 6368 616e 6765 2c0a 2020  ult": change,.  
-0000ef30: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000ef40: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-0000ef50: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000ef60: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-0000ef70: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-0000ef80: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-0000ef90: 2020 2020 2020 2020 2320 7761 6974 5f63          # wait_c
-0000efa0: 6861 6e67 6528 2920 6974 7365 6c66 2073  hange() itself s
-0000efb0: 686f 756c 646e 2774 2072 6169 7365 2061  houldn't raise a
-0000efc0: 6e20 6572 726f 720a 2020 2020 2020 2020  n error.        
-0000efd0: 7265 7370 6f6e 7365 203d 2073 656c 662e  response = self.
-0000efe0: 636c 6965 6e74 2e77 6169 745f 6368 616e  client.wait_chan
-0000eff0: 6765 2827 3730 2729 0a20 2020 2020 2020  ge('70').       
-0000f000: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f010: 6c28 7265 7370 6f6e 7365 2e69 642c 2027  l(response.id, '
-0000f020: 3730 2729 0a20 2020 2020 2020 2073 656c  70').        sel
-0000f030: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-0000f040: 7370 6f6e 7365 2e65 7272 2c20 2753 6f6d  sponse.err, 'Som
-0000f050: 6520 6b69 6e64 206f 6620 7365 7276 6963  e kind of servic
-0000f060: 6520 6572 726f 7227 290a 0a20 2020 2020  e error')..     
-0000f070: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f080: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0000f090: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000f0a0: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-0000f0b0: 272f 7631 2f63 6861 6e67 6573 2f37 302f  '/v1/changes/70/
-0000f0c0: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
-0000f0d0: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
-0000f0e0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0000f0f0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-0000f100: 645f 6c61 7965 7228 7365 6c66 293a 0a20  d_layer(self):. 
-0000f110: 2020 2020 2020 206f 6b61 795f 7265 7370         okay_resp
-0000f120: 6f6e 7365 203d 207b 0a20 2020 2020 2020  onse = {.       
-0000f130: 2020 2020 2022 7265 7375 6c74 223a 2054       "result": T
-0000f140: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000f150: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
-0000f160: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0000f170: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
-0000f180: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
-0000f190: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
-0000f1a0: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-0000f1b0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000f1c0: 7365 732e 6170 7065 6e64 286f 6b61 795f  ses.append(okay_
-0000f1d0: 7265 7370 6f6e 7365 290a 2020 2020 2020  response).      
-0000f1e0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000f1f0: 7370 6f6e 7365 732e 6170 7065 6e64 286f  sponses.append(o
-0000f200: 6b61 795f 7265 7370 6f6e 7365 290a 2020  kay_response).  
-0000f210: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000f220: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-0000f230: 6e64 286f 6b61 795f 7265 7370 6f6e 7365  nd(okay_response
-0000f240: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000f250: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
-0000f260: 6170 7065 6e64 286f 6b61 795f 7265 7370  append(okay_resp
-0000f270: 6f6e 7365 290a 0a20 2020 2020 2020 206c  onse)..        l
-0000f280: 6179 6572 5f79 616d 6c20 3d20 2222 220a  ayer_yaml = """.
-0000f290: 7365 7276 6963 6573 3a0a 2020 666f 6f3a  services:.  foo:
-0000f2a0: 0a20 2020 2063 6f6d 6d61 6e64 3a20 6563  .    command: ec
-0000f2b0: 686f 2062 6172 0a20 2020 206f 7665 7272  ho bar.    overr
-0000f2c0: 6964 653a 2072 6570 6c61 6365 0a22 2222  ide: replace."""
-0000f2d0: 5b31 3a5d 0a20 2020 2020 2020 206c 6179  [1:].        lay
-0000f2e0: 6572 203d 2070 6562 626c 652e 4c61 7965  er = pebble.Laye
-0000f2f0: 7228 6c61 7965 725f 7961 6d6c 290a 0a20  r(layer_yaml).. 
-0000f300: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000f310: 6e74 2e61 6464 5f6c 6179 6572 2827 6127  nt.add_layer('a'
-0000f320: 2c20 6c61 7965 7229 0a20 2020 2020 2020  , layer).       
-0000f330: 2073 656c 662e 636c 6965 6e74 2e61 6464   self.client.add
-0000f340: 5f6c 6179 6572 2827 6227 2c20 6c61 7965  _layer('b', laye
-0000f350: 722e 746f 5f79 616d 6c28 2929 0a20 2020  r.to_yaml()).   
-0000f360: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0000f370: 2e61 6464 5f6c 6179 6572 2827 6327 2c20  .add_layer('c', 
-0000f380: 6c61 7965 722e 746f 5f64 6963 7428 2929  layer.to_dict())
-0000f390: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0000f3a0: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
-0000f3b0: 6427 2c20 6c61 7965 722c 2063 6f6d 6269  d', layer, combi
-0000f3c0: 6e65 3d54 7275 6529 0a0a 2020 2020 2020  ne=True)..      
-0000f3d0: 2020 6465 6620 6275 696c 645f 6578 7065    def build_expe
-0000f3e0: 6374 6564 286c 6162 656c 2c20 636f 6d62  cted(label, comb
-0000f3f0: 696e 6529 3a0a 2020 2020 2020 2020 2020  ine):.          
-0000f400: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-0000f410: 2020 2020 2020 2020 2020 2027 6163 7469             'acti
-0000f420: 6f6e 273a 2027 6164 6427 2c0a 2020 2020  on': 'add',.    
-0000f430: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
-0000f440: 6269 6e65 273a 2063 6f6d 6269 6e65 2c0a  bine': combine,.
-0000f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f460: 276c 6162 656c 273a 206c 6162 656c 2c0a  'label': label,.
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2766 6f72 6d61 7427 3a20 2779 616d 6c27  'format': 'yaml'
-0000f490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f4a0: 2020 276c 6179 6572 273a 206c 6179 6572    'layer': layer
-0000f4b0: 5f79 616d 6c2c 0a20 2020 2020 2020 2020  _yaml,.         
-0000f4c0: 2020 207d 0a0a 2020 2020 2020 2020 7365     }..        se
-0000f4d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000f4e0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0000f4f0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000f500: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-0000f510: 2f6c 6179 6572 7327 2c20 4e6f 6e65 2c20  /layers', None, 
-0000f520: 6275 696c 645f 6578 7065 6374 6564 2827  build_expected('
-0000f530: 6127 2c20 4661 6c73 6529 292c 0a20 2020  a', False)),.   
-0000f540: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-0000f550: 2c20 272f 7631 2f6c 6179 6572 7327 2c20  , '/v1/layers', 
-0000f560: 4e6f 6e65 2c20 6275 696c 645f 6578 7065  None, build_expe
-0000f570: 6374 6564 2827 6227 2c20 4661 6c73 6529  cted('b', False)
-0000f580: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-0000f590: 2750 4f53 5427 2c20 272f 7631 2f6c 6179  'POST', '/v1/lay
-0000f5a0: 6572 7327 2c20 4e6f 6e65 2c20 6275 696c  ers', None, buil
-0000f5b0: 645f 6578 7065 6374 6564 2827 6327 2c20  d_expected('c', 
-0000f5c0: 4661 6c73 6529 292c 0a20 2020 2020 2020  False)),.       
-0000f5d0: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
-0000f5e0: 7631 2f6c 6179 6572 7327 2c20 4e6f 6e65  v1/layers', None
-0000f5f0: 2c20 6275 696c 645f 6578 7065 6374 6564  , build_expected
-0000f600: 2827 6427 2c20 5472 7565 2929 2c0a 2020  ('d', True)),.  
-0000f610: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-0000f620: 6620 7465 7374 5f61 6464 5f6c 6179 6572  f test_add_layer
-0000f630: 5f69 6e76 616c 6964 5f74 7970 6528 7365  _invalid_type(se
-0000f640: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
-0000f650: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000f660: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-0000f670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f680: 2e63 6c69 656e 742e 6164 645f 6c61 7965  .client.add_laye
-0000f690: 7228 2766 6f6f 272c 2034 3229 0a20 2020  r('foo', 42).   
-0000f6a0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000f6b0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0000f6c0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000f6d0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000f6e0: 6164 645f 6c61 7965 7228 3432 2c20 2766  add_layer(42, 'f
-0000f6f0: 6f6f 2729 0a0a 2020 2020 2020 2020 2320  oo')..        # 
-0000f700: 636f 6d62 696e 6520 6973 2061 206b 6579  combine is a key
-0000f710: 776f 7264 2d6f 6e6c 7920 6172 6720 2873  word-only arg (s
-0000f720: 686f 756c 6420 6265 2063 6f6d 6269 6e65  hould be combine
-0000f730: 3d54 7275 6529 0a20 2020 2020 2020 2077  =True).        w
-0000f740: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000f750: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-0000f760: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000f770: 6c66 2e63 6c69 656e 742e 6164 645f 6c61  lf.client.add_la
-0000f780: 7965 7228 2766 6f6f 272c 207b 7d2c 2054  yer('foo', {}, T
-0000f790: 7275 6529 0a0a 2020 2020 6465 6620 7465  rue)..    def te
-0000f7a0: 7374 5f67 6574 5f70 6c61 6e28 7365 6c66  st_get_plan(self
-0000f7b0: 293a 0a20 2020 2020 2020 2070 6c61 6e5f  ):.        plan_
-0000f7c0: 7961 6d6c 203d 2022 2222 0a73 6572 7669  yaml = """.servi
-0000f7d0: 6365 733a 0a20 2066 6f6f 3a0a 2020 2020  ces:.  foo:.    
-0000f7e0: 636f 6d6d 616e 643a 2065 6368 6f20 6261  command: echo ba
-0000f7f0: 720a 2020 2020 6f76 6572 7269 6465 3a20  r.    override: 
-0000f800: 7265 706c 6163 650a 2222 225b 313a 5d0a  replace."""[1:].
-0000f810: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0000f820: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
-0000f830: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
-0000f840: 2020 2022 7265 7375 6c74 223a 2070 6c61     "result": pla
-0000f850: 6e5f 7961 6d6c 2c0a 2020 2020 2020 2020  n_yaml,.        
-0000f860: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
-0000f870: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
-0000f880: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
-0000f890: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-0000f8a0: 2274 7970 6522 3a20 2273 796e 6322 0a20  "type": "sync". 
-0000f8b0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-0000f8c0: 2020 706c 616e 203d 2073 656c 662e 636c    plan = self.cl
-0000f8d0: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
-0000f8e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000f8f0: 6572 7445 7175 616c 2870 6c61 6e2e 746f  ertEqual(plan.to
-0000f900: 5f79 616d 6c28 292c 2070 6c61 6e5f 7961  _yaml(), plan_ya
-0000f910: 6d6c 290a 2020 2020 2020 2020 7365 6c66  ml).        self
-0000f920: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-0000f930: 2870 6c61 6e2e 7365 7276 6963 6573 292c  (plan.services),
-0000f940: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-0000f950: 2e61 7373 6572 7445 7175 616c 2870 6c61  .assertEqual(pla
-0000f960: 6e2e 7365 7276 6963 6573 5b27 666f 6f27  n.services['foo'
-0000f970: 5d2e 636f 6d6d 616e 642c 2027 6563 686f  ].command, 'echo
-0000f980: 2062 6172 2729 0a20 2020 2020 2020 2073   bar').        s
-0000f990: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000f9a0: 706c 616e 2e73 6572 7669 6365 735b 2766  plan.services['f
-0000f9b0: 6f6f 275d 2e6f 7665 7272 6964 652c 2027  oo'].override, '
-0000f9c0: 7265 706c 6163 6527 290a 0a20 2020 2020  replace')..     
-0000f9d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f9e0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0000f9f0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000fa00: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-0000fa10: 272f 7631 2f70 6c61 6e27 2c20 7b27 666f  '/v1/plan', {'fo
-0000fa20: 726d 6174 273a 2027 7961 6d6c 277d 2c20  rmat': 'yaml'}, 
-0000fa30: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0000fa40: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000fa50: 6765 745f 7365 7276 6963 6573 5f61 6c6c  get_services_all
-0000fa60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000fa70: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-0000fa80: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
-0000fa90: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
-0000faa0: 6c74 223a 205b 0a20 2020 2020 2020 2020  lt": [.         
-0000fab0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0000fac0: 2020 2020 2020 2020 2020 2020 2022 6375               "cu
-0000fad0: 7272 656e 7422 3a20 2269 6e61 6374 6976  rrent": "inactiv
-0000fae0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000faf0: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-0000fb00: 2273 7663 3122 2c0a 2020 2020 2020 2020  "svc1",.        
-0000fb10: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0000fb20: 7274 7570 223a 2022 6469 7361 626c 6564  rtup": "disabled
-0000fb30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000fb40: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000fb50: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000fb60: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
-0000fb70: 656e 7422 3a20 2261 6374 6976 6522 2c0a  ent": "active",.
-0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb90: 2020 2020 226e 616d 6522 3a20 2273 7663      "name": "svc
-0000fba0: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
-0000fbb0: 2020 2020 2020 2020 2273 7461 7274 7570          "startup
-0000fbc0: 223a 2022 656e 6162 6c65 6422 0a20 2020  ": "enabled".   
-0000fbd0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0000fbe0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-0000fbf0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000fc00: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-0000fc10: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000fc20: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-0000fc30: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-0000fc40: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-0000fc50: 2020 2020 2020 2020 7365 7276 6963 6573          services
-0000fc60: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-0000fc70: 6574 5f73 6572 7669 6365 7328 290a 2020  et_services().  
-0000fc80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000fc90: 7445 7175 616c 286c 656e 2873 6572 7669  tEqual(len(servi
-0000fca0: 6365 7329 2c20 3229 0a20 2020 2020 2020  ces), 2).       
-0000fcb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000fcc0: 6c28 7365 7276 6963 6573 5b30 5d2e 6e61  l(services[0].na
-0000fcd0: 6d65 2c20 2773 7663 3127 290a 2020 2020  me, 'svc1').    
-0000fce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fcf0: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
-0000fd00: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
-0000fd10: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-0000fd20: 4449 5341 424c 4544 290a 2020 2020 2020  DISABLED).      
-0000fd30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000fd40: 616c 2873 6572 7669 6365 735b 305d 2e63  al(services[0].c
-0000fd50: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
-0000fd60: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-0000fd70: 4354 4956 4529 0a20 2020 2020 2020 2073  CTIVE).        s
-0000fd80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000fd90: 7365 7276 6963 6573 5b31 5d2e 6e61 6d65  services[1].name
-0000fda0: 2c20 2773 7663 3227 290a 2020 2020 2020  , 'svc2').      
-0000fdb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000fdc0: 616c 2873 6572 7669 6365 735b 315d 2e73  al(services[1].s
-0000fdd0: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
-0000fde0: 6572 7669 6365 5374 6172 7475 702e 454e  erviceStartup.EN
-0000fdf0: 4142 4c45 4429 0a20 2020 2020 2020 2073  ABLED).        s
-0000fe00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000fe10: 7365 7276 6963 6573 5b31 5d2e 6375 7272  services[1].curr
-0000fe20: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
-0000fe30: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
-0000fe40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000fe50: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000fe60: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-0000fe70: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000fe80: 2827 4745 5427 2c20 272f 7631 2f73 6572  ('GET', '/v1/ser
-0000fe90: 7669 6365 7327 2c20 4e6f 6e65 2c20 4e6f  vices', None, No
-0000fea0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0000feb0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-0000fec0: 745f 7365 7276 6963 6573 5f6e 616d 6573  t_services_names
-0000fed0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000fee0: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-0000fef0: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
-0000ff00: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
-0000ff10: 6c74 223a 205b 0a20 2020 2020 2020 2020  lt": [.         
-0000ff20: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0000ff30: 2020 2020 2020 2020 2020 2020 2022 6375               "cu
-0000ff40: 7272 656e 7422 3a20 2269 6e61 6374 6976  rrent": "inactiv
-0000ff50: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000ff60: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-0000ff70: 2273 7663 3122 2c0a 2020 2020 2020 2020  "svc1",.        
-0000ff80: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0000ff90: 7274 7570 223a 2022 6469 7361 626c 6564  rtup": "disabled
-0000ffa0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000ffb0: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000ffc0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000ffd0: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
-0000ffe0: 656e 7422 3a20 2261 6374 6976 6522 2c0a  ent": "active",.
-0000fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010000: 2020 2020 226e 616d 6522 3a20 2273 7663      "name": "svc
-00010010: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
-00010020: 2020 2020 2020 2020 2273 7461 7274 7570          "startup
-00010030: 223a 2022 656e 6162 6c65 6422 0a20 2020  ": "enabled".   
-00010040: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00010050: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00010060: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00010070: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-00010080: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-00010090: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
-000100a0: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
-000100b0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
-000100c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-000100d0: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-000100e0: 6574 5f73 6572 7669 6365 7328 5b27 7376  et_services(['sv
-000100f0: 6331 272c 2027 7376 6332 275d 290a 2020  c1', 'svc2']).  
-00010100: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010110: 7445 7175 616c 286c 656e 2873 6572 7669  tEqual(len(servi
-00010120: 6365 7329 2c20 3229 0a20 2020 2020 2020  ces), 2).       
-00010130: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010140: 6c28 7365 7276 6963 6573 5b30 5d2e 6e61  l(services[0].na
-00010150: 6d65 2c20 2773 7663 3127 290a 2020 2020  me, 'svc1').    
-00010160: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00010170: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
-00010180: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
-00010190: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-000101a0: 4449 5341 424c 4544 290a 2020 2020 2020  DISABLED).      
-000101b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000101c0: 616c 2873 6572 7669 6365 735b 305d 2e63  al(services[0].c
-000101d0: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
-000101e0: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-000101f0: 4354 4956 4529 0a20 2020 2020 2020 2073  CTIVE).        s
-00010200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010210: 7365 7276 6963 6573 5b31 5d2e 6e61 6d65  services[1].name
-00010220: 2c20 2773 7663 3227 290a 2020 2020 2020  , 'svc2').      
-00010230: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010240: 616c 2873 6572 7669 6365 735b 315d 2e73  al(services[1].s
-00010250: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
-00010260: 6572 7669 6365 5374 6172 7475 702e 454e  erviceStartup.EN
-00010270: 4142 4c45 4429 0a20 2020 2020 2020 2073  ABLED).        s
-00010280: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010290: 7365 7276 6963 6573 5b31 5d2e 6375 7272  services[1].curr
-000102a0: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
-000102b0: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
-000102c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000102d0: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
-000102e0: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
-000102f0: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
-00010300: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00010310: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00010320: 2020 2020 2020 2020 2263 7572 7265 6e74          "current
-00010330: 223a 2022 6163 7469 7665 222c 0a20 2020  ": "active",.   
-00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010350: 2022 6e61 6d65 223a 2022 7376 6332 222c   "name": "svc2",
-00010360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010370: 2020 2020 2022 7374 6172 7475 7022 3a20       "startup": 
-00010380: 2265 6e61 626c 6564 220a 2020 2020 2020  "enabled".      
-00010390: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000103a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000103b0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
-000103c0: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
-000103d0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-000103e0: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-000103f0: 2020 2022 7479 7065 223a 2022 7379 6e63     "type": "sync
-00010400: 220a 2020 2020 2020 2020 7d29 0a20 2020  ".        }).   
-00010410: 2020 2020 2073 6572 7669 6365 7320 3d20       services = 
-00010420: 7365 6c66 2e63 6c69 656e 742e 6765 745f  self.client.get_
-00010430: 7365 7276 6963 6573 285b 2773 7663 3227  services(['svc2'
-00010440: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00010450: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-00010460: 7365 7276 6963 6573 292c 2031 290a 2020  services), 1).  
-00010470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010480: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
-00010490: 305d 2e6e 616d 652c 2027 7376 6332 2729  0].name, 'svc2')
-000104a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000104b0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-000104c0: 6573 5b30 5d2e 7374 6172 7475 702c 2070  es[0].startup, p
-000104d0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-000104e0: 7274 7570 2e45 4e41 424c 4544 290a 2020  rtup.ENABLED).  
-000104f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010500: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
-00010510: 305d 2e63 7572 7265 6e74 2c20 7065 6262  0].current, pebb
-00010520: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
-00010530: 2e41 4354 4956 4529 0a0a 2020 2020 2020  .ACTIVE)..      
-00010540: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010550: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00010560: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00010570: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-00010580: 2f76 312f 7365 7276 6963 6573 272c 207b  /v1/services', {
-00010590: 276e 616d 6573 273a 2027 7376 6331 2c73  'names': 'svc1,s
-000105a0: 7663 3227 7d2c 204e 6f6e 6529 2c0a 2020  vc2'}, None),.  
-000105b0: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-000105c0: 2c20 272f 7631 2f73 6572 7669 6365 7327  , '/v1/services'
-000105d0: 2c20 7b27 6e61 6d65 7327 3a20 2773 7663  , {'names': 'svc
-000105e0: 3227 7d2c 204e 6f6e 6529 2c0a 2020 2020  2'}, None),.    
-000105f0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-00010600: 7465 7374 5f70 756c 6c5f 626f 756e 6461  test_pull_bounda
-00010610: 7279 5f73 7061 6e6e 696e 675f 6368 756e  ry_spanning_chun
-00010620: 6b28 7365 6c66 293a 0a20 2020 2020 2020  k(self):.       
-00010630: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-00010640: 706f 6e73 6573 2e61 7070 656e 6428 280a  ponses.append((.
-00010650: 2020 2020 2020 2020 2020 2020 7b27 436f              {'Co
-00010660: 6e74 656e 742d 5479 7065 273a 2027 6d75  ntent-Type': 'mu
-00010670: 6c74 6970 6172 742f 666f 726d 2d64 6174  ltipart/form-dat
-00010680: 613b 2062 6f75 6e64 6172 793d 3031 3233  a; boundary=0123
-00010690: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-000106a0: 3031 3233 3435 3637 3839 3031 277d 2c0a  012345678901'},.
-000106b0: 2020 2020 2020 2020 2020 2020 6222 2222              b"""
-000106c0: 5c0a 2d2d 3031 3233 3435 3637 3839 3031  \.--012345678901
-000106d0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-000106e0: 3839 3031 5c72 0a43 6f6e 7465 6e74 2d44  8901\r.Content-D
-000106f0: 6973 706f 7369 7469 6f6e 3a20 666f 726d  isposition: form
-00010700: 2d64 6174 613b 206e 616d 653d 2266 696c  -data; name="fil
-00010710: 6573 223b 2066 696c 656e 616d 653d 222f  es"; filename="/
-00010720: 6574 632f 686f 7374 7322 5c72 0a5c 720a  etc/hosts"\r.\r.
-00010730: 3132 372e 302e 302e 3120 6c6f 6361 6c68  127.0.0.1 localh
-00010740: 6f73 7420 2023 205c 7866 305c 7839 665c  ost  # \xf0\x9f\
-00010750: 7839 385c 7838 305c 6e66 6f6f 5c72 5c6e  x98\x80\nfoo\r\n
-00010760: 6261 725c 720a 2d2d 3031 3233 3435 3637  bar\r.--01234567
-00010770: 3839 3031 3233 3435 3637 3839 3031 3233  8901234567890123
-00010780: 3435 3637 3839 3031 5c72 0a43 6f6e 7465  45678901\r.Conte
-00010790: 6e74 2d44 6973 706f 7369 7469 6f6e 3a20  nt-Disposition: 
-000107a0: 666f 726d 2d64 6174 613b 206e 616d 653d  form-data; name=
-000107b0: 2272 6573 706f 6e73 6522 5c72 0a5c 720a  "response"\r.\r.
-000107c0: 7b0a 2020 2020 2272 6573 756c 7422 3a20  {.    "result": 
-000107d0: 5b7b 2270 6174 6822 3a20 222f 6574 632f  [{"path": "/etc/
-000107e0: 686f 7374 7322 7d5d 2c0a 2020 2020 2273  hosts"}],.    "s
-000107f0: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
-00010800: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
-00010810: 2032 3030 2c0a 2020 2020 2274 7970 6522   200,.    "type"
-00010820: 3a20 2273 796e 6322 0a7d 5c72 0a2d 2d30  : "sync".}\r.--0
-00010830: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
-00010840: 3738 3930 3132 3334 3536 3738 3930 312d  789012345678901-
-00010850: 2d5c 720a 2222 222c 0a20 2020 2020 2020  -\r.""",.       
-00010860: 2029 290a 0a20 2020 2020 2020 2073 656c   ))..        sel
-00010870: 662e 636c 6965 6e74 2e5f 6368 756e 6b5f  f.client._chunk_
-00010880: 7369 7a65 203d 2031 330a 2020 2020 2020  size = 13.      
-00010890: 2020 7769 7468 2073 656c 662e 636c 6965    with self.clie
-000108a0: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
-000108b0: 7374 7327 2920 6173 2069 6e66 696c 653a  sts') as infile:
-000108c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-000108d0: 7465 6e74 203d 2069 6e66 696c 652e 7265  tent = infile.re
-000108e0: 6164 2829 0a20 2020 2020 2020 2073 656c  ad().        sel
-000108f0: 662e 6173 7365 7274 4571 7561 6c28 636f  f.assertEqual(co
-00010900: 6e74 656e 742c 2027 3132 372e 302e 302e  ntent, '127.0.0.
-00010910: 3120 6c6f 6361 6c68 6f73 7420 2023 20f0  1 localhost  # .
-00010920: 9f98 805c 6e66 6f6f 5c72 5c6e 6261 7227  ...\nfoo\r\nbar'
-00010930: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00010940: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00010950: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-00010960: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00010970: 2827 4745 5427 2c20 272f 7631 2f66 696c  ('GET', '/v1/fil
-00010980: 6573 272c 207b 2761 6374 696f 6e27 3a20  es', {'action': 
-00010990: 2772 6561 6427 2c20 2770 6174 6827 3a20  'read', 'path': 
-000109a0: 272f 6574 632f 686f 7374 7327 7d2c 0a20  '/etc/hosts'},. 
-000109b0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-000109c0: 2741 6363 6570 7427 3a20 276d 756c 7469  'Accept': 'multi
-000109d0: 7061 7274 2f66 6f72 6d2d 6461 7461 277d  part/form-data'}
-000109e0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-000109f0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-00010a00: 745f 7075 6c6c 5f74 6578 7428 7365 6c66  t_pull_text(self
-00010a10: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00010a20: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
-00010a30: 2e61 7070 656e 6428 280a 2020 2020 2020  .append((.      
-00010a40: 2020 2020 2020 7b27 436f 6e74 656e 742d        {'Content-
-00010a50: 5479 7065 273a 2027 6d75 6c74 6970 6172  Type': 'multipar
-00010a60: 742f 666f 726d 2d64 6174 613b 2062 6f75  t/form-data; bou
-00010a70: 6e64 6172 793d 3031 3233 3435 3637 3839  ndary=0123456789
-00010a80: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-00010a90: 3637 3839 3031 277d 2c0a 2020 2020 2020  678901'},.      
-00010aa0: 2020 2020 2020 6222 2222 5c0a 2d2d 3031        b"""\.--01
-00010ab0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00010ac0: 3839 3031 3233 3435 3637 3839 3031 5c72  89012345678901\r
-00010ad0: 0a43 6f6e 7465 6e74 2d44 6973 706f 7369  .Content-Disposi
-00010ae0: 7469 6f6e 3a20 666f 726d 2d64 6174 613b  tion: form-data;
-00010af0: 206e 616d 653d 2266 696c 6573 223b 2066   name="files"; f
-00010b00: 696c 656e 616d 653d 222f 6574 632f 686f  ilename="/etc/ho
-00010b10: 7374 7322 5c72 0a5c 720a 3132 372e 302e  sts"\r.\r.127.0.
-00010b20: 302e 3120 6c6f 6361 6c68 6f73 7420 2023  0.1 localhost  #
-00010b30: 205c 7866 305c 7839 665c 7839 385c 7838   \xf0\x9f\x98\x8
-00010b40: 305c 6e66 6f6f 5c72 5c6e 6261 725c 720a  0\nfoo\r\nbar\r.
-00010b50: 2d2d 3031 3233 3435 3637 3839 3031 3233  --01234567890123
-00010b60: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-00010b70: 3031 5c72 0a43 6f6e 7465 6e74 2d44 6973  01\r.Content-Dis
-00010b80: 706f 7369 7469 6f6e 3a20 666f 726d 2d64  position: form-d
-00010b90: 6174 613b 206e 616d 653d 2272 6573 706f  ata; name="respo
-00010ba0: 6e73 6522 5c72 0a5c 720a 7b0a 2020 2020  nse"\r.\r.{.    
-00010bb0: 2272 6573 756c 7422 3a20 5b7b 2270 6174  "result": [{"pat
-00010bc0: 6822 3a20 222f 6574 632f 686f 7374 7322  h": "/etc/hosts"
-00010bd0: 7d5d 2c0a 2020 2020 2273 7461 7475 7322  }],.    "status"
-00010be0: 3a20 224f 4b22 2c0a 2020 2020 2273 7461  : "OK",.    "sta
-00010bf0: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
-00010c00: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-00010c10: 6322 0a7d 5c72 0a2d 2d30 3132 3334 3536  c".}\r.--0123456
-00010c20: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
-00010c30: 3334 3536 3738 3930 312d 2d5c 720a 2222  345678901--\r.""
-00010c40: 222c 0a20 2020 2020 2020 2029 290a 0a20  ",.        )).. 
-00010c50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00010c60: 2e63 6c69 656e 742e 7075 6c6c 2827 2f65  .client.pull('/e
-00010c70: 7463 2f68 6f73 7473 2729 2061 7320 696e  tc/hosts') as in
-00010c80: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00010c90: 2020 636f 6e74 656e 7420 3d20 696e 6669    content = infi
-00010ca0: 6c65 2e72 6561 6428 290a 2020 2020 2020  le.read().      
-00010cb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010cc0: 616c 2863 6f6e 7465 6e74 2c20 2731 3237  al(content, '127
-00010cd0: 2e30 2e30 2e31 206c 6f63 616c 686f 7374  .0.0.1 localhost
-00010ce0: 2020 2320 f09f 9880 5c6e 666f 6f5c 725c    # ....\nfoo\r\
-00010cf0: 6e62 6172 2729 0a0a 2020 2020 2020 2020  nbar')..        
-00010d00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00010d10: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-00010d20: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00010d30: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
-00010d40: 312f 6669 6c65 7327 2c20 7b27 6163 7469  1/files', {'acti
-00010d50: 6f6e 273a 2027 7265 6164 272c 2027 7061  on': 'read', 'pa
-00010d60: 7468 273a 2027 2f65 7463 2f68 6f73 7473  th': '/etc/hosts
-00010d70: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00010d80: 2020 2020 7b27 4163 6365 7074 273a 2027      {'Accept': '
-00010d90: 6d75 6c74 6970 6172 742f 666f 726d 2d64  multipart/form-d
-00010da0: 6174 6127 7d2c 204e 6f6e 6529 2c0a 2020  ata'}, None),.  
-00010db0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-00010dc0: 6620 7465 7374 5f70 756c 6c5f 6269 6e61  f test_pull_bina
-00010dd0: 7279 2873 656c 6629 3a0a 2020 2020 2020  ry(self):.      
-00010de0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-00010df0: 7370 6f6e 7365 732e 6170 7065 6e64 2828  sponses.append((
-00010e00: 0a20 2020 2020 2020 2020 2020 207b 2743  .            {'C
-00010e10: 6f6e 7465 6e74 2d54 7970 6527 3a20 276d  ontent-Type': 'm
-00010e20: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
-00010e30: 7461 3b20 626f 756e 6461 7279 3d30 3132  ta; boundary=012
-00010e40: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
-00010e50: 3930 3132 3334 3536 3738 3930 3127 7d2c  9012345678901'},
-00010e60: 0a20 2020 2020 2020 2020 2020 2062 2222  .            b""
-00010e70: 225c 0a2d 2d30 3132 3334 3536 3738 3930  "\.--01234567890
-00010e80: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
-00010e90: 3738 3930 315c 720a 436f 6e74 656e 742d  78901\r.Content-
-00010ea0: 4469 7370 6f73 6974 696f 6e3a 2066 6f72  Disposition: for
-00010eb0: 6d2d 6461 7461 3b20 6e61 6d65 3d22 6669  m-data; name="fi
-00010ec0: 6c65 7322 3b20 6669 6c65 6e61 6d65 3d22  les"; filename="
-00010ed0: 2f65 7463 2f68 6f73 7473 225c 720a 5c72  /etc/hosts"\r.\r
-00010ee0: 0a31 3237 2e30 2e30 2e31 206c 6f63 616c  .127.0.0.1 local
-00010ef0: 686f 7374 2020 2320 5c78 6630 5c78 3966  host  # \xf0\x9f
-00010f00: 5c78 3938 5c78 3830 5c6e 666f 6f5c 725c  \x98\x80\nfoo\r\
-00010f10: 6e62 6172 5c72 0a2d 2d30 3132 3334 3536  nbar\r.--0123456
-00010f20: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
-00010f30: 3334 3536 3738 3930 315c 720a 436f 6e74  345678901\r.Cont
-00010f40: 656e 742d 4469 7370 6f73 6974 696f 6e3a  ent-Disposition:
-00010f50: 2066 6f72 6d2d 6461 7461 3b20 6e61 6d65   form-data; name
-00010f60: 3d22 7265 7370 6f6e 7365 225c 720a 5c72  ="response"\r.\r
-00010f70: 0a7b 0a20 2020 2022 7265 7375 6c74 223a  .{.    "result":
-00010f80: 205b 7b22 7061 7468 223a 2022 2f65 7463   [{"path": "/etc
-00010f90: 2f68 6f73 7473 227d 5d2c 0a20 2020 2022  /hosts"}],.    "
-00010fa0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-00010fb0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-00010fc0: 3a20 3230 302c 0a20 2020 2022 7479 7065  : 200,.    "type
-00010fd0: 223a 2022 7379 6e63 220a 7d5c 720a 2d2d  ": "sync".}\r.--
-00010fe0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-00010ff0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-00011000: 2d2d 5c72 0a22 2222 2c0a 2020 2020 2020  --\r.""",.      
-00011010: 2020 2929 0a0a 2020 2020 2020 2020 7769    ))..        wi
-00011020: 7468 2073 656c 662e 636c 6965 6e74 2e70  th self.client.p
-00011030: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
-00011040: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
-00011050: 2061 7320 696e 6669 6c65 3a0a 2020 2020   as infile:.    
-00011060: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-00011070: 3d20 696e 6669 6c65 2e72 6561 6428 290a  = infile.read().
-00011080: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011090: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
-000110a0: 2c20 6227 3132 372e 302e 302e 3120 6c6f  , b'127.0.0.1 lo
-000110b0: 6361 6c68 6f73 7420 2023 205c 7866 305c  calhost  # \xf0\
-000110c0: 7839 665c 7839 385c 7838 305c 6e66 6f6f  x9f\x98\x80\nfoo
-000110d0: 5c72 5c6e 6261 7227 290a 0a20 2020 2020  \r\nbar')..     
-000110e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000110f0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-00011100: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-00011110: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-00011120: 272f 7631 2f66 696c 6573 272c 207b 2761  '/v1/files', {'a
-00011130: 6374 696f 6e27 3a20 2772 6561 6427 2c20  ction': 'read', 
-00011140: 2770 6174 6827 3a20 272f 6574 632f 686f  'path': '/etc/ho
-00011150: 7374 7327 7d2c 0a20 2020 2020 2020 2020  sts'},.         
-00011160: 2020 2020 2020 207b 2741 6363 6570 7427         {'Accept'
-00011170: 3a20 276d 756c 7469 7061 7274 2f66 6f72  : 'multipart/for
-00011180: 6d2d 6461 7461 277d 2c20 4e6f 6e65 292c  m-data'}, None),
-00011190: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-000111a0: 2064 6566 2074 6573 745f 7075 6c6c 5f70   def test_pull_p
-000111b0: 6174 685f 6572 726f 7228 7365 6c66 293a  ath_error(self):
-000111c0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-000111d0: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-000111e0: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
-000111f0: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
-00011200: 7065 273a 2027 6d75 6c74 6970 6172 742f  pe': 'multipart/
-00011210: 666f 726d 2d64 6174 613b 2062 6f75 6e64  form-data; bound
-00011220: 6172 793d 3031 3233 3435 3637 3839 3031  ary=012345678901
-00011230: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00011240: 3839 3031 277d 2c0a 2020 2020 2020 2020  8901'},.        
-00011250: 2020 2020 6222 2222 5c0a 2d2d 3031 3233      b"""\.--0123
-00011260: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-00011270: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
-00011280: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
-00011290: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
-000112a0: 616d 653d 2272 6573 706f 6e73 6522 5c72  ame="response"\r
-000112b0: 0a5c 720a 7b0a 2020 2020 2272 6573 756c  .\r.{.    "resul
-000112c0: 7422 3a20 5b0a 2020 2020 2020 2020 7b22  t": [.        {"
-000112d0: 7061 7468 223a 2022 2f65 7463 2f68 6f73  path": "/etc/hos
-000112e0: 7473 222c 2022 6572 726f 7222 3a20 7b22  ts", "error": {"
-000112f0: 6b69 6e64 223a 2022 6e6f 742d 666f 756e  kind": "not-foun
-00011300: 6422 2c20 226d 6573 7361 6765 223a 2022  d", "message": "
-00011310: 6e6f 7420 666f 756e 6422 7d7d 0a20 2020  not found"}}.   
-00011320: 205d 2c0a 2020 2020 2273 7461 7475 7322   ],.    "status"
-00011330: 3a20 224f 4b22 2c0a 2020 2020 2273 7461  : "OK",.    "sta
-00011340: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
-00011350: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-00011360: 6322 0a7d 5c72 0a2d 2d30 3132 3334 3536  c".}\r.--0123456
-00011370: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
-00011380: 3334 3536 3738 3930 312d 2d5c 720a 2222  345678901--\r.""
-00011390: 222c 0a20 2020 2020 2020 2029 290a 0a20  ",.        )).. 
-000113a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000113b0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-000113c0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
-000113d0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-000113e0: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
-000113f0: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
-00011400: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011410: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-00011420: 636d 2e65 7863 6570 7469 6f6e 2c20 7065  cm.exception, pe
-00011430: 6262 6c65 2e45 7272 6f72 290a 2020 2020  bble.Error).    
-00011440: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011450: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-00011460: 6e2e 6b69 6e64 2c20 276e 6f74 2d66 6f75  n.kind, 'not-fou
-00011470: 6e64 2729 0a20 2020 2020 2020 2073 656c  nd').        sel
-00011480: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-00011490: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
-000114a0: 6765 2c20 276e 6f74 2066 6f75 6e64 2729  ge, 'not found')
-000114b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-000114c0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-000114d0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
-000114e0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-000114f0: 2747 4554 272c 2027 2f76 312f 6669 6c65  'GET', '/v1/file
-00011500: 7327 2c20 7b27 6163 7469 6f6e 273a 2027  s', {'action': '
-00011510: 7265 6164 272c 2027 7061 7468 273a 2027  read', 'path': '
-00011520: 2f65 7463 2f68 6f73 7473 277d 2c0a 2020  /etc/hosts'},.  
-00011530: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-00011540: 4163 6365 7074 273a 2027 6d75 6c74 6970  Accept': 'multip
-00011550: 6172 742f 666f 726d 2d64 6174 6127 7d2c  art/form-data'},
-00011560: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-00011570: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00011580: 5f70 756c 6c5f 7072 6f74 6f63 6f6c 5f65  _pull_protocol_e
-00011590: 7272 6f72 7328 7365 6c66 293a 0a20 2020  rrors(self):.   
-000115a0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-000115b0: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-000115c0: 6428 287b 2743 6f6e 7465 6e74 2d54 7970  d(({'Content-Typ
-000115d0: 6527 3a20 2763 7427 7d2c 2062 2727 2929  e': 'ct'}, b''))
-000115e0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-000115f0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00011600: 7065 6262 6c65 2e50 726f 746f 636f 6c45  pebble.ProtocolE
-00011610: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00011620: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-00011630: 6965 6e74 2e70 756c 6c28 272f 6574 632f  ient.pull('/etc/
-00011640: 686f 7374 7327 290a 2020 2020 2020 2020  hosts').        
-00011650: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-00011660: 7461 6e63 6528 636d 2e65 7863 6570 7469  tance(cm.excepti
-00011670: 6f6e 2c20 7065 6262 6c65 2e45 7272 6f72  on, pebble.Error
-00011680: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011690: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
-000116a0: 6d2e 6578 6365 7074 696f 6e29 2c0a 2020  m.exception),.  
-000116b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116c0: 2020 2020 2020 2022 6578 7065 6374 6564         "expected
-000116d0: 2043 6f6e 7465 6e74 2d54 7970 6520 276d   Content-Type 'm
-000116e0: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
-000116f0: 7461 272c 2067 6f74 2027 6374 2722 290a  ta', got 'ct'").
-00011700: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00011710: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00011720: 7070 656e 6428 287b 2743 6f6e 7465 6e74  ppend(({'Content
-00011730: 2d54 7970 6527 3a20 276d 756c 7469 7061  -Type': 'multipa
-00011740: 7274 2f66 6f72 6d2d 6461 7461 277d 2c20  rt/form-data'}, 
-00011750: 6227 2729 290a 2020 2020 2020 2020 7769  b'')).        wi
-00011760: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00011770: 6973 6573 2870 6562 626c 652e 5072 6f74  ises(pebble.Prot
-00011780: 6f63 6f6c 4572 726f 7229 2061 7320 636d  ocolError) as cm
-00011790: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000117a0: 6c66 2e63 6c69 656e 742e 7075 6c6c 2827  lf.client.pull('
-000117b0: 2f65 7463 2f68 6f73 7473 2729 0a20 2020  /etc/hosts').   
-000117c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000117d0: 4571 7561 6c28 7374 7228 636d 2e65 7863  Equal(str(cm.exc
-000117e0: 6570 7469 6f6e 292c 2022 696e 7661 6c69  eption), "invali
-000117f0: 6420 626f 756e 6461 7279 2027 2722 290a  d boundary ''").
-00011800: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00011810: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00011820: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
-00011830: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
-00011840: 7065 273a 2027 6d75 6c74 6970 6172 742f  pe': 'multipart/
-00011850: 666f 726d 2d64 6174 613b 2062 6f75 6e64  form-data; bound
-00011860: 6172 793d 3031 3233 3435 3637 3839 3031  ary=012345678901
-00011870: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00011880: 3839 3031 277d 2c0a 2020 2020 2020 2020  8901'},.        
-00011890: 2020 2020 6222 2222 5c0a 2d2d 3031 3233      b"""\.--0123
-000118a0: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-000118b0: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
-000118c0: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
-000118d0: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
-000118e0: 616d 653d 2266 696c 6573 223b 2066 696c  ame="files"; fil
-000118f0: 656e 616d 653d 222f 6261 6422 5c72 0a5c  ename="/bad"\r.\
-00011900: 720a 6261 6420 7061 7468 5c72 0a2d 2d30  r.bad path\r.--0
-00011910: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
-00011920: 3738 3930 3132 3334 3536 3738 3930 315c  789012345678901\
-00011930: 720a 436f 6e74 656e 742d 4469 7370 6f73  r.Content-Dispos
-00011940: 6974 696f 6e3a 2066 6f72 6d2d 6461 7461  ition: form-data
-00011950: 3b20 6e61 6d65 3d22 7265 7370 6f6e 7365  ; name="response
-00011960: 225c 720a 5c72 0a7b 0a20 2020 2022 7265  "\r.\r.{.    "re
-00011970: 7375 6c74 223a 205b 7b22 7061 7468 223a  sult": [{"path":
-00011980: 2022 2f65 7463 2f68 6f73 7473 227d 5d2c   "/etc/hosts"}],
-00011990: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
-000119a0: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
-000119b0: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
-000119c0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-000119d0: 7d5c 720a 2d2d 3031 3233 3435 3637 3839  }\r.--0123456789
-000119e0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-000119f0: 3637 3839 3031 2d2d 5c72 0a22 2222 2c0a  678901--\r.""",.
-00011a00: 2020 2020 2020 2020 2929 0a20 2020 2020          )).     
-00011a10: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00011a20: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-00011a30: 2e50 726f 746f 636f 6c45 7272 6f72 2920  .ProtocolError) 
-00011a40: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00011a50: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
-00011a60: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
-00011a70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011a80: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
-00011a90: 6d2e 6578 6365 7074 696f 6e29 2c20 2270  m.exception), "p
-00011aa0: 6174 6820 6e6f 7420 6578 7065 6374 6564  ath not expected
-00011ab0: 3a20 272f 6261 6427 2229 0a0a 2020 2020  : '/bad'")..    
-00011ac0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00011ad0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-00011ae0: 2828 0a20 2020 2020 2020 2020 2020 207b  ((.            {
-00011af0: 2743 6f6e 7465 6e74 2d54 7970 6527 3a20  'Content-Type': 
-00011b00: 276d 756c 7469 7061 7274 2f66 6f72 6d2d  'multipart/form-
-00011b10: 6461 7461 3b20 626f 756e 6461 7279 3d30  data; boundary=0
-00011b20: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
-00011b30: 3738 3930 3132 3334 3536 3738 3930 3127  789012345678901'
-00011b40: 7d2c 0a20 2020 2020 2020 2020 2020 2062  },.            b
-00011b50: 2222 225c 0a2d 2d30 3132 3334 3536 3738  """\.--012345678
-00011b60: 3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234
-00011b70: 3536 3738 3930 315c 720a 436f 6e74 656e  5678901\r.Conten
-00011b80: 742d 4469 7370 6f73 6974 696f 6e3a 2066  t-Disposition: f
-00011b90: 6f72 6d2d 6461 7461 3b20 6e61 6d65 3d22  orm-data; name="
-00011ba0: 6669 6c65 7322 3b20 6669 6c65 6e61 6d65  files"; filename
-00011bb0: 3d22 2f65 7463 2f68 6f73 7473 225c 720a  ="/etc/hosts"\r.
-00011bc0: 5c72 0a62 6164 2070 6174 685c 720a 2d2d  \r.bad path\r.--
-00011bd0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-00011be0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-00011bf0: 2d2d 5c72 0a22 2222 2c0a 2020 2020 2020  --\r.""",.      
-00011c00: 2020 2929 0a20 2020 2020 2020 2077 6974    )).        wit
-00011c10: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00011c20: 7365 7328 7065 6262 6c65 2e50 726f 746f  ses(pebble.Proto
-00011c30: 636f 6c45 7272 6f72 2920 6173 2063 6d3a  colError) as cm:
-00011c40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00011c50: 662e 636c 6965 6e74 2e70 756c 6c28 272f  f.client.pull('/
-00011c60: 6574 632f 686f 7374 7327 290a 2020 2020  etc/hosts').    
-00011c70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011c80: 7175 616c 2873 7472 2863 6d2e 6578 6365  qual(str(cm.exce
-00011c90: 7074 696f 6e29 2c20 276e 6f20 2272 6573  ption), 'no "res
-00011ca0: 706f 6e73 6522 2066 6965 6c64 2069 6e20  ponse" field in 
-00011cb0: 6d75 6c74 6970 6172 7420 626f 6479 2729  multipart body')
-00011cc0: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-00011cd0: 7573 685f 7374 7228 7365 6c66 293a 0a20  ush_str(self):. 
-00011ce0: 2020 2020 2020 2073 656c 662e 5f74 6573         self._tes
-00011cf0: 745f 7075 7368 5f73 7472 2827 636f 6e74  t_push_str('cont
-00011d00: 656e 7420 f09f 9880 5c6e 666f 6f5c 725c  ent ....\nfoo\r\
-00011d10: 6e62 6172 2729 0a0a 2020 2020 6465 6620  nbar')..    def 
-00011d20: 7465 7374 5f70 7573 685f 7465 7874 2873  test_push_text(s
-00011d30: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00011d40: 6c66 2e5f 7465 7374 5f70 7573 685f 7374  lf._test_push_st
-00011d50: 7228 696f 2e53 7472 696e 6749 4f28 2763  r(io.StringIO('c
-00011d60: 6f6e 7465 6e74 20f0 9f98 805c 6e66 6f6f  ontent ....\nfoo
-00011d70: 5c72 5c6e 6261 7227 2929 0a0a 2020 2020  \r\nbar'))..    
-00011d80: 6465 6620 5f74 6573 745f 7075 7368 5f73  def _test_push_s
-00011d90: 7472 2873 656c 662c 2073 6f75 7263 6529  tr(self, source)
-00011da0: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
-00011db0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
-00011dc0: 6170 7065 6e64 2828 0a20 2020 2020 2020  append((.       
-00011dd0: 2020 2020 207b 2743 6f6e 7465 6e74 2d54       {'Content-T
-00011de0: 7970 6527 3a20 2761 7070 6c69 6361 7469  ype': 'applicati
-00011df0: 6f6e 2f6a 736f 6e27 7d2c 0a20 2020 2020  on/json'},.     
-00011e00: 2020 2020 2020 2062 2222 220a 7b0a 2020         b""".{.  
-00011e10: 2020 2272 6573 756c 7422 3a20 5b0a 2020    "result": [.  
-00011e20: 2020 2020 2020 7b22 7061 7468 223a 2022        {"path": "
-00011e30: 2f66 6f6f 2f62 6172 227d 0a20 2020 205d  /foo/bar"}.    ]
-00011e40: 2c0a 2020 2020 2273 7461 7475 7322 3a20  ,.    "status": 
-00011e50: 224f 4b22 2c0a 2020 2020 2273 7461 7475  "OK",.    "statu
-00011e60: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
-00011e70: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-00011e80: 0a7d 0a22 2222 2c0a 2020 2020 2020 2020  .}.""",.        
-00011e90: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-00011ea0: 2e63 6c69 656e 742e 7075 7368 2827 2f66  .client.push('/f
-00011eb0: 6f6f 2f62 6172 272c 2073 6f75 7263 6529  oo/bar', source)
-00011ec0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00011ed0: 7373 6572 7445 7175 616c 286c 656e 2873  ssertEqual(len(s
-00011ee0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00011ef0: 7374 7329 2c20 3129 0a20 2020 2020 2020  sts), 1).       
-00011f00: 2072 6571 7565 7374 203d 2073 656c 662e   request = self.
-00011f10: 636c 6965 6e74 2e72 6571 7565 7374 735b  client.requests[
-00011f20: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-00011f30: 6173 7365 7274 4571 7561 6c28 7265 7175  assertEqual(requ
-00011f40: 6573 745b 3a33 5d2c 2028 2750 4f53 5427  est[:3], ('POST'
-00011f50: 2c20 272f 7631 2f66 696c 6573 272c 204e  , '/v1/files', N
-00011f60: 6f6e 6529 290a 0a20 2020 2020 2020 2068  one))..        h
-00011f70: 6561 6465 7273 2c20 626f 6479 203d 2072  eaders, body = r
-00011f80: 6571 7565 7374 5b33 3a5d 0a0a 2020 2020  equest[3:]..    
-00011f90: 2020 2020 636f 6e74 656e 745f 7479 7065      content_type
-00011fa0: 203d 2068 6561 6465 7273 5b27 436f 6e74   = headers['Cont
-00011fb0: 656e 742d 5479 7065 275d 0a20 2020 2020  ent-Type'].     
-00011fc0: 2020 2072 6571 2c20 6669 6c65 6e61 6d65     req, filename
-00011fd0: 2c20 636f 6e74 656e 7420 3d20 7365 6c66  , content = self
-00011fe0: 2e5f 7061 7273 655f 7772 6974 655f 6d75  ._parse_write_mu
-00011ff0: 6c74 6970 6172 7428 636f 6e74 656e 745f  ltipart(content_
-00012000: 7479 7065 2c20 626f 6479 290a 2020 2020  type, body).    
-00012010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00012020: 7175 616c 2866 696c 656e 616d 652c 2027  qual(filename, '
-00012030: 2f66 6f6f 2f62 6172 2729 0a20 2020 2020  /foo/bar').     
-00012040: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00012050: 7561 6c28 636f 6e74 656e 742c 2062 2763  ual(content, b'c
-00012060: 6f6e 7465 6e74 205c 7866 305c 7839 665c  ontent \xf0\x9f\
-00012070: 7839 385c 7838 305c 6e66 6f6f 5c72 5c6e  x98\x80\nfoo\r\n
-00012080: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
-00012090: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-000120a0: 6571 2c20 7b0a 2020 2020 2020 2020 2020  eq, {.          
-000120b0: 2020 2761 6374 696f 6e27 3a20 2777 7269    'action': 'wri
-000120c0: 7465 272c 0a20 2020 2020 2020 2020 2020  te',.           
-000120d0: 2027 6669 6c65 7327 3a20 5b7b 2770 6174   'files': [{'pat
-000120e0: 6827 3a20 272f 666f 6f2f 6261 7227 7d5d  h': '/foo/bar'}]
-000120f0: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
-00012100: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
-00012110: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
-00012120: 2020 2020 2073 656c 662e 5f74 6573 745f       self._test_
-00012130: 7075 7368 5f62 7974 6573 2862 2763 6f6e  push_bytes(b'con
-00012140: 7465 6e74 205c 7866 305c 7839 665c 7839  tent \xf0\x9f\x9
-00012150: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
-00012160: 7227 290a 0a20 2020 2064 6566 2074 6573  r')..    def tes
-00012170: 745f 7075 7368 5f62 696e 6172 7928 7365  t_push_binary(se
-00012180: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00012190: 662e 5f74 6573 745f 7075 7368 5f62 7974  f._test_push_byt
-000121a0: 6573 2869 6f2e 4279 7465 7349 4f28 6227  es(io.BytesIO(b'
-000121b0: 636f 6e74 656e 7420 5c78 6630 5c78 3966  content \xf0\x9f
-000121c0: 5c78 3938 5c78 3830 5c6e 666f 6f5c 725c  \x98\x80\nfoo\r\
-000121d0: 6e62 6172 2729 290a 0a20 2020 2064 6566  nbar'))..    def
-000121e0: 205f 7465 7374 5f70 7573 685f 6279 7465   _test_push_byte
-000121f0: 7328 7365 6c66 2c20 736f 7572 6365 293a  s(self, source):
-00012200: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00012210: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00012220: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
-00012230: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
-00012240: 7065 273a 2027 6170 706c 6963 6174 696f  pe': 'applicatio
-00012250: 6e2f 6a73 6f6e 277d 2c0a 2020 2020 2020  n/json'},.      
-00012260: 2020 2020 2020 6222 2222 0a7b 0a20 2020        b""".{.   
-00012270: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
-00012280: 2020 2020 207b 2270 6174 6822 3a20 222f       {"path": "/
-00012290: 666f 6f2f 6261 7222 7d0a 2020 2020 5d2c  foo/bar"}.    ],
-000122a0: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
-000122b0: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
-000122c0: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
-000122d0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-000122e0: 7d0a 2222 222c 0a20 2020 2020 2020 2029  }.""",.        )
-000122f0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00012300: 636c 6965 6e74 2e70 7573 6828 272f 666f  client.push('/fo
-00012310: 6f2f 6261 7227 2c20 736f 7572 6365 290a  o/bar', source).
-00012320: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00012330: 7365 7274 4571 7561 6c28 6c65 6e28 7365  sertEqual(len(se
-00012340: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-00012350: 7473 292c 2031 290a 2020 2020 2020 2020  ts), 1).        
-00012360: 7265 7175 6573 7420 3d20 7365 6c66 2e63  request = self.c
-00012370: 6c69 656e 742e 7265 7175 6573 7473 5b30  lient.requests[0
-00012380: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00012390: 7373 6572 7445 7175 616c 2872 6571 7565  ssertEqual(reque
-000123a0: 7374 5b3a 335d 2c20 2827 504f 5354 272c  st[:3], ('POST',
-000123b0: 2027 2f76 312f 6669 6c65 7327 2c20 4e6f   '/v1/files', No
-000123c0: 6e65 2929 0a0a 2020 2020 2020 2020 6865  ne))..        he
-000123d0: 6164 6572 732c 2062 6f64 7920 3d20 7265  aders, body = re
-000123e0: 7175 6573 745b 333a 5d0a 2020 2020 2020  quest[3:].      
-000123f0: 2020 636f 6e74 656e 745f 7479 7065 203d    content_type =
-00012400: 2068 6561 6465 7273 5b27 436f 6e74 656e   headers['Conten
-00012410: 742d 5479 7065 275d 0a20 2020 2020 2020  t-Type'].       
-00012420: 2072 6571 2c20 6669 6c65 6e61 6d65 2c20   req, filename, 
-00012430: 636f 6e74 656e 7420 3d20 7365 6c66 2e5f  content = self._
-00012440: 7061 7273 655f 7772 6974 655f 6d75 6c74  parse_write_mult
-00012450: 6970 6172 7428 636f 6e74 656e 745f 7479  ipart(content_ty
-00012460: 7065 2c20 626f 6479 290a 2020 2020 2020  pe, body).      
-00012470: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00012480: 616c 2866 696c 656e 616d 652c 2027 2f66  al(filename, '/f
-00012490: 6f6f 2f62 6172 2729 0a20 2020 2020 2020  oo/bar').       
-000124a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000124b0: 6c28 636f 6e74 656e 742c 2062 2763 6f6e  l(content, b'con
-000124c0: 7465 6e74 205c 7866 305c 7839 665c 7839  tent \xf0\x9f\x9
-000124d0: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
-000124e0: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
-000124f0: 2e61 7373 6572 7445 7175 616c 2872 6571  .assertEqual(req
-00012500: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
-00012510: 2761 6374 696f 6e27 3a20 2777 7269 7465  'action': 'write
-00012520: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00012530: 6669 6c65 7327 3a20 5b7b 2770 6174 6827  files': [{'path'
-00012540: 3a20 272f 666f 6f2f 6261 7227 7d5d 2c0a  : '/foo/bar'}],.
-00012550: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-00012560: 6465 6620 7465 7374 5f70 7573 685f 616c  def test_push_al
-00012570: 6c5f 6f70 7469 6f6e 7328 7365 6c66 293a  l_options(self):
-00012580: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00012590: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-000125a0: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
-000125b0: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
-000125c0: 7065 273a 2027 6170 706c 6963 6174 696f  pe': 'applicatio
-000125d0: 6e2f 6a73 6f6e 277d 2c0a 2020 2020 2020  n/json'},.      
-000125e0: 2020 2020 2020 6222 2222 0a7b 0a20 2020        b""".{.   
-000125f0: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
-00012600: 2020 2020 207b 2270 6174 6822 3a20 222f       {"path": "/
-00012610: 666f 6f2f 6261 7222 7d0a 2020 2020 5d2c  foo/bar"}.    ],
-00012620: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
-00012630: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
-00012640: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
-00012650: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-00012660: 7d0a 2222 222c 0a20 2020 2020 2020 2029  }.""",.        )
-00012670: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00012680: 636c 6965 6e74 2e70 7573 6828 272f 666f  client.push('/fo
-00012690: 6f2f 6261 7227 2c20 2763 6f6e 7465 6e74  o/bar', 'content
-000126a0: 272c 206d 616b 655f 6469 7273 3d54 7275  ', make_dirs=Tru
-000126b0: 652c 2070 6572 6d69 7373 696f 6e73 3d30  e, permissions=0
-000126c0: 6f36 3030 2c0a 2020 2020 2020 2020 2020  o600,.          
-000126d0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000126e0: 7365 725f 6964 3d31 322c 2075 7365 723d  ser_id=12, user=
-000126f0: 2762 6f62 272c 2067 726f 7570 5f69 643d  'bob', group_id=
-00012700: 3334 2c20 6772 6f75 703d 2773 7461 6666  34, group='staff
-00012710: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00012720: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00012730: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-00012740: 7565 7374 7329 2c20 3129 0a20 2020 2020  uests), 1).     
-00012750: 2020 2072 6571 7565 7374 203d 2073 656c     request = sel
-00012760: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-00012770: 735b 305d 0a20 2020 2020 2020 2073 656c  s[0].        sel
-00012780: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-00012790: 7175 6573 745b 3a33 5d2c 2028 2750 4f53  quest[:3], ('POS
-000127a0: 5427 2c20 272f 7631 2f66 696c 6573 272c  T', '/v1/files',
-000127b0: 204e 6f6e 6529 290a 0a20 2020 2020 2020   None))..       
-000127c0: 2068 6561 6465 7273 2c20 626f 6479 203d   headers, body =
-000127d0: 2072 6571 7565 7374 5b33 3a5d 0a20 2020   request[3:].   
-000127e0: 2020 2020 2063 6f6e 7465 6e74 5f74 7970       content_typ
-000127f0: 6520 3d20 6865 6164 6572 735b 2743 6f6e  e = headers['Con
-00012800: 7465 6e74 2d54 7970 6527 5d0a 2020 2020  tent-Type'].    
-00012810: 2020 2020 7265 712c 2066 696c 656e 616d      req, filenam
-00012820: 652c 2063 6f6e 7465 6e74 203d 2073 656c  e, content = sel
-00012830: 662e 5f70 6172 7365 5f77 7269 7465 5f6d  f._parse_write_m
-00012840: 756c 7469 7061 7274 2863 6f6e 7465 6e74  ultipart(content
-00012850: 5f74 7970 652c 2062 6f64 7929 0a20 2020  _type, body).   
-00012860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00012870: 4571 7561 6c28 6669 6c65 6e61 6d65 2c20  Equal(filename, 
-00012880: 272f 666f 6f2f 6261 7227 290a 2020 2020  '/foo/bar').    
-00012890: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000128a0: 7175 616c 2863 6f6e 7465 6e74 2c20 6227  qual(content, b'
-000128b0: 636f 6e74 656e 7427 290a 2020 2020 2020  content').      
-000128c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000128d0: 616c 2872 6571 2c20 7b0a 2020 2020 2020  al(req, {.      
-000128e0: 2020 2020 2020 2761 6374 696f 6e27 3a20        'action': 
-000128f0: 2777 7269 7465 272c 0a20 2020 2020 2020  'write',.       
-00012900: 2020 2020 2027 6669 6c65 7327 3a20 5b7b       'files': [{
-00012910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012920: 2027 7061 7468 273a 2027 2f66 6f6f 2f62   'path': '/foo/b
-00012930: 6172 272c 0a20 2020 2020 2020 2020 2020  ar',.           
-00012940: 2020 2020 2027 6d61 6b65 2d64 6972 7327       'make-dirs'
-00012950: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
-00012960: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
-00012970: 696f 6e73 273a 2027 3630 3027 2c0a 2020  ions': '600',.  
-00012980: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00012990: 7365 722d 6964 273a 2031 322c 0a20 2020  ser-id': 12,.   
-000129a0: 2020 2020 2020 2020 2020 2020 2027 7573               'us
-000129b0: 6572 273a 2027 626f 6227 2c0a 2020 2020  er': 'bob',.    
-000129c0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
-000129d0: 7570 2d69 6427 3a20 3334 2c0a 2020 2020  up-id': 34,.    
-000129e0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
-000129f0: 7570 273a 2027 7374 6166 6627 2c0a 2020  up': 'staff',.  
-00012a00: 2020 2020 2020 2020 2020 7d5d 2c0a 2020            }],.  
-00012a10: 2020 2020 2020 7d29 0a0a 2020 2020 6465        })..    de
-00012a20: 6620 7465 7374 5f70 7573 685f 7569 645f  f test_push_uid_
-00012a30: 6769 6428 7365 6c66 293a 0a20 2020 2020  gid(self):.     
-00012a40: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-00012a50: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-00012a60: 280a 2020 2020 2020 2020 2020 2020 7b27  (.            {'
-00012a70: 436f 6e74 656e 742d 5479 7065 273a 2027  Content-Type': '
-00012a80: 6170 706c 6963 6174 696f 6e2f 6a73 6f6e  application/json
-00012a90: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00012aa0: 6222 2222 0a7b 0a20 2020 2022 7265 7375  b""".{.    "resu
-00012ab0: 6c74 223a 205b 0a20 2020 2020 2020 207b  lt": [.        {
-00012ac0: 2270 6174 6822 3a20 222f 666f 6f2f 6261  "path": "/foo/ba
-00012ad0: 7222 7d0a 2020 2020 5d2c 0a20 2020 2022  r"}.    ],.    "
-00012ae0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-00012af0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-00012b00: 3a20 3230 302c 0a20 2020 2022 7479 7065  : 200,.    "type
-00012b10: 223a 2022 7379 6e63 220a 7d0a 2222 222c  ": "sync".}.""",
-00012b20: 0a20 2020 2020 2020 2029 290a 0a20 2020  .        ))..   
-00012b30: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00012b40: 2e70 7573 6828 272f 666f 6f2f 6261 7227  .push('/foo/bar'
-00012b50: 2c20 2763 6f6e 7465 6e74 272c 2075 7365  , 'content', use
-00012b60: 725f 6964 3d31 322c 2067 726f 7570 5f69  r_id=12, group_i
-00012b70: 643d 3334 290a 0a20 2020 2020 2020 2073  d=34)..        s
-00012b80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012b90: 6c65 6e28 7365 6c66 2e63 6c69 656e 742e  len(self.client.
-00012ba0: 7265 7175 6573 7473 292c 2031 290a 2020  requests), 1).  
-00012bb0: 2020 2020 2020 7265 7175 6573 7420 3d20        request = 
-00012bc0: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-00012bd0: 6573 7473 5b30 5d0a 2020 2020 2020 2020  ests[0].        
-00012be0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00012bf0: 2872 6571 7565 7374 5b3a 335d 2c20 2827  (request[:3], ('
-00012c00: 504f 5354 272c 2027 2f76 312f 6669 6c65  POST', '/v1/file
-00012c10: 7327 2c20 4e6f 6e65 2929 0a0a 2020 2020  s', None))..    
-00012c20: 2020 2020 6865 6164 6572 732c 2062 6f64      headers, bod
-00012c30: 7920 3d20 7265 7175 6573 745b 333a 5d0a  y = request[3:].
-00012c40: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
-00012c50: 7479 7065 203d 2068 6561 6465 7273 5b27  type = headers['
-00012c60: 436f 6e74 656e 742d 5479 7065 275d 0a20  Content-Type']. 
-00012c70: 2020 2020 2020 2072 6571 2c20 6669 6c65         req, file
-00012c80: 6e61 6d65 2c20 636f 6e74 656e 7420 3d20  name, content = 
-00012c90: 7365 6c66 2e5f 7061 7273 655f 7772 6974  self._parse_writ
-00012ca0: 655f 6d75 6c74 6970 6172 7428 636f 6e74  e_multipart(cont
-00012cb0: 656e 745f 7479 7065 2c20 626f 6479 290a  ent_type, body).
-00012cc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00012cd0: 6572 7445 7175 616c 2866 696c 656e 616d  ertEqual(filenam
-00012ce0: 652c 2027 2f66 6f6f 2f62 6172 2729 0a20  e, '/foo/bar'). 
-00012cf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00012d00: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
-00012d10: 2062 2763 6f6e 7465 6e74 2729 0a20 2020   b'content').   
-00012d20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00012d30: 4571 7561 6c28 7265 712c 207b 0a20 2020  Equal(req, {.   
-00012d40: 2020 2020 2020 2020 2027 6163 7469 6f6e           'action
-00012d50: 273a 2027 7772 6974 6527 2c0a 2020 2020  ': 'write',.    
-00012d60: 2020 2020 2020 2020 2766 696c 6573 273a          'files':
-00012d70: 205b 7b0a 2020 2020 2020 2020 2020 2020   [{.            
-00012d80: 2020 2020 2770 6174 6827 3a20 272f 666f      'path': '/fo
-00012d90: 6f2f 6261 7227 2c0a 2020 2020 2020 2020  o/bar',.        
-00012da0: 2020 2020 2020 2020 2775 7365 722d 6964          'user-id
-00012db0: 273a 2031 322c 0a20 2020 2020 2020 2020  ': 12,.         
-00012dc0: 2020 2020 2020 2027 6772 6f75 702d 6964         'group-id
-00012dd0: 273a 2033 342c 0a20 2020 2020 2020 2020  ': 34,.         
-00012de0: 2020 207d 5d2c 0a20 2020 2020 2020 207d     }],.        }
-00012df0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00012e00: 7075 7368 5f70 6174 685f 6572 726f 7228  push_path_error(
-00012e10: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00012e20: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-00012e30: 6e73 6573 2e61 7070 656e 6428 280a 2020  nses.append((.  
-00012e40: 2020 2020 2020 2020 2020 7b27 436f 6e74            {'Cont
-00012e50: 656e 742d 5479 7065 273a 2027 6170 706c  ent-Type': 'appl
-00012e60: 6963 6174 696f 6e2f 6a73 6f6e 277d 2c0a  ication/json'},.
-00012e70: 2020 2020 2020 2020 2020 2020 6222 2222              b"""
-00012e80: 0a7b 0a20 2020 2022 7265 7375 6c74 223a  .{.    "result":
-00012e90: 205b 0a20 2020 2020 2020 207b 2270 6174   [.        {"pat
-00012ea0: 6822 3a20 222f 666f 6f2f 6261 7222 2c20  h": "/foo/bar", 
-00012eb0: 2265 7272 6f72 223a 207b 226b 696e 6422  "error": {"kind"
-00012ec0: 3a20 226e 6f74 2d66 6f75 6e64 222c 2022  : "not-found", "
-00012ed0: 6d65 7373 6167 6522 3a20 226e 6f74 2066  message": "not f
-00012ee0: 6f75 6e64 227d 7d0a 2020 2020 5d2c 0a20  ound"}}.    ],. 
-00012ef0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-00012f00: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
-00012f10: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
-00012f20: 7479 7065 223a 2022 7379 6e63 220a 7d0a  type": "sync".}.
-00012f30: 2222 222c 0a20 2020 2020 2020 2029 290a  """,.        )).
-00012f40: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00012f50: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00012f60: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
-00012f70: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00012f80: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00012f90: 2e70 7573 6828 272f 666f 6f2f 6261 7227  .push('/foo/bar'
-00012fa0: 2c20 2763 6f6e 7465 6e74 2729 0a20 2020  , 'content').   
-00012fb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00012fc0: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
-00012fd0: 6f6e 2e6b 696e 642c 2027 6e6f 742d 666f  on.kind, 'not-fo
-00012fe0: 756e 6427 290a 2020 2020 2020 2020 7365  und').        se
-00012ff0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00013000: 6d2e 6578 6365 7074 696f 6e2e 6d65 7373  m.exception.mess
-00013010: 6167 652c 2027 6e6f 7420 666f 756e 6427  age, 'not found'
-00013020: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00013030: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-00013040: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-00013050: 6573 7473 292c 2031 290a 2020 2020 2020  ests), 1).      
-00013060: 2020 7265 7175 6573 7420 3d20 7365 6c66    request = self
-00013070: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-00013080: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-00013090: 2e61 7373 6572 7445 7175 616c 2872 6571  .assertEqual(req
-000130a0: 7565 7374 5b3a 335d 2c20 2827 504f 5354  uest[:3], ('POST
-000130b0: 272c 2027 2f76 312f 6669 6c65 7327 2c20  ', '/v1/files', 
-000130c0: 4e6f 6e65 2929 0a0a 2020 2020 2020 2020  None))..        
-000130d0: 6865 6164 6572 732c 2062 6f64 7920 3d20  headers, body = 
-000130e0: 7265 7175 6573 745b 333a 5d0a 2020 2020  request[3:].    
-000130f0: 2020 2020 636f 6e74 656e 745f 7479 7065      content_type
-00013100: 203d 2068 6561 6465 7273 5b27 436f 6e74   = headers['Cont
-00013110: 656e 742d 5479 7065 275d 0a20 2020 2020  ent-Type'].     
-00013120: 2020 2072 6571 2c20 6669 6c65 6e61 6d65     req, filename
-00013130: 2c20 636f 6e74 656e 7420 3d20 7365 6c66  , content = self
-00013140: 2e5f 7061 7273 655f 7772 6974 655f 6d75  ._parse_write_mu
-00013150: 6c74 6970 6172 7428 636f 6e74 656e 745f  ltipart(content_
-00013160: 7479 7065 2c20 626f 6479 290a 2020 2020  type, body).    
-00013170: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013180: 7175 616c 2866 696c 656e 616d 652c 2027  qual(filename, '
-00013190: 2f66 6f6f 2f62 6172 2729 0a20 2020 2020  /foo/bar').     
-000131a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000131b0: 7561 6c28 636f 6e74 656e 742c 2062 2763  ual(content, b'c
-000131c0: 6f6e 7465 6e74 2729 0a20 2020 2020 2020  ontent').       
-000131d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000131e0: 6c28 7265 712c 207b 0a20 2020 2020 2020  l(req, {.       
-000131f0: 2020 2020 2027 6163 7469 6f6e 273a 2027       'action': '
-00013200: 7772 6974 6527 2c0a 2020 2020 2020 2020  write',.        
-00013210: 2020 2020 2766 696c 6573 273a 205b 7b27      'files': [{'
-00013220: 7061 7468 273a 2027 2f66 6f6f 2f62 6172  path': '/foo/bar
-00013230: 277d 5d2c 0a20 2020 2020 2020 207d 290a  '}],.        }).
-00013240: 0a20 2020 2064 6566 205f 7061 7273 655f  .    def _parse_
-00013250: 7772 6974 655f 6d75 6c74 6970 6172 7428  write_multipart(
-00013260: 7365 6c66 2c20 636f 6e74 656e 745f 7479  self, content_ty
-00013270: 7065 2c20 626f 6479 293a 0a20 2020 2020  pe, body):.     
-00013280: 2020 2063 7479 7065 2c20 6f70 7469 6f6e     ctype, option
-00013290: 7320 3d20 6367 692e 7061 7273 655f 6865  s = cgi.parse_he
-000132a0: 6164 6572 2863 6f6e 7465 6e74 5f74 7970  ader(content_typ
-000132b0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-000132c0: 6173 7365 7274 4571 7561 6c28 6374 7970  assertEqual(ctyp
-000132d0: 652c 2027 6d75 6c74 6970 6172 742f 666f  e, 'multipart/fo
-000132e0: 726d 2d64 6174 6127 290a 2020 2020 2020  rm-data').      
-000132f0: 2020 626f 756e 6461 7279 203d 206f 7074    boundary = opt
-00013300: 696f 6e73 5b27 626f 756e 6461 7279 275d  ions['boundary']
-00013310: 0a0a 2020 2020 2020 2020 2320 5765 2068  ..        # We h
-00013320: 6176 6520 746f 206d 616e 7561 6c6c 7920  ave to manually 
-00013330: 7772 6974 6520 7468 6520 436f 6e74 656e  write the Conten
-00013340: 742d 5479 7065 2077 6974 6820 626f 756e  t-Type with boun
-00013350: 6461 7279 2c20 6265 6361 7573 650a 2020  dary, because.  
-00013360: 2020 2020 2020 2320 656d 6169 6c2e 7061        # email.pa
-00013370: 7273 6572 2065 7870 6563 7473 2074 6865  rser expects the
-00013380: 2065 6e74 6972 6520 6d75 6c74 6970 6172   entire multipar
-00013390: 7420 6d65 7373 6167 6520 7769 7468 2068  t message with h
-000133a0: 6561 6465 7273 2e0a 2020 2020 2020 2020  eaders..        
-000133b0: 7061 7273 6572 203d 2065 6d61 696c 2e70  parser = email.p
-000133c0: 6172 7365 722e 4279 7465 7346 6565 6450  arser.BytesFeedP
-000133d0: 6172 7365 7228 290a 2020 2020 2020 2020  arser().        
-000133e0: 7061 7273 6572 2e66 6565 6428 6227 436f  parser.feed(b'Co
-000133f0: 6e74 656e 742d 5479 7065 3a20 6d75 6c74  ntent-Type: mult
-00013400: 6970 6172 742f 666f 726d 2d64 6174 613b  ipart/form-data;
-00013410: 2062 6f75 6e64 6172 793d 270a 2020 2020   boundary='.    
-00013420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013430: 2b20 626f 756e 6461 7279 2e65 6e63 6f64  + boundary.encod
-00013440: 6528 2775 7466 2d38 2729 202b 2062 275c  e('utf-8') + b'\
-00013450: 725c 6e5c 725c 6e27 290a 2020 2020 2020  r\n\r\n').      
-00013460: 2020 666f 7220 6220 696e 2062 6f64 793a    for b in body:
-00013470: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-00013480: 6974 6820 7468 6520 226d 656d 6f72 7920  ith the "memory 
-00013490: 6566 6669 6369 656e 7420 7075 7368 2220  efficient push" 
-000134a0: 6368 616e 6765 732c 2062 6f64 7920 6973  changes, body is
-000134b0: 2061 6e20 6974 6572 6162 6c65 2e0a 2020   an iterable..  
-000134c0: 2020 2020 2020 2020 2020 7061 7273 6572            parser
-000134d0: 2e66 6565 6428 6229 0a20 2020 2020 2020  .feed(b).       
-000134e0: 206d 6573 7361 6765 203d 2070 6172 7365   message = parse
-000134f0: 722e 636c 6f73 6528 290a 0a20 2020 2020  r.close()..     
-00013500: 2020 2072 6571 203d 204e 6f6e 650a 2020     req = None.  
-00013510: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
-00013520: 204e 6f6e 650a 2020 2020 2020 2020 636f   None.        co
-00013530: 6e74 656e 7420 3d20 4e6f 6e65 0a20 2020  ntent = None.   
-00013540: 2020 2020 2066 6f72 2070 6172 7420 696e       for part in
-00013550: 206d 6573 7361 6765 2e77 616c 6b28 293a   message.walk():
-00013560: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00013570: 6520 3d20 7061 7274 2e67 6574 5f70 6172  e = part.get_par
-00013580: 616d 2827 6e61 6d65 272c 2068 6561 6465  am('name', heade
-00013590: 723d 2743 6f6e 7465 6e74 2d44 6973 706f  r='Content-Dispo
-000135a0: 7369 7469 6f6e 2729 0a20 2020 2020 2020  sition').       
-000135b0: 2020 2020 2069 6620 6e61 6d65 203d 3d20       if name == 
-000135c0: 2772 6571 7565 7374 273a 0a20 2020 2020  'request':.     
-000135d0: 2020 2020 2020 2020 2020 2072 6571 203d             req =
-000135e0: 206a 736f 6e2e 6c6f 6164 7328 7061 7274   json.loads(part
-000135f0: 2e67 6574 5f70 6179 6c6f 6164 2829 290a  .get_payload()).
-00013600: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00013610: 206e 616d 6520 3d3d 2027 6669 6c65 7327   name == 'files'
-00013620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013630: 2020 2320 6465 636f 6465 3d54 7275 652c    # decode=True,
-00013640: 2069 726f 6e69 6361 6c6c 792c 2061 766f   ironically, avo
-00013650: 6964 7320 6465 636f 6469 6e67 2062 7974  ids decoding byt
-00013660: 6573 2074 6f20 7374 720a 2020 2020 2020  es to str.      
-00013670: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
-00013680: 7420 3d20 7061 7274 2e67 6574 5f70 6179  t = part.get_pay
-00013690: 6c6f 6164 2864 6563 6f64 653d 5472 7565  load(decode=True
-000136a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000136b0: 2020 6669 6c65 6e61 6d65 203d 2070 6172    filename = par
-000136c0: 742e 6765 745f 6669 6c65 6e61 6d65 2829  t.get_filename()
-000136d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000136e0: 2872 6571 2c20 6669 6c65 6e61 6d65 2c20  (req, filename, 
-000136f0: 636f 6e74 656e 7429 0a0a 2020 2020 6465  content)..    de
-00013700: 6620 7465 7374 5f6c 6973 745f 6669 6c65  f test_list_file
-00013710: 735f 7061 7468 2873 656c 6629 3a0a 2020  s_path(self):.  
-00013720: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00013730: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-00013740: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
-00013750: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
-00013760: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00013770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013780: 2020 2027 7061 7468 273a 2027 2f65 7463     'path': '/etc
-00013790: 2f68 6f73 7473 272c 0a20 2020 2020 2020  /hosts',.       
-000137a0: 2020 2020 2020 2020 2020 2020 2027 6e61               'na
-000137b0: 6d65 273a 2027 686f 7374 7327 2c0a 2020  me': 'hosts',.  
-000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137d0: 2020 2774 7970 6527 3a20 2766 696c 6527    'type': 'file'
-000137e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000137f0: 2020 2020 2020 2773 697a 6527 3a20 3132        'size': 12
-00013800: 332c 0a20 2020 2020 2020 2020 2020 2020  3,.             
-00013810: 2020 2020 2020 2027 7065 726d 6973 7369         'permissi
-00013820: 6f6e 7327 3a20 2736 3434 272c 0a20 2020  ons': '644',.   
-00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013840: 2027 6c61 7374 2d6d 6f64 6966 6965 6427   'last-modified'
-00013850: 3a20 2732 3032 312d 3031 2d32 3854 3134  : '2021-01-28T14
-00013860: 3a33 373a 3034 2e32 3931 3531 3737 3638  :37:04.291517768
-00013870: 2b31 333a 3030 272c 0a20 2020 2020 2020  +13:00',.       
-00013880: 2020 2020 2020 2020 2020 2020 2027 7573               'us
-00013890: 6572 2d69 6427 3a20 3132 2c0a 2020 2020  er-id': 12,.    
-000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138b0: 2775 7365 7227 3a20 2762 6f62 272c 0a20  'user': 'bob',. 
-000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138d0: 2020 2027 6772 6f75 702d 6964 273a 2033     'group-id': 3
-000138e0: 342c 0a20 2020 2020 2020 2020 2020 2020  4,.             
-000138f0: 2020 2020 2020 2027 6772 6f75 7027 3a20         'group': 
-00013900: 2773 7461 6666 272c 0a20 2020 2020 2020  'staff',.       
-00013910: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00013920: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00013930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013940: 2020 2770 6174 6827 3a20 272f 6574 632f    'path': '/etc/
-00013950: 6e67 696e 7827 2c0a 2020 2020 2020 2020  nginx',.        
-00013960: 2020 2020 2020 2020 2020 2020 276e 616d              'nam
-00013970: 6527 3a20 276e 6769 6e78 272c 0a20 2020  e': 'nginx',.   
-00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013990: 2027 7479 7065 273a 2027 6469 7265 6374   'type': 'direct
-000139a0: 6f72 7927 2c0a 2020 2020 2020 2020 2020  ory',.          
-000139b0: 2020 2020 2020 2020 2020 2770 6572 6d69            'permi
-000139c0: 7373 696f 6e73 273a 2027 3735 3527 2c0a  ssions': '755',.
-000139d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139e0: 2020 2020 276c 6173 742d 6d6f 6469 6669      'last-modifi
-000139f0: 6564 273a 2027 3230 3230 2d30 312d 3031  ed': '2020-01-01
-00013a00: 5430 313a 3031 3a30 312e 3030 3030 3030  T01:01:01.000000
-00013a10: 2b31 333a 3030 272c 0a20 2020 2020 2020  +13:00',.       
-00013a20: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00013a30: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00013a40: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
-00013a50: 2027 4f4b 272c 0a20 2020 2020 2020 2020   'OK',.         
-00013a60: 2020 2027 7374 6174 7573 2d63 6f64 6527     'status-code'
-00013a70: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-00013a80: 2020 2027 7479 7065 273a 2027 7379 6e63     'type': 'sync
-00013a90: 272c 0a20 2020 2020 2020 207d 290a 2020  ',.        }).  
-00013aa0: 2020 2020 2020 696e 666f 7320 3d20 7365        infos = se
-00013ab0: 6c66 2e63 6c69 656e 742e 6c69 7374 5f66  lf.client.list_f
-00013ac0: 696c 6573 2827 2f65 7463 2729 0a0a 2020  iles('/etc')..  
-00013ad0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013ae0: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
-00013af0: 292c 2032 290a 2020 2020 2020 2020 7365  ), 2).        se
-00013b00: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-00013b10: 6e66 6f73 5b30 5d2e 7061 7468 2c20 272f  nfos[0].path, '/
-00013b20: 6574 632f 686f 7374 7327 290a 2020 2020  etc/hosts').    
-00013b30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013b40: 7175 616c 2869 6e66 6f73 5b30 5d2e 6e61  qual(infos[0].na
-00013b50: 6d65 2c20 2768 6f73 7473 2729 0a20 2020  me, 'hosts').   
-00013b60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00013b70: 4571 7561 6c28 696e 666f 735b 305d 2e74  Equal(infos[0].t
-00013b80: 7970 652c 2070 6562 626c 652e 4669 6c65  ype, pebble.File
-00013b90: 5479 7065 2e46 494c 4529 0a20 2020 2020  Type.FILE).     
-00013ba0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013bb0: 7561 6c28 696e 666f 735b 305d 2e73 697a  ual(infos[0].siz
-00013bc0: 652c 2031 3233 290a 2020 2020 2020 2020  e, 123).        
-00013bd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013be0: 2869 6e66 6f73 5b30 5d2e 7065 726d 6973  (infos[0].permis
-00013bf0: 7369 6f6e 732c 2030 6f36 3434 290a 2020  sions, 0o644).  
-00013c00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013c10: 7445 7175 616c 2869 6e66 6f73 5b30 5d2e  tEqual(infos[0].
-00013c20: 6c61 7374 5f6d 6f64 6966 6965 642c 2064  last_modified, d
-00013c30: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
-00013c40: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
-00013c50: 2c20 342c 2032 3931 3531 3829 290a 2020  , 4, 291518)).  
-00013c60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013c70: 7445 7175 616c 2869 6e66 6f73 5b30 5d2e  tEqual(infos[0].
-00013c80: 7573 6572 5f69 642c 2031 3229 0a20 2020  user_id, 12).   
-00013c90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00013ca0: 4571 7561 6c28 696e 666f 735b 305d 2e75  Equal(infos[0].u
-00013cb0: 7365 722c 2027 626f 6227 290a 2020 2020  ser, 'bob').    
-00013cc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013cd0: 7175 616c 2869 6e66 6f73 5b30 5d2e 6772  qual(infos[0].gr
-00013ce0: 6f75 705f 6964 2c20 3334 290a 2020 2020  oup_id, 34).    
-00013cf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013d00: 7175 616c 2869 6e66 6f73 5b30 5d2e 6772  qual(infos[0].gr
-00013d10: 6f75 702c 2027 7374 6166 6627 290a 2020  oup, 'staff').  
-00013d20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013d30: 7445 7175 616c 2869 6e66 6f73 5b31 5d2e  tEqual(infos[1].
-00013d40: 7061 7468 2c20 272f 6574 632f 6e67 696e  path, '/etc/ngin
-00013d50: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
-00013d60: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-00013d70: 6f73 5b31 5d2e 6e61 6d65 2c20 276e 6769  os[1].name, 'ngi
-00013d80: 6e78 2729 0a20 2020 2020 2020 2073 656c  nx').        sel
-00013d90: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-00013da0: 666f 735b 315d 2e74 7970 652c 2070 6562  fos[1].type, peb
-00013db0: 626c 652e 4669 6c65 5479 7065 2e44 4952  ble.FileType.DIR
-00013dc0: 4543 544f 5259 290a 2020 2020 2020 2020  ECTORY).        
-00013dd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013de0: 2869 6e66 6f73 5b31 5d2e 7369 7a65 2c20  (infos[1].size, 
-00013df0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
-00013e00: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-00013e10: 6e66 6f73 5b31 5d2e 7065 726d 6973 7369  nfos[1].permissi
-00013e20: 6f6e 732c 2030 6f37 3535 290a 2020 2020  ons, 0o755).    
-00013e30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013e40: 7175 616c 2869 6e66 6f73 5b31 5d2e 6c61  qual(infos[1].la
-00013e50: 7374 5f6d 6f64 6966 6965 642c 2064 6174  st_modified, dat
-00013e60: 6574 696d 655f 6e7a 6474 2832 3032 302c  etime_nzdt(2020,
-00013e70: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-00013e80: 3029 290a 2020 2020 2020 2020 7365 6c66  0)).        self
-00013e90: 2e61 7373 6572 7449 7328 696e 666f 735b  .assertIs(infos[
-00013ea0: 315d 2e75 7365 725f 6964 2c20 4e6f 6e65  1].user_id, None
-00013eb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00013ec0: 7373 6572 7449 7328 696e 666f 735b 315d  ssertIs(infos[1]
-00013ed0: 2e75 7365 722c 204e 6f6e 6529 0a20 2020  .user, None).   
-00013ee0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00013ef0: 4973 2869 6e66 6f73 5b31 5d2e 6772 6f75  Is(infos[1].grou
-00013f00: 705f 6964 2c20 4e6f 6e65 290a 2020 2020  p_id, None).    
-00013f10: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-00013f20: 7328 696e 666f 735b 315d 2e67 726f 7570  s(infos[1].group
-00013f30: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
-00013f40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00013f50: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-00013f60: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-00013f70: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-00013f80: 7631 2f66 696c 6573 272c 207b 2761 6374  v1/files', {'act
-00013f90: 696f 6e27 3a20 276c 6973 7427 2c20 2770  ion': 'list', 'p
-00013fa0: 6174 6827 3a20 272f 6574 6327 7d2c 204e  ath': '/etc'}, N
-00013fb0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-00013fc0: 0a0a 2020 2020 6465 6620 7465 7374 5f6c  ..    def test_l
-00013fd0: 6973 745f 6669 6c65 735f 7061 7474 6572  ist_files_patter
-00013fe0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00013ff0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-00014000: 706f 6e73 6573 2e61 7070 656e 6428 7b0a  ponses.append({.
-00014010: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-00014020: 756c 7422 3a20 5b5d 2c0a 2020 2020 2020  ult": [],.      
-00014030: 2020 2020 2020 2773 7461 7475 7327 3a20        'status': 
-00014040: 274f 4b27 2c0a 2020 2020 2020 2020 2020  'OK',.          
-00014050: 2020 2773 7461 7475 732d 636f 6465 273a    'status-code':
-00014060: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
-00014070: 2020 2774 7970 6527 3a20 2773 796e 6327    'type': 'sync'
-00014080: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
-00014090: 2020 2020 2020 696e 666f 7320 3d20 7365        infos = se
-000140a0: 6c66 2e63 6c69 656e 742e 6c69 7374 5f66  lf.client.list_f
-000140b0: 696c 6573 2827 2f65 7463 272c 2070 6174  iles('/etc', pat
-000140c0: 7465 726e 3d27 2a2e 636f 6e66 2729 0a0a  tern='*.conf')..
-000140d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000140e0: 6572 7445 7175 616c 286c 656e 2869 6e66  ertEqual(len(inf
-000140f0: 6f73 292c 2030 290a 2020 2020 2020 2020  os), 0).        
-00014100: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00014110: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-00014120: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00014130: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
-00014140: 312f 6669 6c65 7327 2c20 7b27 6163 7469  1/files', {'acti
-00014150: 6f6e 273a 2027 6c69 7374 272c 2027 7061  on': 'list', 'pa
-00014160: 7468 273a 2027 2f65 7463 272c 2027 7061  th': '/etc', 'pa
-00014170: 7474 6572 6e27 3a20 272a 2e63 6f6e 6627  ttern': '*.conf'
-00014180: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-00014190: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-000141a0: 7374 5f6c 6973 745f 6669 6c65 735f 6974  st_list_files_it
-000141b0: 7365 6c66 2873 656c 6629 3a0a 2020 2020  self(self):.    
-000141c0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-000141d0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-000141e0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-000141f0: 7265 7375 6c74 223a 205b 5d2c 0a20 2020  result": [],.   
-00014200: 2020 2020 2020 2020 2027 7374 6174 7573           'status
-00014210: 273a 2027 4f4b 272c 0a20 2020 2020 2020  ': 'OK',.       
-00014220: 2020 2020 2027 7374 6174 7573 2d63 6f64       'status-cod
-00014230: 6527 3a20 3230 302c 0a20 2020 2020 2020  e': 200,.       
-00014240: 2020 2020 2027 7479 7065 273a 2027 7379       'type': 'sy
-00014250: 6e63 272c 0a20 2020 2020 2020 207d 290a  nc',.        }).
-00014260: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
-00014270: 2073 656c 662e 636c 6965 6e74 2e6c 6973   self.client.lis
-00014280: 745f 6669 6c65 7328 272f 6574 6327 2c20  t_files('/etc', 
-00014290: 6974 7365 6c66 3d54 7275 6529 0a0a 2020  itself=True)..  
-000142a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000142b0: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
-000142c0: 292c 2030 290a 2020 2020 2020 2020 7365  ), 0).        se
-000142d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000142e0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-000142f0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00014300: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-00014310: 6669 6c65 7327 2c20 7b27 6163 7469 6f6e  files', {'action
-00014320: 273a 2027 6c69 7374 272c 2027 7061 7468  ': 'list', 'path
-00014330: 273a 2027 2f65 7463 272c 2027 6974 7365  ': '/etc', 'itse
-00014340: 6c66 273a 2027 7472 7565 277d 2c20 4e6f  lf': 'true'}, No
-00014350: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-00014360: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
-00014370: 6b65 5f64 6972 5f62 6173 6963 2873 656c  ke_dir_basic(sel
-00014380: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00014390: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-000143a0: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
-000143b0: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
-000143c0: 205b 7b27 7061 7468 273a 2027 2f66 6f6f   [{'path': '/foo
-000143d0: 2f62 6172 277d 5d2c 0a20 2020 2020 2020  /bar'}],.       
-000143e0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
-000143f0: 4f4b 272c 0a20 2020 2020 2020 2020 2020  OK',.           
-00014400: 2027 7374 6174 7573 2d63 6f64 6527 3a20   'status-code': 
-00014410: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-00014420: 2027 7479 7065 273a 2027 7379 6e63 272c   'type': 'sync',
-00014430: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00014440: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00014450: 6d61 6b65 5f64 6972 2827 2f66 6f6f 2f62  make_dir('/foo/b
-00014460: 6172 2729 0a20 2020 2020 2020 2072 6571  ar').        req
-00014470: 203d 207b 2761 6374 696f 6e27 3a20 276d   = {'action': 'm
-00014480: 616b 652d 6469 7273 272c 2027 6469 7273  ake-dirs', 'dirs
-00014490: 273a 205b 7b0a 2020 2020 2020 2020 2020  ': [{.          
-000144a0: 2020 2770 6174 6827 3a20 272f 666f 6f2f    'path': '/foo/
-000144b0: 6261 7227 2c0a 2020 2020 2020 2020 7d5d  bar',.        }]
-000144c0: 7d0a 2020 2020 2020 2020 7365 6c66 2e61  }.        self.a
-000144d0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-000144e0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
-000144f0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-00014500: 2750 4f53 5427 2c20 272f 7631 2f66 696c  'POST', '/v1/fil
-00014510: 6573 272c 204e 6f6e 652c 2072 6571 292c  es', None, req),
-00014520: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-00014530: 2064 6566 2074 6573 745f 6d61 6b65 5f64   def test_make_d
-00014540: 6972 5f61 6c6c 5f6f 7074 696f 6e73 2873  ir_all_options(s
-00014550: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00014560: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-00014570: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
-00014580: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
-00014590: 223a 205b 7b27 7061 7468 273a 2027 2f66  ": [{'path': '/f
-000145a0: 6f6f 2f62 6172 277d 5d2c 0a20 2020 2020  oo/bar'}],.     
-000145b0: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
-000145c0: 2027 4f4b 272c 0a20 2020 2020 2020 2020   'OK',.         
-000145d0: 2020 2027 7374 6174 7573 2d63 6f64 6527     'status-code'
-000145e0: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-000145f0: 2020 2027 7479 7065 273a 2027 7379 6e63     'type': 'sync
-00014600: 272c 0a20 2020 2020 2020 207d 290a 2020  ',.        }).  
-00014610: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00014620: 742e 6d61 6b65 5f64 6972 2827 2f66 6f6f  t.make_dir('/foo
-00014630: 2f62 6172 272c 206d 616b 655f 7061 7265  /bar', make_pare
-00014640: 6e74 733d 5472 7565 2c20 7065 726d 6973  nts=True, permis
-00014650: 7369 6f6e 733d 306f 3630 302c 0a20 2020  sions=0o600,.   
-00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014670: 2020 2020 2020 2020 2020 7573 6572 5f69            user_i
-00014680: 643d 3132 2c20 7573 6572 3d27 626f 6227  d=12, user='bob'
-00014690: 2c20 6772 6f75 705f 6964 3d33 342c 2067  , group_id=34, g
-000146a0: 726f 7570 3d27 7374 6166 6627 290a 0a20  roup='staff').. 
-000146b0: 2020 2020 2020 2072 6571 203d 207b 2761         req = {'a
-000146c0: 6374 696f 6e27 3a20 276d 616b 652d 6469  ction': 'make-di
-000146d0: 7273 272c 2027 6469 7273 273a 205b 7b0a  rs', 'dirs': [{.
-000146e0: 2020 2020 2020 2020 2020 2020 2770 6174              'pat
-000146f0: 6827 3a20 272f 666f 6f2f 6261 7227 2c0a  h': '/foo/bar',.
-00014700: 2020 2020 2020 2020 2020 2020 276d 616b              'mak
-00014710: 652d 7061 7265 6e74 7327 3a20 5472 7565  e-parents': True
-00014720: 2c0a 2020 2020 2020 2020 2020 2020 2770  ,.            'p
-00014730: 6572 6d69 7373 696f 6e73 273a 2027 3630  ermissions': '60
-00014740: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00014750: 2775 7365 722d 6964 273a 2031 322c 0a20  'user-id': 12,. 
-00014760: 2020 2020 2020 2020 2020 2027 7573 6572             'user
-00014770: 273a 2027 626f 6227 2c0a 2020 2020 2020  ': 'bob',.      
-00014780: 2020 2020 2020 2767 726f 7570 2d69 6427        'group-id'
-00014790: 3a20 3334 2c0a 2020 2020 2020 2020 2020  : 34,.          
-000147a0: 2020 2767 726f 7570 273a 2027 7374 6166    'group': 'staf
-000147b0: 6627 2c0a 2020 2020 2020 2020 7d5d 7d0a  f',.        }]}.
-000147c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000147d0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-000147e0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-000147f0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-00014800: 4f53 5427 2c20 272f 7631 2f66 696c 6573  OST', '/v1/files
-00014810: 272c 204e 6f6e 652c 2072 6571 292c 0a20  ', None, req),. 
-00014820: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00014830: 6566 2074 6573 745f 6d61 6b65 5f64 6972  ef test_make_dir
-00014840: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
-00014850: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00014860: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-00014870: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
-00014880: 2022 7265 7375 6c74 223a 205b 7b0a 2020   "result": [{.  
-00014890: 2020 2020 2020 2020 2020 2020 2020 2770                'p
-000148a0: 6174 6827 3a20 272f 666f 6f2f 6261 7227  ath': '/foo/bar'
-000148b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000148c0: 2020 2765 7272 6f72 273a 207b 0a20 2020    'error': {.   
-000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148e0: 2027 6b69 6e64 273a 2027 7065 726d 6973   'kind': 'permis
-000148f0: 7369 6f6e 2d64 656e 6965 6427 2c0a 2020  sion-denied',.  
-00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014910: 2020 276d 6573 7361 6765 273a 2027 7065    'message': 'pe
-00014920: 726d 6973 7369 6f6e 2064 656e 6965 6427  rmission denied'
-00014930: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014940: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-00014950: 207d 5d2c 0a20 2020 2020 2020 2020 2020   }],.           
-00014960: 2027 7374 6174 7573 273a 2027 4f4b 272c   'status': 'OK',
-00014970: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
-00014980: 6174 7573 2d63 6f64 6527 3a20 3230 302c  atus-code': 200,
-00014990: 0a20 2020 2020 2020 2020 2020 2027 7479  .            'ty
-000149a0: 7065 273a 2027 7379 6e63 272c 0a20 2020  pe': 'sync',.   
-000149b0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
-000149c0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000149d0: 5261 6973 6573 2870 6562 626c 652e 5061  Raises(pebble.Pa
-000149e0: 7468 4572 726f 7229 2061 7320 636d 3a0a  thError) as cm:.
-000149f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014a00: 2e63 6c69 656e 742e 6d61 6b65 5f64 6972  .client.make_dir
-00014a10: 2827 2f66 6f6f 2f62 6172 2729 0a20 2020  ('/foo/bar').   
-00014a20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014a30: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
-00014a40: 6365 7074 696f 6e2c 2070 6562 626c 652e  ception, pebble.
-00014a50: 4572 726f 7229 0a20 2020 2020 2020 2073  Error).        s
-00014a60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00014a70: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
-00014a80: 642c 2027 7065 726d 6973 7369 6f6e 2d64  d, 'permission-d
-00014a90: 656e 6965 6427 290a 2020 2020 2020 2020  enied').        
-00014aa0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00014ab0: 2863 6d2e 6578 6365 7074 696f 6e2e 6d65  (cm.exception.me
-00014ac0: 7373 6167 652c 2027 7065 726d 6973 7369  ssage, 'permissi
-00014ad0: 6f6e 2064 656e 6965 6427 290a 0a20 2020  on denied')..   
-00014ae0: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
-00014af0: 5f70 6174 685f 6261 7369 6328 7365 6c66  _path_basic(self
-00014b00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00014b10: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
-00014b20: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
-00014b30: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
-00014b40: 5b7b 2770 6174 6827 3a20 272f 626f 6f2f  [{'path': '/boo/
-00014b50: 6661 7227 7d5d 2c0a 2020 2020 2020 2020  far'}],.        
-00014b60: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
-00014b70: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
-00014b80: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
-00014b90: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00014ba0: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
-00014bb0: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
-00014bc0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-00014bd0: 656d 6f76 655f 7061 7468 2827 2f62 6f6f  emove_path('/boo
-00014be0: 2f66 6172 2729 0a20 2020 2020 2020 2072  /far').        r
-00014bf0: 6571 203d 207b 2761 6374 696f 6e27 3a20  eq = {'action': 
-00014c00: 2772 656d 6f76 6527 2c20 2770 6174 6873  'remove', 'paths
-00014c10: 273a 205b 7b0a 2020 2020 2020 2020 2020  ': [{.          
-00014c20: 2020 2770 6174 6827 3a20 272f 626f 6f2f    'path': '/boo/
-00014c30: 6661 7227 2c0a 2020 2020 2020 2020 7d5d  far',.        }]
-00014c40: 7d0a 2020 2020 2020 2020 7365 6c66 2e61  }.        self.a
-00014c50: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-00014c60: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
-00014c70: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-00014c80: 2750 4f53 5427 2c20 272f 7631 2f66 696c  'POST', '/v1/fil
-00014c90: 6573 272c 204e 6f6e 652c 2072 6571 292c  es', None, req),
-00014ca0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-00014cb0: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
-00014cc0: 5f70 6174 685f 7265 6375 7273 6976 6528  _path_recursive(
-00014cd0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00014ce0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-00014cf0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-00014d00: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-00014d10: 7422 3a20 5b7b 2770 6174 6827 3a20 272f  t": [{'path': '/
-00014d20: 626f 6f2f 6661 7227 7d5d 2c0a 2020 2020  boo/far'}],.    
-00014d30: 2020 2020 2020 2020 2773 7461 7475 7327          'status'
-00014d40: 3a20 274f 4b27 2c0a 2020 2020 2020 2020  : 'OK',.        
-00014d50: 2020 2020 2773 7461 7475 732d 636f 6465      'status-code
-00014d60: 273a 2032 3030 2c0a 2020 2020 2020 2020  ': 200,.        
-00014d70: 2020 2020 2774 7970 6527 3a20 2773 796e      'type': 'syn
-00014d80: 6327 2c0a 2020 2020 2020 2020 7d29 0a20  c',.        }). 
-00014d90: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00014da0: 6e74 2e72 656d 6f76 655f 7061 7468 2827  nt.remove_path('
-00014db0: 2f62 6f6f 2f66 6172 272c 2072 6563 7572  /boo/far', recur
-00014dc0: 7369 7665 3d54 7275 6529 0a0a 2020 2020  sive=True)..    
-00014dd0: 2020 2020 7265 7120 3d20 7b27 6163 7469      req = {'acti
-00014de0: 6f6e 273a 2027 7265 6d6f 7665 272c 2027  on': 'remove', '
-00014df0: 7061 7468 7327 3a20 5b7b 0a20 2020 2020  paths': [{.     
-00014e00: 2020 2020 2020 2027 7061 7468 273a 2027         'path': '
-00014e10: 2f62 6f6f 2f66 6172 272c 0a20 2020 2020  /boo/far',.     
-00014e20: 2020 2020 2020 2027 7265 6375 7273 6976         'recursiv
-00014e30: 6527 3a20 5472 7565 2c0a 2020 2020 2020  e': True,.      
-00014e40: 2020 7d5d 7d0a 2020 2020 2020 2020 7365    }]}.        se
-00014e50: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00014e60: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00014e70: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00014e80: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-00014e90: 2f66 696c 6573 272c 204e 6f6e 652c 2072  /files', None, r
-00014ea0: 6571 292c 0a20 2020 2020 2020 205d 290a  eq),.        ]).
-00014eb0: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
-00014ec0: 6d6f 7665 5f70 6174 685f 6572 726f 7228  move_path_error(
-00014ed0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00014ee0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-00014ef0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-00014f00: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-00014f10: 7422 3a20 5b7b 0a20 2020 2020 2020 2020  t": [{.         
-00014f20: 2020 2020 2020 2027 7061 7468 273a 2027         'path': '
-00014f30: 2f62 6f6f 2f66 6172 272c 0a20 2020 2020  /boo/far',.     
-00014f40: 2020 2020 2020 2020 2020 2027 6572 726f             'erro
-00014f50: 7227 3a20 7b0a 2020 2020 2020 2020 2020  r': {.          
-00014f60: 2020 2020 2020 2020 2020 276b 696e 6427            'kind'
-00014f70: 3a20 2767 656e 6572 6963 2d66 696c 652d  : 'generic-file-
-00014f80: 6572 726f 7227 2c0a 2020 2020 2020 2020  error',.        
-00014f90: 2020 2020 2020 2020 2020 2020 276d 6573              'mes
-00014fa0: 7361 6765 273a 2027 736f 6d65 206f 7468  sage': 'some oth
-00014fb0: 6572 2065 7272 6f72 272c 0a20 2020 2020  er error',.     
-00014fc0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00014fd0: 2020 2020 2020 2020 2020 7d5d 2c0a 2020            }],.  
-00014fe0: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
-00014ff0: 7327 3a20 274f 4b27 2c0a 2020 2020 2020  s': 'OK',.      
-00015000: 2020 2020 2020 2773 7461 7475 732d 636f        'status-co
-00015010: 6465 273a 2032 3030 2c0a 2020 2020 2020  de': 200,.      
-00015020: 2020 2020 2020 2774 7970 6527 3a20 2773        'type': 's
-00015030: 796e 6327 2c0a 2020 2020 2020 2020 7d29  ync',.        })
-00015040: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00015050: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00015060: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
-00015070: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00015080: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00015090: 2e72 656d 6f76 655f 7061 7468 2827 2f62  .remove_path('/b
-000150a0: 6f6f 2f66 6172 2729 0a20 2020 2020 2020  oo/far').       
-000150b0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-000150c0: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
-000150d0: 696f 6e2c 2070 6562 626c 652e 4572 726f  ion, pebble.Erro
-000150e0: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-000150f0: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
-00015100: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
-00015110: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
-00015120: 6f72 2729 0a20 2020 2020 2020 2073 656c  or').        sel
-00015130: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-00015140: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
-00015150: 6765 2c20 2773 6f6d 6520 6f74 6865 7220  ge, 'some other 
-00015160: 6572 726f 7227 290a 0a20 2020 2064 6566  error')..    def
-00015170: 2074 6573 745f 7365 6e64 5f73 6967 6e61   test_send_signa
-00015180: 6c5f 6e61 6d65 2873 656c 6629 3a0a 2020  l_name(self):.  
-00015190: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-000151a0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-000151b0: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
-000151c0: 2027 7265 7375 6c74 273a 2054 7275 652c   'result': True,
-000151d0: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
-000151e0: 6174 7573 273a 2027 4f4b 272c 0a20 2020  atus': 'OK',.   
-000151f0: 2020 2020 2020 2020 2027 7374 6174 7573           'status
-00015200: 2d63 6f64 6527 3a20 3230 302c 0a20 2020  -code': 200,.   
-00015210: 2020 2020 2020 2020 2027 7479 7065 273a           'type':
-00015220: 2027 7379 6e63 272c 0a20 2020 2020 2020   'sync',.       
-00015230: 207d 290a 0a20 2020 2020 2020 2073 656c   })..        sel
-00015240: 662e 636c 6965 6e74 2e73 656e 645f 7369  f.client.send_si
-00015250: 676e 616c 2827 5349 4748 5550 272c 205b  gnal('SIGHUP', [
-00015260: 2773 3127 2c20 2773 3227 5d29 0a0a 2020  's1', 's2'])..  
-00015270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00015280: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-00015290: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-000152a0: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-000152b0: 5427 2c20 272f 7631 2f73 6967 6e61 6c73  T', '/v1/signals
-000152c0: 272c 204e 6f6e 652c 207b 2773 6967 6e61  ', None, {'signa
-000152d0: 6c27 3a20 2753 4947 4855 5027 2c20 2773  l': 'SIGHUP', 's
-000152e0: 6572 7669 6365 7327 3a20 5b27 7331 272c  ervices': ['s1',
-000152f0: 2027 7332 275d 7d29 2c0a 2020 2020 2020   's2']}),.      
-00015300: 2020 5d29 0a0a 2020 2020 4075 6e69 7474    ])..    @unitt
-00015310: 6573 742e 736b 6970 556e 6c65 7373 2868  est.skipUnless(h
-00015320: 6173 6174 7472 2873 6967 6e61 6c2c 2027  asattr(signal, '
-00015330: 5349 4748 5550 2729 2c20 2773 6967 6e61  SIGHUP'), 'signa
-00015340: 6c20 636f 6e73 7461 6e74 7320 6e6f 7420  l constants not 
-00015350: 7072 6573 656e 7427 290a 2020 2020 6465  present').    de
-00015360: 6620 7465 7374 5f73 656e 645f 7369 676e  f test_send_sign
-00015370: 616c 5f6e 756d 6265 7228 7365 6c66 293a  al_number(self):
-00015380: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00015390: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-000153a0: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
-000153b0: 2020 2020 2772 6573 756c 7427 3a20 5472      'result': Tr
-000153c0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000153d0: 2773 7461 7475 7327 3a20 274f 4b27 2c0a  'status': 'OK',.
-000153e0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
-000153f0: 7475 732d 636f 6465 273a 2032 3030 2c0a  tus-code': 200,.
-00015400: 2020 2020 2020 2020 2020 2020 2774 7970              'typ
-00015410: 6527 3a20 2773 796e 6327 2c0a 2020 2020  e': 'sync',.    
-00015420: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
-00015430: 7365 6c66 2e63 6c69 656e 742e 7365 6e64  self.client.send
-00015440: 5f73 6967 6e61 6c28 7369 676e 616c 2e53  _signal(signal.S
-00015450: 4947 4855 502c 205b 2773 3127 2c20 2773  IGHUP, ['s1', 's
-00015460: 3227 5d29 0a0a 2020 2020 2020 2020 7365  2'])..        se
-00015470: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00015480: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00015490: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-000154a0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-000154b0: 2f73 6967 6e61 6c73 272c 204e 6f6e 652c  /signals', None,
-000154c0: 207b 2773 6967 6e61 6c27 3a20 2753 4947   {'signal': 'SIG
-000154d0: 4855 5027 2c20 2773 6572 7669 6365 7327  HUP', 'services'
-000154e0: 3a20 5b27 7331 272c 2027 7332 275d 7d29  : ['s1', 's2']})
-000154f0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00015500: 2020 6465 6620 7465 7374 5f73 656e 645f    def test_send_
-00015510: 7369 676e 616c 5f74 7970 655f 6572 726f  signal_type_erro
-00015520: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00015530: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00015540: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-00015550: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00015560: 7365 6c66 2e63 6c69 656e 742e 7365 6e64  self.client.send
-00015570: 5f73 6967 6e61 6c28 2753 4947 4855 5027  _signal('SIGHUP'
-00015580: 2c20 2773 686f 756c 642d 6265 2d61 2d6c  , 'should-be-a-l
-00015590: 6973 7427 290a 0a20 2020 2020 2020 2077  ist')..        w
-000155a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000155b0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-000155c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000155d0: 6c66 2e63 6c69 656e 742e 7365 6e64 5f73  lf.client.send_s
-000155e0: 6967 6e61 6c28 2753 4947 4855 5027 2c20  ignal('SIGHUP', 
-000155f0: 5b31 2c20 325d 290a 0a20 2020 2064 6566  [1, 2])..    def
-00015600: 2074 6573 745f 6765 745f 6368 6563 6b73   test_get_checks
-00015610: 5f61 6c6c 2873 656c 6629 3a0a 2020 2020  _all(self):.    
-00015620: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00015630: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-00015640: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-00015650: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
-00015660: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015680: 2022 6e61 6d65 223a 2022 6368 6b31 222c   "name": "chk1",
-00015690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000156a0: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-000156b0: 7570 222c 0a20 2020 2020 2020 2020 2020  up",.           
-000156c0: 2020 2020 2020 2020 2022 7468 7265 7368           "thresh
-000156d0: 6f6c 6422 3a20 322c 0a20 2020 2020 2020  old": 2,.       
-000156e0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-000156f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015710: 2020 226e 616d 6522 3a20 2263 686b 3222    "name": "chk2"
-00015720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015730: 2020 2020 2020 226c 6576 656c 223a 2022        "level": "
-00015740: 616c 6976 6522 2c0a 2020 2020 2020 2020  alive",.        
-00015750: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00015760: 7475 7322 3a20 2264 6f77 6e22 2c0a 2020  tus": "down",.  
-00015770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015780: 2020 2266 6169 6c75 7265 7322 3a20 352c    "failures": 5,
-00015790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000157a0: 2020 2020 2022 7468 7265 7368 6f6c 6422       "threshold"
-000157b0: 3a20 332c 0a20 2020 2020 2020 2020 2020  : 3,.           
-000157c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000157d0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-000157e0: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
-000157f0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-00015800: 7461 7475 732d 636f 6465 223a 2032 3030  tatus-code": 200
-00015810: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-00015820: 7970 6522 3a20 2273 796e 6322 0a20 2020  ype": "sync".   
-00015830: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
-00015840: 6368 6563 6b73 203d 2073 656c 662e 636c  checks = self.cl
-00015850: 6965 6e74 2e67 6574 5f63 6865 636b 7328  ient.get_checks(
-00015860: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00015870: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
-00015880: 6865 636b 7329 2c20 3229 0a20 2020 2020  hecks), 2).     
-00015890: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000158a0: 7561 6c28 6368 6563 6b73 5b30 5d2e 6e61  ual(checks[0].na
-000158b0: 6d65 2c20 2763 686b 3127 290a 2020 2020  me, 'chk1').    
-000158c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000158d0: 7175 616c 2863 6865 636b 735b 305d 2e6c  qual(checks[0].l
-000158e0: 6576 656c 2c20 7065 6262 6c65 2e43 6865  evel, pebble.Che
-000158f0: 636b 4c65 7665 6c2e 554e 5345 5429 0a20  ckLevel.UNSET). 
-00015900: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015910: 7274 4571 7561 6c28 6368 6563 6b73 5b30  rtEqual(checks[0
-00015920: 5d2e 7374 6174 7573 2c20 7065 6262 6c65  ].status, pebble
-00015930: 2e43 6865 636b 5374 6174 7573 2e55 5029  .CheckStatus.UP)
-00015940: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00015950: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-00015960: 5b30 5d2e 6661 696c 7572 6573 2c20 3029  [0].failures, 0)
-00015970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00015980: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-00015990: 5b30 5d2e 7468 7265 7368 6f6c 642c 2032  [0].threshold, 2
-000159a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000159b0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-000159c0: 735b 315d 2e6e 616d 652c 2027 6368 6b32  s[1].name, 'chk2
-000159d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000159e0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-000159f0: 6b73 5b31 5d2e 6c65 7665 6c2c 2070 6562  ks[1].level, peb
-00015a00: 626c 652e 4368 6563 6b4c 6576 656c 2e41  ble.CheckLevel.A
-00015a10: 4c49 5645 290a 2020 2020 2020 2020 7365  LIVE).        se
-00015a20: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00015a30: 6865 636b 735b 315d 2e73 7461 7475 732c  hecks[1].status,
-00015a40: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
-00015a50: 7475 732e 444f 574e 290a 2020 2020 2020  tus.DOWN).      
-00015a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015a70: 616c 2863 6865 636b 735b 315d 2e66 6169  al(checks[1].fai
-00015a80: 6c75 7265 732c 2035 290a 2020 2020 2020  lures, 5).      
-00015a90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015aa0: 616c 2863 6865 636b 735b 315d 2e74 6872  al(checks[1].thr
-00015ab0: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
-00015ac0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00015ad0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-00015ae0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00015af0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-00015b00: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
-00015b10: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-00015b20: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-00015b30: 7374 5f67 6574 5f63 6865 636b 735f 6669  st_get_checks_fi
-00015b40: 6c74 6572 7328 7365 6c66 293a 0a20 2020  lters(self):.   
-00015b50: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00015b60: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-00015b70: 6428 7b0a 2020 2020 2020 2020 2020 2020  d({.            
-00015b80: 2272 6573 756c 7422 3a20 5b0a 2020 2020  "result": [.    
-00015b90: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bb0: 2020 226e 616d 6522 3a20 2263 686b 3222    "name": "chk2"
-00015bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015bd0: 2020 2020 2020 226c 6576 656c 223a 2022        "level": "
-00015be0: 7265 6164 7922 2c0a 2020 2020 2020 2020  ready",.        
-00015bf0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00015c00: 7475 7322 3a20 2275 7022 2c0a 2020 2020  tus": "up",.    
-00015c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c20: 2274 6872 6573 686f 6c64 223a 2033 2c0a  "threshold": 3,.
-00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c40: 7d2c 0a20 2020 2020 2020 2020 2020 205d  },.            ]
-00015c50: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-00015c60: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
-00015c70: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00015c80: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
-00015c90: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
-00015ca0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
-00015cb0: 207d 290a 2020 2020 2020 2020 6368 6563   }).        chec
-00015cc0: 6b73 203d 2073 656c 662e 636c 6965 6e74  ks = self.client
-00015cd0: 2e67 6574 5f63 6865 636b 7328 6c65 7665  .get_checks(leve
-00015ce0: 6c3d 7065 6262 6c65 2e43 6865 636b 4c65  l=pebble.CheckLe
-00015cf0: 7665 6c2e 5245 4144 592c 206e 616d 6573  vel.READY, names
-00015d00: 3d5b 2763 686b 3227 5d29 0a20 2020 2020  =['chk2']).     
-00015d10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00015d20: 7561 6c28 6c65 6e28 6368 6563 6b73 292c  ual(len(checks),
-00015d30: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-00015d40: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00015d50: 636b 735b 305d 2e6e 616d 652c 2027 6368  cks[0].name, 'ch
-00015d60: 6b32 2729 0a20 2020 2020 2020 2073 656c  k2').        sel
-00015d70: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00015d80: 6563 6b73 5b30 5d2e 6c65 7665 6c2c 2070  ecks[0].level, p
-00015d90: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
-00015da0: 2e52 4541 4459 290a 2020 2020 2020 2020  .READY).        
-00015db0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015dc0: 2863 6865 636b 735b 305d 2e73 7461 7475  (checks[0].statu
-00015dd0: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
-00015de0: 7461 7475 732e 5550 290a 2020 2020 2020  tatus.UP).      
-00015df0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015e00: 616c 2863 6865 636b 735b 305d 2e66 6169  al(checks[0].fai
-00015e10: 6c75 7265 732c 2030 290a 2020 2020 2020  lures, 0).      
-00015e20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015e30: 616c 2863 6865 636b 735b 305d 2e74 6872  al(checks[0].thr
-00015e40: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
-00015e50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00015e60: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-00015e70: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00015e80: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-00015e90: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
-00015ea0: 276c 6576 656c 273a 2027 7265 6164 7927  'level': 'ready'
-00015eb0: 2c20 276e 616d 6573 273a 205b 2763 686b  , 'names': ['chk
-00015ec0: 3227 5d7d 2c20 4e6f 6e65 292c 0a20 2020  2']}, None),.   
-00015ed0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-00015ee0: 2074 6573 745f 6368 6563 6b6c 6576 656c   test_checklevel
-00015ef0: 5f63 6f6e 7665 7273 696f 6e28 7365 6c66  _conversion(self
-00015f00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00015f10: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
-00015f20: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
-00015f30: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
-00015f40: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00015f50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00015f60: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-00015f70: 2263 686b 3222 2c0a 2020 2020 2020 2020  "chk2",.        
-00015f80: 2020 2020 2020 2020 2020 2020 226c 6576              "lev
-00015f90: 656c 223a 2022 666f 6f62 6172 2122 2c0a  el": "foobar!",.
-00015fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fb0: 2020 2020 2273 7461 7475 7322 3a20 2275      "status": "u
-00015fc0: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
-00015fd0: 2020 2020 2020 2020 2274 6872 6573 686f          "thresho
-00015fe0: 6c64 223a 2033 2c0a 2020 2020 2020 2020  ld": 3,.        
-00015ff0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00016000: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00016010: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-00016020: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
-00016030: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
-00016040: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
-00016050: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-00016060: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00016070: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
-00016080: 662e 636c 6965 6e74 2e67 6574 5f63 6865  f.client.get_che
-00016090: 636b 7328 6c65 7665 6c3d 7065 6262 6c65  cks(level=pebble
-000160a0: 2e43 6865 636b 4c65 7665 6c2e 5245 4144  .CheckLevel.READ
-000160b0: 592c 206e 616d 6573 3d5b 2763 686b 3227  Y, names=['chk2'
-000160c0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-000160d0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-000160e0: 6368 6563 6b73 292c 2031 290a 2020 2020  checks), 1).    
-000160f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016100: 7175 616c 2863 6865 636b 735b 305d 2e6e  qual(checks[0].n
-00016110: 616d 652c 2027 6368 6b32 2729 0a20 2020  ame, 'chk2').   
-00016120: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00016130: 4571 7561 6c28 6368 6563 6b73 5b30 5d2e  Equal(checks[0].
-00016140: 6c65 7665 6c2c 2027 666f 6f62 6172 2127  level, 'foobar!'
-00016150: 2920 2023 2073 7461 7973 2061 2072 6177  )  # stays a raw
-00016160: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
-00016170: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016180: 2863 6865 636b 735b 305d 2e73 7461 7475  (checks[0].statu
-00016190: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
-000161a0: 7461 7475 732e 5550 290a 2020 2020 2020  tatus.UP).      
-000161b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000161c0: 616c 2863 6865 636b 735b 305d 2e66 6169  al(checks[0].fai
-000161d0: 6c75 7265 732c 2030 290a 2020 2020 2020  lures, 0).      
-000161e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000161f0: 616c 2863 6865 636b 735b 305d 2e74 6872  al(checks[0].thr
-00016200: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
-00016210: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016220: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-00016230: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00016240: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-00016250: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
-00016260: 276c 6576 656c 273a 2027 7265 6164 7927  'level': 'ready'
-00016270: 2c20 276e 616d 6573 273a 205b 2763 686b  , 'names': ['chk
-00016280: 3227 5d7d 2c20 4e6f 6e65 292c 0a20 2020  2']}, None),.   
-00016290: 2020 2020 205d 290a 0a0a 636c 6173 7320       ])...class 
-000162a0: 5465 7374 536f 636b 6574 436c 6965 6e74  TestSocketClient
-000162b0: 2875 6e69 7474 6573 742e 5465 7374 4361  (unittest.TestCa
-000162c0: 7365 293a 0a20 2020 2064 6566 2074 6573  se):.    def tes
-000162d0: 745f 736f 636b 6574 5f6e 6f74 5f66 6f75  t_socket_not_fou
-000162e0: 6e64 2873 656c 6629 3a0a 2020 2020 2020  nd(self):.      
-000162f0: 2020 636c 6965 6e74 203d 2070 6562 626c    client = pebbl
-00016300: 652e 436c 6965 6e74 2873 6f63 6b65 745f  e.Client(socket_
-00016310: 7061 7468 3d27 646f 6573 5f6e 6f74 5f65  path='does_not_e
-00016320: 7869 7374 2729 0a20 2020 2020 2020 2077  xist').        w
-00016330: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00016340: 6169 7365 7328 7065 6262 6c65 2e43 6f6e  aises(pebble.Con
-00016350: 6e65 6374 696f 6e45 7272 6f72 2920 6173  nectionError) as
-00016360: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00016370: 2063 6c69 656e 742e 6765 745f 7379 7374   client.get_syst
-00016380: 656d 5f69 6e66 6f28 290a 2020 2020 2020  em_info().      
-00016390: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-000163a0: 6e73 7461 6e63 6528 636d 2e65 7863 6570  nstance(cm.excep
-000163b0: 7469 6f6e 2c20 7065 6262 6c65 2e45 7272  tion, pebble.Err
-000163c0: 6f72 290a 0a20 2020 2064 6566 2074 6573  or)..    def tes
-000163d0: 745f 7265 616c 5f63 6c69 656e 7428 7365  t_real_client(se
-000163e0: 6c66 293a 0a20 2020 2020 2020 2073 6875  lf):.        shu
-000163f0: 7464 6f77 6e2c 2073 6f63 6b65 745f 7061  tdown, socket_pa
-00016400: 7468 203d 2066 616b 655f 7065 6262 6c65  th = fake_pebble
-00016410: 2e73 7461 7274 5f73 6572 7665 7228 290a  .start_server().
-00016420: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00016430: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00016440: 203d 2070 6562 626c 652e 436c 6965 6e74   = pebble.Client
-00016450: 2873 6f63 6b65 745f 7061 7468 3d73 6f63  (socket_path=soc
-00016460: 6b65 745f 7061 7468 290a 2020 2020 2020  ket_path).      
-00016470: 2020 2020 2020 696e 666f 203d 2063 6c69        info = cli
-00016480: 656e 742e 6765 745f 7379 7374 656d 5f69  ent.get_system_i
-00016490: 6e66 6f28 290a 2020 2020 2020 2020 2020  nfo().          
-000164a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000164b0: 616c 2869 6e66 6f2e 7665 7273 696f 6e2c  al(info.version,
-000164c0: 2027 332e 3134 2e31 3539 2729 0a0a 2020   '3.14.159')..  
-000164d0: 2020 2020 2020 2020 2020 6368 616e 6765            change
-000164e0: 5f69 6420 3d20 636c 6965 6e74 2e73 7461  _id = client.sta
-000164f0: 7274 5f73 6572 7669 6365 7328 5b27 666f  rt_services(['fo
-00016500: 6f27 5d2c 2074 696d 656f 7574 3d30 290a  o'], timeout=0).
-00016510: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016520: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
-00016530: 6e67 655f 6964 2c20 2731 3233 3427 290a  nge_id, '1234').
-00016540: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00016550: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00016560: 7365 7328 7065 6262 6c65 2e41 5049 4572  ses(pebble.APIEr
-00016570: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-00016580: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-00016590: 6e74 2e73 7461 7274 5f73 6572 7669 6365  nt.start_service
-000165a0: 7328 5b27 6261 7227 5d2c 2074 696d 656f  s(['bar'], timeo
-000165b0: 7574 3d30 290a 2020 2020 2020 2020 2020  ut=0).          
-000165c0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-000165d0: 6e73 7461 6e63 6528 636d 2e65 7863 6570  nstance(cm.excep
-000165e0: 7469 6f6e 2c20 7065 6262 6c65 2e45 7272  tion, pebble.Err
-000165f0: 6f72 290a 2020 2020 2020 2020 2020 2020  or).            
-00016600: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016610: 2863 6d2e 6578 6365 7074 696f 6e2e 636f  (cm.exception.co
-00016620: 6465 2c20 3430 3029 0a20 2020 2020 2020  de, 400).       
-00016630: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00016640: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
-00016650: 6f6e 2e73 7461 7475 732c 2027 4261 6420  on.status, 'Bad 
-00016660: 5265 7175 6573 7427 290a 2020 2020 2020  Request').      
-00016670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00016680: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-00016690: 696f 6e2e 6d65 7373 6167 652c 2027 7365  ion.message, 'se
-000166a0: 7276 6963 6520 2262 6172 2220 646f 6573  rvice "bar" does
-000166b0: 206e 6f74 2065 7869 7374 2729 0a0a 2020   not exist')..  
-000166c0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-000166d0: 2020 2020 2020 2020 2020 2073 6875 7464             shutd
-000166e0: 6f77 6e28 290a 0a0a 636c 6173 7320 5465  own()...class Te
-000166f0: 7374 4578 6563 4572 726f 7228 756e 6974  stExecError(unit
-00016700: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-00016710: 2020 2020 6465 6620 7465 7374 5f69 6e69      def test_ini
-00016720: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00016730: 2065 203d 2070 6562 626c 652e 4578 6563   e = pebble.Exec
-00016740: 4572 726f 7228 5b27 666f 6f27 5d2c 2034  Error(['foo'], 4
-00016750: 322c 2027 6f75 7427 2c20 2765 7272 2729  2, 'out', 'err')
-00016760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00016770: 7365 7274 4571 7561 6c28 652e 636f 6d6d  sertEqual(e.comm
-00016780: 616e 642c 205b 2766 6f6f 275d 290a 2020  and, ['foo']).  
-00016790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000167a0: 7445 7175 616c 2865 2e65 7869 745f 636f  tEqual(e.exit_co
-000167b0: 6465 2c20 3432 290a 2020 2020 2020 2020  de, 42).        
-000167c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000167d0: 2865 2e73 7464 6f75 742c 2027 6f75 7427  (e.stdout, 'out'
-000167e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000167f0: 7373 6572 7445 7175 616c 2865 2e73 7464  ssertEqual(e.std
-00016800: 6572 722c 2027 6572 7227 290a 0a20 2020  err, 'err')..   
-00016810: 2064 6566 2074 6573 745f 7374 7228 7365   def test_str(se
-00016820: 6c66 293a 0a20 2020 2020 2020 2065 203d  lf):.        e =
-00016830: 2070 6562 626c 652e 4578 6563 4572 726f   pebble.ExecErro
-00016840: 7228 5b27 7827 5d2c 2031 2c20 4e6f 6e65  r(['x'], 1, None
-00016850: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-00016860: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016870: 2873 7472 2865 292c 2022 6e6f 6e2d 7a65  (str(e), "non-ze
-00016880: 726f 2065 7869 7420 636f 6465 2031 2065  ro exit code 1 e
-00016890: 7865 6375 7469 6e67 205b 2778 275d 2229  xecuting ['x']")
-000168a0: 0a0a 2020 2020 2020 2020 6520 3d20 7065  ..        e = pe
-000168b0: 6262 6c65 2e45 7865 6345 7272 6f72 285b  bble.ExecError([
-000168c0: 2778 275d 2c20 312c 2027 6f6e 6c79 2d6f  'x'], 1, 'only-o
-000168d0: 7574 272c 204e 6f6e 6529 0a20 2020 2020  ut', None).     
-000168e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000168f0: 7561 6c28 7374 7228 6529 2c20 226e 6f6e  ual(str(e), "non
-00016900: 2d7a 6572 6f20 6578 6974 2063 6f64 6520  -zero exit code 
-00016910: 3120 6578 6563 7574 696e 6720 5b27 7827  1 executing ['x'
-00016920: 5d2c 2073 7464 6f75 743d 276f 6e6c 792d  ], stdout='only-
-00016930: 6f75 7427 2229 0a0a 2020 2020 2020 2020  out'")..        
-00016940: 6520 3d20 7065 6262 6c65 2e45 7865 6345  e = pebble.ExecE
-00016950: 7272 6f72 285b 2778 275d 2c20 312c 204e  rror(['x'], 1, N
-00016960: 6f6e 652c 2027 6f6e 6c79 2d65 7272 2729  one, 'only-err')
-00016970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00016980: 7365 7274 4571 7561 6c28 7374 7228 6529  sertEqual(str(e)
-00016990: 2c20 226e 6f6e 2d7a 6572 6f20 6578 6974  , "non-zero exit
-000169a0: 2063 6f64 6520 3120 6578 6563 7574 696e   code 1 executin
-000169b0: 6720 5b27 7827 5d2c 2073 7464 6572 723d  g ['x'], stderr=
-000169c0: 276f 6e6c 792d 6572 7227 2229 0a0a 2020  'only-err'")..  
-000169d0: 2020 2020 2020 6520 3d20 7065 6262 6c65        e = pebble
-000169e0: 2e45 7865 6345 7272 6f72 285b 2761 272c  .ExecError(['a',
-000169f0: 2027 6227 5d2c 2031 2c20 276f 7574 272c   'b'], 1, 'out',
-00016a00: 2027 6572 7227 290a 2020 2020 2020 2020   'err').        
-00016a10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016a20: 2873 7472 2865 292c 2022 6e6f 6e2d 7a65  (str(e), "non-ze
-00016a30: 726f 2065 7869 7420 636f 6465 2031 2065  ro exit code 1 e
-00016a40: 7865 6375 7469 6e67 205b 2761 272c 2027  xecuting ['a', '
-00016a50: 6227 5d2c 2022 0a20 2020 2020 2020 2020  b'], ".         
-00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a70: 2020 2020 2020 2020 2b20 2273 7464 6f75          + "stdou
-00016a80: 743d 276f 7574 272c 2073 7464 6572 723d  t='out', stderr=
-00016a90: 2765 7272 2722 290a 0a20 2020 2064 6566  'err'")..    def
-00016aa0: 2074 6573 745f 7374 725f 7472 756e 6361   test_str_trunca
-00016ab0: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
-00016ac0: 2020 2065 203d 2070 6562 626c 652e 4578     e = pebble.Ex
-00016ad0: 6563 4572 726f 7228 5b27 666f 6f27 5d2c  ecError(['foo'],
-00016ae0: 2032 2c20 276c 6f6e 676f 7574 272c 2027   2, 'longout', '
-00016af0: 6c6f 6e67 6572 7227 290a 2020 2020 2020  longerr').      
-00016b00: 2020 652e 5354 525f 4d41 585f 4f55 5450    e.STR_MAX_OUTP
-00016b10: 5554 203d 2035 0a20 2020 2020 2020 2073  UT = 5.        s
-00016b20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00016b30: 7374 7228 6529 2c20 226e 6f6e 2d7a 6572  str(e), "non-zer
-00016b40: 6f20 6578 6974 2063 6f64 6520 3220 6578  o exit code 2 ex
-00016b50: 6563 7574 696e 6720 5b27 666f 6f27 5d2c  ecuting ['foo'],
-00016b60: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000b0f0: 2020 2020 6d61 785f 6c6f 6f6b 6168 6561      max_lookahea
+0000b100: 643d 7465 7374 2e6d 6178 5f6c 6f6f 6b61  d=test.max_looka
+0000b110: 6865 6164 290a 2020 2020 2020 2020 2020  head).          
+0000b120: 2020 2020 2020 7372 6320 3d20 696f 2e42        src = io.B
+0000b130: 7974 6573 494f 2874 6573 742e 6461 7461  ytesIO(test.data
+0000b140: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b150: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000b160: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+0000b170: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+0000b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b190: 6461 7461 203d 2073 7263 2e72 6561 6428  data = src.read(
+0000b1a0: 6368 756e 6b5f 7369 7a65 290a 2020 2020  chunk_size).    
+0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1c0: 2020 2020 6966 206e 6f74 2064 6174 613a      if not data:
+0000b1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1e0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0000b1f0: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
+0000b200: 2020 2020 2020 2020 2020 2070 6172 7365             parse
+0000b210: 722e 6665 6564 2864 6174 6129 0a20 2020  r.feed(data).   
+0000b220: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000b230: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000b240: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
+0000b250: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0000b260: 2074 6573 742e 6572 726f 723a 0a20 2020   test.error:.   
+0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b280: 2020 2020 2073 656c 662e 6661 696c 2827       self.fail('
+0000b290: 756e 6578 7065 6374 6564 2065 7272 6f72  unexpected error
+0000b2a0: 3a27 2c20 6572 7229 0a20 2020 2020 2020  :', err).       
+0000b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2c0: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+0000b2d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000b2e0: 6173 7365 7274 4571 7561 6c28 7465 7374  assertEqual(test
+0000b2f0: 2e65 7272 6f72 2c20 7374 7228 6572 7229  .error, str(err)
+0000b300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000b320: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0000b330: 6573 742e 6572 726f 723a 0a20 2020 2020  est.error:.     
+0000b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b350: 2020 2073 656c 662e 6661 696c 2866 276d     self.fail(f'm
+0000b360: 6973 7369 6e67 2065 7870 6563 7465 6420  issing expected 
+0000b370: 6572 726f 723a 207b 7465 7374 2e65 7272  error: {test.err
+0000b380: 6f72 2172 7d27 290a 0a20 2020 2020 2020  or!r}')..       
+0000b390: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+0000b3a0: 203d 2066 2774 6573 7420 6361 7365 207b   = f'test case {
+0000b3b0: 6920 2b20 317d 2028 7b74 6573 742e 6e61  i + 1} ({test.na
+0000b3c0: 6d65 7d29 2c20 6368 756e 6b20 7369 7a65  me}), chunk size
+0000b3d0: 207b 6368 756e 6b5f 7369 7a65 7d27 0a20   {chunk_size}'. 
+0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000b400: 7561 6c28 7465 7374 2e77 616e 745f 6865  ual(test.want_he
+0000b410: 6164 6572 732c 2068 6561 6465 7273 2c20  aders, headers, 
+0000b420: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0000b430: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0000b440: 7365 7274 4571 7561 6c28 7465 7374 2e77  sertEqual(test.w
+0000b450: 616e 745f 626f 6469 6573 2c20 626f 6469  ant_bodies, bodi
+0000b460: 6573 2c20 6d73 6729 0a20 2020 2020 2020  es, msg).       
+0000b470: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000b480: 662e 6173 7365 7274 4571 7561 6c28 7465  f.assertEqual(te
+0000b490: 7374 2e77 616e 745f 626f 6469 6573 5f64  st.want_bodies_d
+0000b4a0: 6f6e 652c 2062 6f64 6965 735f 646f 6e65  one, bodies_done
+0000b4b0: 2c20 6d73 6729 0a0a 0a63 6c61 7373 2054  , msg)...class T
+0000b4c0: 6573 7443 6c69 656e 7428 756e 6974 7465  estClient(unitte
+0000b4d0: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
+0000b4e0: 2020 6d61 7844 6966 6620 3d20 4e6f 6e65    maxDiff = None
+0000b4f0: 0a0a 2020 2020 6465 6620 7365 7455 7028  ..    def setUp(
+0000b500: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000b510: 656c 662e 636c 6965 6e74 203d 204d 6f63  elf.client = Moc
+0000b520: 6b43 6c69 656e 7428 290a 2020 2020 2020  kClient().      
+0000b530: 2020 7365 6c66 2e74 696d 6520 3d20 4d6f    self.time = Mo
+0000b540: 636b 5469 6d65 2829 0a20 2020 2020 2020  ckTime().       
+0000b550: 2074 696d 655f 7061 7463 6865 7220 3d20   time_patcher = 
+0000b560: 756e 6974 7465 7374 2e6d 6f63 6b2e 7061  unittest.mock.pa
+0000b570: 7463 6828 276f 7073 2e70 6562 626c 652e  tch('ops.pebble.
+0000b580: 7469 6d65 272c 2073 656c 662e 7469 6d65  time', self.time
+0000b590: 290a 2020 2020 2020 2020 7469 6d65 5f70  ).        time_p
+0000b5a0: 6174 6368 6572 2e73 7461 7274 2829 0a20  atcher.start(). 
+0000b5b0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000b5c0: 6c65 616e 7570 2874 696d 655f 7061 7463  leanup(time_patc
+0000b5d0: 6865 722e 7374 6f70 290a 0a20 2020 2064  her.stop)..    d
+0000b5e0: 6566 2074 6573 745f 636c 6965 6e74 5f69  ef test_client_i
+0000b5f0: 6e69 7428 7365 6c66 293a 0a20 2020 2020  nit(self):.     
+0000b600: 2020 2070 6562 626c 652e 436c 6965 6e74     pebble.Client
+0000b610: 2873 6f63 6b65 745f 7061 7468 3d27 666f  (socket_path='fo
+0000b620: 6f27 2920 2023 2074 6573 7420 7468 6174  o')  # test that
+0000b630: 2063 6f6e 7374 7275 6374 6f72 2072 756e   constructor run
+0000b640: 730a 2020 2020 2020 2020 7769 7468 2073  s.        with s
+0000b650: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000b660: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0000b670: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+0000b680: 436c 6965 6e74 2829 2020 2320 736f 636b  Client()  # sock
+0000b690: 6574 5f70 6174 6820 6172 6720 7265 7175  et_path arg requ
+0000b6a0: 6972 6564 0a0a 2020 2020 6465 6620 7465  ired..    def te
+0000b6b0: 7374 5f67 6574 5f73 7973 7465 6d5f 696e  st_get_system_in
+0000b6c0: 666f 2873 656c 6629 3a0a 2020 2020 2020  fo(self):.      
+0000b6d0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000b6e0: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
+0000b6f0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+0000b700: 7375 6c74 223a 207b 0a20 2020 2020 2020  sult": {.       
+0000b710: 2020 2020 2020 2020 2022 7665 7273 696f           "versio
+0000b720: 6e22 3a20 2231 2e32 2e33 222c 0a20 2020  n": "1.2.3",.   
+0000b730: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
+0000b740: 7472 612d 6669 656c 6422 3a20 2266 6f6f  tra-field": "foo
+0000b750: 222c 0a20 2020 2020 2020 2020 2020 207d  ",.            }
+0000b760: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000b770: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+0000b780: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000b790: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+0000b7a0: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+0000b7b0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+0000b7c0: 207d 290a 2020 2020 2020 2020 696e 666f   }).        info
+0000b7d0: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+0000b7e0: 6574 5f73 7973 7465 6d5f 696e 666f 2829  et_system_info()
+0000b7f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000b800: 7365 7274 4571 7561 6c28 696e 666f 2e76  sertEqual(info.v
+0000b810: 6572 7369 6f6e 2c20 2731 2e32 2e33 2729  ersion, '1.2.3')
+0000b820: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000b830: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
+0000b840: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
+0000b850: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+0000b860: 4745 5427 2c20 272f 7631 2f73 7973 7465  GET', '/v1/syste
+0000b870: 6d2d 696e 666f 272c 204e 6f6e 652c 204e  m-info', None, N
+0000b880: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
+0000b890: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0000b8a0: 6574 5f77 6172 6e69 6e67 7328 7365 6c66  et_warnings(self
+0000b8b0: 293a 0a20 2020 2020 2020 2065 6d70 7479  ):.        empty
+0000b8c0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0000b8d0: 2022 7265 7375 6c74 223a 205b 5d2c 0a20   "result": [],. 
+0000b8e0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+0000b8f0: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
+0000b900: 2020 2020 2020 2022 7374 6174 7573 2d63         "status-c
+0000b910: 6f64 6522 3a20 3230 302c 0a20 2020 2020  ode": 200,.     
+0000b920: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
+0000b930: 7379 6e63 220a 2020 2020 2020 2020 7d0a  sync".        }.
+0000b940: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000b950: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000b960: 7065 6e64 2865 6d70 7479 290a 2020 2020  pend(empty).    
+0000b970: 2020 2020 7761 726e 696e 6773 203d 2073      warnings = s
+0000b980: 656c 662e 636c 6965 6e74 2e67 6574 5f77  elf.client.get_w
+0000b990: 6172 6e69 6e67 7328 290a 2020 2020 2020  arnings().      
+0000b9a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000b9b0: 616c 2877 6172 6e69 6e67 732c 205b 5d29  al(warnings, [])
+0000b9c0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+0000b9d0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+0000b9e0: 6170 7065 6e64 2865 6d70 7479 290a 2020  append(empty).  
+0000b9f0: 2020 2020 2020 7761 726e 696e 6773 203d        warnings =
+0000ba00: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
+0000ba10: 5f77 6172 6e69 6e67 7328 7365 6c65 6374  _warnings(select
+0000ba20: 3d70 6562 626c 652e 5761 726e 696e 6753  =pebble.WarningS
+0000ba30: 7461 7465 2e41 4c4c 290a 2020 2020 2020  tate.ALL).      
+0000ba40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ba50: 616c 2877 6172 6e69 6e67 732c 205b 5d29  al(warnings, [])
+0000ba60: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0000ba70: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000ba80: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+0000ba90: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000baa0: 2747 4554 272c 2027 2f76 312f 7761 726e  'GET', '/v1/warn
+0000bab0: 696e 6773 272c 207b 2773 656c 6563 7427  ings', {'select'
+0000bac0: 3a20 2770 656e 6469 6e67 277d 2c20 4e6f  : 'pending'}, No
+0000bad0: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
+0000bae0: 2028 2747 4554 272c 2027 2f76 312f 7761   ('GET', '/v1/wa
+0000baf0: 726e 696e 6773 272c 207b 2773 656c 6563  rnings', {'selec
+0000bb00: 7427 3a20 2761 6c6c 277d 2c20 4e6f 6e65  t': 'all'}, None
+0000bb10: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+0000bb20: 2020 2064 6566 2074 6573 745f 6163 6b5f     def test_ack_
+0000bb30: 7761 726e 696e 6773 2873 656c 6629 3a0a  warnings(self):.
+0000bb40: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000bb50: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000bb60: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+0000bb70: 2020 2022 7265 7375 6c74 223a 2030 2c0a     "result": 0,.
+0000bb80: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000bb90: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
+0000bba0: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
+0000bbb0: 636f 6465 223a 2032 3030 2c0a 2020 2020  code": 200,.    
+0000bbc0: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000bbd0: 2273 796e 6322 0a20 2020 2020 2020 207d  "sync".        }
+0000bbe0: 290a 2020 2020 2020 2020 6e75 6d20 3d20  ).        num = 
+0000bbf0: 7365 6c66 2e63 6c69 656e 742e 6163 6b5f  self.client.ack_
+0000bc00: 7761 726e 696e 6773 2864 6174 6574 696d  warnings(datetim
+0000bc10: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+0000bc20: 3238 2c20 3135 2c20 3131 2c20 3029 290a  28, 15, 11, 0)).
+0000bc30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000bc40: 6572 7445 7175 616c 286e 756d 2c20 3029  ertEqual(num, 0)
+0000bc50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000bc60: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
+0000bc70: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
+0000bc80: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+0000bc90: 504f 5354 272c 2027 2f76 312f 7761 726e  POST', '/v1/warn
+0000bca0: 696e 6773 272c 204e 6f6e 652c 207b 0a20  ings', None, {. 
+0000bcb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000bcc0: 6163 7469 6f6e 273a 2027 6f6b 6179 272c  action': 'okay',
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bce0: 2027 7469 6d65 7374 616d 7027 3a20 2732   'timestamp': '2
+0000bcf0: 3032 312d 3031 2d32 3854 3135 3a31 313a  021-01-28T15:11:
+0000bd00: 3030 2b31 333a 3030 272c 0a20 2020 2020  00+13:00',.     
+0000bd10: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
+0000bd20: 2020 205d 290a 0a20 2020 2064 6566 2061     ])..    def a
+0000bd30: 7373 6572 745f 6d6f 636b 5f63 6861 6e67  ssert_mock_chang
+0000bd40: 6528 7365 6c66 2c20 6368 616e 6765 293a  e(self, change):
+0000bd50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000bd60: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000bd70: 2e69 642c 2027 3730 2729 0a20 2020 2020  .id, '70').     
+0000bd80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000bd90: 7561 6c28 6368 616e 6765 2e6b 696e 642c  ual(change.kind,
+0000bda0: 2027 6175 746f 7374 6172 7427 290a 2020   'autostart').  
+0000bdb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bdc0: 7445 7175 616c 2863 6861 6e67 652e 7375  tEqual(change.su
+0000bdd0: 6d6d 6172 792c 2027 4175 746f 7374 6172  mmary, 'Autostar
+0000bde0: 7420 7365 7276 6963 6520 2273 7663 2227  t service "svc"'
+0000bdf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000be00: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+0000be10: 652e 7374 6174 7573 2c20 2744 6f6e 6527  e.status, 'Done'
+0000be20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000be30: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
+0000be40: 6861 6e67 652e 7461 736b 7329 2c20 3129  hange.tasks), 1)
+0000be50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000be60: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000be70: 2e74 6173 6b73 5b30 5d2e 6964 2c20 2737  .tasks[0].id, '7
+0000be80: 3827 290a 2020 2020 2020 2020 7365 6c66  8').        self
+0000be90: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+0000bea0: 6e67 652e 7461 736b 735b 305d 2e6b 696e  nge.tasks[0].kin
+0000beb0: 642c 2027 7374 6172 7427 290a 2020 2020  d, 'start').    
+0000bec0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000bed0: 7175 616c 2863 6861 6e67 652e 7461 736b  qual(change.task
+0000bee0: 735b 305d 2e73 756d 6d61 7279 2c20 2753  s[0].summary, 'S
+0000bef0: 7461 7274 2073 6572 7669 6365 2022 7376  tart service "sv
+0000bf00: 6322 2729 0a20 2020 2020 2020 2073 656c  c"').        sel
+0000bf10: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000bf20: 616e 6765 2e74 6173 6b73 5b30 5d2e 7374  ange.tasks[0].st
+0000bf30: 6174 7573 2c20 2744 6f6e 6527 290a 2020  atus, 'Done').  
+0000bf40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bf50: 7445 7175 616c 2863 6861 6e67 652e 7461  tEqual(change.ta
+0000bf60: 736b 735b 305d 2e6c 6f67 2c20 5b5d 290a  sks[0].log, []).
+0000bf70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000bf80: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
+0000bf90: 7461 736b 735b 305d 2e70 726f 6772 6573  tasks[0].progres
+0000bfa0: 732e 646f 6e65 2c20 3129 0a20 2020 2020  s.done, 1).     
+0000bfb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000bfc0: 7561 6c28 6368 616e 6765 2e74 6173 6b73  ual(change.tasks
+0000bfd0: 5b30 5d2e 7072 6f67 7265 7373 2e6c 6162  [0].progress.lab
+0000bfe0: 656c 2c20 2727 290a 2020 2020 2020 2020  el, '').        
+0000bff0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c000: 2863 6861 6e67 652e 7461 736b 735b 305d  (change.tasks[0]
+0000c010: 2e70 726f 6772 6573 732e 746f 7461 6c2c  .progress.total,
+0000c020: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+0000c030: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+0000c040: 6e67 652e 7461 736b 735b 305d 2e72 6561  nge.tasks[0].rea
+0000c050: 6479 5f74 696d 652c 0a20 2020 2020 2020  dy_time,.       
+0000c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c070: 2020 6461 7465 7469 6d65 5f6e 7a64 7428    datetime_nzdt(
+0000c080: 3230 3231 2c20 312c 2032 382c 2031 342c  2021, 1, 28, 14,
+0000c090: 2033 372c 2033 2c20 3237 3032 3139 2929   37, 3, 270219))
+0000c0a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000c0b0: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000c0c0: 2e74 6173 6b73 5b30 5d2e 7370 6177 6e5f  .tasks[0].spawn_
+0000c0d0: 7469 6d65 2c0a 2020 2020 2020 2020 2020  time,.          
+0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000c0f0: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
+0000c100: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
+0000c110: 2c20 322c 2032 3437 3135 3829 290a 2020  , 2, 247158)).  
+0000c120: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c130: 7445 7175 616c 2863 6861 6e67 652e 7265  tEqual(change.re
+0000c140: 6164 792c 2054 7275 6529 0a20 2020 2020  ady, True).     
+0000c150: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000c160: 7561 6c28 6368 616e 6765 2e65 7272 2c20  ual(change.err, 
+0000c170: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+0000c180: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000c190: 6861 6e67 652e 7265 6164 795f 7469 6d65  hange.ready_time
+0000c1a0: 2c20 6461 7465 7469 6d65 5f6e 7a64 7428  , datetime_nzdt(
+0000c1b0: 3230 3231 2c20 312c 2032 382c 2031 342c  2021, 1, 28, 14,
+0000c1c0: 2033 372c 2034 2c20 3239 3135 3138 2929   37, 4, 291518))
+0000c1d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000c1e0: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000c1f0: 2e73 7061 776e 5f74 696d 652c 2064 6174  .spawn_time, dat
+0000c200: 6574 696d 655f 6e7a 6474 2832 3032 312c  etime_nzdt(2021,
+0000c210: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
+0000c220: 322c 2032 3437 3230 3229 290a 0a20 2020  2, 247202))..   
+0000c230: 2064 6566 2074 6573 745f 6765 745f 6368   def test_get_ch
+0000c240: 616e 6765 7328 7365 6c66 293a 0a20 2020  anges(self):.   
+0000c250: 2020 2020 2065 6d70 7479 203d 207b 0a20       empty = {. 
+0000c260: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+0000c270: 6c74 223a 205b 5d2c 0a20 2020 2020 2020  lt": [],.       
+0000c280: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+0000c290: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
+0000c2a0: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
+0000c2b0: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
+0000c2c0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+0000c2d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0000c2e0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000c2f0: 7370 6f6e 7365 732e 6170 7065 6e64 2865  sponses.append(e
+0000c300: 6d70 7479 290a 2020 2020 2020 2020 6368  mpty).        ch
+0000c310: 616e 6765 7320 3d20 7365 6c66 2e63 6c69  anges = self.cli
+0000c320: 656e 742e 6765 745f 6368 616e 6765 7328  ent.get_changes(
+0000c330: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c340: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+0000c350: 6573 2c20 5b5d 290a 0a20 2020 2020 2020  es, [])..       
+0000c360: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
+0000c370: 706f 6e73 6573 2e61 7070 656e 6428 656d  ponses.append(em
+0000c380: 7074 7929 0a20 2020 2020 2020 2063 6861  pty).        cha
+0000c390: 6e67 6573 203d 2073 656c 662e 636c 6965  nges = self.clie
+0000c3a0: 6e74 2e67 6574 5f63 6861 6e67 6573 2873  nt.get_changes(s
+0000c3b0: 656c 6563 743d 7065 6262 6c65 2e43 6861  elect=pebble.Cha
+0000c3c0: 6e67 6553 7461 7465 2e41 4c4c 290a 2020  ngeState.ALL).  
+0000c3d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c3e0: 7445 7175 616c 2863 6861 6e67 6573 2c20  tEqual(changes, 
+0000c3f0: 5b5d 290a 0a20 2020 2020 2020 2073 656c  [])..        sel
+0000c400: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+0000c410: 6573 2e61 7070 656e 6428 656d 7074 7929  es.append(empty)
+0000c420: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
+0000c430: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+0000c440: 6574 5f63 6861 6e67 6573 2873 656c 6563  et_changes(selec
+0000c450: 743d 7065 6262 6c65 2e43 6861 6e67 6553  t=pebble.ChangeS
+0000c460: 7461 7465 2e41 4c4c 2c20 7365 7276 6963  tate.ALL, servic
+0000c470: 653d 2766 6f6f 2729 0a20 2020 2020 2020  e='foo').       
+0000c480: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c490: 6c28 6368 616e 6765 732c 205b 5d29 0a0a  l(changes, [])..
+0000c4a0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000c4b0: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000c4c0: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+0000c4d0: 2020 2022 7265 7375 6c74 223a 205b 0a20     "result": [. 
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000c4f0: 7569 6c64 5f6d 6f63 6b5f 6368 616e 6765  uild_mock_change
+0000c500: 5f64 6963 7428 292c 0a20 2020 2020 2020  _dict(),.       
+0000c510: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000c520: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
+0000c530: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
+0000c540: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
+0000c550: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+0000c560: 2274 7970 6522 3a20 2273 796e 6322 0a20  "type": "sync". 
+0000c570: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
+0000c580: 2020 6368 616e 6765 7320 3d20 7365 6c66    changes = self
+0000c590: 2e63 6c69 656e 742e 6765 745f 6368 616e  .client.get_chan
+0000c5a0: 6765 7328 290a 2020 2020 2020 2020 7365  ges().        se
+0000c5b0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+0000c5c0: 656e 2863 6861 6e67 6573 292c 2031 290a  en(changes), 1).
+0000c5d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000c5e0: 6572 745f 6d6f 636b 5f63 6861 6e67 6528  ert_mock_change(
+0000c5f0: 6368 616e 6765 735b 305d 290a 0a20 2020  changes[0])..   
+0000c600: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c610: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0000c620: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0000c630: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+0000c640: 2c20 272f 7631 2f63 6861 6e67 6573 272c  , '/v1/changes',
+0000c650: 207b 2773 656c 6563 7427 3a20 2769 6e2d   {'select': 'in-
+0000c660: 7072 6f67 7265 7373 277d 2c20 4e6f 6e65  progress'}, None
+0000c670: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000c680: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000c690: 6765 7327 2c20 7b27 7365 6c65 6374 273a  ges', {'select':
+0000c6a0: 2027 616c 6c27 7d2c 204e 6f6e 6529 2c0a   'all'}, None),.
+0000c6b0: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0000c6c0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0000c6d0: 272c 207b 2773 656c 6563 7427 3a20 2761  ', {'select': 'a
+0000c6e0: 6c6c 272c 2027 666f 7227 3a20 2766 6f6f  ll', 'for': 'foo
+0000c6f0: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+0000c700: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+0000c710: 2f76 312f 6368 616e 6765 7327 2c20 7b27  /v1/changes', {'
+0000c720: 7365 6c65 6374 273a 2027 696e 2d70 726f  select': 'in-pro
+0000c730: 6772 6573 7327 7d2c 204e 6f6e 6529 2c0a  gress'}, None),.
+0000c740: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0000c750: 6465 6620 7465 7374 5f67 6574 5f63 6861  def test_get_cha
+0000c760: 6e67 6528 7365 6c66 293a 0a20 2020 2020  nge(self):.     
+0000c770: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+0000c780: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000c790: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+0000c7a0: 6573 756c 7422 3a20 6275 696c 645f 6d6f  esult": build_mo
+0000c7b0: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
+0000c7c0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000c7d0: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+0000c7e0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000c7f0: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+0000c800: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+0000c810: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+0000c820: 207d 290a 2020 2020 2020 2020 6368 616e   }).        chan
+0000c830: 6765 203d 2073 656c 662e 636c 6965 6e74  ge = self.client
+0000c840: 2e67 6574 5f63 6861 6e67 6528 2737 3027  .get_change('70'
+0000c850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c860: 7373 6572 745f 6d6f 636b 5f63 6861 6e67  ssert_mock_chang
+0000c870: 6528 6368 616e 6765 290a 2020 2020 2020  e(change).      
+0000c880: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000c890: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0000c8a0: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0000c8b0: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+0000c8c0: 2f76 312f 6368 616e 6765 732f 3730 272c  /v1/changes/70',
+0000c8d0: 204e 6f6e 652c 204e 6f6e 6529 2c0a 2020   None, None),.  
+0000c8e0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+0000c8f0: 6620 7465 7374 5f61 626f 7274 5f63 6861  f test_abort_cha
+0000c900: 6e67 6528 7365 6c66 293a 0a20 2020 2020  nge(self):.     
+0000c910: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+0000c920: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000c930: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+0000c940: 6573 756c 7422 3a20 6275 696c 645f 6d6f  esult": build_mo
+0000c950: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
+0000c960: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000c970: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+0000c980: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000c990: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+0000c9a0: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+0000c9b0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+0000c9c0: 207d 290a 2020 2020 2020 2020 6368 616e   }).        chan
+0000c9d0: 6765 203d 2073 656c 662e 636c 6965 6e74  ge = self.client
+0000c9e0: 2e61 626f 7274 5f63 6861 6e67 6528 2737  .abort_change('7
+0000c9f0: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
+0000ca00: 2e61 7373 6572 745f 6d6f 636b 5f63 6861  .assert_mock_cha
+0000ca10: 6e67 6528 6368 616e 6765 290a 2020 2020  nge(change).    
+0000ca20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000ca30: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+0000ca40: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+0000ca50: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
+0000ca60: 2c20 272f 7631 2f63 6861 6e67 6573 2f37  , '/v1/changes/7
+0000ca70: 3027 2c20 4e6f 6e65 2c20 7b27 6163 7469  0', None, {'acti
+0000ca80: 6f6e 273a 2027 6162 6f72 7427 7d29 2c0a  on': 'abort'}),.
+0000ca90: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0000caa0: 6465 6620 5f73 6572 7669 6365 735f 6163  def _services_ac
+0000cab0: 7469 6f6e 5f68 656c 7065 7228 7365 6c66  tion_helper(self
+0000cac0: 2c20 6163 7469 6f6e 2c20 6170 695f 6675  , action, api_fu
+0000cad0: 6e63 2c20 7365 7276 6963 6573 293a 0a20  nc, services):. 
+0000cae0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0000caf0: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
+0000cb00: 656e 6428 7b0a 2020 2020 2020 2020 2020  end({.          
+0000cb10: 2020 2263 6861 6e67 6522 3a20 2237 3022    "change": "70"
+0000cb20: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0000cb30: 6573 756c 7422 3a20 4e6f 6e65 2c0a 2020  esult": None,.  
+0000cb40: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000cb50: 7322 3a20 2241 6363 6570 7465 6422 2c0a  s": "Accepted",.
+0000cb60: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000cb70: 7475 732d 636f 6465 223a 2032 3032 2c0a  tus-code": 202,.
+0000cb80: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
+0000cb90: 6522 3a20 2261 7379 6e63 220a 2020 2020  e": "async".    
+0000cba0: 2020 2020 7d29 0a20 2020 2020 2020 2063      }).        c
+0000cbb0: 6861 6e67 6520 3d20 6275 696c 645f 6d6f  hange = build_mo
+0000cbc0: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
+0000cbd0: 0a20 2020 2020 2020 2063 6861 6e67 655b  .        change[
+0000cbe0: 2772 6561 6479 275d 203d 2054 7275 650a  'ready'] = True.
+0000cbf0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000cc00: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000cc10: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+0000cc20: 2020 2022 7265 7375 6c74 223a 2063 6861     "result": cha
+0000cc30: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
+0000cc40: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
+0000cc50: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0000cc60: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+0000cc70: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
+0000cc80: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
+0000cc90: 2020 2020 7d29 0a20 2020 2020 2020 2063      }).        c
+0000cca0: 6861 6e67 655f 6964 203d 2061 7069 5f66  hange_id = api_f
+0000ccb0: 756e 6328 290a 2020 2020 2020 2020 7365  unc().        se
+0000ccc0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000ccd0: 6861 6e67 655f 6964 2c20 2737 3027 290a  hange_id, '70').
+0000cce0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000ccf0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+0000cd00: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+0000cd10: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+0000cd20: 4f53 5427 2c20 272f 7631 2f73 6572 7669  OST', '/v1/servi
+0000cd30: 6365 7327 2c20 4e6f 6e65 2c20 7b27 6163  ces', None, {'ac
+0000cd40: 7469 6f6e 273a 2061 6374 696f 6e2c 2027  tion': action, '
+0000cd50: 7365 7276 6963 6573 273a 2073 6572 7669  services': servi
+0000cd60: 6365 737d 292c 0a20 2020 2020 2020 2020  ces}),.         
+0000cd70: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000cd80: 6368 616e 6765 732f 3730 2f77 6169 7427  changes/70/wait'
+0000cd90: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
+0000cda0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
+0000cdb0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0000cdc0: 6465 6620 5f73 6572 7669 6365 735f 6163  def _services_ac
+0000cdd0: 7469 6f6e 5f61 7379 6e63 5f68 656c 7065  tion_async_helpe
+0000cde0: 7228 7365 6c66 2c20 6163 7469 6f6e 2c20  r(self, action, 
+0000cdf0: 6170 695f 6675 6e63 2c20 7365 7276 6963  api_func, servic
+0000ce00: 6573 293a 0a20 2020 2020 2020 2073 656c  es):.        sel
+0000ce10: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+0000ce20: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
+0000ce30: 2020 2020 2020 2020 2263 6861 6e67 6522          "change"
+0000ce40: 3a20 2237 3022 2c0a 2020 2020 2020 2020  : "70",.        
+0000ce50: 2020 2020 2272 6573 756c 7422 3a20 4e6f      "result": No
+0000ce60: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0000ce70: 2273 7461 7475 7322 3a20 2241 6363 6570  "status": "Accep
+0000ce80: 7465 6422 2c0a 2020 2020 2020 2020 2020  ted",.          
+0000ce90: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
+0000cea0: 2032 3032 2c0a 2020 2020 2020 2020 2020   202,.          
+0000ceb0: 2020 2274 7970 6522 3a20 2261 7379 6e63    "type": "async
+0000cec0: 220a 2020 2020 2020 2020 7d29 0a20 2020  ".        }).   
+0000ced0: 2020 2020 2063 6861 6e67 655f 6964 203d       change_id =
+0000cee0: 2061 7069 5f66 756e 6328 7469 6d65 6f75   api_func(timeou
+0000cef0: 743d 3029 0a20 2020 2020 2020 2073 656c  t=0).        sel
+0000cf00: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000cf10: 616e 6765 5f69 642c 2027 3730 2729 0a20  ange_id, '70'). 
+0000cf20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000cf30: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+0000cf40: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+0000cf50: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
+0000cf60: 5354 272c 2027 2f76 312f 7365 7276 6963  ST', '/v1/servic
+0000cf70: 6573 272c 204e 6f6e 652c 207b 2761 6374  es', None, {'act
+0000cf80: 696f 6e27 3a20 6163 7469 6f6e 2c20 2773  ion': action, 's
+0000cf90: 6572 7669 6365 7327 3a20 7365 7276 6963  ervices': servic
+0000cfa0: 6573 7d29 2c0a 2020 2020 2020 2020 5d29  es}),.        ])
+0000cfb0: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+0000cfc0: 7574 6f73 7461 7274 5f73 6572 7669 6365  utostart_service
+0000cfd0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000cfe0: 2073 656c 662e 5f73 6572 7669 6365 735f   self._services_
+0000cff0: 6163 7469 6f6e 5f68 656c 7065 7228 2761  action_helper('a
+0000d000: 7574 6f73 7461 7274 272c 2073 656c 662e  utostart', self.
+0000d010: 636c 6965 6e74 2e61 7574 6f73 7461 7274  client.autostart
+0000d020: 5f73 6572 7669 6365 732c 205b 5d29 0a0a  _services, [])..
+0000d030: 2020 2020 6465 6620 7465 7374 5f61 7574      def test_aut
+0000d040: 6f73 7461 7274 5f73 6572 7669 6365 735f  ostart_services_
+0000d050: 6173 796e 6328 7365 6c66 293a 0a20 2020  async(self):.   
+0000d060: 2020 2020 2073 656c 662e 5f73 6572 7669       self._servi
+0000d070: 6365 735f 6163 7469 6f6e 5f61 7379 6e63  ces_action_async
+0000d080: 5f68 656c 7065 7228 2761 7574 6f73 7461  _helper('autosta
+0000d090: 7274 272c 2073 656c 662e 636c 6965 6e74  rt', self.client
+0000d0a0: 2e61 7574 6f73 7461 7274 5f73 6572 7669  .autostart_servi
+0000d0b0: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
+0000d0c0: 6620 7465 7374 5f72 6570 6c61 6e5f 7365  f test_replan_se
+0000d0d0: 7276 6963 6573 2873 656c 6629 3a0a 2020  rvices(self):.  
+0000d0e0: 2020 2020 2020 7365 6c66 2e5f 7365 7276        self._serv
+0000d0f0: 6963 6573 5f61 6374 696f 6e5f 6865 6c70  ices_action_help
+0000d100: 6572 2827 7265 706c 616e 272c 2073 656c  er('replan', sel
+0000d110: 662e 636c 6965 6e74 2e72 6570 6c61 6e5f  f.client.replan_
+0000d120: 7365 7276 6963 6573 2c20 5b5d 290a 0a20  services, []).. 
+0000d130: 2020 2064 6566 2074 6573 745f 7265 706c     def test_repl
+0000d140: 616e 5f73 6572 7669 6365 735f 6173 796e  an_services_asyn
+0000d150: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+0000d160: 2073 656c 662e 5f73 6572 7669 6365 735f   self._services_
+0000d170: 6163 7469 6f6e 5f61 7379 6e63 5f68 656c  action_async_hel
+0000d180: 7065 7228 2772 6570 6c61 6e27 2c20 7365  per('replan', se
+0000d190: 6c66 2e63 6c69 656e 742e 7265 706c 616e  lf.client.replan
+0000d1a0: 5f73 6572 7669 6365 732c 205b 5d29 0a0a  _services, [])..
+0000d1b0: 2020 2020 6465 6620 7465 7374 5f73 7461      def test_sta
+0000d1c0: 7274 5f73 6572 7669 6365 7328 7365 6c66  rt_services(self
+0000d1d0: 293a 0a20 2020 2020 2020 2064 6566 2061  ):.        def a
+0000d1e0: 7069 5f66 756e 6328 293a 0a20 2020 2020  pi_func():.     
+0000d1f0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000d200: 6c66 2e63 6c69 656e 742e 7374 6172 745f  lf.client.start_
+0000d210: 7365 7276 6963 6573 285b 2773 7663 275d  services(['svc']
+0000d220: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+0000d230: 7365 7276 6963 6573 5f61 6374 696f 6e5f  services_action_
+0000d240: 6865 6c70 6572 2827 7374 6172 7427 2c20  helper('start', 
+0000d250: 6170 695f 6675 6e63 2c20 5b27 7376 6327  api_func, ['svc'
+0000d260: 5d29 0a0a 2020 2020 2020 2020 7769 7468  ])..        with
+0000d270: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000d280: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+0000d290: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d2a0: 636c 6965 6e74 2e73 7461 7274 5f73 6572  client.start_ser
+0000d2b0: 7669 6365 7328 3129 0a0a 2020 2020 2020  vices(1)..      
+0000d2c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0000d2d0: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+0000d2e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000d2f0: 2073 656c 662e 636c 6965 6e74 2e73 7461   self.client.sta
+0000d300: 7274 5f73 6572 7669 6365 7328 5b31 5d29  rt_services([1])
+0000d310: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+0000d320: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000d330: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0000d340: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+0000d350: 6965 6e74 2e73 7461 7274 5f73 6572 7669  ient.start_servi
+0000d360: 6365 7328 5b5b 2766 6f6f 275d 5d29 0a0a  ces([['foo']])..
+0000d370: 2020 2020 6465 6620 7465 7374 5f73 7461      def test_sta
+0000d380: 7274 5f73 6572 7669 6365 735f 6173 796e  rt_services_asyn
+0000d390: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+0000d3a0: 2064 6566 2061 7069 5f66 756e 6328 7469   def api_func(ti
+0000d3b0: 6d65 6f75 743d 3330 293a 0a20 2020 2020  meout=30):.     
+0000d3c0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000d3d0: 6c66 2e63 6c69 656e 742e 7374 6172 745f  lf.client.start_
+0000d3e0: 7365 7276 6963 6573 285b 2773 7663 275d  services(['svc']
+0000d3f0: 2c20 7469 6d65 6f75 743d 7469 6d65 6f75  , timeout=timeou
+0000d400: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0000d410: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
+0000d420: 5f61 7379 6e63 5f68 656c 7065 7228 2773  _async_helper('s
+0000d430: 7461 7274 272c 2061 7069 5f66 756e 632c  tart', api_func,
+0000d440: 205b 2773 7663 275d 290a 0a20 2020 2064   ['svc'])..    d
+0000d450: 6566 2074 6573 745f 7374 6f70 5f73 6572  ef test_stop_ser
+0000d460: 7669 6365 7328 7365 6c66 293a 0a20 2020  vices(self):.   
+0000d470: 2020 2020 2064 6566 2061 7069 5f66 756e       def api_fun
+0000d480: 6328 293a 0a20 2020 2020 2020 2020 2020  c():.           
+0000d490: 2072 6574 7572 6e20 7365 6c66 2e63 6c69   return self.cli
+0000d4a0: 656e 742e 7374 6f70 5f73 6572 7669 6365  ent.stop_service
+0000d4b0: 7328 5b27 7376 6327 5d29 0a20 2020 2020  s(['svc']).     
+0000d4c0: 2020 2073 656c 662e 5f73 6572 7669 6365     self._service
+0000d4d0: 735f 6163 7469 6f6e 5f68 656c 7065 7228  s_action_helper(
+0000d4e0: 2773 746f 7027 2c20 6170 695f 6675 6e63  'stop', api_func
+0000d4f0: 2c20 5b27 7376 6327 5d29 0a0a 2020 2020  , ['svc'])..    
+0000d500: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000d510: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+0000d520: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000d530: 2020 2073 656c 662e 636c 6965 6e74 2e73     self.client.s
+0000d540: 746f 705f 7365 7276 6963 6573 2831 290a  top_services(1).
+0000d550: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000d560: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000d570: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+0000d580: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000d590: 656e 742e 7374 6f70 5f73 6572 7669 6365  ent.stop_service
+0000d5a0: 7328 5b31 5d29 0a0a 2020 2020 2020 2020  s([1])..        
+0000d5b0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000d5c0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+0000d5d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0000d5e0: 656c 662e 636c 6965 6e74 2e73 746f 705f  elf.client.stop_
+0000d5f0: 7365 7276 6963 6573 285b 5b27 666f 6f27  services([['foo'
+0000d600: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
+0000d610: 745f 7374 6f70 5f73 6572 7669 6365 735f  t_stop_services_
+0000d620: 6173 796e 6328 7365 6c66 293a 0a20 2020  async(self):.   
+0000d630: 2020 2020 2064 6566 2061 7069 5f66 756e       def api_fun
+0000d640: 6328 7469 6d65 6f75 743d 3330 293a 0a20  c(timeout=30):. 
+0000d650: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d660: 6e20 7365 6c66 2e63 6c69 656e 742e 7374  n self.client.st
+0000d670: 6f70 5f73 6572 7669 6365 7328 5b27 7376  op_services(['sv
+0000d680: 6327 5d2c 2074 696d 656f 7574 3d74 696d  c'], timeout=tim
+0000d690: 656f 7574 290a 2020 2020 2020 2020 7365  eout).        se
+0000d6a0: 6c66 2e5f 7365 7276 6963 6573 5f61 6374  lf._services_act
+0000d6b0: 696f 6e5f 6173 796e 635f 6865 6c70 6572  ion_async_helper
+0000d6c0: 2827 7374 6f70 272c 2061 7069 5f66 756e  ('stop', api_fun
+0000d6d0: 632c 205b 2773 7663 275d 290a 0a20 2020  c, ['svc'])..   
+0000d6e0: 2064 6566 2074 6573 745f 7265 7374 6172   def test_restar
+0000d6f0: 745f 7365 7276 6963 6573 2873 656c 6629  t_services(self)
+0000d700: 3a0a 2020 2020 2020 2020 6465 6620 6170  :.        def ap
+0000d710: 695f 6675 6e63 2829 3a0a 2020 2020 2020  i_func():.      
+0000d720: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d730: 662e 636c 6965 6e74 2e72 6573 7461 7274  f.client.restart
+0000d740: 5f73 6572 7669 6365 7328 5b27 7376 6327  _services(['svc'
+0000d750: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+0000d760: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
+0000d770: 5f68 656c 7065 7228 2772 6573 7461 7274  _helper('restart
+0000d780: 272c 2061 7069 5f66 756e 632c 205b 2773  ', api_func, ['s
+0000d790: 7663 275d 290a 0a20 2020 2020 2020 2077  vc'])..        w
+0000d7a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000d7b0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0000d7c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000d7d0: 6c66 2e63 6c69 656e 742e 7265 7374 6172  lf.client.restar
+0000d7e0: 745f 7365 7276 6963 6573 2831 290a 0a20  t_services(1).. 
+0000d7f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000d800: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
+0000d810: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
+0000d820: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000d830: 742e 7265 7374 6172 745f 7365 7276 6963  t.restart_servic
+0000d840: 6573 285b 315d 290a 0a20 2020 2020 2020  es([1])..       
+0000d850: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000d860: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0000d870: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d880: 7365 6c66 2e63 6c69 656e 742e 7265 7374  self.client.rest
+0000d890: 6172 745f 7365 7276 6963 6573 285b 5b27  art_services([['
+0000d8a0: 666f 6f27 5d5d 290a 0a20 2020 2064 6566  foo']])..    def
+0000d8b0: 2074 6573 745f 7265 7374 6172 745f 7365   test_restart_se
+0000d8c0: 7276 6963 6573 5f61 7379 6e63 2873 656c  rvices_async(sel
+0000d8d0: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000d8e0: 6170 695f 6675 6e63 2874 696d 656f 7574  api_func(timeout
+0000d8f0: 3d33 3029 3a0a 2020 2020 2020 2020 2020  =30):.          
+0000d900: 2020 7265 7475 726e 2073 656c 662e 636c    return self.cl
+0000d910: 6965 6e74 2e72 6573 7461 7274 5f73 6572  ient.restart_ser
+0000d920: 7669 6365 7328 5b27 7376 6327 5d2c 2074  vices(['svc'], t
+0000d930: 696d 656f 7574 3d74 696d 656f 7574 290a  imeout=timeout).
+0000d940: 2020 2020 2020 2020 7365 6c66 2e5f 7365          self._se
+0000d950: 7276 6963 6573 5f61 6374 696f 6e5f 6173  rvices_action_as
+0000d960: 796e 635f 6865 6c70 6572 2827 7265 7374  ync_helper('rest
+0000d970: 6172 7427 2c20 6170 695f 6675 6e63 2c20  art', api_func, 
+0000d980: 5b27 7376 6327 5d29 0a0a 2020 2020 6465  ['svc'])..    de
+0000d990: 6620 7465 7374 5f63 6861 6e67 655f 6572  f test_change_er
+0000d9a0: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+0000d9b0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+0000d9c0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000d9d0: 7b0a 2020 2020 2020 2020 2020 2020 2263  {.            "c
+0000d9e0: 6861 6e67 6522 3a20 2237 3022 2c0a 2020  hange": "70",.  
+0000d9f0: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+0000da00: 7422 3a20 4e6f 6e65 2c0a 2020 2020 2020  t": None,.      
+0000da10: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+0000da20: 2241 6363 6570 7465 6422 2c0a 2020 2020  "Accepted",.    
+0000da30: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
+0000da40: 636f 6465 223a 2032 3032 2c0a 2020 2020  code": 202,.    
+0000da50: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000da60: 2261 7379 6e63 220a 2020 2020 2020 2020  "async".        
+0000da70: 7d29 0a20 2020 2020 2020 2063 6861 6e67  }).        chang
+0000da80: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
+0000da90: 6861 6e67 655f 6469 6374 2829 0a20 2020  hange_dict().   
+0000daa0: 2020 2020 2063 6861 6e67 655b 2765 7272       change['err
+0000dab0: 275d 203d 2027 536f 6d65 206b 696e 6420  '] = 'Some kind 
+0000dac0: 6f66 2073 6572 7669 6365 2065 7272 6f72  of service error
+0000dad0: 270a 2020 2020 2020 2020 7365 6c66 2e63  '.        self.c
+0000dae0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+0000daf0: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
+0000db00: 2020 2020 2022 7265 7375 6c74 223a 2063       "result": c
+0000db10: 6861 6e67 652c 0a20 2020 2020 2020 2020  hange,.         
+0000db20: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+0000db30: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0000db40: 7374 6174 7573 2d63 6f64 6522 3a20 3230  status-code": 20
+0000db50: 302c 0a20 2020 2020 2020 2020 2020 2022  0,.            "
+0000db60: 7479 7065 223a 2022 7379 6e63 220a 2020  type": "sync".  
+0000db70: 2020 2020 2020 7d29 0a20 2020 2020 2020        }).       
+0000db80: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000db90: 7452 6169 7365 7328 7065 6262 6c65 2e43  tRaises(pebble.C
+0000dba0: 6861 6e67 6545 7272 6f72 2920 6173 2063  hangeError) as c
+0000dbb0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
+0000dbc0: 656c 662e 636c 6965 6e74 2e61 7574 6f73  elf.client.autos
+0000dbd0: 7461 7274 5f73 6572 7669 6365 7328 290a  tart_services().
+0000dbe0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000dbf0: 6572 7449 7349 6e73 7461 6e63 6528 636d  ertIsInstance(cm
+0000dc00: 2e65 7863 6570 7469 6f6e 2c20 7065 6262  .exception, pebb
+0000dc10: 6c65 2e45 7272 6f72 290a 2020 2020 2020  le.Error).      
+0000dc20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000dc30: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
+0000dc40: 6572 722c 2027 536f 6d65 206b 696e 6420  err, 'Some kind 
+0000dc50: 6f66 2073 6572 7669 6365 2065 7272 6f72  of service error
+0000dc60: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000dc70: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
+0000dc80: 2863 6d2e 6578 6365 7074 696f 6e2e 6368  (cm.exception.ch
+0000dc90: 616e 6765 2c20 7065 6262 6c65 2e43 6861  ange, pebble.Cha
+0000dca0: 6e67 6529 0a20 2020 2020 2020 2073 656c  nge).        sel
+0000dcb0: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+0000dcc0: 2e65 7863 6570 7469 6f6e 2e63 6861 6e67  .exception.chang
+0000dcd0: 652e 6964 2c20 2737 3027 290a 0a20 2020  e.id, '70')..   
+0000dce0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000dcf0: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0000dd00: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0000dd10: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+0000dd20: 272c 2027 2f76 312f 7365 7276 6963 6573  ', '/v1/services
+0000dd30: 272c 204e 6f6e 652c 207b 2761 6374 696f  ', None, {'actio
+0000dd40: 6e27 3a20 2761 7574 6f73 7461 7274 272c  n': 'autostart',
+0000dd50: 2027 7365 7276 6963 6573 273a 205b 5d7d   'services': []}
+0000dd60: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000dd70: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000dd80: 6765 732f 3730 2f77 6169 7427 2c20 7b27  ges/70/wait', {'
+0000dd90: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
+0000dda0: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0000ddb0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0000ddc0: 7465 7374 5f77 6169 745f 6368 616e 6765  test_wait_change
+0000ddd0: 5f73 7563 6365 7373 2873 656c 662c 2074  _success(self, t
+0000dde0: 696d 656f 7574 3d33 302e 3029 3a0a 2020  imeout=30.0):.  
+0000ddf0: 2020 2020 2020 6368 616e 6765 203d 2062        change = b
+0000de00: 7569 6c64 5f6d 6f63 6b5f 6368 616e 6765  uild_mock_change
+0000de10: 5f64 6963 7428 290a 2020 2020 2020 2020  _dict().        
+0000de20: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
+0000de30: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
+0000de40: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+0000de50: 6c74 223a 2063 6861 6e67 652c 0a20 2020  lt": change,.   
+0000de60: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+0000de70: 223a 2022 4f4b 222c 0a20 2020 2020 2020  ": "OK",.       
+0000de80: 2020 2020 2022 7374 6174 7573 2d63 6f64       "status-cod
+0000de90: 6522 3a20 3230 302c 0a20 2020 2020 2020  e": 200,.       
+0000dea0: 2020 2020 2022 7479 7065 223a 2022 7379       "type": "sy
+0000deb0: 6e63 220a 2020 2020 2020 2020 7d29 0a0a  nc".        })..
+0000dec0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000ded0: 203d 2073 656c 662e 636c 6965 6e74 2e77   = self.client.w
+0000dee0: 6169 745f 6368 616e 6765 2827 3730 272c  ait_change('70',
+0000def0: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
+0000df00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000df10: 7373 6572 7445 7175 616c 2872 6573 706f  ssertEqual(respo
+0000df20: 6e73 652e 6964 2c20 2737 3027 290a 2020  nse.id, '70').  
+0000df30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000df40: 7454 7275 6528 7265 7370 6f6e 7365 2e72  tTrue(response.r
+0000df50: 6561 6479 290a 0a20 2020 2020 2020 2073  eady)..        s
+0000df60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000df70: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+0000df80: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0000df90: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+0000dfa0: 2f63 6861 6e67 6573 2f37 302f 7761 6974  /changes/70/wait
+0000dfb0: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+0000dfc0: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+0000dfd0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+0000dfe0: 2064 6566 2074 6573 745f 7761 6974 5f63   def test_wait_c
+0000dff0: 6861 6e67 655f 7375 6363 6573 735f 7469  hange_success_ti
+0000e000: 6d65 6f75 745f 6e6f 6e65 2873 656c 6629  meout_none(self)
+0000e010: 3a0a 2020 2020 2020 2020 7365 6c66 2e74  :.        self.t
+0000e020: 6573 745f 7761 6974 5f63 6861 6e67 655f  est_wait_change_
+0000e030: 7375 6363 6573 7328 7469 6d65 6f75 743d  success(timeout=
+0000e040: 4e6f 6e65 290a 0a20 2020 2064 6566 2074  None)..    def t
+0000e050: 6573 745f 7761 6974 5f63 6861 6e67 655f  est_wait_change_
+0000e060: 7375 6363 6573 735f 6d75 6c74 6970 6c65  success_multiple
+0000e070: 5f63 616c 6c73 2873 656c 6629 3a0a 2020  _calls(self):.  
+0000e080: 2020 2020 2020 6465 6620 7469 6d65 6f75        def timeou
+0000e090: 745f 7265 7370 6f6e 7365 286e 293a 0a20  t_response(n):. 
+0000e0a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000e0b0: 7469 6d65 2e73 6c65 6570 286e 2920 2023  time.sleep(n)  #
+0000e0c0: 2073 696d 756c 6174 6520 7061 7373 696e   simulate passin
+0000e0d0: 6720 6f66 2074 696d 6520 6475 6520 746f  g of time due to
+0000e0e0: 2077 6169 745f 6368 616e 6765 2063 616c   wait_change cal
+0000e0f0: 6c0a 2020 2020 2020 2020 2020 2020 7261  l.            ra
+0000e100: 6973 6520 7065 6262 6c65 2e41 5049 4572  ise pebble.APIEr
+0000e110: 726f 7228 7b7d 2c20 3530 342c 2022 4761  ror({}, 504, "Ga
+0000e120: 7465 7761 7920 5469 6d65 6f75 7422 2c20  teway Timeout", 
+0000e130: 2274 696d 6564 206f 7574 2229 0a0a 2020  "timed out")..  
+0000e140: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000e150: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000e160: 6e64 286c 616d 6264 613a 2074 696d 656f  nd(lambda: timeo
+0000e170: 7574 5f72 6573 706f 6e73 6528 3429 290a  ut_response(4)).
+0000e180: 0a20 2020 2020 2020 2063 6861 6e67 6520  .        change 
+0000e190: 3d20 6275 696c 645f 6d6f 636b 5f63 6861  = build_mock_cha
+0000e1a0: 6e67 655f 6469 6374 2829 0a20 2020 2020  nge_dict().     
+0000e1b0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+0000e1c0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000e1d0: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+0000e1e0: 6573 756c 7422 3a20 6368 616e 6765 2c0a  esult": change,.
+0000e1f0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000e200: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
+0000e210: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
+0000e220: 636f 6465 223a 2032 3030 2c0a 2020 2020  code": 200,.    
+0000e230: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000e240: 2273 796e 6322 0a20 2020 2020 2020 207d  "sync".        }
+0000e250: 290a 0a20 2020 2020 2020 2072 6573 706f  )..        respo
+0000e260: 6e73 6520 3d20 7365 6c66 2e63 6c69 656e  nse = self.clien
+0000e270: 742e 7761 6974 5f63 6861 6e67 6528 2737  t.wait_change('7
+0000e280: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
+0000e290: 2e61 7373 6572 7445 7175 616c 2872 6573  .assertEqual(res
+0000e2a0: 706f 6e73 652e 6964 2c20 2737 3027 290a  ponse.id, '70').
+0000e2b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000e2c0: 6572 7454 7275 6528 7265 7370 6f6e 7365  ertTrue(response
+0000e2d0: 2e72 6561 6479 290a 0a20 2020 2020 2020  .ready)..       
+0000e2e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000e2f0: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+0000e300: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+0000e310: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+0000e320: 7631 2f63 6861 6e67 6573 2f37 302f 7761  v1/changes/70/wa
+0000e330: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
+0000e340: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
+0000e350: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000e360: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000e370: 6765 732f 3730 2f77 6169 7427 2c20 7b27  ges/70/wait', {'
+0000e380: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
+0000e390: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0000e3a0: 2020 2020 5d29 0a0a 2020 2020 2020 2020      ])..        
+0000e3b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e3c0: 2873 656c 662e 7469 6d65 2e74 696d 6528  (self.time.time(
+0000e3d0: 292c 2034 290a 0a20 2020 2064 6566 2074  ), 4)..    def t
+0000e3e0: 6573 745f 7761 6974 5f63 6861 6e67 655f  est_wait_change_
+0000e3f0: 7375 6363 6573 735f 706f 6c6c 6564 2873  success_polled(s
+0000e400: 656c 662c 2074 696d 656f 7574 3d33 302e  elf, timeout=30.
+0000e410: 3029 3a0a 2020 2020 2020 2020 2320 5472  0):.        # Tr
+0000e420: 6967 6765 7220 706f 6c6c 6564 206d 6f64  igger polled mod
+0000e430: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
+0000e440: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+0000e450: 6170 7065 6e64 2870 6562 626c 652e 4150  append(pebble.AP
+0000e460: 4945 7272 6f72 287b 7d2c 2034 3034 2c20  IError({}, 404, 
+0000e470: 224e 6f74 2046 6f75 6e64 222c 2022 6e6f  "Not Found", "no
+0000e480: 7420 666f 756e 6422 2929 0a0a 2020 2020  t found"))..    
+0000e490: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000e4a0: 6765 2833 293a 0a20 2020 2020 2020 2020  ge(3):.         
+0000e4b0: 2020 2063 6861 6e67 6520 3d20 6275 696c     change = buil
+0000e4c0: 645f 6d6f 636b 5f63 6861 6e67 655f 6469  d_mock_change_di
+0000e4d0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0000e4e0: 2063 6861 6e67 655b 2772 6561 6479 275d   change['ready']
+0000e4f0: 203d 2069 203d 3d20 320a 2020 2020 2020   = i == 2.      
+0000e500: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000e510: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000e520: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+0000e530: 2020 2020 2022 7265 7375 6c74 223a 2063       "result": c
+0000e540: 6861 6e67 652c 0a20 2020 2020 2020 2020  hange,.         
+0000e550: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+0000e560: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
+0000e570: 2020 2020 2020 2022 7374 6174 7573 2d63         "status-c
+0000e580: 6f64 6522 3a20 3230 302c 0a20 2020 2020  ode": 200,.     
+0000e590: 2020 2020 2020 2020 2020 2022 7479 7065             "type
+0000e5a0: 223a 2022 7379 6e63 220a 2020 2020 2020  ": "sync".      
+0000e5b0: 2020 2020 2020 7d29 0a0a 2020 2020 2020        })..      
+0000e5c0: 2020 7265 7370 6f6e 7365 203d 2073 656c    response = sel
+0000e5d0: 662e 636c 6965 6e74 2e77 6169 745f 6368  f.client.wait_ch
+0000e5e0: 616e 6765 2827 3730 272c 2074 696d 656f  ange('70', timeo
+0000e5f0: 7574 3d74 696d 656f 7574 2c20 6465 6c61  ut=timeout, dela
+0000e600: 793d 3129 0a20 2020 2020 2020 2073 656c  y=1).        sel
+0000e610: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
+0000e620: 7370 6f6e 7365 2e69 642c 2027 3730 2729  sponse.id, '70')
+0000e630: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e640: 7365 7274 5472 7565 2872 6573 706f 6e73  sertTrue(respons
+0000e650: 652e 7265 6164 7929 0a0a 2020 2020 2020  e.ready)..      
+0000e660: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000e670: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0000e680: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0000e690: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+0000e6a0: 2f76 312f 6368 616e 6765 732f 3730 2f77  /v1/changes/70/w
+0000e6b0: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
+0000e6c0: 3a20 2734 2e30 3030 7327 7d2c 204e 6f6e  : '4.000s'}, Non
+0000e6d0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0000e6e0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+0000e6f0: 6e67 6573 2f37 3027 2c20 4e6f 6e65 2c20  nges/70', None, 
+0000e700: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000e710: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000e720: 6368 616e 6765 732f 3730 272c 204e 6f6e  changes/70', Non
+0000e730: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
+0000e740: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+0000e750: 7631 2f63 6861 6e67 6573 2f37 3027 2c20  v1/changes/70', 
+0000e760: 4e6f 6e65 2c20 4e6f 6e65 292c 0a20 2020  None, None),.   
+0000e770: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
+0000e780: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000e790: 6c28 7365 6c66 2e74 696d 652e 7469 6d65  l(self.time.time
+0000e7a0: 2829 2c20 3229 0a0a 2020 2020 6465 6620  (), 2)..    def 
+0000e7b0: 7465 7374 5f77 6169 745f 6368 616e 6765  test_wait_change
+0000e7c0: 5f73 7563 6365 7373 5f70 6f6c 6c65 645f  _success_polled_
+0000e7d0: 7469 6d65 6f75 745f 6e6f 6e65 2873 656c  timeout_none(sel
+0000e7e0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000e7f0: 2e74 6573 745f 7761 6974 5f63 6861 6e67  .test_wait_chang
+0000e800: 655f 7375 6363 6573 735f 706f 6c6c 6564  e_success_polled
+0000e810: 2874 696d 656f 7574 3d4e 6f6e 6529 0a0a  (timeout=None)..
+0000e820: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
+0000e830: 745f 6368 616e 6765 5f74 696d 656f 7574  t_change_timeout
+0000e840: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000e850: 6465 6620 7469 6d65 6f75 745f 7265 7370  def timeout_resp
+0000e860: 6f6e 7365 286e 293a 0a20 2020 2020 2020  onse(n):.       
+0000e870: 2020 2020 2073 656c 662e 7469 6d65 2e73       self.time.s
+0000e880: 6c65 6570 286e 2920 2023 2073 696d 756c  leep(n)  # simul
+0000e890: 6174 6520 7061 7373 696e 6720 6f66 2074  ate passing of t
+0000e8a0: 696d 6520 6475 6520 746f 2077 6169 745f  ime due to wait_
+0000e8b0: 6368 616e 6765 2063 616c 6c0a 2020 2020  change call.    
+0000e8c0: 2020 2020 2020 2020 7261 6973 6520 7065          raise pe
+0000e8d0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
+0000e8e0: 2c20 3530 342c 2022 4761 7465 7761 7920  , 504, "Gateway 
+0000e8f0: 5469 6d65 6f75 7422 2c20 2274 696d 6564  Timeout", "timed
+0000e900: 206f 7574 2229 0a0a 2020 2020 2020 2020   out")..        
+0000e910: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
+0000e920: 6f6e 7365 732e 6170 7065 6e64 286c 616d  onses.append(lam
+0000e930: 6264 613a 2074 696d 656f 7574 5f72 6573  bda: timeout_res
+0000e940: 706f 6e73 6528 3429 290a 2020 2020 2020  ponse(4)).      
+0000e950: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000e960: 7370 6f6e 7365 732e 6170 7065 6e64 286c  sponses.append(l
+0000e970: 616d 6264 613a 2074 696d 656f 7574 5f72  ambda: timeout_r
+0000e980: 6573 706f 6e73 6528 3229 290a 0a20 2020  esponse(2))..   
+0000e990: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000e9a0: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
+0000e9b0: 6c65 2e54 696d 656f 7574 4572 726f 7229  le.TimeoutError)
+0000e9c0: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
+0000e9d0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000e9e0: 7761 6974 5f63 6861 6e67 6528 2737 3027  wait_change('70'
+0000e9f0: 2c20 7469 6d65 6f75 743d 3629 0a20 2020  , timeout=6).   
+0000ea00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000ea10: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
+0000ea20: 6365 7074 696f 6e2c 2070 6562 626c 652e  ception, pebble.
+0000ea30: 4572 726f 7229 0a20 2020 2020 2020 2073  Error).        s
+0000ea40: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0000ea50: 616e 6365 2863 6d2e 6578 6365 7074 696f  ance(cm.exceptio
+0000ea60: 6e2c 2054 696d 656f 7574 4572 726f 7229  n, TimeoutError)
+0000ea70: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0000ea80: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000ea90: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+0000eaa0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000eab0: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000eac0: 6765 732f 3730 2f77 6169 7427 2c20 7b27  ges/70/wait', {'
+0000ead0: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
+0000eae0: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0000eaf0: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+0000eb00: 272f 7631 2f63 6861 6e67 6573 2f37 302f  '/v1/changes/70/
+0000eb10: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
+0000eb20: 273a 2027 322e 3030 3073 277d 2c20 4e6f  ': '2.000s'}, No
+0000eb30: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+0000eb40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000eb50: 7365 7274 4571 7561 6c28 7365 6c66 2e74  sertEqual(self.t
+0000eb60: 696d 652e 7469 6d65 2829 2c20 3629 0a0a  ime.time(), 6)..
+0000eb70: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
+0000eb80: 745f 6368 616e 6765 5f74 696d 656f 7574  t_change_timeout
+0000eb90: 5f70 6f6c 6c65 6428 7365 6c66 293a 0a20  _polled(self):. 
+0000eba0: 2020 2020 2020 2023 2054 7269 6767 6572         # Trigger
+0000ebb0: 2070 6f6c 6c65 6420 6d6f 6465 0a20 2020   polled mode.   
+0000ebc0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000ebd0: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000ebe0: 6428 7065 6262 6c65 2e41 5049 4572 726f  d(pebble.APIErro
+0000ebf0: 7228 7b7d 2c20 3430 342c 2022 4e6f 7420  r({}, 404, "Not 
+0000ec00: 466f 756e 6422 2c20 226e 6f74 2066 6f75  Found", "not fou
+0000ec10: 6e64 2229 290a 0a20 2020 2020 2020 2063  nd"))..        c
+0000ec20: 6861 6e67 6520 3d20 6275 696c 645f 6d6f  hange = build_mo
+0000ec30: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
+0000ec40: 0a20 2020 2020 2020 2063 6861 6e67 655b  .        change[
+0000ec50: 2772 6561 6479 275d 203d 2046 616c 7365  'ready'] = False
+0000ec60: 0a20 2020 2020 2020 2066 6f72 205f 2069  .        for _ i
+0000ec70: 6e20 7261 6e67 6528 3329 3a0a 2020 2020  n range(3):.    
+0000ec80: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000ec90: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000eca0: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+0000ecb0: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
+0000ecc0: 2063 6861 6e67 652c 0a20 2020 2020 2020   change,.       
+0000ecd0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+0000ece0: 223a 2022 4f4b 222c 0a20 2020 2020 2020  ": "OK",.       
+0000ecf0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+0000ed00: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
+0000ed10: 2020 2020 2020 2020 2020 2020 2022 7479               "ty
+0000ed20: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
+0000ed30: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+0000ed40: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000ed50: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
+0000ed60: 652e 5469 6d65 6f75 7445 7272 6f72 2920  e.TimeoutError) 
+0000ed70: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+0000ed80: 2020 2073 656c 662e 636c 6965 6e74 2e77     self.client.w
+0000ed90: 6169 745f 6368 616e 6765 2827 3730 272c  ait_change('70',
+0000eda0: 2074 696d 656f 7574 3d33 2c20 6465 6c61   timeout=3, dela
+0000edb0: 793d 3129 0a20 2020 2020 2020 2073 656c  y=1).        sel
+0000edc0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+0000edd0: 6365 2863 6d2e 6578 6365 7074 696f 6e2c  ce(cm.exception,
+0000ede0: 2070 6562 626c 652e 4572 726f 7229 0a20   pebble.Error). 
+0000edf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ee00: 7274 4973 496e 7374 616e 6365 2863 6d2e  rtIsInstance(cm.
+0000ee10: 6578 6365 7074 696f 6e2c 2054 696d 656f  exception, Timeo
+0000ee20: 7574 4572 726f 7229 0a0a 2020 2020 2020  utError)..      
+0000ee30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ee40: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0000ee50: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0000ee60: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+0000ee70: 2f76 312f 6368 616e 6765 732f 3730 2f77  /v1/changes/70/w
+0000ee80: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
+0000ee90: 3a20 2733 2e30 3030 7327 7d2c 204e 6f6e  : '3.000s'}, Non
+0000eea0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0000eeb0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+0000eec0: 6e67 6573 2f37 3027 2c20 4e6f 6e65 2c20  nges/70', None, 
+0000eed0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000eee0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000eef0: 6368 616e 6765 732f 3730 272c 204e 6f6e  changes/70', Non
+0000ef00: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
+0000ef10: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+0000ef20: 7631 2f63 6861 6e67 6573 2f37 3027 2c20  v1/changes/70', 
+0000ef30: 4e6f 6e65 2c20 4e6f 6e65 292c 0a20 2020  None, None),.   
+0000ef40: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
+0000ef50: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ef60: 6c28 7365 6c66 2e74 696d 652e 7469 6d65  l(self.time.time
+0000ef70: 2829 2c20 3329 0a0a 2020 2020 6465 6620  (), 3)..    def 
+0000ef80: 7465 7374 5f77 6169 745f 6368 616e 6765  test_wait_change
+0000ef90: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
+0000efa0: 2020 2020 2020 6368 616e 6765 203d 2062        change = b
+0000efb0: 7569 6c64 5f6d 6f63 6b5f 6368 616e 6765  uild_mock_change
+0000efc0: 5f64 6963 7428 290a 2020 2020 2020 2020  _dict().        
+0000efd0: 6368 616e 6765 5b27 6572 7227 5d20 3d20  change['err'] = 
+0000efe0: 2753 6f6d 6520 6b69 6e64 206f 6620 7365  'Some kind of se
+0000eff0: 7276 6963 6520 6572 726f 7227 0a20 2020  rvice error'.   
+0000f000: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000f010: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+0000f020: 6428 7b0a 2020 2020 2020 2020 2020 2020  d({.            
+0000f030: 2272 6573 756c 7422 3a20 6368 616e 6765  "result": change
+0000f040: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000f050: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+0000f060: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000f070: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+0000f080: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+0000f090: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+0000f0a0: 207d 290a 2020 2020 2020 2020 2320 7761   }).        # wa
+0000f0b0: 6974 5f63 6861 6e67 6528 2920 6974 7365  it_change() itse
+0000f0c0: 6c66 2073 686f 756c 646e 2774 2072 6169  lf shouldn't rai
+0000f0d0: 7365 2061 6e20 6572 726f 720a 2020 2020  se an error.    
+0000f0e0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
+0000f0f0: 656c 662e 636c 6965 6e74 2e77 6169 745f  elf.client.wait_
+0000f100: 6368 616e 6765 2827 3730 2729 0a20 2020  change('70').   
+0000f110: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000f120: 4571 7561 6c28 7265 7370 6f6e 7365 2e69  Equal(response.i
+0000f130: 642c 2027 3730 2729 0a20 2020 2020 2020  d, '70').       
+0000f140: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f150: 6c28 7265 7370 6f6e 7365 2e65 7272 2c20  l(response.err, 
+0000f160: 2753 6f6d 6520 6b69 6e64 206f 6620 7365  'Some kind of se
+0000f170: 7276 6963 6520 6572 726f 7227 290a 0a20  rvice error').. 
+0000f180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f190: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+0000f1a0: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+0000f1b0: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0000f1c0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0000f1d0: 2f37 302f 7761 6974 272c 207b 2774 696d  /70/wait', {'tim
+0000f1e0: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
+0000f1f0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0000f200: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0000f210: 745f 6164 645f 6c61 7965 7228 7365 6c66  t_add_layer(self
+0000f220: 293a 0a20 2020 2020 2020 206f 6b61 795f  ):.        okay_
+0000f230: 7265 7370 6f6e 7365 203d 207b 0a20 2020  response = {.   
+0000f240: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
+0000f250: 223a 2054 7275 652c 0a20 2020 2020 2020  ": True,.       
+0000f260: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+0000f270: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
+0000f280: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
+0000f290: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
+0000f2a0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+0000f2b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0000f2c0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000f2d0: 7370 6f6e 7365 732e 6170 7065 6e64 286f  sponses.append(o
+0000f2e0: 6b61 795f 7265 7370 6f6e 7365 290a 2020  kay_response).  
+0000f2f0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000f300: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000f310: 6e64 286f 6b61 795f 7265 7370 6f6e 7365  nd(okay_response
+0000f320: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000f330: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+0000f340: 6170 7065 6e64 286f 6b61 795f 7265 7370  append(okay_resp
+0000f350: 6f6e 7365 290a 2020 2020 2020 2020 7365  onse).        se
+0000f360: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+0000f370: 7365 732e 6170 7065 6e64 286f 6b61 795f  ses.append(okay_
+0000f380: 7265 7370 6f6e 7365 290a 0a20 2020 2020  response)..     
+0000f390: 2020 206c 6179 6572 5f79 616d 6c20 3d20     layer_yaml = 
+0000f3a0: 2222 220a 7365 7276 6963 6573 3a0a 2020  """.services:.  
+0000f3b0: 666f 6f3a 0a20 2020 2063 6f6d 6d61 6e64  foo:.    command
+0000f3c0: 3a20 6563 686f 2062 6172 0a20 2020 206f  : echo bar.    o
+0000f3d0: 7665 7272 6964 653a 2072 6570 6c61 6365  verride: replace
+0000f3e0: 0a22 2222 5b31 3a5d 0a20 2020 2020 2020  ."""[1:].       
+0000f3f0: 206c 6179 6572 203d 2070 6562 626c 652e   layer = pebble.
+0000f400: 4c61 7965 7228 6c61 7965 725f 7961 6d6c  Layer(layer_yaml
+0000f410: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000f420: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
+0000f430: 2827 6127 2c20 6c61 7965 7229 0a20 2020  ('a', layer).   
+0000f440: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000f450: 2e61 6464 5f6c 6179 6572 2827 6227 2c20  .add_layer('b', 
+0000f460: 6c61 7965 722e 746f 5f79 616d 6c28 2929  layer.to_yaml())
+0000f470: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000f480: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+0000f490: 6327 2c20 6c61 7965 722e 746f 5f64 6963  c', layer.to_dic
+0000f4a0: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
+0000f4b0: 662e 636c 6965 6e74 2e61 6464 5f6c 6179  f.client.add_lay
+0000f4c0: 6572 2827 6427 2c20 6c61 7965 722c 2063  er('d', layer, c
+0000f4d0: 6f6d 6269 6e65 3d54 7275 6529 0a0a 2020  ombine=True)..  
+0000f4e0: 2020 2020 2020 6465 6620 6275 696c 645f        def build_
+0000f4f0: 6578 7065 6374 6564 286c 6162 656c 2c20  expected(label, 
+0000f500: 636f 6d62 696e 6529 3a0a 2020 2020 2020  combine):.      
+0000f510: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+0000f520: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000f530: 6163 7469 6f6e 273a 2027 6164 6427 2c0a  action': 'add',.
+0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f550: 2763 6f6d 6269 6e65 273a 2063 6f6d 6269  'combine': combi
+0000f560: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0000f570: 2020 2020 276c 6162 656c 273a 206c 6162      'label': lab
+0000f580: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
+0000f590: 2020 2020 2766 6f72 6d61 7427 3a20 2779      'format': 'y
+0000f5a0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000f5b0: 2020 2020 2020 276c 6179 6572 273a 206c        'layer': l
+0000f5c0: 6179 6572 5f79 616d 6c2c 0a20 2020 2020  ayer_yaml,.     
+0000f5d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0000f5e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000f5f0: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0000f600: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0000f610: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+0000f620: 272f 7631 2f6c 6179 6572 7327 2c20 4e6f  '/v1/layers', No
+0000f630: 6e65 2c20 6275 696c 645f 6578 7065 6374  ne, build_expect
+0000f640: 6564 2827 6127 2c20 4661 6c73 6529 292c  ed('a', False)),
+0000f650: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+0000f660: 4f53 5427 2c20 272f 7631 2f6c 6179 6572  OST', '/v1/layer
+0000f670: 7327 2c20 4e6f 6e65 2c20 6275 696c 645f  s', None, build_
+0000f680: 6578 7065 6374 6564 2827 6227 2c20 4661  expected('b', Fa
+0000f690: 6c73 6529 292c 0a20 2020 2020 2020 2020  lse)),.         
+0000f6a0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+0000f6b0: 2f6c 6179 6572 7327 2c20 4e6f 6e65 2c20  /layers', None, 
+0000f6c0: 6275 696c 645f 6578 7065 6374 6564 2827  build_expected('
+0000f6d0: 6327 2c20 4661 6c73 6529 292c 0a20 2020  c', False)),.   
+0000f6e0: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
+0000f6f0: 2c20 272f 7631 2f6c 6179 6572 7327 2c20  , '/v1/layers', 
+0000f700: 4e6f 6e65 2c20 6275 696c 645f 6578 7065  None, build_expe
+0000f710: 6374 6564 2827 6427 2c20 5472 7565 2929  cted('d', True))
+0000f720: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+0000f730: 2020 6465 6620 7465 7374 5f61 6464 5f6c    def test_add_l
+0000f740: 6179 6572 5f69 6e76 616c 6964 5f74 7970  ayer_invalid_typ
+0000f750: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0000f760: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000f770: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0000f780: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000f790: 7365 6c66 2e63 6c69 656e 742e 6164 645f  self.client.add_
+0000f7a0: 6c61 7965 7228 2766 6f6f 272c 2034 3229  layer('foo', 42)
+0000f7b0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000f7c0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000f7d0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+0000f7e0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000f7f0: 656e 742e 6164 645f 6c61 7965 7228 3432  ent.add_layer(42
+0000f800: 2c20 2766 6f6f 2729 0a0a 2020 2020 2020  , 'foo')..      
+0000f810: 2020 2320 636f 6d62 696e 6520 6973 2061    # combine is a
+0000f820: 206b 6579 776f 7264 2d6f 6e6c 7920 6172   keyword-only ar
+0000f830: 6720 2873 686f 756c 6420 6265 2063 6f6d  g (should be com
+0000f840: 6269 6e65 3d54 7275 6529 0a20 2020 2020  bine=True).     
+0000f850: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000f860: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+0000f870: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000f880: 2020 7365 6c66 2e63 6c69 656e 742e 6164    self.client.ad
+0000f890: 645f 6c61 7965 7228 2766 6f6f 272c 207b  d_layer('foo', {
+0000f8a0: 7d2c 2054 7275 6529 0a0a 2020 2020 6465  }, True)..    de
+0000f8b0: 6620 7465 7374 5f67 6574 5f70 6c61 6e28  f test_get_plan(
+0000f8c0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+0000f8d0: 6c61 6e5f 7961 6d6c 203d 2022 2222 0a73  lan_yaml = """.s
+0000f8e0: 6572 7669 6365 733a 0a20 2066 6f6f 3a0a  ervices:.  foo:.
+0000f8f0: 2020 2020 636f 6d6d 616e 643a 2065 6368      command: ech
+0000f900: 6f20 6261 720a 2020 2020 6f76 6572 7269  o bar.    overri
+0000f910: 6465 3a20 7265 706c 6163 650a 2222 225b  de: replace."""[
+0000f920: 313a 5d0a 2020 2020 2020 2020 7365 6c66  1:].        self
+0000f930: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
+0000f940: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
+0000f950: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
+0000f960: 2070 6c61 6e5f 7961 6d6c 2c0a 2020 2020   plan_yaml,.    
+0000f970: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0000f980: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
+0000f990: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
+0000f9a0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
+0000f9b0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
+0000f9c0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
+0000f9d0: 2020 2020 2020 706c 616e 203d 2073 656c        plan = sel
+0000f9e0: 662e 636c 6965 6e74 2e67 6574 5f70 6c61  f.client.get_pla
+0000f9f0: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+0000fa00: 2e61 7373 6572 7445 7175 616c 2870 6c61  .assertEqual(pla
+0000fa10: 6e2e 746f 5f79 616d 6c28 292c 2070 6c61  n.to_yaml(), pla
+0000fa20: 6e5f 7961 6d6c 290a 2020 2020 2020 2020  n_yaml).        
+0000fa30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000fa40: 286c 656e 2870 6c61 6e2e 7365 7276 6963  (len(plan.servic
+0000fa50: 6573 292c 2031 290a 2020 2020 2020 2020  es), 1).        
+0000fa60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000fa70: 2870 6c61 6e2e 7365 7276 6963 6573 5b27  (plan.services['
+0000fa80: 666f 6f27 5d2e 636f 6d6d 616e 642c 2027  foo'].command, '
+0000fa90: 6563 686f 2062 6172 2729 0a20 2020 2020  echo bar').     
+0000faa0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000fab0: 7561 6c28 706c 616e 2e73 6572 7669 6365  ual(plan.service
+0000fac0: 735b 2766 6f6f 275d 2e6f 7665 7272 6964  s['foo'].overrid
+0000fad0: 652c 2027 7265 706c 6163 6527 290a 0a20  e, 'replace').. 
+0000fae0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000faf0: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+0000fb00: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+0000fb10: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0000fb20: 5427 2c20 272f 7631 2f70 6c61 6e27 2c20  T', '/v1/plan', 
+0000fb30: 7b27 666f 726d 6174 273a 2027 7961 6d6c  {'format': 'yaml
+0000fb40: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+0000fb50: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0000fb60: 6573 745f 6765 745f 7365 7276 6963 6573  est_get_services
+0000fb70: 5f61 6c6c 2873 656c 6629 3a0a 2020 2020  _all(self):.    
+0000fb80: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000fb90: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000fba0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+0000fbb0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
+0000fbc0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0000fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbe0: 2022 6375 7272 656e 7422 3a20 2269 6e61   "current": "ina
+0000fbf0: 6374 6976 6522 2c0a 2020 2020 2020 2020  ctive",.        
+0000fc00: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
+0000fc10: 6522 3a20 2273 7663 3122 2c0a 2020 2020  e": "svc1",.    
+0000fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc30: 2273 7461 7274 7570 223a 2022 6469 7361  "startup": "disa
+0000fc40: 626c 6564 220a 2020 2020 2020 2020 2020  bled".          
+0000fc50: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0000fc60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0000fc70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000fc80: 6375 7272 656e 7422 3a20 2261 6374 6976  current": "activ
+0000fc90: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000fca0: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+0000fcb0: 2273 7663 3222 2c0a 2020 2020 2020 2020  "svc2",.        
+0000fcc0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000fcd0: 7274 7570 223a 2022 656e 6162 6c65 6422  rtup": "enabled"
+0000fce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fcf0: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
+0000fd00: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000fd10: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+0000fd20: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000fd30: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+0000fd40: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+0000fd50: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+0000fd60: 207d 290a 2020 2020 2020 2020 7365 7276   }).        serv
+0000fd70: 6963 6573 203d 2073 656c 662e 636c 6965  ices = self.clie
+0000fd80: 6e74 2e67 6574 5f73 6572 7669 6365 7328  nt.get_services(
+0000fd90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000fda0: 7373 6572 7445 7175 616c 286c 656e 2873  ssertEqual(len(s
+0000fdb0: 6572 7669 6365 7329 2c20 3229 0a20 2020  ervices), 2).   
+0000fdc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000fdd0: 4571 7561 6c28 7365 7276 6963 6573 5b30  Equal(services[0
+0000fde0: 5d2e 6e61 6d65 2c20 2773 7663 3127 290a  ].name, 'svc1').
+0000fdf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000fe00: 6572 7445 7175 616c 2873 6572 7669 6365  ertEqual(service
+0000fe10: 735b 305d 2e73 7461 7274 7570 2c20 7065  s[0].startup, pe
+0000fe20: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
+0000fe30: 7475 702e 4449 5341 424c 4544 290a 2020  tup.DISABLED).  
+0000fe40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000fe50: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+0000fe60: 305d 2e63 7572 7265 6e74 2c20 7065 6262  0].current, pebb
+0000fe70: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+0000fe80: 2e49 4e41 4354 4956 4529 0a20 2020 2020  .INACTIVE).     
+0000fe90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000fea0: 7561 6c28 7365 7276 6963 6573 5b31 5d2e  ual(services[1].
+0000feb0: 6e61 6d65 2c20 2773 7663 3227 290a 2020  name, 'svc2').  
+0000fec0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000fed0: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+0000fee0: 315d 2e73 7461 7274 7570 2c20 7065 6262  1].startup, pebb
+0000fef0: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
+0000ff00: 702e 454e 4142 4c45 4429 0a20 2020 2020  p.ENABLED).     
+0000ff10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ff20: 7561 6c28 7365 7276 6963 6573 5b31 5d2e  ual(services[1].
+0000ff30: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+0000ff40: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
+0000ff50: 5449 5645 290a 0a20 2020 2020 2020 2073  TIVE)..        s
+0000ff60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000ff70: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+0000ff80: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0000ff90: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+0000ffa0: 2f73 6572 7669 6365 7327 2c20 4e6f 6e65  /services', None
+0000ffb0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0000ffc0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0000ffd0: 745f 6765 745f 7365 7276 6963 6573 5f6e  t_get_services_n
+0000ffe0: 616d 6573 2873 656c 6629 3a0a 2020 2020  ames(self):.    
+0000fff0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00010000: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+00010010: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+00010020: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
+00010030: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00010040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010050: 2022 6375 7272 656e 7422 3a20 2269 6e61   "current": "ina
+00010060: 6374 6976 6522 2c0a 2020 2020 2020 2020  ctive",.        
+00010070: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
+00010080: 6522 3a20 2273 7663 3122 2c0a 2020 2020  e": "svc1",.    
+00010090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100a0: 2273 7461 7274 7570 223a 2022 6469 7361  "startup": "disa
+000100b0: 626c 6564 220a 2020 2020 2020 2020 2020  bled".          
+000100c0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000100d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000100e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000100f0: 6375 7272 656e 7422 3a20 2261 6374 6976  current": "activ
+00010100: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00010110: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+00010120: 2273 7663 3222 2c0a 2020 2020 2020 2020  "svc2",.        
+00010130: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00010140: 7274 7570 223a 2022 656e 6162 6c65 6422  rtup": "enabled"
+00010150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010160: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
+00010170: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00010180: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+00010190: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+000101a0: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+000101b0: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+000101c0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+000101d0: 207d 290a 2020 2020 2020 2020 7365 7276   }).        serv
+000101e0: 6963 6573 203d 2073 656c 662e 636c 6965  ices = self.clie
+000101f0: 6e74 2e67 6574 5f73 6572 7669 6365 7328  nt.get_services(
+00010200: 5b27 7376 6331 272c 2027 7376 6332 275d  ['svc1', 'svc2']
+00010210: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010220: 7373 6572 7445 7175 616c 286c 656e 2873  ssertEqual(len(s
+00010230: 6572 7669 6365 7329 2c20 3229 0a20 2020  ervices), 2).   
+00010240: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010250: 4571 7561 6c28 7365 7276 6963 6573 5b30  Equal(services[0
+00010260: 5d2e 6e61 6d65 2c20 2773 7663 3127 290a  ].name, 'svc1').
+00010270: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010280: 6572 7445 7175 616c 2873 6572 7669 6365  ertEqual(service
+00010290: 735b 305d 2e73 7461 7274 7570 2c20 7065  s[0].startup, pe
+000102a0: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
+000102b0: 7475 702e 4449 5341 424c 4544 290a 2020  tup.DISABLED).  
+000102c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000102d0: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+000102e0: 305d 2e63 7572 7265 6e74 2c20 7065 6262  0].current, pebb
+000102f0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+00010300: 2e49 4e41 4354 4956 4529 0a20 2020 2020  .INACTIVE).     
+00010310: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00010320: 7561 6c28 7365 7276 6963 6573 5b31 5d2e  ual(services[1].
+00010330: 6e61 6d65 2c20 2773 7663 3227 290a 2020  name, 'svc2').  
+00010340: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010350: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+00010360: 315d 2e73 7461 7274 7570 2c20 7065 6262  1].startup, pebb
+00010370: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
+00010380: 702e 454e 4142 4c45 4429 0a20 2020 2020  p.ENABLED).     
+00010390: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000103a0: 7561 6c28 7365 7276 6963 6573 5b31 5d2e  ual(services[1].
+000103b0: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+000103c0: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
+000103d0: 5449 5645 290a 0a20 2020 2020 2020 2073  TIVE)..        s
+000103e0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+000103f0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+00010400: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+00010410: 7422 3a20 5b0a 2020 2020 2020 2020 2020  t": [.          
+00010420: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00010430: 2020 2020 2020 2020 2020 2020 2263 7572              "cur
+00010440: 7265 6e74 223a 2022 6163 7469 7665 222c  rent": "active",
+00010450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010460: 2020 2020 2022 6e61 6d65 223a 2022 7376       "name": "sv
+00010470: 6332 222c 0a20 2020 2020 2020 2020 2020  c2",.           
+00010480: 2020 2020 2020 2020 2022 7374 6172 7475           "startu
+00010490: 7022 3a20 2265 6e61 626c 6564 220a 2020  p": "enabled".  
+000104a0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000104b0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+000104c0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+000104d0: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
+000104e0: 2020 2020 2020 2022 7374 6174 7573 2d63         "status-c
+000104f0: 6f64 6522 3a20 3230 302c 0a20 2020 2020  ode": 200,.     
+00010500: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
+00010510: 7379 6e63 220a 2020 2020 2020 2020 7d29  sync".        })
+00010520: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
+00010530: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+00010540: 6765 745f 7365 7276 6963 6573 285b 2773  get_services(['s
+00010550: 7663 3227 5d29 0a20 2020 2020 2020 2073  vc2']).        s
+00010560: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010570: 6c65 6e28 7365 7276 6963 6573 292c 2031  len(services), 1
+00010580: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010590: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
+000105a0: 6365 735b 305d 2e6e 616d 652c 2027 7376  ces[0].name, 'sv
+000105b0: 6332 2729 0a20 2020 2020 2020 2073 656c  c2').        sel
+000105c0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+000105d0: 7276 6963 6573 5b30 5d2e 7374 6172 7475  rvices[0].startu
+000105e0: 702c 2070 6562 626c 652e 5365 7276 6963  p, pebble.Servic
+000105f0: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
+00010600: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010610: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
+00010620: 6365 735b 305d 2e63 7572 7265 6e74 2c20  ces[0].current, 
+00010630: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+00010640: 6174 7573 2e41 4354 4956 4529 0a0a 2020  atus.ACTIVE)..  
+00010650: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010660: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+00010670: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+00010680: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+00010690: 272c 2027 2f76 312f 7365 7276 6963 6573  ', '/v1/services
+000106a0: 272c 207b 276e 616d 6573 273a 2027 7376  ', {'names': 'sv
+000106b0: 6331 2c73 7663 3227 7d2c 204e 6f6e 6529  c1,svc2'}, None)
+000106c0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+000106d0: 4745 5427 2c20 272f 7631 2f73 6572 7669  GET', '/v1/servi
+000106e0: 6365 7327 2c20 7b27 6e61 6d65 7327 3a20  ces', {'names': 
+000106f0: 2773 7663 3227 7d2c 204e 6f6e 6529 2c0a  'svc2'}, None),.
+00010700: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+00010710: 6465 6620 7465 7374 5f70 756c 6c5f 626f  def test_pull_bo
+00010720: 756e 6461 7279 5f73 7061 6e6e 696e 675f  undary_spanning_
+00010730: 6368 756e 6b28 7365 6c66 293a 0a20 2020  chunk(self):.   
+00010740: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00010750: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+00010760: 6428 280a 2020 2020 2020 2020 2020 2020  d((.            
+00010770: 7b27 436f 6e74 656e 742d 5479 7065 273a  {'Content-Type':
+00010780: 2027 6d75 6c74 6970 6172 742f 666f 726d   'multipart/form
+00010790: 2d64 6174 613b 2062 6f75 6e64 6172 793d  -data; boundary=
+000107a0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+000107b0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+000107c0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+000107d0: 6222 2222 5c0a 2d2d 3031 3233 3435 3637  b"""\.--01234567
+000107e0: 3839 3031 3233 3435 3637 3839 3031 3233  8901234567890123
+000107f0: 3435 3637 3839 3031 5c72 0a43 6f6e 7465  45678901\r.Conte
+00010800: 6e74 2d44 6973 706f 7369 7469 6f6e 3a20  nt-Disposition: 
+00010810: 666f 726d 2d64 6174 613b 206e 616d 653d  form-data; name=
+00010820: 2266 696c 6573 223b 2066 696c 656e 616d  "files"; filenam
+00010830: 653d 222f 6574 632f 686f 7374 7322 5c72  e="/etc/hosts"\r
+00010840: 0a5c 720a 3132 372e 302e 302e 3120 6c6f  .\r.127.0.0.1 lo
+00010850: 6361 6c68 6f73 7420 2023 205c 7866 305c  calhost  # \xf0\
+00010860: 7839 665c 7839 385c 7838 305c 6e66 6f6f  x9f\x98\x80\nfoo
+00010870: 5c72 5c6e 6261 725c 720a 2d2d 3031 3233  \r\nbar\r.--0123
+00010880: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+00010890: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
+000108a0: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
+000108b0: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
+000108c0: 616d 653d 2272 6573 706f 6e73 6522 5c72  ame="response"\r
+000108d0: 0a5c 720a 7b0a 2020 2020 2272 6573 756c  .\r.{.    "resul
+000108e0: 7422 3a20 5b7b 2270 6174 6822 3a20 222f  t": [{"path": "/
+000108f0: 6574 632f 686f 7374 7322 7d5d 2c0a 2020  etc/hosts"}],.  
+00010900: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
+00010910: 2c0a 2020 2020 2273 7461 7475 732d 636f  ,.    "status-co
+00010920: 6465 223a 2032 3030 2c0a 2020 2020 2274  de": 200,.    "t
+00010930: 7970 6522 3a20 2273 796e 6322 0a7d 5c72  ype": "sync".}\r
+00010940: 0a2d 2d30 3132 3334 3536 3738 3930 3132  .--0123456789012
+00010950: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00010960: 3930 312d 2d5c 720a 2222 222c 0a20 2020  901--\r.""",.   
+00010970: 2020 2020 2029 290a 0a20 2020 2020 2020       ))..       
+00010980: 2073 656c 662e 636c 6965 6e74 2e5f 6368   self.client._ch
+00010990: 756e 6b5f 7369 7a65 203d 2031 330a 2020  unk_size = 13.  
+000109a0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000109b0: 636c 6965 6e74 2e70 756c 6c28 272f 6574  client.pull('/et
+000109c0: 632f 686f 7374 7327 2920 6173 2069 6e66  c/hosts') as inf
+000109d0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+000109e0: 2063 6f6e 7465 6e74 203d 2069 6e66 696c   content = infil
+000109f0: 652e 7265 6164 2829 0a20 2020 2020 2020  e.read().       
+00010a00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00010a10: 6c28 636f 6e74 656e 742c 2027 3132 372e  l(content, '127.
+00010a20: 302e 302e 3120 6c6f 6361 6c68 6f73 7420  0.0.1 localhost 
+00010a30: 2023 20f0 9f98 805c 6e66 6f6f 5c72 5c6e   # ....\nfoo\r\n
+00010a40: 6261 7227 290a 0a20 2020 2020 2020 2073  bar')..        s
+00010a50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010a60: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+00010a70: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+00010a80: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+00010a90: 2f66 696c 6573 272c 207b 2761 6374 696f  /files', {'actio
+00010aa0: 6e27 3a20 2772 6561 6427 2c20 2770 6174  n': 'read', 'pat
+00010ab0: 6827 3a20 272f 6574 632f 686f 7374 7327  h': '/etc/hosts'
+00010ac0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00010ad0: 2020 207b 2741 6363 6570 7427 3a20 276d     {'Accept': 'm
+00010ae0: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
+00010af0: 7461 277d 2c20 4e6f 6e65 292c 0a20 2020  ta'}, None),.   
+00010b00: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+00010b10: 2074 6573 745f 7075 6c6c 5f74 6578 7428   test_pull_text(
+00010b20: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00010b30: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00010b40: 6e73 6573 2e61 7070 656e 6428 280a 2020  nses.append((.  
+00010b50: 2020 2020 2020 2020 2020 7b27 436f 6e74            {'Cont
+00010b60: 656e 742d 5479 7065 273a 2027 6d75 6c74  ent-Type': 'mult
+00010b70: 6970 6172 742f 666f 726d 2d64 6174 613b  ipart/form-data;
+00010b80: 2062 6f75 6e64 6172 793d 3031 3233 3435   boundary=012345
+00010b90: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+00010ba0: 3233 3435 3637 3839 3031 277d 2c0a 2020  2345678901'},.  
+00010bb0: 2020 2020 2020 2020 2020 6222 2222 5c0a            b"""\.
+00010bc0: 2d2d 3031 3233 3435 3637 3839 3031 3233  --01234567890123
+00010bd0: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+00010be0: 3031 5c72 0a43 6f6e 7465 6e74 2d44 6973  01\r.Content-Dis
+00010bf0: 706f 7369 7469 6f6e 3a20 666f 726d 2d64  position: form-d
+00010c00: 6174 613b 206e 616d 653d 2266 696c 6573  ata; name="files
+00010c10: 223b 2066 696c 656e 616d 653d 222f 6574  "; filename="/et
+00010c20: 632f 686f 7374 7322 5c72 0a5c 720a 3132  c/hosts"\r.\r.12
+00010c30: 372e 302e 302e 3120 6c6f 6361 6c68 6f73  7.0.0.1 localhos
+00010c40: 7420 2023 205c 7866 305c 7839 665c 7839  t  # \xf0\x9f\x9
+00010c50: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
+00010c60: 725c 720a 2d2d 3031 3233 3435 3637 3839  r\r.--0123456789
+00010c70: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+00010c80: 3637 3839 3031 5c72 0a43 6f6e 7465 6e74  678901\r.Content
+00010c90: 2d44 6973 706f 7369 7469 6f6e 3a20 666f  -Disposition: fo
+00010ca0: 726d 2d64 6174 613b 206e 616d 653d 2272  rm-data; name="r
+00010cb0: 6573 706f 6e73 6522 5c72 0a5c 720a 7b0a  esponse"\r.\r.{.
+00010cc0: 2020 2020 2272 6573 756c 7422 3a20 5b7b      "result": [{
+00010cd0: 2270 6174 6822 3a20 222f 6574 632f 686f  "path": "/etc/ho
+00010ce0: 7374 7322 7d5d 2c0a 2020 2020 2273 7461  sts"}],.    "sta
+00010cf0: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
+00010d00: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
+00010d10: 3030 2c0a 2020 2020 2274 7970 6522 3a20  00,.    "type": 
+00010d20: 2273 796e 6322 0a7d 5c72 0a2d 2d30 3132  "sync".}\r.--012
+00010d30: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00010d40: 3930 3132 3334 3536 3738 3930 312d 2d5c  9012345678901--\
+00010d50: 720a 2222 222c 0a20 2020 2020 2020 2029  r.""",.        )
+00010d60: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+00010d70: 7365 6c66 2e63 6c69 656e 742e 7075 6c6c  self.client.pull
+00010d80: 2827 2f65 7463 2f68 6f73 7473 2729 2061  ('/etc/hosts') a
+00010d90: 7320 696e 6669 6c65 3a0a 2020 2020 2020  s infile:.      
+00010da0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+00010db0: 696e 6669 6c65 2e72 6561 6428 290a 2020  infile.read().  
+00010dc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010dd0: 7445 7175 616c 2863 6f6e 7465 6e74 2c20  tEqual(content, 
+00010de0: 2731 3237 2e30 2e30 2e31 206c 6f63 616c  '127.0.0.1 local
+00010df0: 686f 7374 2020 2320 f09f 9880 5c6e 666f  host  # ....\nfo
+00010e00: 6f5c 725c 6e62 6172 2729 0a0a 2020 2020  o\r\nbar')..    
+00010e10: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00010e20: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+00010e30: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+00010e40: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+00010e50: 2027 2f76 312f 6669 6c65 7327 2c20 7b27   '/v1/files', {'
+00010e60: 6163 7469 6f6e 273a 2027 7265 6164 272c  action': 'read',
+00010e70: 2027 7061 7468 273a 2027 2f65 7463 2f68   'path': '/etc/h
+00010e80: 6f73 7473 277d 2c0a 2020 2020 2020 2020  osts'},.        
+00010e90: 2020 2020 2020 2020 7b27 4163 6365 7074          {'Accept
+00010ea0: 273a 2027 6d75 6c74 6970 6172 742f 666f  ': 'multipart/fo
+00010eb0: 726d 2d64 6174 6127 7d2c 204e 6f6e 6529  rm-data'}, None)
+00010ec0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+00010ed0: 2020 6465 6620 7465 7374 5f70 756c 6c5f    def test_pull_
+00010ee0: 6269 6e61 7279 2873 656c 6629 3a0a 2020  binary(self):.  
+00010ef0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00010f00: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+00010f10: 6e64 2828 0a20 2020 2020 2020 2020 2020  nd((.           
+00010f20: 207b 2743 6f6e 7465 6e74 2d54 7970 6527   {'Content-Type'
+00010f30: 3a20 276d 756c 7469 7061 7274 2f66 6f72  : 'multipart/for
+00010f40: 6d2d 6461 7461 3b20 626f 756e 6461 7279  m-data; boundary
+00010f50: 3d30 3132 3334 3536 3738 3930 3132 3334  =012345678901234
+00010f60: 3536 3738 3930 3132 3334 3536 3738 3930  5678901234567890
+00010f70: 3127 7d2c 0a20 2020 2020 2020 2020 2020  1'},.           
+00010f80: 2062 2222 225c 0a2d 2d30 3132 3334 3536   b"""\.--0123456
+00010f90: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
+00010fa0: 3334 3536 3738 3930 315c 720a 436f 6e74  345678901\r.Cont
+00010fb0: 656e 742d 4469 7370 6f73 6974 696f 6e3a  ent-Disposition:
+00010fc0: 2066 6f72 6d2d 6461 7461 3b20 6e61 6d65   form-data; name
+00010fd0: 3d22 6669 6c65 7322 3b20 6669 6c65 6e61  ="files"; filena
+00010fe0: 6d65 3d22 2f65 7463 2f68 6f73 7473 225c  me="/etc/hosts"\
+00010ff0: 720a 5c72 0a31 3237 2e30 2e30 2e31 206c  r.\r.127.0.0.1 l
+00011000: 6f63 616c 686f 7374 2020 2320 5c78 6630  ocalhost  # \xf0
+00011010: 5c78 3966 5c78 3938 5c78 3830 5c6e 666f  \x9f\x98\x80\nfo
+00011020: 6f5c 725c 6e62 6172 5c72 0a2d 2d30 3132  o\r\nbar\r.--012
+00011030: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00011040: 3930 3132 3334 3536 3738 3930 315c 720a  9012345678901\r.
+00011050: 436f 6e74 656e 742d 4469 7370 6f73 6974  Content-Disposit
+00011060: 696f 6e3a 2066 6f72 6d2d 6461 7461 3b20  ion: form-data; 
+00011070: 6e61 6d65 3d22 7265 7370 6f6e 7365 225c  name="response"\
+00011080: 720a 5c72 0a7b 0a20 2020 2022 7265 7375  r.\r.{.    "resu
+00011090: 6c74 223a 205b 7b22 7061 7468 223a 2022  lt": [{"path": "
+000110a0: 2f65 7463 2f68 6f73 7473 227d 5d2c 0a20  /etc/hosts"}],. 
+000110b0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+000110c0: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
+000110d0: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
+000110e0: 7479 7065 223a 2022 7379 6e63 220a 7d5c  type": "sync".}\
+000110f0: 720a 2d2d 3031 3233 3435 3637 3839 3031  r.--012345678901
+00011100: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+00011110: 3839 3031 2d2d 5c72 0a22 2222 2c0a 2020  8901--\r.""",.  
+00011120: 2020 2020 2020 2929 0a0a 2020 2020 2020        ))..      
+00011130: 2020 7769 7468 2073 656c 662e 636c 6965    with self.clie
+00011140: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
+00011150: 7374 7327 2c20 656e 636f 6469 6e67 3d4e  sts', encoding=N
+00011160: 6f6e 6529 2061 7320 696e 6669 6c65 3a0a  one) as infile:.
+00011170: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00011180: 656e 7420 3d20 696e 6669 6c65 2e72 6561  ent = infile.rea
+00011190: 6428 290a 2020 2020 2020 2020 7365 6c66  d().        self
+000111a0: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
+000111b0: 7465 6e74 2c20 6227 3132 372e 302e 302e  tent, b'127.0.0.
+000111c0: 3120 6c6f 6361 6c68 6f73 7420 2023 205c  1 localhost  # \
+000111d0: 7866 305c 7839 665c 7839 385c 7838 305c  xf0\x9f\x98\x80\
+000111e0: 6e66 6f6f 5c72 5c6e 6261 7227 290a 0a20  nfoo\r\nbar').. 
+000111f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011200: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+00011210: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+00011220: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+00011230: 5427 2c20 272f 7631 2f66 696c 6573 272c  T', '/v1/files',
+00011240: 207b 2761 6374 696f 6e27 3a20 2772 6561   {'action': 'rea
+00011250: 6427 2c20 2770 6174 6827 3a20 272f 6574  d', 'path': '/et
+00011260: 632f 686f 7374 7327 7d2c 0a20 2020 2020  c/hosts'},.     
+00011270: 2020 2020 2020 2020 2020 207b 2741 6363             {'Acc
+00011280: 6570 7427 3a20 276d 756c 7469 7061 7274  ept': 'multipart
+00011290: 2f66 6f72 6d2d 6461 7461 277d 2c20 4e6f  /form-data'}, No
+000112a0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+000112b0: 0a20 2020 2064 6566 2074 6573 745f 7075  .    def test_pu
+000112c0: 6c6c 5f70 6174 685f 6572 726f 7228 7365  ll_path_error(se
+000112d0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000112e0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+000112f0: 6573 2e61 7070 656e 6428 280a 2020 2020  es.append((.    
+00011300: 2020 2020 2020 2020 7b27 436f 6e74 656e          {'Conten
+00011310: 742d 5479 7065 273a 2027 6d75 6c74 6970  t-Type': 'multip
+00011320: 6172 742f 666f 726d 2d64 6174 613b 2062  art/form-data; b
+00011330: 6f75 6e64 6172 793d 3031 3233 3435 3637  oundary=01234567
+00011340: 3839 3031 3233 3435 3637 3839 3031 3233  8901234567890123
+00011350: 3435 3637 3839 3031 277d 2c0a 2020 2020  45678901'},.    
+00011360: 2020 2020 2020 2020 6222 2222 5c0a 2d2d          b"""\.--
+00011370: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+00011380: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+00011390: 5c72 0a43 6f6e 7465 6e74 2d44 6973 706f  \r.Content-Dispo
+000113a0: 7369 7469 6f6e 3a20 666f 726d 2d64 6174  sition: form-dat
+000113b0: 613b 206e 616d 653d 2272 6573 706f 6e73  a; name="respons
+000113c0: 6522 5c72 0a5c 720a 7b0a 2020 2020 2272  e"\r.\r.{.    "r
+000113d0: 6573 756c 7422 3a20 5b0a 2020 2020 2020  esult": [.      
+000113e0: 2020 7b22 7061 7468 223a 2022 2f65 7463    {"path": "/etc
+000113f0: 2f68 6f73 7473 222c 2022 6572 726f 7222  /hosts", "error"
+00011400: 3a20 7b22 6b69 6e64 223a 2022 6e6f 742d  : {"kind": "not-
+00011410: 666f 756e 6422 2c20 226d 6573 7361 6765  found", "message
+00011420: 223a 2022 6e6f 7420 666f 756e 6422 7d7d  ": "not found"}}
+00011430: 0a20 2020 205d 2c0a 2020 2020 2273 7461  .    ],.    "sta
+00011440: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
+00011450: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
+00011460: 3030 2c0a 2020 2020 2274 7970 6522 3a20  00,.    "type": 
+00011470: 2273 796e 6322 0a7d 5c72 0a2d 2d30 3132  "sync".}\r.--012
+00011480: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00011490: 3930 3132 3334 3536 3738 3930 312d 2d5c  9012345678901--\
+000114a0: 720a 2222 222c 0a20 2020 2020 2020 2029  r.""",.        )
+000114b0: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+000114c0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000114d0: 7328 7065 6262 6c65 2e50 6174 6845 7272  s(pebble.PathErr
+000114e0: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+000114f0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00011500: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
+00011510: 7374 7327 290a 2020 2020 2020 2020 7365  sts').        se
+00011520: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+00011530: 6e63 6528 636d 2e65 7863 6570 7469 6f6e  nce(cm.exception
+00011540: 2c20 7065 6262 6c65 2e45 7272 6f72 290a  , pebble.Error).
+00011550: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011560: 6572 7445 7175 616c 2863 6d2e 6578 6365  ertEqual(cm.exce
+00011570: 7074 696f 6e2e 6b69 6e64 2c20 276e 6f74  ption.kind, 'not
+00011580: 2d66 6f75 6e64 2729 0a20 2020 2020 2020  -found').       
+00011590: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000115a0: 6c28 636d 2e65 7863 6570 7469 6f6e 2e6d  l(cm.exception.m
+000115b0: 6573 7361 6765 2c20 276e 6f74 2066 6f75  essage, 'not fou
+000115c0: 6e64 2729 0a0a 2020 2020 2020 2020 7365  nd')..        se
+000115d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+000115e0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+000115f0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00011600: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+00011610: 6669 6c65 7327 2c20 7b27 6163 7469 6f6e  files', {'action
+00011620: 273a 2027 7265 6164 272c 2027 7061 7468  ': 'read', 'path
+00011630: 273a 2027 2f65 7463 2f68 6f73 7473 277d  ': '/etc/hosts'}
+00011640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011650: 2020 7b27 4163 6365 7074 273a 2027 6d75    {'Accept': 'mu
+00011660: 6c74 6970 6172 742f 666f 726d 2d64 6174  ltipart/form-dat
+00011670: 6127 7d2c 204e 6f6e 6529 2c0a 2020 2020  a'}, None),.    
+00011680: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+00011690: 7465 7374 5f70 756c 6c5f 7072 6f74 6f63  test_pull_protoc
+000116a0: 6f6c 5f65 7272 6f72 7328 7365 6c66 293a  ol_errors(self):
+000116b0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+000116c0: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+000116d0: 7070 656e 6428 287b 2743 6f6e 7465 6e74  ppend(({'Content
+000116e0: 2d54 7970 6527 3a20 2763 7427 7d2c 2062  -Type': 'ct'}, b
+000116f0: 2727 2929 0a20 2020 2020 2020 2077 6974  '')).        wit
+00011700: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00011710: 7365 7328 7065 6262 6c65 2e50 726f 746f  ses(pebble.Proto
+00011720: 636f 6c45 7272 6f72 2920 6173 2063 6d3a  colError) as cm:
+00011730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011740: 662e 636c 6965 6e74 2e70 756c 6c28 272f  f.client.pull('/
+00011750: 6574 632f 686f 7374 7327 290a 2020 2020  etc/hosts').    
+00011760: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00011770: 7349 6e73 7461 6e63 6528 636d 2e65 7863  sInstance(cm.exc
+00011780: 6570 7469 6f6e 2c20 7065 6262 6c65 2e45  eption, pebble.E
+00011790: 7272 6f72 290a 2020 2020 2020 2020 7365  rror).        se
+000117a0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+000117b0: 7472 2863 6d2e 6578 6365 7074 696f 6e29  tr(cm.exception)
+000117c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000117d0: 2020 2020 2020 2020 2020 2022 6578 7065             "expe
+000117e0: 6374 6564 2043 6f6e 7465 6e74 2d54 7970  cted Content-Typ
+000117f0: 6520 276d 756c 7469 7061 7274 2f66 6f72  e 'multipart/for
+00011800: 6d2d 6461 7461 272c 2067 6f74 2027 6374  m-data', got 'ct
+00011810: 2722 290a 0a20 2020 2020 2020 2073 656c  '")..        sel
+00011820: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+00011830: 6573 2e61 7070 656e 6428 287b 2743 6f6e  es.append(({'Con
+00011840: 7465 6e74 2d54 7970 6527 3a20 276d 756c  tent-Type': 'mul
+00011850: 7469 7061 7274 2f66 6f72 6d2d 6461 7461  tipart/form-data
+00011860: 277d 2c20 6227 2729 290a 2020 2020 2020  '}, b'')).      
+00011870: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00011880: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
+00011890: 5072 6f74 6f63 6f6c 4572 726f 7229 2061  ProtocolError) a
+000118a0: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+000118b0: 2020 7365 6c66 2e63 6c69 656e 742e 7075    self.client.pu
+000118c0: 6c6c 2827 2f65 7463 2f68 6f73 7473 2729  ll('/etc/hosts')
+000118d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000118e0: 7365 7274 4571 7561 6c28 7374 7228 636d  sertEqual(str(cm
+000118f0: 2e65 7863 6570 7469 6f6e 292c 2022 696e  .exception), "in
+00011900: 7661 6c69 6420 626f 756e 6461 7279 2027  valid boundary '
+00011910: 2722 290a 0a20 2020 2020 2020 2073 656c  '")..        sel
+00011920: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+00011930: 6573 2e61 7070 656e 6428 280a 2020 2020  es.append((.    
+00011940: 2020 2020 2020 2020 7b27 436f 6e74 656e          {'Conten
+00011950: 742d 5479 7065 273a 2027 6d75 6c74 6970  t-Type': 'multip
+00011960: 6172 742f 666f 726d 2d64 6174 613b 2062  art/form-data; b
+00011970: 6f75 6e64 6172 793d 3031 3233 3435 3637  oundary=01234567
+00011980: 3839 3031 3233 3435 3637 3839 3031 3233  8901234567890123
+00011990: 3435 3637 3839 3031 277d 2c0a 2020 2020  45678901'},.    
+000119a0: 2020 2020 2020 2020 6222 2222 5c0a 2d2d          b"""\.--
+000119b0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+000119c0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+000119d0: 5c72 0a43 6f6e 7465 6e74 2d44 6973 706f  \r.Content-Dispo
+000119e0: 7369 7469 6f6e 3a20 666f 726d 2d64 6174  sition: form-dat
+000119f0: 613b 206e 616d 653d 2266 696c 6573 223b  a; name="files";
+00011a00: 2066 696c 656e 616d 653d 222f 6261 6422   filename="/bad"
+00011a10: 5c72 0a5c 720a 6261 6420 7061 7468 5c72  \r.\r.bad path\r
+00011a20: 0a2d 2d30 3132 3334 3536 3738 3930 3132  .--0123456789012
+00011a30: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00011a40: 3930 315c 720a 436f 6e74 656e 742d 4469  901\r.Content-Di
+00011a50: 7370 6f73 6974 696f 6e3a 2066 6f72 6d2d  sposition: form-
+00011a60: 6461 7461 3b20 6e61 6d65 3d22 7265 7370  data; name="resp
+00011a70: 6f6e 7365 225c 720a 5c72 0a7b 0a20 2020  onse"\r.\r.{.   
+00011a80: 2022 7265 7375 6c74 223a 205b 7b22 7061   "result": [{"pa
+00011a90: 7468 223a 2022 2f65 7463 2f68 6f73 7473  th": "/etc/hosts
+00011aa0: 227d 5d2c 0a20 2020 2022 7374 6174 7573  "}],.    "status
+00011ab0: 223a 2022 4f4b 222c 0a20 2020 2022 7374  ": "OK",.    "st
+00011ac0: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+00011ad0: 0a20 2020 2022 7479 7065 223a 2022 7379  .    "type": "sy
+00011ae0: 6e63 220a 7d5c 720a 2d2d 3031 3233 3435  nc".}\r.--012345
+00011af0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+00011b00: 3233 3435 3637 3839 3031 2d2d 5c72 0a22  2345678901--\r."
+00011b10: 2222 2c0a 2020 2020 2020 2020 2929 0a20  "",.        )). 
+00011b20: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00011b30: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00011b40: 6262 6c65 2e50 726f 746f 636f 6c45 7272  bble.ProtocolErr
+00011b50: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+00011b60: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00011b70: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
+00011b80: 7374 7327 290a 2020 2020 2020 2020 7365  sts').        se
+00011b90: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00011ba0: 7472 2863 6d2e 6578 6365 7074 696f 6e29  tr(cm.exception)
+00011bb0: 2c20 2270 6174 6820 6e6f 7420 6578 7065  , "path not expe
+00011bc0: 6374 6564 3a20 272f 6261 6427 2229 0a0a  cted: '/bad'")..
+00011bd0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+00011be0: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+00011bf0: 7065 6e64 2828 0a20 2020 2020 2020 2020  pend((.         
+00011c00: 2020 207b 2743 6f6e 7465 6e74 2d54 7970     {'Content-Typ
+00011c10: 6527 3a20 276d 756c 7469 7061 7274 2f66  e': 'multipart/f
+00011c20: 6f72 6d2d 6461 7461 3b20 626f 756e 6461  orm-data; bounda
+00011c30: 7279 3d30 3132 3334 3536 3738 3930 3132  ry=0123456789012
+00011c40: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00011c50: 3930 3127 7d2c 0a20 2020 2020 2020 2020  901'},.         
+00011c60: 2020 2062 2222 225c 0a2d 2d30 3132 3334     b"""\.--01234
+00011c70: 3536 3738 3930 3132 3334 3536 3738 3930  5678901234567890
+00011c80: 3132 3334 3536 3738 3930 315c 720a 436f  12345678901\r.Co
+00011c90: 6e74 656e 742d 4469 7370 6f73 6974 696f  ntent-Dispositio
+00011ca0: 6e3a 2066 6f72 6d2d 6461 7461 3b20 6e61  n: form-data; na
+00011cb0: 6d65 3d22 6669 6c65 7322 3b20 6669 6c65  me="files"; file
+00011cc0: 6e61 6d65 3d22 2f65 7463 2f68 6f73 7473  name="/etc/hosts
+00011cd0: 225c 720a 5c72 0a62 6164 2070 6174 685c  "\r.\r.bad path\
+00011ce0: 720a 2d2d 3031 3233 3435 3637 3839 3031  r.--012345678901
+00011cf0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+00011d00: 3839 3031 2d2d 5c72 0a22 2222 2c0a 2020  8901--\r.""",.  
+00011d10: 2020 2020 2020 2929 0a20 2020 2020 2020        )).       
+00011d20: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00011d30: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
+00011d40: 726f 746f 636f 6c45 7272 6f72 2920 6173  rotocolError) as
+00011d50: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+00011d60: 2073 656c 662e 636c 6965 6e74 2e70 756c   self.client.pul
+00011d70: 6c28 272f 6574 632f 686f 7374 7327 290a  l('/etc/hosts').
+00011d80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011d90: 6572 7445 7175 616c 2873 7472 2863 6d2e  ertEqual(str(cm.
+00011da0: 6578 6365 7074 696f 6e29 2c20 276e 6f20  exception), 'no 
+00011db0: 2272 6573 706f 6e73 6522 2066 6965 6c64  "response" field
+00011dc0: 2069 6e20 6d75 6c74 6970 6172 7420 626f   in multipart bo
+00011dd0: 6479 2729 0a0a 2020 2020 6465 6620 7465  dy')..    def te
+00011de0: 7374 5f70 7573 685f 7374 7228 7365 6c66  st_push_str(self
+00011df0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00011e00: 5f74 6573 745f 7075 7368 5f73 7472 2827  _test_push_str('
+00011e10: 636f 6e74 656e 7420 f09f 9880 5c6e 666f  content ....\nfo
+00011e20: 6f5c 725c 6e62 6172 2729 0a0a 2020 2020  o\r\nbar')..    
+00011e30: 6465 6620 7465 7374 5f70 7573 685f 7465  def test_push_te
+00011e40: 7874 2873 656c 6629 3a0a 2020 2020 2020  xt(self):.      
+00011e50: 2020 7365 6c66 2e5f 7465 7374 5f70 7573    self._test_pus
+00011e60: 685f 7374 7228 696f 2e53 7472 696e 6749  h_str(io.StringI
+00011e70: 4f28 2763 6f6e 7465 6e74 20f0 9f98 805c  O('content ....\
+00011e80: 6e66 6f6f 5c72 5c6e 6261 7227 2929 0a0a  nfoo\r\nbar'))..
+00011e90: 2020 2020 6465 6620 5f74 6573 745f 7075      def _test_pu
+00011ea0: 7368 5f73 7472 2873 656c 662c 2073 6f75  sh_str(self, sou
+00011eb0: 7263 6529 3a0a 2020 2020 2020 2020 7365  rce):.        se
+00011ec0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+00011ed0: 7365 732e 6170 7065 6e64 2828 0a20 2020  ses.append((.   
+00011ee0: 2020 2020 2020 2020 207b 2743 6f6e 7465           {'Conte
+00011ef0: 6e74 2d54 7970 6527 3a20 2761 7070 6c69  nt-Type': 'appli
+00011f00: 6361 7469 6f6e 2f6a 736f 6e27 7d2c 0a20  cation/json'},. 
+00011f10: 2020 2020 2020 2020 2020 2062 2222 220a             b""".
+00011f20: 7b0a 2020 2020 2272 6573 756c 7422 3a20  {.    "result": 
+00011f30: 5b0a 2020 2020 2020 2020 7b22 7061 7468  [.        {"path
+00011f40: 223a 2022 2f66 6f6f 2f62 6172 227d 0a20  ": "/foo/bar"}. 
+00011f50: 2020 205d 2c0a 2020 2020 2273 7461 7475     ],.    "statu
+00011f60: 7322 3a20 224f 4b22 2c0a 2020 2020 2273  s": "OK",.    "s
+00011f70: 7461 7475 732d 636f 6465 223a 2032 3030  tatus-code": 200
+00011f80: 2c0a 2020 2020 2274 7970 6522 3a20 2273  ,.    "type": "s
+00011f90: 796e 6322 0a7d 0a22 2222 2c0a 2020 2020  ync".}.""",.    
+00011fa0: 2020 2020 2929 0a0a 2020 2020 2020 2020      ))..        
+00011fb0: 7365 6c66 2e63 6c69 656e 742e 7075 7368  self.client.push
+00011fc0: 2827 2f66 6f6f 2f62 6172 272c 2073 6f75  ('/foo/bar', sou
+00011fd0: 7263 6529 0a0a 2020 2020 2020 2020 7365  rce)..        se
+00011fe0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+00011ff0: 656e 2873 656c 662e 636c 6965 6e74 2e72  en(self.client.r
+00012000: 6571 7565 7374 7329 2c20 3129 0a20 2020  equests), 1).   
+00012010: 2020 2020 2072 6571 7565 7374 203d 2073       request = s
+00012020: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00012030: 7374 735b 305d 0a20 2020 2020 2020 2073  sts[0].        s
+00012040: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012050: 7265 7175 6573 745b 3a33 5d2c 2028 2750  request[:3], ('P
+00012060: 4f53 5427 2c20 272f 7631 2f66 696c 6573  OST', '/v1/files
+00012070: 272c 204e 6f6e 6529 290a 0a20 2020 2020  ', None))..     
+00012080: 2020 2068 6561 6465 7273 2c20 626f 6479     headers, body
+00012090: 203d 2072 6571 7565 7374 5b33 3a5d 0a0a   = request[3:]..
+000120a0: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
+000120b0: 7479 7065 203d 2068 6561 6465 7273 5b27  type = headers['
+000120c0: 436f 6e74 656e 742d 5479 7065 275d 0a20  Content-Type']. 
+000120d0: 2020 2020 2020 2072 6571 2c20 6669 6c65         req, file
+000120e0: 6e61 6d65 2c20 636f 6e74 656e 7420 3d20  name, content = 
+000120f0: 7365 6c66 2e5f 7061 7273 655f 7772 6974  self._parse_writ
+00012100: 655f 6d75 6c74 6970 6172 7428 636f 6e74  e_multipart(cont
+00012110: 656e 745f 7479 7065 2c20 626f 6479 290a  ent_type, body).
+00012120: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00012130: 6572 7445 7175 616c 2866 696c 656e 616d  ertEqual(filenam
+00012140: 652c 2027 2f66 6f6f 2f62 6172 2729 0a20  e, '/foo/bar'). 
+00012150: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012160: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
+00012170: 2062 2763 6f6e 7465 6e74 205c 7866 305c   b'content \xf0\
+00012180: 7839 665c 7839 385c 7838 305c 6e66 6f6f  x9f\x98\x80\nfoo
+00012190: 5c72 5c6e 6261 7227 290a 2020 2020 2020  \r\nbar').      
+000121a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000121b0: 616c 2872 6571 2c20 7b0a 2020 2020 2020  al(req, {.      
+000121c0: 2020 2020 2020 2761 6374 696f 6e27 3a20        'action': 
+000121d0: 2777 7269 7465 272c 0a20 2020 2020 2020  'write',.       
+000121e0: 2020 2020 2027 6669 6c65 7327 3a20 5b7b       'files': [{
+000121f0: 2770 6174 6827 3a20 272f 666f 6f2f 6261  'path': '/foo/ba
+00012200: 7227 7d5d 2c0a 2020 2020 2020 2020 7d29  r'}],.        })
+00012210: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+00012220: 7573 685f 6279 7465 7328 7365 6c66 293a  ush_bytes(self):
+00012230: 0a20 2020 2020 2020 2073 656c 662e 5f74  .        self._t
+00012240: 6573 745f 7075 7368 5f62 7974 6573 2862  est_push_bytes(b
+00012250: 2763 6f6e 7465 6e74 205c 7866 305c 7839  'content \xf0\x9
+00012260: 665c 7839 385c 7838 305c 6e66 6f6f 5c72  f\x98\x80\nfoo\r
+00012270: 5c6e 6261 7227 290a 0a20 2020 2064 6566  \nbar')..    def
+00012280: 2074 6573 745f 7075 7368 5f62 696e 6172   test_push_binar
+00012290: 7928 7365 6c66 293a 0a20 2020 2020 2020  y(self):.       
+000122a0: 2073 656c 662e 5f74 6573 745f 7075 7368   self._test_push
+000122b0: 5f62 7974 6573 2869 6f2e 4279 7465 7349  _bytes(io.BytesI
+000122c0: 4f28 6227 636f 6e74 656e 7420 5c78 6630  O(b'content \xf0
+000122d0: 5c78 3966 5c78 3938 5c78 3830 5c6e 666f  \x9f\x98\x80\nfo
+000122e0: 6f5c 725c 6e62 6172 2729 290a 0a20 2020  o\r\nbar'))..   
+000122f0: 2064 6566 205f 7465 7374 5f70 7573 685f   def _test_push_
+00012300: 6279 7465 7328 7365 6c66 2c20 736f 7572  bytes(self, sour
+00012310: 6365 293a 0a20 2020 2020 2020 2073 656c  ce):.        sel
+00012320: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+00012330: 6573 2e61 7070 656e 6428 280a 2020 2020  es.append((.    
+00012340: 2020 2020 2020 2020 7b27 436f 6e74 656e          {'Conten
+00012350: 742d 5479 7065 273a 2027 6170 706c 6963  t-Type': 'applic
+00012360: 6174 696f 6e2f 6a73 6f6e 277d 2c0a 2020  ation/json'},.  
+00012370: 2020 2020 2020 2020 2020 6222 2222 0a7b            b""".{
+00012380: 0a20 2020 2022 7265 7375 6c74 223a 205b  .    "result": [
+00012390: 0a20 2020 2020 2020 207b 2270 6174 6822  .        {"path"
+000123a0: 3a20 222f 666f 6f2f 6261 7222 7d0a 2020  : "/foo/bar"}.  
+000123b0: 2020 5d2c 0a20 2020 2022 7374 6174 7573    ],.    "status
+000123c0: 223a 2022 4f4b 222c 0a20 2020 2022 7374  ": "OK",.    "st
+000123d0: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+000123e0: 0a20 2020 2022 7479 7065 223a 2022 7379  .    "type": "sy
+000123f0: 6e63 220a 7d0a 2222 222c 0a20 2020 2020  nc".}.""",.     
+00012400: 2020 2029 290a 0a20 2020 2020 2020 2073     ))..        s
+00012410: 656c 662e 636c 6965 6e74 2e70 7573 6828  elf.client.push(
+00012420: 272f 666f 6f2f 6261 7227 2c20 736f 7572  '/foo/bar', sour
+00012430: 6365 290a 0a20 2020 2020 2020 2073 656c  ce)..        sel
+00012440: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00012450: 6e28 7365 6c66 2e63 6c69 656e 742e 7265  n(self.client.re
+00012460: 7175 6573 7473 292c 2031 290a 2020 2020  quests), 1).    
+00012470: 2020 2020 7265 7175 6573 7420 3d20 7365      request = se
+00012480: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
+00012490: 7473 5b30 5d0a 2020 2020 2020 2020 7365  ts[0].        se
+000124a0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+000124b0: 6571 7565 7374 5b3a 335d 2c20 2827 504f  equest[:3], ('PO
+000124c0: 5354 272c 2027 2f76 312f 6669 6c65 7327  ST', '/v1/files'
+000124d0: 2c20 4e6f 6e65 2929 0a0a 2020 2020 2020  , None))..      
+000124e0: 2020 6865 6164 6572 732c 2062 6f64 7920    headers, body 
+000124f0: 3d20 7265 7175 6573 745b 333a 5d0a 2020  = request[3:].  
+00012500: 2020 2020 2020 636f 6e74 656e 745f 7479        content_ty
+00012510: 7065 203d 2068 6561 6465 7273 5b27 436f  pe = headers['Co
+00012520: 6e74 656e 742d 5479 7065 275d 0a20 2020  ntent-Type'].   
+00012530: 2020 2020 2072 6571 2c20 6669 6c65 6e61       req, filena
+00012540: 6d65 2c20 636f 6e74 656e 7420 3d20 7365  me, content = se
+00012550: 6c66 2e5f 7061 7273 655f 7772 6974 655f  lf._parse_write_
+00012560: 6d75 6c74 6970 6172 7428 636f 6e74 656e  multipart(conten
+00012570: 745f 7479 7065 2c20 626f 6479 290a 2020  t_type, body).  
+00012580: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00012590: 7445 7175 616c 2866 696c 656e 616d 652c  tEqual(filename,
+000125a0: 2027 2f66 6f6f 2f62 6172 2729 0a20 2020   '/foo/bar').   
+000125b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000125c0: 4571 7561 6c28 636f 6e74 656e 742c 2062  Equal(content, b
+000125d0: 2763 6f6e 7465 6e74 205c 7866 305c 7839  'content \xf0\x9
+000125e0: 665c 7839 385c 7838 305c 6e66 6f6f 5c72  f\x98\x80\nfoo\r
+000125f0: 5c6e 6261 7227 290a 2020 2020 2020 2020  \nbar').        
+00012600: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012610: 2872 6571 2c20 7b0a 2020 2020 2020 2020  (req, {.        
+00012620: 2020 2020 2761 6374 696f 6e27 3a20 2777      'action': 'w
+00012630: 7269 7465 272c 0a20 2020 2020 2020 2020  rite',.         
+00012640: 2020 2027 6669 6c65 7327 3a20 5b7b 2770     'files': [{'p
+00012650: 6174 6827 3a20 272f 666f 6f2f 6261 7227  ath': '/foo/bar'
+00012660: 7d5d 2c0a 2020 2020 2020 2020 7d29 0a0a  }],.        })..
+00012670: 2020 2020 6465 6620 7465 7374 5f70 7573      def test_pus
+00012680: 685f 616c 6c5f 6f70 7469 6f6e 7328 7365  h_all_options(se
+00012690: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000126a0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+000126b0: 6573 2e61 7070 656e 6428 280a 2020 2020  es.append((.    
+000126c0: 2020 2020 2020 2020 7b27 436f 6e74 656e          {'Conten
+000126d0: 742d 5479 7065 273a 2027 6170 706c 6963  t-Type': 'applic
+000126e0: 6174 696f 6e2f 6a73 6f6e 277d 2c0a 2020  ation/json'},.  
+000126f0: 2020 2020 2020 2020 2020 6222 2222 0a7b            b""".{
+00012700: 0a20 2020 2022 7265 7375 6c74 223a 205b  .    "result": [
+00012710: 0a20 2020 2020 2020 207b 2270 6174 6822  .        {"path"
+00012720: 3a20 222f 666f 6f2f 6261 7222 7d0a 2020  : "/foo/bar"}.  
+00012730: 2020 5d2c 0a20 2020 2022 7374 6174 7573    ],.    "status
+00012740: 223a 2022 4f4b 222c 0a20 2020 2022 7374  ": "OK",.    "st
+00012750: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+00012760: 0a20 2020 2022 7479 7065 223a 2022 7379  .    "type": "sy
+00012770: 6e63 220a 7d0a 2222 222c 0a20 2020 2020  nc".}.""",.     
+00012780: 2020 2029 290a 0a20 2020 2020 2020 2073     ))..        s
+00012790: 656c 662e 636c 6965 6e74 2e70 7573 6828  elf.client.push(
+000127a0: 272f 666f 6f2f 6261 7227 2c20 2763 6f6e  '/foo/bar', 'con
+000127b0: 7465 6e74 272c 206d 616b 655f 6469 7273  tent', make_dirs
+000127c0: 3d54 7275 652c 2070 6572 6d69 7373 696f  =True, permissio
+000127d0: 6e73 3d30 6f36 3030 2c0a 2020 2020 2020  ns=0o600,.      
+000127e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127f0: 2020 2075 7365 725f 6964 3d31 322c 2075     user_id=12, u
+00012800: 7365 723d 2762 6f62 272c 2067 726f 7570  ser='bob', group
+00012810: 5f69 643d 3334 2c20 6772 6f75 703d 2773  _id=34, group='s
+00012820: 7461 6666 2729 0a0a 2020 2020 2020 2020  taff')..        
+00012830: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012840: 286c 656e 2873 656c 662e 636c 6965 6e74  (len(self.client
+00012850: 2e72 6571 7565 7374 7329 2c20 3129 0a20  .requests), 1). 
+00012860: 2020 2020 2020 2072 6571 7565 7374 203d         request =
+00012870: 2073 656c 662e 636c 6965 6e74 2e72 6571   self.client.req
+00012880: 7565 7374 735b 305d 0a20 2020 2020 2020  uests[0].       
+00012890: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000128a0: 6c28 7265 7175 6573 745b 3a33 5d2c 2028  l(request[:3], (
+000128b0: 2750 4f53 5427 2c20 272f 7631 2f66 696c  'POST', '/v1/fil
+000128c0: 6573 272c 204e 6f6e 6529 290a 0a20 2020  es', None))..   
+000128d0: 2020 2020 2068 6561 6465 7273 2c20 626f       headers, bo
+000128e0: 6479 203d 2072 6571 7565 7374 5b33 3a5d  dy = request[3:]
+000128f0: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+00012900: 5f74 7970 6520 3d20 6865 6164 6572 735b  _type = headers[
+00012910: 2743 6f6e 7465 6e74 2d54 7970 6527 5d0a  'Content-Type'].
+00012920: 2020 2020 2020 2020 7265 712c 2066 696c          req, fil
+00012930: 656e 616d 652c 2063 6f6e 7465 6e74 203d  ename, content =
+00012940: 2073 656c 662e 5f70 6172 7365 5f77 7269   self._parse_wri
+00012950: 7465 5f6d 756c 7469 7061 7274 2863 6f6e  te_multipart(con
+00012960: 7465 6e74 5f74 7970 652c 2062 6f64 7929  tent_type, body)
+00012970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00012980: 7365 7274 4571 7561 6c28 6669 6c65 6e61  sertEqual(filena
+00012990: 6d65 2c20 272f 666f 6f2f 6261 7227 290a  me, '/foo/bar').
+000129a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000129b0: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
+000129c0: 2c20 6227 636f 6e74 656e 7427 290a 2020  , b'content').  
+000129d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000129e0: 7445 7175 616c 2872 6571 2c20 7b0a 2020  tEqual(req, {.  
+000129f0: 2020 2020 2020 2020 2020 2761 6374 696f            'actio
+00012a00: 6e27 3a20 2777 7269 7465 272c 0a20 2020  n': 'write',.   
+00012a10: 2020 2020 2020 2020 2027 6669 6c65 7327           'files'
+00012a20: 3a20 5b7b 0a20 2020 2020 2020 2020 2020  : [{.           
+00012a30: 2020 2020 2027 7061 7468 273a 2027 2f66       'path': '/f
+00012a40: 6f6f 2f62 6172 272c 0a20 2020 2020 2020  oo/bar',.       
+00012a50: 2020 2020 2020 2020 2027 6d61 6b65 2d64           'make-d
+00012a60: 6972 7327 3a20 5472 7565 2c0a 2020 2020  irs': True,.    
+00012a70: 2020 2020 2020 2020 2020 2020 2770 6572              'per
+00012a80: 6d69 7373 696f 6e73 273a 2027 3630 3027  missions': '600'
+00012a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012aa0: 2020 2775 7365 722d 6964 273a 2031 322c    'user-id': 12,
+00012ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012ac0: 2027 7573 6572 273a 2027 626f 6227 2c0a   'user': 'bob',.
+00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ae0: 2767 726f 7570 2d69 6427 3a20 3334 2c0a  'group-id': 34,.
+00012af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b00: 2767 726f 7570 273a 2027 7374 6166 6627  'group': 'staff'
+00012b10: 2c0a 2020 2020 2020 2020 2020 2020 7d5d  ,.            }]
+00012b20: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
+00012b30: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
+00012b40: 7569 645f 6769 6428 7365 6c66 293a 0a20  uid_gid(self):. 
+00012b50: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00012b60: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
+00012b70: 656e 6428 280a 2020 2020 2020 2020 2020  end((.          
+00012b80: 2020 7b27 436f 6e74 656e 742d 5479 7065    {'Content-Type
+00012b90: 273a 2027 6170 706c 6963 6174 696f 6e2f  ': 'application/
+00012ba0: 6a73 6f6e 277d 2c0a 2020 2020 2020 2020  json'},.        
+00012bb0: 2020 2020 6222 2222 0a7b 0a20 2020 2022      b""".{.    "
+00012bc0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
+00012bd0: 2020 207b 2270 6174 6822 3a20 222f 666f     {"path": "/fo
+00012be0: 6f2f 6261 7222 7d0a 2020 2020 5d2c 0a20  o/bar"}.    ],. 
+00012bf0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+00012c00: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
+00012c10: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
+00012c20: 7479 7065 223a 2022 7379 6e63 220a 7d0a  type": "sync".}.
+00012c30: 2222 222c 0a20 2020 2020 2020 2029 290a  """,.        )).
+00012c40: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00012c50: 6965 6e74 2e70 7573 6828 272f 666f 6f2f  ient.push('/foo/
+00012c60: 6261 7227 2c20 2763 6f6e 7465 6e74 272c  bar', 'content',
+00012c70: 2075 7365 725f 6964 3d31 322c 2067 726f   user_id=12, gro
+00012c80: 7570 5f69 643d 3334 290a 0a20 2020 2020  up_id=34)..     
+00012c90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00012ca0: 7561 6c28 6c65 6e28 7365 6c66 2e63 6c69  ual(len(self.cli
+00012cb0: 656e 742e 7265 7175 6573 7473 292c 2031  ent.requests), 1
+00012cc0: 290a 2020 2020 2020 2020 7265 7175 6573  ).        reques
+00012cd0: 7420 3d20 7365 6c66 2e63 6c69 656e 742e  t = self.client.
+00012ce0: 7265 7175 6573 7473 5b30 5d0a 2020 2020  requests[0].    
+00012cf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00012d00: 7175 616c 2872 6571 7565 7374 5b3a 335d  qual(request[:3]
+00012d10: 2c20 2827 504f 5354 272c 2027 2f76 312f  , ('POST', '/v1/
+00012d20: 6669 6c65 7327 2c20 4e6f 6e65 2929 0a0a  files', None))..
+00012d30: 2020 2020 2020 2020 6865 6164 6572 732c          headers,
+00012d40: 2062 6f64 7920 3d20 7265 7175 6573 745b   body = request[
+00012d50: 333a 5d0a 2020 2020 2020 2020 636f 6e74  3:].        cont
+00012d60: 656e 745f 7479 7065 203d 2068 6561 6465  ent_type = heade
+00012d70: 7273 5b27 436f 6e74 656e 742d 5479 7065  rs['Content-Type
+00012d80: 275d 0a20 2020 2020 2020 2072 6571 2c20  '].        req, 
+00012d90: 6669 6c65 6e61 6d65 2c20 636f 6e74 656e  filename, conten
+00012da0: 7420 3d20 7365 6c66 2e5f 7061 7273 655f  t = self._parse_
+00012db0: 7772 6974 655f 6d75 6c74 6970 6172 7428  write_multipart(
+00012dc0: 636f 6e74 656e 745f 7479 7065 2c20 626f  content_type, bo
+00012dd0: 6479 290a 2020 2020 2020 2020 7365 6c66  dy).        self
+00012de0: 2e61 7373 6572 7445 7175 616c 2866 696c  .assertEqual(fil
+00012df0: 656e 616d 652c 2027 2f66 6f6f 2f62 6172  ename, '/foo/bar
+00012e00: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00012e10: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
+00012e20: 656e 742c 2062 2763 6f6e 7465 6e74 2729  ent, b'content')
+00012e30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00012e40: 7365 7274 4571 7561 6c28 7265 712c 207b  sertEqual(req, {
+00012e50: 0a20 2020 2020 2020 2020 2020 2027 6163  .            'ac
+00012e60: 7469 6f6e 273a 2027 7772 6974 6527 2c0a  tion': 'write',.
+00012e70: 2020 2020 2020 2020 2020 2020 2766 696c              'fil
+00012e80: 6573 273a 205b 7b0a 2020 2020 2020 2020  es': [{.        
+00012e90: 2020 2020 2020 2020 2770 6174 6827 3a20          'path': 
+00012ea0: 272f 666f 6f2f 6261 7227 2c0a 2020 2020  '/foo/bar',.    
+00012eb0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
+00012ec0: 722d 6964 273a 2031 322c 0a20 2020 2020  r-id': 12,.     
+00012ed0: 2020 2020 2020 2020 2020 2027 6772 6f75             'grou
+00012ee0: 702d 6964 273a 2033 342c 0a20 2020 2020  p-id': 34,.     
+00012ef0: 2020 2020 2020 207d 5d2c 0a20 2020 2020         }],.     
+00012f00: 2020 207d 290a 0a20 2020 2064 6566 2074     })..    def t
+00012f10: 6573 745f 7075 7368 5f70 6174 685f 6572  est_push_path_er
+00012f20: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+00012f30: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00012f40: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+00012f50: 280a 2020 2020 2020 2020 2020 2020 7b27  (.            {'
+00012f60: 436f 6e74 656e 742d 5479 7065 273a 2027  Content-Type': '
+00012f70: 6170 706c 6963 6174 696f 6e2f 6a73 6f6e  application/json
+00012f80: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00012f90: 6222 2222 0a7b 0a20 2020 2022 7265 7375  b""".{.    "resu
+00012fa0: 6c74 223a 205b 0a20 2020 2020 2020 207b  lt": [.        {
+00012fb0: 2270 6174 6822 3a20 222f 666f 6f2f 6261  "path": "/foo/ba
+00012fc0: 7222 2c20 2265 7272 6f72 223a 207b 226b  r", "error": {"k
+00012fd0: 696e 6422 3a20 226e 6f74 2d66 6f75 6e64  ind": "not-found
+00012fe0: 222c 2022 6d65 7373 6167 6522 3a20 226e  ", "message": "n
+00012ff0: 6f74 2066 6f75 6e64 227d 7d0a 2020 2020  ot found"}}.    
+00013000: 5d2c 0a20 2020 2022 7374 6174 7573 223a  ],.    "status":
+00013010: 2022 4f4b 222c 0a20 2020 2022 7374 6174   "OK",.    "stat
+00013020: 7573 2d63 6f64 6522 3a20 3230 302c 0a20  us-code": 200,. 
+00013030: 2020 2022 7479 7065 223a 2022 7379 6e63     "type": "sync
+00013040: 220a 7d0a 2222 222c 0a20 2020 2020 2020  ".}.""",.       
+00013050: 2029 290a 0a20 2020 2020 2020 2077 6974   ))..        wit
+00013060: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00013070: 7365 7328 7065 6262 6c65 2e50 6174 6845  ses(pebble.PathE
+00013080: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+00013090: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+000130a0: 6965 6e74 2e70 7573 6828 272f 666f 6f2f  ient.push('/foo/
+000130b0: 6261 7227 2c20 2763 6f6e 7465 6e74 2729  bar', 'content')
+000130c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000130d0: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+000130e0: 6570 7469 6f6e 2e6b 696e 642c 2027 6e6f  eption.kind, 'no
+000130f0: 742d 666f 756e 6427 290a 2020 2020 2020  t-found').      
+00013100: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00013110: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
+00013120: 6d65 7373 6167 652c 2027 6e6f 7420 666f  message, 'not fo
+00013130: 756e 6427 290a 0a20 2020 2020 2020 2073  und')..        s
+00013140: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00013150: 6c65 6e28 7365 6c66 2e63 6c69 656e 742e  len(self.client.
+00013160: 7265 7175 6573 7473 292c 2031 290a 2020  requests), 1).  
+00013170: 2020 2020 2020 7265 7175 6573 7420 3d20        request = 
+00013180: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+00013190: 6573 7473 5b30 5d0a 2020 2020 2020 2020  ests[0].        
+000131a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000131b0: 2872 6571 7565 7374 5b3a 335d 2c20 2827  (request[:3], ('
+000131c0: 504f 5354 272c 2027 2f76 312f 6669 6c65  POST', '/v1/file
+000131d0: 7327 2c20 4e6f 6e65 2929 0a0a 2020 2020  s', None))..    
+000131e0: 2020 2020 6865 6164 6572 732c 2062 6f64      headers, bod
+000131f0: 7920 3d20 7265 7175 6573 745b 333a 5d0a  y = request[3:].
+00013200: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
+00013210: 7479 7065 203d 2068 6561 6465 7273 5b27  type = headers['
+00013220: 436f 6e74 656e 742d 5479 7065 275d 0a20  Content-Type']. 
+00013230: 2020 2020 2020 2072 6571 2c20 6669 6c65         req, file
+00013240: 6e61 6d65 2c20 636f 6e74 656e 7420 3d20  name, content = 
+00013250: 7365 6c66 2e5f 7061 7273 655f 7772 6974  self._parse_writ
+00013260: 655f 6d75 6c74 6970 6172 7428 636f 6e74  e_multipart(cont
+00013270: 656e 745f 7479 7065 2c20 626f 6479 290a  ent_type, body).
+00013280: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013290: 6572 7445 7175 616c 2866 696c 656e 616d  ertEqual(filenam
+000132a0: 652c 2027 2f66 6f6f 2f62 6172 2729 0a20  e, '/foo/bar'). 
+000132b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000132c0: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
+000132d0: 2062 2763 6f6e 7465 6e74 2729 0a20 2020   b'content').   
+000132e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000132f0: 4571 7561 6c28 7265 712c 207b 0a20 2020  Equal(req, {.   
+00013300: 2020 2020 2020 2020 2027 6163 7469 6f6e           'action
+00013310: 273a 2027 7772 6974 6527 2c0a 2020 2020  ': 'write',.    
+00013320: 2020 2020 2020 2020 2766 696c 6573 273a          'files':
+00013330: 205b 7b27 7061 7468 273a 2027 2f66 6f6f   [{'path': '/foo
+00013340: 2f62 6172 277d 5d2c 0a20 2020 2020 2020  /bar'}],.       
+00013350: 207d 290a 0a20 2020 2064 6566 205f 7061   })..    def _pa
+00013360: 7273 655f 7772 6974 655f 6d75 6c74 6970  rse_write_multip
+00013370: 6172 7428 7365 6c66 2c20 636f 6e74 656e  art(self, conten
+00013380: 745f 7479 7065 2c20 626f 6479 293a 0a20  t_type, body):. 
+00013390: 2020 2020 2020 2063 7479 7065 2c20 6f70         ctype, op
+000133a0: 7469 6f6e 7320 3d20 6367 692e 7061 7273  tions = cgi.pars
+000133b0: 655f 6865 6164 6572 2863 6f6e 7465 6e74  e_header(content
+000133c0: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
+000133d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000133e0: 6374 7970 652c 2027 6d75 6c74 6970 6172  ctype, 'multipar
+000133f0: 742f 666f 726d 2d64 6174 6127 290a 2020  t/form-data').  
+00013400: 2020 2020 2020 626f 756e 6461 7279 203d        boundary =
+00013410: 206f 7074 696f 6e73 5b27 626f 756e 6461   options['bounda
+00013420: 7279 275d 0a0a 2020 2020 2020 2020 2320  ry']..        # 
+00013430: 5765 2068 6176 6520 746f 206d 616e 7561  We have to manua
+00013440: 6c6c 7920 7772 6974 6520 7468 6520 436f  lly write the Co
+00013450: 6e74 656e 742d 5479 7065 2077 6974 6820  ntent-Type with 
+00013460: 626f 756e 6461 7279 2c20 6265 6361 7573  boundary, becaus
+00013470: 650a 2020 2020 2020 2020 2320 656d 6169  e.        # emai
+00013480: 6c2e 7061 7273 6572 2065 7870 6563 7473  l.parser expects
+00013490: 2074 6865 2065 6e74 6972 6520 6d75 6c74   the entire mult
+000134a0: 6970 6172 7420 6d65 7373 6167 6520 7769  ipart message wi
+000134b0: 7468 2068 6561 6465 7273 2e0a 2020 2020  th headers..    
+000134c0: 2020 2020 7061 7273 6572 203d 2065 6d61      parser = ema
+000134d0: 696c 2e70 6172 7365 722e 4279 7465 7346  il.parser.BytesF
+000134e0: 6565 6450 6172 7365 7228 290a 2020 2020  eedParser().    
+000134f0: 2020 2020 7061 7273 6572 2e66 6565 6428      parser.feed(
+00013500: 6227 436f 6e74 656e 742d 5479 7065 3a20  b'Content-Type: 
+00013510: 6d75 6c74 6970 6172 742f 666f 726d 2d64  multipart/form-d
+00013520: 6174 613b 2062 6f75 6e64 6172 793d 270a  ata; boundary='.
+00013530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013540: 2020 2020 2b20 626f 756e 6461 7279 2e65      + boundary.e
+00013550: 6e63 6f64 6528 2775 7466 2d38 2729 202b  ncode('utf-8') +
+00013560: 2062 275c 725c 6e5c 725c 6e27 290a 2020   b'\r\n\r\n').  
+00013570: 2020 2020 2020 666f 7220 6220 696e 2062        for b in b
+00013580: 6f64 793a 0a20 2020 2020 2020 2020 2020  ody:.           
+00013590: 2023 2057 6974 6820 7468 6520 226d 656d   # With the "mem
+000135a0: 6f72 7920 6566 6669 6369 656e 7420 7075  ory efficient pu
+000135b0: 7368 2220 6368 616e 6765 732c 2062 6f64  sh" changes, bod
+000135c0: 7920 6973 2061 6e20 6974 6572 6162 6c65  y is an iterable
+000135d0: 2e0a 2020 2020 2020 2020 2020 2020 7061  ..            pa
+000135e0: 7273 6572 2e66 6565 6428 6229 0a20 2020  rser.feed(b).   
+000135f0: 2020 2020 206d 6573 7361 6765 203d 2070       message = p
+00013600: 6172 7365 722e 636c 6f73 6528 290a 0a20  arser.close().. 
+00013610: 2020 2020 2020 2072 6571 203d 204e 6f6e         req = Non
+00013620: 650a 2020 2020 2020 2020 6669 6c65 6e61  e.        filena
+00013630: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
+00013640: 2020 636f 6e74 656e 7420 3d20 4e6f 6e65    content = None
+00013650: 0a20 2020 2020 2020 2066 6f72 2070 6172  .        for par
+00013660: 7420 696e 206d 6573 7361 6765 2e77 616c  t in message.wal
+00013670: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00013680: 206e 616d 6520 3d20 7061 7274 2e67 6574   name = part.get
+00013690: 5f70 6172 616d 2827 6e61 6d65 272c 2068  _param('name', h
+000136a0: 6561 6465 723d 2743 6f6e 7465 6e74 2d44  eader='Content-D
+000136b0: 6973 706f 7369 7469 6f6e 2729 0a20 2020  isposition').   
+000136c0: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+000136d0: 203d 3d20 2772 6571 7565 7374 273a 0a20   == 'request':. 
+000136e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000136f0: 6571 203d 206a 736f 6e2e 6c6f 6164 7328  eq = json.loads(
+00013700: 7061 7274 2e67 6574 5f70 6179 6c6f 6164  part.get_payload
+00013710: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00013720: 656c 6966 206e 616d 6520 3d3d 2027 6669  elif name == 'fi
+00013730: 6c65 7327 3a0a 2020 2020 2020 2020 2020  les':.          
+00013740: 2020 2020 2020 2320 6465 636f 6465 3d54        # decode=T
+00013750: 7275 652c 2069 726f 6e69 6361 6c6c 792c  rue, ironically,
+00013760: 2061 766f 6964 7320 6465 636f 6469 6e67   avoids decoding
+00013770: 2062 7974 6573 2074 6f20 7374 720a 2020   bytes to str.  
+00013780: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00013790: 6e74 656e 7420 3d20 7061 7274 2e67 6574  ntent = part.get
+000137a0: 5f70 6179 6c6f 6164 2864 6563 6f64 653d  _payload(decode=
+000137b0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+000137c0: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+000137d0: 2070 6172 742e 6765 745f 6669 6c65 6e61   part.get_filena
+000137e0: 6d65 2829 0a20 2020 2020 2020 2072 6574  me().        ret
+000137f0: 7572 6e20 2872 6571 2c20 6669 6c65 6e61  urn (req, filena
+00013800: 6d65 2c20 636f 6e74 656e 7429 0a0a 2020  me, content)..  
+00013810: 2020 6465 6620 7465 7374 5f6c 6973 745f    def test_list_
+00013820: 6669 6c65 735f 7061 7468 2873 656c 6629  files_path(self)
+00013830: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00013840: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+00013850: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
+00013860: 2020 2020 2022 7265 7375 6c74 223a 205b       "result": [
+00013870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013880: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00013890: 2020 2020 2020 2027 7061 7468 273a 2027         'path': '
+000138a0: 2f65 7463 2f68 6f73 7473 272c 0a20 2020  /etc/hosts',.   
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138c0: 2027 6e61 6d65 273a 2027 686f 7374 7327   'name': 'hosts'
+000138d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000138e0: 2020 2020 2020 2774 7970 6527 3a20 2766        'type': 'f
+000138f0: 696c 6527 2c0a 2020 2020 2020 2020 2020  ile',.          
+00013900: 2020 2020 2020 2020 2020 2773 697a 6527            'size'
+00013910: 3a20 3132 332c 0a20 2020 2020 2020 2020  : 123,.         
+00013920: 2020 2020 2020 2020 2020 2027 7065 726d             'perm
+00013930: 6973 7369 6f6e 7327 3a20 2736 3434 272c  issions': '644',
+00013940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013950: 2020 2020 2027 6c61 7374 2d6d 6f64 6966       'last-modif
+00013960: 6965 6427 3a20 2732 3032 312d 3031 2d32  ied': '2021-01-2
+00013970: 3854 3134 3a33 373a 3034 2e32 3931 3531  8T14:37:04.29151
+00013980: 3737 3638 2b31 333a 3030 272c 0a20 2020  7768+13:00',.   
+00013990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139a0: 2027 7573 6572 2d69 6427 3a20 3132 2c0a   'user-id': 12,.
+000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139c0: 2020 2020 2775 7365 7227 3a20 2762 6f62      'user': 'bob
+000139d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000139e0: 2020 2020 2020 2027 6772 6f75 702d 6964         'group-id
+000139f0: 273a 2033 342c 0a20 2020 2020 2020 2020  ': 34,.         
+00013a00: 2020 2020 2020 2020 2020 2027 6772 6f75             'grou
+00013a10: 7027 3a20 2773 7461 6666 272c 0a20 2020  p': 'staff',.   
+00013a20: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00013a50: 2020 2020 2020 2770 6174 6827 3a20 272f        'path': '/
+00013a60: 6574 632f 6e67 696e 7827 2c0a 2020 2020  etc/nginx',.    
+00013a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a80: 276e 616d 6527 3a20 276e 6769 6e78 272c  'name': 'nginx',
+00013a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013aa0: 2020 2020 2027 7479 7065 273a 2027 6469       'type': 'di
+00013ab0: 7265 6374 6f72 7927 2c0a 2020 2020 2020  rectory',.      
+00013ac0: 2020 2020 2020 2020 2020 2020 2020 2770                'p
+00013ad0: 6572 6d69 7373 696f 6e73 273a 2027 3735  ermissions': '75
+00013ae0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+00013af0: 2020 2020 2020 2020 276c 6173 742d 6d6f          'last-mo
+00013b00: 6469 6669 6564 273a 2027 3230 3230 2d30  dified': '2020-0
+00013b10: 312d 3031 5430 313a 3031 3a30 312e 3030  1-01T01:01:01.00
+00013b20: 3030 3030 2b31 333a 3030 272c 0a20 2020  0000+13:00',.   
+00013b30: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00013b40: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00013b50: 2020 2020 2020 2020 2020 2027 7374 6174             'stat
+00013b60: 7573 273a 2027 4f4b 272c 0a20 2020 2020  us': 'OK',.     
+00013b70: 2020 2020 2020 2027 7374 6174 7573 2d63         'status-c
+00013b80: 6f64 6527 3a20 3230 302c 0a20 2020 2020  ode': 200,.     
+00013b90: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
+00013ba0: 7379 6e63 272c 0a20 2020 2020 2020 207d  sync',.        }
+00013bb0: 290a 2020 2020 2020 2020 696e 666f 7320  ).        infos 
+00013bc0: 3d20 7365 6c66 2e63 6c69 656e 742e 6c69  = self.client.li
+00013bd0: 7374 5f66 696c 6573 2827 2f65 7463 2729  st_files('/etc')
+00013be0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00013bf0: 7373 6572 7445 7175 616c 286c 656e 2869  ssertEqual(len(i
+00013c00: 6e66 6f73 292c 2032 290a 2020 2020 2020  nfos), 2).      
+00013c10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00013c20: 616c 2869 6e66 6f73 5b30 5d2e 7061 7468  al(infos[0].path
+00013c30: 2c20 272f 6574 632f 686f 7374 7327 290a  , '/etc/hosts').
+00013c40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013c50: 6572 7445 7175 616c 2869 6e66 6f73 5b30  ertEqual(infos[0
+00013c60: 5d2e 6e61 6d65 2c20 2768 6f73 7473 2729  ].name, 'hosts')
+00013c70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00013c80: 7365 7274 4571 7561 6c28 696e 666f 735b  sertEqual(infos[
+00013c90: 305d 2e74 7970 652c 2070 6562 626c 652e  0].type, pebble.
+00013ca0: 4669 6c65 5479 7065 2e46 494c 4529 0a20  FileType.FILE). 
+00013cb0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00013cc0: 7274 4571 7561 6c28 696e 666f 735b 305d  rtEqual(infos[0]
+00013cd0: 2e73 697a 652c 2031 3233 290a 2020 2020  .size, 123).    
+00013ce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013cf0: 7175 616c 2869 6e66 6f73 5b30 5d2e 7065  qual(infos[0].pe
+00013d00: 726d 6973 7369 6f6e 732c 2030 6f36 3434  rmissions, 0o644
+00013d10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013d20: 7373 6572 7445 7175 616c 2869 6e66 6f73  ssertEqual(infos
+00013d30: 5b30 5d2e 6c61 7374 5f6d 6f64 6966 6965  [0].last_modifie
+00013d40: 642c 2064 6174 6574 696d 655f 6e7a 6474  d, datetime_nzdt
+00013d50: 2832 3032 312c 2031 2c20 3238 2c20 3134  (2021, 1, 28, 14
+00013d60: 2c20 3337 2c20 342c 2032 3931 3531 3829  , 37, 4, 291518)
+00013d70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013d80: 7373 6572 7445 7175 616c 2869 6e66 6f73  ssertEqual(infos
+00013d90: 5b30 5d2e 7573 6572 5f69 642c 2031 3229  [0].user_id, 12)
+00013da0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00013db0: 7365 7274 4571 7561 6c28 696e 666f 735b  sertEqual(infos[
+00013dc0: 305d 2e75 7365 722c 2027 626f 6227 290a  0].user, 'bob').
+00013dd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013de0: 6572 7445 7175 616c 2869 6e66 6f73 5b30  ertEqual(infos[0
+00013df0: 5d2e 6772 6f75 705f 6964 2c20 3334 290a  ].group_id, 34).
+00013e00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013e10: 6572 7445 7175 616c 2869 6e66 6f73 5b30  ertEqual(infos[0
+00013e20: 5d2e 6772 6f75 702c 2027 7374 6166 6627  ].group, 'staff'
+00013e30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013e40: 7373 6572 7445 7175 616c 2869 6e66 6f73  ssertEqual(infos
+00013e50: 5b31 5d2e 7061 7468 2c20 272f 6574 632f  [1].path, '/etc/
+00013e60: 6e67 696e 7827 290a 2020 2020 2020 2020  nginx').        
+00013e70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013e80: 2869 6e66 6f73 5b31 5d2e 6e61 6d65 2c20  (infos[1].name, 
+00013e90: 276e 6769 6e78 2729 0a20 2020 2020 2020  'nginx').       
+00013ea0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00013eb0: 6c28 696e 666f 735b 315d 2e74 7970 652c  l(infos[1].type,
+00013ec0: 2070 6562 626c 652e 4669 6c65 5479 7065   pebble.FileType
+00013ed0: 2e44 4952 4543 544f 5259 290a 2020 2020  .DIRECTORY).    
+00013ee0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013ef0: 7175 616c 2869 6e66 6f73 5b31 5d2e 7369  qual(infos[1].si
+00013f00: 7a65 2c20 4e6f 6e65 290a 2020 2020 2020  ze, None).      
+00013f10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00013f20: 616c 2869 6e66 6f73 5b31 5d2e 7065 726d  al(infos[1].perm
+00013f30: 6973 7369 6f6e 732c 2030 6f37 3535 290a  issions, 0o755).
+00013f40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013f50: 6572 7445 7175 616c 2869 6e66 6f73 5b31  ertEqual(infos[1
+00013f60: 5d2e 6c61 7374 5f6d 6f64 6966 6965 642c  ].last_modified,
+00013f70: 2064 6174 6574 696d 655f 6e7a 6474 2832   datetime_nzdt(2
+00013f80: 3032 302c 2031 2c20 312c 2031 2c20 312c  020, 1, 1, 1, 1,
+00013f90: 2031 2c20 3029 290a 2020 2020 2020 2020   1, 0)).        
+00013fa0: 7365 6c66 2e61 7373 6572 7449 7328 696e  self.assertIs(in
+00013fb0: 666f 735b 315d 2e75 7365 725f 6964 2c20  fos[1].user_id, 
+00013fc0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+00013fd0: 6c66 2e61 7373 6572 7449 7328 696e 666f  lf.assertIs(info
+00013fe0: 735b 315d 2e75 7365 722c 204e 6f6e 6529  s[1].user, None)
+00013ff0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00014000: 7365 7274 4973 2869 6e66 6f73 5b31 5d2e  sertIs(infos[1].
+00014010: 6772 6f75 705f 6964 2c20 4e6f 6e65 290a  group_id, None).
+00014020: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014030: 6572 7449 7328 696e 666f 735b 315d 2e67  ertIs(infos[1].g
+00014040: 726f 7570 2c20 4e6f 6e65 290a 0a20 2020  roup, None)..   
+00014050: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014060: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+00014070: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+00014080: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+00014090: 2c20 272f 7631 2f66 696c 6573 272c 207b  , '/v1/files', {
+000140a0: 2761 6374 696f 6e27 3a20 276c 6973 7427  'action': 'list'
+000140b0: 2c20 2770 6174 6827 3a20 272f 6574 6327  , 'path': '/etc'
+000140c0: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
+000140d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+000140e0: 7374 5f6c 6973 745f 6669 6c65 735f 7061  st_list_files_pa
+000140f0: 7474 6572 6e28 7365 6c66 293a 0a20 2020  ttern(self):.   
+00014100: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00014110: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+00014120: 6428 7b0a 2020 2020 2020 2020 2020 2020  d({.            
+00014130: 2272 6573 756c 7422 3a20 5b5d 2c0a 2020  "result": [],.  
+00014140: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+00014150: 7327 3a20 274f 4b27 2c0a 2020 2020 2020  s': 'OK',.      
+00014160: 2020 2020 2020 2773 7461 7475 732d 636f        'status-co
+00014170: 6465 273a 2032 3030 2c0a 2020 2020 2020  de': 200,.      
+00014180: 2020 2020 2020 2774 7970 6527 3a20 2773        'type': 's
+00014190: 796e 6327 2c0a 2020 2020 2020 2020 7d29  ync',.        })
+000141a0: 0a0a 2020 2020 2020 2020 696e 666f 7320  ..        infos 
+000141b0: 3d20 7365 6c66 2e63 6c69 656e 742e 6c69  = self.client.li
+000141c0: 7374 5f66 696c 6573 2827 2f65 7463 272c  st_files('/etc',
+000141d0: 2070 6174 7465 726e 3d27 2a2e 636f 6e66   pattern='*.conf
+000141e0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+000141f0: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00014200: 2869 6e66 6f73 292c 2030 290a 2020 2020  (infos), 0).    
+00014210: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00014220: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+00014230: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+00014240: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+00014250: 2027 2f76 312f 6669 6c65 7327 2c20 7b27   '/v1/files', {'
+00014260: 6163 7469 6f6e 273a 2027 6c69 7374 272c  action': 'list',
+00014270: 2027 7061 7468 273a 2027 2f65 7463 272c   'path': '/etc',
+00014280: 2027 7061 7474 6572 6e27 3a20 272a 2e63   'pattern': '*.c
+00014290: 6f6e 6627 7d2c 204e 6f6e 6529 2c0a 2020  onf'}, None),.  
+000142a0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+000142b0: 6620 7465 7374 5f6c 6973 745f 6669 6c65  f test_list_file
+000142c0: 735f 6974 7365 6c66 2873 656c 6629 3a0a  s_itself(self):.
+000142d0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+000142e0: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+000142f0: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+00014300: 2020 2022 7265 7375 6c74 223a 205b 5d2c     "result": [],
+00014310: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
+00014320: 6174 7573 273a 2027 4f4b 272c 0a20 2020  atus': 'OK',.   
+00014330: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+00014340: 2d63 6f64 6527 3a20 3230 302c 0a20 2020  -code': 200,.   
+00014350: 2020 2020 2020 2020 2027 7479 7065 273a           'type':
+00014360: 2027 7379 6e63 272c 0a20 2020 2020 2020   'sync',.       
+00014370: 207d 290a 0a20 2020 2020 2020 2069 6e66   })..        inf
+00014380: 6f73 203d 2073 656c 662e 636c 6965 6e74  os = self.client
+00014390: 2e6c 6973 745f 6669 6c65 7328 272f 6574  .list_files('/et
+000143a0: 6327 2c20 6974 7365 6c66 3d54 7275 6529  c', itself=True)
+000143b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000143c0: 7373 6572 7445 7175 616c 286c 656e 2869  ssertEqual(len(i
+000143d0: 6e66 6f73 292c 2030 290a 2020 2020 2020  nfos), 0).      
+000143e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000143f0: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+00014400: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+00014410: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+00014420: 2f76 312f 6669 6c65 7327 2c20 7b27 6163  /v1/files', {'ac
+00014430: 7469 6f6e 273a 2027 6c69 7374 272c 2027  tion': 'list', '
+00014440: 7061 7468 273a 2027 2f65 7463 272c 2027  path': '/etc', '
+00014450: 6974 7365 6c66 273a 2027 7472 7565 277d  itself': 'true'}
+00014460: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+00014470: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00014480: 745f 6d61 6b65 5f64 6972 5f62 6173 6963  t_make_dir_basic
+00014490: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000144a0: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
+000144b0: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
+000144c0: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+000144d0: 6c74 223a 205b 7b27 7061 7468 273a 2027  lt": [{'path': '
+000144e0: 2f66 6f6f 2f62 6172 277d 5d2c 0a20 2020  /foo/bar'}],.   
+000144f0: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+00014500: 273a 2027 4f4b 272c 0a20 2020 2020 2020  ': 'OK',.       
+00014510: 2020 2020 2027 7374 6174 7573 2d63 6f64       'status-cod
+00014520: 6527 3a20 3230 302c 0a20 2020 2020 2020  e': 200,.       
+00014530: 2020 2020 2027 7479 7065 273a 2027 7379       'type': 'sy
+00014540: 6e63 272c 0a20 2020 2020 2020 207d 290a  nc',.        }).
+00014550: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+00014560: 656e 742e 6d61 6b65 5f64 6972 2827 2f66  ent.make_dir('/f
+00014570: 6f6f 2f62 6172 2729 0a20 2020 2020 2020  oo/bar').       
+00014580: 2072 6571 203d 207b 2761 6374 696f 6e27   req = {'action'
+00014590: 3a20 276d 616b 652d 6469 7273 272c 2027  : 'make-dirs', '
+000145a0: 6469 7273 273a 205b 7b0a 2020 2020 2020  dirs': [{.      
+000145b0: 2020 2020 2020 2770 6174 6827 3a20 272f        'path': '/
+000145c0: 666f 6f2f 6261 7227 2c0a 2020 2020 2020  foo/bar',.      
+000145d0: 2020 7d5d 7d0a 2020 2020 2020 2020 7365    }]}.        se
+000145e0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+000145f0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00014600: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00014610: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+00014620: 2f66 696c 6573 272c 204e 6f6e 652c 2072  /files', None, r
+00014630: 6571 292c 0a20 2020 2020 2020 205d 290a  eq),.        ]).
+00014640: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
+00014650: 6b65 5f64 6972 5f61 6c6c 5f6f 7074 696f  ke_dir_all_optio
+00014660: 6e73 2873 656c 6629 3a0a 2020 2020 2020  ns(self):.      
+00014670: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+00014680: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
+00014690: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+000146a0: 7375 6c74 223a 205b 7b27 7061 7468 273a  sult": [{'path':
+000146b0: 2027 2f66 6f6f 2f62 6172 277d 5d2c 0a20   '/foo/bar'}],. 
+000146c0: 2020 2020 2020 2020 2020 2027 7374 6174             'stat
+000146d0: 7573 273a 2027 4f4b 272c 0a20 2020 2020  us': 'OK',.     
+000146e0: 2020 2020 2020 2027 7374 6174 7573 2d63         'status-c
+000146f0: 6f64 6527 3a20 3230 302c 0a20 2020 2020  ode': 200,.     
+00014700: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
+00014710: 7379 6e63 272c 0a20 2020 2020 2020 207d  sync',.        }
+00014720: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+00014730: 6c69 656e 742e 6d61 6b65 5f64 6972 2827  lient.make_dir('
+00014740: 2f66 6f6f 2f62 6172 272c 206d 616b 655f  /foo/bar', make_
+00014750: 7061 7265 6e74 733d 5472 7565 2c20 7065  parents=True, pe
+00014760: 726d 6973 7369 6f6e 733d 306f 3630 302c  rmissions=0o600,
+00014770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014780: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00014790: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
+000147a0: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
+000147b0: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
+000147c0: 290a 0a20 2020 2020 2020 2072 6571 203d  )..        req =
+000147d0: 207b 2761 6374 696f 6e27 3a20 276d 616b   {'action': 'mak
+000147e0: 652d 6469 7273 272c 2027 6469 7273 273a  e-dirs', 'dirs':
+000147f0: 205b 7b0a 2020 2020 2020 2020 2020 2020   [{.            
+00014800: 2770 6174 6827 3a20 272f 666f 6f2f 6261  'path': '/foo/ba
+00014810: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
+00014820: 276d 616b 652d 7061 7265 6e74 7327 3a20  'make-parents': 
+00014830: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00014840: 2020 2770 6572 6d69 7373 696f 6e73 273a    'permissions':
+00014850: 2027 3630 3027 2c0a 2020 2020 2020 2020   '600',.        
+00014860: 2020 2020 2775 7365 722d 6964 273a 2031      'user-id': 1
+00014870: 322c 0a20 2020 2020 2020 2020 2020 2027  2,.            '
+00014880: 7573 6572 273a 2027 626f 6227 2c0a 2020  user': 'bob',.  
+00014890: 2020 2020 2020 2020 2020 2767 726f 7570            'group
+000148a0: 2d69 6427 3a20 3334 2c0a 2020 2020 2020  -id': 34,.      
+000148b0: 2020 2020 2020 2767 726f 7570 273a 2027        'group': '
+000148c0: 7374 6166 6627 2c0a 2020 2020 2020 2020  staff',.        
+000148d0: 7d5d 7d0a 2020 2020 2020 2020 7365 6c66  }]}.        self
+000148e0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+000148f0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
+00014900: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00014910: 2028 2750 4f53 5427 2c20 272f 7631 2f66   ('POST', '/v1/f
+00014920: 696c 6573 272c 204e 6f6e 652c 2072 6571  iles', None, req
+00014930: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+00014940: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+00014950: 5f64 6972 5f65 7272 6f72 2873 656c 6629  _dir_error(self)
+00014960: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00014970: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+00014980: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
+00014990: 2020 2020 2022 7265 7375 6c74 223a 205b       "result": [
+000149a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000149b0: 2020 2770 6174 6827 3a20 272f 666f 6f2f    'path': '/foo/
+000149c0: 6261 7227 2c0a 2020 2020 2020 2020 2020  bar',.          
+000149d0: 2020 2020 2020 2765 7272 6f72 273a 207b        'error': {
+000149e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000149f0: 2020 2020 2027 6b69 6e64 273a 2027 7065       'kind': 'pe
+00014a00: 726d 6973 7369 6f6e 2d64 656e 6965 6427  rmission-denied'
+00014a10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014a20: 2020 2020 2020 276d 6573 7361 6765 273a        'message':
+00014a30: 2027 7065 726d 6973 7369 6f6e 2064 656e   'permission den
+00014a40: 6965 6427 2c0a 2020 2020 2020 2020 2020  ied',.          
+00014a50: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00014a60: 2020 2020 207d 5d2c 0a20 2020 2020 2020       }],.       
+00014a70: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
+00014a80: 4f4b 272c 0a20 2020 2020 2020 2020 2020  OK',.           
+00014a90: 2027 7374 6174 7573 2d63 6f64 6527 3a20   'status-code': 
+00014aa0: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
+00014ab0: 2027 7479 7065 273a 2027 7379 6e63 272c   'type': 'sync',
+00014ac0: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00014ad0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00014ae0: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
+00014af0: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
+00014b00: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+00014b10: 7365 6c66 2e63 6c69 656e 742e 6d61 6b65  self.client.make
+00014b20: 5f64 6972 2827 2f66 6f6f 2f62 6172 2729  _dir('/foo/bar')
+00014b30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00014b40: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
+00014b50: 6d2e 6578 6365 7074 696f 6e2c 2070 6562  m.exception, peb
+00014b60: 626c 652e 4572 726f 7229 0a20 2020 2020  ble.Error).     
+00014b70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00014b80: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
+00014b90: 2e6b 696e 642c 2027 7065 726d 6973 7369  .kind, 'permissi
+00014ba0: 6f6e 2d64 656e 6965 6427 290a 2020 2020  on-denied').    
+00014bb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00014bc0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00014bd0: 6e2e 6d65 7373 6167 652c 2027 7065 726d  n.message, 'perm
+00014be0: 6973 7369 6f6e 2064 656e 6965 6427 290a  ission denied').
+00014bf0: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00014c00: 6d6f 7665 5f70 6174 685f 6261 7369 6328  move_path_basic(
+00014c10: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00014c20: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00014c30: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+00014c40: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+00014c50: 7422 3a20 5b7b 2770 6174 6827 3a20 272f  t": [{'path': '/
+00014c60: 626f 6f2f 6661 7227 7d5d 2c0a 2020 2020  boo/far'}],.    
+00014c70: 2020 2020 2020 2020 2773 7461 7475 7327          'status'
+00014c80: 3a20 274f 4b27 2c0a 2020 2020 2020 2020  : 'OK',.        
+00014c90: 2020 2020 2773 7461 7475 732d 636f 6465      'status-code
+00014ca0: 273a 2032 3030 2c0a 2020 2020 2020 2020  ': 200,.        
+00014cb0: 2020 2020 2774 7970 6527 3a20 2773 796e      'type': 'syn
+00014cc0: 6327 2c0a 2020 2020 2020 2020 7d29 0a20  c',.        }). 
+00014cd0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00014ce0: 6e74 2e72 656d 6f76 655f 7061 7468 2827  nt.remove_path('
+00014cf0: 2f62 6f6f 2f66 6172 2729 0a20 2020 2020  /boo/far').     
+00014d00: 2020 2072 6571 203d 207b 2761 6374 696f     req = {'actio
+00014d10: 6e27 3a20 2772 656d 6f76 6527 2c20 2770  n': 'remove', 'p
+00014d20: 6174 6873 273a 205b 7b0a 2020 2020 2020  aths': [{.      
+00014d30: 2020 2020 2020 2770 6174 6827 3a20 272f        'path': '/
+00014d40: 626f 6f2f 6661 7227 2c0a 2020 2020 2020  boo/far',.      
+00014d50: 2020 7d5d 7d0a 2020 2020 2020 2020 7365    }]}.        se
+00014d60: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00014d70: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00014d80: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00014d90: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+00014da0: 2f66 696c 6573 272c 204e 6f6e 652c 2072  /files', None, r
+00014db0: 6571 292c 0a20 2020 2020 2020 205d 290a  eq),.        ]).
+00014dc0: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00014dd0: 6d6f 7665 5f70 6174 685f 7265 6375 7273  move_path_recurs
+00014de0: 6976 6528 7365 6c66 293a 0a20 2020 2020  ive(self):.     
+00014df0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00014e00: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+00014e10: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+00014e20: 6573 756c 7422 3a20 5b7b 2770 6174 6827  esult": [{'path'
+00014e30: 3a20 272f 626f 6f2f 6661 7227 7d5d 2c0a  : '/boo/far'}],.
+00014e40: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+00014e50: 7475 7327 3a20 274f 4b27 2c0a 2020 2020  tus': 'OK',.    
+00014e60: 2020 2020 2020 2020 2773 7461 7475 732d          'status-
+00014e70: 636f 6465 273a 2032 3030 2c0a 2020 2020  code': 200,.    
+00014e80: 2020 2020 2020 2020 2774 7970 6527 3a20          'type': 
+00014e90: 2773 796e 6327 2c0a 2020 2020 2020 2020  'sync',.        
+00014ea0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+00014eb0: 636c 6965 6e74 2e72 656d 6f76 655f 7061  client.remove_pa
+00014ec0: 7468 2827 2f62 6f6f 2f66 6172 272c 2072  th('/boo/far', r
+00014ed0: 6563 7572 7369 7665 3d54 7275 6529 0a0a  ecursive=True)..
+00014ee0: 2020 2020 2020 2020 7265 7120 3d20 7b27          req = {'
+00014ef0: 6163 7469 6f6e 273a 2027 7265 6d6f 7665  action': 'remove
+00014f00: 272c 2027 7061 7468 7327 3a20 5b7b 0a20  ', 'paths': [{. 
+00014f10: 2020 2020 2020 2020 2020 2027 7061 7468             'path
+00014f20: 273a 2027 2f62 6f6f 2f66 6172 272c 0a20  ': '/boo/far',. 
+00014f30: 2020 2020 2020 2020 2020 2027 7265 6375             'recu
+00014f40: 7273 6976 6527 3a20 5472 7565 2c0a 2020  rsive': True,.  
+00014f50: 2020 2020 2020 7d5d 7d0a 2020 2020 2020        }]}.      
+00014f60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00014f70: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+00014f80: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+00014f90: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+00014fa0: 272f 7631 2f66 696c 6573 272c 204e 6f6e  '/v1/files', Non
+00014fb0: 652c 2072 6571 292c 0a20 2020 2020 2020  e, req),.       
+00014fc0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00014fd0: 745f 7265 6d6f 7665 5f70 6174 685f 6572  t_remove_path_er
+00014fe0: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+00014ff0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00015000: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+00015010: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+00015020: 6573 756c 7422 3a20 5b7b 0a20 2020 2020  esult": [{.     
+00015030: 2020 2020 2020 2020 2020 2027 7061 7468             'path
+00015040: 273a 2027 2f62 6f6f 2f66 6172 272c 0a20  ': '/boo/far',. 
+00015050: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00015060: 6572 726f 7227 3a20 7b0a 2020 2020 2020  error': {.      
+00015070: 2020 2020 2020 2020 2020 2020 2020 276b                'k
+00015080: 696e 6427 3a20 2767 656e 6572 6963 2d66  ind': 'generic-f
+00015090: 696c 652d 6572 726f 7227 2c0a 2020 2020  ile-error',.    
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150b0: 276d 6573 7361 6765 273a 2027 736f 6d65  'message': 'some
+000150c0: 206f 7468 6572 2065 7272 6f72 272c 0a20   other error',. 
+000150d0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000150e0: 2c0a 2020 2020 2020 2020 2020 2020 7d5d  ,.            }]
+000150f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00015100: 7461 7475 7327 3a20 274f 4b27 2c0a 2020  tatus': 'OK',.  
+00015110: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+00015120: 732d 636f 6465 273a 2032 3030 2c0a 2020  s-code': 200,.  
+00015130: 2020 2020 2020 2020 2020 2774 7970 6527            'type'
+00015140: 3a20 2773 796e 6327 2c0a 2020 2020 2020  : 'sync',.      
+00015150: 2020 7d29 0a20 2020 2020 2020 2077 6974    }).        wit
+00015160: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00015170: 7365 7328 7065 6262 6c65 2e50 6174 6845  ses(pebble.PathE
+00015180: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+00015190: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+000151a0: 6965 6e74 2e72 656d 6f76 655f 7061 7468  ient.remove_path
+000151b0: 2827 2f62 6f6f 2f66 6172 2729 0a20 2020  ('/boo/far').   
+000151c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000151d0: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
+000151e0: 6365 7074 696f 6e2c 2070 6562 626c 652e  ception, pebble.
+000151f0: 4572 726f 7229 0a20 2020 2020 2020 2073  Error).        s
+00015200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00015210: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
+00015220: 642c 2027 6765 6e65 7269 632d 6669 6c65  d, 'generic-file
+00015230: 2d65 7272 6f72 2729 0a20 2020 2020 2020  -error').       
+00015240: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00015250: 6c28 636d 2e65 7863 6570 7469 6f6e 2e6d  l(cm.exception.m
+00015260: 6573 7361 6765 2c20 2773 6f6d 6520 6f74  essage, 'some ot
+00015270: 6865 7220 6572 726f 7227 290a 0a20 2020  her error')..   
+00015280: 2064 6566 2074 6573 745f 7365 6e64 5f73   def test_send_s
+00015290: 6967 6e61 6c5f 6e61 6d65 2873 656c 6629  ignal_name(self)
+000152a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+000152b0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+000152c0: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
+000152d0: 2020 2020 2027 7265 7375 6c74 273a 2054       'result': T
+000152e0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+000152f0: 2027 7374 6174 7573 273a 2027 4f4b 272c   'status': 'OK',
+00015300: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
+00015310: 6174 7573 2d63 6f64 6527 3a20 3230 302c  atus-code': 200,
+00015320: 0a20 2020 2020 2020 2020 2020 2027 7479  .            'ty
+00015330: 7065 273a 2027 7379 6e63 272c 0a20 2020  pe': 'sync',.   
+00015340: 2020 2020 207d 290a 0a20 2020 2020 2020       })..       
+00015350: 2073 656c 662e 636c 6965 6e74 2e73 656e   self.client.sen
+00015360: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
+00015370: 272c 205b 2773 3127 2c20 2773 3227 5d29  ', ['s1', 's2'])
+00015380: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00015390: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+000153a0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+000153b0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+000153c0: 2750 4f53 5427 2c20 272f 7631 2f73 6967  'POST', '/v1/sig
+000153d0: 6e61 6c73 272c 204e 6f6e 652c 207b 2773  nals', None, {'s
+000153e0: 6967 6e61 6c27 3a20 2753 4947 4855 5027  ignal': 'SIGHUP'
+000153f0: 2c20 2773 6572 7669 6365 7327 3a20 5b27  , 'services': ['
+00015400: 7331 272c 2027 7332 275d 7d29 2c0a 2020  s1', 's2']}),.  
+00015410: 2020 2020 2020 5d29 0a0a 2020 2020 4075        ])..    @u
+00015420: 6e69 7474 6573 742e 736b 6970 556e 6c65  nittest.skipUnle
+00015430: 7373 2868 6173 6174 7472 2873 6967 6e61  ss(hasattr(signa
+00015440: 6c2c 2027 5349 4748 5550 2729 2c20 2773  l, 'SIGHUP'), 's
+00015450: 6967 6e61 6c20 636f 6e73 7461 6e74 7320  ignal constants 
+00015460: 6e6f 7420 7072 6573 656e 7427 290a 2020  not present').  
+00015470: 2020 6465 6620 7465 7374 5f73 656e 645f    def test_send_
+00015480: 7369 676e 616c 5f6e 756d 6265 7228 7365  signal_number(se
+00015490: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000154a0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+000154b0: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
+000154c0: 2020 2020 2020 2020 2772 6573 756c 7427          'result'
+000154d0: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
+000154e0: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
+000154f0: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
+00015500: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
+00015510: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00015520: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
+00015530: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+00015540: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00015550: 7365 6e64 5f73 6967 6e61 6c28 7369 676e  send_signal(sign
+00015560: 616c 2e53 4947 4855 502c 205b 2773 3127  al.SIGHUP, ['s1'
+00015570: 2c20 2773 3227 5d29 0a0a 2020 2020 2020  , 's2'])..      
+00015580: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015590: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+000155a0: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+000155b0: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+000155c0: 272f 7631 2f73 6967 6e61 6c73 272c 204e  '/v1/signals', N
+000155d0: 6f6e 652c 207b 2773 6967 6e61 6c27 3a20  one, {'signal': 
+000155e0: 2753 4947 4855 5027 2c20 2773 6572 7669  'SIGHUP', 'servi
+000155f0: 6365 7327 3a20 5b27 7331 272c 2027 7332  ces': ['s1', 's2
+00015600: 275d 7d29 2c0a 2020 2020 2020 2020 5d29  ']}),.        ])
+00015610: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00015620: 656e 645f 7369 676e 616c 5f74 7970 655f  end_signal_type_
+00015630: 6572 726f 7228 7365 6c66 293a 0a20 2020  error(self):.   
+00015640: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00015650: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+00015660: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00015670: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00015680: 7365 6e64 5f73 6967 6e61 6c28 2753 4947  send_signal('SIG
+00015690: 4855 5027 2c20 2773 686f 756c 642d 6265  HUP', 'should-be
+000156a0: 2d61 2d6c 6973 7427 290a 0a20 2020 2020  -a-list')..     
+000156b0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+000156c0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+000156d0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000156e0: 2020 7365 6c66 2e63 6c69 656e 742e 7365    self.client.se
+000156f0: 6e64 5f73 6967 6e61 6c28 2753 4947 4855  nd_signal('SIGHU
+00015700: 5027 2c20 5b31 2c20 325d 290a 0a20 2020  P', [1, 2])..   
+00015710: 2064 6566 2074 6573 745f 6765 745f 6368   def test_get_ch
+00015720: 6563 6b73 5f61 6c6c 2873 656c 6629 3a0a  ecks_all(self):.
+00015730: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+00015740: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+00015750: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+00015760: 2020 2022 7265 7375 6c74 223a 205b 0a20     "result": [. 
+00015770: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00015780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015790: 2020 2020 2022 6e61 6d65 223a 2022 6368       "name": "ch
+000157a0: 6b31 222c 0a20 2020 2020 2020 2020 2020  k1",.           
+000157b0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+000157c0: 223a 2022 7570 222c 0a20 2020 2020 2020  ": "up",.       
+000157d0: 2020 2020 2020 2020 2020 2020 2022 7468               "th
+000157e0: 7265 7368 6f6c 6422 3a20 322c 0a20 2020  reshold": 2,.   
+000157f0: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00015800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015810: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00015820: 2020 2020 2020 226e 616d 6522 3a20 2263        "name": "c
+00015830: 686b 3222 2c0a 2020 2020 2020 2020 2020  hk2",.          
+00015840: 2020 2020 2020 2020 2020 226c 6576 656c            "level
+00015850: 223a 2022 616c 6976 6522 2c0a 2020 2020  ": "alive",.    
+00015860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015870: 2273 7461 7475 7322 3a20 2264 6f77 6e22  "status": "down"
+00015880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015890: 2020 2020 2020 2266 6169 6c75 7265 7322        "failures"
+000158a0: 3a20 352c 0a20 2020 2020 2020 2020 2020  : 5,.           
+000158b0: 2020 2020 2020 2020 2022 7468 7265 7368           "thresh
+000158c0: 6f6c 6422 3a20 332c 0a20 2020 2020 2020  old": 3,.       
+000158d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000158e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000158f0: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+00015900: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
+00015910: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
+00015920: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
+00015930: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
+00015940: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00015950: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
+00015960: 662e 636c 6965 6e74 2e67 6574 5f63 6865  f.client.get_che
+00015970: 636b 7328 290a 2020 2020 2020 2020 7365  cks().        se
+00015980: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+00015990: 656e 2863 6865 636b 7329 2c20 3229 0a20  en(checks), 2). 
+000159a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000159b0: 7274 4571 7561 6c28 6368 6563 6b73 5b30  rtEqual(checks[0
+000159c0: 5d2e 6e61 6d65 2c20 2763 686b 3127 290a  ].name, 'chk1').
+000159d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000159e0: 6572 7445 7175 616c 2863 6865 636b 735b  ertEqual(checks[
+000159f0: 305d 2e6c 6576 656c 2c20 7065 6262 6c65  0].level, pebble
+00015a00: 2e43 6865 636b 4c65 7665 6c2e 554e 5345  .CheckLevel.UNSE
+00015a10: 5429 0a20 2020 2020 2020 2073 656c 662e  T).        self.
+00015a20: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+00015a30: 6b73 5b30 5d2e 7374 6174 7573 2c20 7065  ks[0].status, pe
+00015a40: 6262 6c65 2e43 6865 636b 5374 6174 7573  bble.CheckStatus
+00015a50: 2e55 5029 0a20 2020 2020 2020 2073 656c  .UP).        sel
+00015a60: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00015a70: 6563 6b73 5b30 5d2e 6661 696c 7572 6573  ecks[0].failures
+00015a80: 2c20 3029 0a20 2020 2020 2020 2073 656c  , 0).        sel
+00015a90: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00015aa0: 6563 6b73 5b30 5d2e 7468 7265 7368 6f6c  ecks[0].threshol
+00015ab0: 642c 2032 290a 2020 2020 2020 2020 7365  d, 2).        se
+00015ac0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00015ad0: 6865 636b 735b 315d 2e6e 616d 652c 2027  hecks[1].name, '
+00015ae0: 6368 6b32 2729 0a20 2020 2020 2020 2073  chk2').        s
+00015af0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00015b00: 6368 6563 6b73 5b31 5d2e 6c65 7665 6c2c  checks[1].level,
+00015b10: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
+00015b20: 656c 2e41 4c49 5645 290a 2020 2020 2020  el.ALIVE).      
+00015b30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015b40: 616c 2863 6865 636b 735b 315d 2e73 7461  al(checks[1].sta
+00015b50: 7475 732c 2070 6562 626c 652e 4368 6563  tus, pebble.Chec
+00015b60: 6b53 7461 7475 732e 444f 574e 290a 2020  kStatus.DOWN).  
+00015b70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015b80: 7445 7175 616c 2863 6865 636b 735b 315d  tEqual(checks[1]
+00015b90: 2e66 6169 6c75 7265 732c 2035 290a 2020  .failures, 5).  
+00015ba0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015bb0: 7445 7175 616c 2863 6865 636b 735b 315d  tEqual(checks[1]
+00015bc0: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
+00015bd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015be0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+00015bf0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+00015c00: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00015c10: 4554 272c 2027 2f76 312f 6368 6563 6b73  ET', '/v1/checks
+00015c20: 272c 207b 7d2c 204e 6f6e 6529 2c0a 2020  ', {}, None),.  
+00015c30: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+00015c40: 6620 7465 7374 5f67 6574 5f63 6865 636b  f test_get_check
+00015c50: 735f 6669 6c74 6572 7328 7365 6c66 293a  s_filters(self):
+00015c60: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00015c70: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+00015c80: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
+00015c90: 2020 2020 2272 6573 756c 7422 3a20 5b0a      "result": [.
+00015ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00015cc0: 2020 2020 2020 226e 616d 6522 3a20 2263        "name": "c
+00015cd0: 686b 3222 2c0a 2020 2020 2020 2020 2020  hk2",.          
+00015ce0: 2020 2020 2020 2020 2020 226c 6576 656c            "level
+00015cf0: 223a 2022 7265 6164 7922 2c0a 2020 2020  ": "ready",.    
+00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d10: 2273 7461 7475 7322 3a20 2275 7022 2c0a  "status": "up",.
+00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d30: 2020 2020 2274 6872 6573 686f 6c64 223a      "threshold":
+00015d40: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
+00015d50: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00015d60: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00015d70: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
+00015d80: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00015d90: 7461 7475 732d 636f 6465 223a 2032 3030  tatus-code": 200
+00015da0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00015db0: 7970 6522 3a20 2273 796e 6322 0a20 2020  ype": "sync".   
+00015dc0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+00015dd0: 6368 6563 6b73 203d 2073 656c 662e 636c  checks = self.cl
+00015de0: 6965 6e74 2e67 6574 5f63 6865 636b 7328  ient.get_checks(
+00015df0: 6c65 7665 6c3d 7065 6262 6c65 2e43 6865  level=pebble.Che
+00015e00: 636b 4c65 7665 6c2e 5245 4144 592c 206e  ckLevel.READY, n
+00015e10: 616d 6573 3d5b 2763 686b 3227 5d29 0a20  ames=['chk2']). 
+00015e20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015e30: 7274 4571 7561 6c28 6c65 6e28 6368 6563  rtEqual(len(chec
+00015e40: 6b73 292c 2031 290a 2020 2020 2020 2020  ks), 1).        
+00015e50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00015e60: 2863 6865 636b 735b 305d 2e6e 616d 652c  (checks[0].name,
+00015e70: 2027 6368 6b32 2729 0a20 2020 2020 2020   'chk2').       
+00015e80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00015e90: 6c28 6368 6563 6b73 5b30 5d2e 6c65 7665  l(checks[0].leve
+00015ea0: 6c2c 2070 6562 626c 652e 4368 6563 6b4c  l, pebble.CheckL
+00015eb0: 6576 656c 2e52 4541 4459 290a 2020 2020  evel.READY).    
+00015ec0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00015ed0: 7175 616c 2863 6865 636b 735b 305d 2e73  qual(checks[0].s
+00015ee0: 7461 7475 732c 2070 6562 626c 652e 4368  tatus, pebble.Ch
+00015ef0: 6563 6b53 7461 7475 732e 5550 290a 2020  eckStatus.UP).  
+00015f00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015f10: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+00015f20: 2e66 6169 6c75 7265 732c 2030 290a 2020  .failures, 0).  
+00015f30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015f40: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+00015f50: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
+00015f60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015f70: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+00015f80: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+00015f90: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00015fa0: 4554 272c 2027 2f76 312f 6368 6563 6b73  ET', '/v1/checks
+00015fb0: 272c 207b 276c 6576 656c 273a 2027 7265  ', {'level': 're
+00015fc0: 6164 7927 2c20 276e 616d 6573 273a 205b  ady', 'names': [
+00015fd0: 2763 686b 3227 5d7d 2c20 4e6f 6e65 292c  'chk2']}, None),
+00015fe0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+00015ff0: 2064 6566 2074 6573 745f 6368 6563 6b6c   def test_checkl
+00016000: 6576 656c 5f63 6f6e 7665 7273 696f 6e28  evel_conversion(
+00016010: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00016020: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00016030: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+00016040: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+00016050: 7422 3a20 5b0a 2020 2020 2020 2020 2020  t": [.          
+00016060: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00016070: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
+00016080: 6522 3a20 2263 686b 3222 2c0a 2020 2020  e": "chk2",.    
+00016090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160a0: 226c 6576 656c 223a 2022 666f 6f62 6172  "level": "foobar
+000160b0: 2122 2c0a 2020 2020 2020 2020 2020 2020  !",.            
+000160c0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+000160d0: 3a20 2275 7022 2c0a 2020 2020 2020 2020  : "up",.        
+000160e0: 2020 2020 2020 2020 2020 2020 2274 6872              "thr
+000160f0: 6573 686f 6c64 223a 2033 2c0a 2020 2020  eshold": 3,.    
+00016100: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00016110: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00016120: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00016130: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+00016140: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+00016150: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+00016160: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+00016170: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+00016180: 2020 2020 2020 2020 6368 6563 6b73 203d          checks =
+00016190: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
+000161a0: 5f63 6865 636b 7328 6c65 7665 6c3d 7065  _checks(level=pe
+000161b0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+000161c0: 5245 4144 592c 206e 616d 6573 3d5b 2763  READY, names=['c
+000161d0: 686b 3227 5d29 0a20 2020 2020 2020 2073  hk2']).        s
+000161e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000161f0: 6c65 6e28 6368 6563 6b73 292c 2031 290a  len(checks), 1).
+00016200: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00016210: 6572 7445 7175 616c 2863 6865 636b 735b  ertEqual(checks[
+00016220: 305d 2e6e 616d 652c 2027 6368 6b32 2729  0].name, 'chk2')
+00016230: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016240: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+00016250: 5b30 5d2e 6c65 7665 6c2c 2027 666f 6f62  [0].level, 'foob
+00016260: 6172 2127 2920 2023 2073 7461 7973 2061  ar!')  # stays a
+00016270: 2072 6177 2073 7472 696e 670a 2020 2020   raw string.    
+00016280: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016290: 7175 616c 2863 6865 636b 735b 305d 2e73  qual(checks[0].s
+000162a0: 7461 7475 732c 2070 6562 626c 652e 4368  tatus, pebble.Ch
+000162b0: 6563 6b53 7461 7475 732e 5550 290a 2020  eckStatus.UP).  
+000162c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000162d0: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+000162e0: 2e66 6169 6c75 7265 732c 2030 290a 2020  .failures, 0).  
+000162f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016300: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+00016310: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
+00016320: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00016330: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+00016340: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+00016350: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00016360: 4554 272c 2027 2f76 312f 6368 6563 6b73  ET', '/v1/checks
+00016370: 272c 207b 276c 6576 656c 273a 2027 7265  ', {'level': 're
+00016380: 6164 7927 2c20 276e 616d 6573 273a 205b  ady', 'names': [
+00016390: 2763 686b 3227 5d7d 2c20 4e6f 6e65 292c  'chk2']}, None),
+000163a0: 0a20 2020 2020 2020 205d 290a 0a0a 636c  .        ])...cl
+000163b0: 6173 7320 5465 7374 536f 636b 6574 436c  ass TestSocketCl
+000163c0: 6965 6e74 2875 6e69 7474 6573 742e 5465  ient(unittest.Te
+000163d0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+000163e0: 2074 6573 745f 736f 636b 6574 5f6e 6f74   test_socket_not
+000163f0: 5f66 6f75 6e64 2873 656c 6629 3a0a 2020  _found(self):.  
+00016400: 2020 2020 2020 636c 6965 6e74 203d 2070        client = p
+00016410: 6562 626c 652e 436c 6965 6e74 2873 6f63  ebble.Client(soc
+00016420: 6b65 745f 7061 7468 3d27 646f 6573 5f6e  ket_path='does_n
+00016430: 6f74 5f65 7869 7374 2729 0a20 2020 2020  ot_exist').     
+00016440: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00016450: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
+00016460: 2e43 6f6e 6e65 6374 696f 6e45 7272 6f72  .ConnectionError
+00016470: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00016480: 2020 2020 2063 6c69 656e 742e 6765 745f       client.get_
+00016490: 7379 7374 656d 5f69 6e66 6f28 290a 2020  system_info().  
+000164a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000164b0: 7449 7349 6e73 7461 6e63 6528 636d 2e65  tIsInstance(cm.e
+000164c0: 7863 6570 7469 6f6e 2c20 7065 6262 6c65  xception, pebble
+000164d0: 2e45 7272 6f72 290a 0a20 2020 2064 6566  .Error)..    def
+000164e0: 2074 6573 745f 7265 616c 5f63 6c69 656e   test_real_clien
+000164f0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+00016500: 2073 6875 7464 6f77 6e2c 2073 6f63 6b65   shutdown, socke
+00016510: 745f 7061 7468 203d 2066 616b 655f 7065  t_path = fake_pe
+00016520: 6262 6c65 2e73 7461 7274 5f73 6572 7665  bble.start_serve
+00016530: 7228 290a 0a20 2020 2020 2020 2074 7279  r()..        try
+00016540: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00016550: 6965 6e74 203d 2070 6562 626c 652e 436c  ient = pebble.Cl
+00016560: 6965 6e74 2873 6f63 6b65 745f 7061 7468  ient(socket_path
+00016570: 3d73 6f63 6b65 745f 7061 7468 290a 2020  =socket_path).  
+00016580: 2020 2020 2020 2020 2020 696e 666f 203d            info =
+00016590: 2063 6c69 656e 742e 6765 745f 7379 7374   client.get_syst
+000165a0: 656d 5f69 6e66 6f28 290a 2020 2020 2020  em_info().      
+000165b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000165c0: 7445 7175 616c 2869 6e66 6f2e 7665 7273  tEqual(info.vers
+000165d0: 696f 6e2c 2027 332e 3134 2e31 3539 2729  ion, '3.14.159')
+000165e0: 0a0a 2020 2020 2020 2020 2020 2020 6368  ..            ch
+000165f0: 616e 6765 5f69 6420 3d20 636c 6965 6e74  ange_id = client
+00016600: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
+00016610: 5b27 666f 6f27 5d2c 2074 696d 656f 7574  ['foo'], timeout
+00016620: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+00016630: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016640: 2863 6861 6e67 655f 6964 2c20 2731 3233  (change_id, '123
+00016650: 3427 290a 0a20 2020 2020 2020 2020 2020  4')..           
+00016660: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00016670: 7452 6169 7365 7328 7065 6262 6c65 2e41  tRaises(pebble.A
+00016680: 5049 4572 726f 7229 2061 7320 636d 3a0a  PIError) as cm:.
+00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166a0: 636c 6965 6e74 2e73 7461 7274 5f73 6572  client.start_ser
+000166b0: 7669 6365 7328 5b27 6261 7227 5d2c 2074  vices(['bar'], t
+000166c0: 696d 656f 7574 3d30 290a 2020 2020 2020  imeout=0).      
+000166d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000166e0: 7449 7349 6e73 7461 6e63 6528 636d 2e65  tIsInstance(cm.e
+000166f0: 7863 6570 7469 6f6e 2c20 7065 6262 6c65  xception, pebble
+00016700: 2e45 7272 6f72 290a 2020 2020 2020 2020  .Error).        
+00016710: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016720: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00016730: 6e2e 636f 6465 2c20 3430 3029 0a20 2020  n.code, 400).   
+00016740: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00016750: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+00016760: 6570 7469 6f6e 2e73 7461 7475 732c 2027  eption.status, '
+00016770: 4261 6420 5265 7175 6573 7427 290a 2020  Bad Request').  
+00016780: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00016790: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+000167a0: 6365 7074 696f 6e2e 6d65 7373 6167 652c  ception.message,
+000167b0: 2027 7365 7276 6963 6520 2262 6172 2220   'service "bar" 
+000167c0: 646f 6573 206e 6f74 2065 7869 7374 2729  does not exist')
+000167d0: 0a0a 2020 2020 2020 2020 6669 6e61 6c6c  ..        finall
+000167e0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000167f0: 6875 7464 6f77 6e28 290a 0a0a 636c 6173  hutdown()...clas
+00016800: 7320 5465 7374 4578 6563 4572 726f 7228  s TestExecError(
+00016810: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
+00016820: 6529 3a0a 2020 2020 6465 6620 7465 7374  e):.    def test
+00016830: 5f69 6e69 7428 7365 6c66 293a 0a20 2020  _init(self):.   
+00016840: 2020 2020 2065 203d 2070 6562 626c 652e       e = pebble.
+00016850: 4578 6563 4572 726f 7228 5b27 666f 6f27  ExecError(['foo'
+00016860: 5d2c 2034 322c 2027 6f75 7427 2c20 2765  ], 42, 'out', 'e
+00016870: 7272 2729 0a20 2020 2020 2020 2073 656c  rr').        sel
+00016880: 662e 6173 7365 7274 4571 7561 6c28 652e  f.assertEqual(e.
+00016890: 636f 6d6d 616e 642c 205b 2766 6f6f 275d  command, ['foo']
+000168a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000168b0: 7373 6572 7445 7175 616c 2865 2e65 7869  ssertEqual(e.exi
+000168c0: 745f 636f 6465 2c20 3432 290a 2020 2020  t_code, 42).    
+000168d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000168e0: 7175 616c 2865 2e73 7464 6f75 742c 2027  qual(e.stdout, '
+000168f0: 6f75 7427 290a 2020 2020 2020 2020 7365  out').        se
+00016900: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+00016910: 2e73 7464 6572 722c 2027 6572 7227 290a  .stderr, 'err').
+00016920: 0a20 2020 2064 6566 2074 6573 745f 7374  .    def test_st
+00016930: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+00016940: 2065 203d 2070 6562 626c 652e 4578 6563   e = pebble.Exec
+00016950: 4572 726f 7228 5b27 7827 5d2c 2031 2c20  Error(['x'], 1, 
+00016960: 4e6f 6e65 2c20 4e6f 6e65 290a 2020 2020  None, None).    
+00016970: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016980: 7175 616c 2873 7472 2865 292c 2022 6e6f  qual(str(e), "no
+00016990: 6e2d 7a65 726f 2065 7869 7420 636f 6465  n-zero exit code
+000169a0: 2031 2065 7865 6375 7469 6e67 205b 2778   1 executing ['x
+000169b0: 275d 2229 0a0a 2020 2020 2020 2020 6520  ']")..        e 
+000169c0: 3d20 7065 6262 6c65 2e45 7865 6345 7272  = pebble.ExecErr
+000169d0: 6f72 285b 2778 275d 2c20 312c 2027 6f6e  or(['x'], 1, 'on
+000169e0: 6c79 2d6f 7574 272c 204e 6f6e 6529 0a20  ly-out', None). 
+000169f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00016a00: 7274 4571 7561 6c28 7374 7228 6529 2c20  rtEqual(str(e), 
+00016a10: 226e 6f6e 2d7a 6572 6f20 6578 6974 2063  "non-zero exit c
+00016a20: 6f64 6520 3120 6578 6563 7574 696e 6720  ode 1 executing 
+00016a30: 5b27 7827 5d2c 2073 7464 6f75 743d 276f  ['x'], stdout='o
+00016a40: 6e6c 792d 6f75 7427 2229 0a0a 2020 2020  nly-out'")..    
+00016a50: 2020 2020 6520 3d20 7065 6262 6c65 2e45      e = pebble.E
+00016a60: 7865 6345 7272 6f72 285b 2778 275d 2c20  xecError(['x'], 
+00016a70: 312c 204e 6f6e 652c 2027 6f6e 6c79 2d65  1, None, 'only-e
+00016a80: 7272 2729 0a20 2020 2020 2020 2073 656c  rr').        sel
+00016a90: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
+00016aa0: 7228 6529 2c20 226e 6f6e 2d7a 6572 6f20  r(e), "non-zero 
+00016ab0: 6578 6974 2063 6f64 6520 3120 6578 6563  exit code 1 exec
+00016ac0: 7574 696e 6720 5b27 7827 5d2c 2073 7464  uting ['x'], std
+00016ad0: 6572 723d 276f 6e6c 792d 6572 7227 2229  err='only-err'")
+00016ae0: 0a0a 2020 2020 2020 2020 6520 3d20 7065  ..        e = pe
+00016af0: 6262 6c65 2e45 7865 6345 7272 6f72 285b  bble.ExecError([
+00016b00: 2761 272c 2027 6227 5d2c 2031 2c20 276f  'a', 'b'], 1, 'o
+00016b10: 7574 272c 2027 6572 7227 290a 2020 2020  ut', 'err').    
+00016b20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016b30: 7175 616c 2873 7472 2865 292c 2022 6e6f  qual(str(e), "no
+00016b40: 6e2d 7a65 726f 2065 7869 7420 636f 6465  n-zero exit code
+00016b50: 2031 2065 7865 6375 7469 6e67 205b 2761   1 executing ['a
+00016b60: 272c 2027 6227 5d2c 2022 0a20 2020 2020  ', 'b'], ".     
 00016b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b80: 2020 2020 2b20 2273 7464 6f75 743d 276c      + "stdout='l
-00016b90: 6f6e 676f 2720 5b74 7275 6e63 6174 6564  ongo' [truncated
-00016ba0: 5d2c 2073 7464 6572 723d 276c 6f6e 6765  ], stderr='longe
-00016bb0: 2720 5b74 7275 6e63 6174 6564 5d22 290a  ' [truncated]").
-00016bc0: 0a0a 636c 6173 7320 4d6f 636b 5765 6273  ..class MockWebs
-00016bd0: 6f63 6b65 743a 0a20 2020 2064 6566 205f  ocket:.    def _
-00016be0: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
-00016bf0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-00016c00: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
-00016c10: 656c 662e 7265 6365 6976 6573 203d 205b  elf.receives = [
-00016c20: 5d0a 0a20 2020 2064 6566 2073 656e 645f  ]..    def send_
-00016c30: 6269 6e61 7279 2873 656c 662c 2062 293a  binary(self, b):
-00016c40: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00016c50: 6e64 732e 6170 7065 6e64 2828 2742 494e  nds.append(('BIN
-00016c60: 272c 2062 2929 0a0a 2020 2020 6465 6620  ', b))..    def 
-00016c70: 7365 6e64 2873 656c 662c 2073 293a 0a20  send(self, s):. 
-00016c80: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-00016c90: 732e 6170 7065 6e64 2828 2754 5854 272c  s.append(('TXT',
-00016ca0: 2073 2929 0a0a 2020 2020 6465 6620 7265   s))..    def re
-00016cb0: 6376 2873 656c 6629 3a0a 2020 2020 2020  cv(self):.      
-00016cc0: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
-00016cd0: 6365 6976 6573 2e70 6f70 2830 290a 0a20  ceives.pop(0).. 
-00016ce0: 2020 2064 6566 2073 6875 7464 6f77 6e28     def shutdown(
-00016cf0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-00016d00: 6173 730a 0a0a 636c 6173 7320 5465 7374  ass...class Test
-00016d10: 4578 6563 2875 6e69 7474 6573 742e 5465  Exec(unittest.Te
-00016d20: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-00016d30: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
-00016d40: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00016d50: 7420 3d20 4d6f 636b 436c 6965 6e74 2829  t = MockClient()
-00016d60: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
-00016d70: 6d65 203d 204d 6f63 6b54 696d 6528 290a  me = MockTime().
-00016d80: 2020 2020 2020 2020 7469 6d65 5f70 6174          time_pat
-00016d90: 6368 6572 203d 2075 6e69 7474 6573 742e  cher = unittest.
-00016da0: 6d6f 636b 2e70 6174 6368 2827 6f70 732e  mock.patch('ops.
-00016db0: 7065 6262 6c65 2e74 696d 6527 2c20 7365  pebble.time', se
-00016dc0: 6c66 2e74 696d 6529 0a20 2020 2020 2020  lf.time).       
-00016dd0: 2074 696d 655f 7061 7463 6865 722e 7374   time_patcher.st
-00016de0: 6172 7428 290a 2020 2020 2020 2020 7365  art().        se
-00016df0: 6c66 2e61 6464 436c 6561 6e75 7028 7469  lf.addCleanup(ti
-00016e00: 6d65 5f70 6174 6368 6572 2e73 746f 7029  me_patcher.stop)
-00016e10: 0a0a 2020 2020 6465 6620 6164 645f 7265  ..    def add_re
-00016e20: 7370 6f6e 7365 7328 7365 6c66 2c20 6368  sponses(self, ch
-00016e30: 616e 6765 5f69 642c 2065 7869 745f 636f  ange_id, exit_co
-00016e40: 6465 2c20 6368 616e 6765 5f65 7272 3d4e  de, change_err=N
-00016e50: 6f6e 6529 3a0a 2020 2020 2020 2020 7461  one):.        ta
-00016e60: 736b 5f69 6420 3d20 6622 547b 6368 616e  sk_id = f"T{chan
-00016e70: 6765 5f69 647d 2220 2023 2063 7265 6174  ge_id}"  # creat
-00016e80: 6520 6120 7461 736b 5f69 6420 6261 7365  e a task_id base
-00016e90: 6420 6f6e 2063 6861 6e67 655f 6964 0a20  d on change_id. 
-00016ea0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00016eb0: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-00016ec0: 656e 6428 7b0a 2020 2020 2020 2020 2020  end({.          
-00016ed0: 2020 2763 6861 6e67 6527 3a20 6368 616e    'change': chan
-00016ee0: 6765 5f69 642c 0a20 2020 2020 2020 2020  ge_id,.         
-00016ef0: 2020 2027 7265 7375 6c74 273a 207b 2774     'result': {'t
-00016f00: 6173 6b2d 6964 273a 2074 6173 6b5f 6964  ask-id': task_id
-00016f10: 7d2c 0a20 2020 2020 2020 207d 290a 0a20  },.        }).. 
-00016f20: 2020 2020 2020 2063 6861 6e67 6520 3d20         change = 
-00016f30: 6275 696c 645f 6d6f 636b 5f63 6861 6e67  build_mock_chang
-00016f40: 655f 6469 6374 2863 6861 6e67 655f 6964  e_dict(change_id
-00016f50: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
-00016f60: 5b27 7461 736b 7327 5d5b 305d 5b27 6461  ['tasks'][0]['da
-00016f70: 7461 275d 203d 207b 2765 7869 742d 636f  ta'] = {'exit-co
-00016f80: 6465 273a 2065 7869 745f 636f 6465 7d0a  de': exit_code}.
-00016f90: 2020 2020 2020 2020 6966 2063 6861 6e67          if chang
-00016fa0: 655f 6572 7220 6973 206e 6f74 204e 6f6e  e_err is not Non
-00016fb0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00016fc0: 6861 6e67 655b 2765 7272 275d 203d 2063  hange['err'] = c
-00016fd0: 6861 6e67 655f 6572 720a 2020 2020 2020  hange_err.      
-00016fe0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-00016ff0: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-00017000: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
-00017010: 7375 6c74 273a 2063 6861 6e67 652c 0a20  sult': change,. 
-00017020: 2020 2020 2020 207d 290a 0a20 2020 2020         })..     
-00017030: 2020 2073 7464 696f 203d 204d 6f63 6b57     stdio = MockW
-00017040: 6562 736f 636b 6574 2829 0a20 2020 2020  ebsocket().     
-00017050: 2020 2073 7464 6572 7220 3d20 4d6f 636b     stderr = Mock
-00017060: 5765 6273 6f63 6b65 7428 290a 2020 2020  Websocket().    
-00017070: 2020 2020 636f 6e74 726f 6c20 3d20 4d6f      control = Mo
-00017080: 636b 5765 6273 6f63 6b65 7428 290a 2020  ckWebsocket().  
-00017090: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-000170a0: 742e 7765 6273 6f63 6b65 7473 203d 207b  t.websockets = {
-000170b0: 0a20 2020 2020 2020 2020 2020 2028 7461  .            (ta
-000170c0: 736b 5f69 642c 2027 7374 6469 6f27 293a  sk_id, 'stdio'):
-000170d0: 2073 7464 696f 2c0a 2020 2020 2020 2020   stdio,.        
-000170e0: 2020 2020 2874 6173 6b5f 6964 2c20 2773      (task_id, 's
-000170f0: 7464 6572 7227 293a 2073 7464 6572 722c  tderr'): stderr,
-00017100: 0a20 2020 2020 2020 2020 2020 2028 7461  .            (ta
-00017110: 736b 5f69 642c 2027 636f 6e74 726f 6c27  sk_id, 'control'
-00017120: 293a 2063 6f6e 7472 6f6c 2c0a 2020 2020  ): control,.    
-00017130: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-00017140: 7475 726e 2028 7374 6469 6f2c 2073 7464  turn (stdio, std
-00017150: 6572 722c 2063 6f6e 7472 6f6c 290a 0a20  err, control).. 
-00017160: 2020 2064 6566 2062 7569 6c64 5f65 7865     def build_exe
-00017170: 635f 6461 7461 280a 2020 2020 2020 2020  c_data(.        
-00017180: 2020 2020 7365 6c66 2c20 636f 6d6d 616e      self, comman
-00017190: 642c 2065 6e76 6972 6f6e 6d65 6e74 3d4e  d, environment=N
-000171a0: 6f6e 652c 2077 6f72 6b69 6e67 5f64 6972  one, working_dir
-000171b0: 3d4e 6f6e 652c 2074 696d 656f 7574 3d4e  =None, timeout=N
-000171c0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000171d0: 2075 7365 725f 6964 3d4e 6f6e 652c 2075   user_id=None, u
-000171e0: 7365 723d 4e6f 6e65 2c20 6772 6f75 705f  ser=None, group_
-000171f0: 6964 3d4e 6f6e 652c 2067 726f 7570 3d4e  id=None, group=N
-00017200: 6f6e 652c 2063 6f6d 6269 6e65 5f73 7464  one, combine_std
-00017210: 6572 723d 4661 6c73 6529 3a0a 2020 2020  err=False):.    
-00017220: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-00017230: 2020 2020 2020 2020 2027 636f 6d6d 616e           'comman
-00017240: 6427 3a20 636f 6d6d 616e 642c 0a20 2020  d': command,.   
-00017250: 2020 2020 2020 2020 2027 656e 7669 726f           'enviro
-00017260: 6e6d 656e 7427 3a20 656e 7669 726f 6e6d  nment': environm
-00017270: 656e 7420 6f72 207b 7d2c 0a20 2020 2020  ent or {},.     
-00017280: 2020 2020 2020 2027 776f 726b 696e 672d         'working-
-00017290: 6469 7227 3a20 776f 726b 696e 675f 6469  dir': working_di
-000172a0: 722c 0a20 2020 2020 2020 2020 2020 2027  r,.            '
-000172b0: 7469 6d65 6f75 7427 3a20 6627 7b74 696d  timeout': f'{tim
-000172c0: 656f 7574 3a2e 3366 7d73 2720 6966 2074  eout:.3f}s' if t
-000172d0: 696d 656f 7574 2069 7320 6e6f 7420 4e6f  imeout is not No
-000172e0: 6e65 2065 6c73 6520 4e6f 6e65 2c0a 2020  ne else None,.  
-000172f0: 2020 2020 2020 2020 2020 2775 7365 722d            'user-
-00017300: 6964 273a 2075 7365 725f 6964 2c0a 2020  id': user_id,.  
-00017310: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
-00017320: 3a20 7573 6572 2c0a 2020 2020 2020 2020  : user,.        
-00017330: 2020 2020 2767 726f 7570 2d69 6427 3a20      'group-id': 
-00017340: 6772 6f75 705f 6964 2c0a 2020 2020 2020  group_id,.      
-00017350: 2020 2020 2020 2767 726f 7570 273a 2067        'group': g
-00017360: 726f 7570 2c0a 2020 2020 2020 2020 2020  roup,.          
-00017370: 2020 2773 706c 6974 2d73 7464 6572 7227    'split-stderr'
-00017380: 3a20 6e6f 7420 636f 6d62 696e 655f 7374  : not combine_st
-00017390: 6465 7272 2c0a 2020 2020 2020 2020 7d0a  derr,.        }.
-000173a0: 0a20 2020 2064 6566 2074 6573 745f 6172  .    def test_ar
-000173b0: 675f 6572 726f 7273 2873 656c 6629 3a0a  g_errors(self):.
-000173c0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000173d0: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
-000173e0: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
-000173f0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00017400: 6e74 2e65 7865 6328 2766 6f6f 2729 0a20  nt.exec('foo'). 
-00017410: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00017420: 2e61 7373 6572 7452 6169 7365 7328 5661  .assertRaises(Va
-00017430: 6c75 6545 7272 6f72 293a 0a20 2020 2020  lueError):.     
-00017440: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00017450: 6e74 2e65 7865 6328 5b5d 290a 2020 2020  nt.exec([]).    
-00017460: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00017470: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
-00017480: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00017490: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-000174a0: 6578 6563 285b 2766 6f6f 275d 2c20 7374  exec(['foo'], st
-000174b0: 6469 6e3d 2773 272c 2065 6e63 6f64 696e  din='s', encodin
-000174c0: 673d 4e6f 6e65 290a 2020 2020 2020 2020  g=None).        
-000174d0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000174e0: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
-000174f0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00017500: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-00017510: 285b 2766 6f6f 275d 2c20 7374 6469 6e3d  (['foo'], stdin=
-00017520: 6227 7327 290a 2020 2020 2020 2020 7769  b's').        wi
-00017530: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00017540: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00017550: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00017560: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
-00017570: 666f 6f27 5d2c 2073 7464 696e 3d31 3233  foo'], stdin=123
-00017580: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00017590: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-000175a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
-000175b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-000175c0: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
-000175d0: 275d 2c20 7374 646f 7574 3d69 6f2e 5374  '], stdout=io.St
-000175e0: 7269 6e67 494f 2829 2c20 7374 6465 7272  ringIO(), stderr
-000175f0: 3d69 6f2e 5374 7269 6e67 494f 2829 2c0a  =io.StringIO(),.
-00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017610: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00017620: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
-00017630: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00017640: 6e6f 5f77 6169 745f 6361 6c6c 2873 656c  no_wait_call(sel
-00017650: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00017660: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
-00017670: 3132 3327 2c20 3029 0a20 2020 2020 2020  123', 0).       
-00017680: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00017690: 7457 6172 6e73 2852 6573 6f75 7263 6557  tWarns(ResourceW
-000176a0: 6172 6e69 6e67 2920 6173 2063 6d3a 0a20  arning) as cm:. 
-000176b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-000176c0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
-000176d0: 2e65 7865 6328 5b27 7472 7565 275d 290a  .exec(['true']).
-000176e0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-000176f0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-00017700: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00017710: 2873 7472 2863 6d2e 7761 726e 696e 6729  (str(cm.warning)
-00017720: 2c20 2745 7865 6350 726f 6365 7373 2069  , 'ExecProcess i
-00017730: 6e73 7461 6e63 6520 6761 7262 6167 6520  nstance garbage 
-00017740: 636f 6c6c 6563 7465 6420 270a 2020 2020  collected '.    
-00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b80: 2020 2020 2020 2020 2020 2020 2b20 2273              + "s
+00016b90: 7464 6f75 743d 276f 7574 272c 2073 7464  tdout='out', std
+00016ba0: 6572 723d 2765 7272 2722 290a 0a20 2020  err='err'")..   
+00016bb0: 2064 6566 2074 6573 745f 7374 725f 7472   def test_str_tr
+00016bc0: 756e 6361 7465 6428 7365 6c66 293a 0a20  uncated(self):. 
+00016bd0: 2020 2020 2020 2065 203d 2070 6562 626c         e = pebbl
+00016be0: 652e 4578 6563 4572 726f 7228 5b27 666f  e.ExecError(['fo
+00016bf0: 6f27 5d2c 2032 2c20 276c 6f6e 676f 7574  o'], 2, 'longout
+00016c00: 272c 2027 6c6f 6e67 6572 7227 290a 2020  ', 'longerr').  
+00016c10: 2020 2020 2020 652e 5354 525f 4d41 585f        e.STR_MAX_
+00016c20: 4f55 5450 5554 203d 2035 0a20 2020 2020  OUTPUT = 5.     
+00016c30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016c40: 7561 6c28 7374 7228 6529 2c20 226e 6f6e  ual(str(e), "non
+00016c50: 2d7a 6572 6f20 6578 6974 2063 6f64 6520  -zero exit code 
+00016c60: 3220 6578 6563 7574 696e 6720 5b27 666f  2 executing ['fo
+00016c70: 6f27 5d2c 2022 0a20 2020 2020 2020 2020  o'], ".         
+00016c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c90: 2020 2020 2020 2020 2b20 2273 7464 6f75          + "stdou
+00016ca0: 743d 276c 6f6e 676f 2720 5b74 7275 6e63  t='longo' [trunc
+00016cb0: 6174 6564 5d2c 2073 7464 6572 723d 276c  ated], stderr='l
+00016cc0: 6f6e 6765 2720 5b74 7275 6e63 6174 6564  onge' [truncated
+00016cd0: 5d22 290a 0a0a 636c 6173 7320 4d6f 636b  ]")...class Mock
+00016ce0: 5765 6273 6f63 6b65 743a 0a20 2020 2064  Websocket:.    d
+00016cf0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00016d00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00016d10: 7365 6e64 7320 3d20 5b5d 0a20 2020 2020  sends = [].     
+00016d20: 2020 2073 656c 662e 7265 6365 6976 6573     self.receives
+00016d30: 203d 205b 5d0a 0a20 2020 2064 6566 2073   = []..    def s
+00016d40: 656e 645f 6269 6e61 7279 2873 656c 662c  end_binary(self,
+00016d50: 2062 293a 0a20 2020 2020 2020 2073 656c   b):.        sel
+00016d60: 662e 7365 6e64 732e 6170 7065 6e64 2828  f.sends.append((
+00016d70: 2742 494e 272c 2062 2929 0a0a 2020 2020  'BIN', b))..    
+00016d80: 6465 6620 7365 6e64 2873 656c 662c 2073  def send(self, s
+00016d90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00016da0: 7365 6e64 732e 6170 7065 6e64 2828 2754  sends.append(('T
+00016db0: 5854 272c 2073 2929 0a0a 2020 2020 6465  XT', s))..    de
+00016dc0: 6620 7265 6376 2873 656c 6629 3a0a 2020  f recv(self):.  
+00016dd0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00016de0: 662e 7265 6365 6976 6573 2e70 6f70 2830  f.receives.pop(0
+00016df0: 290a 0a20 2020 2064 6566 2073 6875 7464  )..    def shutd
+00016e00: 6f77 6e28 7365 6c66 293a 0a20 2020 2020  own(self):.     
+00016e10: 2020 2070 6173 730a 0a0a 636c 6173 7320     pass...class 
+00016e20: 5465 7374 4578 6563 2875 6e69 7474 6573  TestExec(unittes
+00016e30: 742e 5465 7374 4361 7365 293a 0a20 2020  t.TestCase):.   
+00016e40: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
+00016e50: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00016e60: 6c69 656e 7420 3d20 4d6f 636b 436c 6965  lient = MockClie
+00016e70: 6e74 2829 0a20 2020 2020 2020 2073 656c  nt().        sel
+00016e80: 662e 7469 6d65 203d 204d 6f63 6b54 696d  f.time = MockTim
+00016e90: 6528 290a 2020 2020 2020 2020 7469 6d65  e().        time
+00016ea0: 5f70 6174 6368 6572 203d 2075 6e69 7474  _patcher = unitt
+00016eb0: 6573 742e 6d6f 636b 2e70 6174 6368 2827  est.mock.patch('
+00016ec0: 6f70 732e 7065 6262 6c65 2e74 696d 6527  ops.pebble.time'
+00016ed0: 2c20 7365 6c66 2e74 696d 6529 0a20 2020  , self.time).   
+00016ee0: 2020 2020 2074 696d 655f 7061 7463 6865       time_patche
+00016ef0: 722e 7374 6172 7428 290a 2020 2020 2020  r.start().      
+00016f00: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00016f10: 7028 7469 6d65 5f70 6174 6368 6572 2e73  p(time_patcher.s
+00016f20: 746f 7029 0a0a 2020 2020 6465 6620 6164  top)..    def ad
+00016f30: 645f 7265 7370 6f6e 7365 7328 7365 6c66  d_responses(self
+00016f40: 2c20 6368 616e 6765 5f69 642c 2065 7869  , change_id, exi
+00016f50: 745f 636f 6465 2c20 6368 616e 6765 5f65  t_code, change_e
+00016f60: 7272 3d4e 6f6e 6529 3a0a 2020 2020 2020  rr=None):.      
+00016f70: 2020 7461 736b 5f69 6420 3d20 6622 547b    task_id = f"T{
+00016f80: 6368 616e 6765 5f69 647d 2220 2023 2063  change_id}"  # c
+00016f90: 7265 6174 6520 6120 7461 736b 5f69 6420  reate a task_id 
+00016fa0: 6261 7365 6420 6f6e 2063 6861 6e67 655f  based on change_
+00016fb0: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
+00016fc0: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
+00016fd0: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
+00016fe0: 2020 2020 2020 2763 6861 6e67 6527 3a20        'change': 
+00016ff0: 6368 616e 6765 5f69 642c 0a20 2020 2020  change_id,.     
+00017000: 2020 2020 2020 2027 7265 7375 6c74 273a         'result':
+00017010: 207b 2774 6173 6b2d 6964 273a 2074 6173   {'task-id': tas
+00017020: 6b5f 6964 7d2c 0a20 2020 2020 2020 207d  k_id},.        }
+00017030: 290a 0a20 2020 2020 2020 2063 6861 6e67  )..        chang
+00017040: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
+00017050: 6861 6e67 655f 6469 6374 2863 6861 6e67  hange_dict(chang
+00017060: 655f 6964 290a 2020 2020 2020 2020 6368  e_id).        ch
+00017070: 616e 6765 5b27 7461 736b 7327 5d5b 305d  ange['tasks'][0]
+00017080: 5b27 6461 7461 275d 203d 207b 2765 7869  ['data'] = {'exi
+00017090: 742d 636f 6465 273a 2065 7869 745f 636f  t-code': exit_co
+000170a0: 6465 7d0a 2020 2020 2020 2020 6966 2063  de}.        if c
+000170b0: 6861 6e67 655f 6572 7220 6973 206e 6f74  hange_err is not
+000170c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000170d0: 2020 2063 6861 6e67 655b 2765 7272 275d     change['err']
+000170e0: 203d 2063 6861 6e67 655f 6572 720a 2020   = change_err.  
+000170f0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00017100: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+00017110: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+00017120: 2027 7265 7375 6c74 273a 2063 6861 6e67   'result': chang
+00017130: 652c 0a20 2020 2020 2020 207d 290a 0a20  e,.        }).. 
+00017140: 2020 2020 2020 2073 7464 696f 203d 204d         stdio = M
+00017150: 6f63 6b57 6562 736f 636b 6574 2829 0a20  ockWebsocket(). 
+00017160: 2020 2020 2020 2073 7464 6572 7220 3d20         stderr = 
+00017170: 4d6f 636b 5765 6273 6f63 6b65 7428 290a  MockWebsocket().
+00017180: 2020 2020 2020 2020 636f 6e74 726f 6c20          control 
+00017190: 3d20 4d6f 636b 5765 6273 6f63 6b65 7428  = MockWebsocket(
+000171a0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+000171b0: 6c69 656e 742e 7765 6273 6f63 6b65 7473  lient.websockets
+000171c0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+000171d0: 2028 7461 736b 5f69 642c 2027 7374 6469   (task_id, 'stdi
+000171e0: 6f27 293a 2073 7464 696f 2c0a 2020 2020  o'): stdio,.    
+000171f0: 2020 2020 2020 2020 2874 6173 6b5f 6964          (task_id
+00017200: 2c20 2773 7464 6572 7227 293a 2073 7464  , 'stderr'): std
+00017210: 6572 722c 0a20 2020 2020 2020 2020 2020  err,.           
+00017220: 2028 7461 736b 5f69 642c 2027 636f 6e74   (task_id, 'cont
+00017230: 726f 6c27 293a 2063 6f6e 7472 6f6c 2c0a  rol'): control,.
+00017240: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00017250: 2020 7265 7475 726e 2028 7374 6469 6f2c    return (stdio,
+00017260: 2073 7464 6572 722c 2063 6f6e 7472 6f6c   stderr, control
+00017270: 290a 0a20 2020 2064 6566 2062 7569 6c64  )..    def build
+00017280: 5f65 7865 635f 6461 7461 280a 2020 2020  _exec_data(.    
+00017290: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+000172a0: 6d6d 616e 642c 2073 6572 7669 6365 5f63  mmand, service_c
+000172b0: 6f6e 7465 7874 3d4e 6f6e 652c 2065 6e76  ontext=None, env
+000172c0: 6972 6f6e 6d65 6e74 3d4e 6f6e 652c 2077  ironment=None, w
+000172d0: 6f72 6b69 6e67 5f64 6972 3d4e 6f6e 652c  orking_dir=None,
+000172e0: 2074 696d 656f 7574 3d4e 6f6e 652c 0a20   timeout=None,. 
+000172f0: 2020 2020 2020 2020 2020 2075 7365 725f             user_
+00017300: 6964 3d4e 6f6e 652c 2075 7365 723d 4e6f  id=None, user=No
+00017310: 6e65 2c20 6772 6f75 705f 6964 3d4e 6f6e  ne, group_id=Non
+00017320: 652c 2067 726f 7570 3d4e 6f6e 652c 2063  e, group=None, c
+00017330: 6f6d 6269 6e65 5f73 7464 6572 723d 4661  ombine_stderr=Fa
+00017340: 6c73 6529 3a0a 2020 2020 2020 2020 7265  lse):.        re
+00017350: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+00017360: 2020 2027 636f 6d6d 616e 6427 3a20 636f     'command': co
+00017370: 6d6d 616e 642c 0a20 2020 2020 2020 2020  mmand,.         
+00017380: 2020 2027 7365 7276 6963 652d 636f 6e74     'service-cont
+00017390: 6578 7427 3a20 7365 7276 6963 655f 636f  ext': service_co
+000173a0: 6e74 6578 742c 0a20 2020 2020 2020 2020  ntext,.         
+000173b0: 2020 2027 656e 7669 726f 6e6d 656e 7427     'environment'
+000173c0: 3a20 656e 7669 726f 6e6d 656e 7420 6f72  : environment or
+000173d0: 207b 7d2c 0a20 2020 2020 2020 2020 2020   {},.           
+000173e0: 2027 776f 726b 696e 672d 6469 7227 3a20   'working-dir': 
+000173f0: 776f 726b 696e 675f 6469 722c 0a20 2020  working_dir,.   
+00017400: 2020 2020 2020 2020 2027 7469 6d65 6f75           'timeou
+00017410: 7427 3a20 6627 7b74 696d 656f 7574 3a2e  t': f'{timeout:.
+00017420: 3366 7d73 2720 6966 2074 696d 656f 7574  3f}s' if timeout
+00017430: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00017440: 6520 4e6f 6e65 2c0a 2020 2020 2020 2020  e None,.        
+00017450: 2020 2020 2775 7365 722d 6964 273a 2075      'user-id': u
+00017460: 7365 725f 6964 2c0a 2020 2020 2020 2020  ser_id,.        
+00017470: 2020 2020 2775 7365 7227 3a20 7573 6572      'user': user
+00017480: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
+00017490: 726f 7570 2d69 6427 3a20 6772 6f75 705f  roup-id': group_
+000174a0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+000174b0: 2767 726f 7570 273a 2067 726f 7570 2c0a  'group': group,.
+000174c0: 2020 2020 2020 2020 2020 2020 2773 706c              'spl
+000174d0: 6974 2d73 7464 6572 7227 3a20 6e6f 7420  it-stderr': not 
+000174e0: 636f 6d62 696e 655f 7374 6465 7272 2c0a  combine_stderr,.
+000174f0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
+00017500: 6566 2074 6573 745f 6172 675f 6572 726f  ef test_arg_erro
+00017510: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
+00017520: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00017530: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+00017540: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00017550: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
+00017560: 6328 2766 6f6f 2729 0a20 2020 2020 2020  c('foo').       
+00017570: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00017580: 7452 6169 7365 7328 5661 6c75 6545 7272  tRaises(ValueErr
+00017590: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000175a0: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
+000175b0: 6328 5b5d 290a 2020 2020 2020 2020 7769  c([]).        wi
+000175c0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000175d0: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
+000175e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000175f0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
+00017600: 2766 6f6f 275d 2c20 7374 6469 6e3d 2773  'foo'], stdin='s
+00017610: 272c 2065 6e63 6f64 696e 673d 4e6f 6e65  ', encoding=None
+00017620: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00017630: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00017640: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
+00017650: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00017660: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
+00017670: 275d 2c20 7374 6469 6e3d 6227 7327 290a  '], stdin=b's').
+00017680: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00017690: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
+000176a0: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
+000176b0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+000176c0: 6e74 2e65 7865 6328 5b27 666f 6f27 5d2c  nt.exec(['foo'],
+000176d0: 2073 7464 696e 3d31 3233 290a 2020 2020   stdin=123).    
+000176e0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+000176f0: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
+00017700: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00017710: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00017720: 6578 6563 285b 2766 6f6f 275d 2c20 7374  exec(['foo'], st
+00017730: 646f 7574 3d69 6f2e 5374 7269 6e67 494f  dout=io.StringIO
+00017740: 2829 2c20 7374 6465 7272 3d69 6f2e 5374  (), stderr=io.St
+00017750: 7269 6e67 494f 2829 2c0a 2020 2020 2020  ringIO(),.      
 00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017770: 2020 2020 2020 2b20 2777 6974 686f 7574        + 'without
-00017780: 2063 616c 6c20 746f 2077 6169 7428 2920   call to wait() 
-00017790: 6f72 2077 6169 745f 6f75 7470 7574 2829  or wait_output()
-000177a0: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-000177b0: 5f77 6169 745f 6578 6974 5f7a 6572 6f28  _wait_exit_zero(
-000177c0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-000177d0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
-000177e0: 7328 2731 3233 272c 2030 290a 0a20 2020  s('123', 0)..   
-000177f0: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-00017800: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-00017810: 5b27 7472 7565 275d 290a 2020 2020 2020  ['true']).      
-00017820: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-00017830: 6f74 4e6f 6e65 2870 726f 6365 7373 2e73  otNone(process.s
-00017840: 7464 6f75 7429 0a20 2020 2020 2020 2073  tdout).        s
-00017850: 656c 662e 6173 7365 7274 4973 4e6f 744e  elf.assertIsNotN
-00017860: 6f6e 6528 7072 6f63 6573 732e 7374 6465  one(process.stde
-00017870: 7272 290a 2020 2020 2020 2020 7072 6f63  rr).        proc
-00017880: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
-00017890: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000178a0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-000178b0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-000178c0: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-000178d0: 2c20 272f 7631 2f65 7865 6327 2c20 4e6f  , '/v1/exec', No
-000178e0: 6e65 2c20 7365 6c66 2e62 7569 6c64 5f65  ne, self.build_e
-000178f0: 7865 635f 6461 7461 285b 2774 7275 6527  xec_data(['true'
-00017900: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
-00017910: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-00017920: 616e 6765 732f 3132 332f 7761 6974 272c  anges/123/wait',
-00017930: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
-00017940: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
-00017950: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00017960: 6566 2074 6573 745f 7761 6974 5f65 7869  ef test_wait_exi
-00017970: 745f 6e6f 6e7a 6572 6f28 7365 6c66 293a  t_nonzero(self):
-00017980: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00017990: 645f 7265 7370 6f6e 7365 7328 2734 3536  d_responses('456
-000179a0: 272c 2031 290a 0a20 2020 2020 2020 2070  ', 1)..        p
-000179b0: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-000179c0: 6965 6e74 2e65 7865 6328 5b27 6661 6c73  ient.exec(['fals
-000179d0: 6527 5d29 0a20 2020 2020 2020 2077 6974  e']).        wit
-000179e0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000179f0: 7365 7328 7065 6262 6c65 2e45 7865 6345  ses(pebble.ExecE
-00017a00: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00017a10: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00017a20: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
-00017a30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00017a40: 2863 6d2e 6578 6365 7074 696f 6e2e 636f  (cm.exception.co
-00017a50: 6d6d 616e 642c 205b 2766 616c 7365 275d  mmand, ['false']
-00017a60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00017a70: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
-00017a80: 6365 7074 696f 6e2e 6578 6974 5f63 6f64  ception.exit_cod
-00017a90: 652c 2031 290a 2020 2020 2020 2020 7365  e, 1).        se
-00017aa0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00017ab0: 6d2e 6578 6365 7074 696f 6e2e 7374 646f  m.exception.stdo
-00017ac0: 7574 2c20 4e6f 6e65 290a 2020 2020 2020  ut, None).      
-00017ad0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00017ae0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00017af0: 7374 6465 7272 2c20 4e6f 6e65 290a 0a20  stderr, None).. 
-00017b00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00017b10: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
-00017b20: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
-00017b30: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
-00017b40: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
-00017b50: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
-00017b60: 645f 6578 6563 5f64 6174 6128 5b27 6661  d_exec_data(['fa
-00017b70: 6c73 6527 5d29 292c 0a20 2020 2020 2020  lse'])),.       
-00017b80: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
-00017b90: 312f 6368 616e 6765 732f 3435 362f 7761  1/changes/456/wa
-00017ba0: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
-00017bb0: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
-00017bc0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-00017bd0: 2020 2064 6566 2074 6573 745f 7761 6974     def test_wait
-00017be0: 5f74 696d 656f 7574 2873 656c 6629 3a0a  _timeout(self):.
-00017bf0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00017c00: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
-00017c10: 2c20 3029 0a0a 2020 2020 2020 2020 7072  , 0)..        pr
-00017c20: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-00017c30: 656e 742e 6578 6563 285b 2774 7275 6527  ent.exec(['true'
-00017c40: 5d2c 2074 696d 656f 7574 3d32 290a 2020  ], timeout=2).  
-00017c50: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
-00017c60: 6974 2829 0a0a 2020 2020 2020 2020 7365  it()..        se
-00017c70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00017c80: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00017c90: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00017ca0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-00017cb0: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
-00017cc0: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
-00017cd0: 7461 285b 2774 7275 6527 5d2c 2074 696d  ta(['true'], tim
-00017ce0: 656f 7574 3d32 2929 2c0a 2020 2020 2020  eout=2)),.      
-00017cf0: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-00017d00: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
-00017d10: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
-00017d20: 3a20 2733 2e30 3030 7327 7d2c 204e 6f6e  : '3.000s'}, Non
-00017d30: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
-00017d40: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
-00017d50: 745f 6f74 6865 725f 6172 6773 2873 656c  t_other_args(sel
-00017d60: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00017d70: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
-00017d80: 3132 3327 2c20 3029 0a0a 2020 2020 2020  123', 0)..      
-00017d90: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
-00017da0: 2e63 6c69 656e 742e 6578 6563 280a 2020  .client.exec(.  
-00017db0: 2020 2020 2020 2020 2020 5b27 7472 7565            ['true
-00017dc0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00017dd0: 656e 7669 726f 6e6d 656e 743d 7b27 4b31  environment={'K1
-00017de0: 273a 2027 5631 272c 2027 4b32 273a 2027  ': 'V1', 'K2': '
-00017df0: 5632 277d 2c0a 2020 2020 2020 2020 2020  V2'},.          
-00017e00: 2020 776f 726b 696e 675f 6469 723d 2757    working_dir='W
-00017e10: 4427 2c0a 2020 2020 2020 2020 2020 2020  D',.            
-00017e20: 7573 6572 5f69 643d 3130 3030 2c0a 2020  user_id=1000,.  
-00017e30: 2020 2020 2020 2020 2020 7573 6572 3d27            user='
-00017e40: 626f 6227 2c0a 2020 2020 2020 2020 2020  bob',.          
-00017e50: 2020 6772 6f75 705f 6964 3d31 3030 302c    group_id=1000,
-00017e60: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
-00017e70: 7570 3d27 7374 6166 6627 2c0a 2020 2020  up='staff',.    
-00017e80: 2020 2020 290a 2020 2020 2020 2020 7072      ).        pr
-00017e90: 6f63 6573 732e 7761 6974 2829 0a0a 2020  ocess.wait()..  
-00017ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00017eb0: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-00017ec0: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-00017ed0: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-00017ee0: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
-00017ef0: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
-00017f00: 5f65 7865 635f 6461 7461 280a 2020 2020  _exec_data(.    
-00017f10: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00017f20: 616e 643d 5b27 7472 7565 275d 2c0a 2020  and=['true'],.  
-00017f30: 2020 2020 2020 2020 2020 2020 2020 656e                en
-00017f40: 7669 726f 6e6d 656e 743d 7b27 4b31 273a  vironment={'K1':
-00017f50: 2027 5631 272c 2027 4b32 273a 2027 5632   'V1', 'K2': 'V2
-00017f60: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00017f70: 2020 2020 776f 726b 696e 675f 6469 723d      working_dir=
-00017f80: 2757 4427 2c0a 2020 2020 2020 2020 2020  'WD',.          
-00017f90: 2020 2020 2020 7573 6572 5f69 643d 3130        user_id=10
-00017fa0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00017fb0: 2020 2020 7573 6572 3d27 626f 6227 2c0a      user='bob',.
-00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fd0: 6772 6f75 705f 6964 3d31 3030 302c 0a20  group_id=1000,. 
-00017fe0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00017ff0: 726f 7570 3d27 7374 6166 6627 2c0a 2020  roup='staff',.  
-00018000: 2020 2020 2020 2020 2020 2929 2c0a 2020            )),.  
-00018010: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-00018020: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
-00018030: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
-00018040: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-00018050: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-00018060: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00018070: 5f77 6169 745f 6368 616e 6765 5f65 7272  _wait_change_err
-00018080: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-00018090: 2020 7365 6c66 2e61 6464 5f72 6573 706f    self.add_respo
-000180a0: 6e73 6573 2827 3132 3327 2c20 302c 2063  nses('123', 0, c
-000180b0: 6861 6e67 655f 6572 723d 2763 6861 6e67  hange_err='chang
-000180c0: 6520 6572 726f 7221 2729 0a0a 2020 2020  e error!')..    
-000180d0: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
-000180e0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-000180f0: 2774 7275 6527 5d29 0a20 2020 2020 2020  'true']).       
-00018100: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00018110: 7452 6169 7365 7328 7065 6262 6c65 2e43  tRaises(pebble.C
-00018120: 6861 6e67 6545 7272 6f72 2920 6173 2063  hangeError) as c
-00018130: 6d3a 0a20 2020 2020 2020 2020 2020 2070  m:.            p
-00018140: 726f 6365 7373 2e77 6169 7428 290a 2020  rocess.wait().  
-00018150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018160: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-00018170: 696f 6e2e 6572 722c 2027 6368 616e 6765  ion.err, 'change
-00018180: 2065 7272 6f72 2127 290a 2020 2020 2020   error!').      
-00018190: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000181a0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-000181b0: 6368 616e 6765 2e69 642c 2027 3132 3327  change.id, '123'
-000181c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000181d0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-000181e0: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-000181f0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00018200: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
-00018210: 6563 272c 204e 6f6e 652c 2073 656c 662e  ec', None, self.
-00018220: 6275 696c 645f 6578 6563 5f64 6174 6128  build_exec_data(
-00018230: 5b27 7472 7565 275d 2929 2c0a 2020 2020  ['true'])),.    
-00018240: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-00018250: 272f 7631 2f63 6861 6e67 6573 2f31 3233  '/v1/changes/123
-00018260: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-00018270: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-00018280: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-00018290: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-000182a0: 656e 645f 7369 676e 616c 2873 656c 6629  end_signal(self)
-000182b0: 3a0a 2020 2020 2020 2020 5f2c 205f 2c20  :.        _, _, 
-000182c0: 636f 6e74 726f 6c20 3d20 7365 6c66 2e61  control = self.a
-000182d0: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
-000182e0: 3327 2c20 3029 0a0a 2020 2020 2020 2020  3', 0)..        
-000182f0: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
-00018300: 6c69 656e 742e 6578 6563 285b 2773 6572  lient.exec(['ser
-00018310: 7665 7227 5d29 0a20 2020 2020 2020 2070  ver']).        p
-00018320: 726f 6365 7373 2e73 656e 645f 7369 676e  rocess.send_sign
-00018330: 616c 2827 5349 4748 5550 2729 0a20 2020  al('SIGHUP').   
-00018340: 2020 2020 206e 756d 5f73 656e 6473 203d       num_sends =
-00018350: 2031 0a20 2020 2020 2020 2069 6620 6861   1.        if ha
-00018360: 7361 7474 7228 7369 676e 616c 2c20 2753  sattr(signal, 'S
-00018370: 4947 4855 5027 293a 0a20 2020 2020 2020  IGHUP'):.       
-00018380: 2020 2020 2070 726f 6365 7373 2e73 656e       process.sen
-00018390: 645f 7369 676e 616c 2831 290a 2020 2020  d_signal(1).    
-000183a0: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
-000183b0: 7365 6e64 5f73 6967 6e61 6c28 7369 676e  send_signal(sign
-000183c0: 616c 2e53 4947 4855 5029 0a20 2020 2020  al.SIGHUP).     
-000183d0: 2020 2020 2020 206e 756d 5f73 656e 6473         num_sends
-000183e0: 202b 3d20 320a 0a20 2020 2020 2020 2070   += 2..        p
-000183f0: 726f 6365 7373 2e77 6169 7428 290a 0a20  rocess.wait().. 
-00018400: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00018410: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
-00018420: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
-00018430: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
-00018440: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
-00018450: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
-00018460: 645f 6578 6563 5f64 6174 6128 5b27 7365  d_exec_data(['se
-00018470: 7276 6572 275d 2929 2c0a 2020 2020 2020  rver'])),.      
-00018480: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-00018490: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
-000184a0: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
-000184b0: 3a20 2734 2e30 3030 7327 7d2c 204e 6f6e  : '4.000s'}, Non
-000184c0: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
-000184d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000184e0: 6572 7445 7175 616c 286c 656e 2863 6f6e  ertEqual(len(con
-000184f0: 7472 6f6c 2e73 656e 6473 292c 206e 756d  trol.sends), num
-00018500: 5f73 656e 6473 290a 2020 2020 2020 2020  _sends).        
-00018510: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018520: 2863 6f6e 7472 6f6c 2e73 656e 6473 5b30  (control.sends[0
-00018530: 5d5b 305d 2c20 2754 5854 2729 0a20 2020  ][0], 'TXT').   
-00018540: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018550: 4571 7561 6c28 6a73 6f6e 2e6c 6f61 6473  Equal(json.loads
-00018560: 2863 6f6e 7472 6f6c 2e73 656e 6473 5b30  (control.sends[0
-00018570: 5d5b 315d 292c 0a20 2020 2020 2020 2020  ][1]),.         
-00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018590: 7b27 636f 6d6d 616e 6427 3a20 2773 6967  {'command': 'sig
-000185a0: 6e61 6c27 2c20 2773 6967 6e61 6c27 3a20  nal', 'signal': 
-000185b0: 7b27 6e61 6d65 273a 2027 5349 4748 5550  {'name': 'SIGHUP
-000185c0: 277d 7d29 0a20 2020 2020 2020 2069 6620  '}}).        if 
-000185d0: 6861 7361 7474 7228 7369 676e 616c 2c20  hasattr(signal, 
-000185e0: 2753 4947 4855 5027 293a 0a20 2020 2020  'SIGHUP'):.     
-000185f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00018600: 7274 4571 7561 6c28 636f 6e74 726f 6c2e  rtEqual(control.
-00018610: 7365 6e64 735b 315d 5b30 5d2c 2027 5458  sends[1][0], 'TX
-00018620: 5427 290a 2020 2020 2020 2020 2020 2020  T').            
-00018630: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018640: 286a 736f 6e2e 6c6f 6164 7328 636f 6e74  (json.loads(cont
-00018650: 726f 6c2e 7365 6e64 735b 315d 5b31 5d29  rol.sends[1][1])
-00018660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018670: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00018680: 2763 6f6d 6d61 6e64 273a 2027 7369 676e  'command': 'sign
-00018690: 616c 272c 2027 7369 676e 616c 273a 207b  al', 'signal': {
-000186a0: 276e 616d 6527 3a20 7369 676e 616c 2e53  'name': signal.S
-000186b0: 6967 6e61 6c73 2831 292e 6e61 6d65 7d7d  ignals(1).name}}
-000186c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000186d0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-000186e0: 6f6e 7472 6f6c 2e73 656e 6473 5b32 5d5b  ontrol.sends[2][
-000186f0: 305d 2c20 2754 5854 2729 0a20 2020 2020  0], 'TXT').     
-00018700: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00018710: 7274 4571 7561 6c28 6a73 6f6e 2e6c 6f61  rtEqual(json.loa
-00018720: 6473 2863 6f6e 7472 6f6c 2e73 656e 6473  ds(control.sends
-00018730: 5b32 5d5b 315d 292c 0a20 2020 2020 2020  [2][1]),.       
-00018740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018750: 2020 2020 2020 7b27 636f 6d6d 616e 6427        {'command'
-00018760: 3a20 2773 6967 6e61 6c27 2c20 2773 6967  : 'signal', 'sig
-00018770: 6e61 6c27 3a20 7b27 6e61 6d65 273a 2027  nal': {'name': '
-00018780: 5349 4748 5550 277d 7d29 0a0a 2020 2020  SIGHUP'}})..    
-00018790: 6465 6620 7465 7374 5f77 6169 745f 6f75  def test_wait_ou
-000187a0: 7470 7574 2873 656c 6629 3a0a 2020 2020  tput(self):.    
-000187b0: 2020 2020 7374 6469 6f2c 2073 7464 6572      stdio, stder
-000187c0: 722c 205f 203d 2073 656c 662e 6164 645f  r, _ = self.add_
-000187d0: 7265 7370 6f6e 7365 7328 2731 3233 272c  responses('123',
-000187e0: 2030 290a 2020 2020 2020 2020 7374 6469   0).        stdi
-000187f0: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
-00018800: 6428 6227 5079 7468 6f6e 2033 2e38 2e31  d(b'Python 3.8.1
-00018810: 305c 6e27 290a 2020 2020 2020 2020 7374  0\n').        st
-00018820: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
-00018830: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-00018840: 2265 6e64 227d 2729 0a20 2020 2020 2020  "end"}').       
-00018850: 2073 7464 6572 722e 7265 6365 6976 6573   stderr.receives
-00018860: 2e61 7070 656e 6428 277b 2263 6f6d 6d61  .append('{"comma
-00018870: 6e64 223a 2265 6e64 227d 2729 0a0a 2020  nd":"end"}')..  
-00018880: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
-00018890: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-000188a0: 285b 2770 7974 686f 6e33 272c 2027 2d2d  (['python3', '--
-000188b0: 7665 7273 696f 6e27 5d29 0a20 2020 2020  version']).     
-000188c0: 2020 206f 7574 2c20 6572 7220 3d20 7072     out, err = pr
-000188d0: 6f63 6573 732e 7761 6974 5f6f 7574 7075  ocess.wait_outpu
-000188e0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-000188f0: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
-00018900: 2c20 2750 7974 686f 6e20 332e 382e 3130  , 'Python 3.8.10
-00018910: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
-00018920: 662e 6173 7365 7274 4571 7561 6c28 6572  f.assertEqual(er
-00018930: 722c 2027 2729 0a0a 2020 2020 2020 2020  r, '')..        
-00018940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018950: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-00018960: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00018970: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
-00018980: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
-00018990: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
-000189a0: 6461 7461 285b 2770 7974 686f 6e33 272c  data(['python3',
-000189b0: 2027 2d2d 7665 7273 696f 6e27 5d29 292c   '--version'])),
-000189c0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-000189d0: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-000189e0: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
-000189f0: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
-00018a00: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
-00018a10: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-00018a20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00018a30: 7464 696f 2e73 656e 6473 2c20 5b5d 290a  tdio.sends, []).
-00018a40: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-00018a50: 6974 5f6f 7574 7075 745f 636f 6d62 696e  it_output_combin
-00018a60: 655f 7374 6465 7272 2873 656c 6629 3a0a  e_stderr(self):.
-00018a70: 2020 2020 2020 2020 7374 6469 6f2c 205f          stdio, _
-00018a80: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
-00018a90: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
-00018aa0: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
-00018ab0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-00018ac0: 2862 2769 6e76 616c 6964 2074 696d 6520  (b'invalid time 
-00018ad0: 696e 7465 7276 616c 5c6e 2729 0a20 2020  interval\n').   
-00018ae0: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
-00018af0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
-00018b00: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
-00018b10: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00018b20: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-00018b30: 7865 6328 5b27 736c 6565 7027 2c20 2778  xec(['sleep', 'x
-00018b40: 275d 2c20 636f 6d62 696e 655f 7374 6465  '], combine_stde
-00018b50: 7272 3d54 7275 6529 0a20 2020 2020 2020  rr=True).       
-00018b60: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
-00018b70: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
-00018b80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00018b90: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
-00018ba0: 2769 6e76 616c 6964 2074 696d 6520 696e  'invalid time in
-00018bb0: 7465 7276 616c 5c6e 2729 0a20 2020 2020  terval\n').     
-00018bc0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00018bd0: 4e6f 6e65 2865 7272 290a 2020 2020 2020  None(err).      
-00018be0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-00018bf0: 6f6e 6528 7072 6f63 6573 732e 7374 6465  one(process.stde
-00018c00: 7272 290a 0a20 2020 2020 2020 2065 7865  rr)..        exe
-00018c10: 635f 6461 7461 203d 2073 656c 662e 6275  c_data = self.bu
-00018c20: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
-00018c30: 736c 6565 7027 2c20 2778 275d 2c20 636f  sleep', 'x'], co
-00018c40: 6d62 696e 655f 7374 6465 7272 3d54 7275  mbine_stderr=Tru
-00018c50: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00018c60: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00018c70: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-00018c80: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00018c90: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
-00018ca0: 6563 272c 204e 6f6e 652c 2065 7865 635f  ec', None, exec_
-00018cb0: 6461 7461 292c 0a20 2020 2020 2020 2020  data),.         
-00018cc0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-00018cd0: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
-00018ce0: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
-00018cf0: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
-00018d00: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
-00018d10: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00018d20: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
-00018d30: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
-00018d40: 6573 745f 7761 6974 5f6f 7574 7075 745f  est_wait_output_
-00018d50: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
-00018d60: 2020 2020 2073 7464 696f 2c20 7374 6465       stdio, stde
-00018d70: 7272 2c20 5f20 3d20 7365 6c66 2e61 6464  rr, _ = self.add
-00018d80: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
-00018d90: 2c20 3029 0a20 2020 2020 2020 2073 7464  , 0).        std
-00018da0: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
-00018db0: 6e64 2862 2750 7974 686f 6e20 332e 382e  nd(b'Python 3.8.
-00018dc0: 3130 5c6e 2729 0a20 2020 2020 2020 2073  10\n').        s
-00018dd0: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
-00018de0: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
-00018df0: 3a22 656e 6422 7d27 290a 2020 2020 2020  :"end"}').      
-00018e00: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
-00018e10: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
-00018e20: 616e 6422 3a22 656e 6422 7d27 290a 0a20  and":"end"}').. 
-00018e30: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-00018e40: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-00018e50: 6328 5b27 7079 7468 6f6e 3327 2c20 272d  c(['python3', '-
-00018e60: 2d76 6572 7369 6f6e 275d 2c20 656e 636f  -version'], enco
-00018e70: 6469 6e67 3d4e 6f6e 6529 0a20 2020 2020  ding=None).     
-00018e80: 2020 206f 7574 2c20 6572 7220 3d20 7072     out, err = pr
-00018e90: 6f63 6573 732e 7761 6974 5f6f 7574 7075  ocess.wait_outpu
-00018ea0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-00018eb0: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
-00018ec0: 2c20 6227 5079 7468 6f6e 2033 2e38 2e31  , b'Python 3.8.1
-00018ed0: 305c 6e27 290a 2020 2020 2020 2020 7365  0\n').        se
-00018ee0: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-00018ef0: 7272 2c20 6227 2729 0a0a 2020 2020 2020  rr, b'')..      
-00018f00: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00018f10: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00018f20: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00018f30: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
-00018f40: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
-00018f50: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
-00018f60: 635f 6461 7461 285b 2770 7974 686f 6e33  c_data(['python3
-00018f70: 272c 2027 2d2d 7665 7273 696f 6e27 5d29  ', '--version'])
-00018f80: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00018f90: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-00018fa0: 6765 732f 3132 332f 7761 6974 272c 207b  ges/123/wait', {
-00018fb0: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
-00018fc0: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
-00018fd0: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-00018fe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018ff0: 2873 7464 696f 2e73 656e 6473 2c20 5b5d  (stdio.sends, []
-00019000: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00019010: 7761 6974 5f6f 7574 7075 745f 6578 6974  wait_output_exit
-00019020: 5f6e 6f6e 7a65 726f 2873 656c 6629 3a0a  _nonzero(self):.
-00019030: 2020 2020 2020 2020 7374 6469 6f2c 2073          stdio, s
-00019040: 7464 6572 722c 205f 203d 2073 656c 662e  tderr, _ = self.
-00019050: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
-00019060: 3233 272c 2030 290a 2020 2020 2020 2020  23', 0).        
-00019070: 7374 6469 6f2e 7265 6365 6976 6573 2e61  stdio.receives.a
-00019080: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
-00019090: 223a 2265 6e64 227d 2729 0a20 2020 2020  ":"end"}').     
-000190a0: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
-000190b0: 6573 2e61 7070 656e 6428 6227 6669 6c65  es.append(b'file
-000190c0: 206e 6f74 2066 6f75 6e64 3a20 785c 6e27   not found: x\n'
-000190d0: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
-000190e0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-000190f0: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-00019100: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
-00019110: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-00019120: 6965 6e74 2e65 7865 6328 5b27 6c73 272c  ient.exec(['ls',
-00019130: 2027 7827 5d29 0a20 2020 2020 2020 206f   'x']).        o
-00019140: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-00019150: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-00019160: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019170: 6572 7445 7175 616c 286f 7574 2c20 2727  ertEqual(out, ''
-00019180: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00019190: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
-000191a0: 2766 696c 6520 6e6f 7420 666f 756e 643a  'file not found:
-000191b0: 2078 5c6e 2729 0a0a 2020 2020 2020 2020   x\n')..        
-000191c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000191d0: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-000191e0: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-000191f0: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
-00019200: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
-00019210: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
-00019220: 6461 7461 285b 276c 7327 2c20 2778 275d  data(['ls', 'x']
-00019230: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00019240: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-00019250: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
-00019260: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
-00019270: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
-00019280: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-00019290: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000192a0: 6c28 7374 6469 6f2e 7365 6e64 732c 205b  l(stdio.sends, [
-000192b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-000192c0: 5f77 6169 745f 6f75 7470 7574 5f65 7869  _wait_output_exi
-000192d0: 745f 6e6f 6e7a 6572 6f5f 636f 6d62 696e  t_nonzero_combin
-000192e0: 655f 7374 6465 7272 2873 656c 6629 3a0a  e_stderr(self):.
-000192f0: 2020 2020 2020 2020 7374 6469 6f2c 205f          stdio, _
-00019300: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
-00019310: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
-00019320: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
-00019330: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-00019340: 2862 2766 696c 6520 6e6f 7420 666f 756e  (b'file not foun
-00019350: 643a 2078 5c6e 2729 0a20 2020 2020 2020  d: x\n').       
-00019360: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
-00019370: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
-00019380: 6422 3a22 656e 6422 7d27 290a 0a20 2020  d":"end"}')..   
-00019390: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-000193a0: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-000193b0: 5b27 6c73 272c 2027 7827 5d2c 2063 6f6d  ['ls', 'x'], com
-000193c0: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
-000193d0: 290a 2020 2020 2020 2020 6f75 742c 2065  ).        out, e
-000193e0: 7272 203d 2070 726f 6365 7373 2e77 6169  rr = process.wai
-000193f0: 745f 6f75 7470 7574 2829 0a20 2020 2020  t_output().     
-00019400: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00019410: 7561 6c28 6f75 742c 2027 6669 6c65 206e  ual(out, 'file n
-00019420: 6f74 2066 6f75 6e64 3a20 785c 6e27 290a  ot found: x\n').
-00019430: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019440: 6572 7449 734e 6f6e 6528 6572 7229 0a0a  ertIsNone(err)..
-00019450: 2020 2020 2020 2020 6578 6563 5f64 6174          exec_dat
-00019460: 6120 3d20 7365 6c66 2e62 7569 6c64 5f65  a = self.build_e
-00019470: 7865 635f 6461 7461 285b 276c 7327 2c20  xec_data(['ls', 
-00019480: 2778 275d 2c20 636f 6d62 696e 655f 7374  'x'], combine_st
-00019490: 6465 7272 3d54 7275 6529 0a20 2020 2020  derr=True).     
-000194a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000194b0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-000194c0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-000194d0: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
-000194e0: 2027 2f76 312f 6578 6563 272c 204e 6f6e   '/v1/exec', Non
-000194f0: 652c 2065 7865 635f 6461 7461 292c 0a20  e, exec_data),. 
-00019500: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-00019510: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-00019520: 3132 332f 7761 6974 272c 207b 2774 696d  123/wait', {'tim
-00019530: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
-00019540: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-00019550: 205d 290a 2020 2020 2020 2020 7365 6c66   ]).        self
-00019560: 2e61 7373 6572 7445 7175 616c 2873 7464  .assertEqual(std
-00019570: 696f 2e73 656e 6473 2c20 5b5d 290a 0a20  io.sends, []).. 
-00019580: 2020 2064 6566 2074 6573 745f 7761 6974     def test_wait
-00019590: 5f6f 7574 7075 745f 7365 6e64 5f73 7464  _output_send_std
-000195a0: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
-000195b0: 2020 7374 6469 6f2c 2073 7464 6572 722c    stdio, stderr,
-000195c0: 205f 203d 2073 656c 662e 6164 645f 7265   _ = self.add_re
-000195d0: 7370 6f6e 7365 7328 2731 3233 272c 2030  sponses('123', 0
-000195e0: 290a 2020 2020 2020 2020 7374 6469 6f2e  ).        stdio.
-000195f0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-00019600: 6227 464f 4f5c 6e42 4152 5c6e 2729 0a20  b'FOO\nBAR\n'). 
-00019610: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
-00019620: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
-00019630: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
-00019640: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
-00019650: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-00019660: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-00019670: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
-00019680: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-00019690: 6965 6e74 2e65 7865 6328 5b27 6177 6b27  ient.exec(['awk'
-000196a0: 2c20 277b 2070 7269 6e74 2074 6f75 7070  , '{ print toupp
-000196b0: 6572 2824 2920 7d27 5d2c 2073 7464 696e  er($) }'], stdin
-000196c0: 3d27 666f 6f5c 6e62 6172 5c6e 2729 0a20  ='foo\nbar\n'). 
-000196d0: 2020 2020 2020 206f 7574 2c20 6572 7220         out, err 
-000196e0: 3d20 7072 6f63 6573 732e 7761 6974 5f6f  = process.wait_o
-000196f0: 7574 7075 7428 290a 2020 2020 2020 2020  utput().        
-00019700: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00019710: 286f 7574 2c20 2746 4f4f 5c6e 4241 525c  (out, 'FOO\nBAR\
-00019720: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
-00019730: 2e61 7373 6572 7445 7175 616c 2865 7272  .assertEqual(err
-00019740: 2c20 2727 290a 0a20 2020 2020 2020 2073  , '')..        s
-00019750: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019760: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-00019770: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-00019780: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
-00019790: 312f 6578 6563 272c 204e 6f6e 652c 2073  1/exec', None, s
-000197a0: 656c 662e 6275 696c 645f 6578 6563 5f64  elf.build_exec_d
-000197b0: 6174 6128 5b27 6177 6b27 2c20 277b 2070  ata(['awk', '{ p
-000197c0: 7269 6e74 2074 6f75 7070 6572 2824 2920  rint toupper($) 
-000197d0: 7d27 5d29 292c 0a20 2020 2020 2020 2020  }'])),.         
-000197e0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-000197f0: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
-00019800: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
-00019810: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
-00019820: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
-00019830: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00019840: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
-00019850: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00019860: 2827 4249 4e27 2c20 6227 666f 6f5c 6e62  ('BIN', b'foo\nb
-00019870: 6172 5c6e 2729 2c0a 2020 2020 2020 2020  ar\n'),.        
-00019880: 2020 2020 2827 5458 5427 2c20 277b 2263      ('TXT', '{"c
-00019890: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
-000198a0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-000198b0: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
-000198c0: 6f75 7470 7574 5f73 656e 645f 7374 6469  output_send_stdi
-000198d0: 6e5f 6279 7465 7328 7365 6c66 293a 0a20  n_bytes(self):. 
-000198e0: 2020 2020 2020 2073 7464 696f 2c20 7374         stdio, st
-000198f0: 6465 7272 2c20 5f20 3d20 7365 6c66 2e61  derr, _ = self.a
-00019900: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
-00019910: 3327 2c20 3029 0a20 2020 2020 2020 2073  3', 0).        s
-00019920: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
-00019930: 7065 6e64 2862 2746 4f4f 5c6e 4241 525c  pend(b'FOO\nBAR\
-00019940: 6e27 290a 2020 2020 2020 2020 7374 6469  n').        stdi
-00019950: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
-00019960: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
-00019970: 6e64 227d 2729 0a20 2020 2020 2020 2073  nd"}').        s
-00019980: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
-00019990: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
-000199a0: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
-000199b0: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
-000199c0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-000199d0: 2761 776b 272c 2027 7b20 7072 696e 7420  'awk', '{ print 
-000199e0: 746f 7570 7065 7228 2429 207d 275d 2c20  toupper($) }'], 
-000199f0: 7374 6469 6e3d 6227 666f 6f5c 6e62 6172  stdin=b'foo\nbar
-00019a00: 5c6e 272c 0a20 2020 2020 2020 2020 2020  \n',.           
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
-00019a30: 3d4e 6f6e 6529 0a20 2020 2020 2020 206f  =None).        o
-00019a40: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-00019a50: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-00019a60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019a70: 6572 7445 7175 616c 286f 7574 2c20 6227  ertEqual(out, b'
-00019a80: 464f 4f5c 6e42 4152 5c6e 2729 0a20 2020  FOO\nBAR\n').   
-00019a90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00019aa0: 4571 7561 6c28 6572 722c 2062 2727 290a  Equal(err, b'').
-00019ab0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00019ac0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-00019ad0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-00019ae0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-00019af0: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
-00019b00: 272c 204e 6f6e 652c 2073 656c 662e 6275  ', None, self.bu
-00019b10: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
-00019b20: 6177 6b27 2c20 277b 2070 7269 6e74 2074  awk', '{ print t
-00019b30: 6f75 7070 6572 2824 2920 7d27 5d29 292c  oupper($) }'])),
-00019b40: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-00019b50: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-00019b60: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
-00019b70: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
-00019b80: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
-00019b90: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-00019ba0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00019bb0: 7464 696f 2e73 656e 6473 2c20 5b0a 2020  tdio.sends, [.  
-00019bc0: 2020 2020 2020 2020 2020 2827 4249 4e27            ('BIN'
-00019bd0: 2c20 6227 666f 6f5c 6e62 6172 5c6e 2729  , b'foo\nbar\n')
-00019be0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00019bf0: 5458 5427 2c20 277b 2263 6f6d 6d61 6e64  TXT', '{"command
-00019c00: 223a 2265 6e64 227d 2729 2c0a 2020 2020  ":"end"}'),.    
-00019c10: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-00019c20: 7465 7374 5f77 6169 745f 6f75 7470 7574  test_wait_output
-00019c30: 5f62 6164 5f63 6f6d 6d61 6e64 2873 656c  _bad_command(sel
-00019c40: 6629 3a0a 2020 2020 2020 2020 7374 6469  f):.        stdi
-00019c50: 6f2c 2073 7464 6572 722c 205f 203d 2073  o, stderr, _ = s
-00019c60: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
-00019c70: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
-00019c80: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
-00019c90: 6573 2e61 7070 656e 6428 6227 5079 7468  es.append(b'Pyth
-00019ca0: 6f6e 2033 2e38 2e31 305c 6e27 290a 2020  on 3.8.10\n').  
-00019cb0: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
-00019cc0: 6976 6573 2e61 7070 656e 6428 276e 6f74  ives.append('not
-00019cd0: 206a 736f 6e27 2920 2023 2062 6164 204a   json')  # bad J
-00019ce0: 534f 4e20 7368 6f75 6c64 2062 6520 6967  SON should be ig
-00019cf0: 6e6f 7265 640a 2020 2020 2020 2020 7374  nored.        st
-00019d00: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
-00019d10: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-00019d20: 2266 6f6f 227d 2729 2020 2320 756e 6b6e  "foo"}')  # unkn
-00019d30: 6f77 6e20 636f 6d6d 616e 6420 7368 6f75  own command shou
-00019d40: 6c64 2062 6520 6967 6e6f 7265 640a 2020  ld be ignored.  
-00019d50: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
-00019d60: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
-00019d70: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
-00019d80: 0a20 2020 2020 2020 2073 7464 6572 722e  .        stderr.
-00019d90: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-00019da0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
-00019db0: 227d 2729 0a0a 2020 2020 2020 2020 7769  "}')..        wi
-00019dc0: 7468 2073 656c 662e 6173 7365 7274 4c6f  th self.assertLo
-00019dd0: 6773 2827 6f70 732e 7065 6262 6c65 272c  gs('ops.pebble',
-00019de0: 206c 6576 656c 3d27 5741 524e 494e 4727   level='WARNING'
-00019df0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00019e00: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-00019e10: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-00019e20: 5b27 7079 7468 6f6e 3327 2c20 272d 2d76  ['python3', '--v
-00019e30: 6572 7369 6f6e 275d 290a 2020 2020 2020  ersion']).      
-00019e40: 2020 2020 2020 6f75 742c 2065 7272 203d        out, err =
-00019e50: 2070 726f 6365 7373 2e77 6169 745f 6f75   process.wait_ou
-00019e60: 7470 7574 2829 0a20 2020 2020 2020 2073  tput().        s
-00019e70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019e80: 636d 2e6f 7574 7075 742c 205b 0a20 2020  cm.output, [.   
-00019e90: 2020 2020 2020 2020 2022 5741 524e 494e           "WARNIN
-00019ea0: 473a 6f70 732e 7065 6262 6c65 3a43 616e  G:ops.pebble:Can
-00019eb0: 6e6f 7420 6465 636f 6465 2049 2f4f 2063  not decode I/O c
-00019ec0: 6f6d 6d61 6e64 2028 696e 7661 6c69 6420  ommand (invalid 
-00019ed0: 4a53 4f4e 2922 2c0a 2020 2020 2020 2020  JSON)",.        
-00019ee0: 2020 2020 2257 4152 4e49 4e47 3a6f 7073      "WARNING:ops
-00019ef0: 2e70 6562 626c 653a 496e 7661 6c69 6420  .pebble:Invalid 
-00019f00: 492f 4f20 636f 6d6d 616e 6420 2766 6f6f  I/O command 'foo
-00019f10: 2722 2c0a 2020 2020 2020 2020 5d29 0a0a  '",.        ])..
-00019f20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019f30: 6572 7445 7175 616c 286f 7574 2c20 2750  ertEqual(out, 'P
-00019f40: 7974 686f 6e20 332e 382e 3130 5c6e 2729  ython 3.8.10\n')
-00019f50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00019f60: 7365 7274 4571 7561 6c28 6572 722c 2027  sertEqual(err, '
-00019f70: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00019f80: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00019f90: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-00019fa0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-00019fb0: 2028 2750 4f53 5427 2c20 272f 7631 2f65   ('POST', '/v1/e
-00019fc0: 7865 6327 2c20 4e6f 6e65 2c20 7365 6c66  xec', None, self
-00019fd0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
-00019fe0: 285b 2770 7974 686f 6e33 272c 2027 2d2d  (['python3', '--
-00019ff0: 7665 7273 696f 6e27 5d29 292c 0a20 2020  version'])),.   
-0001a000: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0001a010: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
-0001a020: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
-0001a030: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
-0001a040: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0001a050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001a060: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
-0001a070: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
-0001a080: 2064 6566 2074 6573 745f 7761 6974 5f70   def test_wait_p
-0001a090: 6173 7365 645f 6f75 7470 7574 2873 656c  assed_output(sel
-0001a0a0: 6629 3a0a 2020 2020 2020 2020 696f 5f77  f):.        io_w
-0001a0b0: 732c 2073 7464 6572 722c 205f 203d 2073  s, stderr, _ = s
-0001a0c0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
-0001a0d0: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
-0001a0e0: 2020 2020 696f 5f77 732e 7265 6365 6976      io_ws.receiv
-0001a0f0: 6573 2e61 7070 656e 6428 6227 666f 6f5c  es.append(b'foo\
-0001a100: 6e27 290a 2020 2020 2020 2020 696f 5f77  n').        io_w
-0001a110: 732e 7265 6365 6976 6573 2e61 7070 656e  s.receives.appen
-0001a120: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
-0001a130: 6e64 227d 2729 0a20 2020 2020 2020 2073  nd"}').        s
-0001a140: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
-0001a150: 7070 656e 6428 6227 736f 6d65 2065 7272  ppend(b'some err
-0001a160: 6f72 5c6e 2729 0a20 2020 2020 2020 2073  or\n').        s
-0001a170: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
-0001a180: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
-0001a190: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
-0001a1a0: 2020 2020 6f75 7420 3d20 696f 2e53 7472      out = io.Str
-0001a1b0: 696e 6749 4f28 290a 2020 2020 2020 2020  ingIO().        
-0001a1c0: 6572 7220 3d20 696f 2e53 7472 696e 6749  err = io.StringI
-0001a1d0: 4f28 290a 2020 2020 2020 2020 7072 6f63  O().        proc
-0001a1e0: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
-0001a1f0: 742e 6578 6563 285b 2765 6368 6f27 2c20  t.exec(['echo', 
-0001a200: 2766 6f6f 275d 2c20 7374 646f 7574 3d6f  'foo'], stdout=o
-0001a210: 7574 2c20 7374 6465 7272 3d65 7272 290a  ut, stderr=err).
-0001a220: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
-0001a230: 7761 6974 2829 0a20 2020 2020 2020 2073  wait().        s
-0001a240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a250: 6f75 742e 6765 7476 616c 7565 2829 2c20  out.getvalue(), 
-0001a260: 2766 6f6f 5c6e 2729 0a20 2020 2020 2020  'foo\n').       
-0001a270: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001a280: 6c28 6572 722e 6765 7476 616c 7565 2829  l(err.getvalue()
-0001a290: 2c20 2773 6f6d 6520 6572 726f 725c 6e27  , 'some error\n'
-0001a2a0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001a2b0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0001a2c0: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-0001a2d0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001a2e0: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
-0001a2f0: 6563 272c 204e 6f6e 652c 2073 656c 662e  ec', None, self.
-0001a300: 6275 696c 645f 6578 6563 5f64 6174 6128  build_exec_data(
-0001a310: 5b27 6563 686f 272c 2027 666f 6f27 5d29  ['echo', 'foo'])
-0001a320: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-0001a330: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-0001a340: 6765 732f 3132 332f 7761 6974 272c 207b  ges/123/wait', {
-0001a350: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
-0001a360: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
-0001a370: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-0001a380: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001a390: 2869 6f5f 7773 2e73 656e 6473 2c20 5b5d  (io_ws.sends, []
-0001a3a0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001a3b0: 7761 6974 5f70 6173 7365 645f 6f75 7470  wait_passed_outp
-0001a3c0: 7574 5f63 6f6d 6269 6e65 5f73 7464 6572  ut_combine_stder
-0001a3d0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-0001a3e0: 2069 6f5f 7773 2c20 5f2c 205f 203d 2073   io_ws, _, _ = s
-0001a3f0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
-0001a400: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
-0001a410: 2020 2020 696f 5f77 732e 7265 6365 6976      io_ws.receiv
-0001a420: 6573 2e61 7070 656e 6428 6227 666f 6f5c  es.append(b'foo\
-0001a430: 6e27 290a 2020 2020 2020 2020 696f 5f77  n').        io_w
-0001a440: 732e 7265 6365 6976 6573 2e61 7070 656e  s.receives.appen
-0001a450: 6428 6227 736f 6d65 2065 7272 6f72 5c6e  d(b'some error\n
-0001a460: 2729 0a20 2020 2020 2020 2069 6f5f 7773  ').        io_ws
-0001a470: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-0001a480: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-0001a490: 6422 7d27 290a 0a20 2020 2020 2020 206f  d"}')..        o
-0001a4a0: 7574 203d 2069 6f2e 5374 7269 6e67 494f  ut = io.StringIO
-0001a4b0: 2829 0a20 2020 2020 2020 2070 726f 6365  ().        proce
-0001a4c0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
-0001a4d0: 2e65 7865 6328 5b27 6563 686f 272c 2027  .exec(['echo', '
-0001a4e0: 666f 6f27 5d2c 2073 7464 6f75 743d 6f75  foo'], stdout=ou
-0001a4f0: 742c 2063 6f6d 6269 6e65 5f73 7464 6572  t, combine_stder
-0001a500: 723d 5472 7565 290a 2020 2020 2020 2020  r=True).        
-0001a510: 7072 6f63 6573 732e 7761 6974 2829 0a20  process.wait(). 
-0001a520: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001a530: 7274 4571 7561 6c28 6f75 742e 6765 7476  rtEqual(out.getv
-0001a540: 616c 7565 2829 2c20 2766 6f6f 5c6e 736f  alue(), 'foo\nso
-0001a550: 6d65 2065 7272 6f72 5c6e 2729 0a20 2020  me error\n').   
-0001a560: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001a570: 4973 4e6f 6e65 2870 726f 6365 7373 2e73  IsNone(process.s
-0001a580: 7464 6572 7229 0a0a 2020 2020 2020 2020  tderr)..        
-0001a590: 6578 6563 5f64 6174 6120 3d20 7365 6c66  exec_data = self
-0001a5a0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
-0001a5b0: 285b 2765 6368 6f27 2c20 2766 6f6f 275d  (['echo', 'foo']
-0001a5c0: 2c20 636f 6d62 696e 655f 7374 6465 7272  , combine_stderr
-0001a5d0: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
-0001a5e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a5f0: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-0001a600: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-0001a610: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
-0001a620: 312f 6578 6563 272c 204e 6f6e 652c 2065  1/exec', None, e
-0001a630: 7865 635f 6461 7461 292c 0a20 2020 2020  xec_data),.     
-0001a640: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-0001a650: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
-0001a660: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
-0001a670: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
-0001a680: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0001a690: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001a6a0: 6572 7445 7175 616c 2869 6f5f 7773 2e73  ertEqual(io_ws.s
-0001a6b0: 656e 6473 2c20 5b5d 290a 0a20 2020 2064  ends, [])..    d
-0001a6c0: 6566 2074 6573 745f 7761 6974 5f70 6173  ef test_wait_pas
-0001a6d0: 7365 645f 6f75 7470 7574 5f62 7974 6573  sed_output_bytes
-0001a6e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001a6f0: 696f 5f77 732c 2073 7464 6572 722c 205f  io_ws, stderr, _
-0001a700: 203d 2073 656c 662e 6164 645f 7265 7370   = self.add_resp
-0001a710: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
-0001a720: 2020 2020 2020 2020 696f 5f77 732e 7265          io_ws.re
-0001a730: 6365 6976 6573 2e61 7070 656e 6428 6227  ceives.append(b'
-0001a740: 666f 6f5c 6e27 290a 2020 2020 2020 2020  foo\n').        
-0001a750: 696f 5f77 732e 7265 6365 6976 6573 2e61  io_ws.receives.a
-0001a760: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
-0001a770: 223a 2265 6e64 227d 2729 0a20 2020 2020  ":"end"}').     
-0001a780: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
-0001a790: 6573 2e61 7070 656e 6428 6227 736f 6d65  es.append(b'some
-0001a7a0: 2065 7272 6f72 5c6e 2729 0a20 2020 2020   error\n').     
-0001a7b0: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
-0001a7c0: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
-0001a7d0: 6d61 6e64 223a 2265 6e64 227d 2729 0a0a  mand":"end"}')..
-0001a7e0: 2020 2020 2020 2020 6f75 7420 3d20 696f          out = io
-0001a7f0: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
-0001a800: 2020 2065 7272 203d 2069 6f2e 4279 7465     err = io.Byte
-0001a810: 7349 4f28 290a 2020 2020 2020 2020 7072  sIO().        pr
-0001a820: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-0001a830: 656e 742e 6578 6563 285b 2765 6368 6f27  ent.exec(['echo'
-0001a840: 2c20 2766 6f6f 275d 2c20 7374 646f 7574  , 'foo'], stdout
-0001a850: 3d6f 7574 2c20 7374 6465 7272 3d65 7272  =out, stderr=err
-0001a860: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
-0001a870: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001a880: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
-0001a890: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001a8a0: 286f 7574 2e67 6574 7661 6c75 6528 292c  (out.getvalue(),
-0001a8b0: 2062 2766 6f6f 5c6e 2729 0a20 2020 2020   b'foo\n').     
-0001a8c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001a8d0: 7561 6c28 6572 722e 6765 7476 616c 7565  ual(err.getvalue
-0001a8e0: 2829 2c20 6227 736f 6d65 2065 7272 6f72  (), b'some error
-0001a8f0: 5c6e 2729 0a0a 2020 2020 2020 2020 7365  \n')..        se
-0001a900: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0001a910: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0001a920: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0001a930: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-0001a940: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
-0001a950: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
-0001a960: 7461 285b 2765 6368 6f27 2c20 2766 6f6f  ta(['echo', 'foo
-0001a970: 275d 2929 2c0a 2020 2020 2020 2020 2020  '])),.          
-0001a980: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0001a990: 6861 6e67 6573 2f31 3233 2f77 6169 7427  hanges/123/wait'
-0001a9a0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
-0001a9b0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
-0001a9c0: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
-0001a9d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001a9e0: 7561 6c28 696f 5f77 732e 7365 6e64 732c  ual(io_ws.sends,
-0001a9f0: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
-0001aa00: 7374 5f77 6169 745f 7061 7373 6564 5f6f  st_wait_passed_o
-0001aa10: 7574 7075 745f 6261 645f 636f 6d6d 616e  utput_bad_comman
-0001aa20: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-0001aa30: 2069 6f5f 7773 2c20 7374 6465 7272 2c20   io_ws, stderr, 
-0001aa40: 5f20 3d20 7365 6c66 2e61 6464 5f72 6573  _ = self.add_res
-0001aa50: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
-0001aa60: 0a20 2020 2020 2020 2069 6f5f 7773 2e72  .        io_ws.r
-0001aa70: 6563 6569 7665 732e 6170 7065 6e64 2862  eceives.append(b
-0001aa80: 2766 6f6f 5c6e 2729 0a20 2020 2020 2020  'foo\n').       
-0001aa90: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
-0001aaa0: 6170 7065 6e64 2827 6e6f 7420 6a73 6f6e  append('not json
-0001aab0: 2729 2020 2320 6261 6420 4a53 4f4e 2073  ')  # bad JSON s
-0001aac0: 686f 756c 6420 6265 2069 676e 6f72 6564  hould be ignored
-0001aad0: 0a20 2020 2020 2020 2069 6f5f 7773 2e72  .        io_ws.r
-0001aae0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-0001aaf0: 7b22 636f 6d6d 616e 6422 3a22 666f 6f22  {"command":"foo"
-0001ab00: 7d27 2920 2023 2075 6e6b 6e6f 776e 2063  }')  # unknown c
-0001ab10: 6f6d 6d61 6e64 2073 686f 756c 6420 6265  ommand should be
-0001ab20: 2069 676e 6f72 6564 0a20 2020 2020 2020   ignored.       
-0001ab30: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
-0001ab40: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
-0001ab50: 6422 3a22 656e 6422 7d27 290a 2020 2020  d":"end"}').    
-0001ab60: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
-0001ab70: 7665 732e 6170 7065 6e64 2862 2773 6f6d  ves.append(b'som
-0001ab80: 6520 6572 726f 725c 6e27 290a 2020 2020  e error\n').    
-0001ab90: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
-0001aba0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
-0001abb0: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
-0001abc0: 0a20 2020 2020 2020 206f 7574 203d 2069  .        out = i
-0001abd0: 6f2e 5374 7269 6e67 494f 2829 0a20 2020  o.StringIO().   
-0001abe0: 2020 2020 2065 7272 203d 2069 6f2e 5374       err = io.St
-0001abf0: 7269 6e67 494f 2829 0a0a 2020 2020 2020  ringIO()..      
-0001ac00: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001ac10: 7274 4c6f 6773 2827 6f70 732e 7065 6262  rtLogs('ops.pebb
-0001ac20: 6c65 272c 206c 6576 656c 3d27 5741 524e  le', level='WARN
-0001ac30: 494e 4727 2920 6173 2063 6d3a 0a20 2020  ING') as cm:.   
-0001ac40: 2020 2020 2020 2020 2070 726f 6365 7373           process
-0001ac50: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-0001ac60: 7865 6328 5b27 6563 686f 272c 2027 666f  xec(['echo', 'fo
-0001ac70: 6f27 5d2c 2073 7464 6f75 743d 6f75 742c  o'], stdout=out,
-0001ac80: 2073 7464 6572 723d 6572 7229 0a20 2020   stderr=err).   
-0001ac90: 2020 2020 2020 2020 2070 726f 6365 7373           process
-0001aca0: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
-0001acb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001acc0: 2863 6d2e 6f75 7470 7574 2c20 5b0a 2020  (cm.output, [.  
-0001acd0: 2020 2020 2020 2020 2020 2257 4152 4e49            "WARNI
-0001ace0: 4e47 3a6f 7073 2e70 6562 626c 653a 4361  NG:ops.pebble:Ca
-0001acf0: 6e6e 6f74 2064 6563 6f64 6520 492f 4f20  nnot decode I/O 
-0001ad00: 636f 6d6d 616e 6420 2869 6e76 616c 6964  command (invalid
-0001ad10: 204a 534f 4e29 222c 0a20 2020 2020 2020   JSON)",.       
-0001ad20: 2020 2020 2022 5741 524e 494e 473a 6f70       "WARNING:op
-0001ad30: 732e 7065 6262 6c65 3a49 6e76 616c 6964  s.pebble:Invalid
-0001ad40: 2049 2f4f 2063 6f6d 6d61 6e64 2027 666f   I/O command 'fo
-0001ad50: 6f27 222c 0a20 2020 2020 2020 205d 290a  o'",.        ]).
-0001ad60: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ad70: 7365 7274 4571 7561 6c28 6f75 742e 6765  sertEqual(out.ge
-0001ad80: 7476 616c 7565 2829 2c20 2766 6f6f 5c6e  tvalue(), 'foo\n
-0001ad90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001ada0: 6173 7365 7274 4571 7561 6c28 6572 722e  assertEqual(err.
-0001adb0: 6765 7476 616c 7565 2829 2c20 2773 6f6d  getvalue(), 'som
-0001adc0: 6520 6572 726f 725c 6e27 290a 0a20 2020  e error\n')..   
-0001add0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001ade0: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
-0001adf0: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
-0001ae00: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
-0001ae10: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
-0001ae20: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
-0001ae30: 6578 6563 5f64 6174 6128 5b27 6563 686f  exec_data(['echo
-0001ae40: 272c 2027 666f 6f27 5d29 292c 0a20 2020  ', 'foo'])),.   
-0001ae50: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0001ae60: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
-0001ae70: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
-0001ae80: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
-0001ae90: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0001aea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001aeb0: 7373 6572 7445 7175 616c 2869 6f5f 7773  ssertEqual(io_ws
-0001aec0: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
-0001aed0: 2064 6566 2074 6573 745f 7761 6974 5f66   def test_wait_f
-0001aee0: 696c 655f 696f 2873 656c 6629 3a0a 2020  ile_io(self):.  
-0001aef0: 2020 2020 2020 6669 6e20 3d20 7465 6d70        fin = temp
-0001af00: 6669 6c65 2e54 656d 706f 7261 7279 4669  file.TemporaryFi
-0001af10: 6c65 286d 6f64 653d 2777 2b27 2c20 656e  le(mode='w+', en
-0001af20: 636f 6469 6e67 3d27 7574 662d 3827 290a  coding='utf-8').
-0001af30: 2020 2020 2020 2020 6f75 7420 3d20 7465          out = te
-0001af40: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
-0001af50: 4669 6c65 286d 6f64 653d 2777 2b27 2c20  File(mode='w+', 
-0001af60: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-0001af70: 290a 2020 2020 2020 2020 6572 7220 3d20  ).        err = 
-0001af80: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
-0001af90: 7279 4669 6c65 286d 6f64 653d 2777 2b27  ryFile(mode='w+'
-0001afa0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
-0001afb0: 3827 290a 2020 2020 2020 2020 7472 793a  8').        try:
-0001afc0: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
-0001afd0: 2e77 7269 7465 2827 666f 6f5c 6e27 290a  .write('foo\n').
-0001afe0: 2020 2020 2020 2020 2020 2020 6669 6e2e              fin.
-0001aff0: 7365 656b 2830 290a 0a20 2020 2020 2020  seek(0)..       
-0001b000: 2020 2020 2069 6f5f 7773 2c20 7374 6465       io_ws, stde
-0001b010: 7272 2c20 5f20 3d20 7365 6c66 2e61 6464  rr, _ = self.add
-0001b020: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
-0001b030: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
-0001b040: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
-0001b050: 6170 7065 6e64 2862 2766 6f6f 5c6e 2729  append(b'foo\n')
-0001b060: 0a20 2020 2020 2020 2020 2020 2069 6f5f  .            io_
-0001b070: 7773 2e72 6563 6569 7665 732e 6170 7065  ws.receives.appe
-0001b080: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
-0001b090: 656e 6422 7d27 290a 2020 2020 2020 2020  end"}').        
-0001b0a0: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
-0001b0b0: 7665 732e 6170 7065 6e64 2862 2773 6f6d  ves.append(b'som
-0001b0c0: 6520 6572 726f 725c 6e27 290a 2020 2020  e error\n').    
-0001b0d0: 2020 2020 2020 2020 7374 6465 7272 2e72          stderr.r
-0001b0e0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-0001b0f0: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
-0001b100: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
-0001b110: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
-0001b120: 636c 6965 6e74 2e65 7865 6328 5b27 6563  client.exec(['ec
-0001b130: 686f 272c 2027 666f 6f27 5d2c 2073 7464  ho', 'foo'], std
-0001b140: 696e 3d66 696e 2c20 7374 646f 7574 3d6f  in=fin, stdout=o
-0001b150: 7574 2c20 7374 6465 7272 3d65 7272 290a  ut, stderr=err).
-0001b160: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-0001b170: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
-0001b180: 2020 2020 2020 2020 6f75 742e 7365 656b          out.seek
-0001b190: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-0001b1a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001b1b0: 286f 7574 2e72 6561 6428 292c 2027 666f  (out.read(), 'fo
-0001b1c0: 6f5c 6e27 290a 2020 2020 2020 2020 2020  o\n').          
-0001b1d0: 2020 6572 722e 7365 656b 2830 290a 2020    err.seek(0).  
-0001b1e0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0001b1f0: 7373 6572 7445 7175 616c 2865 7272 2e72  ssertEqual(err.r
-0001b200: 6561 6428 292c 2027 736f 6d65 2065 7272  ead(), 'some err
-0001b210: 6f72 5c6e 2729 0a0a 2020 2020 2020 2020  or\n')..        
-0001b220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b230: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-0001b240: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0001b250: 2020 2020 2020 2020 2020 2020 2028 2750               ('P
-0001b260: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
-0001b270: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
-0001b280: 6c64 5f65 7865 635f 6461 7461 285b 2765  ld_exec_data(['e
-0001b290: 6368 6f27 2c20 2766 6f6f 275d 2929 2c0a  cho', 'foo'])),.
-0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2b0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0001b2c0: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
-0001b2d0: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
-0001b2e0: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
-0001b2f0: 2020 2020 2020 2020 2020 5d29 0a20 2020            ]).   
-0001b300: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-0001b310: 7365 7274 4571 7561 6c28 696f 5f77 732e  sertEqual(io_ws.
-0001b320: 7365 6e64 732c 205b 0a20 2020 2020 2020  sends, [.       
-0001b330: 2020 2020 2020 2020 2028 2742 494e 272c           ('BIN',
-0001b340: 2062 2766 6f6f 5c6e 2729 2c0a 2020 2020   b'foo\n'),.    
-0001b350: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
-0001b360: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
-0001b370: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
-0001b380: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-0001b390: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-0001b3a0: 2020 2020 2020 6669 6e2e 636c 6f73 6528        fin.close(
-0001b3b0: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
-0001b3c0: 742e 636c 6f73 6528 290a 2020 2020 2020  t.close().      
-0001b3d0: 2020 2020 2020 6572 722e 636c 6f73 6528        err.close(
-0001b3e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001b3f0: 7761 6974 5f72 6574 7572 6e65 645f 696f  wait_returned_io
-0001b400: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001b410: 7374 6469 6f2c 2073 7464 6572 722c 205f  stdio, stderr, _
-0001b420: 203d 2073 656c 662e 6164 645f 7265 7370   = self.add_resp
-0001b430: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
-0001b440: 2020 2020 2020 2020 7374 6469 6f2e 7265          stdio.re
-0001b450: 6365 6976 6573 2e61 7070 656e 6428 6227  ceives.append(b'
-0001b460: 464f 4f20 4241 525c 6e27 290a 2020 2020  FOO BAR\n').    
-0001b470: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
-0001b480: 6573 2e61 7070 656e 6428 6227 4241 5a5a  es.append(b'BAZZ
-0001b490: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
-0001b4a0: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
-0001b4b0: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
-0001b4c0: 656e 6422 7d27 290a 0a20 2020 2020 2020  end"}')..       
-0001b4d0: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
-0001b4e0: 636c 6965 6e74 2e65 7865 6328 5b27 6177  client.exec(['aw
-0001b4f0: 6b27 2c20 277b 2070 7269 6e74 2074 6f75  k', '{ print tou
-0001b500: 7070 6572 2824 2920 7d27 5d29 0a20 2020  pper($) }']).   
-0001b510: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
-0001b520: 696e 2e77 7269 7465 2827 466f 6f20 4261  in.write('Foo Ba
-0001b530: 725c 6e27 290a 2020 2020 2020 2020 7365  r\n').        se
-0001b540: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-0001b550: 726f 6365 7373 2e73 7464 6f75 742e 7265  rocess.stdout.re
-0001b560: 6164 2834 292c 2027 464f 4f20 2729 0a20  ad(4), 'FOO '). 
-0001b570: 2020 2020 2020 2070 726f 6365 7373 2e73         process.s
-0001b580: 7464 696e 2e77 7269 7465 2827 6261 7a7a  tdin.write('bazz
-0001b590: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
-0001b5a0: 662e 6173 7365 7274 4571 7561 6c28 7072  f.assertEqual(pr
-0001b5b0: 6f63 6573 732e 7374 646f 7574 2e72 6561  ocess.stdout.rea
-0001b5c0: 6428 292c 2027 4241 525c 6e42 415a 5a5c  d(), 'BAR\nBAZZ\
-0001b5d0: 6e27 290a 2020 2020 2020 2020 7072 6f63  n').        proc
-0001b5e0: 6573 732e 7374 6469 6e2e 636c 6f73 6528  ess.stdin.close(
-0001b5f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001b600: 7373 6572 7445 7175 616c 2870 726f 6365  ssertEqual(proce
-0001b610: 7373 2e73 7464 6f75 742e 7265 6164 2829  ss.stdout.read()
-0001b620: 2c20 2727 290a 2020 2020 2020 2020 7072  , '').        pr
-0001b630: 6f63 6573 732e 7761 6974 2829 0a0a 2020  ocess.wait()..  
-0001b640: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b650: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-0001b660: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-0001b670: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-0001b680: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
-0001b690: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
-0001b6a0: 5f65 7865 635f 6461 7461 285b 2761 776b  _exec_data(['awk
-0001b6b0: 272c 2027 7b20 7072 696e 7420 746f 7570  ', '{ print toup
-0001b6c0: 7065 7228 2429 207d 275d 2929 2c0a 2020  per($) }'])),.  
-0001b6d0: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-0001b6e0: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
-0001b6f0: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
-0001b700: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-0001b710: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0001b720: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-0001b730: 6173 7365 7274 4571 7561 6c28 7374 6469  assertEqual(stdi
-0001b740: 6f2e 7365 6e64 732c 205b 0a20 2020 2020  o.sends, [.     
-0001b750: 2020 2020 2020 2028 2742 494e 272c 2062         ('BIN', b
-0001b760: 2746 6f6f 2042 6172 5c6e 6261 7a7a 5c6e  'Foo Bar\nbazz\n
-0001b770: 2729 2c20 2023 2054 6578 7449 4f57 7261  '),  # TextIOWra
-0001b780: 7070 6572 2067 726f 7570 7320 7468 6520  pper groups the 
-0001b790: 7772 6974 6573 2074 6f67 6574 6865 720a  writes together.
-0001b7a0: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
-0001b7b0: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
-0001b7c0: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
-0001b7d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0001b7e0: 7374 5f77 6169 745f 7265 7475 726e 6564  st_wait_returned
-0001b7f0: 5f69 6f5f 6279 7465 7328 7365 6c66 293a  _io_bytes(self):
-0001b800: 0a20 2020 2020 2020 2073 7464 696f 2c20  .        stdio, 
-0001b810: 7374 6465 7272 2c20 5f20 3d20 7365 6c66  stderr, _ = self
-0001b820: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
-0001b830: 3132 3327 2c20 3029 0a20 2020 2020 2020  123', 0).       
-0001b840: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
-0001b850: 6170 7065 6e64 2862 2746 4f4f 2042 4152  append(b'FOO BAR
-0001b860: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
-0001b870: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
-0001b880: 6e64 2862 2742 415a 5a5c 6e27 290a 2020  nd(b'BAZZ\n').  
-0001b890: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
-0001b8a0: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
-0001b8b0: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
-0001b8c0: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
-0001b8d0: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
-0001b8e0: 6578 6563 285b 2761 776b 272c 2027 7b20  exec(['awk', '{ 
-0001b8f0: 7072 696e 7420 746f 7570 7065 7228 2429  print toupper($)
-0001b900: 207d 275d 2c20 656e 636f 6469 6e67 3d4e   }'], encoding=N
-0001b910: 6f6e 6529 0a20 2020 2020 2020 2070 726f  one).        pro
-0001b920: 6365 7373 2e73 7464 696e 2e77 7269 7465  cess.stdin.write
-0001b930: 2862 2746 6f6f 2042 6172 5c6e 2729 0a20  (b'Foo Bar\n'). 
-0001b940: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001b950: 7274 4571 7561 6c28 7072 6f63 6573 732e  rtEqual(process.
-0001b960: 7374 646f 7574 2e72 6561 6428 3429 2c20  stdout.read(4), 
-0001b970: 6227 464f 4f20 2729 0a20 2020 2020 2020  b'FOO ').       
-0001b980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001b990: 6c28 7072 6f63 6573 732e 7374 646f 7574  l(process.stdout
-0001b9a0: 2e72 6561 6428 292c 2062 2742 4152 5c6e  .read(), b'BAR\n
-0001b9b0: 2729 0a20 2020 2020 2020 2070 726f 6365  ').        proce
-0001b9c0: 7373 2e73 7464 696e 2e77 7269 7465 2862  ss.stdin.write(b
-0001b9d0: 2762 617a 7a5c 6e27 290a 2020 2020 2020  'bazz\n').      
-0001b9e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001b9f0: 616c 2870 726f 6365 7373 2e73 7464 6f75  al(process.stdou
-0001ba00: 742e 7265 6164 2829 2c20 6227 4241 5a5a  t.read(), b'BAZZ
-0001ba10: 5c6e 2729 0a20 2020 2020 2020 2070 726f  \n').        pro
-0001ba20: 6365 7373 2e73 7464 696e 2e63 6c6f 7365  cess.stdin.close
-0001ba30: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001ba40: 6173 7365 7274 4571 7561 6c28 7072 6f63  assertEqual(proc
-0001ba50: 6573 732e 7374 646f 7574 2e72 6561 6428  ess.stdout.read(
-0001ba60: 292c 2062 2727 290a 2020 2020 2020 2020  ), b'').        
-0001ba70: 7072 6f63 6573 732e 7761 6974 2829 0a0a  process.wait()..
-0001ba80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ba90: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-0001baa0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-0001bab0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-0001bac0: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
-0001bad0: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
-0001bae0: 6c64 5f65 7865 635f 6461 7461 285b 2761  ld_exec_data(['a
-0001baf0: 776b 272c 2027 7b20 7072 696e 7420 746f  wk', '{ print to
-0001bb00: 7570 7065 7228 2429 207d 275d 2929 2c0a  upper($) }'])),.
-0001bb10: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
-0001bb20: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
-0001bb30: 2f31 3233 2f77 6169 7427 2c20 7b27 7469  /123/wait', {'ti
-0001bb40: 6d65 6f75 7427 3a20 2734 2e30 3030 7327  meout': '4.000s'
-0001bb50: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-0001bb60: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
-0001bb70: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
-0001bb80: 6469 6f2e 7365 6e64 732c 205b 0a20 2020  dio.sends, [.   
-0001bb90: 2020 2020 2020 2020 2028 2742 494e 272c           ('BIN',
-0001bba0: 2062 2746 6f6f 2042 6172 5c6e 2729 2c0a   b'Foo Bar\n'),.
-0001bbb0: 2020 2020 2020 2020 2020 2020 2827 4249              ('BI
-0001bbc0: 4e27 2c20 6227 6261 7a7a 5c6e 2729 2c0a  N', b'bazz\n'),.
-0001bbd0: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
-0001bbe0: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
-0001bbf0: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
-0001bc00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0001bc10: 7374 5f63 6f6e 6e65 6374 5f77 6562 736f  st_connect_webso
-0001bc20: 636b 6574 5f65 7272 6f72 2873 656c 6629  cket_error(self)
-0001bc30: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
-0001bc40: 436c 6965 6e74 284d 6f63 6b43 6c69 656e  Client(MockClien
-0001bc50: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0001bc60: 6465 6620 5f63 6f6e 6e65 6374 5f77 6562  def _connect_web
-0001bc70: 736f 636b 6574 2873 656c 662c 2063 6861  socket(self, cha
-0001bc80: 6e67 655f 6964 2c20 7765 6273 6f63 6b65  nge_id, websocke
-0001bc90: 745f 6964 293a 0a20 2020 2020 2020 2020  t_id):.         
-0001bca0: 2020 2020 2020 2072 6169 7365 2077 6562         raise web
-0001bcb0: 736f 636b 6574 2e57 6562 536f 636b 6574  socket.WebSocket
-0001bcc0: 4578 6365 7074 696f 6e28 2763 6f6e 6e21  Exception('conn!
-0001bcd0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001bce0: 2e63 6c69 656e 7420 3d20 436c 6965 6e74  .client = Client
-0001bcf0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001bd00: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
-0001bd10: 3233 272c 2030 2c20 6368 616e 6765 5f65  23', 0, change_e
-0001bd20: 7272 3d27 6368 616e 6765 2065 7272 6f72  rr='change error
-0001bd30: 2127 290a 2020 2020 2020 2020 7769 7468  !').        with
-0001bd40: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001bd50: 6573 2870 6562 626c 652e 4368 616e 6765  es(pebble.Change
-0001bd60: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-0001bd70: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0001bd80: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
-0001bd90: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
-0001bda0: 2e61 7373 6572 7445 7175 616c 2873 7472  .assertEqual(str
-0001bdb0: 2863 6d2e 6578 6365 7074 696f 6e29 2c20  (cm.exception), 
-0001bdc0: 2763 6861 6e67 6520 6572 726f 7221 2729  'change error!')
-0001bdd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-0001bde0: 6c69 656e 7420 3d20 436c 6965 6e74 2829  lient = Client()
-0001bdf0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001be00: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
-0001be10: 272c 2030 290a 2020 2020 2020 2020 7769  ', 0).        wi
-0001be20: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001be30: 6973 6573 2870 6562 626c 652e 436f 6e6e  ises(pebble.Conn
-0001be40: 6563 7469 6f6e 4572 726f 7229 2061 7320  ectionError) as 
-0001be50: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-0001be60: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-0001be70: 285b 2766 6f6f 275d 290a 2020 2020 2020  (['foo']).      
-0001be80: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
-0001be90: 7374 7228 636d 2e65 7863 6570 7469 6f6e  str(cm.exception
-0001bea0: 292c 2027 756e 6578 7065 6374 6564 2065  ), 'unexpected e
-0001beb0: 7272 6f72 2063 6f6e 6e65 6374 696e 6720  rror connecting 
-0001bec0: 746f 2077 6562 736f 636b 6574 733a 2063  to websockets: c
-0001bed0: 6f6e 6e21 2729 0a0a 2020 2020 6465 6620  onn!')..    def 
-0001bee0: 7465 7374 5f77 6562 736f 636b 6574 5f73  test_websocket_s
-0001bef0: 656e 645f 7261 6973 6573 2873 656c 6629  end_raises(self)
-0001bf00: 3a0a 2020 2020 2020 2020 7374 6469 6f2c  :.        stdio,
-0001bf10: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
-0001bf20: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
-0001bf30: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
-0001bf40: 2020 7261 6973 6564 203d 2046 616c 7365    raised = False
-0001bf50: 0a0a 2020 2020 2020 2020 6465 6620 7365  ..        def se
-0001bf60: 6e64 5f62 696e 6172 7928 6229 3a0a 2020  nd_binary(b):.  
-0001bf70: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
-0001bf80: 616c 2072 6169 7365 640a 2020 2020 2020  al raised.      
-0001bf90: 2020 2020 2020 7261 6973 6564 203d 2054        raised = T
-0001bfa0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0001bfb0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0001bfc0: 2761 2073 696d 756c 6174 6564 2065 7272  'a simulated err
-0001bfd0: 6f72 2127 290a 0a20 2020 2020 2020 2073  or!')..        s
-0001bfe0: 7464 696f 2e73 656e 645f 6269 6e61 7279  tdio.send_binary
-0001bff0: 203d 2073 656e 645f 6269 6e61 7279 0a20   = send_binary. 
-0001c000: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
-0001c010: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
-0001c020: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
-0001c030: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
-0001c040: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-0001c050: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-0001c060: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
-0001c070: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-0001c080: 6965 6e74 2e65 7865 6328 5b27 6361 7427  ient.exec(['cat'
-0001c090: 5d2c 2073 7464 696e 3d27 666f 6f5c 6e62  ], stdin='foo\nb
-0001c0a0: 6172 5c6e 2729 0a20 2020 2020 2020 206f  ar\n').        o
-0001c0b0: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-0001c0c0: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-0001c0d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001c0e0: 6572 7445 7175 616c 286f 7574 2c20 2727  ertEqual(out, ''
-0001c0f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001c100: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
-0001c110: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-0001c120: 2e61 7373 6572 7454 7275 6528 7261 6973  .assertTrue(rais
-0001c130: 6564 290a 0a20 2020 2020 2020 2073 656c  ed)..        sel
-0001c140: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001c150: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-0001c160: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0001c170: 2020 2827 504f 5354 272c 2027 2f76 312f    ('POST', '/v1/
-0001c180: 6578 6563 272c 204e 6f6e 652c 2073 656c  exec', None, sel
-0001c190: 662e 6275 696c 645f 6578 6563 5f64 6174  f.build_exec_dat
-0001c1a0: 6128 5b27 6361 7427 5d29 292c 0a20 2020  a(['cat'])),.   
-0001c1b0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0001c1c0: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
-0001c1d0: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
-0001c1e0: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
-0001c1f0: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0001c200: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001c210: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
-0001c220: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
-0001c230: 2023 2059 6f75 2764 206e 6f72 6d61 6c6c   # You'd normall
-0001c240: 7920 7573 6520 7079 7465 7374 2e6d 6172  y use pytest.mar
-0001c250: 6b2e 6669 6c74 6572 7761 726e 696e 6773  k.filterwarnings
-0001c260: 2061 7320 6120 6465 636f 7261 746f 722c   as a decorator,
-0001c270: 2062 7574 0a20 2020 2023 2050 7974 6573   but.    # Pytes
-0001c280: 7455 6e68 616e 646c 6564 5468 7265 6164  tUnhandledThread
-0001c290: 4578 6365 7074 696f 6e57 6172 6e69 6e67  ExceptionWarning
-0001c2a0: 2069 736e 2774 2070 7265 7365 6e74 206f   isn't present o
-0001c2b0: 6e20 6f6c 6465 7220 5079 7468 6f6e 2076  n older Python v
-0001c2c0: 6572 7369 6f6e 732e 0a20 2020 2069 6620  ersions..    if 
-0001c2d0: 6861 7361 7474 7228 7079 7465 7374 2c20  hasattr(pytest, 
-0001c2e0: 2750 7974 6573 7455 6e68 616e 646c 6564  'PytestUnhandled
-0001c2f0: 5468 7265 6164 4578 6365 7074 696f 6e57  ThreadExceptionW
-0001c300: 6172 6e69 6e67 2729 3a0a 2020 2020 2020  arning'):.      
-0001c310: 2020 7465 7374 5f77 6562 736f 636b 6574    test_websocket
-0001c320: 5f73 656e 645f 7261 6973 6573 203d 2070  _send_raises = p
-0001c330: 7974 6573 742e 6d61 726b 2e66 696c 7465  ytest.mark.filte
-0001c340: 7277 6172 6e69 6e67 7328 0a20 2020 2020  rwarnings(.     
-0001c350: 2020 2020 2020 2027 6967 6e6f 7265 3a3a         'ignore::
-0001c360: 7079 7465 7374 2e50 7974 6573 7455 6e68  pytest.PytestUnh
-0001c370: 616e 646c 6564 5468 7265 6164 4578 6365  andledThreadExce
-0001c380: 7074 696f 6e57 6172 6e69 6e67 2729 2874  ptionWarning')(t
-0001c390: 6573 745f 7765 6273 6f63 6b65 745f 7365  est_websocket_se
-0001c3a0: 6e64 5f72 6169 7365 7329 0a0a 2020 2020  nd_raises)..    
-0001c3b0: 6465 6620 7465 7374 5f77 6562 736f 636b  def test_websock
-0001c3c0: 6574 5f72 6563 765f 7261 6973 6573 2873  et_recv_raises(s
-0001c3d0: 656c 6629 3a0a 2020 2020 2020 2020 7374  elf):.        st
-0001c3e0: 6469 6f2c 2073 7464 6572 722c 205f 203d  dio, stderr, _ =
-0001c3f0: 2073 656c 662e 6164 645f 7265 7370 6f6e   self.add_respon
-0001c400: 7365 7328 2731 3233 272c 2030 290a 2020  ses('123', 0).  
-0001c410: 2020 2020 2020 7261 6973 6564 203d 2046        raised = F
-0001c420: 616c 7365 0a0a 2020 2020 2020 2020 6465  alse..        de
-0001c430: 6620 7265 6376 2829 3a0a 2020 2020 2020  f recv():.      
-0001c440: 2020 2020 2020 6e6f 6e6c 6f63 616c 2072        nonlocal r
-0001c450: 6169 7365 640a 2020 2020 2020 2020 2020  aised.          
-0001c460: 2020 7261 6973 6564 203d 2054 7275 650a    raised = True.
-0001c470: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001c480: 6520 4578 6365 7074 696f 6e28 2761 2073  e Exception('a s
-0001c490: 696d 756c 6174 6564 2065 7272 6f72 2127  imulated error!'
-0001c4a0: 290a 0a20 2020 2020 2020 2073 7464 696f  )..        stdio
-0001c4b0: 2e72 6563 7620 3d20 7265 6376 0a20 2020  .recv = recv.   
-0001c4c0: 2020 2020 2073 7464 6572 722e 7265 6365       stderr.rece
-0001c4d0: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
-0001c4e0: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
-0001c4f0: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
-0001c500: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
-0001c510: 6578 6563 285b 2763 6174 275d 2c20 7374  exec(['cat'], st
-0001c520: 6469 6e3d 2766 6f6f 5c6e 6261 725c 6e27  din='foo\nbar\n'
-0001c530: 290a 2020 2020 2020 2020 6f75 742c 2065  ).        out, e
-0001c540: 7272 203d 2070 726f 6365 7373 2e77 6169  rr = process.wai
-0001c550: 745f 6f75 7470 7574 2829 0a20 2020 2020  t_output().     
-0001c560: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001c570: 7561 6c28 6f75 742c 2027 2729 0a20 2020  ual(out, '').   
-0001c580: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c590: 4571 7561 6c28 6572 722c 2027 2729 0a20  Equal(err, ''). 
-0001c5a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001c5b0: 7274 5472 7565 2872 6169 7365 6429 0a0a  rtTrue(raised)..
-0001c5c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001c5d0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-0001c5e0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-0001c5f0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-0001c600: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
-0001c610: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
-0001c620: 6c64 5f65 7865 635f 6461 7461 285b 2763  ld_exec_data(['c
-0001c630: 6174 275d 2929 2c0a 2020 2020 2020 2020  at'])),.        
-0001c640: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-0001c650: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
-0001c660: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
-0001c670: 2734 2e30 3030 7327 7d2c 204e 6f6e 6529  '4.000s'}, None)
-0001c680: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0001c690: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c6a0: 4571 7561 6c28 7374 6469 6f2e 7365 6e64  Equal(stdio.send
-0001c6b0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0001c6c0: 2028 2742 494e 272c 2062 2766 6f6f 5c6e   ('BIN', b'foo\n
-0001c6d0: 6261 725c 6e27 292c 0a20 2020 2020 2020  bar\n'),.       
-0001c6e0: 2020 2020 2028 2754 5854 272c 2027 7b22       ('TXT', '{"
-0001c6f0: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
-0001c700: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0001c710: 2020 2069 6620 6861 7361 7474 7228 7079     if hasattr(py
-0001c720: 7465 7374 2c20 2750 7974 6573 7455 6e68  test, 'PytestUnh
-0001c730: 616e 646c 6564 5468 7265 6164 4578 6365  andledThreadExce
-0001c740: 7074 696f 6e57 6172 6e69 6e67 2729 3a0a  ptionWarning'):.
-0001c750: 2020 2020 2020 2020 7465 7374 5f77 6562          test_web
-0001c760: 736f 636b 6574 5f72 6563 765f 7261 6973  socket_recv_rais
-0001c770: 6573 203d 2070 7974 6573 742e 6d61 726b  es = pytest.mark
-0001c780: 2e66 696c 7465 7277 6172 6e69 6e67 7328  .filterwarnings(
-0001c790: 0a20 2020 2020 2020 2020 2020 2027 6967  .            'ig
-0001c7a0: 6e6f 7265 3a3a 7079 7465 7374 2e50 7974  nore::pytest.Pyt
-0001c7b0: 6573 7455 6e68 616e 646c 6564 5468 7265  estUnhandledThre
-0001c7c0: 6164 4578 6365 7074 696f 6e57 6172 6e69  adExceptionWarni
-0001c7d0: 6e67 2729 2874 6573 745f 7765 6273 6f63  ng')(test_websoc
-0001c7e0: 6b65 745f 7265 6376 5f72 6169 7365 7329  ket_recv_raises)
-0001c7f0: 0a0a 0a23 2053 6574 2074 6865 2052 554e  ...# Set the RUN
-0001c800: 5f52 4541 4c5f 5045 4242 4c45 5f54 4553  _REAL_PEBBLE_TES
-0001c810: 5453 2065 6e76 6972 6f6e 6d65 6e74 2076  TS environment v
-0001c820: 6172 6961 626c 6520 746f 2072 756e 2074  ariable to run t
-0001c830: 6865 7365 2074 6573 7473 0a23 2061 6761  hese tests.# aga
-0001c840: 696e 7374 2061 2072 6561 6c20 5065 6262  inst a real Pebb
-0001c850: 6c65 2073 6572 7665 722e 2046 6f72 2065  le server. For e
-0001c860: 7861 6d70 6c65 2c20 696e 206f 6e65 2074  xample, in one t
-0001c870: 6572 6d69 6e61 6c2c 2072 756e 2050 6562  erminal, run Peb
-0001c880: 626c 653a 0a23 0a23 2024 2050 4542 424c  ble:.#.# $ PEBBL
-0001c890: 453d 7e2f 7065 6262 6c65 2070 6562 626c  E=~/pebble pebbl
-0001c8a0: 6520 7275 6e20 2d2d 6874 7470 3d3a 3430  e run --http=:40
-0001c8b0: 3030 0a23 2032 3032 312d 3039 2d32 3054  00.# 2021-09-20T
-0001c8c0: 3034 3a31 303a 3334 2e39 3334 5a20 5b70  04:10:34.934Z [p
-0001c8d0: 6562 626c 655d 2053 7461 7274 6564 2064  ebble] Started d
-0001c8e0: 6165 6d6f 6e0a 230a 2320 496e 2061 6e6f  aemon.#.# In ano
-0001c8f0: 7468 6572 2074 6572 6d69 6e61 6c2c 2072  ther terminal, r
-0001c900: 756e 2074 6865 2074 6573 7473 3a0a 230a  un the tests:.#.
-0001c910: 2320 2420 736f 7572 6365 202e 746f 782f  # $ source .tox/
-0001c920: 756e 6974 2f62 696e 2f61 6374 6976 6174  unit/bin/activat
-0001c930: 650a 2320 2420 5255 4e5f 5245 414c 5f50  e.# $ RUN_REAL_P
-0001c940: 4542 424c 455f 5445 5354 533d 3120 5045  EBBLE_TESTS=1 PE
-0001c950: 4242 4c45 3d7e 2f70 6562 626c 6520 7079  BBLE=~/pebble py
-0001c960: 7465 7374 2074 6573 742f 7465 7374 5f70  test test/test_p
-0001c970: 6562 626c 652e 7079 202d 7620 2d6b 2052  ebble.py -v -k R
-0001c980: 6561 6c50 6562 626c 650a 2320 2420 6465  ealPebble.# $ de
-0001c990: 6163 7469 7661 7465 0a23 0a40 756e 6974  activate.#.@unit
-0001c9a0: 7465 7374 2e73 6b69 7055 6e6c 6573 7328  test.skipUnless(
-0001c9b0: 6f73 2e67 6574 656e 7628 2752 554e 5f52  os.getenv('RUN_R
-0001c9c0: 4541 4c5f 5045 4242 4c45 5f54 4553 5453  EAL_PEBBLE_TESTS
-0001c9d0: 2729 2c20 2752 554e 5f52 4541 4c5f 5045  '), 'RUN_REAL_PE
-0001c9e0: 4242 4c45 5f54 4553 5453 206e 6f74 2073  BBLE_TESTS not s
-0001c9f0: 6574 2729 0a63 6c61 7373 2054 6573 7452  et').class TestR
-0001ca00: 6561 6c50 6562 626c 6528 756e 6974 7465  ealPebble(unitte
-0001ca10: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
-0001ca20: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-0001ca30: 293a 0a20 2020 2020 2020 2073 6f63 6b65  ):.        socke
-0001ca40: 745f 7061 7468 203d 206f 732e 6765 7465  t_path = os.gete
-0001ca50: 6e76 2827 5045 4242 4c45 5f53 4f43 4b45  nv('PEBBLE_SOCKE
-0001ca60: 5427 290a 2020 2020 2020 2020 6966 206e  T').        if n
-0001ca70: 6f74 2073 6f63 6b65 745f 7061 7468 2061  ot socket_path a
-0001ca80: 6e64 206f 732e 6765 7465 6e76 2827 5045  nd os.getenv('PE
-0001ca90: 4242 4c45 2729 3a0a 2020 2020 2020 2020  BBLE'):.        
-0001caa0: 2020 2020 736f 636b 6574 5f70 6174 6820      socket_path 
-0001cab0: 3d20 6f73 2e70 6174 682e 6a6f 696e 286f  = os.path.join(o
-0001cac0: 732e 6765 7465 6e76 2827 5045 4242 4c45  s.getenv('PEBBLE
-0001cad0: 2729 2c20 272e 7065 6262 6c65 2e73 6f63  '), '.pebble.soc
-0001cae0: 6b65 7427 290a 2020 2020 2020 2020 6173  ket').        as
-0001caf0: 7365 7274 2073 6f63 6b65 745f 7061 7468  sert socket_path
-0001cb00: 2c20 2750 4542 424c 4520 6f72 2050 4542  , 'PEBBLE or PEB
-0001cb10: 424c 455f 534f 434b 4554 206d 7573 7420  BLE_SOCKET must 
-0001cb20: 6265 2073 6574 2069 6620 5255 4e5f 5245  be set if RUN_RE
-0001cb30: 414c 5f50 4542 424c 455f 5445 5354 5320  AL_PEBBLE_TESTS 
-0001cb40: 7365 7427 0a0a 2020 2020 2020 2020 7365  set'..        se
-0001cb50: 6c66 2e63 6c69 656e 7420 3d20 7065 6262  lf.client = pebb
-0001cb60: 6c65 2e43 6c69 656e 7428 736f 636b 6574  le.Client(socket
-0001cb70: 5f70 6174 683d 736f 636b 6574 5f70 6174  _path=socket_pat
-0001cb80: 6829 0a0a 2020 2020 6465 6620 7465 7374  h)..    def test
-0001cb90: 5f63 6865 636b 735f 616e 645f 6865 616c  _checks_and_heal
-0001cba0: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
-0001cbb0: 2020 7365 6c66 2e63 6c69 656e 742e 6164    self.client.ad
-0001cbc0: 645f 6c61 7965 7228 276c 6179 6572 272c  d_layer('layer',
-0001cbd0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-0001cbe0: 6368 6563 6b73 273a 207b 0a20 2020 2020  checks': {.     
-0001cbf0: 2020 2020 2020 2020 2020 2027 6261 6427             'bad'
-0001cc00: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-0001cc10: 2020 2020 2020 2020 276f 7665 7272 6964          'overrid
-0001cc20: 6527 3a20 2772 6570 6c61 6365 272c 0a20  e': 'replace',. 
-0001cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc40: 2020 2027 6c65 7665 6c27 3a20 2772 6561     'level': 'rea
-0001cc50: 6479 272c 0a20 2020 2020 2020 2020 2020  dy',.           
-0001cc60: 2020 2020 2020 2020 2027 7065 7269 6f64           'period
-0001cc70: 273a 2027 3530 6d73 272c 0a20 2020 2020  ': '50ms',.     
-0001cc80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001cc90: 7468 7265 7368 6f6c 6427 3a20 322c 0a20  threshold': 2,. 
-0001cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccb0: 2020 2027 6578 6563 273a 207b 0a20 2020     'exec': {.   
-0001ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccd0: 2020 2020 2027 636f 6d6d 616e 6427 3a20       'command': 
-0001cce0: 2773 6c65 6570 2078 272c 0a20 2020 2020  'sleep x',.     
-0001ccf0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0001cd00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001cd10: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0001cd20: 2020 2020 2027 676f 6f64 273a 207b 0a20       'good': {. 
-0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd40: 2020 2027 6f76 6572 7269 6465 273a 2027     'override': '
-0001cd50: 7265 706c 6163 6527 2c0a 2020 2020 2020  replace',.      
-0001cd60: 2020 2020 2020 2020 2020 2020 2020 276c                'l
-0001cd70: 6576 656c 273a 2027 616c 6976 6527 2c0a  evel': 'alive',.
-0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd90: 2020 2020 2770 6572 696f 6427 3a20 2735      'period': '5
-0001cda0: 306d 7327 2c0a 2020 2020 2020 2020 2020  0ms',.          
-0001cdb0: 2020 2020 2020 2020 2020 2765 7865 6327            'exec'
-0001cdc0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-0001cdd0: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
-0001cde0: 6d61 6e64 273a 2027 6563 686f 2066 6f6f  mand': 'echo foo
-0001cdf0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001ce00: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0001ce10: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0001ce20: 2020 2020 2020 2020 2020 2020 2027 6f74               'ot
-0001ce30: 6865 7227 3a20 7b0a 2020 2020 2020 2020  her': {.        
-0001ce40: 2020 2020 2020 2020 2020 2020 276f 7665              'ove
-0001ce50: 7272 6964 6527 3a20 2772 6570 6c61 6365  rride': 'replace
-0001ce60: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001ce70: 2020 2020 2020 2027 6578 6563 273a 207b         'exec': {
-0001ce80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ce90: 2020 2020 2020 2020 2027 636f 6d6d 616e           'comman
-0001cea0: 6427 3a20 2765 6368 6f20 6261 7227 2c0a  d': 'echo bar',.
-0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cec0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0001ced0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0001cee0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0001cef0: 207d 2c20 636f 6d62 696e 653d 5472 7565   }, combine=True
-0001cf00: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-0001cf10: 636b 7320 7368 6f75 6c64 2061 6c6c 2062  cks should all b
-0001cf20: 6520 2275 7022 2069 6e69 7469 616c 6c79  e "up" initially
-0001cf30: 0a20 2020 2020 2020 2063 6865 636b 7320  .        checks 
-0001cf40: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
-0001cf50: 745f 6368 6563 6b73 2829 0a20 2020 2020  t_checks().     
-0001cf60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001cf70: 7561 6c28 6c65 6e28 6368 6563 6b73 292c  ual(len(checks),
-0001cf80: 2033 290a 2020 2020 2020 2020 7365 6c66   3).        self
-0001cf90: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-0001cfa0: 636b 735b 305d 2e6e 616d 652c 2027 6261  cks[0].name, 'ba
-0001cfb0: 6427 290a 2020 2020 2020 2020 7365 6c66  d').        self
-0001cfc0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-0001cfd0: 636b 735b 305d 2e6c 6576 656c 2c20 7065  cks[0].level, pe
-0001cfe0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
-0001cff0: 5245 4144 5929 0a20 2020 2020 2020 2073  READY).        s
-0001d000: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d010: 6368 6563 6b73 5b30 5d2e 7374 6174 7573  checks[0].status
-0001d020: 2c20 7065 6262 6c65 2e43 6865 636b 5374  , pebble.CheckSt
-0001d030: 6174 7573 2e55 5029 0a20 2020 2020 2020  atus.UP).       
-0001d040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d050: 6c28 6368 6563 6b73 5b31 5d2e 6e61 6d65  l(checks[1].name
-0001d060: 2c20 2767 6f6f 6427 290a 2020 2020 2020  , 'good').      
-0001d070: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001d080: 616c 2863 6865 636b 735b 315d 2e6c 6576  al(checks[1].lev
-0001d090: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
-0001d0a0: 4c65 7665 6c2e 414c 4956 4529 0a20 2020  Level.ALIVE).   
-0001d0b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d0c0: 4571 7561 6c28 6368 6563 6b73 5b31 5d2e  Equal(checks[1].
-0001d0d0: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
-0001d0e0: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
-0001d0f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001d100: 7274 4571 7561 6c28 6368 6563 6b73 5b32  rtEqual(checks[2
-0001d110: 5d2e 6e61 6d65 2c20 276f 7468 6572 2729  ].name, 'other')
-0001d120: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001d130: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-0001d140: 5b32 5d2e 6c65 7665 6c2c 2070 6562 626c  [2].level, pebbl
-0001d150: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
-0001d160: 4554 290a 2020 2020 2020 2020 7365 6c66  ET).        self
-0001d170: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-0001d180: 636b 735b 325d 2e73 7461 7475 732c 2070  cks[2].status, p
-0001d190: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-0001d1a0: 732e 5550 290a 0a20 2020 2020 2020 2023  s.UP)..        #
-0001d1b0: 2041 6e64 202f 7631 2f68 6561 6c74 6820   And /v1/health 
-0001d1c0: 7368 6f75 6c64 2072 6574 7572 6e20 2268  should return "h
-0001d1d0: 6561 6c74 6879 220a 2020 2020 2020 2020  ealthy".        
-0001d1e0: 6865 616c 7468 203d 2073 656c 662e 5f67  health = self._g
-0001d1f0: 6574 5f68 6561 6c74 6828 290a 2020 2020  et_health().    
-0001d200: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001d210: 7175 616c 2868 6561 6c74 682c 207b 0a20  qual(health, {. 
-0001d220: 2020 2020 2020 2020 2020 2027 7265 7375             'resu
-0001d230: 6c74 273a 207b 2768 6561 6c74 6879 273a  lt': {'healthy':
-0001d240: 2054 7275 657d 2c0a 2020 2020 2020 2020   True},.        
-0001d250: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
-0001d260: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
-0001d270: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
-0001d280: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-0001d290: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
-0001d2a0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-0001d2b0: 2020 2020 2320 4166 7465 7220 7477 6f20      # After two 
-0001d2c0: 7265 7472 6965 7320 7468 6520 2262 6164  retries the "bad
-0001d2d0: 2220 6368 6563 6b20 7368 6f75 6c64 2067  " check should g
-0001d2e0: 6f20 646f 776e 0a20 2020 2020 2020 2066  o down.        f
-0001d2f0: 6f72 2069 2069 6e20 7261 6e67 6528 3529  or i in range(5)
-0001d300: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
-0001d310: 6563 6b73 203d 2073 656c 662e 636c 6965  ecks = self.clie
-0001d320: 6e74 2e67 6574 5f63 6865 636b 7328 290a  nt.get_checks().
-0001d330: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
-0001d340: 6368 6563 6b20 3d20 5b63 2066 6f72 2063  check = [c for c
-0001d350: 2069 6e20 6368 6563 6b73 2069 6620 632e   in checks if c.
-0001d360: 6e61 6d65 203d 3d20 2762 6164 275d 5b30  name == 'bad'][0
-0001d370: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0001d380: 2062 6164 5f63 6865 636b 2e73 7461 7475   bad_check.statu
-0001d390: 7320 3d3d 2070 6562 626c 652e 4368 6563  s == pebble.Chec
-0001d3a0: 6b53 7461 7475 732e 444f 574e 3a0a 2020  kStatus.DOWN:.  
-0001d3b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0001d3c0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-0001d3d0: 7469 6d65 2e73 6c65 6570 2830 2e30 3629  time.sleep(0.06)
-0001d3e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001d3f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001d400: 7420 4661 6c73 652c 2027 7469 6d65 6420  t False, 'timed 
-0001d410: 6f75 7420 7761 6974 696e 6720 666f 7220  out waiting for 
-0001d420: 2262 6164 2220 6368 6563 6b20 746f 2067  "bad" check to g
-0001d430: 6f20 646f 776e 270a 2020 2020 2020 2020  o down'.        
-0001d440: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001d450: 2862 6164 5f63 6865 636b 2e66 6169 6c75  (bad_check.failu
-0001d460: 7265 732c 2032 290a 2020 2020 2020 2020  res, 2).        
-0001d470: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001d480: 2862 6164 5f63 6865 636b 2e74 6872 6573  (bad_check.thres
-0001d490: 686f 6c64 2c20 3229 0a20 2020 2020 2020  hold, 2).       
-0001d4a0: 2067 6f6f 645f 6368 6563 6b20 3d20 5b63   good_check = [c
-0001d4b0: 2066 6f72 2063 2069 6e20 6368 6563 6b73   for c in checks
-0001d4c0: 2069 6620 632e 6e61 6d65 203d 3d20 2767   if c.name == 'g
-0001d4d0: 6f6f 6427 5d5b 305d 0a20 2020 2020 2020  ood'][0].       
-0001d4e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d4f0: 6c28 676f 6f64 5f63 6865 636b 2e73 7461  l(good_check.sta
-0001d500: 7475 732c 2070 6562 626c 652e 4368 6563  tus, pebble.Chec
-0001d510: 6b53 7461 7475 732e 5550 290a 0a20 2020  kStatus.UP)..   
-0001d520: 2020 2020 2023 2041 6e64 202f 7631 2f68       # And /v1/h
-0001d530: 6561 6c74 6820 7368 6f75 6c64 2072 6574  ealth should ret
-0001d540: 7572 6e20 2275 6e68 6561 6c74 6879 2220  urn "unhealthy" 
-0001d550: 2877 6974 6820 7374 6174 7573 2048 5454  (with status HTT
-0001d560: 5020 3530 3229 0a20 2020 2020 2020 2077  P 502).        w
-0001d570: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0001d580: 6169 7365 7328 7572 6c6c 6962 2e65 7272  aises(urllib.err
-0001d590: 6f72 2e48 5454 5045 7272 6f72 2920 6173  or.HTTPError) as
-0001d5a0: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-0001d5b0: 2073 656c 662e 5f67 6574 5f68 6561 6c74   self._get_healt
-0001d5c0: 6828 290a 2020 2020 2020 2020 7365 6c66  h().        self
-0001d5d0: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-0001d5e0: 6578 6365 7074 696f 6e2e 636f 6465 2c20  exception.code, 
-0001d5f0: 3530 3229 0a20 2020 2020 2020 2068 6561  502).        hea
-0001d600: 6c74 6820 3d20 6a73 6f6e 2e6c 6f61 6473  lth = json.loads
-0001d610: 2863 6d2e 6578 6365 7074 696f 6e2e 7265  (cm.exception.re
-0001d620: 6164 2829 290a 2020 2020 2020 2020 7365  ad()).        se
-0001d630: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
-0001d640: 6561 6c74 682c 207b 0a20 2020 2020 2020  ealth, {.       
-0001d650: 2020 2020 2027 7265 7375 6c74 273a 207b       'result': {
-0001d660: 2768 6561 6c74 6879 273a 2046 616c 7365  'healthy': False
-0001d670: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
-0001d680: 7374 6174 7573 273a 2027 4261 6420 4761  status': 'Bad Ga
-0001d690: 7465 7761 7927 2c0a 2020 2020 2020 2020  teway',.        
-0001d6a0: 2020 2020 2773 7461 7475 732d 636f 6465      'status-code
-0001d6b0: 273a 2035 3032 2c0a 2020 2020 2020 2020  ': 502,.        
-0001d6c0: 2020 2020 2774 7970 6527 3a20 2773 796e      'type': 'syn
-0001d6d0: 6327 2c0a 2020 2020 2020 2020 7d29 0a0a  c',.        })..
-0001d6e0: 2020 2020 2020 2020 2320 5468 656e 2074          # Then t
-0001d6f0: 6573 7420 6669 6c74 6572 696e 6720 6279  est filtering by
-0001d700: 2063 6865 636b 206c 6576 656c 2061 6e64   check level and
-0001d710: 2062 7920 6e61 6d65 0a20 2020 2020 2020   by name.       
-0001d720: 2063 6865 636b 7320 3d20 7365 6c66 2e63   checks = self.c
-0001d730: 6c69 656e 742e 6765 745f 6368 6563 6b73  lient.get_checks
-0001d740: 286c 6576 656c 3d70 6562 626c 652e 4368  (level=pebble.Ch
-0001d750: 6563 6b4c 6576 656c 2e41 4c49 5645 290a  eckLevel.ALIVE).
-0001d760: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001d770: 6572 7445 7175 616c 286c 656e 2863 6865  ertEqual(len(che
-0001d780: 636b 7329 2c20 3129 0a20 2020 2020 2020  cks), 1).       
-0001d790: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d7a0: 6c28 6368 6563 6b73 5b30 5d2e 6e61 6d65  l(checks[0].name
-0001d7b0: 2c20 2767 6f6f 6427 290a 2020 2020 2020  , 'good').      
-0001d7c0: 2020 6368 6563 6b73 203d 2073 656c 662e    checks = self.
-0001d7d0: 636c 6965 6e74 2e67 6574 5f63 6865 636b  client.get_check
-0001d7e0: 7328 6e61 6d65 733d 5b27 676f 6f64 272c  s(names=['good',
-0001d7f0: 2027 6261 6427 5d29 0a20 2020 2020 2020   'bad']).       
-0001d800: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d810: 6c28 6c65 6e28 6368 6563 6b73 292c 2032  l(len(checks), 2
-0001d820: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001d830: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0001d840: 735b 305d 2e6e 616d 652c 2027 6261 6427  s[0].name, 'bad'
-0001d850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001d860: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0001d870: 735b 315d 2e6e 616d 652c 2027 676f 6f64  s[1].name, 'good
-0001d880: 2729 0a0a 2020 2020 6465 6620 5f67 6574  ')..    def _get
-0001d890: 5f68 6561 6c74 6828 7365 6c66 293a 0a20  _health(self):. 
-0001d8a0: 2020 2020 2020 2066 203d 2075 726c 6c69         f = urlli
-0001d8b0: 622e 7265 7175 6573 742e 7572 6c6f 7065  b.request.urlope
-0001d8c0: 6e28 2768 7474 703a 2f2f 6c6f 6361 6c68  n('http://localh
-0001d8d0: 6f73 743a 3430 3030 2f76 312f 6865 616c  ost:4000/v1/heal
-0001d8e0: 7468 2729 0a20 2020 2020 2020 2072 6574  th').        ret
-0001d8f0: 7572 6e20 6a73 6f6e 2e6c 6f61 6473 2866  urn json.loads(f
-0001d900: 2e72 6561 6428 2929 0a0a 2020 2020 6465  .read())..    de
-0001d910: 6620 7465 7374 5f65 7865 635f 7761 6974  f test_exec_wait
-0001d920: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001d930: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
-0001d940: 6c69 656e 742e 6578 6563 285b 2774 7275  lient.exec(['tru
-0001d950: 6527 5d29 0a20 2020 2020 2020 2070 726f  e']).        pro
-0001d960: 6365 7373 2e77 6169 7428 290a 0a20 2020  cess.wait()..   
-0001d970: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0001d980: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-0001d990: 6c65 2e45 7865 6345 7272 6f72 2920 6173  le.ExecError) as
-0001d9a0: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-0001d9b0: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
-0001d9c0: 636c 6965 6e74 2e65 7865 6328 5b27 2f62  client.exec(['/b
-0001d9d0: 696e 2f73 6827 2c20 272d 6327 2c20 2765  in/sh', '-c', 'e
-0001d9e0: 7869 7420 3432 275d 290a 2020 2020 2020  xit 42']).      
-0001d9f0: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
-0001da00: 6974 2829 0a20 2020 2020 2020 2073 656c  it().        sel
-0001da10: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-0001da20: 2e65 7863 6570 7469 6f6e 2e65 7869 745f  .exception.exit_
-0001da30: 636f 6465 2c20 3432 290a 0a20 2020 2064  code, 42)..    d
-0001da40: 6566 2074 6573 745f 6578 6563 5f77 6169  ef test_exec_wai
-0001da50: 745f 6f75 7470 7574 2873 656c 6629 3a0a  t_output(self):.
-0001da60: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
-0001da70: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
-0001da80: 6563 285b 272f 6269 6e2f 7368 272c 2027  ec(['/bin/sh', '
-0001da90: 2d63 272c 2027 6563 686f 204f 5554 3b20  -c', 'echo OUT; 
-0001daa0: 6563 686f 2045 5252 203e 2632 275d 290a  echo ERR >&2']).
-0001dab0: 2020 2020 2020 2020 6f75 742c 2065 7272          out, err
-0001dac0: 203d 2070 726f 6365 7373 2e77 6169 745f   = process.wait_
-0001dad0: 6f75 7470 7574 2829 0a20 2020 2020 2020  output().       
-0001dae0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001daf0: 6c28 6f75 742c 2027 4f55 545c 6e27 290a  l(out, 'OUT\n').
-0001db00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001db10: 6572 7445 7175 616c 2865 7272 2c20 2745  ertEqual(err, 'E
-0001db20: 5252 5c6e 2729 0a0a 2020 2020 2020 2020  RR\n')..        
-0001db30: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
-0001db40: 6c69 656e 742e 6578 6563 285b 272f 6269  lient.exec(['/bi
-0001db50: 6e2f 7368 272c 2027 2d63 272c 2027 6563  n/sh', '-c', 'ec
-0001db60: 686f 204f 5554 3b20 6563 686f 2045 5252  ho OUT; echo ERR
-0001db70: 203e 2632 275d 2c20 656e 636f 6469 6e67   >&2'], encoding
-0001db80: 3d4e 6f6e 6529 0a20 2020 2020 2020 206f  =None).        o
-0001db90: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-0001dba0: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-0001dbb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001dbc0: 6572 7445 7175 616c 286f 7574 2c20 6227  ertEqual(out, b'
-0001dbd0: 4f55 545c 6e27 290a 2020 2020 2020 2020  OUT\n').        
-0001dbe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001dbf0: 2865 7272 2c20 6227 4552 525c 6e27 290a  (err, b'ERR\n').
-0001dc00: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0001dc10: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0001dc20: 7065 6262 6c65 2e45 7865 6345 7272 6f72  pebble.ExecError
-0001dc30: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-0001dc40: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-0001dc50: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-0001dc60: 5b27 2f62 696e 2f73 6827 2c20 272d 6327  ['/bin/sh', '-c'
-0001dc70: 2c20 2765 6368 6f20 4f55 543b 2065 6368  , 'echo OUT; ech
-0001dc80: 6f20 4552 5220 3e26 323b 2065 7869 7420  o ERR >&2; exit 
-0001dc90: 3432 275d 290a 2020 2020 2020 2020 2020  42']).          
-0001dca0: 2020 7072 6f63 6573 732e 7761 6974 5f6f    process.wait_o
-0001dcb0: 7574 7075 7428 290a 2020 2020 2020 2020  utput().        
-0001dcc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001dcd0: 2863 6d2e 6578 6365 7074 696f 6e2e 6578  (cm.exception.ex
-0001dce0: 6974 5f63 6f64 652c 2034 3229 0a20 2020  it_code, 42).   
-0001dcf0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001dd00: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
-0001dd10: 6f6e 2e73 7464 6f75 742c 2027 4f55 545c  on.stdout, 'OUT\
-0001dd20: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
-0001dd30: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-0001dd40: 6578 6365 7074 696f 6e2e 7374 6465 7272  exception.stderr
-0001dd50: 2c20 2745 5252 5c6e 2729 0a0a 2020 2020  , 'ERR\n')..    
-0001dd60: 6465 6620 7465 7374 5f65 7865 635f 7365  def test_exec_se
-0001dd70: 6e64 5f73 7464 696e 2873 656c 6629 3a0a  nd_stdin(self):.
-0001dd80: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
-0001dd90: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
-0001dda0: 6563 285b 2761 776b 272c 2027 7b20 7072  ec(['awk', '{ pr
-0001ddb0: 696e 7420 746f 7570 7065 7228 2430 2920  int toupper($0) 
-0001ddc0: 7d27 5d2c 2073 7464 696e 3d27 666f 6f5c  }'], stdin='foo\
-0001ddd0: 6e42 6172 5c6e 2729 0a20 2020 2020 2020  nBar\n').       
-0001dde0: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
-0001ddf0: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
-0001de00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001de10: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
-0001de20: 2746 4f4f 5c6e 4241 525c 6e27 290a 2020  'FOO\nBAR\n').  
-0001de30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001de40: 7445 7175 616c 2865 7272 2c20 2727 290a  tEqual(err, '').
-0001de50: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001de60: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-0001de70: 7865 6328 5b27 6177 6b27 2c20 277b 2070  xec(['awk', '{ p
-0001de80: 7269 6e74 2074 6f75 7070 6572 2824 3029  rint toupper($0)
-0001de90: 207d 275d 2c20 7374 6469 6e3d 6227 666f   }'], stdin=b'fo
-0001dea0: 6f5c 6e42 6172 5c6e 272c 0a20 2020 2020  o\nBar\n',.     
-0001deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dec0: 2020 2020 2020 2020 2020 2020 2020 656e                en
-0001ded0: 636f 6469 6e67 3d4e 6f6e 6529 0a20 2020  coding=None).   
-0001dee0: 2020 2020 206f 7574 2c20 6572 7220 3d20       out, err = 
-0001def0: 7072 6f63 6573 732e 7761 6974 5f6f 7574  process.wait_out
-0001df00: 7075 7428 290a 2020 2020 2020 2020 7365  put().        se
-0001df10: 6c66 2e61 7373 6572 7445 7175 616c 286f  lf.assertEqual(o
-0001df20: 7574 2c20 6227 464f 4f5c 6e42 4152 5c6e  ut, b'FOO\nBAR\n
-0001df30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001df40: 6173 7365 7274 4571 7561 6c28 6572 722c  assertEqual(err,
-0001df50: 2062 2727 290a 0a20 2020 2064 6566 2074   b'')..    def t
-0001df60: 6573 745f 7075 7368 5f70 756c 6c28 7365  est_push_pull(se
-0001df70: 6c66 293a 0a20 2020 2020 2020 2066 6e61  lf):.        fna
-0001df80: 6d65 203d 206f 732e 7061 7468 2e6a 6f69  me = os.path.joi
-0001df90: 6e28 7465 6d70 6669 6c65 2e67 6574 7465  n(tempfile.gette
-0001dfa0: 6d70 6469 7228 292c 2066 2770 6562 626c  mpdir(), f'pebbl
-0001dfb0: 6574 6573 742d 7b75 7569 642e 7575 6964  etest-{uuid.uuid
-0001dfc0: 3428 297d 2729 0a20 2020 2020 2020 2063  4()}').        c
-0001dfd0: 6f6e 7465 6e74 203d 2027 666f 6f5c 6e62  ontent = 'foo\nb
-0001dfe0: 6172 5c6e 6261 7a2d 3432 270a 2020 2020  ar\nbaz-42'.    
-0001dff0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0001e000: 7075 7368 2866 6e61 6d65 2c20 636f 6e74  push(fname, cont
-0001e010: 656e 7429 0a20 2020 2020 2020 2077 6974  ent).        wit
-0001e020: 6820 7365 6c66 2e63 6c69 656e 742e 7075  h self.client.pu
-0001e030: 6c6c 2866 6e61 6d65 2920 6173 2066 3a0a  ll(fname) as f:.
-0001e040: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001e050: 203d 2066 2e72 6561 6428 290a 2020 2020   = f.read().    
+00017770: 2020 2020 2020 2063 6f6d 6269 6e65 5f73         combine_s
+00017780: 7464 6572 723d 5472 7565 290a 0a20 2020  tderr=True)..   
+00017790: 2064 6566 2074 6573 745f 6e6f 5f77 6169   def test_no_wai
+000177a0: 745f 6361 6c6c 2873 656c 6629 3a0a 2020  t_call(self):.  
+000177b0: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+000177c0: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
+000177d0: 3029 0a20 2020 2020 2020 2077 6974 6820  0).        with 
+000177e0: 7365 6c66 2e61 7373 6572 7457 6172 6e73  self.assertWarns
+000177f0: 2852 6573 6f75 7263 6557 6172 6e69 6e67  (ResourceWarning
+00017800: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00017810: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+00017820: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+00017830: 5b27 7472 7565 275d 290a 2020 2020 2020  ['true']).      
+00017840: 2020 2020 2020 6465 6c20 7072 6f63 6573        del proces
+00017850: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
+00017860: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
+00017870: 6d2e 7761 726e 696e 6729 2c20 2745 7865  m.warning), 'Exe
+00017880: 6350 726f 6365 7373 2069 6e73 7461 6e63  cProcess instanc
+00017890: 6520 6761 7262 6167 6520 636f 6c6c 6563  e garbage collec
+000178a0: 7465 6420 270a 2020 2020 2020 2020 2020  ted '.          
+000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178d0: 2b20 2777 6974 686f 7574 2063 616c 6c20  + 'without call 
+000178e0: 746f 2077 6169 7428 2920 6f72 2077 6169  to wait() or wai
+000178f0: 745f 6f75 7470 7574 2829 2729 0a0a 2020  t_output()')..  
+00017900: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
+00017910: 6578 6974 5f7a 6572 6f28 7365 6c66 293a  exit_zero(self):
+00017920: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00017930: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
+00017940: 272c 2030 290a 0a20 2020 2020 2020 2070  ', 0)..        p
+00017950: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+00017960: 6965 6e74 2e65 7865 6328 5b27 7472 7565  ient.exec(['true
+00017970: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+00017980: 2e61 7373 6572 7449 734e 6f74 4e6f 6e65  .assertIsNotNone
+00017990: 2870 726f 6365 7373 2e73 7464 6f75 7429  (process.stdout)
+000179a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000179b0: 7365 7274 4973 4e6f 744e 6f6e 6528 7072  sertIsNotNone(pr
+000179c0: 6f63 6573 732e 7374 6465 7272 290a 2020  ocess.stderr).  
+000179d0: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
+000179e0: 6974 2829 0a0a 2020 2020 2020 2020 7365  it()..        se
+000179f0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00017a00: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00017a10: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00017a20: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+00017a30: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
+00017a40: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
+00017a50: 7461 285b 2774 7275 6527 5d29 292c 0a20  ta(['true'])),. 
+00017a60: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+00017a70: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
+00017a80: 3132 332f 7761 6974 272c 207b 2774 696d  123/wait', {'tim
+00017a90: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
+00017aa0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+00017ab0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00017ac0: 745f 7761 6974 5f65 7869 745f 6e6f 6e7a  t_wait_exit_nonz
+00017ad0: 6572 6f28 7365 6c66 293a 0a20 2020 2020  ero(self):.     
+00017ae0: 2020 2073 656c 662e 6164 645f 7265 7370     self.add_resp
+00017af0: 6f6e 7365 7328 2734 3536 272c 2031 290a  onses('456', 1).
+00017b00: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00017b10: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+00017b20: 7865 6328 5b27 6661 6c73 6527 5d29 0a20  xec(['false']). 
+00017b30: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00017b40: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00017b50: 6262 6c65 2e45 7865 6345 7272 6f72 2920  bble.ExecError) 
+00017b60: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+00017b70: 2020 2070 726f 6365 7373 2e77 6169 7428     process.wait(
+00017b80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00017b90: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00017ba0: 6365 7074 696f 6e2e 636f 6d6d 616e 642c  ception.command,
+00017bb0: 205b 2766 616c 7365 275d 290a 2020 2020   ['false']).    
+00017bc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00017bd0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00017be0: 6e2e 6578 6974 5f63 6f64 652c 2031 290a  n.exit_code, 1).
+00017bf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00017c00: 6572 7445 7175 616c 2863 6d2e 6578 6365  ertEqual(cm.exce
+00017c10: 7074 696f 6e2e 7374 646f 7574 2c20 4e6f  ption.stdout, No
+00017c20: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
+00017c30: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
+00017c40: 6578 6365 7074 696f 6e2e 7374 6465 7272  exception.stderr
+00017c50: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
+00017c60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00017c70: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+00017c80: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+00017c90: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
+00017ca0: 2f76 312f 6578 6563 272c 204e 6f6e 652c  /v1/exec', None,
+00017cb0: 2073 656c 662e 6275 696c 645f 6578 6563   self.build_exec
+00017cc0: 5f64 6174 6128 5b27 6661 6c73 6527 5d29  _data(['false'])
+00017cd0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00017ce0: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+00017cf0: 6765 732f 3435 362f 7761 6974 272c 207b  ges/456/wait', {
+00017d00: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
+00017d10: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
+00017d20: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+00017d30: 2074 6573 745f 7761 6974 5f74 696d 656f   test_wait_timeo
+00017d40: 7574 2873 656c 6629 3a0a 2020 2020 2020  ut(self):.      
+00017d50: 2020 7365 6c66 2e61 6464 5f72 6573 706f    self.add_respo
+00017d60: 6e73 6573 2827 3132 3327 2c20 3029 0a0a  nses('123', 0)..
+00017d70: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+00017d80: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
+00017d90: 6563 285b 2774 7275 6527 5d2c 2074 696d  ec(['true'], tim
+00017da0: 656f 7574 3d32 290a 2020 2020 2020 2020  eout=2).        
+00017db0: 7072 6f63 6573 732e 7761 6974 2829 0a0a  process.wait()..
+00017dc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00017dd0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+00017de0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+00017df0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+00017e00: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
+00017e10: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
+00017e20: 6c64 5f65 7865 635f 6461 7461 285b 2774  ld_exec_data(['t
+00017e30: 7275 6527 5d2c 2074 696d 656f 7574 3d32  rue'], timeout=2
+00017e40: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00017e50: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+00017e60: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
+00017e70: 7b27 7469 6d65 6f75 7427 3a20 2733 2e30  {'timeout': '3.0
+00017e80: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
+00017e90: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+00017ea0: 6620 7465 7374 5f77 6169 745f 6f74 6865  f test_wait_othe
+00017eb0: 725f 6172 6773 2873 656c 6629 3a0a 2020  r_args(self):.  
+00017ec0: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+00017ed0: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
+00017ee0: 3029 0a0a 2020 2020 2020 2020 7072 6f63  0)..        proc
+00017ef0: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
+00017f00: 742e 6578 6563 280a 2020 2020 2020 2020  t.exec(.        
+00017f10: 2020 2020 5b27 7472 7565 275d 2c0a 2020      ['true'],.  
+00017f20: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
+00017f30: 6e6d 656e 743d 7b27 4b31 273a 2027 5631  nment={'K1': 'V1
+00017f40: 272c 2027 4b32 273a 2027 5632 277d 2c0a  ', 'K2': 'V2'},.
+00017f50: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00017f60: 696e 675f 6469 723d 2757 4427 2c0a 2020  ing_dir='WD',.  
+00017f70: 2020 2020 2020 2020 2020 7573 6572 5f69            user_i
+00017f80: 643d 3130 3030 2c0a 2020 2020 2020 2020  d=1000,.        
+00017f90: 2020 2020 7573 6572 3d27 626f 6227 2c0a      user='bob',.
+00017fa0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00017fb0: 705f 6964 3d31 3030 302c 0a20 2020 2020  p_id=1000,.     
+00017fc0: 2020 2020 2020 2067 726f 7570 3d27 7374         group='st
+00017fd0: 6166 6627 2c0a 2020 2020 2020 2020 290a  aff',.        ).
+00017fe0: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
+00017ff0: 7761 6974 2829 0a0a 2020 2020 2020 2020  wait()..        
+00018000: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018010: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+00018020: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+00018030: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+00018040: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
+00018050: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
+00018060: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
+00018070: 2020 2020 2020 636f 6d6d 616e 643d 5b27        command=['
+00018080: 7472 7565 275d 2c0a 2020 2020 2020 2020  true'],.        
+00018090: 2020 2020 2020 2020 656e 7669 726f 6e6d          environm
+000180a0: 656e 743d 7b27 4b31 273a 2027 5631 272c  ent={'K1': 'V1',
+000180b0: 2027 4b32 273a 2027 5632 277d 2c0a 2020   'K2': 'V2'},.  
+000180c0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+000180d0: 726b 696e 675f 6469 723d 2757 4427 2c0a  rking_dir='WD',.
+000180e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180f0: 7573 6572 5f69 643d 3130 3030 2c0a 2020  user_id=1000,.  
+00018100: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00018110: 6572 3d27 626f 6227 2c0a 2020 2020 2020  er='bob',.      
+00018120: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+00018130: 6964 3d31 3030 302c 0a20 2020 2020 2020  id=1000,.       
+00018140: 2020 2020 2020 2020 2067 726f 7570 3d27           group='
+00018150: 7374 6166 6627 2c0a 2020 2020 2020 2020  staff',.        
+00018160: 2020 2020 2929 2c0a 2020 2020 2020 2020      )),.        
+00018170: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+00018180: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
+00018190: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
+000181a0: 2734 2e30 3030 7327 7d2c 204e 6f6e 6529  '4.000s'}, None)
+000181b0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+000181c0: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
+000181d0: 6368 616e 6765 5f65 7272 6f72 2873 656c  change_error(sel
+000181e0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+000181f0: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
+00018200: 3132 3327 2c20 302c 2063 6861 6e67 655f  123', 0, change_
+00018210: 6572 723d 2763 6861 6e67 6520 6572 726f  err='change erro
+00018220: 7221 2729 0a0a 2020 2020 2020 2020 7072  r!')..        pr
+00018230: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
+00018240: 656e 742e 6578 6563 285b 2774 7275 6527  ent.exec(['true'
+00018250: 5d29 0a20 2020 2020 2020 2077 6974 6820  ]).        with 
+00018260: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00018270: 7328 7065 6262 6c65 2e43 6861 6e67 6545  s(pebble.ChangeE
+00018280: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+00018290: 2020 2020 2020 2020 2070 726f 6365 7373           process
+000182a0: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
+000182b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000182c0: 2863 6d2e 6578 6365 7074 696f 6e2e 6572  (cm.exception.er
+000182d0: 722c 2027 6368 616e 6765 2065 7272 6f72  r, 'change error
+000182e0: 2127 290a 2020 2020 2020 2020 7365 6c66  !').        self
+000182f0: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
+00018300: 6578 6365 7074 696f 6e2e 6368 616e 6765  exception.change
+00018310: 2e69 642c 2027 3132 3327 290a 0a20 2020  .id, '123')..   
+00018320: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018330: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+00018340: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+00018350: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+00018360: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
+00018370: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
+00018380: 6578 6563 5f64 6174 6128 5b27 7472 7565  exec_data(['true
+00018390: 275d 2929 2c0a 2020 2020 2020 2020 2020  '])),.          
+000183a0: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
+000183b0: 6861 6e67 6573 2f31 3233 2f77 6169 7427  hanges/123/wait'
+000183c0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
+000183d0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
+000183e0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+000183f0: 6465 6620 7465 7374 5f73 656e 645f 7369  def test_send_si
+00018400: 676e 616c 2873 656c 6629 3a0a 2020 2020  gnal(self):.    
+00018410: 2020 2020 5f2c 205f 2c20 636f 6e74 726f      _, _, contro
+00018420: 6c20 3d20 7365 6c66 2e61 6464 5f72 6573  l = self.add_res
+00018430: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
+00018440: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+00018450: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+00018460: 6578 6563 285b 2773 6572 7665 7227 5d29  exec(['server'])
+00018470: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00018480: 2e73 656e 645f 7369 676e 616c 2827 5349  .send_signal('SI
+00018490: 4748 5550 2729 0a20 2020 2020 2020 206e  GHUP').        n
+000184a0: 756d 5f73 656e 6473 203d 2031 0a20 2020  um_sends = 1.   
+000184b0: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+000184c0: 7369 676e 616c 2c20 2753 4947 4855 5027  signal, 'SIGHUP'
+000184d0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+000184e0: 726f 6365 7373 2e73 656e 645f 7369 676e  rocess.send_sign
+000184f0: 616c 2831 290a 2020 2020 2020 2020 2020  al(1).          
+00018500: 2020 7072 6f63 6573 732e 7365 6e64 5f73    process.send_s
+00018510: 6967 6e61 6c28 7369 676e 616c 2e53 4947  ignal(signal.SIG
+00018520: 4855 5029 0a20 2020 2020 2020 2020 2020  HUP).           
+00018530: 206e 756d 5f73 656e 6473 202b 3d20 320a   num_sends += 2.
+00018540: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00018550: 2e77 6169 7428 290a 0a20 2020 2020 2020  .wait()..       
+00018560: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00018570: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+00018580: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+00018590: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
+000185a0: 2f76 312f 6578 6563 272c 204e 6f6e 652c  /v1/exec', None,
+000185b0: 2073 656c 662e 6275 696c 645f 6578 6563   self.build_exec
+000185c0: 5f64 6174 6128 5b27 7365 7276 6572 275d  _data(['server']
+000185d0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+000185e0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+000185f0: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
+00018600: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
+00018610: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
+00018620: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
+00018630: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00018640: 616c 286c 656e 2863 6f6e 7472 6f6c 2e73  al(len(control.s
+00018650: 656e 6473 292c 206e 756d 5f73 656e 6473  ends), num_sends
+00018660: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00018670: 7373 6572 7445 7175 616c 2863 6f6e 7472  ssertEqual(contr
+00018680: 6f6c 2e73 656e 6473 5b30 5d5b 305d 2c20  ol.sends[0][0], 
+00018690: 2754 5854 2729 0a20 2020 2020 2020 2073  'TXT').        s
+000186a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000186b0: 6a73 6f6e 2e6c 6f61 6473 2863 6f6e 7472  json.loads(contr
+000186c0: 6f6c 2e73 656e 6473 5b30 5d5b 315d 292c  ol.sends[0][1]),
+000186d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000186e0: 2020 2020 2020 2020 2020 7b27 636f 6d6d            {'comm
+000186f0: 616e 6427 3a20 2773 6967 6e61 6c27 2c20  and': 'signal', 
+00018700: 2773 6967 6e61 6c27 3a20 7b27 6e61 6d65  'signal': {'name
+00018710: 273a 2027 5349 4748 5550 277d 7d29 0a20  ': 'SIGHUP'}}). 
+00018720: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+00018730: 7228 7369 676e 616c 2c20 2753 4947 4855  r(signal, 'SIGHU
+00018740: 5027 293a 0a20 2020 2020 2020 2020 2020  P'):.           
+00018750: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00018760: 6c28 636f 6e74 726f 6c2e 7365 6e64 735b  l(control.sends[
+00018770: 315d 5b30 5d2c 2027 5458 5427 290a 2020  1][0], 'TXT').  
+00018780: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00018790: 7373 6572 7445 7175 616c 286a 736f 6e2e  ssertEqual(json.
+000187a0: 6c6f 6164 7328 636f 6e74 726f 6c2e 7365  loads(control.se
+000187b0: 6e64 735b 315d 5b31 5d29 2c0a 2020 2020  nds[1][1]),.    
+000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187d0: 2020 2020 2020 2020 207b 2763 6f6d 6d61           {'comma
+000187e0: 6e64 273a 2027 7369 676e 616c 272c 2027  nd': 'signal', '
+000187f0: 7369 676e 616c 273a 207b 276e 616d 6527  signal': {'name'
+00018800: 3a20 7369 676e 616c 2e53 6967 6e61 6c73  : signal.Signals
+00018810: 2831 292e 6e61 6d65 7d7d 290a 2020 2020  (1).name}}).    
+00018820: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018830: 6572 7445 7175 616c 2863 6f6e 7472 6f6c  ertEqual(control
+00018840: 2e73 656e 6473 5b32 5d5b 305d 2c20 2754  .sends[2][0], 'T
+00018850: 5854 2729 0a20 2020 2020 2020 2020 2020  XT').           
+00018860: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00018870: 6c28 6a73 6f6e 2e6c 6f61 6473 2863 6f6e  l(json.loads(con
+00018880: 7472 6f6c 2e73 656e 6473 5b32 5d5b 315d  trol.sends[2][1]
+00018890: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188b0: 7b27 636f 6d6d 616e 6427 3a20 2773 6967  {'command': 'sig
+000188c0: 6e61 6c27 2c20 2773 6967 6e61 6c27 3a20  nal', 'signal': 
+000188d0: 7b27 6e61 6d65 273a 2027 5349 4748 5550  {'name': 'SIGHUP
+000188e0: 277d 7d29 0a0a 2020 2020 6465 6620 7465  '}})..    def te
+000188f0: 7374 5f77 6169 745f 6f75 7470 7574 2873  st_wait_output(s
+00018900: 656c 6629 3a0a 2020 2020 2020 2020 7374  elf):.        st
+00018910: 6469 6f2c 2073 7464 6572 722c 205f 203d  dio, stderr, _ =
+00018920: 2073 656c 662e 6164 645f 7265 7370 6f6e   self.add_respon
+00018930: 7365 7328 2731 3233 272c 2030 290a 2020  ses('123', 0).  
+00018940: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
+00018950: 6976 6573 2e61 7070 656e 6428 6227 5079  ives.append(b'Py
+00018960: 7468 6f6e 2033 2e38 2e31 305c 6e27 290a  thon 3.8.10\n').
+00018970: 2020 2020 2020 2020 7374 6469 6f2e 7265          stdio.re
+00018980: 6365 6976 6573 2e61 7070 656e 6428 277b  ceives.append('{
+00018990: 2263 6f6d 6d61 6e64 223a 2265 6e64 227d  "command":"end"}
+000189a0: 2729 0a20 2020 2020 2020 2073 7464 6572  ').        stder
+000189b0: 722e 7265 6365 6976 6573 2e61 7070 656e  r.receives.appen
+000189c0: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
+000189d0: 6e64 227d 2729 0a0a 2020 2020 2020 2020  nd"}')..        
+000189e0: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
+000189f0: 6c69 656e 742e 6578 6563 285b 2770 7974  lient.exec(['pyt
+00018a00: 686f 6e33 272c 2027 2d2d 7665 7273 696f  hon3', '--versio
+00018a10: 6e27 5d29 0a20 2020 2020 2020 206f 7574  n']).        out
+00018a20: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
+00018a30: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
+00018a40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00018a50: 7445 7175 616c 286f 7574 2c20 2750 7974  tEqual(out, 'Pyt
+00018a60: 686f 6e20 332e 382e 3130 5c6e 2729 0a20  hon 3.8.10\n'). 
+00018a70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018a80: 7274 4571 7561 6c28 6572 722c 2027 2729  rtEqual(err, '')
+00018a90: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00018aa0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00018ab0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+00018ac0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00018ad0: 2750 4f53 5427 2c20 272f 7631 2f65 7865  'POST', '/v1/exe
+00018ae0: 6327 2c20 4e6f 6e65 2c20 7365 6c66 2e62  c', None, self.b
+00018af0: 7569 6c64 5f65 7865 635f 6461 7461 285b  uild_exec_data([
+00018b00: 2770 7974 686f 6e33 272c 2027 2d2d 7665  'python3', '--ve
+00018b10: 7273 696f 6e27 5d29 292c 0a20 2020 2020  rsion'])),.     
+00018b20: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+00018b30: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
+00018b40: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
+00018b50: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
+00018b60: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+00018b70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018b80: 6572 7445 7175 616c 2873 7464 696f 2e73  ertEqual(stdio.s
+00018b90: 656e 6473 2c20 5b5d 290a 0a20 2020 2064  ends, [])..    d
+00018ba0: 6566 2074 6573 745f 7761 6974 5f6f 7574  ef test_wait_out
+00018bb0: 7075 745f 636f 6d62 696e 655f 7374 6465  put_combine_stde
+00018bc0: 7272 2873 656c 6629 3a0a 2020 2020 2020  rr(self):.      
+00018bd0: 2020 7374 6469 6f2c 205f 2c20 5f20 3d20    stdio, _, _ = 
+00018be0: 7365 6c66 2e61 6464 5f72 6573 706f 6e73  self.add_respons
+00018bf0: 6573 2827 3132 3327 2c20 3029 0a20 2020  es('123', 0).   
+00018c00: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
+00018c10: 7665 732e 6170 7065 6e64 2862 2769 6e76  ves.append(b'inv
+00018c20: 616c 6964 2074 696d 6520 696e 7465 7276  alid time interv
+00018c30: 616c 5c6e 2729 0a20 2020 2020 2020 2073  al\n').        s
+00018c40: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
+00018c50: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
+00018c60: 3a22 656e 6422 7d27 290a 0a20 2020 2020  :"end"}')..     
+00018c70: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
+00018c80: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
+00018c90: 736c 6565 7027 2c20 2778 275d 2c20 636f  sleep', 'x'], co
+00018ca0: 6d62 696e 655f 7374 6465 7272 3d54 7275  mbine_stderr=Tru
+00018cb0: 6529 0a20 2020 2020 2020 206f 7574 2c20  e).        out, 
+00018cc0: 6572 7220 3d20 7072 6f63 6573 732e 7761  err = process.wa
+00018cd0: 6974 5f6f 7574 7075 7428 290a 2020 2020  it_output().    
+00018ce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00018cf0: 7175 616c 286f 7574 2c20 2769 6e76 616c  qual(out, 'inval
+00018d00: 6964 2074 696d 6520 696e 7465 7276 616c  id time interval
+00018d10: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
+00018d20: 662e 6173 7365 7274 4973 4e6f 6e65 2865  f.assertIsNone(e
+00018d30: 7272 290a 2020 2020 2020 2020 7365 6c66  rr).        self
+00018d40: 2e61 7373 6572 7449 734e 6f6e 6528 7072  .assertIsNone(pr
+00018d50: 6f63 6573 732e 7374 6465 7272 290a 0a20  ocess.stderr).. 
+00018d60: 2020 2020 2020 2065 7865 635f 6461 7461         exec_data
+00018d70: 203d 2073 656c 662e 6275 696c 645f 6578   = self.build_ex
+00018d80: 6563 5f64 6174 6128 5b27 736c 6565 7027  ec_data(['sleep'
+00018d90: 2c20 2778 275d 2c20 636f 6d62 696e 655f  , 'x'], combine_
+00018da0: 7374 6465 7272 3d54 7275 6529 0a20 2020  stderr=True).   
+00018db0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018dc0: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+00018dd0: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+00018de0: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+00018df0: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
+00018e00: 6f6e 652c 2065 7865 635f 6461 7461 292c  one, exec_data),
+00018e10: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00018e20: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
+00018e30: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
+00018e40: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
+00018e50: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+00018e60: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00018e70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00018e80: 7464 696f 2e73 656e 6473 2c20 5b5d 290a  tdio.sends, []).
+00018e90: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
+00018ea0: 6974 5f6f 7574 7075 745f 6279 7465 7328  it_output_bytes(
+00018eb0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00018ec0: 7464 696f 2c20 7374 6465 7272 2c20 5f20  tdio, stderr, _ 
+00018ed0: 3d20 7365 6c66 2e61 6464 5f72 6573 706f  = self.add_respo
+00018ee0: 6e73 6573 2827 3132 3327 2c20 3029 0a20  nses('123', 0). 
+00018ef0: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
+00018f00: 6569 7665 732e 6170 7065 6e64 2862 2750  eives.append(b'P
+00018f10: 7974 686f 6e20 332e 382e 3130 5c6e 2729  ython 3.8.10\n')
+00018f20: 0a20 2020 2020 2020 2073 7464 696f 2e72  .        stdio.r
+00018f30: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
+00018f40: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
+00018f50: 7d27 290a 2020 2020 2020 2020 7374 6465  }').        stde
+00018f60: 7272 2e72 6563 6569 7665 732e 6170 7065  rr.receives.appe
+00018f70: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
+00018f80: 656e 6422 7d27 290a 0a20 2020 2020 2020  end"}')..       
+00018f90: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
+00018fa0: 636c 6965 6e74 2e65 7865 6328 5b27 7079  client.exec(['py
+00018fb0: 7468 6f6e 3327 2c20 272d 2d76 6572 7369  thon3', '--versi
+00018fc0: 6f6e 275d 2c20 656e 636f 6469 6e67 3d4e  on'], encoding=N
+00018fd0: 6f6e 6529 0a20 2020 2020 2020 206f 7574  one).        out
+00018fe0: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
+00018ff0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
+00019000: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00019010: 7445 7175 616c 286f 7574 2c20 6227 5079  tEqual(out, b'Py
+00019020: 7468 6f6e 2033 2e38 2e31 305c 6e27 290a  thon 3.8.10\n').
+00019030: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019040: 6572 7445 7175 616c 2865 7272 2c20 6227  ertEqual(err, b'
+00019050: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+00019060: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00019070: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
+00019080: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00019090: 2028 2750 4f53 5427 2c20 272f 7631 2f65   ('POST', '/v1/e
+000190a0: 7865 6327 2c20 4e6f 6e65 2c20 7365 6c66  xec', None, self
+000190b0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
+000190c0: 285b 2770 7974 686f 6e33 272c 2027 2d2d  (['python3', '--
+000190d0: 7665 7273 696f 6e27 5d29 292c 0a20 2020  version'])),.   
+000190e0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+000190f0: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
+00019100: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
+00019110: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
+00019120: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+00019130: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00019140: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
+00019150: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
+00019160: 2064 6566 2074 6573 745f 7761 6974 5f6f   def test_wait_o
+00019170: 7574 7075 745f 6578 6974 5f6e 6f6e 7a65  utput_exit_nonze
+00019180: 726f 2873 656c 6629 3a0a 2020 2020 2020  ro(self):.      
+00019190: 2020 7374 6469 6f2c 2073 7464 6572 722c    stdio, stderr,
+000191a0: 205f 203d 2073 656c 662e 6164 645f 7265   _ = self.add_re
+000191b0: 7370 6f6e 7365 7328 2731 3233 272c 2030  sponses('123', 0
+000191c0: 290a 2020 2020 2020 2020 7374 6469 6f2e  ).        stdio.
+000191d0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+000191e0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+000191f0: 227d 2729 0a20 2020 2020 2020 2073 7464  "}').        std
+00019200: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
+00019210: 656e 6428 6227 6669 6c65 206e 6f74 2066  end(b'file not f
+00019220: 6f75 6e64 3a20 785c 6e27 290a 2020 2020  ound: x\n').    
+00019230: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+00019240: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+00019250: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+00019260: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00019270: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+00019280: 7865 6328 5b27 6c73 272c 2027 7827 5d29  xec(['ls', 'x'])
+00019290: 0a20 2020 2020 2020 206f 7574 2c20 6572  .        out, er
+000192a0: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+000192b0: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+000192c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000192d0: 616c 286f 7574 2c20 2727 290a 2020 2020  al(out, '').    
+000192e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000192f0: 7175 616c 2865 7272 2c20 2766 696c 6520  qual(err, 'file 
+00019300: 6e6f 7420 666f 756e 643a 2078 5c6e 2729  not found: x\n')
+00019310: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00019320: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00019330: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+00019340: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00019350: 2750 4f53 5427 2c20 272f 7631 2f65 7865  'POST', '/v1/exe
+00019360: 6327 2c20 4e6f 6e65 2c20 7365 6c66 2e62  c', None, self.b
+00019370: 7569 6c64 5f65 7865 635f 6461 7461 285b  uild_exec_data([
+00019380: 276c 7327 2c20 2778 275d 2929 2c0a 2020  'ls', 'x'])),.  
+00019390: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+000193a0: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
+000193b0: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
+000193c0: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+000193d0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+000193e0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+000193f0: 6173 7365 7274 4571 7561 6c28 7374 6469  assertEqual(stdi
+00019400: 6f2e 7365 6e64 732c 205b 5d29 0a0a 2020  o.sends, [])..  
+00019410: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
+00019420: 6f75 7470 7574 5f65 7869 745f 6e6f 6e7a  output_exit_nonz
+00019430: 6572 6f5f 636f 6d62 696e 655f 7374 6465  ero_combine_stde
+00019440: 7272 2873 656c 6629 3a0a 2020 2020 2020  rr(self):.      
+00019450: 2020 7374 6469 6f2c 205f 2c20 5f20 3d20    stdio, _, _ = 
+00019460: 7365 6c66 2e61 6464 5f72 6573 706f 6e73  self.add_respons
+00019470: 6573 2827 3132 3327 2c20 3029 0a20 2020  es('123', 0).   
+00019480: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
+00019490: 7665 732e 6170 7065 6e64 2862 2766 696c  ves.append(b'fil
+000194a0: 6520 6e6f 7420 666f 756e 643a 2078 5c6e  e not found: x\n
+000194b0: 2729 0a20 2020 2020 2020 2073 7464 696f  ').        stdio
+000194c0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+000194d0: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+000194e0: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
+000194f0: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+00019500: 6965 6e74 2e65 7865 6328 5b27 6c73 272c  ient.exec(['ls',
+00019510: 2027 7827 5d2c 2063 6f6d 6269 6e65 5f73   'x'], combine_s
+00019520: 7464 6572 723d 5472 7565 290a 2020 2020  tderr=True).    
+00019530: 2020 2020 6f75 742c 2065 7272 203d 2070      out, err = p
+00019540: 726f 6365 7373 2e77 6169 745f 6f75 7470  rocess.wait_outp
+00019550: 7574 2829 0a20 2020 2020 2020 2073 656c  ut().        sel
+00019560: 662e 6173 7365 7274 4571 7561 6c28 6f75  f.assertEqual(ou
+00019570: 742c 2027 6669 6c65 206e 6f74 2066 6f75  t, 'file not fou
+00019580: 6e64 3a20 785c 6e27 290a 2020 2020 2020  nd: x\n').      
+00019590: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+000195a0: 6f6e 6528 6572 7229 0a0a 2020 2020 2020  one(err)..      
+000195b0: 2020 6578 6563 5f64 6174 6120 3d20 7365    exec_data = se
+000195c0: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
+000195d0: 7461 285b 276c 7327 2c20 2778 275d 2c20  ta(['ls', 'x'], 
+000195e0: 636f 6d62 696e 655f 7374 6465 7272 3d54  combine_stderr=T
+000195f0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00019600: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+00019610: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
+00019620: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+00019630: 2020 2827 504f 5354 272c 2027 2f76 312f    ('POST', '/v1/
+00019640: 6578 6563 272c 204e 6f6e 652c 2065 7865  exec', None, exe
+00019650: 635f 6461 7461 292c 0a20 2020 2020 2020  c_data),.       
+00019660: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
+00019670: 312f 6368 616e 6765 732f 3132 332f 7761  1/changes/123/wa
+00019680: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
+00019690: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
+000196a0: 292c 0a20 2020 2020 2020 205d 290a 2020  ),.        ]).  
+000196b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000196c0: 7445 7175 616c 2873 7464 696f 2e73 656e  tEqual(stdio.sen
+000196d0: 6473 2c20 5b5d 290a 0a20 2020 2064 6566  ds, [])..    def
+000196e0: 2074 6573 745f 7761 6974 5f6f 7574 7075   test_wait_outpu
+000196f0: 745f 7365 6e64 5f73 7464 696e 2873 656c  t_send_stdin(sel
+00019700: 6629 3a0a 2020 2020 2020 2020 7374 6469  f):.        stdi
+00019710: 6f2c 2073 7464 6572 722c 205f 203d 2073  o, stderr, _ = s
+00019720: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
+00019730: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
+00019740: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
+00019750: 6573 2e61 7070 656e 6428 6227 464f 4f5c  es.append(b'FOO\
+00019760: 6e42 4152 5c6e 2729 0a20 2020 2020 2020  nBAR\n').       
+00019770: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
+00019780: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
+00019790: 6422 3a22 656e 6422 7d27 290a 2020 2020  d":"end"}').    
+000197a0: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+000197b0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+000197c0: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+000197d0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000197e0: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+000197f0: 7865 6328 5b27 6177 6b27 2c20 277b 2070  xec(['awk', '{ p
+00019800: 7269 6e74 2074 6f75 7070 6572 2824 2920  rint toupper($) 
+00019810: 7d27 5d2c 2073 7464 696e 3d27 666f 6f5c  }'], stdin='foo\
+00019820: 6e62 6172 5c6e 2729 0a20 2020 2020 2020  nbar\n').       
+00019830: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
+00019840: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
+00019850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00019860: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
+00019870: 2746 4f4f 5c6e 4241 525c 6e27 290a 2020  'FOO\nBAR\n').  
+00019880: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00019890: 7445 7175 616c 2865 7272 2c20 2727 290a  tEqual(err, '').
+000198a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000198b0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
+000198c0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
+000198d0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+000198e0: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
+000198f0: 272c 204e 6f6e 652c 2073 656c 662e 6275  ', None, self.bu
+00019900: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
+00019910: 6177 6b27 2c20 277b 2070 7269 6e74 2074  awk', '{ print t
+00019920: 6f75 7070 6572 2824 2920 7d27 5d29 292c  oupper($) }'])),
+00019930: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00019940: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
+00019950: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
+00019960: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
+00019970: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+00019980: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00019990: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+000199a0: 7464 696f 2e73 656e 6473 2c20 5b0a 2020  tdio.sends, [.  
+000199b0: 2020 2020 2020 2020 2020 2827 4249 4e27            ('BIN'
+000199c0: 2c20 6227 666f 6f5c 6e62 6172 5c6e 2729  , b'foo\nbar\n')
+000199d0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+000199e0: 5458 5427 2c20 277b 2263 6f6d 6d61 6e64  TXT', '{"command
+000199f0: 223a 2265 6e64 227d 2729 2c0a 2020 2020  ":"end"}'),.    
+00019a00: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+00019a10: 7465 7374 5f77 6169 745f 6f75 7470 7574  test_wait_output
+00019a20: 5f73 656e 645f 7374 6469 6e5f 6279 7465  _send_stdin_byte
+00019a30: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00019a40: 2073 7464 696f 2c20 7374 6465 7272 2c20   stdio, stderr, 
+00019a50: 5f20 3d20 7365 6c66 2e61 6464 5f72 6573  _ = self.add_res
+00019a60: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
+00019a70: 0a20 2020 2020 2020 2073 7464 696f 2e72  .        stdio.r
+00019a80: 6563 6569 7665 732e 6170 7065 6e64 2862  eceives.append(b
+00019a90: 2746 4f4f 5c6e 4241 525c 6e27 290a 2020  'FOO\nBAR\n').  
+00019aa0: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
+00019ab0: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
+00019ac0: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+00019ad0: 0a20 2020 2020 2020 2073 7464 6572 722e  .        stderr.
+00019ae0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+00019af0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+00019b00: 227d 2729 0a0a 2020 2020 2020 2020 7072  "}')..        pr
+00019b10: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
+00019b20: 656e 742e 6578 6563 285b 2761 776b 272c  ent.exec(['awk',
+00019b30: 2027 7b20 7072 696e 7420 746f 7570 7065   '{ print touppe
+00019b40: 7228 2429 207d 275d 2c20 7374 6469 6e3d  r($) }'], stdin=
+00019b50: 6227 666f 6f5c 6e62 6172 5c6e 272c 0a20  b'foo\nbar\n',. 
+00019b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b80: 2020 656e 636f 6469 6e67 3d4e 6f6e 6529    encoding=None)
+00019b90: 0a20 2020 2020 2020 206f 7574 2c20 6572  .        out, er
+00019ba0: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+00019bb0: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+00019bc0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00019bd0: 616c 286f 7574 2c20 6227 464f 4f5c 6e42  al(out, b'FOO\nB
+00019be0: 4152 5c6e 2729 0a20 2020 2020 2020 2073  AR\n').        s
+00019bf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00019c00: 6572 722c 2062 2727 290a 0a20 2020 2020  err, b'')..     
+00019c10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00019c20: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+00019c30: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+00019c40: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
+00019c50: 2027 2f76 312f 6578 6563 272c 204e 6f6e   '/v1/exec', Non
+00019c60: 652c 2073 656c 662e 6275 696c 645f 6578  e, self.build_ex
+00019c70: 6563 5f64 6174 6128 5b27 6177 6b27 2c20  ec_data(['awk', 
+00019c80: 277b 2070 7269 6e74 2074 6f75 7070 6572  '{ print toupper
+00019c90: 2824 2920 7d27 5d29 292c 0a20 2020 2020  ($) }'])),.     
+00019ca0: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+00019cb0: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
+00019cc0: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
+00019cd0: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
+00019ce0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+00019cf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019d00: 6572 7445 7175 616c 2873 7464 696f 2e73  ertEqual(stdio.s
+00019d10: 656e 6473 2c20 5b0a 2020 2020 2020 2020  ends, [.        
+00019d20: 2020 2020 2827 4249 4e27 2c20 6227 666f      ('BIN', b'fo
+00019d30: 6f5c 6e62 6172 5c6e 2729 2c0a 2020 2020  o\nbar\n'),.    
+00019d40: 2020 2020 2020 2020 2827 5458 5427 2c20          ('TXT', 
+00019d50: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+00019d60: 227d 2729 2c0a 2020 2020 2020 2020 5d29  "}'),.        ])
+00019d70: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
+00019d80: 6169 745f 6f75 7470 7574 5f62 6164 5f63  ait_output_bad_c
+00019d90: 6f6d 6d61 6e64 2873 656c 6629 3a0a 2020  ommand(self):.  
+00019da0: 2020 2020 2020 7374 6469 6f2c 2073 7464        stdio, std
+00019db0: 6572 722c 205f 203d 2073 656c 662e 6164  err, _ = self.ad
+00019dc0: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
+00019dd0: 272c 2030 290a 2020 2020 2020 2020 7374  ', 0).        st
+00019de0: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
+00019df0: 656e 6428 6227 5079 7468 6f6e 2033 2e38  end(b'Python 3.8
+00019e00: 2e31 305c 6e27 290a 2020 2020 2020 2020  .10\n').        
+00019e10: 7374 6469 6f2e 7265 6365 6976 6573 2e61  stdio.receives.a
+00019e20: 7070 656e 6428 276e 6f74 206a 736f 6e27  ppend('not json'
+00019e30: 2920 2023 2062 6164 204a 534f 4e20 7368  )  # bad JSON sh
+00019e40: 6f75 6c64 2062 6520 6967 6e6f 7265 640a  ould be ignored.
+00019e50: 2020 2020 2020 2020 7374 6469 6f2e 7265          stdio.re
+00019e60: 6365 6976 6573 2e61 7070 656e 6428 277b  ceives.append('{
+00019e70: 2263 6f6d 6d61 6e64 223a 2266 6f6f 227d  "command":"foo"}
+00019e80: 2729 2020 2320 756e 6b6e 6f77 6e20 636f  ')  # unknown co
+00019e90: 6d6d 616e 6420 7368 6f75 6c64 2062 6520  mmand should be 
+00019ea0: 6967 6e6f 7265 640a 2020 2020 2020 2020  ignored.        
+00019eb0: 7374 6469 6f2e 7265 6365 6976 6573 2e61  stdio.receives.a
+00019ec0: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+00019ed0: 223a 2265 6e64 227d 2729 0a20 2020 2020  ":"end"}').     
+00019ee0: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
+00019ef0: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
+00019f00: 6d61 6e64 223a 2265 6e64 227d 2729 0a0a  mand":"end"}')..
+00019f10: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00019f20: 662e 6173 7365 7274 4c6f 6773 2827 6f70  f.assertLogs('op
+00019f30: 732e 7065 6262 6c65 272c 206c 6576 656c  s.pebble', level
+00019f40: 3d27 5741 524e 494e 4727 2920 6173 2063  ='WARNING') as c
+00019f50: 6d3a 0a20 2020 2020 2020 2020 2020 2070  m:.            p
+00019f60: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+00019f70: 6965 6e74 2e65 7865 6328 5b27 7079 7468  ient.exec(['pyth
+00019f80: 6f6e 3327 2c20 272d 2d76 6572 7369 6f6e  on3', '--version
+00019f90: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
+00019fa0: 6f75 742c 2065 7272 203d 2070 726f 6365  out, err = proce
+00019fb0: 7373 2e77 6169 745f 6f75 7470 7574 2829  ss.wait_output()
+00019fc0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00019fd0: 7365 7274 4571 7561 6c28 636d 2e6f 7574  sertEqual(cm.out
+00019fe0: 7075 742c 205b 0a20 2020 2020 2020 2020  put, [.         
+00019ff0: 2020 2022 5741 524e 494e 473a 6f70 732e     "WARNING:ops.
+0001a000: 7065 6262 6c65 3a43 616e 6e6f 7420 6465  pebble:Cannot de
+0001a010: 636f 6465 2049 2f4f 2063 6f6d 6d61 6e64  code I/O command
+0001a020: 2028 696e 7661 6c69 6420 4a53 4f4e 2922   (invalid JSON)"
+0001a030: 2c0a 2020 2020 2020 2020 2020 2020 2257  ,.            "W
+0001a040: 4152 4e49 4e47 3a6f 7073 2e70 6562 626c  ARNING:ops.pebbl
+0001a050: 653a 496e 7661 6c69 6420 492f 4f20 636f  e:Invalid I/O co
+0001a060: 6d6d 616e 6420 2766 6f6f 2722 2c0a 2020  mmand 'foo'",.  
+0001a070: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
+0001a080: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001a090: 616c 286f 7574 2c20 2750 7974 686f 6e20  al(out, 'Python 
+0001a0a0: 332e 382e 3130 5c6e 2729 0a20 2020 2020  3.8.10\n').     
+0001a0b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a0c0: 7561 6c28 6572 722c 2027 2729 0a0a 2020  ual(err, '')..  
+0001a0d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001a0e0: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+0001a0f0: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+0001a100: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
+0001a110: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
+0001a120: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
+0001a130: 5f65 7865 635f 6461 7461 285b 2770 7974  _exec_data(['pyt
+0001a140: 686f 6e33 272c 2027 2d2d 7665 7273 696f  hon3', '--versio
+0001a150: 6e27 5d29 292c 0a20 2020 2020 2020 2020  n'])),.         
+0001a160: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0001a170: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
+0001a180: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+0001a190: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+0001a1a0: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
+0001a1b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001a1c0: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
+0001a1d0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+0001a1e0: 6573 745f 7761 6974 5f70 6173 7365 645f  est_wait_passed_
+0001a1f0: 6f75 7470 7574 2873 656c 6629 3a0a 2020  output(self):.  
+0001a200: 2020 2020 2020 696f 5f77 732c 2073 7464        io_ws, std
+0001a210: 6572 722c 205f 203d 2073 656c 662e 6164  err, _ = self.ad
+0001a220: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
+0001a230: 272c 2030 290a 2020 2020 2020 2020 696f  ', 0).        io
+0001a240: 5f77 732e 7265 6365 6976 6573 2e61 7070  _ws.receives.app
+0001a250: 656e 6428 6227 666f 6f5c 6e27 290a 2020  end(b'foo\n').  
+0001a260: 2020 2020 2020 696f 5f77 732e 7265 6365        io_ws.rece
+0001a270: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
+0001a280: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+0001a290: 0a20 2020 2020 2020 2073 7464 6572 722e  .        stderr.
+0001a2a0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+0001a2b0: 6227 736f 6d65 2065 7272 6f72 5c6e 2729  b'some error\n')
+0001a2c0: 0a20 2020 2020 2020 2073 7464 6572 722e  .        stderr.
+0001a2d0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+0001a2e0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+0001a2f0: 227d 2729 0a0a 2020 2020 2020 2020 6f75  "}')..        ou
+0001a300: 7420 3d20 696f 2e53 7472 696e 6749 4f28  t = io.StringIO(
+0001a310: 290a 2020 2020 2020 2020 6572 7220 3d20  ).        err = 
+0001a320: 696f 2e53 7472 696e 6749 4f28 290a 2020  io.StringIO().  
+0001a330: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
+0001a340: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
+0001a350: 285b 2765 6368 6f27 2c20 2766 6f6f 275d  (['echo', 'foo']
+0001a360: 2c20 7374 646f 7574 3d6f 7574 2c20 7374  , stdout=out, st
+0001a370: 6465 7272 3d65 7272 290a 2020 2020 2020  derr=err).      
+0001a380: 2020 7072 6f63 6573 732e 7761 6974 2829    process.wait()
+0001a390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001a3a0: 7365 7274 4571 7561 6c28 6f75 742e 6765  sertEqual(out.ge
+0001a3b0: 7476 616c 7565 2829 2c20 2766 6f6f 5c6e  tvalue(), 'foo\n
+0001a3c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001a3d0: 6173 7365 7274 4571 7561 6c28 6572 722e  assertEqual(err.
+0001a3e0: 6765 7476 616c 7565 2829 2c20 2773 6f6d  getvalue(), 'som
+0001a3f0: 6520 6572 726f 725c 6e27 290a 0a20 2020  e error\n')..   
+0001a400: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a410: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0001a420: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0001a430: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+0001a440: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
+0001a450: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
+0001a460: 6578 6563 5f64 6174 6128 5b27 6563 686f  exec_data(['echo
+0001a470: 272c 2027 666f 6f27 5d29 292c 0a20 2020  ', 'foo'])),.   
+0001a480: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+0001a490: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
+0001a4a0: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
+0001a4b0: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
+0001a4c0: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+0001a4d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001a4e0: 7373 6572 7445 7175 616c 2869 6f5f 7773  ssertEqual(io_ws
+0001a4f0: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
+0001a500: 2064 6566 2074 6573 745f 7761 6974 5f70   def test_wait_p
+0001a510: 6173 7365 645f 6f75 7470 7574 5f63 6f6d  assed_output_com
+0001a520: 6269 6e65 5f73 7464 6572 7228 7365 6c66  bine_stderr(self
+0001a530: 293a 0a20 2020 2020 2020 2069 6f5f 7773  ):.        io_ws
+0001a540: 2c20 5f2c 205f 203d 2073 656c 662e 6164  , _, _ = self.ad
+0001a550: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
+0001a560: 272c 2030 290a 2020 2020 2020 2020 696f  ', 0).        io
+0001a570: 5f77 732e 7265 6365 6976 6573 2e61 7070  _ws.receives.app
+0001a580: 656e 6428 6227 666f 6f5c 6e27 290a 2020  end(b'foo\n').  
+0001a590: 2020 2020 2020 696f 5f77 732e 7265 6365        io_ws.rece
+0001a5a0: 6976 6573 2e61 7070 656e 6428 6227 736f  ives.append(b'so
+0001a5b0: 6d65 2065 7272 6f72 5c6e 2729 0a20 2020  me error\n').   
+0001a5c0: 2020 2020 2069 6f5f 7773 2e72 6563 6569       io_ws.recei
+0001a5d0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+0001a5e0: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+0001a5f0: 0a20 2020 2020 2020 206f 7574 203d 2069  .        out = i
+0001a600: 6f2e 5374 7269 6e67 494f 2829 0a20 2020  o.StringIO().   
+0001a610: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+0001a620: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+0001a630: 5b27 6563 686f 272c 2027 666f 6f27 5d2c  ['echo', 'foo'],
+0001a640: 2073 7464 6f75 743d 6f75 742c 2063 6f6d   stdout=out, com
+0001a650: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
+0001a660: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
+0001a670: 732e 7761 6974 2829 0a20 2020 2020 2020  s.wait().       
+0001a680: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a690: 6c28 6f75 742e 6765 7476 616c 7565 2829  l(out.getvalue()
+0001a6a0: 2c20 2766 6f6f 5c6e 736f 6d65 2065 7272  , 'foo\nsome err
+0001a6b0: 6f72 5c6e 2729 0a20 2020 2020 2020 2073  or\n').        s
+0001a6c0: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001a6d0: 2870 726f 6365 7373 2e73 7464 6572 7229  (process.stderr)
+0001a6e0: 0a0a 2020 2020 2020 2020 6578 6563 5f64  ..        exec_d
+0001a6f0: 6174 6120 3d20 7365 6c66 2e62 7569 6c64  ata = self.build
+0001a700: 5f65 7865 635f 6461 7461 285b 2765 6368  _exec_data(['ech
+0001a710: 6f27 2c20 2766 6f6f 275d 2c20 636f 6d62  o', 'foo'], comb
+0001a720: 696e 655f 7374 6465 7272 3d54 7275 6529  ine_stderr=True)
+0001a730: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001a740: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
+0001a750: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
+0001a760: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+0001a770: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
+0001a780: 272c 204e 6f6e 652c 2065 7865 635f 6461  ', None, exec_da
+0001a790: 7461 292c 0a20 2020 2020 2020 2020 2020  ta),.           
+0001a7a0: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
+0001a7b0: 616e 6765 732f 3132 332f 7761 6974 272c  anges/123/wait',
+0001a7c0: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
+0001a7d0: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
+0001a7e0: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+0001a7f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001a800: 616c 2869 6f5f 7773 2e73 656e 6473 2c20  al(io_ws.sends, 
+0001a810: 5b5d 290a 0a20 2020 2064 6566 2074 6573  [])..    def tes
+0001a820: 745f 7761 6974 5f70 6173 7365 645f 6f75  t_wait_passed_ou
+0001a830: 7470 7574 5f62 7974 6573 2873 656c 6629  tput_bytes(self)
+0001a840: 3a0a 2020 2020 2020 2020 696f 5f77 732c  :.        io_ws,
+0001a850: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
+0001a860: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
+0001a870: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
+0001a880: 2020 696f 5f77 732e 7265 6365 6976 6573    io_ws.receives
+0001a890: 2e61 7070 656e 6428 6227 666f 6f5c 6e27  .append(b'foo\n'
+0001a8a0: 290a 2020 2020 2020 2020 696f 5f77 732e  ).        io_ws.
+0001a8b0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+0001a8c0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+0001a8d0: 227d 2729 0a20 2020 2020 2020 2073 7464  "}').        std
+0001a8e0: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
+0001a8f0: 656e 6428 6227 736f 6d65 2065 7272 6f72  end(b'some error
+0001a900: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
+0001a910: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
+0001a920: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
+0001a930: 2265 6e64 227d 2729 0a0a 2020 2020 2020  "end"}')..      
+0001a940: 2020 6f75 7420 3d20 696f 2e42 7974 6573    out = io.Bytes
+0001a950: 494f 2829 0a20 2020 2020 2020 2065 7272  IO().        err
+0001a960: 203d 2069 6f2e 4279 7465 7349 4f28 290a   = io.BytesIO().
+0001a970: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+0001a980: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
+0001a990: 6563 285b 2765 6368 6f27 2c20 2766 6f6f  ec(['echo', 'foo
+0001a9a0: 275d 2c20 7374 646f 7574 3d6f 7574 2c20  '], stdout=out, 
+0001a9b0: 7374 6465 7272 3d65 7272 2c20 656e 636f  stderr=err, enco
+0001a9c0: 6469 6e67 3d4e 6f6e 6529 0a20 2020 2020  ding=None).     
+0001a9d0: 2020 2070 726f 6365 7373 2e77 6169 7428     process.wait(
+0001a9e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001a9f0: 7373 6572 7445 7175 616c 286f 7574 2e67  ssertEqual(out.g
+0001aa00: 6574 7661 6c75 6528 292c 2062 2766 6f6f  etvalue(), b'foo
+0001aa10: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
+0001aa20: 662e 6173 7365 7274 4571 7561 6c28 6572  f.assertEqual(er
+0001aa30: 722e 6765 7476 616c 7565 2829 2c20 6227  r.getvalue(), b'
+0001aa40: 736f 6d65 2065 7272 6f72 5c6e 2729 0a0a  some error\n')..
+0001aa50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001aa60: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+0001aa70: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+0001aa80: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+0001aa90: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
+0001aaa0: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
+0001aab0: 6c64 5f65 7865 635f 6461 7461 285b 2765  ld_exec_data(['e
+0001aac0: 6368 6f27 2c20 2766 6f6f 275d 2929 2c0a  cho', 'foo'])),.
+0001aad0: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0001aae0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0001aaf0: 2f31 3233 2f77 6169 7427 2c20 7b27 7469  /123/wait', {'ti
+0001ab00: 6d65 6f75 7427 3a20 2734 2e30 3030 7327  meout': '4.000s'
+0001ab10: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
+0001ab20: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
+0001ab30: 662e 6173 7365 7274 4571 7561 6c28 696f  f.assertEqual(io
+0001ab40: 5f77 732e 7365 6e64 732c 205b 5d29 0a0a  _ws.sends, [])..
+0001ab50: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
+0001ab60: 745f 7061 7373 6564 5f6f 7574 7075 745f  t_passed_output_
+0001ab70: 6261 645f 636f 6d6d 616e 6428 7365 6c66  bad_command(self
+0001ab80: 293a 0a20 2020 2020 2020 2069 6f5f 7773  ):.        io_ws
+0001ab90: 2c20 7374 6465 7272 2c20 5f20 3d20 7365  , stderr, _ = se
+0001aba0: 6c66 2e61 6464 5f72 6573 706f 6e73 6573  lf.add_responses
+0001abb0: 2827 3132 3327 2c20 3029 0a20 2020 2020  ('123', 0).     
+0001abc0: 2020 2069 6f5f 7773 2e72 6563 6569 7665     io_ws.receive
+0001abd0: 732e 6170 7065 6e64 2862 2766 6f6f 5c6e  s.append(b'foo\n
+0001abe0: 2729 0a20 2020 2020 2020 2069 6f5f 7773  ').        io_ws
+0001abf0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001ac00: 2827 6e6f 7420 6a73 6f6e 2729 2020 2320  ('not json')  # 
+0001ac10: 6261 6420 4a53 4f4e 2073 686f 756c 6420  bad JSON should 
+0001ac20: 6265 2069 676e 6f72 6564 0a20 2020 2020  be ignored.     
+0001ac30: 2020 2069 6f5f 7773 2e72 6563 6569 7665     io_ws.receive
+0001ac40: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
+0001ac50: 616e 6422 3a22 666f 6f22 7d27 2920 2023  and":"foo"}')  #
+0001ac60: 2075 6e6b 6e6f 776e 2063 6f6d 6d61 6e64   unknown command
+0001ac70: 2073 686f 756c 6420 6265 2069 676e 6f72   should be ignor
+0001ac80: 6564 0a20 2020 2020 2020 2069 6f5f 7773  ed.        io_ws
+0001ac90: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001aca0: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+0001acb0: 6422 7d27 290a 2020 2020 2020 2020 7374  d"}').        st
+0001acc0: 6465 7272 2e72 6563 6569 7665 732e 6170  derr.receives.ap
+0001acd0: 7065 6e64 2862 2773 6f6d 6520 6572 726f  pend(b'some erro
+0001ace0: 725c 6e27 290a 2020 2020 2020 2020 7374  r\n').        st
+0001acf0: 6465 7272 2e72 6563 6569 7665 732e 6170  derr.receives.ap
+0001ad00: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
+0001ad10: 3a22 656e 6422 7d27 290a 0a20 2020 2020  :"end"}')..     
+0001ad20: 2020 206f 7574 203d 2069 6f2e 5374 7269     out = io.Stri
+0001ad30: 6e67 494f 2829 0a20 2020 2020 2020 2065  ngIO().        e
+0001ad40: 7272 203d 2069 6f2e 5374 7269 6e67 494f  rr = io.StringIO
+0001ad50: 2829 0a0a 2020 2020 2020 2020 7769 7468  ()..        with
+0001ad60: 2073 656c 662e 6173 7365 7274 4c6f 6773   self.assertLogs
+0001ad70: 2827 6f70 732e 7065 6262 6c65 272c 206c  ('ops.pebble', l
+0001ad80: 6576 656c 3d27 5741 524e 494e 4727 2920  evel='WARNING') 
+0001ad90: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+0001ada0: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
+0001adb0: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
+0001adc0: 6563 686f 272c 2027 666f 6f27 5d2c 2073  echo', 'foo'], s
+0001add0: 7464 6f75 743d 6f75 742c 2073 7464 6572  tdout=out, stder
+0001ade0: 723d 6572 7229 0a20 2020 2020 2020 2020  r=err).         
+0001adf0: 2020 2070 726f 6365 7373 2e77 6169 7428     process.wait(
+0001ae00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ae10: 7373 6572 7445 7175 616c 2863 6d2e 6f75  ssertEqual(cm.ou
+0001ae20: 7470 7574 2c20 5b0a 2020 2020 2020 2020  tput, [.        
+0001ae30: 2020 2020 2257 4152 4e49 4e47 3a6f 7073      "WARNING:ops
+0001ae40: 2e70 6562 626c 653a 4361 6e6e 6f74 2064  .pebble:Cannot d
+0001ae50: 6563 6f64 6520 492f 4f20 636f 6d6d 616e  ecode I/O comman
+0001ae60: 6420 2869 6e76 616c 6964 204a 534f 4e29  d (invalid JSON)
+0001ae70: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0001ae80: 5741 524e 494e 473a 6f70 732e 7065 6262  WARNING:ops.pebb
+0001ae90: 6c65 3a49 6e76 616c 6964 2049 2f4f 2063  le:Invalid I/O c
+0001aea0: 6f6d 6d61 6e64 2027 666f 6f27 222c 0a20  ommand 'foo'",. 
+0001aeb0: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
+0001aec0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001aed0: 7561 6c28 6f75 742e 6765 7476 616c 7565  ual(out.getvalue
+0001aee0: 2829 2c20 2766 6f6f 5c6e 2729 0a20 2020  (), 'foo\n').   
+0001aef0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001af00: 4571 7561 6c28 6572 722e 6765 7476 616c  Equal(err.getval
+0001af10: 7565 2829 2c20 2773 6f6d 6520 6572 726f  ue(), 'some erro
+0001af20: 725c 6e27 290a 0a20 2020 2020 2020 2073  r\n')..        s
+0001af30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001af40: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+0001af50: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0001af60: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
+0001af70: 312f 6578 6563 272c 204e 6f6e 652c 2073  1/exec', None, s
+0001af80: 656c 662e 6275 696c 645f 6578 6563 5f64  elf.build_exec_d
+0001af90: 6174 6128 5b27 6563 686f 272c 2027 666f  ata(['echo', 'fo
+0001afa0: 6f27 5d29 292c 0a20 2020 2020 2020 2020  o'])),.         
+0001afb0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0001afc0: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
+0001afd0: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+0001afe0: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+0001aff0: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
+0001b000: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b010: 7175 616c 2869 6f5f 7773 2e73 656e 6473  qual(io_ws.sends
+0001b020: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+0001b030: 6573 745f 7761 6974 5f66 696c 655f 696f  est_wait_file_io
+0001b040: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001b050: 6669 6e20 3d20 7465 6d70 6669 6c65 2e54  fin = tempfile.T
+0001b060: 656d 706f 7261 7279 4669 6c65 286d 6f64  emporaryFile(mod
+0001b070: 653d 2777 2b27 2c20 656e 636f 6469 6e67  e='w+', encoding
+0001b080: 3d27 7574 662d 3827 290a 2020 2020 2020  ='utf-8').      
+0001b090: 2020 6f75 7420 3d20 7465 6d70 6669 6c65    out = tempfile
+0001b0a0: 2e54 656d 706f 7261 7279 4669 6c65 286d  .TemporaryFile(m
+0001b0b0: 6f64 653d 2777 2b27 2c20 656e 636f 6469  ode='w+', encodi
+0001b0c0: 6e67 3d27 7574 662d 3827 290a 2020 2020  ng='utf-8').    
+0001b0d0: 2020 2020 6572 7220 3d20 7465 6d70 6669      err = tempfi
+0001b0e0: 6c65 2e54 656d 706f 7261 7279 4669 6c65  le.TemporaryFile
+0001b0f0: 286d 6f64 653d 2777 2b27 2c20 656e 636f  (mode='w+', enco
+0001b100: 6469 6e67 3d27 7574 662d 3827 290a 2020  ding='utf-8').  
+0001b110: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001b120: 2020 2020 2020 2066 696e 2e77 7269 7465         fin.write
+0001b130: 2827 666f 6f5c 6e27 290a 2020 2020 2020  ('foo\n').      
+0001b140: 2020 2020 2020 6669 6e2e 7365 656b 2830        fin.seek(0
+0001b150: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001b160: 6f5f 7773 2c20 7374 6465 7272 2c20 5f20  o_ws, stderr, _ 
+0001b170: 3d20 7365 6c66 2e61 6464 5f72 6573 706f  = self.add_respo
+0001b180: 6e73 6573 2827 3132 3327 2c20 3029 0a20  nses('123', 0). 
+0001b190: 2020 2020 2020 2020 2020 2069 6f5f 7773             io_ws
+0001b1a0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001b1b0: 2862 2766 6f6f 5c6e 2729 0a20 2020 2020  (b'foo\n').     
+0001b1c0: 2020 2020 2020 2069 6f5f 7773 2e72 6563         io_ws.rec
+0001b1d0: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
+0001b1e0: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
+0001b1f0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001b200: 6465 7272 2e72 6563 6569 7665 732e 6170  derr.receives.ap
+0001b210: 7065 6e64 2862 2773 6f6d 6520 6572 726f  pend(b'some erro
+0001b220: 725c 6e27 290a 2020 2020 2020 2020 2020  r\n').          
+0001b230: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
+0001b240: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
+0001b250: 616e 6422 3a22 656e 6422 7d27 290a 0a20  and":"end"}').. 
+0001b260: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+0001b270: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+0001b280: 2e65 7865 6328 5b27 6563 686f 272c 2027  .exec(['echo', '
+0001b290: 666f 6f27 5d2c 2073 7464 696e 3d66 696e  foo'], stdin=fin
+0001b2a0: 2c20 7374 646f 7574 3d6f 7574 2c20 7374  , stdout=out, st
+0001b2b0: 6465 7272 3d65 7272 290a 2020 2020 2020  derr=err).      
+0001b2c0: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
+0001b2d0: 6974 2829 0a0a 2020 2020 2020 2020 2020  it()..          
+0001b2e0: 2020 6f75 742e 7365 656b 2830 290a 2020    out.seek(0).  
+0001b2f0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+0001b300: 7373 6572 7445 7175 616c 286f 7574 2e72  ssertEqual(out.r
+0001b310: 6561 6428 292c 2027 666f 6f5c 6e27 290a  ead(), 'foo\n').
+0001b320: 2020 2020 2020 2020 2020 2020 6572 722e              err.
+0001b330: 7365 656b 2830 290a 2020 2020 2020 2020  seek(0).        
+0001b340: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b350: 7175 616c 2865 7272 2e72 6561 6428 292c  qual(err.read(),
+0001b360: 2027 736f 6d65 2065 7272 6f72 5c6e 2729   'some error\n')
+0001b370: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0001b380: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001b390: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0001b3a0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0001b3b0: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+0001b3c0: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
+0001b3d0: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
+0001b3e0: 635f 6461 7461 285b 2765 6368 6f27 2c20  c_data(['echo', 
+0001b3f0: 2766 6f6f 275d 2929 2c0a 2020 2020 2020  'foo'])),.      
+0001b400: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+0001b410: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
+0001b420: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
+0001b430: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+0001b440: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0001b450: 2020 2020 5d29 0a20 2020 2020 2020 2020      ]).         
+0001b460: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001b470: 7561 6c28 696f 5f77 732e 7365 6e64 732c  ual(io_ws.sends,
+0001b480: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0001b490: 2020 2028 2742 494e 272c 2062 2766 6f6f     ('BIN', b'foo
+0001b4a0: 5c6e 2729 2c0a 2020 2020 2020 2020 2020  \n'),.          
+0001b4b0: 2020 2020 2020 2827 5458 5427 2c20 277b        ('TXT', '{
+0001b4c0: 2263 6f6d 6d61 6e64 223a 2265 6e64 227d  "command":"end"}
+0001b4d0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+0001b4e0: 5d29 0a20 2020 2020 2020 2066 696e 616c  ]).        final
+0001b4f0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+0001b500: 6669 6e2e 636c 6f73 6528 290a 2020 2020  fin.close().    
+0001b510: 2020 2020 2020 2020 6f75 742e 636c 6f73          out.clos
+0001b520: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0001b530: 6572 722e 636c 6f73 6528 290a 0a20 2020  err.close()..   
+0001b540: 2064 6566 2074 6573 745f 7761 6974 5f72   def test_wait_r
+0001b550: 6574 7572 6e65 645f 696f 2873 656c 6629  eturned_io(self)
+0001b560: 3a0a 2020 2020 2020 2020 7374 6469 6f2c  :.        stdio,
+0001b570: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
+0001b580: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
+0001b590: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
+0001b5a0: 2020 7374 6469 6f2e 7265 6365 6976 6573    stdio.receives
+0001b5b0: 2e61 7070 656e 6428 6227 464f 4f20 4241  .append(b'FOO BA
+0001b5c0: 525c 6e27 290a 2020 2020 2020 2020 7374  R\n').        st
+0001b5d0: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
+0001b5e0: 656e 6428 6227 4241 5a5a 5c6e 2729 0a20  end(b'BAZZ\n'). 
+0001b5f0: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
+0001b600: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
+0001b610: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
+0001b620: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+0001b630: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+0001b640: 2e65 7865 6328 5b27 6177 6b27 2c20 277b  .exec(['awk', '{
+0001b650: 2070 7269 6e74 2074 6f75 7070 6572 2824   print toupper($
+0001b660: 2920 7d27 5d29 0a20 2020 2020 2020 2070  ) }']).        p
+0001b670: 726f 6365 7373 2e73 7464 696e 2e77 7269  rocess.stdin.wri
+0001b680: 7465 2827 466f 6f20 4261 725c 6e27 290a  te('Foo Bar\n').
+0001b690: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001b6a0: 6572 7445 7175 616c 2870 726f 6365 7373  ertEqual(process
+0001b6b0: 2e73 7464 6f75 742e 7265 6164 2834 292c  .stdout.read(4),
+0001b6c0: 2027 464f 4f20 2729 0a20 2020 2020 2020   'FOO ').       
+0001b6d0: 2070 726f 6365 7373 2e73 7464 696e 2e77   process.stdin.w
+0001b6e0: 7269 7465 2827 6261 7a7a 5c6e 2729 0a20  rite('bazz\n'). 
+0001b6f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001b700: 7274 4571 7561 6c28 7072 6f63 6573 732e  rtEqual(process.
+0001b710: 7374 646f 7574 2e72 6561 6428 292c 2027  stdout.read(), '
+0001b720: 4241 525c 6e42 415a 5a5c 6e27 290a 2020  BAR\nBAZZ\n').  
+0001b730: 2020 2020 2020 7072 6f63 6573 732e 7374        process.st
+0001b740: 6469 6e2e 636c 6f73 6528 290a 2020 2020  din.close().    
+0001b750: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b760: 7175 616c 2870 726f 6365 7373 2e73 7464  qual(process.std
+0001b770: 6f75 742e 7265 6164 2829 2c20 2727 290a  out.read(), '').
+0001b780: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
+0001b790: 7761 6974 2829 0a0a 2020 2020 2020 2020  wait()..        
+0001b7a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001b7b0: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+0001b7c0: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+0001b7d0: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+0001b7e0: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
+0001b7f0: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
+0001b800: 6461 7461 285b 2761 776b 272c 2027 7b20  data(['awk', '{ 
+0001b810: 7072 696e 7420 746f 7570 7065 7228 2429  print toupper($)
+0001b820: 207d 275d 2929 2c0a 2020 2020 2020 2020   }'])),.        
+0001b830: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+0001b840: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
+0001b850: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
+0001b860: 2734 2e30 3030 7327 7d2c 204e 6f6e 6529  '4.000s'}, None)
+0001b870: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0001b880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001b890: 4571 7561 6c28 7374 6469 6f2e 7365 6e64  Equal(stdio.send
+0001b8a0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+0001b8b0: 2028 2742 494e 272c 2062 2746 6f6f 2042   ('BIN', b'Foo B
+0001b8c0: 6172 5c6e 6261 7a7a 5c6e 2729 2c20 2023  ar\nbazz\n'),  #
+0001b8d0: 2054 6578 7449 4f57 7261 7070 6572 2067   TextIOWrapper g
+0001b8e0: 726f 7570 7320 7468 6520 7772 6974 6573  roups the writes
+0001b8f0: 2074 6f67 6574 6865 720a 2020 2020 2020   together.      
+0001b900: 2020 2020 2020 2827 5458 5427 2c20 277b        ('TXT', '{
+0001b910: 2263 6f6d 6d61 6e64 223a 2265 6e64 227d  "command":"end"}
+0001b920: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+0001b930: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
+0001b940: 745f 7265 7475 726e 6564 5f69 6f5f 6279  t_returned_io_by
+0001b950: 7465 7328 7365 6c66 293a 0a20 2020 2020  tes(self):.     
+0001b960: 2020 2073 7464 696f 2c20 7374 6465 7272     stdio, stderr
+0001b970: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
+0001b980: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
+0001b990: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
+0001b9a0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001b9b0: 2862 2746 4f4f 2042 4152 5c6e 2729 0a20  (b'FOO BAR\n'). 
+0001b9c0: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
+0001b9d0: 6569 7665 732e 6170 7065 6e64 2862 2742  eives.append(b'B
+0001b9e0: 415a 5a5c 6e27 290a 2020 2020 2020 2020  AZZ\n').        
+0001b9f0: 7374 6469 6f2e 7265 6365 6976 6573 2e61  stdio.receives.a
+0001ba00: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+0001ba10: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
+0001ba20: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
+0001ba30: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
+0001ba40: 2761 776b 272c 2027 7b20 7072 696e 7420  'awk', '{ print 
+0001ba50: 746f 7570 7065 7228 2429 207d 275d 2c20  toupper($) }'], 
+0001ba60: 656e 636f 6469 6e67 3d4e 6f6e 6529 0a20  encoding=None). 
+0001ba70: 2020 2020 2020 2070 726f 6365 7373 2e73         process.s
+0001ba80: 7464 696e 2e77 7269 7465 2862 2746 6f6f  tdin.write(b'Foo
+0001ba90: 2042 6172 5c6e 2729 0a20 2020 2020 2020   Bar\n').       
+0001baa0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001bab0: 6c28 7072 6f63 6573 732e 7374 646f 7574  l(process.stdout
+0001bac0: 2e72 6561 6428 3429 2c20 6227 464f 4f20  .read(4), b'FOO 
+0001bad0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001bae0: 6173 7365 7274 4571 7561 6c28 7072 6f63  assertEqual(proc
+0001baf0: 6573 732e 7374 646f 7574 2e72 6561 6428  ess.stdout.read(
+0001bb00: 292c 2062 2742 4152 5c6e 2729 0a20 2020  ), b'BAR\n').   
+0001bb10: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
+0001bb20: 696e 2e77 7269 7465 2862 2762 617a 7a5c  in.write(b'bazz\
+0001bb30: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
+0001bb40: 2e61 7373 6572 7445 7175 616c 2870 726f  .assertEqual(pro
+0001bb50: 6365 7373 2e73 7464 6f75 742e 7265 6164  cess.stdout.read
+0001bb60: 2829 2c20 6227 4241 5a5a 5c6e 2729 0a20  (), b'BAZZ\n'). 
+0001bb70: 2020 2020 2020 2070 726f 6365 7373 2e73         process.s
+0001bb80: 7464 696e 2e63 6c6f 7365 2829 0a20 2020  tdin.close().   
+0001bb90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001bba0: 4571 7561 6c28 7072 6f63 6573 732e 7374  Equal(process.st
+0001bbb0: 646f 7574 2e72 6561 6428 292c 2062 2727  dout.read(), b''
+0001bbc0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
+0001bbd0: 732e 7761 6974 2829 0a0a 2020 2020 2020  s.wait()..      
+0001bbe0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001bbf0: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0001bc00: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0001bc10: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+0001bc20: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
+0001bc30: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
+0001bc40: 635f 6461 7461 285b 2761 776b 272c 2027  c_data(['awk', '
+0001bc50: 7b20 7072 696e 7420 746f 7570 7065 7228  { print toupper(
+0001bc60: 2429 207d 275d 2929 2c0a 2020 2020 2020  $) }'])),.      
+0001bc70: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+0001bc80: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
+0001bc90: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
+0001bca0: 3a20 2734 2e30 3030 7327 7d2c 204e 6f6e  : '4.000s'}, Non
+0001bcb0: 6529 2c0a 2020 2020 2020 2020 5d29 0a20  e),.        ]). 
+0001bcc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001bcd0: 7274 4571 7561 6c28 7374 6469 6f2e 7365  rtEqual(stdio.se
+0001bce0: 6e64 732c 205b 0a20 2020 2020 2020 2020  nds, [.         
+0001bcf0: 2020 2028 2742 494e 272c 2062 2746 6f6f     ('BIN', b'Foo
+0001bd00: 2042 6172 5c6e 2729 2c0a 2020 2020 2020   Bar\n'),.      
+0001bd10: 2020 2020 2020 2827 4249 4e27 2c20 6227        ('BIN', b'
+0001bd20: 6261 7a7a 5c6e 2729 2c0a 2020 2020 2020  bazz\n'),.      
+0001bd30: 2020 2020 2020 2827 5458 5427 2c20 277b        ('TXT', '{
+0001bd40: 2263 6f6d 6d61 6e64 223a 2265 6e64 227d  "command":"end"}
+0001bd50: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+0001bd60: 2020 2020 6465 6620 7465 7374 5f63 6f6e      def test_con
+0001bd70: 6e65 6374 5f77 6562 736f 636b 6574 5f65  nect_websocket_e
+0001bd80: 7272 6f72 2873 656c 6629 3a0a 2020 2020  rror(self):.    
+0001bd90: 2020 2020 636c 6173 7320 436c 6965 6e74      class Client
+0001bda0: 284d 6f63 6b43 6c69 656e 7429 3a0a 2020  (MockClient):.  
+0001bdb0: 2020 2020 2020 2020 2020 6465 6620 5f63            def _c
+0001bdc0: 6f6e 6e65 6374 5f77 6562 736f 636b 6574  onnect_websocket
+0001bdd0: 2873 656c 662c 2063 6861 6e67 655f 6964  (self, change_id
+0001bde0: 2c20 7765 6273 6f63 6b65 745f 6964 293a  , websocket_id):
+0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be00: 2072 6169 7365 2077 6562 736f 636b 6574   raise websocket
+0001be10: 2e57 6562 536f 636b 6574 4578 6365 7074  .WebSocketExcept
+0001be20: 696f 6e28 2763 6f6e 6e21 2729 0a0a 2020  ion('conn!')..  
+0001be30: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0001be40: 7420 3d20 436c 6965 6e74 2829 0a20 2020  t = Client().   
+0001be50: 2020 2020 2073 656c 662e 6164 645f 7265       self.add_re
+0001be60: 7370 6f6e 7365 7328 2731 3233 272c 2030  sponses('123', 0
+0001be70: 2c20 6368 616e 6765 5f65 7272 3d27 6368  , change_err='ch
+0001be80: 616e 6765 2065 7272 6f72 2127 290a 2020  ange error!').  
+0001be90: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0001bea0: 6173 7365 7274 5261 6973 6573 2870 6562  assertRaises(peb
+0001beb0: 626c 652e 4368 616e 6765 4572 726f 7229  ble.ChangeError)
+0001bec0: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
+0001bed0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0001bee0: 6578 6563 285b 2766 6f6f 275d 290a 2020  exec(['foo']).  
+0001bef0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001bf00: 7445 7175 616c 2873 7472 2863 6d2e 6578  tEqual(str(cm.ex
+0001bf10: 6365 7074 696f 6e29 2c20 2763 6861 6e67  ception), 'chang
+0001bf20: 6520 6572 726f 7221 2729 0a0a 2020 2020  e error!')..    
+0001bf30: 2020 2020 7365 6c66 2e63 6c69 656e 7420      self.client 
+0001bf40: 3d20 436c 6965 6e74 2829 0a20 2020 2020  = Client().     
+0001bf50: 2020 2073 656c 662e 6164 645f 7265 7370     self.add_resp
+0001bf60: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
+0001bf70: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0001bf80: 662e 6173 7365 7274 5261 6973 6573 2870  f.assertRaises(p
+0001bf90: 6562 626c 652e 436f 6e6e 6563 7469 6f6e  ebble.Connection
+0001bfa0: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
+0001bfb0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001bfc0: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
+0001bfd0: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+0001bfe0: 2e61 7373 6572 7449 6e28 7374 7228 636d  .assertIn(str(cm
+0001bff0: 2e65 7863 6570 7469 6f6e 292c 2027 756e  .exception), 'un
+0001c000: 6578 7065 6374 6564 2065 7272 6f72 2063  expected error c
+0001c010: 6f6e 6e65 6374 696e 6720 746f 2077 6562  onnecting to web
+0001c020: 736f 636b 6574 733a 2063 6f6e 6e21 2729  sockets: conn!')
+0001c030: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
+0001c040: 6562 736f 636b 6574 5f73 656e 645f 7261  ebsocket_send_ra
+0001c050: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
+0001c060: 2020 2020 7374 6469 6f2c 2073 7464 6572      stdio, stder
+0001c070: 722c 205f 203d 2073 656c 662e 6164 645f  r, _ = self.add_
+0001c080: 7265 7370 6f6e 7365 7328 2731 3233 272c  responses('123',
+0001c090: 2030 290a 2020 2020 2020 2020 7261 6973   0).        rais
+0001c0a0: 6564 203d 2046 616c 7365 0a0a 2020 2020  ed = False..    
+0001c0b0: 2020 2020 6465 6620 7365 6e64 5f62 696e      def send_bin
+0001c0c0: 6172 7928 6229 3a0a 2020 2020 2020 2020  ary(b):.        
+0001c0d0: 2020 2020 6e6f 6e6c 6f63 616c 2072 6169      nonlocal rai
+0001c0e0: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
+0001c0f0: 7261 6973 6564 203d 2054 7275 650a 2020  raised = True.  
+0001c100: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001c110: 4578 6365 7074 696f 6e28 2761 2073 696d  Exception('a sim
+0001c120: 756c 6174 6564 2065 7272 6f72 2127 290a  ulated error!').
+0001c130: 0a20 2020 2020 2020 2073 7464 696f 2e73  .        stdio.s
+0001c140: 656e 645f 6269 6e61 7279 203d 2073 656e  end_binary = sen
+0001c150: 645f 6269 6e61 7279 0a20 2020 2020 2020  d_binary.       
+0001c160: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
+0001c170: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
+0001c180: 6422 3a22 656e 6422 7d27 290a 2020 2020  d":"end"}').    
+0001c190: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+0001c1a0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+0001c1b0: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+0001c1c0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0001c1d0: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+0001c1e0: 7865 6328 5b27 6361 7427 5d2c 2073 7464  xec(['cat'], std
+0001c1f0: 696e 3d27 666f 6f5c 6e62 6172 5c6e 2729  in='foo\nbar\n')
+0001c200: 0a20 2020 2020 2020 206f 7574 2c20 6572  .        out, er
+0001c210: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+0001c220: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+0001c230: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001c240: 616c 286f 7574 2c20 2727 290a 2020 2020  al(out, '').    
+0001c250: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c260: 7175 616c 2865 7272 2c20 2727 290a 2020  qual(err, '').  
+0001c270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c280: 7454 7275 6528 7261 6973 6564 290a 0a20  tTrue(raised).. 
+0001c290: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c2a0: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+0001c2b0: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+0001c2c0: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
+0001c2d0: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
+0001c2e0: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
+0001c2f0: 645f 6578 6563 5f64 6174 6128 5b27 6361  d_exec_data(['ca
+0001c300: 7427 5d29 292c 0a20 2020 2020 2020 2020  t'])),.         
+0001c310: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0001c320: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
+0001c330: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+0001c340: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+0001c350: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
+0001c360: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c370: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
+0001c380: 2c20 5b5d 290a 0a20 2020 2023 2059 6f75  , [])..    # You
+0001c390: 2764 206e 6f72 6d61 6c6c 7920 7573 6520  'd normally use 
+0001c3a0: 7079 7465 7374 2e6d 6172 6b2e 6669 6c74  pytest.mark.filt
+0001c3b0: 6572 7761 726e 696e 6773 2061 7320 6120  erwarnings as a 
+0001c3c0: 6465 636f 7261 746f 722c 2062 7574 0a20  decorator, but. 
+0001c3d0: 2020 2023 2050 7974 6573 7455 6e68 616e     # PytestUnhan
+0001c3e0: 646c 6564 5468 7265 6164 4578 6365 7074  dledThreadExcept
+0001c3f0: 696f 6e57 6172 6e69 6e67 2069 736e 2774  ionWarning isn't
+0001c400: 2070 7265 7365 6e74 206f 6e20 6f6c 6465   present on olde
+0001c410: 7220 5079 7468 6f6e 2076 6572 7369 6f6e  r Python version
+0001c420: 732e 0a20 2020 2069 6620 6861 7361 7474  s..    if hasatt
+0001c430: 7228 7079 7465 7374 2c20 2750 7974 6573  r(pytest, 'Pytes
+0001c440: 7455 6e68 616e 646c 6564 5468 7265 6164  tUnhandledThread
+0001c450: 4578 6365 7074 696f 6e57 6172 6e69 6e67  ExceptionWarning
+0001c460: 2729 3a0a 2020 2020 2020 2020 7465 7374  '):.        test
+0001c470: 5f77 6562 736f 636b 6574 5f73 656e 645f  _websocket_send_
+0001c480: 7261 6973 6573 203d 2070 7974 6573 742e  raises = pytest.
+0001c490: 6d61 726b 2e66 696c 7465 7277 6172 6e69  mark.filterwarni
+0001c4a0: 6e67 7328 0a20 2020 2020 2020 2020 2020  ngs(.           
+0001c4b0: 2027 6967 6e6f 7265 3a3a 7079 7465 7374   'ignore::pytest
+0001c4c0: 2e50 7974 6573 7455 6e68 616e 646c 6564  .PytestUnhandled
+0001c4d0: 5468 7265 6164 4578 6365 7074 696f 6e57  ThreadExceptionW
+0001c4e0: 6172 6e69 6e67 2729 2874 6573 745f 7765  arning')(test_we
+0001c4f0: 6273 6f63 6b65 745f 7365 6e64 5f72 6169  bsocket_send_rai
+0001c500: 7365 7329 0a0a 2020 2020 6465 6620 7465  ses)..    def te
+0001c510: 7374 5f77 6562 736f 636b 6574 5f72 6563  st_websocket_rec
+0001c520: 765f 7261 6973 6573 2873 656c 6629 3a0a  v_raises(self):.
+0001c530: 2020 2020 2020 2020 7374 6469 6f2c 2073          stdio, s
+0001c540: 7464 6572 722c 205f 203d 2073 656c 662e  tderr, _ = self.
+0001c550: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
+0001c560: 3233 272c 2030 290a 2020 2020 2020 2020  23', 0).        
+0001c570: 7261 6973 6564 203d 2046 616c 7365 0a0a  raised = False..
+0001c580: 2020 2020 2020 2020 6465 6620 7265 6376          def recv
+0001c590: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001c5a0: 6e6f 6e6c 6f63 616c 2072 6169 7365 640a  nonlocal raised.
+0001c5b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c5c0: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
+0001c5d0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+0001c5e0: 7074 696f 6e28 2761 2073 696d 756c 6174  ption('a simulat
+0001c5f0: 6564 2065 7272 6f72 2127 290a 0a20 2020  ed error!')..   
+0001c600: 2020 2020 2073 7464 696f 2e72 6563 7620       stdio.recv 
+0001c610: 3d20 7265 6376 0a20 2020 2020 2020 2073  = recv.        s
+0001c620: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
+0001c630: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+0001c640: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
+0001c650: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
+0001c660: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
+0001c670: 2763 6174 275d 2c20 7374 6469 6e3d 2766  'cat'], stdin='f
+0001c680: 6f6f 5c6e 6261 725c 6e27 290a 2020 2020  oo\nbar\n').    
+0001c690: 2020 2020 6f75 742c 2065 7272 203d 2070      out, err = p
+0001c6a0: 726f 6365 7373 2e77 6169 745f 6f75 7470  rocess.wait_outp
+0001c6b0: 7574 2829 0a20 2020 2020 2020 2073 656c  ut().        sel
+0001c6c0: 662e 6173 7365 7274 4571 7561 6c28 6f75  f.assertEqual(ou
+0001c6d0: 742c 2027 2729 0a20 2020 2020 2020 2073  t, '').        s
+0001c6e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001c6f0: 6572 722c 2027 2729 0a20 2020 2020 2020  err, '').       
+0001c700: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0001c710: 2872 6169 7365 6429 0a0a 2020 2020 2020  (raised)..      
+0001c720: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001c730: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+0001c740: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0001c750: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+0001c760: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
+0001c770: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
+0001c780: 635f 6461 7461 285b 2763 6174 275d 2929  c_data(['cat']))
+0001c790: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+0001c7a0: 4745 5427 2c20 272f 7631 2f63 6861 6e67  GET', '/v1/chang
+0001c7b0: 6573 2f31 3233 2f77 6169 7427 2c20 7b27  es/123/wait', {'
+0001c7c0: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
+0001c7d0: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0001c7e0: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
+0001c7f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001c800: 7374 6469 6f2e 7365 6e64 732c 205b 0a20  stdio.sends, [. 
+0001c810: 2020 2020 2020 2020 2020 2028 2742 494e             ('BIN
+0001c820: 272c 2062 2766 6f6f 5c6e 6261 725c 6e27  ', b'foo\nbar\n'
+0001c830: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0001c840: 2754 5854 272c 2027 7b22 636f 6d6d 616e  'TXT', '{"comman
+0001c850: 6422 3a22 656e 6422 7d27 292c 0a20 2020  d":"end"}'),.   
+0001c860: 2020 2020 205d 290a 0a20 2020 2069 6620       ])..    if 
+0001c870: 6861 7361 7474 7228 7079 7465 7374 2c20  hasattr(pytest, 
+0001c880: 2750 7974 6573 7455 6e68 616e 646c 6564  'PytestUnhandled
+0001c890: 5468 7265 6164 4578 6365 7074 696f 6e57  ThreadExceptionW
+0001c8a0: 6172 6e69 6e67 2729 3a0a 2020 2020 2020  arning'):.      
+0001c8b0: 2020 7465 7374 5f77 6562 736f 636b 6574    test_websocket
+0001c8c0: 5f72 6563 765f 7261 6973 6573 203d 2070  _recv_raises = p
+0001c8d0: 7974 6573 742e 6d61 726b 2e66 696c 7465  ytest.mark.filte
+0001c8e0: 7277 6172 6e69 6e67 7328 0a20 2020 2020  rwarnings(.     
+0001c8f0: 2020 2020 2020 2027 6967 6e6f 7265 3a3a         'ignore::
+0001c900: 7079 7465 7374 2e50 7974 6573 7455 6e68  pytest.PytestUnh
+0001c910: 616e 646c 6564 5468 7265 6164 4578 6365  andledThreadExce
+0001c920: 7074 696f 6e57 6172 6e69 6e67 2729 2874  ptionWarning')(t
+0001c930: 6573 745f 7765 6273 6f63 6b65 745f 7265  est_websocket_re
+0001c940: 6376 5f72 6169 7365 7329 0a0a 0a23 2053  cv_raises)...# S
+0001c950: 6574 2074 6865 2052 554e 5f52 4541 4c5f  et the RUN_REAL_
+0001c960: 5045 4242 4c45 5f54 4553 5453 2065 6e76  PEBBLE_TESTS env
+0001c970: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
+0001c980: 6520 746f 2072 756e 2074 6865 7365 2074  e to run these t
+0001c990: 6573 7473 0a23 2061 6761 696e 7374 2061  ests.# against a
+0001c9a0: 2072 6561 6c20 5065 6262 6c65 2073 6572   real Pebble ser
+0001c9b0: 7665 722e 2046 6f72 2065 7861 6d70 6c65  ver. For example
+0001c9c0: 2c20 696e 206f 6e65 2074 6572 6d69 6e61  , in one termina
+0001c9d0: 6c2c 2072 756e 2050 6562 626c 653a 0a23  l, run Pebble:.#
+0001c9e0: 0a23 2024 2050 4542 424c 453d 7e2f 7065  .# $ PEBBLE=~/pe
+0001c9f0: 6262 6c65 2070 6562 626c 6520 7275 6e20  bble pebble run 
+0001ca00: 2d2d 6874 7470 3d3a 3430 3030 0a23 2032  --http=:4000.# 2
+0001ca10: 3032 312d 3039 2d32 3054 3034 3a31 303a  021-09-20T04:10:
+0001ca20: 3334 2e39 3334 5a20 5b70 6562 626c 655d  34.934Z [pebble]
+0001ca30: 2053 7461 7274 6564 2064 6165 6d6f 6e0a   Started daemon.
+0001ca40: 230a 2320 496e 2061 6e6f 7468 6572 2074  #.# In another t
+0001ca50: 6572 6d69 6e61 6c2c 2072 756e 2074 6865  erminal, run the
+0001ca60: 2074 6573 7473 3a0a 230a 2320 2420 736f   tests:.#.# $ so
+0001ca70: 7572 6365 202e 746f 782f 756e 6974 2f62  urce .tox/unit/b
+0001ca80: 696e 2f61 6374 6976 6174 650a 2320 2420  in/activate.# $ 
+0001ca90: 5255 4e5f 5245 414c 5f50 4542 424c 455f  RUN_REAL_PEBBLE_
+0001caa0: 5445 5354 533d 3120 5045 4242 4c45 3d7e  TESTS=1 PEBBLE=~
+0001cab0: 2f70 6562 626c 6520 7079 7465 7374 2074  /pebble pytest t
+0001cac0: 6573 742f 7465 7374 5f70 6562 626c 652e  est/test_pebble.
+0001cad0: 7079 202d 7620 2d6b 2052 6561 6c50 6562  py -v -k RealPeb
+0001cae0: 626c 650a 2320 2420 6465 6163 7469 7661  ble.# $ deactiva
+0001caf0: 7465 0a23 0a40 756e 6974 7465 7374 2e73  te.#.@unittest.s
+0001cb00: 6b69 7055 6e6c 6573 7328 6f73 2e67 6574  kipUnless(os.get
+0001cb10: 656e 7628 2752 554e 5f52 4541 4c5f 5045  env('RUN_REAL_PE
+0001cb20: 4242 4c45 5f54 4553 5453 2729 2c20 2752  BBLE_TESTS'), 'R
+0001cb30: 554e 5f52 4541 4c5f 5045 4242 4c45 5f54  UN_REAL_PEBBLE_T
+0001cb40: 4553 5453 206e 6f74 2073 6574 2729 0a63  ESTS not set').c
+0001cb50: 6c61 7373 2054 6573 7452 6561 6c50 6562  lass TestRealPeb
+0001cb60: 626c 6528 756e 6974 7465 7374 2e54 6573  ble(unittest.Tes
+0001cb70: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+0001cb80: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
+0001cb90: 2020 2020 2073 6f63 6b65 745f 7061 7468       socket_path
+0001cba0: 203d 206f 732e 6765 7465 6e76 2827 5045   = os.getenv('PE
+0001cbb0: 4242 4c45 5f53 4f43 4b45 5427 290a 2020  BBLE_SOCKET').  
+0001cbc0: 2020 2020 2020 6966 206e 6f74 2073 6f63        if not soc
+0001cbd0: 6b65 745f 7061 7468 2061 6e64 206f 732e  ket_path and os.
+0001cbe0: 6765 7465 6e76 2827 5045 4242 4c45 2729  getenv('PEBBLE')
+0001cbf0: 3a0a 2020 2020 2020 2020 2020 2020 736f  :.            so
+0001cc00: 636b 6574 5f70 6174 6820 3d20 6f73 2e70  cket_path = os.p
+0001cc10: 6174 682e 6a6f 696e 286f 732e 6765 7465  ath.join(os.gete
+0001cc20: 6e76 2827 5045 4242 4c45 2729 2c20 272e  nv('PEBBLE'), '.
+0001cc30: 7065 6262 6c65 2e73 6f63 6b65 7427 290a  pebble.socket').
+0001cc40: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0001cc50: 6f63 6b65 745f 7061 7468 2c20 2750 4542  ocket_path, 'PEB
+0001cc60: 424c 4520 6f72 2050 4542 424c 455f 534f  BLE or PEBBLE_SO
+0001cc70: 434b 4554 206d 7573 7420 6265 2073 6574  CKET must be set
+0001cc80: 2069 6620 5255 4e5f 5245 414c 5f50 4542   if RUN_REAL_PEB
+0001cc90: 424c 455f 5445 5354 5320 7365 7427 0a0a  BLE_TESTS set'..
+0001cca0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0001ccb0: 656e 7420 3d20 7065 6262 6c65 2e43 6c69  ent = pebble.Cli
+0001ccc0: 656e 7428 736f 636b 6574 5f70 6174 683d  ent(socket_path=
+0001ccd0: 736f 636b 6574 5f70 6174 6829 0a0a 2020  socket_path)..  
+0001cce0: 2020 6465 6620 7465 7374 5f63 6865 636b    def test_check
+0001ccf0: 735f 616e 645f 6865 616c 7468 2873 656c  s_and_health(sel
+0001cd00: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0001cd10: 2e63 6c69 656e 742e 6164 645f 6c61 7965  .client.add_laye
+0001cd20: 7228 276c 6179 6572 272c 207b 0a20 2020  r('layer', {.   
+0001cd30: 2020 2020 2020 2020 2027 6368 6563 6b73           'checks
+0001cd40: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0001cd50: 2020 2020 2027 6261 6427 3a20 7b0a 2020       'bad': {.  
+0001cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd70: 2020 276f 7665 7272 6964 6527 3a20 2772    'override': 'r
+0001cd80: 6570 6c61 6365 272c 0a20 2020 2020 2020  eplace',.       
+0001cd90: 2020 2020 2020 2020 2020 2020 2027 6c65               'le
+0001cda0: 7665 6c27 3a20 2772 6561 6479 272c 0a20  vel': 'ready',. 
+0001cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdc0: 2020 2027 7065 7269 6f64 273a 2027 3530     'period': '50
+0001cdd0: 6d73 272c 0a20 2020 2020 2020 2020 2020  ms',.           
+0001cde0: 2020 2020 2020 2020 2027 7468 7265 7368           'thresh
+0001cdf0: 6f6c 6427 3a20 322c 0a20 2020 2020 2020  old': 2,.       
+0001ce00: 2020 2020 2020 2020 2020 2020 2027 6578               'ex
+0001ce10: 6563 273a 207b 0a20 2020 2020 2020 2020  ec': {.         
+0001ce20: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001ce30: 636f 6d6d 616e 6427 3a20 2773 6c65 6570  command': 'sleep
+0001ce40: 2078 272c 0a20 2020 2020 2020 2020 2020   x',.           
+0001ce50: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0001ce60: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+0001ce70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001ce80: 676f 6f64 273a 207b 0a20 2020 2020 2020  good': {.       
+0001ce90: 2020 2020 2020 2020 2020 2020 2027 6f76               'ov
+0001cea0: 6572 7269 6465 273a 2027 7265 706c 6163  erride': 'replac
+0001ceb0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0001cec0: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+0001ced0: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
+0001cee0: 2020 2020 2020 2020 2020 2020 2020 2770                'p
+0001cef0: 6572 696f 6427 3a20 2735 306d 7327 2c0a  eriod': '50ms',.
+0001cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf10: 2020 2020 2765 7865 6327 3a20 7b0a 2020      'exec': {.  
+0001cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf30: 2020 2020 2020 2763 6f6d 6d61 6e64 273a        'command':
+0001cf40: 2027 6563 686f 2066 6f6f 272c 0a20 2020   'echo foo',.   
+0001cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf60: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+0001cf70: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0001cf80: 2020 2020 2020 2027 6f74 6865 7227 3a20         'other': 
+0001cf90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0001cfa0: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
+0001cfb0: 3a20 2772 6570 6c61 6365 272c 0a20 2020  : 'replace',.   
+0001cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cfd0: 2027 6578 6563 273a 207b 0a20 2020 2020   'exec': {.     
+0001cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cff0: 2020 2027 636f 6d6d 616e 6427 3a20 2765     'command': 'e
+0001d000: 6368 6f20 6261 7227 2c0a 2020 2020 2020  cho bar',.      
+0001d010: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+0001d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d030: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+0001d040: 7d2c 0a20 2020 2020 2020 207d 2c20 636f  },.        }, co
+0001d050: 6d62 696e 653d 5472 7565 290a 0a20 2020  mbine=True)..   
+0001d060: 2020 2020 2023 2043 6865 636b 7320 7368       # Checks sh
+0001d070: 6f75 6c64 2061 6c6c 2062 6520 2275 7022  ould all be "up"
+0001d080: 2069 6e69 7469 616c 6c79 0a20 2020 2020   initially.     
+0001d090: 2020 2063 6865 636b 7320 3d20 7365 6c66     checks = self
+0001d0a0: 2e63 6c69 656e 742e 6765 745f 6368 6563  .client.get_chec
+0001d0b0: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
+0001d0c0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+0001d0d0: 6e28 6368 6563 6b73 292c 2033 290a 2020  n(checks), 3).  
+0001d0e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d0f0: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+0001d100: 2e6e 616d 652c 2027 6261 6427 290a 2020  .name, 'bad').  
+0001d110: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d120: 7445 7175 616c 2863 6865 636b 735b 305d  tEqual(checks[0]
+0001d130: 2e6c 6576 656c 2c20 7065 6262 6c65 2e43  .level, pebble.C
+0001d140: 6865 636b 4c65 7665 6c2e 5245 4144 5929  heckLevel.READY)
+0001d150: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d160: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+0001d170: 5b30 5d2e 7374 6174 7573 2c20 7065 6262  [0].status, pebb
+0001d180: 6c65 2e43 6865 636b 5374 6174 7573 2e55  le.CheckStatus.U
+0001d190: 5029 0a20 2020 2020 2020 2073 656c 662e  P).        self.
+0001d1a0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+0001d1b0: 6b73 5b31 5d2e 6e61 6d65 2c20 2767 6f6f  ks[1].name, 'goo
+0001d1c0: 6427 290a 2020 2020 2020 2020 7365 6c66  d').        self
+0001d1d0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0001d1e0: 636b 735b 315d 2e6c 6576 656c 2c20 7065  cks[1].level, pe
+0001d1f0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+0001d200: 414c 4956 4529 0a20 2020 2020 2020 2073  ALIVE).        s
+0001d210: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d220: 6368 6563 6b73 5b31 5d2e 7374 6174 7573  checks[1].status
+0001d230: 2c20 7065 6262 6c65 2e43 6865 636b 5374  , pebble.CheckSt
+0001d240: 6174 7573 2e55 5029 0a20 2020 2020 2020  atus.UP).       
+0001d250: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d260: 6c28 6368 6563 6b73 5b32 5d2e 6e61 6d65  l(checks[2].name
+0001d270: 2c20 276f 7468 6572 2729 0a20 2020 2020  , 'other').     
+0001d280: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001d290: 7561 6c28 6368 6563 6b73 5b32 5d2e 6c65  ual(checks[2].le
+0001d2a0: 7665 6c2c 2070 6562 626c 652e 4368 6563  vel, pebble.Chec
+0001d2b0: 6b4c 6576 656c 2e55 4e53 4554 290a 2020  kLevel.UNSET).  
+0001d2c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d2d0: 7445 7175 616c 2863 6865 636b 735b 325d  tEqual(checks[2]
+0001d2e0: 2e73 7461 7475 732c 2070 6562 626c 652e  .status, pebble.
+0001d2f0: 4368 6563 6b53 7461 7475 732e 5550 290a  CheckStatus.UP).
+0001d300: 0a20 2020 2020 2020 2023 2041 6e64 202f  .        # And /
+0001d310: 7631 2f68 6561 6c74 6820 7368 6f75 6c64  v1/health should
+0001d320: 2072 6574 7572 6e20 2268 6561 6c74 6879   return "healthy
+0001d330: 220a 2020 2020 2020 2020 6865 616c 7468  ".        health
+0001d340: 203d 2073 656c 662e 5f67 6574 5f68 6561   = self._get_hea
+0001d350: 6c74 6828 290a 2020 2020 2020 2020 7365  lth().        se
+0001d360: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+0001d370: 6561 6c74 682c 207b 0a20 2020 2020 2020  ealth, {.       
+0001d380: 2020 2020 2027 7265 7375 6c74 273a 207b       'result': {
+0001d390: 2768 6561 6c74 6879 273a 2054 7275 657d  'healthy': True}
+0001d3a0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001d3b0: 7461 7475 7327 3a20 274f 4b27 2c0a 2020  tatus': 'OK',.  
+0001d3c0: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+0001d3d0: 732d 636f 6465 273a 2032 3030 2c0a 2020  s-code': 200,.  
+0001d3e0: 2020 2020 2020 2020 2020 2774 7970 6527            'type'
+0001d3f0: 3a20 2773 796e 6327 2c0a 2020 2020 2020  : 'sync',.      
+0001d400: 2020 7d29 0a0a 2020 2020 2020 2020 2320    })..        # 
+0001d410: 4166 7465 7220 7477 6f20 7265 7472 6965  After two retrie
+0001d420: 7320 7468 6520 2262 6164 2220 6368 6563  s the "bad" chec
+0001d430: 6b20 7368 6f75 6c64 2067 6f20 646f 776e  k should go down
+0001d440: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+0001d450: 6e20 7261 6e67 6528 3529 3a0a 2020 2020  n range(5):.    
+0001d460: 2020 2020 2020 2020 6368 6563 6b73 203d          checks =
+0001d470: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
+0001d480: 5f63 6865 636b 7328 290a 2020 2020 2020  _checks().      
+0001d490: 2020 2020 2020 6261 645f 6368 6563 6b20        bad_check 
+0001d4a0: 3d20 5b63 2066 6f72 2063 2069 6e20 6368  = [c for c in ch
+0001d4b0: 6563 6b73 2069 6620 632e 6e61 6d65 203d  ecks if c.name =
+0001d4c0: 3d20 2762 6164 275d 5b30 5d0a 2020 2020  = 'bad'][0].    
+0001d4d0: 2020 2020 2020 2020 6966 2062 6164 5f63          if bad_c
+0001d4e0: 6865 636b 2e73 7461 7475 7320 3d3d 2070  heck.status == p
+0001d4f0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+0001d500: 732e 444f 574e 3a0a 2020 2020 2020 2020  s.DOWN:.        
+0001d510: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0001d520: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
+0001d530: 6c65 6570 2830 2e30 3629 0a20 2020 2020  leep(0.06).     
+0001d540: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001d550: 2020 2020 2061 7373 6572 7420 4661 6c73       assert Fals
+0001d560: 652c 2027 7469 6d65 6420 6f75 7420 7761  e, 'timed out wa
+0001d570: 6974 696e 6720 666f 7220 2262 6164 2220  iting for "bad" 
+0001d580: 6368 6563 6b20 746f 2067 6f20 646f 776e  check to go down
+0001d590: 270a 2020 2020 2020 2020 7365 6c66 2e61  '.        self.a
+0001d5a0: 7373 6572 7445 7175 616c 2862 6164 5f63  ssertEqual(bad_c
+0001d5b0: 6865 636b 2e66 6169 6c75 7265 732c 2032  heck.failures, 2
+0001d5c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001d5d0: 7373 6572 7445 7175 616c 2862 6164 5f63  ssertEqual(bad_c
+0001d5e0: 6865 636b 2e74 6872 6573 686f 6c64 2c20  heck.threshold, 
+0001d5f0: 3229 0a20 2020 2020 2020 2067 6f6f 645f  2).        good_
+0001d600: 6368 6563 6b20 3d20 5b63 2066 6f72 2063  check = [c for c
+0001d610: 2069 6e20 6368 6563 6b73 2069 6620 632e   in checks if c.
+0001d620: 6e61 6d65 203d 3d20 2767 6f6f 6427 5d5b  name == 'good'][
+0001d630: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+0001d640: 6173 7365 7274 4571 7561 6c28 676f 6f64  assertEqual(good
+0001d650: 5f63 6865 636b 2e73 7461 7475 732c 2070  _check.status, p
+0001d660: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+0001d670: 732e 5550 290a 0a20 2020 2020 2020 2023  s.UP)..        #
+0001d680: 2041 6e64 202f 7631 2f68 6561 6c74 6820   And /v1/health 
+0001d690: 7368 6f75 6c64 2072 6574 7572 6e20 2275  should return "u
+0001d6a0: 6e68 6561 6c74 6879 2220 2877 6974 6820  nhealthy" (with 
+0001d6b0: 7374 6174 7573 2048 5454 5020 3530 3229  status HTTP 502)
+0001d6c0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001d6d0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001d6e0: 7572 6c6c 6962 2e65 7272 6f72 2e48 5454  urllib.error.HTT
+0001d6f0: 5045 7272 6f72 2920 6173 2063 6d3a 0a20  PError) as cm:. 
+0001d700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001d710: 5f67 6574 5f68 6561 6c74 6828 290a 2020  _get_health().  
+0001d720: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001d730: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
+0001d740: 696f 6e2e 636f 6465 2c20 3530 3229 0a20  ion.code, 502). 
+0001d750: 2020 2020 2020 2068 6561 6c74 6820 3d20         health = 
+0001d760: 6a73 6f6e 2e6c 6f61 6473 2863 6d2e 6578  json.loads(cm.ex
+0001d770: 6365 7074 696f 6e2e 7265 6164 2829 290a  ception.read()).
+0001d780: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001d790: 6572 7445 7175 616c 2868 6561 6c74 682c  ertEqual(health,
+0001d7a0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+0001d7b0: 7265 7375 6c74 273a 207b 2768 6561 6c74  result': {'healt
+0001d7c0: 6879 273a 2046 616c 7365 7d2c 0a20 2020  hy': False},.   
+0001d7d0: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+0001d7e0: 273a 2027 4261 6420 4761 7465 7761 7927  ': 'Bad Gateway'
+0001d7f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001d800: 7461 7475 732d 636f 6465 273a 2035 3032  tatus-code': 502
+0001d810: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
+0001d820: 7970 6527 3a20 2773 796e 6327 2c0a 2020  ype': 'sync',.  
+0001d830: 2020 2020 2020 7d29 0a0a 2020 2020 2020        })..      
+0001d840: 2020 2320 5468 656e 2074 6573 7420 6669    # Then test fi
+0001d850: 6c74 6572 696e 6720 6279 2063 6865 636b  ltering by check
+0001d860: 206c 6576 656c 2061 6e64 2062 7920 6e61   level and by na
+0001d870: 6d65 0a20 2020 2020 2020 2063 6865 636b  me.        check
+0001d880: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0001d890: 6765 745f 6368 6563 6b73 286c 6576 656c  get_checks(level
+0001d8a0: 3d70 6562 626c 652e 4368 6563 6b4c 6576  =pebble.CheckLev
+0001d8b0: 656c 2e41 4c49 5645 290a 2020 2020 2020  el.ALIVE).      
+0001d8c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001d8d0: 616c 286c 656e 2863 6865 636b 7329 2c20  al(len(checks), 
+0001d8e0: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
+0001d8f0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+0001d900: 6b73 5b30 5d2e 6e61 6d65 2c20 2767 6f6f  ks[0].name, 'goo
+0001d910: 6427 290a 2020 2020 2020 2020 6368 6563  d').        chec
+0001d920: 6b73 203d 2073 656c 662e 636c 6965 6e74  ks = self.client
+0001d930: 2e67 6574 5f63 6865 636b 7328 6e61 6d65  .get_checks(name
+0001d940: 733d 5b27 676f 6f64 272c 2027 6261 6427  s=['good', 'bad'
+0001d950: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+0001d960: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+0001d970: 6368 6563 6b73 292c 2032 290a 2020 2020  checks), 2).    
+0001d980: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d990: 7175 616c 2863 6865 636b 735b 305d 2e6e  qual(checks[0].n
+0001d9a0: 616d 652c 2027 6261 6427 290a 2020 2020  ame, 'bad').    
+0001d9b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d9c0: 7175 616c 2863 6865 636b 735b 315d 2e6e  qual(checks[1].n
+0001d9d0: 616d 652c 2027 676f 6f64 2729 0a0a 2020  ame, 'good')..  
+0001d9e0: 2020 6465 6620 5f67 6574 5f68 6561 6c74    def _get_healt
+0001d9f0: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+0001da00: 2066 203d 2075 726c 6c69 622e 7265 7175   f = urllib.requ
+0001da10: 6573 742e 7572 6c6f 7065 6e28 2768 7474  est.urlopen('htt
+0001da20: 703a 2f2f 6c6f 6361 6c68 6f73 743a 3430  p://localhost:40
+0001da30: 3030 2f76 312f 6865 616c 7468 2729 0a20  00/v1/health'). 
+0001da40: 2020 2020 2020 2072 6574 7572 6e20 6a73         return js
+0001da50: 6f6e 2e6c 6f61 6473 2866 2e72 6561 6428  on.loads(f.read(
+0001da60: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0001da70: 5f65 7865 635f 7761 6974 2873 656c 6629  _exec_wait(self)
+0001da80: 3a0a 2020 2020 2020 2020 7072 6f63 6573  :.        proces
+0001da90: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0001daa0: 6578 6563 285b 2774 7275 6527 5d29 0a20  exec(['true']). 
+0001dab0: 2020 2020 2020 2070 726f 6365 7373 2e77         process.w
+0001dac0: 6169 7428 290a 0a20 2020 2020 2020 2077  ait()..        w
+0001dad0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0001dae0: 6169 7365 7328 7065 6262 6c65 2e45 7865  aises(pebble.Exe
+0001daf0: 6345 7272 6f72 2920 6173 2063 6d3a 0a20  cError) as cm:. 
+0001db00: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+0001db10: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+0001db20: 2e65 7865 6328 5b27 2f62 696e 2f73 6827  .exec(['/bin/sh'
+0001db30: 2c20 272d 6327 2c20 2765 7869 7420 3432  , '-c', 'exit 42
+0001db40: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
+0001db50: 7072 6f63 6573 732e 7761 6974 2829 0a20  process.wait(). 
+0001db60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001db70: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+0001db80: 7469 6f6e 2e65 7869 745f 636f 6465 2c20  tion.exit_code, 
+0001db90: 3432 290a 0a20 2020 2064 6566 2074 6573  42)..    def tes
+0001dba0: 745f 6578 6563 5f77 6169 745f 6f75 7470  t_exec_wait_outp
+0001dbb0: 7574 2873 656c 6629 3a0a 2020 2020 2020  ut(self):.      
+0001dbc0: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
+0001dbd0: 2e63 6c69 656e 742e 6578 6563 285b 272f  .client.exec(['/
+0001dbe0: 6269 6e2f 7368 272c 2027 2d63 272c 2027  bin/sh', '-c', '
+0001dbf0: 6563 686f 204f 5554 3b20 6563 686f 2045  echo OUT; echo E
+0001dc00: 5252 203e 2632 275d 290a 2020 2020 2020  RR >&2']).      
+0001dc10: 2020 6f75 742c 2065 7272 203d 2070 726f    out, err = pro
+0001dc20: 6365 7373 2e77 6169 745f 6f75 7470 7574  cess.wait_output
+0001dc30: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001dc40: 6173 7365 7274 4571 7561 6c28 6f75 742c  assertEqual(out,
+0001dc50: 2027 4f55 545c 6e27 290a 2020 2020 2020   'OUT\n').      
+0001dc60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001dc70: 616c 2865 7272 2c20 2745 5252 5c6e 2729  al(err, 'ERR\n')
+0001dc80: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+0001dc90: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0001dca0: 6578 6563 285b 272f 6269 6e2f 7368 272c  exec(['/bin/sh',
+0001dcb0: 2027 2d63 272c 2027 6563 686f 204f 5554   '-c', 'echo OUT
+0001dcc0: 3b20 6563 686f 2045 5252 203e 2632 275d  ; echo ERR >&2']
+0001dcd0: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+0001dce0: 0a20 2020 2020 2020 206f 7574 2c20 6572  .        out, er
+0001dcf0: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+0001dd00: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+0001dd10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001dd20: 616c 286f 7574 2c20 6227 4f55 545c 6e27  al(out, b'OUT\n'
+0001dd30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001dd40: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
+0001dd50: 6227 4552 525c 6e27 290a 0a20 2020 2020  b'ERR\n')..     
+0001dd60: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0001dd70: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
+0001dd80: 2e45 7865 6345 7272 6f72 2920 6173 2063  .ExecError) as c
+0001dd90: 6d3a 0a20 2020 2020 2020 2020 2020 2070  m:.            p
+0001dda0: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+0001ddb0: 6965 6e74 2e65 7865 6328 5b27 2f62 696e  ient.exec(['/bin
+0001ddc0: 2f73 6827 2c20 272d 6327 2c20 2765 6368  /sh', '-c', 'ech
+0001ddd0: 6f20 4f55 543b 2065 6368 6f20 4552 5220  o OUT; echo ERR 
+0001dde0: 3e26 323b 2065 7869 7420 3432 275d 290a  >&2; exit 42']).
+0001ddf0: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0001de00: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
+0001de10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001de20: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+0001de30: 6365 7074 696f 6e2e 6578 6974 5f63 6f64  ception.exit_cod
+0001de40: 652c 2034 3229 0a20 2020 2020 2020 2073  e, 42).        s
+0001de50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001de60: 636d 2e65 7863 6570 7469 6f6e 2e73 7464  cm.exception.std
+0001de70: 6f75 742c 2027 4f55 545c 6e27 290a 2020  out, 'OUT\n').  
+0001de80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001de90: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
+0001dea0: 696f 6e2e 7374 6465 7272 2c20 2745 5252  ion.stderr, 'ERR
+0001deb0: 5c6e 2729 0a0a 2020 2020 6465 6620 7465  \n')..    def te
+0001dec0: 7374 5f65 7865 635f 7365 6e64 5f73 7464  st_exec_send_std
+0001ded0: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
+0001dee0: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
+0001def0: 2e63 6c69 656e 742e 6578 6563 285b 2761  .client.exec(['a
+0001df00: 776b 272c 2027 7b20 7072 696e 7420 746f  wk', '{ print to
+0001df10: 7570 7065 7228 2430 2920 7d27 5d2c 2073  upper($0) }'], s
+0001df20: 7464 696e 3d27 666f 6f5c 6e42 6172 5c6e  tdin='foo\nBar\n
+0001df30: 2729 0a20 2020 2020 2020 206f 7574 2c20  ').        out, 
+0001df40: 6572 7220 3d20 7072 6f63 6573 732e 7761  err = process.wa
+0001df50: 6974 5f6f 7574 7075 7428 290a 2020 2020  it_output().    
+0001df60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001df70: 7175 616c 286f 7574 2c20 2746 4f4f 5c6e  qual(out, 'FOO\n
+0001df80: 4241 525c 6e27 290a 2020 2020 2020 2020  BAR\n').        
+0001df90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001dfa0: 2865 7272 2c20 2727 290a 0a20 2020 2020  (err, '')..     
+0001dfb0: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
+0001dfc0: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
+0001dfd0: 6177 6b27 2c20 277b 2070 7269 6e74 2074  awk', '{ print t
+0001dfe0: 6f75 7070 6572 2824 3029 207d 275d 2c20  oupper($0) }'], 
+0001dff0: 7374 6469 6e3d 6227 666f 6f5c 6e42 6172  stdin=b'foo\nBar
+0001e000: 5c6e 272c 0a20 2020 2020 2020 2020 2020  \n',.           
+0001e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e020: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
+0001e030: 3d4e 6f6e 6529 0a20 2020 2020 2020 206f  =None).        o
+0001e040: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+0001e050: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
 0001e060: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001e070: 6572 7445 7175 616c 2864 6174 612c 2063  ertEqual(data, c
-0001e080: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
-0001e090: 6f73 2e72 656d 6f76 6528 666e 616d 6529  os.remove(fname)
-0001e0a0: 0a0a 2020 2020 6465 6620 7465 7374 5f65  ..    def test_e
-0001e0b0: 7865 635f 7469 6d65 6f75 7428 7365 6c66  xec_timeout(self
-0001e0c0: 293a 0a20 2020 2020 2020 2070 726f 6365  ):.        proce
-0001e0d0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
-0001e0e0: 2e65 7865 6328 5b27 736c 6565 7027 2c20  .exec(['sleep', 
-0001e0f0: 2730 2e32 275d 2c20 7469 6d65 6f75 743d  '0.2'], timeout=
-0001e100: 302e 3129 0a20 2020 2020 2020 2077 6974  0.1).        wit
-0001e110: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0001e120: 7365 7328 7065 6262 6c65 2e43 6861 6e67  ses(pebble.Chang
-0001e130: 6545 7272 6f72 2920 6173 2063 6d3a 0a20  eError) as cm:. 
-0001e140: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-0001e150: 7373 2e77 6169 7428 290a 2020 2020 2020  ss.wait().      
-0001e160: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
-0001e170: 2774 696d 6564 206f 7574 272c 2063 6d2e  'timed out', cm.
-0001e180: 6578 6365 7074 696f 6e2e 6572 7229 0a0a  exception.err)..
-0001e190: 2020 2020 6465 6620 7465 7374 5f65 7865      def test_exe
-0001e1a0: 635f 776f 726b 696e 675f 6469 7228 7365  c_working_dir(se
-0001e1b0: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
-0001e1c0: 6820 7465 6d70 6669 6c65 2e54 656d 706f  h tempfile.Tempo
-0001e1d0: 7261 7279 4469 7265 6374 6f72 7928 2920  raryDirectory() 
-0001e1e0: 6173 2074 656d 705f 6469 723a 0a20 2020  as temp_dir:.   
-0001e1f0: 2020 2020 2020 2020 2070 726f 6365 7373           process
-0001e200: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-0001e210: 7865 6328 5b27 7077 6427 5d2c 2077 6f72  xec(['pwd'], wor
-0001e220: 6b69 6e67 5f64 6972 3d74 656d 705f 6469  king_dir=temp_di
-0001e230: 7229 0a20 2020 2020 2020 2020 2020 206f  r).            o
-0001e240: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-0001e250: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-0001e260: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e270: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
-0001e280: 2c20 6622 7b74 656d 705f 6469 727d 5c6e  , f"{temp_dir}\n
-0001e290: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
-0001e2a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001e2b0: 6572 722c 2027 2729 0a0a 2020 2020 6465  err, '')..    de
-0001e2c0: 6620 7465 7374 5f65 7865 635f 656e 7669  f test_exec_envi
-0001e2d0: 726f 6e6d 656e 7428 7365 6c66 293a 0a20  ronment(self):. 
-0001e2e0: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-0001e2f0: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-0001e300: 6328 5b27 2f62 696e 2f73 6827 2c20 272d  c(['/bin/sh', '-
-0001e310: 6327 2c20 2765 6368 6f20 244f 4e45 2e24  c', 'echo $ONE.$
-0001e320: 5457 4f2e 2454 4852 4545 275d 2c0a 2020  TWO.$THREE'],.  
-0001e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e350: 2065 6e76 6972 6f6e 6d65 6e74 3d7b 274f   environment={'O
-0001e360: 4e45 273a 2027 3127 2c20 2754 574f 273a  NE': '1', 'TWO':
-0001e370: 2027 3227 7d29 0a20 2020 2020 2020 206f   '2'}).        o
-0001e380: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-0001e390: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-0001e3a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001e3b0: 6572 7445 7175 616c 286f 7574 2c20 2731  ertEqual(out, '1
-0001e3c0: 2e32 2e5c 6e27 290a 2020 2020 2020 2020  .2.\n').        
-0001e3d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001e3e0: 2865 7272 2c20 2727 290a 0a20 2020 2064  (err, '')..    d
-0001e3f0: 6566 2074 6573 745f 6578 6563 5f73 7472  ef test_exec_str
-0001e400: 6561 6d69 6e67 2873 656c 6629 3a0a 2020  eaming(self):.  
-0001e410: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
-0001e420: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-0001e430: 285b 2763 6174 275d 290a 0a20 2020 2020  (['cat'])..     
-0001e440: 2020 2064 6566 2073 7464 696e 5f74 6872     def stdin_thr
-0001e450: 6561 6428 293a 0a20 2020 2020 2020 2020  ead():.         
-0001e460: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001e470: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
-0001e480: 2069 6e20 5b27 6f6e 655c 6e27 2c20 2732   in ['one\n', '2
-0001e490: 5c6e 272c 2027 5448 5245 455c 6e27 5d3a  \n', 'THREE\n']:
-0001e4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e4b0: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
-0001e4c0: 696e 2e77 7269 7465 286c 696e 6529 0a20  in.write(line). 
-0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4e0: 2020 2070 726f 6365 7373 2e73 7464 696e     process.stdin
-0001e4f0: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
-0001e500: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-0001e510: 652e 736c 6565 7028 302e 3129 0a20 2020  e.sleep(0.1).   
-0001e520: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
-0001e530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e540: 2020 7072 6f63 6573 732e 7374 6469 6e2e    process.stdin.
-0001e550: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
-0001e560: 2074 6872 6561 6469 6e67 2e54 6872 6561   threading.Threa
-0001e570: 6428 7461 7267 6574 3d73 7464 696e 5f74  d(target=stdin_t
-0001e580: 6872 6561 6429 2e73 7461 7274 2829 0a0a  hread).start()..
-0001e590: 2020 2020 2020 2020 7265 6164 7320 3d20          reads = 
-0001e5a0: 5b5d 0a20 2020 2020 2020 2066 6f72 206c  [].        for l
-0001e5b0: 696e 6520 696e 2070 726f 6365 7373 2e73  ine in process.s
-0001e5c0: 7464 6f75 743a 0a20 2020 2020 2020 2020  tdout:.         
-0001e5d0: 2020 2072 6561 6473 2e61 7070 656e 6428     reads.append(
-0001e5e0: 6c69 6e65 290a 0a20 2020 2020 2020 2070  line)..        p
-0001e5f0: 726f 6365 7373 2e77 6169 7428 290a 0a20  rocess.wait().. 
-0001e600: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001e610: 7274 4571 7561 6c28 7265 6164 732c 205b  rtEqual(reads, [
-0001e620: 276f 6e65 5c6e 272c 2027 325c 6e27 2c20  'one\n', '2\n', 
-0001e630: 2754 4852 4545 5c6e 275d 290a 0a20 2020  'THREE\n'])..   
-0001e640: 2064 6566 2074 6573 745f 6578 6563 5f73   def test_exec_s
-0001e650: 7472 6561 6d69 6e67 5f62 7974 6573 2873  treaming_bytes(s
-0001e660: 656c 6629 3a0a 2020 2020 2020 2020 7072  elf):.        pr
-0001e670: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-0001e680: 656e 742e 6578 6563 285b 2763 6174 275d  ent.exec(['cat']
-0001e690: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
-0001e6a0: 0a0a 2020 2020 2020 2020 6465 6620 7374  ..        def st
-0001e6b0: 6469 6e5f 7468 7265 6164 2829 3a0a 2020  din_thread():.  
-0001e6c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001e6e0: 6f72 206c 696e 6520 696e 205b 6227 6f6e  or line in [b'on
-0001e6f0: 655c 6e27 2c20 6227 325c 6e27 2c20 6227  e\n', b'2\n', b'
-0001e700: 5448 5245 455c 6e27 5d3a 0a20 2020 2020  THREE\n']:.     
-0001e710: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001e720: 726f 6365 7373 2e73 7464 696e 2e77 7269  rocess.stdin.wri
-0001e730: 7465 286c 696e 6529 0a20 2020 2020 2020  te(line).       
-0001e740: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0001e750: 6365 7373 2e73 7464 696e 2e66 6c75 7368  cess.stdin.flush
-0001e760: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0001e770: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-0001e780: 7028 302e 3129 0a20 2020 2020 2020 2020  p(0.1).         
-0001e790: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-0001e7a0: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-0001e7b0: 6573 732e 7374 6469 6e2e 636c 6f73 6528  ess.stdin.close(
-0001e7c0: 290a 0a20 2020 2020 2020 2074 6872 6561  )..        threa
-0001e7d0: 6469 6e67 2e54 6872 6561 6428 7461 7267  ding.Thread(targ
-0001e7e0: 6574 3d73 7464 696e 5f74 6872 6561 6429  et=stdin_thread)
-0001e7f0: 2e73 7461 7274 2829 0a0a 2020 2020 2020  .start()..      
-0001e800: 2020 7265 6164 7320 3d20 5b5d 0a20 2020    reads = [].   
-0001e810: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
-0001e820: 2070 726f 6365 7373 2e73 7464 6f75 743a   process.stdout:
-0001e830: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
-0001e840: 6473 2e61 7070 656e 6428 6c69 6e65 290a  ds.append(line).
-0001e850: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001e860: 2e77 6169 7428 290a 0a20 2020 2020 2020  .wait()..       
-0001e870: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001e880: 6c28 7265 6164 732c 205b 6227 6f6e 655c  l(reads, [b'one\
-0001e890: 6e27 2c20 6227 325c 6e27 2c20 6227 5448  n', b'2\n', b'TH
-0001e8a0: 5245 455c 6e27 5d29 0a                   REE\n']).
+0001e070: 6572 7445 7175 616c 286f 7574 2c20 6227  ertEqual(out, b'
+0001e080: 464f 4f5c 6e42 4152 5c6e 2729 0a20 2020  FOO\nBAR\n').   
+0001e090: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001e0a0: 4571 7561 6c28 6572 722c 2062 2727 290a  Equal(err, b'').
+0001e0b0: 0a20 2020 2064 6566 2074 6573 745f 7075  .    def test_pu
+0001e0c0: 7368 5f70 756c 6c28 7365 6c66 293a 0a20  sh_pull(self):. 
+0001e0d0: 2020 2020 2020 2066 6e61 6d65 203d 206f         fname = o
+0001e0e0: 732e 7061 7468 2e6a 6f69 6e28 7465 6d70  s.path.join(temp
+0001e0f0: 6669 6c65 2e67 6574 7465 6d70 6469 7228  file.gettempdir(
+0001e100: 292c 2066 2770 6562 626c 6574 6573 742d  ), f'pebbletest-
+0001e110: 7b75 7569 642e 7575 6964 3428 297d 2729  {uuid.uuid4()}')
+0001e120: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+0001e130: 203d 2027 666f 6f5c 6e62 6172 5c6e 6261   = 'foo\nbar\nba
+0001e140: 7a2d 3432 270a 2020 2020 2020 2020 7365  z-42'.        se
+0001e150: 6c66 2e63 6c69 656e 742e 7075 7368 2866  lf.client.push(f
+0001e160: 6e61 6d65 2c20 636f 6e74 656e 7429 0a20  name, content). 
+0001e170: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0001e180: 2e63 6c69 656e 742e 7075 6c6c 2866 6e61  .client.pull(fna
+0001e190: 6d65 2920 6173 2066 3a0a 2020 2020 2020  me) as f:.      
+0001e1a0: 2020 2020 2020 6461 7461 203d 2066 2e72        data = f.r
+0001e1b0: 6561 6428 290a 2020 2020 2020 2020 2020  ead().          
+0001e1c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001e1d0: 616c 2864 6174 612c 2063 6f6e 7465 6e74  al(data, content
+0001e1e0: 290a 2020 2020 2020 2020 6f73 2e72 656d  ).        os.rem
+0001e1f0: 6f76 6528 666e 616d 6529 0a0a 2020 2020  ove(fname)..    
+0001e200: 6465 6620 7465 7374 5f65 7865 635f 7469  def test_exec_ti
+0001e210: 6d65 6f75 7428 7365 6c66 293a 0a20 2020  meout(self):.   
+0001e220: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+0001e230: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+0001e240: 5b27 736c 6565 7027 2c20 2730 2e32 275d  ['sleep', '0.2']
+0001e250: 2c20 7469 6d65 6f75 743d 302e 3129 0a20  , timeout=0.1). 
+0001e260: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0001e270: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+0001e280: 6262 6c65 2e43 6861 6e67 6545 7272 6f72  bble.ChangeError
+0001e290: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+0001e2a0: 2020 2020 2070 726f 6365 7373 2e77 6169       process.wai
+0001e2b0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0001e2c0: 2e61 7373 6572 7449 6e28 2774 696d 6564  .assertIn('timed
+0001e2d0: 206f 7574 272c 2063 6d2e 6578 6365 7074   out', cm.except
+0001e2e0: 696f 6e2e 6572 7229 0a0a 2020 2020 6465  ion.err)..    de
+0001e2f0: 6620 7465 7374 5f65 7865 635f 776f 726b  f test_exec_work
+0001e300: 696e 675f 6469 7228 7365 6c66 293a 0a20  ing_dir(self):. 
+0001e310: 2020 2020 2020 2077 6974 6820 7465 6d70         with temp
+0001e320: 6669 6c65 2e54 656d 706f 7261 7279 4469  file.TemporaryDi
+0001e330: 7265 6374 6f72 7928 2920 6173 2074 656d  rectory() as tem
+0001e340: 705f 6469 723a 0a20 2020 2020 2020 2020  p_dir:.         
+0001e350: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
+0001e360: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
+0001e370: 7077 6427 5d2c 2077 6f72 6b69 6e67 5f64  pwd'], working_d
+0001e380: 6972 3d74 656d 705f 6469 7229 0a20 2020  ir=temp_dir).   
+0001e390: 2020 2020 2020 2020 206f 7574 2c20 6572           out, er
+0001e3a0: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+0001e3b0: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+0001e3c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001e3d0: 7445 7175 616c 286f 7574 2c20 6622 7b74  tEqual(out, f"{t
+0001e3e0: 656d 705f 6469 727d 5c6e 2229 0a20 2020  emp_dir}\n").   
+0001e3f0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0001e400: 7365 7274 4571 7561 6c28 6572 722c 2027  sertEqual(err, '
+0001e410: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+0001e420: 5f65 7865 635f 656e 7669 726f 6e6d 656e  _exec_environmen
+0001e430: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0001e440: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
+0001e450: 636c 6965 6e74 2e65 7865 6328 5b27 2f62  client.exec(['/b
+0001e460: 696e 2f73 6827 2c20 272d 6327 2c20 2765  in/sh', '-c', 'e
+0001e470: 6368 6f20 244f 4e45 2e24 5457 4f2e 2454  cho $ONE.$TWO.$T
+0001e480: 4852 4545 275d 2c0a 2020 2020 2020 2020  HREE'],.        
+0001e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4a0: 2020 2020 2020 2020 2020 2065 6e76 6972             envir
+0001e4b0: 6f6e 6d65 6e74 3d7b 274f 4e45 273a 2027  onment={'ONE': '
+0001e4c0: 3127 2c20 2754 574f 273a 2027 3227 7d29  1', 'TWO': '2'})
+0001e4d0: 0a20 2020 2020 2020 206f 7574 2c20 6572  .        out, er
+0001e4e0: 7220 3d20 7072 6f63 6573 732e 7761 6974  r = process.wait
+0001e4f0: 5f6f 7574 7075 7428 290a 2020 2020 2020  _output().      
+0001e500: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001e510: 616c 286f 7574 2c20 2731 2e32 2e5c 6e27  al(out, '1.2.\n'
+0001e520: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001e530: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
+0001e540: 2727 290a 0a20 2020 2064 6566 2074 6573  '')..    def tes
+0001e550: 745f 6578 6563 5f73 7472 6561 6d69 6e67  t_exec_streaming
+0001e560: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001e570: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
+0001e580: 6c69 656e 742e 6578 6563 285b 2763 6174  lient.exec(['cat
+0001e590: 275d 290a 0a20 2020 2020 2020 2064 6566  '])..        def
+0001e5a0: 2073 7464 696e 5f74 6872 6561 6428 293a   stdin_thread():
+0001e5b0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0001e5c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e5d0: 2020 666f 7220 6c69 6e65 2069 6e20 5b27    for line in ['
+0001e5e0: 6f6e 655c 6e27 2c20 2732 5c6e 272c 2027  one\n', '2\n', '
+0001e5f0: 5448 5245 455c 6e27 5d3a 0a20 2020 2020  THREE\n']:.     
+0001e600: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001e610: 726f 6365 7373 2e73 7464 696e 2e77 7269  rocess.stdin.wri
+0001e620: 7465 286c 696e 6529 0a20 2020 2020 2020  te(line).       
+0001e630: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0001e640: 6365 7373 2e73 7464 696e 2e66 6c75 7368  cess.stdin.flush
+0001e650: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001e660: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+0001e670: 7028 302e 3129 0a20 2020 2020 2020 2020  p(0.1).         
+0001e680: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+0001e690: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0001e6a0: 6573 732e 7374 6469 6e2e 636c 6f73 6528  ess.stdin.close(
+0001e6b0: 290a 0a20 2020 2020 2020 2074 6872 6561  )..        threa
+0001e6c0: 6469 6e67 2e54 6872 6561 6428 7461 7267  ding.Thread(targ
+0001e6d0: 6574 3d73 7464 696e 5f74 6872 6561 6429  et=stdin_thread)
+0001e6e0: 2e73 7461 7274 2829 0a0a 2020 2020 2020  .start()..      
+0001e6f0: 2020 7265 6164 7320 3d20 5b5d 0a20 2020    reads = [].   
+0001e700: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
+0001e710: 2070 726f 6365 7373 2e73 7464 6f75 743a   process.stdout:
+0001e720: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
+0001e730: 6473 2e61 7070 656e 6428 6c69 6e65 290a  ds.append(line).
+0001e740: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0001e750: 2e77 6169 7428 290a 0a20 2020 2020 2020  .wait()..       
+0001e760: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001e770: 6c28 7265 6164 732c 205b 276f 6e65 5c6e  l(reads, ['one\n
+0001e780: 272c 2027 325c 6e27 2c20 2754 4852 4545  ', '2\n', 'THREE
+0001e790: 5c6e 275d 290a 0a20 2020 2064 6566 2074  \n'])..    def t
+0001e7a0: 6573 745f 6578 6563 5f73 7472 6561 6d69  est_exec_streami
+0001e7b0: 6e67 5f62 7974 6573 2873 656c 6629 3a0a  ng_bytes(self):.
+0001e7c0: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+0001e7d0: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
+0001e7e0: 6563 285b 2763 6174 275d 2c20 656e 636f  ec(['cat'], enco
+0001e7f0: 6469 6e67 3d4e 6f6e 6529 0a0a 2020 2020  ding=None)..    
+0001e800: 2020 2020 6465 6620 7374 6469 6e5f 7468      def stdin_th
+0001e810: 7265 6164 2829 3a0a 2020 2020 2020 2020  read():.        
+0001e820: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001e830: 2020 2020 2020 2020 2066 6f72 206c 696e           for lin
+0001e840: 6520 696e 205b 6227 6f6e 655c 6e27 2c20  e in [b'one\n', 
+0001e850: 6227 325c 6e27 2c20 6227 5448 5245 455c  b'2\n', b'THREE\
+0001e860: 6e27 5d3a 0a20 2020 2020 2020 2020 2020  n']:.           
+0001e870: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0001e880: 2e73 7464 696e 2e77 7269 7465 286c 696e  .stdin.write(lin
+0001e890: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001e8a0: 2020 2020 2020 2070 726f 6365 7373 2e73         process.s
+0001e8b0: 7464 696e 2e66 6c75 7368 2829 0a20 2020  tdin.flush().   
+0001e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8d0: 2074 696d 652e 736c 6565 7028 302e 3129   time.sleep(0.1)
+0001e8e0: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
+0001e8f0: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
+0001e900: 2020 2020 2020 7072 6f63 6573 732e 7374        process.st
+0001e910: 6469 6e2e 636c 6f73 6528 290a 0a20 2020  din.close()..   
+0001e920: 2020 2020 2074 6872 6561 6469 6e67 2e54       threading.T
+0001e930: 6872 6561 6428 7461 7267 6574 3d73 7464  hread(target=std
+0001e940: 696e 5f74 6872 6561 6429 2e73 7461 7274  in_thread).start
+0001e950: 2829 0a0a 2020 2020 2020 2020 7265 6164  ()..        read
+0001e960: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+0001e970: 6f72 206c 696e 6520 696e 2070 726f 6365  or line in proce
+0001e980: 7373 2e73 7464 6f75 743a 0a20 2020 2020  ss.stdout:.     
+0001e990: 2020 2020 2020 2072 6561 6473 2e61 7070         reads.app
+0001e9a0: 656e 6428 6c69 6e65 290a 0a20 2020 2020  end(line)..     
+0001e9b0: 2020 2070 726f 6365 7373 2e77 6169 7428     process.wait(
+0001e9c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001e9d0: 6173 7365 7274 4571 7561 6c28 7265 6164  assertEqual(read
+0001e9e0: 732c 205b 6227 6f6e 655c 6e27 2c20 6227  s, [b'one\n', b'
+0001e9f0: 325c 6e27 2c20 6227 5448 5245 455c 6e27  2\n', b'THREE\n'
+0001ea00: 5d29 0a                                  ]).
```

### Comparing `ops-2.4.1/test/test_private.py` & `ops-2.5.0/test/test_private.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_storage.py` & `ops-2.5.0/test/test_storage.py`

 * *Files identical despite different names*

### Comparing `ops-2.4.1/test/test_testing.py` & `ops-2.5.0/test/test_testing.py`

 * *Files 2% similar despite different names*

```diff
@@ -32,11930 +32,12077 @@
 000001f0: 7220 7468 6520 7370 6563 6966 6963 206c  r the specific l
 00000200: 616e 6775 6167 6520 676f 7665 726e 696e  anguage governin
 00000210: 6720 7065 726d 6973 7369 6f6e 7320 616e  g permissions an
 00000220: 640a 2320 6c69 6d69 7461 7469 6f6e 7320  d.# limitations 
 00000230: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
 00000240: 652e 0a0a 696d 706f 7274 2063 6f6c 6c65  e...import colle
 00000250: 6374 696f 6e73 0a69 6d70 6f72 7420 6461  ctions.import da
-00000260: 7465 7469 6d65 0a69 6d70 6f72 7420 696d  tetime.import im
-00000270: 706f 7274 6c69 620a 696d 706f 7274 2069  portlib.import i
-00000280: 6e73 7065 6374 0a69 6d70 6f72 7420 696f  nspect.import io
-00000290: 0a69 6d70 6f72 7420 6970 6164 6472 6573  .import ipaddres
-000002a0: 730a 696d 706f 7274 206f 730a 696d 706f  s.import os.impo
-000002b0: 7274 2070 6174 686c 6962 0a69 6d70 6f72  rt pathlib.impor
-000002c0: 7420 706c 6174 666f 726d 0a69 6d70 6f72  t platform.impor
-000002d0: 7420 7368 7574 696c 0a69 6d70 6f72 7420  t shutil.import 
-000002e0: 7379 730a 696d 706f 7274 2074 656d 7066  sys.import tempf
-000002f0: 696c 650a 696d 706f 7274 2074 6578 7477  ile.import textw
-00000300: 7261 700a 696d 706f 7274 2075 6e69 7474  rap.import unitt
-00000310: 6573 740a 696d 706f 7274 2075 7569 640a  est.import uuid.
-00000320: 6672 6f6d 2069 6f20 696d 706f 7274 2042  from io import B
-00000330: 7974 6573 494f 2c20 5374 7269 6e67 494f  ytesIO, StringIO
-00000340: 0a66 726f 6d20 756e 6974 7465 7374 2e6d  .from unittest.m
-00000350: 6f63 6b20 696d 706f 7274 204d 6167 6963  ock import Magic
-00000360: 4d6f 636b 0a0a 696d 706f 7274 2070 7974  Mock..import pyt
-00000370: 6573 740a 696d 706f 7274 2079 616d 6c0a  est.import yaml.
-00000380: 0a69 6d70 6f72 7420 6f70 730a 696d 706f  .import ops.impo
-00000390: 7274 206f 7073 2e74 6573 7469 6e67 0a66  rt ops.testing.f
-000003a0: 726f 6d20 6f70 7320 696d 706f 7274 2070  rom ops import p
-000003b0: 6562 626c 650a 6672 6f6d 206f 7073 2e6d  ebble.from ops.m
-000003c0: 6f64 656c 2069 6d70 6f72 7420 5f4d 6f64  odel import _Mod
-000003d0: 656c 4261 636b 656e 640a 6672 6f6d 206f  elBackend.from o
-000003e0: 7073 2e74 6573 7469 6e67 2069 6d70 6f72  ps.testing impor
-000003f0: 7420 280a 2020 2020 4e6f 6e41 6273 6f6c  t (.    NonAbsol
-00000400: 7574 6550 6174 6845 7272 6f72 2c0a 2020  utePathError,.  
-00000410: 2020 5f44 6972 6563 746f 7279 2c0a 2020    _Directory,.  
-00000420: 2020 5f54 6573 7469 6e67 4669 6c65 7379    _TestingFilesy
-00000430: 7374 656d 2c0a 2020 2020 5f54 6573 7469  stem,.    _Testi
-00000440: 6e67 5065 6262 6c65 436c 6965 6e74 2c0a  ngPebbleClient,.
-00000450: 2020 2020 5f54 6573 7469 6e67 5374 6f72      _TestingStor
-00000460: 6167 654d 6f75 6e74 2c0a 290a 0a69 735f  ageMount,.)..is_
-00000470: 6c69 6e75 7820 3d20 706c 6174 666f 726d  linux = platform
-00000480: 2e73 7973 7465 6d28 2920 3d3d 2027 4c69  .system() == 'Li
-00000490: 6e75 7827 0a0a 0a63 6c61 7373 2053 6574  nux'...class Set
-000004a0: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
-000004b0: 7228 6f70 732e 4368 6172 6d42 6173 6529  r(ops.CharmBase)
-000004c0: 3a0a 2020 2020 2222 2253 6574 7320 7065  :.    """Sets pe
-000004d0: 6572 2072 656c 6174 696f 6e20 6461 7461  er relation data
-000004e0: 2069 6e73 6964 6520 6c65 6164 6572 2d65   inside leader-e
-000004f0: 6c65 6374 6564 2e22 2222 0a0a 2020 2020  lected."""..    
-00000500: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00000510: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
-00000520: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-00000530: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
-00000540: 6b29 0a20 2020 2020 2020 2073 656c 662e  k).        self.
-00000550: 5f70 6565 725f 6e61 6d65 203d 2027 7065  _peer_name = 'pe
-00000560: 6572 270a 2020 2020 2020 2020 7365 6c66  er'.        self
-00000570: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
-00000580: 7665 2873 656c 662e 6f6e 2e6c 6561 6465  ve(self.on.leade
-00000590: 725f 656c 6563 7465 642c 0a20 2020 2020  r_elected,.     
-000005a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000005b0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000005c0: 6f6e 5f6c 6561 6465 725f 656c 6563 7465  on_leader_electe
-000005d0: 6429 0a0a 2020 2020 6465 6620 5f6f 6e5f  d)..    def _on_
-000005e0: 6c65 6164 6572 5f65 6c65 6374 6564 2873  leader_elected(s
-000005f0: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
-00000600: 2020 2020 2070 6565 7273 203d 2073 656c       peers = sel
-00000610: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
-00000620: 7469 6f6e 2873 656c 662e 5f70 6565 725f  tion(self._peer_
-00000630: 6e61 6d65 290a 2020 2020 2020 2020 7065  name).        pe
-00000640: 6572 732e 6461 7461 5b73 656c 662e 6170  ers.data[self.ap
-00000650: 705d 5b22 666f 6f22 5d20 3d20 2262 6172  p]["foo"] = "bar
-00000660: 220a 0a0a 636c 6173 7320 5374 6f72 6167  "...class Storag
-00000670: 6554 6573 7465 7228 6f70 732e 4368 6172  eTester(ops.Char
-00000680: 6d42 6173 6529 3a0a 2020 2020 2222 2252  mBase):.    """R
-00000690: 6563 6f72 6420 7468 6520 7265 6c61 7469  ecord the relati
-000006a0: 6f6e 2d63 6861 6e67 6564 2065 7665 6e74  on-changed event
-000006b0: 732e 2222 220a 0a20 2020 2064 6566 205f  s."""..    def _
-000006c0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
-000006d0: 616d 6577 6f72 6b29 3a0a 2020 2020 2020  amework):.      
-000006e0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-000006f0: 5f5f 2866 7261 6d65 776f 726b 290a 2020  __(framework).  
-00000700: 2020 2020 2020 7365 6c66 2e6f 6273 6572        self.obser
-00000710: 7665 645f 6576 656e 7473 203d 205b 5d0a  ved_events = [].
-00000720: 2020 2020 2020 2020 7365 6c66 2e66 7261          self.fra
-00000730: 6d65 776f 726b 2e6f 6273 6572 7665 2873  mework.observe(s
-00000740: 656c 662e 6f6e 2e74 6573 745f 7374 6f72  elf.on.test_stor
-00000750: 6167 655f 6174 7461 6368 6564 2c0a 2020  age_attached,.  
-00000760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000770: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00000780: 662e 5f6f 6e5f 7465 7374 5f73 746f 7261  f._on_test_stora
-00000790: 6765 5f61 7474 6163 6865 6429 0a20 2020  ge_attached).   
-000007a0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-000007b0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-000007c0: 2e6f 6e2e 7465 7374 5f73 746f 7261 6765  .on.test_storage
-000007d0: 5f64 6574 6163 6869 6e67 2c0a 2020 2020  _detaching,.    
-000007e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000007f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000800: 5f6f 6e5f 7465 7374 5f73 746f 7261 6765  _on_test_storage
-00000810: 5f64 6574 6163 6869 6e67 290a 0a20 2020  _detaching)..   
-00000820: 2064 6566 205f 6f6e 5f74 6573 745f 7374   def _on_test_st
-00000830: 6f72 6167 655f 6174 7461 6368 6564 2873  orage_attached(s
-00000840: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
-00000850: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-00000860: 6564 5f65 7665 6e74 732e 6170 7065 6e64  ed_events.append
-00000870: 2865 7665 6e74 290a 0a20 2020 2064 6566  (event)..    def
-00000880: 205f 6f6e 5f74 6573 745f 7374 6f72 6167   _on_test_storag
-00000890: 655f 6465 7461 6368 696e 6728 7365 6c66  e_detaching(self
-000008a0: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-000008b0: 2020 7365 6c66 2e6f 6273 6572 7665 645f    self.observed_
-000008c0: 6576 656e 7473 2e61 7070 656e 6428 6576  events.append(ev
-000008d0: 656e 7429 0a0a 0a63 6c61 7373 2053 746f  ent)...class Sto
-000008e0: 7261 6765 5769 7468 4879 7068 656e 7348  rageWithHyphensH
-000008f0: 656c 7065 7228 6f70 732e 4f62 6a65 6374  elper(ops.Object
-00000900: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
-00000910: 745f 5f28 7365 6c66 2c20 7061 7265 6e74  t__(self, parent
-00000920: 2c20 6b65 7929 3a0a 2020 2020 2020 2020  , key):.        
-00000930: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00000940: 2870 6172 656e 742c 206b 6579 290a 2020  (parent, key).  
-00000950: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
-00000960: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-00000970: 7061 7265 6e74 2e66 7261 6d65 776f 726b  parent.framework
-00000980: 2e6f 6273 6572 7665 2870 6172 656e 742e  .observe(parent.
-00000990: 6f6e 2e74 6573 745f 7769 7468 5f68 7970  on.test_with_hyp
-000009a0: 6865 6e73 5f73 746f 7261 6765 5f61 7474  hens_storage_att
-000009b0: 6163 6865 642c 0a20 2020 2020 2020 2020  ached,.         
-000009c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000009d0: 2020 2020 2020 2020 7365 6c66 2e6f 6e5f          self.on_
-000009e0: 7374 6f72 6167 655f 6368 616e 6765 6429  storage_changed)
-000009f0: 0a20 2020 2020 2020 2070 6172 656e 742e  .        parent.
-00000a00: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
-00000a10: 6528 7061 7265 6e74 2e6f 6e2e 7465 7374  e(parent.on.test
-00000a20: 5f77 6974 685f 6879 7068 656e 735f 7374  _with_hyphens_st
-00000a30: 6f72 6167 655f 6465 7461 6368 696e 672c  orage_detaching,
-00000a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a60: 2020 7365 6c66 2e6f 6e5f 7374 6f72 6167    self.on_storag
-00000a70: 655f 6368 616e 6765 6429 0a0a 2020 2020  e_changed)..    
-00000a80: 6465 6620 6f6e 5f73 746f 7261 6765 5f63  def on_storage_c
-00000a90: 6861 6e67 6564 2873 656c 662c 2065 7665  hanged(self, eve
-00000aa0: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
-00000ab0: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
-00000ac0: 2865 7665 6e74 290a 0a0a 636c 6173 7320  (event)...class 
-00000ad0: 5465 7374 4861 726e 6573 7328 756e 6974  TestHarness(unit
-00000ae0: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-00000af0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-00000b00: 645f 7265 6c61 7469 6f6e 2873 656c 6629  d_relation(self)
-00000b10: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-00000b20: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-00000b30: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
-00000b40: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-00000b50: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00000b60: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00000b70: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00000b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000b90: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-00000ba0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00000bb0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00000bc0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00000bd0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00000be0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00000bf0: 7570 290a 2020 2020 2020 2020 7265 6c5f  up).        rel_
-00000c00: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-00000c10: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-00000c20: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
-00000c30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00000c40: 7449 7349 6e73 7461 6e63 6528 7265 6c5f  tIsInstance(rel_
-00000c50: 6964 2c20 696e 7429 0a20 2020 2020 2020  id, int).       
-00000c60: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
-00000c70: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
-00000c80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00000c90: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
-00000ca0: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
-00000cb0: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
-00000cc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00000cd0: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
-00000ce0: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
-00000cf0: 292c 205b 5d29 0a20 2020 2020 2020 2023  ), []).        #
-00000d00: 204d 616b 6520 7375 7265 2074 6865 2069   Make sure the i
-00000d10: 6e69 7469 616c 2064 6174 6120 6261 6773  nitial data bags
-00000d20: 2066 6f72 206f 7572 2061 7070 2061 6e64   for our app and
-00000d30: 2075 6e69 7420 6172 6520 656d 7074 792e   unit are empty.
-00000d40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00000d50: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00000d60: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
-00000d70: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00000d80: 272c 2069 735f 6170 703d 5472 7565 292c  ', is_app=True),
-00000d90: 207b 7d29 0a20 2020 2020 2020 2073 656c   {}).        sel
-00000da0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-00000db0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00000dc0: 6574 2872 656c 5f69 642c 2027 7465 7374  et(rel_id, 'test
-00000dd0: 2d61 7070 2f30 272c 2069 735f 6170 703d  -app/0', is_app=
-00000de0: 4661 6c73 6529 2c20 7b7d 290a 0a20 2020  False), {})..   
-00000df0: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
-00000e00: 6e6e 6563 745f 6465 6661 756c 7428 7365  nnect_default(se
-00000e10: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00000e20: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-00000e30: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
-00000e40: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-00000e50: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-00000e60: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-00000e70: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-00000e80: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
-00000e90: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-00000ea0: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-00000eb0: 653a 2066 6f6f 2d69 6d61 6765 0a20 2020  e: foo-image.   
-00000ec0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-00000ed0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00000ee0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00000ef0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
-00000f00: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-00000f10: 2020 2020 2020 2020 6320 3d20 6861 726e          c = harn
-00000f20: 6573 732e 6d6f 6465 6c2e 756e 6974 2e67  ess.model.unit.g
-00000f30: 6574 5f63 6f6e 7461 696e 6572 2827 666f  et_container('fo
-00000f40: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
-00000f50: 662e 6173 7365 7274 4661 6c73 6528 632e  f.assertFalse(c.
-00000f60: 6361 6e5f 636f 6e6e 6563 7428 2929 0a20  can_connect()). 
-00000f70: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00000f80: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-00000f90: 6262 6c65 2e43 6f6e 6e65 6374 696f 6e45  bble.ConnectionE
-00000fa0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00000fb0: 2020 2063 2e67 6574 5f70 6c61 6e28 290a     c.get_plan().
-00000fc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00000fd0: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
-00000fe0: 2827 666f 6f27 2c20 5472 7565 290a 2020  ('foo', True).  
-00000ff0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00001000: 7454 7275 6528 632e 6361 6e5f 636f 6e6e  tTrue(c.can_conn
-00001010: 6563 7428 2929 0a0a 2020 2020 2020 2020  ect())..        
-00001020: 6861 726e 6573 732e 7365 745f 6361 6e5f  harness.set_can_
-00001030: 636f 6e6e 6563 7428 2766 6f6f 272c 2046  connect('foo', F
-00001040: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
-00001050: 6c66 2e61 7373 6572 7446 616c 7365 2863  lf.assertFalse(c
-00001060: 2e63 616e 5f63 6f6e 6e65 6374 2829 290a  .can_connect()).
-00001070: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00001080: 2e63 6f6e 7461 696e 6572 5f70 6562 626c  .container_pebbl
-00001090: 655f 7265 6164 7928 2766 6f6f 2729 0a20  e_ready('foo'). 
-000010a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000010b0: 7274 5472 7565 2863 2e63 616e 5f63 6f6e  rtTrue(c.can_con
-000010c0: 6e65 6374 2829 290a 2020 2020 2020 2020  nect()).        
-000010d0: 632e 6765 745f 706c 616e 2829 2020 2320  c.get_plan()  # 
-000010e0: 7368 6f75 6c64 6e27 7420 7261 6973 6520  shouldn't raise 
-000010f0: 436f 6e6e 6563 7469 6f6e 4572 726f 720a  ConnectionError.
-00001100: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
-00001110: 6e5f 636f 6e6e 6563 745f 6265 6769 6e5f  n_connect_begin_
-00001120: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
-00001130: 6b73 2873 656c 6629 3a0a 2020 2020 2020  ks(self):.      
-00001140: 2020 7065 6262 6c65 5f72 6561 6479 5f63    pebble_ready_c
-00001150: 616c 6c73 203d 2063 6f6c 6c65 6374 696f  alls = collectio
-00001160: 6e73 2e64 6566 6175 6c74 6469 6374 2869  ns.defaultdict(i
-00001170: 6e74 290a 0a20 2020 2020 2020 2063 6c61  nt)..        cla
-00001180: 7373 204d 7943 6861 726d 286f 7073 2e43  ss MyCharm(ops.C
-00001190: 6861 726d 4261 7365 293a 0a20 2020 2020  harmBase):.     
-000011a0: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
-000011b0: 745f 5f28 7365 6c66 2c20 2a61 7267 7329  t__(self, *args)
-000011c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000011d0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-000011e0: 5f5f 282a 6172 6773 290a 2020 2020 2020  __(*args).      
-000011f0: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00001200: 7261 6d65 776f 726b 2e6f 6273 6572 7665  ramework.observe
-00001210: 2873 656c 662e 6f6e 2e66 6f6f 5f70 6562  (self.on.foo_peb
-00001220: 626c 655f 7265 6164 792c 2073 656c 662e  ble_ready, self.
-00001230: 5f6f 6e5f 7065 6262 6c65 5f72 6561 6479  _on_pebble_ready
-00001240: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00001250: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-00001260: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-00001270: 2e62 6172 5f70 6562 626c 655f 7265 6164  .bar_pebble_read
-00001280: 792c 2073 656c 662e 5f6f 6e5f 7065 6262  y, self._on_pebb
-00001290: 6c65 5f72 6561 6479 290a 0a20 2020 2020  le_ready)..     
-000012a0: 2020 2020 2020 2064 6566 205f 6f6e 5f70         def _on_p
-000012b0: 6562 626c 655f 7265 6164 7928 7365 6c66  ebble_ready(self
-000012c0: 2c20 6576 656e 743a 206f 7073 2e50 6562  , event: ops.Peb
-000012d0: 626c 6552 6561 6479 4576 656e 7429 3a0a  bleReadyEvent):.
-000012e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000012f0: 6173 7365 7274 2065 7665 6e74 2e77 6f72  assert event.wor
-00001300: 6b6c 6f61 642e 6361 6e5f 636f 6e6e 6563  kload.can_connec
-00001310: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-00001320: 2020 2020 7065 6262 6c65 5f72 6561 6479      pebble_ready
-00001330: 5f63 616c 6c73 5b65 7665 6e74 2e77 6f72  _calls[event.wor
-00001340: 6b6c 6f61 642e 6e61 6d65 5d20 2b3d 2031  kload.name] += 1
-00001350: 0a0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
-00001360: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-00001370: 4861 726e 6573 7328 4d79 4368 6172 6d2c  Harness(MyCharm,
-00001380: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-00001390: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-000013a0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-000013b0: 2063 6f6e 7461 696e 6572 733a 0a20 2020   containers:.   
-000013c0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
-000013d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000013e0: 7265 736f 7572 6365 3a20 666f 6f2d 696d  resource: foo-im
-000013f0: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
-00001400: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
-00001410: 2020 2020 2020 2072 6573 6f75 7263 653a         resource:
-00001420: 2062 6172 2d69 6d61 6765 0a20 2020 2020   bar-image.     
-00001430: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00001440: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00001450: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-00001460: 6e75 7029 0a0a 2020 2020 2020 2020 6861  nup)..        ha
-00001470: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
-00001480: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
-00001490: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000014a0: 7365 7274 4571 7561 6c28 6469 6374 2870  sertEqual(dict(p
-000014b0: 6562 626c 655f 7265 6164 795f 6361 6c6c  ebble_ready_call
-000014c0: 7329 2c20 7b27 666f 6f27 3a20 312c 2027  s), {'foo': 1, '
-000014d0: 6261 7227 3a20 317d 290a 2020 2020 2020  bar': 1}).      
-000014e0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-000014f0: 6528 6861 726e 6573 732e 6d6f 6465 6c2e  e(harness.model.
-00001500: 756e 6974 2e63 6f6e 7461 696e 6572 735b  unit.containers[
-00001510: 2766 6f6f 275d 2e63 616e 5f63 6f6e 6e65  'foo'].can_conne
-00001520: 6374 2829 290a 2020 2020 2020 2020 7365  ct()).        se
-00001530: 6c66 2e61 7373 6572 7454 7275 6528 6861  lf.assertTrue(ha
-00001540: 726e 6573 732e 6d6f 6465 6c2e 756e 6974  rness.model.unit
-00001550: 2e63 6f6e 7461 696e 6572 735b 2762 6172  .containers['bar
-00001560: 275d 2e63 616e 5f63 6f6e 6e65 6374 2829  '].can_connect()
-00001570: 290a 0a20 2020 2020 2020 2068 6172 6e65  )..        harne
-00001580: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
-00001590: 6374 2827 666f 6f27 2c20 4661 6c73 6529  ct('foo', False)
-000015a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000015b0: 7365 7274 4661 6c73 6528 6861 726e 6573  sertFalse(harnes
-000015c0: 732e 6d6f 6465 6c2e 756e 6974 2e63 6f6e  s.model.unit.con
-000015d0: 7461 696e 6572 735b 2766 6f6f 275d 2e63  tainers['foo'].c
-000015e0: 616e 5f63 6f6e 6e65 6374 2829 290a 0a20  an_connect()).. 
-000015f0: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
-00001600: 6574 5f63 616e 5f63 6f6e 6e65 6374 2827  et_can_connect('
-00001610: 666f 6f27 2c20 5472 7565 290a 2020 2020  foo', True).    
-00001620: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
-00001630: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
-00001640: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
-00001650: 6f6f 275d 0a20 2020 2020 2020 2073 656c  oo'].        sel
-00001660: 662e 6173 7365 7274 5472 7565 2863 6f6e  f.assertTrue(con
-00001670: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
-00001680: 6374 2829 290a 2020 2020 2020 2020 636f  ct()).        co
-00001690: 6e74 6169 6e65 722e 6765 745f 706c 616e  ntainer.get_plan
-000016a0: 2829 2020 2320 7368 6f75 6c64 6e27 7420  ()  # shouldn't 
-000016b0: 7261 6973 6520 436f 6e6e 6563 7469 6f6e  raise Connection
-000016c0: 4572 726f 720a 0a20 2020 2064 6566 2074  Error..    def t
-000016d0: 6573 745f 6164 645f 7265 6c61 7469 6f6e  est_add_relation
-000016e0: 5f61 6e64 5f75 6e69 7428 7365 6c66 293a  _and_unit(self):
-000016f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00001700: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
-00001710: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
-00001720: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-00001730: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00001740: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-00001750: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-00001760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001770: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-00001780: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-00001790: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-000017a0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-000017b0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-000017c0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-000017d0: 7029 0a20 2020 2020 2020 2072 656c 5f69  p).        rel_i
-000017e0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
-000017f0: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-00001800: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-00001810: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001820: 4973 496e 7374 616e 6365 2872 656c 5f69  IsInstance(rel_i
-00001830: 642c 2069 6e74 290a 2020 2020 2020 2020  d, int).        
-00001840: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00001850: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
-00001860: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
-00001870: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00001880: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00001890: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
-000018a0: 706f 7374 6772 6573 716c 2f30 272c 207b  postgresql/0', {
-000018b0: 2766 6f6f 273a 2027 6261 7227 7d29 0a20  'foo': 'bar'}). 
-000018c0: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
-000018d0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-000018e0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-000018f0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-00001900: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
-00001910: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
-00001920: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00001930: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00001940: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
-00001950: 7265 6c5f 6964 292c 205b 2770 6f73 7467  rel_id), ['postg
-00001960: 7265 7371 6c2f 3027 5d29 0a20 2020 2020  resql/0']).     
-00001970: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00001980: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-00001990: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
-000019a0: 6e5f 6765 7428 7265 6c5f 6964 2c20 2770  n_get(rel_id, 'p
-000019b0: 6f73 7467 7265 7371 6c2f 3027 2c20 6973  ostgresql/0', is
-000019c0: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
-000019d0: 2020 2020 2020 2020 207b 2766 6f6f 273a           {'foo':
-000019e0: 2027 6261 7227 7d29 0a0a 2020 2020 6465   'bar'})..    de
-000019f0: 6620 7465 7374 5f61 6464 5f72 656c 6174  f test_add_relat
-00001a00: 696f 6e5f 7769 7468 5f72 656d 6f74 655f  ion_with_remote_
-00001a10: 6170 705f 6461 7461 2873 656c 6629 3a0a  app_data(self):.
-00001a20: 2020 2020 2020 2020 2320 6c61 6e67 7561          # langua
-00001a30: 6765 3d59 414d 4c0a 2020 2020 2020 2020  ge=YAML.        
-00001a40: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-00001a50: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-00001a60: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-00001a70: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00001a80: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00001a90: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00001aa0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-00001ab0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-00001ac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00001ad0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-00001ae0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00001af0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00001b00: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00001b10: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00001b20: 2020 7265 6d6f 7465 5f61 7070 203d 2027    remote_app = '
-00001b30: 706f 7374 6772 6573 716c 270a 2020 2020  postgresql'.    
-00001b40: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
-00001b50: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00001b60: 6e28 2764 6227 2c20 7265 6d6f 7465 5f61  n('db', remote_a
-00001b70: 7070 290a 2020 2020 2020 2020 6861 726e  pp).        harn
-00001b80: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00001b90: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00001ba0: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
-00001bb0: 2761 7070 273a 2027 6461 7461 277d 290a  'app': 'data'}).
-00001bc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00001bd0: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
-00001be0: 6c5f 6964 2c20 696e 7429 0a20 2020 2020  l_id, int).     
-00001bf0: 2020 2062 6163 6b65 6e64 203d 2068 6172     backend = har
-00001c00: 6e65 7373 2e5f 6261 636b 656e 640a 2020  ness._backend.  
-00001c10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00001c20: 7445 7175 616c 285b 7265 6c5f 6964 5d2c  tEqual([rel_id],
-00001c30: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
-00001c40: 6e5f 6964 7328 2764 6227 2929 0a20 2020  n_ids('db')).   
-00001c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001c60: 4571 7561 6c28 7b27 6170 7027 3a20 2764  Equal({'app': 'd
-00001c70: 6174 6127 7d2c 2062 6163 6b65 6e64 2e72  ata'}, backend.r
-00001c80: 656c 6174 696f 6e5f 6765 7428 7265 6c5f  elation_get(rel_
-00001c90: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
-00001ca0: 6973 5f61 7070 3d54 7275 6529 290a 0a20  is_app=True)).. 
-00001cb0: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-00001cc0: 7265 6c61 7469 6f6e 5f77 6974 685f 6f75  relation_with_ou
-00001cd0: 725f 696e 6974 6961 6c5f 6461 7461 2873  r_initial_data(s
-00001ce0: 656c 6629 3a0a 0a20 2020 2020 2020 2063  elf):..        c
-00001cf0: 6c61 7373 2049 6e69 7469 616c 4461 7461  lass InitialData
-00001d00: 5465 7374 6572 286f 7073 2e43 6861 726d  Tester(ops.Charm
-00001d10: 4261 7365 293a 0a20 2020 2020 2020 2020  Base):.         
-00001d20: 2020 2022 2222 5265 636f 7264 2074 6865     """Record the
-00001d30: 2072 656c 6174 696f 6e2d 6368 616e 6765   relation-change
-00001d40: 6420 6576 656e 7473 2e22 2222 0a0a 2020  d events."""..  
-00001d50: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
-00001d60: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
-00001d70: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
-00001d80: 2020 2020 2020 2020 2073 7570 6572 2829           super()
-00001d90: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-00001da0: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
-00001db0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-00001dc0: 6564 5f65 7665 6e74 7320 3d20 5b5d 0a20  ed_events = []. 
-00001dd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00001de0: 656c 662e 6672 616d 6577 6f72 6b2e 6f62  elf.framework.ob
-00001df0: 7365 7276 6528 7365 6c66 2e6f 6e2e 6462  serve(self.on.db
-00001e00: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
-00001e10: 642c 2073 656c 662e 5f6f 6e5f 6462 5f72  d, self._on_db_r
-00001e20: 656c 6174 696f 6e5f 6368 616e 6765 6429  elation_changed)
-00001e30: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
-00001e40: 6620 5f6f 6e5f 6462 5f72 656c 6174 696f  f _on_db_relatio
-00001e50: 6e5f 6368 616e 6765 6428 7365 6c66 2c20  n_changed(self, 
-00001e60: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-00001e70: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
-00001e80: 6572 7665 645f 6576 656e 7473 2e61 7070  erved_events.app
-00001e90: 656e 6428 6576 656e 7429 0a0a 2020 2020  end(event)..    
-00001ea0: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
-00001eb0: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
-00001ec0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00001ed0: 672e 4861 726e 6573 7328 496e 6974 6961  g.Harness(Initia
-00001ee0: 6c44 6174 6154 6573 7465 722c 206d 6574  lDataTester, met
-00001ef0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00001f00: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00001f10: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00001f20: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-00001f30: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-00001f40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00001f50: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-00001f60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00001f70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00001f80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00001f90: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00001fa0: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
-00001fb0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00001fc0: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
-00001fd0: 6c27 290a 2020 2020 2020 2020 6861 726e  l').        harn
-00001fe0: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00001ff0: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00002000: 2027 7465 7374 2d61 7070 272c 207b 276b   'test-app', {'k
-00002010: 273a 2027 7631 277d 290a 2020 2020 2020  ': 'v1'}).      
-00002020: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00002030: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00002040: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00002050: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
-00002060: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
-00002070: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
-00002080: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
-00002090: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
-000020a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000020b0: 616c 287b 276b 273a 2027 7631 277d 2c20  al({'k': 'v1'}, 
-000020c0: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-000020d0: 5f67 6574 2872 656c 5f69 642c 2027 7465  _get(rel_id, 'te
-000020e0: 7374 2d61 7070 272c 2069 735f 6170 703d  st-app', is_app=
-000020f0: 5472 7565 2929 0a20 2020 2020 2020 2073  True)).        s
-00002100: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00002110: 7b27 696e 6772 6573 732d 6164 6472 6573  {'ingress-addres
-00002120: 7327 3a20 2731 3932 2e30 2e32 2e31 277d  s': '192.0.2.1'}
-00002130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002140: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-00002150: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-00002160: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-00002170: 702f 3027 2c20 6973 5f61 7070 3d46 616c  p/0', is_app=Fal
-00002180: 7365 2929 0a0a 2020 2020 2020 2020 6861  se))..        ha
-00002190: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-000021a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000021b0: 7445 7175 616c 287b 276b 273a 2027 7631  tEqual({'k': 'v1
-000021c0: 277d 2c20 6261 636b 656e 642e 7265 6c61  '}, backend.rela
-000021d0: 7469 6f6e 5f67 6574 2872 656c 5f69 642c  tion_get(rel_id,
-000021e0: 2027 7465 7374 2d61 7070 272c 2069 735f   'test-app', is_
-000021f0: 6170 703d 5472 7565 2929 0a20 2020 2020  app=True)).     
-00002200: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00002210: 7561 6c28 7b27 696e 6772 6573 732d 6164  ual({'ingress-ad
-00002220: 6472 6573 7327 3a20 2731 3932 2e30 2e32  dress': '192.0.2
-00002230: 2e31 277d 2c0a 2020 2020 2020 2020 2020  .1'},.          
-00002240: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00002250: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00002260: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
-00002270: 742d 6170 702f 3027 2c20 6973 5f61 7070  t-app/0', is_app
-00002280: 3d46 616c 7365 2929 0a20 2020 2020 2020  =False)).       
-00002290: 2023 204d 616b 6520 7375 7265 206e 6f20   # Make sure no 
-000022a0: 7265 6c61 7469 6f6e 2d63 6861 6e67 6564  relation-changed
-000022b0: 2065 7665 6e74 7320 6172 6520 656d 6974   events are emit
-000022c0: 7465 6420 666f 7220 6f75 7220 6f77 6e20  ted for our own 
-000022d0: 6461 7461 2062 6167 732e 0a20 2020 2020  data bags..     
-000022e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000022f0: 7561 6c28 5b5d 2c20 6861 726e 6573 732e  ual([], harness.
-00002300: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00002310: 7665 6e74 7329 0a0a 2020 2020 2020 2020  vents)..        
-00002320: 2320 4120 7265 6d6f 7465 2075 6e69 7420  # A remote unit 
-00002330: 6361 6e20 7374 696c 6c20 7570 6461 7465  can still update
-00002340: 206f 7572 2061 7070 2072 656c 6174 696f   our app relatio
-00002350: 6e20 6461 7461 2062 6167 2073 696e 6365  n data bag since
-00002360: 206f 7572 2075 6e69 7420 6973 206e 6f74   our unit is not
-00002370: 2061 206c 6561 6465 722e 0a20 2020 2020   a leader..     
-00002380: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00002390: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-000023a0: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-000023b0: 7027 2c20 7b27 6b27 3a20 2776 3227 7d29  p', {'k': 'v2'})
-000023c0: 0a20 2020 2020 2020 2023 2041 6e64 2077  .        # And w
-000023d0: 6520 6765 7420 616e 2065 7665 6e74 0a20  e get an event. 
-000023e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000023f0: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
-00002400: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-00002410: 6564 5f65 7665 6e74 7329 0a20 2020 2020  ed_events).     
-00002420: 2020 2023 2057 6520 6361 6e20 616c 736f     # We can also
-00002430: 2075 7064 6174 6520 6f75 7220 6f77 6e20   update our own 
-00002440: 7265 6c61 7469 6f6e 2064 6174 612c 2065  relation data, e
-00002450: 7665 6e20 6966 2069 7420 6973 2061 2062  ven if it is a b
-00002460: 6974 2027 6368 6561 7479 270a 2020 2020  it 'cheaty'.    
-00002470: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-00002480: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00002490: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
-000024a0: 7070 2f30 272c 207b 2769 6e67 7265 7373  pp/0', {'ingress
-000024b0: 2d61 6464 7265 7373 273a 2027 3139 322e  -address': '192.
-000024c0: 302e 322e 3227 7d29 0a20 2020 2020 2020  0.2.2'}).       
-000024d0: 2023 2042 7574 206e 6f20 6576 656e 7420   # But no event 
-000024e0: 6861 7070 656e 730a 0a20 2020 2020 2020  happens..       
-000024f0: 2023 2055 7064 6174 696e 6720 6f75 7220   # Updating our 
-00002500: 6461 7461 2061 7070 2072 656c 6174 696f  data app relatio
-00002510: 6e20 6461 7461 2062 6167 2061 6e64 206f  n data bag and o
-00002520: 7572 2075 6e69 7420 6461 7461 2062 6167  ur unit data bag
-00002530: 2064 6f65 7320 6e6f 7420 6765 6e65 7261   does not genera
-00002540: 7465 2065 7665 6e74 732e 0a20 2020 2020  te events..     
-00002550: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
-00002560: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
-00002570: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-00002580: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00002590: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
-000025a0: 7070 272c 207b 276b 273a 2027 7633 277d  pp', {'k': 'v3'}
-000025b0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-000025c0: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-000025d0: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
-000025e0: 7465 7374 2d61 7070 2f30 272c 207b 2769  test-app/0', {'i
-000025f0: 6e67 7265 7373 2d61 6464 7265 7373 273a  ngress-address':
-00002600: 2027 3139 322e 302e 322e 3227 7d29 0a20   '192.0.2.2'}). 
-00002610: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00002620: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
-00002630: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-00002640: 6564 5f65 7665 6e74 7329 0a0a 2020 2020  ed_events)..    
-00002650: 6465 6620 7465 7374 5f61 6464 5f70 6565  def test_add_pee
-00002660: 725f 7265 6c61 7469 6f6e 5f77 6974 685f  r_relation_with_
-00002670: 696e 6974 6961 6c5f 6461 7461 5f6c 6561  initial_data_lea
-00002680: 6465 7228 7365 6c66 293a 0a0a 2020 2020  der(self):..    
-00002690: 2020 2020 636c 6173 7320 496e 6974 6961      class Initia
-000026a0: 6c44 6174 6154 6573 7465 7228 6f70 732e  lDataTester(ops.
-000026b0: 4368 6172 6d42 6173 6529 3a0a 2020 2020  CharmBase):.    
-000026c0: 2020 2020 2020 2020 2222 2252 6563 6f72          """Recor
-000026d0: 6420 7468 6520 7265 6c61 7469 6f6e 2d63  d the relation-c
-000026e0: 6861 6e67 6564 2065 7665 6e74 732e 2222  hanged events.""
-000026f0: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
-00002700: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00002710: 2c20 6672 616d 6577 6f72 6b29 3a0a 2020  , framework):.  
-00002720: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00002730: 7065 7228 292e 5f5f 696e 6974 5f5f 2866  per().__init__(f
-00002740: 7261 6d65 776f 726b 290a 2020 2020 2020  ramework).      
-00002750: 2020 2020 2020 2020 2020 7365 6c66 2e6f            self.o
-00002760: 6273 6572 7665 645f 6576 656e 7473 203d  bserved_events =
-00002770: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00002780: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
-00002790: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
-000027a0: 6f6e 2e63 6c75 7374 6572 5f72 656c 6174  on.cluster_relat
-000027b0: 696f 6e5f 6368 616e 6765 642c 0a20 2020  ion_changed,.   
-000027c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027e0: 2020 2020 7365 6c66 2e5f 6f6e 5f63 6c75      self._on_clu
-000027f0: 7374 6572 5f72 656c 6174 696f 6e5f 6368  ster_relation_ch
-00002800: 616e 6765 6429 0a0a 2020 2020 2020 2020  anged)..        
-00002810: 2020 2020 6465 6620 5f6f 6e5f 636c 7573      def _on_clus
-00002820: 7465 725f 7265 6c61 7469 6f6e 5f63 6861  ter_relation_cha
-00002830: 6e67 6564 2873 656c 662c 2065 7665 6e74  nged(self, event
-00002840: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00002850: 2020 2073 656c 662e 6f62 7365 7276 6564     self.observed
-00002860: 5f65 7665 6e74 732e 6170 7065 6e64 2865  _events.append(e
-00002870: 7665 6e74 290a 0a20 2020 2020 2020 2023  vent)..        #
-00002880: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
-00002890: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-000028a0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-000028b0: 6e65 7373 2849 6e69 7469 616c 4461 7461  ness(InitialData
-000028c0: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
-000028d0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-000028e0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-000028f0: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
-00002900: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00002910: 6c75 7374 6572 3a0a 2020 2020 2020 2020  luster:.        
-00002920: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00002930: 7266 6163 653a 2063 6c75 7374 6572 0a20  rface: cluster. 
-00002940: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00002950: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00002960: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00002970: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00002980: 2023 2054 4f44 4f3a 2064 6d69 7472 6969   # TODO: dmitrii
-00002990: 7320 3230 3230 2d30 342d 3037 2074 6573  s 2020-04-07 tes
-000029a0: 7420 6120 6d69 6e69 6f6e 2075 6e69 7420  t a minion unit 
-000029b0: 616e 6420 696e 6974 6961 6c20 7065 6572  and initial peer
-000029c0: 2072 656c 6174 696f 6e20 6170 7020 6461   relation app da
-000029d0: 7461 0a20 2020 2020 2020 2023 2065 7665  ta.        # eve
-000029e0: 6e74 7320 7768 656e 2074 6865 2068 6172  nts when the har
-000029f0: 6e65 7373 2062 6567 696e 7320 746f 2065  ness begins to e
-00002a00: 6d69 7420 6576 656e 7473 2066 6f72 2069  mit events for i
-00002a10: 6e69 7469 616c 2064 6174 612e 0a20 2020  nitial data..   
-00002a20: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-00002a30: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
-00002a40: 723d 5472 7565 290a 2020 2020 2020 2020  r=True).        
-00002a50: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-00002a60: 2e61 6464 5f72 656c 6174 696f 6e28 2763  .add_relation('c
-00002a70: 6c75 7374 6572 272c 2027 7465 7374 2d61  luster', 'test-a
-00002a80: 7070 2729 0a20 2020 2020 2020 2068 6172  pp').        har
-00002a90: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00002aa0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00002ab0: 2c20 2774 6573 742d 6170 7027 2c20 7b27  , 'test-app', {'
-00002ac0: 6b27 3a20 2776 277d 290a 2020 2020 2020  k': 'v'}).      
-00002ad0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00002ae0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00002af0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00002b00: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
-00002b10: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
-00002b20: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
-00002b30: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
-00002b40: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
-00002b50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00002b60: 616c 287b 276b 273a 2027 7627 7d2c 2062  al({'k': 'v'}, b
-00002b70: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00002b80: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
-00002b90: 742d 6170 7027 2c20 6973 5f61 7070 3d54  t-app', is_app=T
-00002ba0: 7275 6529 290a 2020 2020 2020 2020 7365  rue)).        se
-00002bb0: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
-00002bc0: 2769 6e67 7265 7373 2d61 6464 7265 7373  'ingress-address
-00002bd0: 273a 2027 3139 322e 302e 322e 3127 7d2c  ': '192.0.2.1'},
-00002be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002bf0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
-00002c00: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
-00002c10: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00002c20: 2f30 272c 2069 735f 6170 703d 4661 6c73  /0', is_app=Fals
-00002c30: 6529 290a 0a20 2020 2020 2020 2068 6172  e))..        har
-00002c40: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-00002c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00002c60: 4571 7561 6c28 7b27 6b27 3a20 2776 277d  Equal({'k': 'v'}
-00002c70: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
-00002c80: 6f6e 5f67 6574 2872 656c 5f69 642c 2027  on_get(rel_id, '
-00002c90: 7465 7374 2d61 7070 272c 2069 735f 6170  test-app', is_ap
-00002ca0: 703d 5472 7565 2929 0a20 2020 2020 2020  p=True)).       
-00002cb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00002cc0: 6c28 7b27 696e 6772 6573 732d 6164 6472  l({'ingress-addr
-00002cd0: 6573 7327 3a20 2731 3932 2e30 2e32 2e31  ess': '192.0.2.1
-00002ce0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00002cf0: 2020 2020 2020 2020 2020 2020 2062 6163               bac
-00002d00: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-00002d10: 7428 7265 6c5f 6964 2c20 2774 6573 742d  t(rel_id, 'test-
-00002d20: 6170 702f 3027 2c20 6973 5f61 7070 3d46  app/0', is_app=F
-00002d30: 616c 7365 2929 0a20 2020 2020 2020 2023  alse)).        #
-00002d40: 204d 616b 6520 7375 7265 206e 6f20 7265   Make sure no re
-00002d50: 6c61 7469 6f6e 2d63 6861 6e67 6564 2065  lation-changed e
-00002d60: 7665 6e74 7320 6172 6520 656d 6974 7465  vents are emitte
-00002d70: 6420 666f 7220 6f75 7220 6f77 6e20 6461  d for our own da
-00002d80: 7461 2062 6167 732e 0a20 2020 2020 2020  ta bags..       
-00002d90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00002da0: 6c28 5b5d 2c20 6861 726e 6573 732e 6368  l([], harness.ch
-00002db0: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
-00002dc0: 6e74 7329 0a0a 2020 2020 2020 2020 2320  nts)..        # 
-00002dd0: 5570 6461 7469 6e67 206f 7572 2061 7070  Updating our app
-00002de0: 2072 656c 6174 696f 6e20 6461 7461 2062   relation data b
-00002df0: 6167 2061 6e64 206f 7572 2075 6e69 7420  ag and our unit 
-00002e00: 6461 7461 2062 6167 2064 6f65 7320 6e6f  data bag does no
-00002e10: 7420 7472 6967 6765 7220 6576 656e 7473  t trigger events
-00002e20: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00002e30: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-00002e40: 5f64 6174 6128 7265 6c5f 6964 2c20 2774  _data(rel_id, 't
-00002e50: 6573 742d 6170 7027 2c20 7b27 6b27 3a20  est-app', {'k': 
-00002e60: 2776 3227 7d29 0a20 2020 2020 2020 2068  'v2'}).        h
-00002e70: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00002e80: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-00002e90: 6964 2c20 2774 6573 742d 6170 702f 3027  id, 'test-app/0'
-00002ea0: 2c20 7b27 696e 6772 6573 732d 6164 6472  , {'ingress-addr
-00002eb0: 6573 7327 3a20 2731 3932 2e30 2e32 2e32  ess': '192.0.2.2
-00002ec0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-00002ed0: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
-00002ee0: 2068 6172 6e65 7373 2e63 6861 726d 2e6f   harness.charm.o
-00002ef0: 6273 6572 7665 645f 6576 656e 7473 290a  bserved_events).
-00002f00: 0a20 2020 2020 2020 2023 2049 6620 6f75  .        # If ou
-00002f10: 7220 756e 6974 2062 6563 6f6d 6573 2061  r unit becomes a
-00002f20: 206d 696e 696f 6e2c 2075 7064 6174 696e   minion, updatin
-00002f30: 6720 6170 7020 7265 6c61 7469 6f6e 2064  g app relation d
-00002f40: 6174 6120 696e 6469 7265 6374 6c79 2062  ata indirectly b
-00002f50: 6563 6f6d 6573 2070 6f73 7369 626c 650a  ecomes possible.
-00002f60: 2020 2020 2020 2020 2320 616e 6420 6f75          # and ou
-00002f70: 7220 6368 6172 6d20 6765 7473 206e 6f74  r charm gets not
-00002f80: 6966 6963 6174 696f 6e73 2e0a 2020 2020  ifications..    
-00002f90: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-00002fa0: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
-00002fb0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
-00002fc0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00002fd0: 7461 2872 656c 5f69 642c 2027 7465 7374  ta(rel_id, 'test
-00002fe0: 2d61 7070 272c 207b 276b 273a 2027 7633  -app', {'k': 'v3
-00002ff0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-00003000: 2e61 7373 6572 7445 7175 616c 287b 276b  .assertEqual({'k
-00003010: 273a 2027 7633 277d 2c20 6261 636b 656e  ': 'v3'}, backen
-00003020: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
-00003030: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00003040: 272c 2069 735f 6170 703d 5472 7565 2929  ', is_app=True))
-00003050: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00003060: 7365 7274 5472 7565 286c 656e 2868 6172  sertTrue(len(har
-00003070: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-00003080: 7665 645f 6576 656e 7473 292c 2031 290a  ved_events), 1).
-00003090: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000030a0: 6572 7449 7349 6e73 7461 6e63 6528 6861  ertIsInstance(ha
-000030b0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-000030c0: 7276 6564 5f65 7665 6e74 735b 305d 2c20  rved_events[0], 
-000030d0: 6f70 732e 5265 6c61 7469 6f6e 4576 656e  ops.RelationEven
-000030e0: 7429 0a0a 2020 2020 6465 6620 7465 7374  t)..    def test
-000030f0: 5f72 656c 6174 696f 6e5f 6765 745f 7768  _relation_get_wh
-00003100: 656e 5f62 726f 6b65 6e28 7365 6c66 293a  en_broken(self):
-00003110: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00003120: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
-00003130: 6172 6e65 7373 2852 656c 6174 696f 6e42  arness(RelationB
-00003140: 726f 6b65 6e54 6573 7465 722c 206d 6574  rokenTester, met
-00003150: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00003160: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00003170: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00003180: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-00003190: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-000031a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000031b0: 696e 7465 7266 6163 653a 2066 6f6f 666f  interface: foofo
-000031c0: 6f0a 2020 2020 2020 2020 2020 2020 2727  o.            ''
-000031d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000031e0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-000031f0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00003200: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-00003210: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
-00003220: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-00003230: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-00003240: 7328 2766 6f6f 2729 0a0a 2020 2020 2020  s('foo')..      
-00003250: 2020 2320 7265 6c61 7469 6f6e 2072 656d    # relation rem
-00003260: 6f74 6520 6170 7020 6973 204e 6f6e 6520  ote app is None 
-00003270: 746f 206d 6972 726f 7220 7072 6f64 7563  to mirror produc
-00003280: 7469 6f6e 204a 756a 7520 6265 6861 7669  tion Juju behavi
-00003290: 6f72 2077 6865 7265 204a 756a 7520 646f  or where Juju do
-000032a0: 6573 6e27 740a 2020 2020 2020 2020 2320  esn't.        # 
-000032b0: 636f 6d6d 756e 6963 6174 6520 7468 6520  communicate the 
-000032c0: 7265 6d6f 7465 2061 7070 2074 6f20 6f70  remote app to op
-000032d0: 732e 0a20 2020 2020 2020 2072 656c 5f69  s..        rel_i
-000032e0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
-000032f0: 7265 6c61 7469 6f6e 2827 666f 6f27 2c20  relation('foo', 
-00003300: 4e6f 6e65 290a 0a20 2020 2020 2020 2077  None)..        w
-00003310: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
-00003320: 7328 4b65 7945 7272 6f72 2c20 6d61 7463  s(KeyError, matc
-00003330: 683d 2774 7279 696e 6720 746f 2061 6363  h='trying to acc
-00003340: 6573 7320 7265 6d6f 7465 2061 7070 2064  ess remote app d
-00003350: 6174 6127 293a 0a20 2020 2020 2020 2020  ata'):.         
-00003360: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
-00003370: 655f 7265 6c61 7469 6f6e 2872 656c 5f69  e_relation(rel_i
-00003380: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
-00003390: 5f72 656d 6f76 655f 7265 6c61 7469 6f6e  _remove_relation
-000033a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000033b0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-000033c0: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
-000033d0: 6c61 7469 6f6e 4576 656e 7443 6861 726d  lationEventCharm
-000033e0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000033f0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-00003400: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-00003410: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-00003420: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00003430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003440: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-00003450: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-00003460: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00003470: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00003480: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00003490: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-000034a0: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
-000034b0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-000034c0: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
-000034d0: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
-000034e0: 2020 2023 2046 6972 7374 2063 7265 6174     # First creat
-000034f0: 6520 6120 7265 6c61 7469 6f6e 0a20 2020  e a relation.   
-00003500: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
-00003510: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00003520: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
-00003530: 6573 716c 2729 0a20 2020 2020 2020 2073  esql').        s
-00003540: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-00003550: 616e 6365 2872 656c 5f69 642c 2069 6e74  ance(rel_id, int
-00003560: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00003570: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-00003580: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
-00003590: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
-000035a0: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
-000035b0: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
-000035c0: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
-000035d0: 656c 6174 696f 6e20 7761 7320 6372 6561  elation was crea
-000035e0: 7465 640a 2020 2020 2020 2020 7365 6c66  ted.        self
-000035f0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00003600: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
-00003610: 7328 2764 6227 292c 205b 7265 6c5f 6964  s('db'), [rel_id
-00003620: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00003630: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
-00003640: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
-00003650: 7428 7265 6c5f 6964 292c 205b 2770 6f73  t(rel_id), ['pos
-00003660: 7467 7265 7371 6c2f 3027 5d29 0a20 2020  tgresql/0']).   
-00003670: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-00003680: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-00003690: 6573 6574 3d54 7275 6529 2020 2320 6372  eset=True)  # cr
-000036a0: 6561 7465 6420 6576 656e 7420 6967 6e6f  eated event igno
-000036b0: 7265 640a 2020 2020 2020 2020 2320 4e6f  red.        # No
-000036c0: 7720 7265 6d6f 7665 2072 656c 6174 696f  w remove relatio
-000036d0: 6e0a 2020 2020 2020 2020 6861 726e 6573  n.        harnes
-000036e0: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
-000036f0: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
-00003700: 2020 2320 4368 6563 6b20 7265 6c61 7469    # Check relati
-00003710: 6f6e 206e 6f20 6c6f 6e67 6572 2065 7869  on no longer exi
-00003720: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
-00003730: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00003740: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
-00003750: 7328 2764 6227 292c 205b 5d29 0a20 2020  s('db'), []).   
-00003760: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003770: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
-00003780: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
-00003790: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
-000037a0: 6f6e 5f6c 6973 742c 2072 656c 5f69 6429  on_list, rel_id)
-000037b0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-000037c0: 2072 656c 6174 696f 6e20 6272 6f6b 656e   relation broken
-000037d0: 2065 7665 6e74 2069 7320 7261 6973 6564   event is raised
-000037e0: 2077 6974 6820 636f 7272 6563 7420 6461   with correct da
-000037f0: 7461 0a20 2020 2020 2020 2063 6861 6e67  ta.        chang
-00003800: 6573 203d 2068 6172 6e65 7373 2e63 6861  es = harness.cha
-00003810: 726d 2e67 6574 5f63 6861 6e67 6573 2829  rm.get_changes()
-00003820: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00003830: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
-00003840: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
-00003850: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00003860: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
-00003870: 6e2d 6465 7061 7274 6564 272c 0a20 2020  n-departed',.   
-00003880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003890: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-000038a0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
-000038b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038c0: 2020 2027 6461 7461 273a 207b 2761 7070     'data': {'app
-000038d0: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
-000038e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000038f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003900: 2020 2020 2775 6e69 7427 3a20 2770 6f73      'unit': 'pos
-00003910: 7467 7265 7371 6c2f 3027 2c0a 2020 2020  tgresql/0',.    
+00000260: 7465 7469 6d65 0a69 6d70 6f72 7420 6772  tetime.import gr
+00000270: 700a 696d 706f 7274 2069 6d70 6f72 746c  p.import importl
+00000280: 6962 0a69 6d70 6f72 7420 696e 7370 6563  ib.import inspec
+00000290: 740a 696d 706f 7274 2069 6f0a 696d 706f  t.import io.impo
+000002a0: 7274 2069 7061 6464 7265 7373 0a69 6d70  rt ipaddress.imp
+000002b0: 6f72 7420 6f73 0a69 6d70 6f72 7420 7061  ort os.import pa
+000002c0: 7468 6c69 620a 696d 706f 7274 2070 6c61  thlib.import pla
+000002d0: 7466 6f72 6d0a 696d 706f 7274 2070 7764  tform.import pwd
+000002e0: 0a69 6d70 6f72 7420 7368 7574 696c 0a69  .import shutil.i
+000002f0: 6d70 6f72 7420 7379 730a 696d 706f 7274  mport sys.import
+00000300: 2074 656d 7066 696c 650a 696d 706f 7274   tempfile.import
+00000310: 2074 6578 7477 7261 700a 696d 706f 7274   textwrap.import
+00000320: 2075 6e69 7474 6573 740a 696d 706f 7274   unittest.import
+00000330: 2075 7569 640a 6672 6f6d 2075 6e69 7474   uuid.from unitt
+00000340: 6573 742e 6d6f 636b 2069 6d70 6f72 7420  est.mock import 
+00000350: 4d61 6769 634d 6f63 6b0a 0a69 6d70 6f72  MagicMock..impor
+00000360: 7420 7079 7465 7374 0a69 6d70 6f72 7420  t pytest.import 
+00000370: 7961 6d6c 0a0a 696d 706f 7274 206f 7073  yaml..import ops
+00000380: 0a69 6d70 6f72 7420 6f70 732e 7465 7374  .import ops.test
+00000390: 696e 670a 6672 6f6d 206f 7073 2069 6d70  ing.from ops imp
+000003a0: 6f72 7420 7065 6262 6c65 0a66 726f 6d20  ort pebble.from 
+000003b0: 6f70 732e 6d6f 6465 6c20 696d 706f 7274  ops.model import
+000003c0: 205f 4d6f 6465 6c42 6163 6b65 6e64 0a66   _ModelBackend.f
+000003d0: 726f 6d20 6f70 732e 7065 6262 6c65 2069  rom ops.pebble i
+000003e0: 6d70 6f72 7420 4669 6c65 5479 7065 0a66  mport FileType.f
+000003f0: 726f 6d20 6f70 732e 7465 7374 696e 6720  rom ops.testing 
+00000400: 696d 706f 7274 205f 5465 7374 696e 6750  import _TestingP
+00000410: 6562 626c 6543 6c69 656e 740a 0a69 735f  ebbleClient..is_
+00000420: 6c69 6e75 7820 3d20 706c 6174 666f 726d  linux = platform
+00000430: 2e73 7973 7465 6d28 2920 3d3d 2027 4c69  .system() == 'Li
+00000440: 6e75 7827 0a0a 0a63 6c61 7373 2053 6574  nux'...class Set
+00000450: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
+00000460: 7228 6f70 732e 4368 6172 6d42 6173 6529  r(ops.CharmBase)
+00000470: 3a0a 2020 2020 2222 2253 6574 7320 7065  :.    """Sets pe
+00000480: 6572 2072 656c 6174 696f 6e20 6461 7461  er relation data
+00000490: 2069 6e73 6964 6520 6c65 6164 6572 2d65   inside leader-e
+000004a0: 6c65 6374 6564 2e22 2222 0a0a 2020 2020  lected."""..    
+000004b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000004c0: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
+000004d0: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+000004e0: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
+000004f0: 6b29 0a20 2020 2020 2020 2073 656c 662e  k).        self.
+00000500: 5f70 6565 725f 6e61 6d65 203d 2027 7065  _peer_name = 'pe
+00000510: 6572 270a 2020 2020 2020 2020 7365 6c66  er'.        self
+00000520: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
+00000530: 7665 2873 656c 662e 6f6e 2e6c 6561 6465  ve(self.on.leade
+00000540: 725f 656c 6563 7465 642c 0a20 2020 2020  r_elected,.     
+00000550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000560: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00000570: 6f6e 5f6c 6561 6465 725f 656c 6563 7465  on_leader_electe
+00000580: 6429 0a0a 2020 2020 6465 6620 5f6f 6e5f  d)..    def _on_
+00000590: 6c65 6164 6572 5f65 6c65 6374 6564 2873  leader_elected(s
+000005a0: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
+000005b0: 2020 2020 2070 6565 7273 203d 2073 656c       peers = sel
+000005c0: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+000005d0: 7469 6f6e 2873 656c 662e 5f70 6565 725f  tion(self._peer_
+000005e0: 6e61 6d65 290a 2020 2020 2020 2020 7065  name).        pe
+000005f0: 6572 732e 6461 7461 5b73 656c 662e 6170  ers.data[self.ap
+00000600: 705d 5b22 666f 6f22 5d20 3d20 2262 6172  p]["foo"] = "bar
+00000610: 220a 0a0a 636c 6173 7320 5374 6f72 6167  "...class Storag
+00000620: 6554 6573 7465 7228 6f70 732e 4368 6172  eTester(ops.Char
+00000630: 6d42 6173 6529 3a0a 2020 2020 2222 2252  mBase):.    """R
+00000640: 6563 6f72 6420 7468 6520 7265 6c61 7469  ecord the relati
+00000650: 6f6e 2d63 6861 6e67 6564 2065 7665 6e74  on-changed event
+00000660: 732e 2222 220a 0a20 2020 2064 6566 205f  s."""..    def _
+00000670: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
+00000680: 616d 6577 6f72 6b29 3a0a 2020 2020 2020  amework):.      
+00000690: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+000006a0: 5f5f 2866 7261 6d65 776f 726b 290a 2020  __(framework).  
+000006b0: 2020 2020 2020 7365 6c66 2e6f 6273 6572        self.obser
+000006c0: 7665 645f 6576 656e 7473 203d 205b 5d0a  ved_events = [].
+000006d0: 2020 2020 2020 2020 7365 6c66 2e66 7261          self.fra
+000006e0: 6d65 776f 726b 2e6f 6273 6572 7665 2873  mework.observe(s
+000006f0: 656c 662e 6f6e 2e74 6573 745f 7374 6f72  elf.on.test_stor
+00000700: 6167 655f 6174 7461 6368 6564 2c0a 2020  age_attached,.  
+00000710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000720: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00000730: 662e 5f6f 6e5f 7465 7374 5f73 746f 7261  f._on_test_stora
+00000740: 6765 5f61 7474 6163 6865 6429 0a20 2020  ge_attached).   
+00000750: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+00000760: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+00000770: 2e6f 6e2e 7465 7374 5f73 746f 7261 6765  .on.test_storage
+00000780: 5f64 6574 6163 6869 6e67 2c0a 2020 2020  _detaching,.    
+00000790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000007a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000007b0: 5f6f 6e5f 7465 7374 5f73 746f 7261 6765  _on_test_storage
+000007c0: 5f64 6574 6163 6869 6e67 290a 0a20 2020  _detaching)..   
+000007d0: 2064 6566 205f 6f6e 5f74 6573 745f 7374   def _on_test_st
+000007e0: 6f72 6167 655f 6174 7461 6368 6564 2873  orage_attached(s
+000007f0: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
+00000800: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+00000810: 6564 5f65 7665 6e74 732e 6170 7065 6e64  ed_events.append
+00000820: 2865 7665 6e74 290a 0a20 2020 2064 6566  (event)..    def
+00000830: 205f 6f6e 5f74 6573 745f 7374 6f72 6167   _on_test_storag
+00000840: 655f 6465 7461 6368 696e 6728 7365 6c66  e_detaching(self
+00000850: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
+00000860: 2020 7365 6c66 2e6f 6273 6572 7665 645f    self.observed_
+00000870: 6576 656e 7473 2e61 7070 656e 6428 6576  events.append(ev
+00000880: 656e 7429 0a0a 0a63 6c61 7373 2053 746f  ent)...class Sto
+00000890: 7261 6765 5769 7468 4879 7068 656e 7348  rageWithHyphensH
+000008a0: 656c 7065 7228 6f70 732e 4f62 6a65 6374  elper(ops.Object
+000008b0: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+000008c0: 745f 5f28 7365 6c66 2c20 7061 7265 6e74  t__(self, parent
+000008d0: 2c20 6b65 7929 3a0a 2020 2020 2020 2020  , key):.        
+000008e0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+000008f0: 2870 6172 656e 742c 206b 6579 290a 2020  (parent, key).  
+00000900: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
+00000910: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+00000920: 7061 7265 6e74 2e66 7261 6d65 776f 726b  parent.framework
+00000930: 2e6f 6273 6572 7665 2870 6172 656e 742e  .observe(parent.
+00000940: 6f6e 2e74 6573 745f 7769 7468 5f68 7970  on.test_with_hyp
+00000950: 6865 6e73 5f73 746f 7261 6765 5f61 7474  hens_storage_att
+00000960: 6163 6865 642c 0a20 2020 2020 2020 2020  ached,.         
+00000970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000980: 2020 2020 2020 2020 7365 6c66 2e6f 6e5f          self.on_
+00000990: 7374 6f72 6167 655f 6368 616e 6765 6429  storage_changed)
+000009a0: 0a20 2020 2020 2020 2070 6172 656e 742e  .        parent.
+000009b0: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
+000009c0: 6528 7061 7265 6e74 2e6f 6e2e 7465 7374  e(parent.on.test
+000009d0: 5f77 6974 685f 6879 7068 656e 735f 7374  _with_hyphens_st
+000009e0: 6f72 6167 655f 6465 7461 6368 696e 672c  orage_detaching,
+000009f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a10: 2020 7365 6c66 2e6f 6e5f 7374 6f72 6167    self.on_storag
+00000a20: 655f 6368 616e 6765 6429 0a0a 2020 2020  e_changed)..    
+00000a30: 6465 6620 6f6e 5f73 746f 7261 6765 5f63  def on_storage_c
+00000a40: 6861 6e67 6564 2873 656c 662c 2065 7665  hanged(self, eve
+00000a50: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
+00000a60: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
+00000a70: 2865 7665 6e74 290a 0a0a 636c 6173 7320  (event)...class 
+00000a80: 5465 7374 4861 726e 6573 7328 756e 6974  TestHarness(unit
+00000a90: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
+00000aa0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+00000ab0: 645f 7265 6c61 7469 6f6e 2873 656c 6629  d_relation(self)
+00000ac0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+00000ad0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00000ae0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00000af0: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+00000b00: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00000b10: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+00000b20: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00000b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000b40: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00000b50: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+00000b60: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00000b70: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00000b80: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00000b90: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00000ba0: 7570 290a 2020 2020 2020 2020 7265 6c5f  up).        rel_
+00000bb0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00000bc0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00000bd0: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+00000be0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00000bf0: 7449 7349 6e73 7461 6e63 6528 7265 6c5f  tIsInstance(rel_
+00000c00: 6964 2c20 696e 7429 0a20 2020 2020 2020  id, int).       
+00000c10: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+00000c20: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+00000c30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00000c40: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00000c50: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
+00000c60: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
+00000c70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00000c80: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00000c90: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
+00000ca0: 292c 205b 5d29 0a20 2020 2020 2020 2023  ), []).        #
+00000cb0: 204d 616b 6520 7375 7265 2074 6865 2069   Make sure the i
+00000cc0: 6e69 7469 616c 2064 6174 6120 6261 6773  nitial data bags
+00000cd0: 2066 6f72 206f 7572 2061 7070 2061 6e64   for our app and
+00000ce0: 2075 6e69 7420 6172 6520 656d 7074 792e   unit are empty.
+00000cf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00000d00: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+00000d10: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00000d20: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00000d30: 272c 2069 735f 6170 703d 5472 7565 292c  ', is_app=True),
+00000d40: 207b 7d29 0a20 2020 2020 2020 2073 656c   {}).        sel
+00000d50: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00000d60: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00000d70: 6574 2872 656c 5f69 642c 2027 7465 7374  et(rel_id, 'test
+00000d80: 2d61 7070 2f30 272c 2069 735f 6170 703d  -app/0', is_app=
+00000d90: 4661 6c73 6529 2c20 7b7d 290a 0a20 2020  False), {})..   
+00000da0: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
+00000db0: 6e6e 6563 745f 6465 6661 756c 7428 7365  nnect_default(se
+00000dc0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+00000dd0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00000de0: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+00000df0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+00000e00: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+00000e10: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+00000e20: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+00000e30: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
+00000e40: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+00000e50: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00000e60: 653a 2066 6f6f 2d69 6d61 6765 0a20 2020  e: foo-image.   
+00000e70: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00000e80: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00000e90: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+00000ea0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
+00000eb0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+00000ec0: 2020 2020 2020 2020 6320 3d20 6861 726e          c = harn
+00000ed0: 6573 732e 6d6f 6465 6c2e 756e 6974 2e67  ess.model.unit.g
+00000ee0: 6574 5f63 6f6e 7461 696e 6572 2827 666f  et_container('fo
+00000ef0: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
+00000f00: 662e 6173 7365 7274 4661 6c73 6528 632e  f.assertFalse(c.
+00000f10: 6361 6e5f 636f 6e6e 6563 7428 2929 0a20  can_connect()). 
+00000f20: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000f30: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00000f40: 6262 6c65 2e43 6f6e 6e65 6374 696f 6e45  bble.ConnectionE
+00000f50: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00000f60: 2020 2063 2e67 6574 5f70 6c61 6e28 290a     c.get_plan().
+00000f70: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00000f80: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
+00000f90: 2827 666f 6f27 2c20 5472 7565 290a 2020  ('foo', True).  
+00000fa0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00000fb0: 7454 7275 6528 632e 6361 6e5f 636f 6e6e  tTrue(c.can_conn
+00000fc0: 6563 7428 2929 0a0a 2020 2020 2020 2020  ect())..        
+00000fd0: 6861 726e 6573 732e 7365 745f 6361 6e5f  harness.set_can_
+00000fe0: 636f 6e6e 6563 7428 2766 6f6f 272c 2046  connect('foo', F
+00000ff0: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
+00001000: 6c66 2e61 7373 6572 7446 616c 7365 2863  lf.assertFalse(c
+00001010: 2e63 616e 5f63 6f6e 6e65 6374 2829 290a  .can_connect()).
+00001020: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00001030: 2e63 6f6e 7461 696e 6572 5f70 6562 626c  .container_pebbl
+00001040: 655f 7265 6164 7928 2766 6f6f 2729 0a20  e_ready('foo'). 
+00001050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00001060: 7274 5472 7565 2863 2e63 616e 5f63 6f6e  rtTrue(c.can_con
+00001070: 6e65 6374 2829 290a 2020 2020 2020 2020  nect()).        
+00001080: 632e 6765 745f 706c 616e 2829 2020 2320  c.get_plan()  # 
+00001090: 7368 6f75 6c64 6e27 7420 7261 6973 6520  shouldn't raise 
+000010a0: 436f 6e6e 6563 7469 6f6e 4572 726f 720a  ConnectionError.
+000010b0: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
+000010c0: 6e5f 636f 6e6e 6563 745f 6265 6769 6e5f  n_connect_begin_
+000010d0: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
+000010e0: 6b73 2873 656c 6629 3a0a 2020 2020 2020  ks(self):.      
+000010f0: 2020 7065 6262 6c65 5f72 6561 6479 5f63    pebble_ready_c
+00001100: 616c 6c73 203d 2063 6f6c 6c65 6374 696f  alls = collectio
+00001110: 6e73 2e64 6566 6175 6c74 6469 6374 2869  ns.defaultdict(i
+00001120: 6e74 290a 0a20 2020 2020 2020 2063 6c61  nt)..        cla
+00001130: 7373 204d 7943 6861 726d 286f 7073 2e43  ss MyCharm(ops.C
+00001140: 6861 726d 4261 7365 293a 0a20 2020 2020  harmBase):.     
+00001150: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
+00001160: 745f 5f28 7365 6c66 2c20 2a61 7267 7329  t__(self, *args)
+00001170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001180: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00001190: 5f5f 282a 6172 6773 290a 2020 2020 2020  __(*args).      
+000011a0: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+000011b0: 7261 6d65 776f 726b 2e6f 6273 6572 7665  ramework.observe
+000011c0: 2873 656c 662e 6f6e 2e66 6f6f 5f70 6562  (self.on.foo_peb
+000011d0: 626c 655f 7265 6164 792c 2073 656c 662e  ble_ready, self.
+000011e0: 5f6f 6e5f 7065 6262 6c65 5f72 6561 6479  _on_pebble_ready
+000011f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00001200: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+00001210: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+00001220: 2e62 6172 5f70 6562 626c 655f 7265 6164  .bar_pebble_read
+00001230: 792c 2073 656c 662e 5f6f 6e5f 7065 6262  y, self._on_pebb
+00001240: 6c65 5f72 6561 6479 290a 0a20 2020 2020  le_ready)..     
+00001250: 2020 2020 2020 2064 6566 205f 6f6e 5f70         def _on_p
+00001260: 6562 626c 655f 7265 6164 7928 7365 6c66  ebble_ready(self
+00001270: 2c20 6576 656e 743a 206f 7073 2e50 6562  , event: ops.Peb
+00001280: 626c 6552 6561 6479 4576 656e 7429 3a0a  bleReadyEvent):.
+00001290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000012a0: 6173 7365 7274 2065 7665 6e74 2e77 6f72  assert event.wor
+000012b0: 6b6c 6f61 642e 6361 6e5f 636f 6e6e 6563  kload.can_connec
+000012c0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000012d0: 2020 2020 7065 6262 6c65 5f72 6561 6479      pebble_ready
+000012e0: 5f63 616c 6c73 5b65 7665 6e74 2e77 6f72  _calls[event.wor
+000012f0: 6b6c 6f61 642e 6e61 6d65 5d20 2b3d 2031  kload.name] += 1
+00001300: 0a0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
+00001310: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00001320: 4861 726e 6573 7328 4d79 4368 6172 6d2c  Harness(MyCharm,
+00001330: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00001340: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00001350: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00001360: 2063 6f6e 7461 696e 6572 733a 0a20 2020   containers:.   
+00001370: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+00001380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001390: 7265 736f 7572 6365 3a20 666f 6f2d 696d  resource: foo-im
+000013a0: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
+000013b0: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
+000013c0: 2020 2020 2020 2072 6573 6f75 7263 653a         resource:
+000013d0: 2062 6172 2d69 6d61 6765 0a20 2020 2020   bar-image.     
+000013e0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+000013f0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00001400: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+00001410: 6e75 7029 0a0a 2020 2020 2020 2020 6861  nup)..        ha
+00001420: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
+00001430: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
+00001440: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00001450: 7365 7274 4571 7561 6c28 6469 6374 2870  sertEqual(dict(p
+00001460: 6562 626c 655f 7265 6164 795f 6361 6c6c  ebble_ready_call
+00001470: 7329 2c20 7b27 666f 6f27 3a20 312c 2027  s), {'foo': 1, '
+00001480: 6261 7227 3a20 317d 290a 2020 2020 2020  bar': 1}).      
+00001490: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+000014a0: 6528 6861 726e 6573 732e 6d6f 6465 6c2e  e(harness.model.
+000014b0: 756e 6974 2e63 6f6e 7461 696e 6572 735b  unit.containers[
+000014c0: 2766 6f6f 275d 2e63 616e 5f63 6f6e 6e65  'foo'].can_conne
+000014d0: 6374 2829 290a 2020 2020 2020 2020 7365  ct()).        se
+000014e0: 6c66 2e61 7373 6572 7454 7275 6528 6861  lf.assertTrue(ha
+000014f0: 726e 6573 732e 6d6f 6465 6c2e 756e 6974  rness.model.unit
+00001500: 2e63 6f6e 7461 696e 6572 735b 2762 6172  .containers['bar
+00001510: 275d 2e63 616e 5f63 6f6e 6e65 6374 2829  '].can_connect()
+00001520: 290a 0a20 2020 2020 2020 2068 6172 6e65  )..        harne
+00001530: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+00001540: 6374 2827 666f 6f27 2c20 4661 6c73 6529  ct('foo', False)
+00001550: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00001560: 7365 7274 4661 6c73 6528 6861 726e 6573  sertFalse(harnes
+00001570: 732e 6d6f 6465 6c2e 756e 6974 2e63 6f6e  s.model.unit.con
+00001580: 7461 696e 6572 735b 2766 6f6f 275d 2e63  tainers['foo'].c
+00001590: 616e 5f63 6f6e 6e65 6374 2829 290a 0a20  an_connect()).. 
+000015a0: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+000015b0: 6574 5f63 616e 5f63 6f6e 6e65 6374 2827  et_can_connect('
+000015c0: 666f 6f27 2c20 5472 7565 290a 2020 2020  foo', True).    
+000015d0: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
+000015e0: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
+000015f0: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
+00001600: 6f6f 275d 0a20 2020 2020 2020 2073 656c  oo'].        sel
+00001610: 662e 6173 7365 7274 5472 7565 2863 6f6e  f.assertTrue(con
+00001620: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
+00001630: 6374 2829 290a 2020 2020 2020 2020 636f  ct()).        co
+00001640: 6e74 6169 6e65 722e 6765 745f 706c 616e  ntainer.get_plan
+00001650: 2829 2020 2320 7368 6f75 6c64 6e27 7420  ()  # shouldn't 
+00001660: 7261 6973 6520 436f 6e6e 6563 7469 6f6e  raise Connection
+00001670: 4572 726f 720a 0a20 2020 2064 6566 2074  Error..    def t
+00001680: 6573 745f 6164 645f 7265 6c61 7469 6f6e  est_add_relation
+00001690: 5f61 6e64 5f75 6e69 7428 7365 6c66 293a  _and_unit(self):
+000016a0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000016b0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+000016c0: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+000016d0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+000016e0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+000016f0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00001700: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+00001710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001720: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+00001730: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+00001740: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
+00001750: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00001760: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00001770: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00001780: 7029 0a20 2020 2020 2020 2072 656c 5f69  p).        rel_i
+00001790: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+000017a0: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+000017b0: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
+000017c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000017d0: 4973 496e 7374 616e 6365 2872 656c 5f69  IsInstance(rel_i
+000017e0: 642c 2069 6e74 290a 2020 2020 2020 2020  d, int).        
+000017f0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001800: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
+00001810: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00001820: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00001830: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00001840: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+00001850: 706f 7374 6772 6573 716c 2f30 272c 207b  postgresql/0', {
+00001860: 2766 6f6f 273a 2027 6261 7227 7d29 0a20  'foo': 'bar'}). 
+00001870: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+00001880: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+00001890: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+000018a0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
+000018b0: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
+000018c0: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
+000018d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000018e0: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+000018f0: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
+00001900: 7265 6c5f 6964 292c 205b 2770 6f73 7467  rel_id), ['postg
+00001910: 7265 7371 6c2f 3027 5d29 0a20 2020 2020  resql/0']).     
+00001920: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00001930: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+00001940: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
+00001950: 6e5f 6765 7428 7265 6c5f 6964 2c20 2770  n_get(rel_id, 'p
+00001960: 6f73 7467 7265 7371 6c2f 3027 2c20 6973  ostgresql/0', is
+00001970: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
+00001980: 2020 2020 2020 2020 207b 2766 6f6f 273a           {'foo':
+00001990: 2027 6261 7227 7d29 0a0a 2020 2020 6465   'bar'})..    de
+000019a0: 6620 7465 7374 5f61 6464 5f72 656c 6174  f test_add_relat
+000019b0: 696f 6e5f 7769 7468 5f72 656d 6f74 655f  ion_with_remote_
+000019c0: 6170 705f 6461 7461 2873 656c 6629 3a0a  app_data(self):.
+000019d0: 2020 2020 2020 2020 2320 6c61 6e67 7561          # langua
+000019e0: 6765 3d59 414d 4c0a 2020 2020 2020 2020  ge=YAML.        
+000019f0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00001a00: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+00001a10: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+00001a20: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00001a30: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00001a40: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00001a50: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00001a60: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00001a70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001a80: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00001a90: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00001aa0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00001ab0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00001ac0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00001ad0: 2020 7265 6d6f 7465 5f61 7070 203d 2027    remote_app = '
+00001ae0: 706f 7374 6772 6573 716c 270a 2020 2020  postgresql'.    
+00001af0: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
+00001b00: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00001b10: 6e28 2764 6227 2c20 7265 6d6f 7465 5f61  n('db', remote_a
+00001b20: 7070 290a 2020 2020 2020 2020 6861 726e  pp).        harn
+00001b30: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00001b40: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00001b50: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
+00001b60: 2761 7070 273a 2027 6461 7461 277d 290a  'app': 'data'}).
+00001b70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00001b80: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
+00001b90: 6c5f 6964 2c20 696e 7429 0a20 2020 2020  l_id, int).     
+00001ba0: 2020 2062 6163 6b65 6e64 203d 2068 6172     backend = har
+00001bb0: 6e65 7373 2e5f 6261 636b 656e 640a 2020  ness._backend.  
+00001bc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001bd0: 7445 7175 616c 285b 7265 6c5f 6964 5d2c  tEqual([rel_id],
+00001be0: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
+00001bf0: 6e5f 6964 7328 2764 6227 2929 0a20 2020  n_ids('db')).   
+00001c00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00001c10: 4571 7561 6c28 7b27 6170 7027 3a20 2764  Equal({'app': 'd
+00001c20: 6174 6127 7d2c 2062 6163 6b65 6e64 2e72  ata'}, backend.r
+00001c30: 656c 6174 696f 6e5f 6765 7428 7265 6c5f  elation_get(rel_
+00001c40: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
+00001c50: 6973 5f61 7070 3d54 7275 6529 290a 0a20  is_app=True)).. 
+00001c60: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
+00001c70: 7265 6c61 7469 6f6e 5f77 6974 685f 6f75  relation_with_ou
+00001c80: 725f 696e 6974 6961 6c5f 6461 7461 2873  r_initial_data(s
+00001c90: 656c 6629 3a0a 0a20 2020 2020 2020 2063  elf):..        c
+00001ca0: 6c61 7373 2049 6e69 7469 616c 4461 7461  lass InitialData
+00001cb0: 5465 7374 6572 286f 7073 2e43 6861 726d  Tester(ops.Charm
+00001cc0: 4261 7365 293a 0a20 2020 2020 2020 2020  Base):.         
+00001cd0: 2020 2022 2222 5265 636f 7264 2074 6865     """Record the
+00001ce0: 2072 656c 6174 696f 6e2d 6368 616e 6765   relation-change
+00001cf0: 6420 6576 656e 7473 2e22 2222 0a0a 2020  d events."""..  
+00001d00: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
+00001d10: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
+00001d20: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
+00001d30: 2020 2020 2020 2020 2073 7570 6572 2829           super()
+00001d40: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
+00001d50: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
+00001d60: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+00001d70: 6564 5f65 7665 6e74 7320 3d20 5b5d 0a20  ed_events = []. 
+00001d80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00001d90: 656c 662e 6672 616d 6577 6f72 6b2e 6f62  elf.framework.ob
+00001da0: 7365 7276 6528 7365 6c66 2e6f 6e2e 6462  serve(self.on.db
+00001db0: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
+00001dc0: 642c 2073 656c 662e 5f6f 6e5f 6462 5f72  d, self._on_db_r
+00001dd0: 656c 6174 696f 6e5f 6368 616e 6765 6429  elation_changed)
+00001de0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00001df0: 6620 5f6f 6e5f 6462 5f72 656c 6174 696f  f _on_db_relatio
+00001e00: 6e5f 6368 616e 6765 6428 7365 6c66 2c20  n_changed(self, 
+00001e10: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00001e20: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
+00001e30: 6572 7665 645f 6576 656e 7473 2e61 7070  erved_events.app
+00001e40: 656e 6428 6576 656e 7429 0a0a 2020 2020  end(event)..    
+00001e50: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
+00001e60: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
+00001e70: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00001e80: 672e 4861 726e 6573 7328 496e 6974 6961  g.Harness(Initia
+00001e90: 6c44 6174 6154 6573 7465 722c 206d 6574  lDataTester, met
+00001ea0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00001eb0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00001ec0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00001ed0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00001ee0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00001ef0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001f00: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00001f10: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00001f20: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00001f30: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00001f40: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00001f50: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+00001f60: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00001f70: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+00001f80: 6c27 290a 2020 2020 2020 2020 6861 726e  l').        harn
+00001f90: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00001fa0: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00001fb0: 2027 7465 7374 2d61 7070 272c 207b 276b   'test-app', {'k
+00001fc0: 273a 2027 7631 277d 290a 2020 2020 2020  ': 'v1'}).      
+00001fd0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00001fe0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00001ff0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002000: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
+00002010: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
+00002020: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
+00002030: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
+00002040: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
+00002050: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002060: 616c 287b 276b 273a 2027 7631 277d 2c20  al({'k': 'v1'}, 
+00002070: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+00002080: 5f67 6574 2872 656c 5f69 642c 2027 7465  _get(rel_id, 'te
+00002090: 7374 2d61 7070 272c 2069 735f 6170 703d  st-app', is_app=
+000020a0: 5472 7565 2929 0a20 2020 2020 2020 2073  True)).        s
+000020b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000020c0: 7b27 696e 6772 6573 732d 6164 6472 6573  {'ingress-addres
+000020d0: 7327 3a20 2731 3932 2e30 2e32 2e31 277d  s': '192.0.2.1'}
+000020e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000020f0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
+00002100: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00002110: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
+00002120: 702f 3027 2c20 6973 5f61 7070 3d46 616c  p/0', is_app=Fal
+00002130: 7365 2929 0a0a 2020 2020 2020 2020 6861  se))..        ha
+00002140: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+00002150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00002160: 7445 7175 616c 287b 276b 273a 2027 7631  tEqual({'k': 'v1
+00002170: 277d 2c20 6261 636b 656e 642e 7265 6c61  '}, backend.rela
+00002180: 7469 6f6e 5f67 6574 2872 656c 5f69 642c  tion_get(rel_id,
+00002190: 2027 7465 7374 2d61 7070 272c 2069 735f   'test-app', is_
+000021a0: 6170 703d 5472 7565 2929 0a20 2020 2020  app=True)).     
+000021b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000021c0: 7561 6c28 7b27 696e 6772 6573 732d 6164  ual({'ingress-ad
+000021d0: 6472 6573 7327 3a20 2731 3932 2e30 2e32  dress': '192.0.2
+000021e0: 2e31 277d 2c0a 2020 2020 2020 2020 2020  .1'},.          
+000021f0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00002200: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00002210: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
+00002220: 742d 6170 702f 3027 2c20 6973 5f61 7070  t-app/0', is_app
+00002230: 3d46 616c 7365 2929 0a20 2020 2020 2020  =False)).       
+00002240: 2023 204d 616b 6520 7375 7265 206e 6f20   # Make sure no 
+00002250: 7265 6c61 7469 6f6e 2d63 6861 6e67 6564  relation-changed
+00002260: 2065 7665 6e74 7320 6172 6520 656d 6974   events are emit
+00002270: 7465 6420 666f 7220 6f75 7220 6f77 6e20  ted for our own 
+00002280: 6461 7461 2062 6167 732e 0a20 2020 2020  data bags..     
+00002290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000022a0: 7561 6c28 5b5d 2c20 6861 726e 6573 732e  ual([], harness.
+000022b0: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+000022c0: 7665 6e74 7329 0a0a 2020 2020 2020 2020  vents)..        
+000022d0: 2320 4120 7265 6d6f 7465 2075 6e69 7420  # A remote unit 
+000022e0: 6361 6e20 7374 696c 6c20 7570 6461 7465  can still update
+000022f0: 206f 7572 2061 7070 2072 656c 6174 696f   our app relatio
+00002300: 6e20 6461 7461 2062 6167 2073 696e 6365  n data bag since
+00002310: 206f 7572 2075 6e69 7420 6973 206e 6f74   our unit is not
+00002320: 2061 206c 6561 6465 722e 0a20 2020 2020   a leader..     
+00002330: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00002340: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00002350: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
+00002360: 7027 2c20 7b27 6b27 3a20 2776 3227 7d29  p', {'k': 'v2'})
+00002370: 0a20 2020 2020 2020 2023 2041 6e64 2077  .        # And w
+00002380: 6520 6765 7420 616e 2065 7665 6e74 0a20  e get an event. 
+00002390: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000023a0: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
+000023b0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+000023c0: 6564 5f65 7665 6e74 7329 0a20 2020 2020  ed_events).     
+000023d0: 2020 2023 2057 6520 6361 6e20 616c 736f     # We can also
+000023e0: 2075 7064 6174 6520 6f75 7220 6f77 6e20   update our own 
+000023f0: 7265 6c61 7469 6f6e 2064 6174 612c 2065  relation data, e
+00002400: 7665 6e20 6966 2069 7420 6973 2061 2062  ven if it is a b
+00002410: 6974 2027 6368 6561 7479 270a 2020 2020  it 'cheaty'.    
+00002420: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00002430: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00002440: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+00002450: 7070 2f30 272c 207b 2769 6e67 7265 7373  pp/0', {'ingress
+00002460: 2d61 6464 7265 7373 273a 2027 3139 322e  -address': '192.
+00002470: 302e 322e 3227 7d29 0a20 2020 2020 2020  0.2.2'}).       
+00002480: 2023 2042 7574 206e 6f20 6576 656e 7420   # But no event 
+00002490: 6861 7070 656e 730a 0a20 2020 2020 2020  happens..       
+000024a0: 2023 2055 7064 6174 696e 6720 6f75 7220   # Updating our 
+000024b0: 6461 7461 2061 7070 2072 656c 6174 696f  data app relatio
+000024c0: 6e20 6461 7461 2062 6167 2061 6e64 206f  n data bag and o
+000024d0: 7572 2075 6e69 7420 6461 7461 2062 6167  ur unit data bag
+000024e0: 2064 6f65 7320 6e6f 7420 6765 6e65 7261   does not genera
+000024f0: 7465 2065 7665 6e74 732e 0a20 2020 2020  te events..     
+00002500: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
+00002510: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
+00002520: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00002530: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00002540: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+00002550: 7070 272c 207b 276b 273a 2027 7633 277d  pp', {'k': 'v3'}
+00002560: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00002570: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00002580: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+00002590: 7465 7374 2d61 7070 2f30 272c 207b 2769  test-app/0', {'i
+000025a0: 6e67 7265 7373 2d61 6464 7265 7373 273a  ngress-address':
+000025b0: 2027 3139 322e 302e 322e 3227 7d29 0a20   '192.0.2.2'}). 
+000025c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000025d0: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
+000025e0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+000025f0: 6564 5f65 7665 6e74 7329 0a0a 2020 2020  ed_events)..    
+00002600: 6465 6620 7465 7374 5f61 6464 5f70 6565  def test_add_pee
+00002610: 725f 7265 6c61 7469 6f6e 5f77 6974 685f  r_relation_with_
+00002620: 696e 6974 6961 6c5f 6461 7461 5f6c 6561  initial_data_lea
+00002630: 6465 7228 7365 6c66 293a 0a0a 2020 2020  der(self):..    
+00002640: 2020 2020 636c 6173 7320 496e 6974 6961      class Initia
+00002650: 6c44 6174 6154 6573 7465 7228 6f70 732e  lDataTester(ops.
+00002660: 4368 6172 6d42 6173 6529 3a0a 2020 2020  CharmBase):.    
+00002670: 2020 2020 2020 2020 2222 2252 6563 6f72          """Recor
+00002680: 6420 7468 6520 7265 6c61 7469 6f6e 2d63  d the relation-c
+00002690: 6861 6e67 6564 2065 7665 6e74 732e 2222  hanged events.""
+000026a0: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
+000026b0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000026c0: 2c20 6672 616d 6577 6f72 6b29 3a0a 2020  , framework):.  
+000026d0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+000026e0: 7065 7228 292e 5f5f 696e 6974 5f5f 2866  per().__init__(f
+000026f0: 7261 6d65 776f 726b 290a 2020 2020 2020  ramework).      
+00002700: 2020 2020 2020 2020 2020 7365 6c66 2e6f            self.o
+00002710: 6273 6572 7665 645f 6576 656e 7473 203d  bserved_events =
+00002720: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00002730: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+00002740: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+00002750: 6f6e 2e63 6c75 7374 6572 5f72 656c 6174  on.cluster_relat
+00002760: 696f 6e5f 6368 616e 6765 642c 0a20 2020  ion_changed,.   
+00002770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002790: 2020 2020 7365 6c66 2e5f 6f6e 5f63 6c75      self._on_clu
+000027a0: 7374 6572 5f72 656c 6174 696f 6e5f 6368  ster_relation_ch
+000027b0: 616e 6765 6429 0a0a 2020 2020 2020 2020  anged)..        
+000027c0: 2020 2020 6465 6620 5f6f 6e5f 636c 7573      def _on_clus
+000027d0: 7465 725f 7265 6c61 7469 6f6e 5f63 6861  ter_relation_cha
+000027e0: 6e67 6564 2873 656c 662c 2065 7665 6e74  nged(self, event
+000027f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00002800: 2020 2073 656c 662e 6f62 7365 7276 6564     self.observed
+00002810: 5f65 7665 6e74 732e 6170 7065 6e64 2865  _events.append(e
+00002820: 7665 6e74 290a 0a20 2020 2020 2020 2023  vent)..        #
+00002830: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
+00002840: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00002850: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00002860: 6e65 7373 2849 6e69 7469 616c 4461 7461  ness(InitialData
+00002870: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
+00002880: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00002890: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+000028a0: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
+000028b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000028c0: 6c75 7374 6572 3a0a 2020 2020 2020 2020  luster:.        
+000028d0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+000028e0: 7266 6163 653a 2063 6c75 7374 6572 0a20  rface: cluster. 
+000028f0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00002900: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00002910: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00002920: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00002930: 2023 2054 4f44 4f3a 2064 6d69 7472 6969   # TODO: dmitrii
+00002940: 7320 3230 3230 2d30 342d 3037 2074 6573  s 2020-04-07 tes
+00002950: 7420 6120 6d69 6e69 6f6e 2075 6e69 7420  t a minion unit 
+00002960: 616e 6420 696e 6974 6961 6c20 7065 6572  and initial peer
+00002970: 2072 656c 6174 696f 6e20 6170 7020 6461   relation app da
+00002980: 7461 0a20 2020 2020 2020 2023 2065 7665  ta.        # eve
+00002990: 6e74 7320 7768 656e 2074 6865 2068 6172  nts when the har
+000029a0: 6e65 7373 2062 6567 696e 7320 746f 2065  ness begins to e
+000029b0: 6d69 7420 6576 656e 7473 2066 6f72 2069  mit events for i
+000029c0: 6e69 7469 616c 2064 6174 612e 0a20 2020  nitial data..   
+000029d0: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+000029e0: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
+000029f0: 723d 5472 7565 290a 2020 2020 2020 2020  r=True).        
+00002a00: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00002a10: 2e61 6464 5f72 656c 6174 696f 6e28 2763  .add_relation('c
+00002a20: 6c75 7374 6572 272c 2027 7465 7374 2d61  luster', 'test-a
+00002a30: 7070 2729 0a20 2020 2020 2020 2068 6172  pp').        har
+00002a40: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00002a50: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00002a60: 2c20 2774 6573 742d 6170 7027 2c20 7b27  , 'test-app', {'
+00002a70: 6b27 3a20 2776 277d 290a 2020 2020 2020  k': 'v'}).      
+00002a80: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00002a90: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00002aa0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002ab0: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
+00002ac0: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
+00002ad0: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
+00002ae0: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
+00002af0: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
+00002b00: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002b10: 616c 287b 276b 273a 2027 7627 7d2c 2062  al({'k': 'v'}, b
+00002b20: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00002b30: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
+00002b40: 742d 6170 7027 2c20 6973 5f61 7070 3d54  t-app', is_app=T
+00002b50: 7275 6529 290a 2020 2020 2020 2020 7365  rue)).        se
+00002b60: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
+00002b70: 2769 6e67 7265 7373 2d61 6464 7265 7373  'ingress-address
+00002b80: 273a 2027 3139 322e 302e 322e 3127 7d2c  ': '192.0.2.1'},
+00002b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002ba0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
+00002bb0: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00002bc0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002bd0: 2f30 272c 2069 735f 6170 703d 4661 6c73  /0', is_app=Fals
+00002be0: 6529 290a 0a20 2020 2020 2020 2068 6172  e))..        har
+00002bf0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+00002c00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00002c10: 4571 7561 6c28 7b27 6b27 3a20 2776 277d  Equal({'k': 'v'}
+00002c20: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
+00002c30: 6f6e 5f67 6574 2872 656c 5f69 642c 2027  on_get(rel_id, '
+00002c40: 7465 7374 2d61 7070 272c 2069 735f 6170  test-app', is_ap
+00002c50: 703d 5472 7565 2929 0a20 2020 2020 2020  p=True)).       
+00002c60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00002c70: 6c28 7b27 696e 6772 6573 732d 6164 6472  l({'ingress-addr
+00002c80: 6573 7327 3a20 2731 3932 2e30 2e32 2e31  ess': '192.0.2.1
+00002c90: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00002ca0: 2020 2020 2020 2020 2020 2020 2062 6163               bac
+00002cb0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00002cc0: 7428 7265 6c5f 6964 2c20 2774 6573 742d  t(rel_id, 'test-
+00002cd0: 6170 702f 3027 2c20 6973 5f61 7070 3d46  app/0', is_app=F
+00002ce0: 616c 7365 2929 0a20 2020 2020 2020 2023  alse)).        #
+00002cf0: 204d 616b 6520 7375 7265 206e 6f20 7265   Make sure no re
+00002d00: 6c61 7469 6f6e 2d63 6861 6e67 6564 2065  lation-changed e
+00002d10: 7665 6e74 7320 6172 6520 656d 6974 7465  vents are emitte
+00002d20: 6420 666f 7220 6f75 7220 6f77 6e20 6461  d for our own da
+00002d30: 7461 2062 6167 732e 0a20 2020 2020 2020  ta bags..       
+00002d40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00002d50: 6c28 5b5d 2c20 6861 726e 6573 732e 6368  l([], harness.ch
+00002d60: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
+00002d70: 6e74 7329 0a0a 2020 2020 2020 2020 2320  nts)..        # 
+00002d80: 5570 6461 7469 6e67 206f 7572 2061 7070  Updating our app
+00002d90: 2072 656c 6174 696f 6e20 6461 7461 2062   relation data b
+00002da0: 6167 2061 6e64 206f 7572 2075 6e69 7420  ag and our unit 
+00002db0: 6461 7461 2062 6167 2064 6f65 7320 6e6f  data bag does no
+00002dc0: 7420 7472 6967 6765 7220 6576 656e 7473  t trigger events
+00002dd0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00002de0: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00002df0: 5f64 6174 6128 7265 6c5f 6964 2c20 2774  _data(rel_id, 't
+00002e00: 6573 742d 6170 7027 2c20 7b27 6b27 3a20  est-app', {'k': 
+00002e10: 2776 3227 7d29 0a20 2020 2020 2020 2068  'v2'}).        h
+00002e20: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00002e30: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+00002e40: 6964 2c20 2774 6573 742d 6170 702f 3027  id, 'test-app/0'
+00002e50: 2c20 7b27 696e 6772 6573 732d 6164 6472  , {'ingress-addr
+00002e60: 6573 7327 3a20 2731 3932 2e30 2e32 2e32  ess': '192.0.2.2
+00002e70: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+00002e80: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
+00002e90: 2068 6172 6e65 7373 2e63 6861 726d 2e6f   harness.charm.o
+00002ea0: 6273 6572 7665 645f 6576 656e 7473 290a  bserved_events).
+00002eb0: 0a20 2020 2020 2020 2023 2049 6620 6f75  .        # If ou
+00002ec0: 7220 756e 6974 2062 6563 6f6d 6573 2061  r unit becomes a
+00002ed0: 206d 696e 696f 6e2c 2075 7064 6174 696e   minion, updatin
+00002ee0: 6720 6170 7020 7265 6c61 7469 6f6e 2064  g app relation d
+00002ef0: 6174 6120 696e 6469 7265 6374 6c79 2062  ata indirectly b
+00002f00: 6563 6f6d 6573 2070 6f73 7369 626c 650a  ecomes possible.
+00002f10: 2020 2020 2020 2020 2320 616e 6420 6f75          # and ou
+00002f20: 7220 6368 6172 6d20 6765 7473 206e 6f74  r charm gets not
+00002f30: 6966 6963 6174 696f 6e73 2e0a 2020 2020  ifications..    
+00002f40: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+00002f50: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
+00002f60: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00002f70: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002f80: 7461 2872 656c 5f69 642c 2027 7465 7374  ta(rel_id, 'test
+00002f90: 2d61 7070 272c 207b 276b 273a 2027 7633  -app', {'k': 'v3
+00002fa0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+00002fb0: 2e61 7373 6572 7445 7175 616c 287b 276b  .assertEqual({'k
+00002fc0: 273a 2027 7633 277d 2c20 6261 636b 656e  ': 'v3'}, backen
+00002fd0: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00002fe0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002ff0: 272c 2069 735f 6170 703d 5472 7565 2929  ', is_app=True))
+00003000: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00003010: 7365 7274 5472 7565 286c 656e 2868 6172  sertTrue(len(har
+00003020: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+00003030: 7665 645f 6576 656e 7473 292c 2031 290a  ved_events), 1).
+00003040: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00003050: 6572 7449 7349 6e73 7461 6e63 6528 6861  ertIsInstance(ha
+00003060: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00003070: 7276 6564 5f65 7665 6e74 735b 305d 2c20  rved_events[0], 
+00003080: 6f70 732e 5265 6c61 7469 6f6e 4576 656e  ops.RelationEven
+00003090: 7429 0a0a 2020 2020 6465 6620 7465 7374  t)..    def test
+000030a0: 5f72 656c 6174 696f 6e5f 6765 745f 7768  _relation_get_wh
+000030b0: 656e 5f62 726f 6b65 6e28 7365 6c66 293a  en_broken(self):
+000030c0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000030d0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+000030e0: 6172 6e65 7373 2852 656c 6174 696f 6e42  arness(RelationB
+000030f0: 726f 6b65 6e54 6573 7465 722c 206d 6574  rokenTester, met
+00003100: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00003110: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00003120: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00003130: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00003140: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+00003150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003160: 696e 7465 7266 6163 653a 2066 6f6f 666f  interface: foofo
+00003170: 6f0a 2020 2020 2020 2020 2020 2020 2727  o.            ''
+00003180: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00003190: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+000031a0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+000031b0: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+000031c0: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
+000031d0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+000031e0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+000031f0: 7328 2766 6f6f 2729 0a0a 2020 2020 2020  s('foo')..      
+00003200: 2020 2320 7265 6c61 7469 6f6e 2072 656d    # relation rem
+00003210: 6f74 6520 6170 7020 6973 204e 6f6e 6520  ote app is None 
+00003220: 746f 206d 6972 726f 7220 7072 6f64 7563  to mirror produc
+00003230: 7469 6f6e 204a 756a 7520 6265 6861 7669  tion Juju behavi
+00003240: 6f72 2077 6865 7265 204a 756a 7520 646f  or where Juju do
+00003250: 6573 6e27 740a 2020 2020 2020 2020 2320  esn't.        # 
+00003260: 636f 6d6d 756e 6963 6174 6520 7468 6520  communicate the 
+00003270: 7265 6d6f 7465 2061 7070 2074 6f20 6f70  remote app to op
+00003280: 732e 0a20 2020 2020 2020 2072 656c 5f69  s..        rel_i
+00003290: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+000032a0: 7265 6c61 7469 6f6e 2827 666f 6f27 2c20  relation('foo', 
+000032b0: 4e6f 6e65 290a 0a20 2020 2020 2020 2077  None)..        w
+000032c0: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
+000032d0: 7328 4b65 7945 7272 6f72 2c20 6d61 7463  s(KeyError, matc
+000032e0: 683d 2774 7279 696e 6720 746f 2061 6363  h='trying to acc
+000032f0: 6573 7320 7265 6d6f 7465 2061 7070 2064  ess remote app d
+00003300: 6174 6127 293a 0a20 2020 2020 2020 2020  ata'):.         
+00003310: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
+00003320: 655f 7265 6c61 7469 6f6e 2872 656c 5f69  e_relation(rel_i
+00003330: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
+00003340: 5f72 656d 6f76 655f 7265 6c61 7469 6f6e  _remove_relation
+00003350: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00003360: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00003370: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+00003380: 6c61 7469 6f6e 4576 656e 7443 6861 726d  lationEventCharm
+00003390: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+000033a0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+000033b0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+000033c0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+000033d0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+000033e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000033f0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00003400: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00003410: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00003420: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00003430: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00003440: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00003450: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+00003460: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+00003470: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
+00003480: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
+00003490: 2020 2023 2046 6972 7374 2063 7265 6174     # First creat
+000034a0: 6520 6120 7265 6c61 7469 6f6e 0a20 2020  e a relation.   
+000034b0: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
+000034c0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+000034d0: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
+000034e0: 6573 716c 2729 0a20 2020 2020 2020 2073  esql').        s
+000034f0: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+00003500: 616e 6365 2872 656c 5f69 642c 2069 6e74  ance(rel_id, int
+00003510: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00003520: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00003530: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+00003540: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+00003550: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
+00003560: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
+00003570: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
+00003580: 656c 6174 696f 6e20 7761 7320 6372 6561  elation was crea
+00003590: 7465 640a 2020 2020 2020 2020 7365 6c66  ted.        self
+000035a0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+000035b0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
+000035c0: 7328 2764 6227 292c 205b 7265 6c5f 6964  s('db'), [rel_id
+000035d0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+000035e0: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
+000035f0: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
+00003600: 7428 7265 6c5f 6964 292c 205b 2770 6f73  t(rel_id), ['pos
+00003610: 7467 7265 7371 6c2f 3027 5d29 0a20 2020  tgresql/0']).   
+00003620: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+00003630: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+00003640: 6573 6574 3d54 7275 6529 2020 2320 6372  eset=True)  # cr
+00003650: 6561 7465 6420 6576 656e 7420 6967 6e6f  eated event igno
+00003660: 7265 640a 2020 2020 2020 2020 2320 4e6f  red.        # No
+00003670: 7720 7265 6d6f 7665 2072 656c 6174 696f  w remove relatio
+00003680: 6e0a 2020 2020 2020 2020 6861 726e 6573  n.        harnes
+00003690: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
+000036a0: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
+000036b0: 2020 2320 4368 6563 6b20 7265 6c61 7469    # Check relati
+000036c0: 6f6e 206e 6f20 6c6f 6e67 6572 2065 7869  on no longer exi
+000036d0: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
+000036e0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+000036f0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
+00003700: 7328 2764 6227 292c 205b 5d29 0a20 2020  s('db'), []).   
+00003710: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00003720: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00003730: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
+00003740: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
+00003750: 6f6e 5f6c 6973 742c 2072 656c 5f69 6429  on_list, rel_id)
+00003760: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00003770: 2072 656c 6174 696f 6e20 6272 6f6b 656e   relation broken
+00003780: 2065 7665 6e74 2069 7320 7261 6973 6564   event is raised
+00003790: 2077 6974 6820 636f 7272 6563 7420 6461   with correct da
+000037a0: 7461 0a20 2020 2020 2020 2063 6861 6e67  ta.        chang
+000037b0: 6573 203d 2068 6172 6e65 7373 2e63 6861  es = harness.cha
+000037c0: 726d 2e67 6574 5f63 6861 6e67 6573 2829  rm.get_changes()
+000037d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000037e0: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+000037f0: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00003800: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00003810: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
+00003820: 6e2d 6465 7061 7274 6564 272c 0a20 2020  n-departed',.   
+00003830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003840: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00003850: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+00003860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003870: 2020 2027 6461 7461 273a 207b 2761 7070     'data': {'app
+00003880: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
+00003890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000038a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038b0: 2020 2020 2775 6e69 7427 3a20 2770 6f73      'unit': 'pos
+000038c0: 7467 7265 7371 6c2f 3027 2c0a 2020 2020  tgresql/0',.    
+000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000038f0: 6465 7061 7274 696e 675f 756e 6974 273a  departing_unit':
+00003900: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
+00003910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00003920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003930: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00003940: 6465 7061 7274 696e 675f 756e 6974 273a  departing_unit':
-00003950: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
-00003960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003930: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00003940: 273a 2030 7d7d 290a 2020 2020 2020 2020  ': 0}}).        
+00003950: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003960: 2863 6861 6e67 6573 5b31 5d2c 0a20 2020  (changes[1],.   
 00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003980: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
-00003990: 273a 2030 7d7d 290a 2020 2020 2020 2020  ': 0}}).        
-000039a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000039b0: 2863 6861 6e67 6573 5b31 5d2c 0a20 2020  (changes[1],.   
-000039c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039d0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000039e0: 7265 6c61 7469 6f6e 2d62 726f 6b65 6e27  relation-broken'
-000039f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003a00: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-00003a10: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
-00003a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a30: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-00003a40: 7b27 6170 7027 3a20 2770 6f73 7467 7265  {'app': 'postgre
-00003a50: 7371 6c27 2c0a 2020 2020 2020 2020 2020  sql',.          
-00003a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a70: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
-00003a80: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00003a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003aa0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00003ab0: 696f 6e5f 6964 273a 2072 656c 5f69 647d  ion_id': rel_id}
-00003ac0: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-00003ad0: 5f72 656d 6f76 655f 7370 6563 6966 6963  _remove_specific
-00003ae0: 5f72 656c 6174 696f 6e5f 6964 2873 656c  _relation_id(sel
-00003af0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00003b00: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00003b10: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
-00003b20: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
-00003b30: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00003b40: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00003b50: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00003b60: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00003b70: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b90: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00003ba0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00003bb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00003bc0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00003bd0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00003be0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00003bf0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-00003c00: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-00003c10: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
-00003c20: 2827 6462 2729 0a0a 2020 2020 2020 2020  ('db')..        
-00003c30: 2320 4372 6561 7465 2074 6865 2066 6972  # Create the fir
-00003c40: 7374 2072 656c 6174 696f 6e0a 2020 2020  st relation.    
-00003c50: 2020 2020 7265 6c5f 6964 5f31 203d 2068      rel_id_1 = h
-00003c60: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00003c70: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
-00003c80: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
-00003c90: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-00003ca0: 7461 6e63 6528 7265 6c5f 6964 5f31 2c20  tance(rel_id_1, 
-00003cb0: 696e 7429 0a20 2020 2020 2020 2068 6172  int).        har
-00003cc0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00003cd0: 6e5f 756e 6974 2872 656c 5f69 645f 312c  n_unit(rel_id_1,
-00003ce0: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
-00003cf0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
-00003d00: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
-00003d10: 656e 640a 2020 2020 2020 2020 2320 4368  end.        # Ch
-00003d20: 6563 6b20 7265 6c61 7469 6f6e 2077 6173  eck relation was
-00003d30: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
-00003d40: 2073 656c 662e 6173 7365 7274 496e 2872   self.assertIn(r
-00003d50: 656c 5f69 645f 312c 2062 6163 6b65 6e64  el_id_1, backend
-00003d60: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
-00003d70: 6227 2929 0a20 2020 2020 2020 2073 656c  b')).        sel
-00003d80: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-00003d90: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
-00003da0: 6973 7428 7265 6c5f 6964 5f31 292c 205b  ist(rel_id_1), [
-00003db0: 2770 6f73 7467 7265 7371 6c2f 3027 5d29  'postgresql/0'])
-00003dc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00003dd0: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
-00003de0: 6573 2872 6573 6574 3d54 7275 6529 2020  es(reset=True)  
-00003df0: 2320 6372 6561 7465 6420 6576 656e 7420  # created event 
-00003e00: 6967 6e6f 7265 640a 0a20 2020 2020 2020  ignored..       
-00003e10: 2023 2043 7265 6174 6520 7468 6520 7365   # Create the se
-00003e20: 636f 6e64 2072 656c 6174 696f 6e0a 2020  cond relation.  
-00003e30: 2020 2020 2020 7265 6c5f 6964 5f32 203d        rel_id_2 =
-00003e40: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00003e50: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-00003e60: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-00003e70: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-00003e80: 6e73 7461 6e63 6528 7265 6c5f 6964 5f32  nstance(rel_id_2
-00003e90: 2c20 696e 7429 0a20 2020 2020 2020 2068  , int).        h
-00003ea0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00003eb0: 696f 6e5f 756e 6974 2872 656c 5f69 645f  ion_unit(rel_id_
-00003ec0: 322c 2027 706f 7374 6772 6573 716c 2f31  2, 'postgresql/1
-00003ed0: 2729 0a20 2020 2020 2020 2062 6163 6b65  ').        backe
-00003ee0: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-00003ef0: 636b 656e 640a 2020 2020 2020 2020 2320  ckend.        # 
-00003f00: 4368 6563 6b20 7265 6c61 7469 6f6e 2077  Check relation w
-00003f10: 6173 2063 7265 6174 6564 2061 6e64 2062  as created and b
-00003f20: 6f74 6820 7265 6c61 7469 6f6e 7320 6578  oth relations ex
-00003f30: 6973 740a 2020 2020 2020 2020 7365 6c66  ist.        self
-00003f40: 2e61 7373 6572 7449 6e28 7265 6c5f 6964  .assertIn(rel_id
-00003f50: 5f31 2c20 6261 636b 656e 642e 7265 6c61  _1, backend.rela
-00003f60: 7469 6f6e 5f69 6473 2827 6462 2729 290a  tion_ids('db')).
-00003f70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003f80: 6572 7449 6e28 7265 6c5f 6964 5f32 2c20  ertIn(rel_id_2, 
-00003f90: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-00003fa0: 5f69 6473 2827 6462 2729 290a 2020 2020  _ids('db')).    
-00003fb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00003fc0: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
-00003fd0: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
-00003fe0: 645f 3229 2c20 5b27 706f 7374 6772 6573  d_2), ['postgres
-00003ff0: 716c 2f31 275d 290a 2020 2020 2020 2020  ql/1']).        
-00004000: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-00004010: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
-00004020: 5472 7565 2920 2023 2063 7265 6174 6564  True)  # created
-00004030: 2065 7665 6e74 2069 676e 6f72 6564 0a0a   event ignored..
-00004040: 2020 2020 2020 2020 2320 4e6f 7720 7265          # Now re
-00004050: 6d6f 7665 2073 6563 6f6e 6420 7265 6c61  move second rela
-00004060: 7469 6f6e 0a20 2020 2020 2020 2068 6172  tion.        har
-00004070: 6e65 7373 2e72 656d 6f76 655f 7265 6c61  ness.remove_rela
-00004080: 7469 6f6e 2872 656c 5f69 645f 3229 0a20  tion(rel_id_2). 
-00004090: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
-000040a0: 6563 6f6e 6420 7265 6c61 7469 6f6e 206e  econd relation n
-000040b0: 6f20 6c6f 6e67 6572 2065 7869 7374 7320  o longer exists 
-000040c0: 6275 7420 6669 7273 7420 646f 6573 0a20  but first does. 
-000040d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000040e0: 7274 4571 7561 6c28 6261 636b 656e 642e  rtEqual(backend.
-000040f0: 7265 6c61 7469 6f6e 5f69 6473 2827 6462  relation_ids('db
-00004100: 2729 2c20 5b72 656c 5f69 645f 315d 290a  '), [rel_id_1]).
-00004110: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004120: 6572 7452 6169 7365 7328 6f70 732e 5265  ertRaises(ops.Re
-00004130: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
-00004140: 726f 722c 2062 6163 6b65 6e64 2e72 656c  ror, backend.rel
-00004150: 6174 696f 6e5f 6c69 7374 2c20 7265 6c5f  ation_list, rel_
-00004160: 6964 5f32 290a 0a20 2020 2020 2020 2023  id_2)..        #
-00004170: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
-00004180: 6272 6f6b 656e 2065 7665 6e74 2069 7320  broken event is 
-00004190: 7261 6973 6564 2077 6974 6820 636f 7272  raised with corr
-000041a0: 6563 7420 6461 7461 0a20 2020 2020 2020  ect data.       
-000041b0: 2063 6861 6e67 6573 203d 2068 6172 6e65   changes = harne
-000041c0: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
-000041d0: 6e67 6573 2829 0a20 2020 2020 2020 2073  nges().        s
-000041e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000041f0: 6368 616e 6765 735b 305d 2c0a 2020 2020  changes[0],.    
-00004200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004210: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
-00004220: 656c 6174 696f 6e2d 6465 7061 7274 6564  elation-departed
-00004230: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00004240: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00004250: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004270: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00004280: 207b 2761 7070 273a 2027 706f 7374 6772   {'app': 'postgr
-00004290: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
-000042a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042b0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
-000042c0: 3a20 2770 6f73 7467 7265 7371 6c2f 3127  : 'postgresql/1'
-000042d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000042e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042f0: 2020 2020 2027 6465 7061 7274 696e 675f       'departing_
-00004300: 756e 6974 273a 2027 706f 7374 6772 6573  unit': 'postgres
-00004310: 716c 2f31 272c 0a20 2020 2020 2020 2020  ql/1',.         
-00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004330: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00004340: 696f 6e5f 6964 273a 2072 656c 5f69 645f  ion_id': rel_id_
-00004350: 327d 7d29 0a20 2020 2020 2020 2073 656c  2}}).        sel
-00004360: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00004370: 616e 6765 735b 315d 2c0a 2020 2020 2020  anges[1],.      
-00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004390: 2020 207b 276e 616d 6527 3a20 2772 656c     {'name': 'rel
-000043a0: 6174 696f 6e2d 6272 6f6b 656e 272c 0a20  ation-broken',. 
-000043b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043c0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-000043d0: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
-000043e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043f0: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
-00004400: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
-00004410: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00004420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004430: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
-00004440: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00004450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004460: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-00004470: 5f69 6427 3a20 7265 6c5f 6964 5f32 7d7d  _id': rel_id_2}}
-00004480: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00004490: 7265 6d6f 7669 6e67 5f69 6e76 616c 6964  removing_invalid
-000044a0: 5f72 656c 6174 696f 6e5f 6964 5f72 6169  _relation_id_rai
-000044b0: 7365 735f 6578 6365 7074 696f 6e28 7365  ses_exception(se
-000044c0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-000044d0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-000044e0: 6e67 2e48 6172 6e65 7373 2852 656c 6174  ng.Harness(Relat
-000044f0: 696f 6e45 7665 6e74 4368 6172 6d2c 206d  ionEventCharm, m
-00004500: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00004510: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00004520: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
-00004530: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
-00004540: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
-00004550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004560: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-00004570: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00004580: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00004590: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-000045a0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-000045b0: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-000045c0: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
-000045d0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-000045e0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-000045f0: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
-00004600: 2320 4669 7273 7420 6372 6561 7465 2061  # First create a
-00004610: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
-00004620: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
-00004630: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00004640: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
-00004650: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-00004660: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-00004670: 6528 7265 6c5f 6964 2c20 696e 7429 0a20  e(rel_id, int). 
-00004680: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
-00004690: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-000046a0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-000046b0: 6573 716c 2f30 2729 0a20 2020 2020 2020  esql/0').       
-000046c0: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
-000046d0: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
-000046e0: 2020 2020 2320 4368 6563 6b20 7265 6c61      # Check rela
-000046f0: 7469 6f6e 2077 6173 2063 7265 6174 6564  tion was created
-00004700: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00004710: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00004720: 642e 7265 6c61 7469 6f6e 5f69 6473 2827  d.relation_ids('
-00004730: 6462 2729 2c20 5b72 656c 5f69 645d 290a  db'), [rel_id]).
-00004740: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004750: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
-00004760: 2e72 656c 6174 696f 6e5f 6c69 7374 2872  .relation_list(r
-00004770: 656c 5f69 6429 2c20 5b27 706f 7374 6772  el_id), ['postgr
-00004780: 6573 716c 2f30 275d 290a 2020 2020 2020  esql/0']).      
-00004790: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-000047a0: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
-000047b0: 743d 5472 7565 2920 2023 2063 7265 6174  t=True)  # creat
-000047c0: 6564 2065 7665 6e74 2069 676e 6f72 6564  ed event ignored
-000047d0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-000047e0: 2065 7863 6570 7469 6f6e 2069 7320 7261   exception is ra
-000047f0: 6973 6564 2069 6620 7265 6c61 7469 6f6e  ised if relation
-00004800: 2069 6420 6973 2069 6e76 616c 6964 0a20   id is invalid. 
-00004810: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00004820: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-00004830: 732e 5265 6c61 7469 6f6e 4e6f 7446 6f75  s.RelationNotFou
-00004840: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
-00004850: 2020 2020 2020 6861 726e 6573 732e 7265        harness.re
-00004860: 6d6f 7665 5f72 656c 6174 696f 6e28 7265  move_relation(re
-00004870: 6c5f 6964 202b 2031 290a 0a20 2020 2064  l_id + 1)..    d
-00004880: 6566 2074 6573 745f 7265 6d6f 7665 5f72  ef test_remove_r
-00004890: 656c 6174 696f 6e5f 756e 6974 2873 656c  elation_unit(sel
-000048a0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-000048b0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-000048c0: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
-000048d0: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
-000048e0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-000048f0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00004900: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00004910: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00004920: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00004930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004940: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00004950: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00004960: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00004970: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00004980: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00004990: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-000049a0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-000049b0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-000049c0: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
-000049d0: 2827 6462 2729 0a20 2020 2020 2020 2023  ('db').        #
-000049e0: 2046 6972 7374 2061 6464 2061 2072 656c   First add a rel
-000049f0: 6174 696f 6e20 616e 6420 756e 6974 0a20  ation and unit. 
-00004a00: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-00004a10: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00004a20: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-00004a30: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-00004a40: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-00004a50: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
-00004a60: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
-00004a70: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00004a80: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
-00004a90: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
-00004aa0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
-00004ab0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00004ac0: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
-00004ad0: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
-00004ae0: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
-00004af0: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
-00004b00: 696f 6e20 616e 6420 756e 6974 2077 6572  ion and unit wer
-00004b10: 6520 6372 6561 7465 640a 2020 2020 2020  e created.      
-00004b20: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
-00004b30: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
-00004b40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00004b50: 4571 7561 6c28 6261 636b 656e 642e 7265  Equal(backend.re
-00004b60: 6c61 7469 6f6e 5f69 6473 2827 6462 2729  lation_ids('db')
-00004b70: 2c20 5b72 656c 5f69 645d 290a 2020 2020  , [rel_id]).    
-00004b80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00004b90: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
-00004ba0: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
-00004bb0: 6429 2c20 5b27 706f 7374 6772 6573 716c  d), ['postgresql
-00004bc0: 2f30 275d 290a 2020 2020 2020 2020 6861  /0']).        ha
-00004bd0: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
-00004be0: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
-00004bf0: 7565 2920 2023 2069 676e 6f72 6520 7265  ue)  # ignore re
-00004c00: 6c61 7469 6f6e 2063 7265 6174 6564 2065  lation created e
-00004c10: 7665 6e74 730a 2020 2020 2020 2020 7265  vents.        re
-00004c20: 6c61 7469 6f6e 203d 2068 6172 6e65 7373  lation = harness
-00004c30: 2e63 6861 726d 2e6d 6f64 656c 2e67 6574  .charm.model.get
-00004c40: 5f72 656c 6174 696f 6e28 2764 6227 290a  _relation('db').
-00004c50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004c60: 6572 7445 7175 616c 286c 656e 2872 656c  ertEqual(len(rel
-00004c70: 6174 696f 6e2e 756e 6974 7329 2c20 3129  ation.units), 1)
-00004c80: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00004c90: 2072 656c 6174 696f 6e20 6461 7461 2069   relation data i
-00004ca0: 7320 636f 7272 6563 740a 2020 2020 2020  s correct.      
-00004cb0: 2020 7265 6c5f 756e 6974 203d 2068 6172    rel_unit = har
-00004cc0: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
-00004cd0: 2e67 6574 5f75 6e69 7428 2770 6f73 7467  .get_unit('postg
-00004ce0: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
-00004cf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00004d00: 616c 2872 656c 6174 696f 6e2e 6461 7461  al(relation.data
-00004d10: 5b72 656c 5f75 6e69 745d 5b27 666f 6f27  [rel_unit]['foo'
-00004d20: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
-00004d30: 2020 2320 496e 7374 7275 6374 2074 6865    # Instruct the
-00004d40: 2063 6861 726d 2074 6f20 7265 636f 7264   charm to record
-00004d50: 2074 6865 2072 656c 6174 696f 6e20 6461   the relation da
-00004d60: 7461 2069 7420 7365 6573 2069 6e20 7468  ta it sees in th
-00004d70: 6520 6c69 7374 206f 6620 6368 616e 6765  e list of change
-00004d80: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
-00004d90: 732e 6368 6172 6d2e 7265 636f 7264 5f72  s.charm.record_r
-00004da0: 656c 6174 696f 6e5f 6461 7461 5f6f 6e5f  elation_data_on_
-00004db0: 6576 656e 7473 203d 2054 7275 650a 2020  events = True.  
-00004dc0: 2020 2020 2020 2320 4e6f 7720 7265 6d6f        # Now remo
-00004dd0: 7665 2075 6e69 740a 2020 2020 2020 2020  ve unit.        
-00004de0: 6861 726e 6573 732e 7265 6d6f 7665 5f72  harness.remove_r
-00004df0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00004e00: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-00004e10: 2f30 2729 0a20 2020 2020 2020 2023 2043  /0').        # C
-00004e20: 6865 636b 2072 656c 6174 696f 6e20 7374  heck relation st
-00004e30: 696c 6c20 6578 6973 7473 0a20 2020 2020  ill exists.     
-00004e40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00004e50: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
-00004e60: 7469 6f6e 5f69 6473 2827 6462 2729 2c20  tion_ids('db'), 
-00004e70: 5b72 656c 5f69 645d 290a 2020 2020 2020  [rel_id]).      
-00004e80: 2020 2320 4368 6563 6b20 7265 6d6f 7665    # Check remove
-00004e90: 6420 756e 6974 2064 6f65 7320 6e6f 7420  d unit does not 
-00004ea0: 6578 6973 740a 2020 2020 2020 2020 7365  exist.        se
-00004eb0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00004ec0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00004ed0: 6c69 7374 2872 656c 5f69 6429 2c20 5b5d  list(rel_id), []
-00004ee0: 290a 2020 2020 2020 2020 2320 4368 6563  ).        # Chec
-00004ef0: 6b20 7468 6520 756e 6974 2069 7320 6163  k the unit is ac
-00004f00: 7475 616c 6c79 2072 656d 6f76 6564 2066  tually removed f
-00004f10: 726f 6d20 7468 6520 7265 6c61 7469 6f6e  rom the relation
-00004f20: 7320 7468 6520 6d6f 6465 6c20 6b6e 6f77  s the model know
-00004f30: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
-00004f40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00004f50: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
-00004f60: 726d 2e6d 6f64 656c 2e67 6574 5f72 656c  rm.model.get_rel
-00004f70: 6174 696f 6e28 2764 6227 292e 756e 6974  ation('db').unit
-00004f80: 7329 2c20 3029 0a20 2020 2020 2020 2073  s), 0).        s
-00004f90: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-00004fa0: 7265 6c5f 756e 6974 2069 6e20 6861 726e  rel_unit in harn
-00004fb0: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
-00004fc0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00004fd0: 2729 2e64 6174 6129 0a20 2020 2020 2020  ').data).       
-00004fe0: 2023 2043 6865 636b 2072 656c 6174 696f   # Check relatio
-00004ff0: 6e20 6465 7061 7274 6564 2077 6173 2072  n departed was r
-00005000: 6169 7365 6420 7769 7468 2063 6f72 7265  aised with corre
-00005010: 6374 2064 6174 610a 2020 2020 2020 2020  ct data.        
-00005020: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005030: 287b 276e 616d 6527 3a20 2772 656c 6174  ({'name': 'relat
-00005040: 696f 6e2d 6465 7061 7274 6564 272c 0a20  ion-departed',. 
-00005050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005060: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-00005070: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
-00005080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005090: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
-000050a0: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
-000050b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000050c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050d0: 2020 2020 2020 2775 6e69 7427 3a20 2770        'unit': 'p
-000050e0: 6f73 7467 7265 7371 6c2f 3027 2c0a 2020  ostgresql/0',.  
+00003980: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00003990: 7265 6c61 7469 6f6e 2d62 726f 6b65 6e27  relation-broken'
+000039a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000039b0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+000039c0: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
+000039d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000039e0: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+000039f0: 7b27 6170 7027 3a20 2770 6f73 7467 7265  {'app': 'postgre
+00003a00: 7371 6c27 2c0a 2020 2020 2020 2020 2020  sql',.          
+00003a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a20: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
+00003a30: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00003a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a50: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00003a60: 696f 6e5f 6964 273a 2072 656c 5f69 647d  ion_id': rel_id}
+00003a70: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+00003a80: 5f72 656d 6f76 655f 7370 6563 6966 6963  _remove_specific
+00003a90: 5f72 656c 6174 696f 6e5f 6964 2873 656c  _relation_id(sel
+00003aa0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00003ab0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00003ac0: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
+00003ad0: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
+00003ae0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00003af0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00003b00: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+00003b10: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+00003b20: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+00003b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b40: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00003b50: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00003b60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00003b70: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00003b80: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00003b90: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00003ba0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+00003bb0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+00003bc0: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
+00003bd0: 2827 6462 2729 0a0a 2020 2020 2020 2020  ('db')..        
+00003be0: 2320 4372 6561 7465 2074 6865 2066 6972  # Create the fir
+00003bf0: 7374 2072 656c 6174 696f 6e0a 2020 2020  st relation.    
+00003c00: 2020 2020 7265 6c5f 6964 5f31 203d 2068      rel_id_1 = h
+00003c10: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00003c20: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
+00003c30: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
+00003c40: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00003c50: 7461 6e63 6528 7265 6c5f 6964 5f31 2c20  tance(rel_id_1, 
+00003c60: 696e 7429 0a20 2020 2020 2020 2068 6172  int).        har
+00003c70: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00003c80: 6e5f 756e 6974 2872 656c 5f69 645f 312c  n_unit(rel_id_1,
+00003c90: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
+00003ca0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+00003cb0: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
+00003cc0: 656e 640a 2020 2020 2020 2020 2320 4368  end.        # Ch
+00003cd0: 6563 6b20 7265 6c61 7469 6f6e 2077 6173  eck relation was
+00003ce0: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
+00003cf0: 2073 656c 662e 6173 7365 7274 496e 2872   self.assertIn(r
+00003d00: 656c 5f69 645f 312c 2062 6163 6b65 6e64  el_id_1, backend
+00003d10: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
+00003d20: 6227 2929 0a20 2020 2020 2020 2073 656c  b')).        sel
+00003d30: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00003d40: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
+00003d50: 6973 7428 7265 6c5f 6964 5f31 292c 205b  ist(rel_id_1), [
+00003d60: 2770 6f73 7467 7265 7371 6c2f 3027 5d29  'postgresql/0'])
+00003d70: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00003d80: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
+00003d90: 6573 2872 6573 6574 3d54 7275 6529 2020  es(reset=True)  
+00003da0: 2320 6372 6561 7465 6420 6576 656e 7420  # created event 
+00003db0: 6967 6e6f 7265 640a 0a20 2020 2020 2020  ignored..       
+00003dc0: 2023 2043 7265 6174 6520 7468 6520 7365   # Create the se
+00003dd0: 636f 6e64 2072 656c 6174 696f 6e0a 2020  cond relation.  
+00003de0: 2020 2020 2020 7265 6c5f 6964 5f32 203d        rel_id_2 =
+00003df0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00003e00: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
+00003e10: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+00003e20: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+00003e30: 6e73 7461 6e63 6528 7265 6c5f 6964 5f32  nstance(rel_id_2
+00003e40: 2c20 696e 7429 0a20 2020 2020 2020 2068  , int).        h
+00003e50: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00003e60: 696f 6e5f 756e 6974 2872 656c 5f69 645f  ion_unit(rel_id_
+00003e70: 322c 2027 706f 7374 6772 6573 716c 2f31  2, 'postgresql/1
+00003e80: 2729 0a20 2020 2020 2020 2062 6163 6b65  ').        backe
+00003e90: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
+00003ea0: 636b 656e 640a 2020 2020 2020 2020 2320  ckend.        # 
+00003eb0: 4368 6563 6b20 7265 6c61 7469 6f6e 2077  Check relation w
+00003ec0: 6173 2063 7265 6174 6564 2061 6e64 2062  as created and b
+00003ed0: 6f74 6820 7265 6c61 7469 6f6e 7320 6578  oth relations ex
+00003ee0: 6973 740a 2020 2020 2020 2020 7365 6c66  ist.        self
+00003ef0: 2e61 7373 6572 7449 6e28 7265 6c5f 6964  .assertIn(rel_id
+00003f00: 5f31 2c20 6261 636b 656e 642e 7265 6c61  _1, backend.rela
+00003f10: 7469 6f6e 5f69 6473 2827 6462 2729 290a  tion_ids('db')).
+00003f20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00003f30: 6572 7449 6e28 7265 6c5f 6964 5f32 2c20  ertIn(rel_id_2, 
+00003f40: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+00003f50: 5f69 6473 2827 6462 2729 290a 2020 2020  _ids('db')).    
+00003f60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00003f70: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00003f80: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
+00003f90: 645f 3229 2c20 5b27 706f 7374 6772 6573  d_2), ['postgres
+00003fa0: 716c 2f31 275d 290a 2020 2020 2020 2020  ql/1']).        
+00003fb0: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+00003fc0: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
+00003fd0: 5472 7565 2920 2023 2063 7265 6174 6564  True)  # created
+00003fe0: 2065 7665 6e74 2069 676e 6f72 6564 0a0a   event ignored..
+00003ff0: 2020 2020 2020 2020 2320 4e6f 7720 7265          # Now re
+00004000: 6d6f 7665 2073 6563 6f6e 6420 7265 6c61  move second rela
+00004010: 7469 6f6e 0a20 2020 2020 2020 2068 6172  tion.        har
+00004020: 6e65 7373 2e72 656d 6f76 655f 7265 6c61  ness.remove_rela
+00004030: 7469 6f6e 2872 656c 5f69 645f 3229 0a20  tion(rel_id_2). 
+00004040: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
+00004050: 6563 6f6e 6420 7265 6c61 7469 6f6e 206e  econd relation n
+00004060: 6f20 6c6f 6e67 6572 2065 7869 7374 7320  o longer exists 
+00004070: 6275 7420 6669 7273 7420 646f 6573 0a20  but first does. 
+00004080: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00004090: 7274 4571 7561 6c28 6261 636b 656e 642e  rtEqual(backend.
+000040a0: 7265 6c61 7469 6f6e 5f69 6473 2827 6462  relation_ids('db
+000040b0: 2729 2c20 5b72 656c 5f69 645f 315d 290a  '), [rel_id_1]).
+000040c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000040d0: 6572 7452 6169 7365 7328 6f70 732e 5265  ertRaises(ops.Re
+000040e0: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
+000040f0: 726f 722c 2062 6163 6b65 6e64 2e72 656c  ror, backend.rel
+00004100: 6174 696f 6e5f 6c69 7374 2c20 7265 6c5f  ation_list, rel_
+00004110: 6964 5f32 290a 0a20 2020 2020 2020 2023  id_2)..        #
+00004120: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00004130: 6272 6f6b 656e 2065 7665 6e74 2069 7320  broken event is 
+00004140: 7261 6973 6564 2077 6974 6820 636f 7272  raised with corr
+00004150: 6563 7420 6461 7461 0a20 2020 2020 2020  ect data.       
+00004160: 2063 6861 6e67 6573 203d 2068 6172 6e65   changes = harne
+00004170: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+00004180: 6e67 6573 2829 0a20 2020 2020 2020 2073  nges().        s
+00004190: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000041a0: 6368 616e 6765 735b 305d 2c0a 2020 2020  changes[0],.    
+000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041c0: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+000041d0: 656c 6174 696f 6e2d 6465 7061 7274 6564  elation-departed
+000041e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000041f0: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00004200: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+00004210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004220: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00004230: 207b 2761 7070 273a 2027 706f 7374 6772   {'app': 'postgr
+00004240: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
+00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004260: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+00004270: 3a20 2770 6f73 7467 7265 7371 6c2f 3127  : 'postgresql/1'
+00004280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042a0: 2020 2020 2027 6465 7061 7274 696e 675f       'departing_
+000042b0: 756e 6974 273a 2027 706f 7374 6772 6573  unit': 'postgres
+000042c0: 716c 2f31 272c 0a20 2020 2020 2020 2020  ql/1',.         
+000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042e0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000042f0: 696f 6e5f 6964 273a 2072 656c 5f69 645f  ion_id': rel_id_
+00004300: 327d 7d29 0a20 2020 2020 2020 2073 656c  2}}).        sel
+00004310: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00004320: 616e 6765 735b 315d 2c0a 2020 2020 2020  anges[1],.      
+00004330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004340: 2020 207b 276e 616d 6527 3a20 2772 656c     {'name': 'rel
+00004350: 6174 696f 6e2d 6272 6f6b 656e 272c 0a20  ation-broken',. 
+00004360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004370: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00004380: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+00004390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043a0: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
+000043b0: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
+000043c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000043d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043e0: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
+000043f0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00004400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004410: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00004420: 5f69 6427 3a20 7265 6c5f 6964 5f32 7d7d  _id': rel_id_2}}
+00004430: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00004440: 7265 6d6f 7669 6e67 5f69 6e76 616c 6964  removing_invalid
+00004450: 5f72 656c 6174 696f 6e5f 6964 5f72 6169  _relation_id_rai
+00004460: 7365 735f 6578 6365 7074 696f 6e28 7365  ses_exception(se
+00004470: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+00004480: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00004490: 6e67 2e48 6172 6e65 7373 2852 656c 6174  ng.Harness(Relat
+000044a0: 696f 6e45 7665 6e74 4368 6172 6d2c 206d  ionEventCharm, m
+000044b0: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+000044c0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+000044d0: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
+000044e0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
+000044f0: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
+00004500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004510: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
+00004520: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
+00004530: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00004540: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00004550: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00004560: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+00004570: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
+00004580: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+00004590: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+000045a0: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
+000045b0: 2320 4669 7273 7420 6372 6561 7465 2061  # First create a
+000045c0: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
+000045d0: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+000045e0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+000045f0: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+00004600: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+00004610: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+00004620: 6528 7265 6c5f 6964 2c20 696e 7429 0a20  e(rel_id, int). 
+00004630: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+00004640: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+00004650: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+00004660: 6573 716c 2f30 2729 0a20 2020 2020 2020  esql/0').       
+00004670: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+00004680: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+00004690: 2020 2020 2320 4368 6563 6b20 7265 6c61      # Check rela
+000046a0: 7469 6f6e 2077 6173 2063 7265 6174 6564  tion was created
+000046b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000046c0: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+000046d0: 642e 7265 6c61 7469 6f6e 5f69 6473 2827  d.relation_ids('
+000046e0: 6462 2729 2c20 5b72 656c 5f69 645d 290a  db'), [rel_id]).
+000046f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004700: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
+00004710: 2e72 656c 6174 696f 6e5f 6c69 7374 2872  .relation_list(r
+00004720: 656c 5f69 6429 2c20 5b27 706f 7374 6772  el_id), ['postgr
+00004730: 6573 716c 2f30 275d 290a 2020 2020 2020  esql/0']).      
+00004740: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
+00004750: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
+00004760: 743d 5472 7565 2920 2023 2063 7265 6174  t=True)  # creat
+00004770: 6564 2065 7665 6e74 2069 676e 6f72 6564  ed event ignored
+00004780: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00004790: 2065 7863 6570 7469 6f6e 2069 7320 7261   exception is ra
+000047a0: 6973 6564 2069 6620 7265 6c61 7469 6f6e  ised if relation
+000047b0: 2069 6420 6973 2069 6e76 616c 6964 0a20   id is invalid. 
+000047c0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000047d0: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+000047e0: 732e 5265 6c61 7469 6f6e 4e6f 7446 6f75  s.RelationNotFou
+000047f0: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
+00004800: 2020 2020 2020 6861 726e 6573 732e 7265        harness.re
+00004810: 6d6f 7665 5f72 656c 6174 696f 6e28 7265  move_relation(re
+00004820: 6c5f 6964 202b 2031 290a 0a20 2020 2064  l_id + 1)..    d
+00004830: 6566 2074 6573 745f 7265 6d6f 7665 5f72  ef test_remove_r
+00004840: 656c 6174 696f 6e5f 756e 6974 2873 656c  elation_unit(sel
+00004850: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00004860: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00004870: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
+00004880: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
+00004890: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+000048a0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+000048b0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+000048c0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+000048d0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+000048e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000048f0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00004900: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00004910: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00004920: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00004930: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00004940: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00004950: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+00004960: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+00004970: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
+00004980: 2827 6462 2729 0a20 2020 2020 2020 2023  ('db').        #
+00004990: 2046 6972 7374 2061 6464 2061 2072 656c   First add a rel
+000049a0: 6174 696f 6e20 616e 6420 756e 6974 0a20  ation and unit. 
+000049b0: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+000049c0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+000049d0: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+000049e0: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+000049f0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00004a00: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00004a10: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
+00004a20: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00004a30: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
+00004a40: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
+00004a50: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00004a60: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00004a70: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+00004a80: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
+00004a90: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+00004aa0: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
+00004ab0: 696f 6e20 616e 6420 756e 6974 2077 6572  ion and unit wer
+00004ac0: 6520 6372 6561 7465 640a 2020 2020 2020  e created.      
+00004ad0: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+00004ae0: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
+00004af0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00004b00: 4571 7561 6c28 6261 636b 656e 642e 7265  Equal(backend.re
+00004b10: 6c61 7469 6f6e 5f69 6473 2827 6462 2729  lation_ids('db')
+00004b20: 2c20 5b72 656c 5f69 645d 290a 2020 2020  , [rel_id]).    
+00004b30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00004b40: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00004b50: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
+00004b60: 6429 2c20 5b27 706f 7374 6772 6573 716c  d), ['postgresql
+00004b70: 2f30 275d 290a 2020 2020 2020 2020 6861  /0']).        ha
+00004b80: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
+00004b90: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
+00004ba0: 7565 2920 2023 2069 676e 6f72 6520 7265  ue)  # ignore re
+00004bb0: 6c61 7469 6f6e 2063 7265 6174 6564 2065  lation created e
+00004bc0: 7665 6e74 730a 2020 2020 2020 2020 7265  vents.        re
+00004bd0: 6c61 7469 6f6e 203d 2068 6172 6e65 7373  lation = harness
+00004be0: 2e63 6861 726d 2e6d 6f64 656c 2e67 6574  .charm.model.get
+00004bf0: 5f72 656c 6174 696f 6e28 2764 6227 290a  _relation('db').
+00004c00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004c10: 6572 7445 7175 616c 286c 656e 2872 656c  ertEqual(len(rel
+00004c20: 6174 696f 6e2e 756e 6974 7329 2c20 3129  ation.units), 1)
+00004c30: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00004c40: 2072 656c 6174 696f 6e20 6461 7461 2069   relation data i
+00004c50: 7320 636f 7272 6563 740a 2020 2020 2020  s correct.      
+00004c60: 2020 7265 6c5f 756e 6974 203d 2068 6172    rel_unit = har
+00004c70: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
+00004c80: 2e67 6574 5f75 6e69 7428 2770 6f73 7467  .get_unit('postg
+00004c90: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
+00004ca0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00004cb0: 616c 2872 656c 6174 696f 6e2e 6461 7461  al(relation.data
+00004cc0: 5b72 656c 5f75 6e69 745d 5b27 666f 6f27  [rel_unit]['foo'
+00004cd0: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
+00004ce0: 2020 2320 496e 7374 7275 6374 2074 6865    # Instruct the
+00004cf0: 2063 6861 726d 2074 6f20 7265 636f 7264   charm to record
+00004d00: 2074 6865 2072 656c 6174 696f 6e20 6461   the relation da
+00004d10: 7461 2069 7420 7365 6573 2069 6e20 7468  ta it sees in th
+00004d20: 6520 6c69 7374 206f 6620 6368 616e 6765  e list of change
+00004d30: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
+00004d40: 732e 6368 6172 6d2e 7265 636f 7264 5f72  s.charm.record_r
+00004d50: 656c 6174 696f 6e5f 6461 7461 5f6f 6e5f  elation_data_on_
+00004d60: 6576 656e 7473 203d 2054 7275 650a 2020  events = True.  
+00004d70: 2020 2020 2020 2320 4e6f 7720 7265 6d6f        # Now remo
+00004d80: 7665 2075 6e69 740a 2020 2020 2020 2020  ve unit.        
+00004d90: 6861 726e 6573 732e 7265 6d6f 7665 5f72  harness.remove_r
+00004da0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00004db0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+00004dc0: 2f30 2729 0a20 2020 2020 2020 2023 2043  /0').        # C
+00004dd0: 6865 636b 2072 656c 6174 696f 6e20 7374  heck relation st
+00004de0: 696c 6c20 6578 6973 7473 0a20 2020 2020  ill exists.     
+00004df0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00004e00: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00004e10: 7469 6f6e 5f69 6473 2827 6462 2729 2c20  tion_ids('db'), 
+00004e20: 5b72 656c 5f69 645d 290a 2020 2020 2020  [rel_id]).      
+00004e30: 2020 2320 4368 6563 6b20 7265 6d6f 7665    # Check remove
+00004e40: 6420 756e 6974 2064 6f65 7320 6e6f 7420  d unit does not 
+00004e50: 6578 6973 740a 2020 2020 2020 2020 7365  exist.        se
+00004e60: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00004e70: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00004e80: 6c69 7374 2872 656c 5f69 6429 2c20 5b5d  list(rel_id), []
+00004e90: 290a 2020 2020 2020 2020 2320 4368 6563  ).        # Chec
+00004ea0: 6b20 7468 6520 756e 6974 2069 7320 6163  k the unit is ac
+00004eb0: 7475 616c 6c79 2072 656d 6f76 6564 2066  tually removed f
+00004ec0: 726f 6d20 7468 6520 7265 6c61 7469 6f6e  rom the relation
+00004ed0: 7320 7468 6520 6d6f 6465 6c20 6b6e 6f77  s the model know
+00004ee0: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
+00004ef0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00004f00: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
+00004f10: 726d 2e6d 6f64 656c 2e67 6574 5f72 656c  rm.model.get_rel
+00004f20: 6174 696f 6e28 2764 6227 292e 756e 6974  ation('db').unit
+00004f30: 7329 2c20 3029 0a20 2020 2020 2020 2073  s), 0).        s
+00004f40: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+00004f50: 7265 6c5f 756e 6974 2069 6e20 6861 726e  rel_unit in harn
+00004f60: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00004f70: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00004f80: 2729 2e64 6174 6129 0a20 2020 2020 2020  ').data).       
+00004f90: 2023 2043 6865 636b 2072 656c 6174 696f   # Check relatio
+00004fa0: 6e20 6465 7061 7274 6564 2077 6173 2072  n departed was r
+00004fb0: 6169 7365 6420 7769 7468 2063 6f72 7265  aised with corre
+00004fc0: 6374 2064 6174 610a 2020 2020 2020 2020  ct data.        
+00004fd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00004fe0: 287b 276e 616d 6527 3a20 2772 656c 6174  ({'name': 'relat
+00004ff0: 696f 6e2d 6465 7061 7274 6564 272c 0a20  ion-departed',. 
+00005000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005010: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00005020: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+00005030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005040: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
+00005050: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
+00005060: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00005070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005080: 2020 2020 2020 2775 6e69 7427 3a20 2770        'unit': 'p
+00005090: 6f73 7467 7265 7371 6c2f 3027 2c0a 2020  ostgresql/0',.  
+000050a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000050b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000050c0: 2027 6465 7061 7274 696e 675f 756e 6974   'departing_unit
+000050d0: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
+000050e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 000050f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005110: 2027 6465 7061 7274 696e 675f 756e 6974   'departing_unit
-00005120: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
-00005130: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005150: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
-00005160: 6964 273a 2030 2c0a 2020 2020 2020 2020  id': 0,.        
+00005100: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
+00005110: 6964 273a 2030 2c0a 2020 2020 2020 2020  id': 0,.        
+00005120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005130: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
+00005140: 7469 6f6e 5f64 6174 6127 3a20 7b27 7465  tion_data': {'te
+00005150: 7374 2d61 7070 2f30 273a 207b 7d2c 0a20  st-app/0': {},. 
+00005160: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005180: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00005190: 7469 6f6e 5f64 6174 6127 3a20 7b27 7465  tion_data': {'te
-000051a0: 7374 2d61 7070 2f30 273a 207b 7d2c 0a20  st-app/0': {},. 
+00005180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005190: 2020 2020 2774 6573 742d 6170 7027 3a20      'test-app': 
+000051a0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
 000051b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000051c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051e0: 2020 2020 2774 6573 742d 6170 7027 3a20      'test-app': 
-000051f0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
+000051d0: 2020 2020 2020 2020 2027 706f 7374 6772           'postgr
+000051e0: 6573 716c 2f30 273a 207b 2766 6f6f 273a  esql/0': {'foo':
+000051f0: 2027 6261 7227 7d2c 0a20 2020 2020 2020   'bar'},.       
 00005200: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005220: 2020 2020 2020 2020 2027 706f 7374 6772           'postgr
-00005230: 6573 716c 2f30 273a 207b 2766 6f6f 273a  esql/0': {'foo':
-00005240: 2027 6261 7227 7d2c 0a20 2020 2020 2020   'bar'},.       
-00005250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005270: 2020 2020 2020 2020 2020 2020 2020 2770                'p
-00005280: 6f73 7467 7265 7371 6c27 3a20 7b7d 7d7d  ostgresql': {}}}
-00005290: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-000052a0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
-000052b0: 6573 732e 6368 6172 6d2e 6765 745f 6368  ess.charm.get_ch
-000052c0: 616e 6765 7328 295b 305d 290a 0a20 2020  anges()[0])..   
-000052d0: 2064 6566 2074 6573 745f 7265 6d6f 7669   def test_removi
-000052e0: 6e67 5f72 656c 6174 696f 6e5f 7265 6d6f  ng_relation_remo
-000052f0: 7665 735f 7265 6d6f 7465 5f61 7070 5f64  ves_remote_app_d
-00005300: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
-00005310: 2020 2023 206c 616e 6775 6167 653d 5941     # language=YA
-00005320: 4d4c 0a20 2020 2020 2020 2068 6172 6e65  ML.        harne
-00005330: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-00005340: 2e48 6172 6e65 7373 2852 656c 6174 696f  .Harness(Relatio
-00005350: 6e45 7665 6e74 4368 6172 6d2c 206d 6574  nEventCharm, met
-00005360: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00005370: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00005380: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00005390: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-000053a0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-000053b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000053c0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-000053d0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-000053e0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-000053f0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00005400: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00005410: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-00005420: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00005430: 732e 6368 6172 6d2e 6f62 7365 7276 655f  s.charm.observe_
-00005440: 7265 6c61 7469 6f6e 5f65 7665 6e74 7328  relation_events(
-00005450: 2764 6227 290a 2020 2020 2020 2020 2320  'db').        # 
-00005460: 4164 6420 6120 7265 6c61 7469 6f6e 2061  Add a relation a
-00005470: 6e64 2075 7064 6174 6520 6170 7020 6461  nd update app da
-00005480: 7461 0a20 2020 2020 2020 2072 656d 6f74  ta.        remot
-00005490: 655f 6170 7020 3d20 2770 6f73 7467 7265  e_app = 'postgre
-000054a0: 7371 6c27 0a20 2020 2020 2020 2072 656c  sql'.        rel
-000054b0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-000054c0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-000054d0: 2072 656d 6f74 655f 6170 7029 0a20 2020   remote_app).   
-000054e0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-000054f0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00005500: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
-00005510: 7265 7371 6c27 2c20 7b27 6170 7027 3a20  resql', {'app': 
-00005520: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-00005530: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-00005540: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
-00005550: 6e74 290a 2020 2020 2020 2020 2320 4368  nt).        # Ch
-00005560: 6563 6b20 7265 6c61 7469 6f6e 2061 7070  eck relation app
-00005570: 2064 6174 6120 6578 6973 7473 0a20 2020   data exists.   
-00005580: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
-00005590: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
-000055a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000055b0: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
-000055c0: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
-000055d0: 6227 292c 205b 7265 6c5f 6964 5d29 0a20  b'), [rel_id]). 
-000055e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000055f0: 7274 4571 7561 6c28 7b27 6170 7027 3a20  rtEqual({'app': 
-00005600: 2764 6174 6127 7d2c 2062 6163 6b65 6e64  'data'}, backend
-00005610: 2e72 656c 6174 696f 6e5f 6765 7428 7265  .relation_get(re
-00005620: 6c5f 6964 2c20 7265 6d6f 7465 5f61 7070  l_id, remote_app
-00005630: 2c20 6973 5f61 7070 3d54 7275 6529 290a  , is_app=True)).
-00005640: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00005650: 7265 6d6f 7665 5f72 656c 6174 696f 6e28  remove_relation(
-00005660: 7265 6c5f 6964 290a 2020 2020 2020 2020  rel_id).        
-00005670: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
-00005680: 2061 6e64 2061 7070 2064 6174 6120 6172   and app data ar
-00005690: 6520 7265 6d6f 7665 640a 2020 2020 2020  e removed.      
-000056a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000056b0: 616c 2862 6163 6b65 6e64 2e72 656c 6174  al(backend.relat
-000056c0: 696f 6e5f 6964 7328 2764 6227 292c 205b  ion_ids('db'), [
-000056d0: 5d29 0a20 2020 2020 2020 2077 6974 6820  ]).        with 
-000056e0: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
-000056f0: 6f6e 7465 7874 2827 666f 6f27 293a 0a20  ontext('foo'):. 
-00005700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005710: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-00005720: 2e52 656c 6174 696f 6e4e 6f74 466f 756e  .RelationNotFoun
-00005730: 6445 7272 6f72 2c20 6261 636b 656e 642e  dError, backend.
-00005740: 7265 6c61 7469 6f6e 5f67 6574 2c0a 2020  relation_get,.  
-00005750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005760: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
-00005770: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
-00005780: 6973 5f61 7070 3d54 7275 6529 0a0a 2020  is_app=True)..  
-00005790: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
-000057a0: 696e 675f 7265 6c61 7469 6f6e 5f72 6566  ing_relation_ref
-000057b0: 7265 7368 6573 5f63 6861 726d 5f6d 6f64  reshes_charm_mod
-000057c0: 656c 2873 656c 6629 3a0a 2020 2020 2020  el(self):.      
-000057d0: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
-000057e0: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
-000057f0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-00005800: 4861 726e 6573 7328 5265 6c61 7469 6f6e  Harness(Relation
-00005810: 4576 656e 7443 6861 726d 2c20 6d65 7461  EventCharm, meta
-00005820: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00005830: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
-00005840: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-00005850: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
-00005860: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00005870: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00005880: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
-00005890: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-000058a0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-000058b0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-000058c0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-000058d0: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
-000058e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000058f0: 2e63 6861 726d 2e6f 6273 6572 7665 5f72  .charm.observe_r
-00005900: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
-00005910: 6462 2729 0a20 2020 2020 2020 2023 2041  db').        # A
-00005920: 6464 2061 2072 656c 6174 696f 6e20 616e  dd a relation an
-00005930: 6420 7570 6461 7465 2061 7070 2064 6174  d update app dat
-00005940: 610a 2020 2020 2020 2020 7265 6d6f 7465  a.        remote
-00005950: 5f61 7070 203d 2027 706f 7374 6772 6573  _app = 'postgres
-00005960: 716c 270a 2020 2020 2020 2020 7265 6c5f  ql'.        rel_
-00005970: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-00005980: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-00005990: 7265 6d6f 7465 5f61 7070 290a 2020 2020  remote_app).    
-000059a0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-000059b0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-000059c0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-000059d0: 6573 716c 272c 207b 2761 7070 273a 2027  esql', {'app': '
-000059e0: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
-000059f0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-00005a00: 7461 6e63 6528 7265 6c5f 6964 2c20 696e  tance(rel_id, in
-00005a10: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-00005a20: 6173 7365 7274 4973 4e6f 744e 6f6e 6528  assertIsNotNone(
-00005a30: 7365 6c66 2e5f 6669 6e64 5f72 656c 6174  self._find_relat
-00005a40: 696f 6e5f 696e 5f6d 6f64 656c 5f62 795f  ion_in_model_by_
-00005a50: 6964 2868 6172 6e65 7373 2c20 7265 6c5f  id(harness, rel_
-00005a60: 6964 2929 0a0a 2020 2020 2020 2020 2320  id))..        # 
-00005a70: 4368 6563 6b20 7265 6c61 7469 6f6e 2061  Check relation a
-00005a80: 7070 2064 6174 6120 6578 6973 7473 0a20  pp data exists. 
-00005a90: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
-00005aa0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-00005ab0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-00005ac0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-00005ad0: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
-00005ae0: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
-00005af0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00005b00: 7365 7274 4571 7561 6c28 7b27 6170 7027  sertEqual({'app'
-00005b10: 3a20 2764 6174 6127 7d2c 2062 6163 6b65  : 'data'}, backe
-00005b20: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-00005b30: 7265 6c5f 6964 2c20 7265 6d6f 7465 5f61  rel_id, remote_a
-00005b40: 7070 2c20 6973 5f61 7070 3d54 7275 6529  pp, is_app=True)
-00005b50: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00005b60: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
-00005b70: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
-00005b80: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
-00005b90: 6f6e 6528 7365 6c66 2e5f 6669 6e64 5f72  one(self._find_r
-00005ba0: 656c 6174 696f 6e5f 696e 5f6d 6f64 656c  elation_in_model
-00005bb0: 5f62 795f 6964 2868 6172 6e65 7373 2c20  _by_id(harness, 
-00005bc0: 7265 6c5f 6964 2929 0a0a 2020 2020 6465  rel_id))..    de
-00005bd0: 6620 5f66 696e 645f 7265 6c61 7469 6f6e  f _find_relation
-00005be0: 5f69 6e5f 6d6f 6465 6c5f 6279 5f69 6428  _in_model_by_id(
-00005bf0: 7365 6c66 2c20 6861 726e 6573 732c 2072  self, harness, r
-00005c00: 656c 5f69 6429 3a0a 2020 2020 2020 2020  el_id):.        
-00005c10: 666f 7220 7265 6c61 7469 6f6e 7320 696e  for relations in
-00005c20: 2068 6172 6e65 7373 2e63 6861 726d 2e6d   harness.charm.m
-00005c30: 6f64 656c 2e72 656c 6174 696f 6e73 2e76  odel.relations.v
-00005c40: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-00005c50: 2020 2020 2066 6f72 2072 656c 6174 696f       for relatio
-00005c60: 6e20 696e 2072 656c 6174 696f 6e73 3a0a  n in relations:.
-00005c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c80: 6966 2072 656c 5f69 6420 3d3d 2072 656c  if rel_id == rel
-00005c90: 6174 696f 6e2e 6964 3a0a 2020 2020 2020  ation.id:.      
-00005ca0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00005cb0: 7475 726e 2072 656c 6174 696f 6e0a 2020  turn relation.  
-00005cc0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00005cd0: 650a 0a20 2020 2064 6566 2074 6573 745f  e..    def test_
-00005ce0: 7265 6d6f 7669 6e67 5f72 656c 6174 696f  removing_relatio
-00005cf0: 6e5f 756e 6974 5f72 656d 6f76 6573 5f64  n_unit_removes_d
-00005d00: 6174 615f 616c 736f 2873 656c 6629 3a0a  ata_also(self):.
-00005d10: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00005d20: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-00005d30: 726e 6573 7328 5265 6c61 7469 6f6e 4576  rness(RelationEv
-00005d40: 656e 7443 6861 726d 2c20 6d65 7461 3d27  entCharm, meta='
-00005d50: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-00005d60: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-00005d70: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-00005d80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00005d90: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00005da0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00005db0: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-00005dc0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-00005dd0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00005de0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00005df0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-00005e00: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-00005e10: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
-00005e20: 6861 726d 2e6f 6273 6572 7665 5f72 656c  harm.observe_rel
-00005e30: 6174 696f 6e5f 6576 656e 7473 2827 6462  ation_events('db
-00005e40: 2729 0a20 2020 2020 2020 2023 2041 6464  ').        # Add
-00005e50: 2061 2072 656c 6174 696f 6e20 616e 6420   a relation and 
-00005e60: 756e 6974 2077 6974 6820 6461 7461 0a20  unit with data. 
-00005e70: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-00005e80: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00005e90: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-00005ea0: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-00005eb0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-00005ec0: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
-00005ed0: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
-00005ee0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00005ef0: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
-00005f00: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
-00005f10: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
-00005f20: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00005f30: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
-00005f40: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
-00005f50: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
-00005f60: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
-00005f70: 696f 6e2c 2075 6e69 7420 616e 6420 6461  ion, unit and da
-00005f80: 7461 2065 7869 7374 0a20 2020 2020 2020  ta exist.       
-00005f90: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
-00005fa0: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
-00005fb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00005fc0: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
-00005fd0: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
-00005fe0: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
-00005ff0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00006000: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
-00006010: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
-00006020: 292c 205b 2770 6f73 7467 7265 7371 6c2f  ), ['postgresql/
-00006030: 3027 5d29 0a20 2020 2020 2020 2073 656c  0']).        sel
-00006040: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00006050: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-00006060: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-00006070: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
-00006080: 7371 6c2f 3027 2c20 6973 5f61 7070 3d46  sql/0', is_app=F
-00006090: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
-000060a0: 2020 207b 2766 6f6f 273a 2027 6261 7227     {'foo': 'bar'
-000060b0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-000060c0: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
-000060d0: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
-000060e0: 2020 2320 6967 6e6f 7265 2072 656c 6174    # ignore relat
-000060f0: 696f 6e20 6372 6561 7465 6420 6576 656e  ion created even
-00006100: 7473 0a20 2020 2020 2020 2023 2052 656d  ts.        # Rem
-00006110: 6f76 6520 756e 6974 2062 7574 206e 6f74  ove unit but not
-00006120: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
-00006130: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
-00006140: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-00006150: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00006160: 716c 2f30 2729 0a20 2020 2020 2020 2023  ql/0').        #
-00006170: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
-00006180: 6578 6973 7473 2062 7574 2075 6e69 7420  exists but unit 
-00006190: 616e 6420 6461 7461 2061 7265 2072 656d  and data are rem
-000061a0: 6f76 6564 0a20 2020 2020 2020 2073 656c  oved.        sel
-000061b0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-000061c0: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
-000061d0: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
-000061e0: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
-000061f0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00006200: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
-00006210: 7374 2872 656c 5f69 6429 2c20 5b5d 290a  st(rel_id), []).
-00006220: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00006230: 6572 7452 6169 7365 7328 4b65 7945 7272  ertRaises(KeyErr
-00006240: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00006250: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00006260: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00006270: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-00006280: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00006290: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
-000062a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062b0: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
-000062c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062d0: 2020 2020 2020 2020 2020 6973 5f61 7070            is_app
-000062e0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
-000062f0: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
-00006300: 2064 6570 6172 7465 6420 7761 7320 7261   departed was ra
-00006310: 6973 6564 2077 6974 6820 636f 7272 6563  ised with correc
-00006320: 7420 6461 7461 0a20 2020 2020 2020 2073  t data.        s
-00006330: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006340: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-00006350: 745f 6368 616e 6765 7328 295b 305d 2c0a  t_changes()[0],.
-00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006370: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-00006380: 3a20 2772 656c 6174 696f 6e2d 6465 7061  : 'relation-depa
-00006390: 7274 6564 272c 0a20 2020 2020 2020 2020  rted',.         
-000063a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063b0: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
-000063c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000063d0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-000063e0: 7461 273a 207b 2761 7070 273a 2027 706f  ta': {'app': 'po
-000063f0: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
-00006400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006410: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00006420: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
-00006430: 6c2f 3027 2c0a 2020 2020 2020 2020 2020  l/0',.          
-00006440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006450: 2020 2020 2020 2020 2027 6465 7061 7274           'depart
-00006460: 696e 675f 756e 6974 273a 2027 706f 7374  ing_unit': 'post
-00006470: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
-00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006490: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-000064a0: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
-000064b0: 5f69 647d 7d29 0a0a 2020 2020 6465 6620  _id}})..    def 
-000064c0: 7465 7374 5f72 656d 6f76 696e 675f 7265  test_removing_re
-000064d0: 6c61 7469 6f6e 5f75 6e69 745f 646f 6573  lation_unit_does
-000064e0: 5f6e 6f74 5f72 656d 6f76 655f 6f74 6865  _not_remove_othe
-000064f0: 725f 756e 6974 5f61 6e64 5f64 6174 6128  r_unit_and_data(
-00006500: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-00006510: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-00006520: 7469 6e67 2e48 6172 6e65 7373 2852 656c  ting.Harness(Rel
-00006530: 6174 696f 6e45 7665 6e74 4368 6172 6d2c  ationEventCharm,
-00006540: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-00006550: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-00006560: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-00006570: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-00006580: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065a0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-000065b0: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-000065c0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-000065d0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-000065e0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-000065f0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-00006600: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
-00006610: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-00006620: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
-00006630: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
-00006640: 2020 2320 4164 6420 6120 7265 6c61 7469    # Add a relati
-00006650: 6f6e 2077 6974 6820 7477 6f20 756e 6974  on with two unit
-00006660: 7320 7769 7468 2064 6174 610a 2020 2020  s with data.    
-00006670: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
-00006680: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00006690: 6e28 2764 6227 2c20 2770 6f73 7467 7265  n('db', 'postgre
-000066a0: 7371 6c27 290a 2020 2020 2020 2020 7365  sql').        se
-000066b0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-000066c0: 6e63 6528 7265 6c5f 6964 2c20 696e 7429  nce(rel_id, int)
-000066d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000066e0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-000066f0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
-00006700: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
-00006710: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-00006720: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00006730: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-00006740: 2f31 2729 0a20 2020 2020 2020 2068 6172  /1').        har
-00006750: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00006760: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00006770: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
-00006780: 2c20 7b27 666f 6f30 273a 2027 6261 7230  , {'foo0': 'bar0
-00006790: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
-000067a0: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-000067b0: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-000067c0: 2027 706f 7374 6772 6573 716c 2f31 272c   'postgresql/1',
-000067d0: 207b 2766 6f6f 3127 3a20 2762 6172 3127   {'foo1': 'bar1'
-000067e0: 7d29 0a20 2020 2020 2020 2023 2043 6865  }).        # Che
-000067f0: 636b 2062 6f74 6820 756e 6974 2061 6e64  ck both unit and
-00006800: 2064 6174 6120 6172 6520 7072 6573 656e   data are presen
-00006810: 740a 2020 2020 2020 2020 6261 636b 656e  t.        backen
-00006820: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
-00006830: 6b65 6e64 0a20 2020 2020 2020 2073 656c  kend.        sel
-00006840: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-00006850: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
-00006860: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
-00006870: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
-00006880: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00006890: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
-000068a0: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
-000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068c0: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
-000068d0: 6c2f 3027 2c20 2770 6f73 7467 7265 7371  l/0', 'postgresq
-000068e0: 6c2f 3127 5d29 0a20 2020 2020 2020 2073  l/1']).        s
-000068f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006900: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
-00006910: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-00006920: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-00006930: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
-00006940: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
-00006950: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
-00006960: 6172 3027 7d29 0a20 2020 2020 2020 2073  ar0'}).        s
-00006970: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006980: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
-00006990: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-000069a0: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-000069b0: 7265 7371 6c2f 3127 2c20 6973 5f61 7070  resql/1', is_app
-000069c0: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
-000069d0: 2020 2020 207b 2766 6f6f 3127 3a20 2762       {'foo1': 'b
-000069e0: 6172 3127 7d29 0a20 2020 2020 2020 2068  ar1'}).        h
-000069f0: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
-00006a00: 5f63 6861 6e67 6573 2872 6573 6574 3d54  _changes(reset=T
-00006a10: 7275 6529 2020 2320 6967 6e6f 7265 2072  rue)  # ignore r
-00006a20: 656c 6174 696f 6e20 6372 6561 7465 6420  elation created 
-00006a30: 6576 656e 7473 0a20 2020 2020 2020 2023  events.        #
-00006a40: 2052 656d 6f76 6520 6f6e 6c79 206f 6e65   Remove only one
-00006a50: 2075 6e69 740a 2020 2020 2020 2020 6861   unit.        ha
-00006a60: 726e 6573 732e 7265 6d6f 7665 5f72 656c  rness.remove_rel
-00006a70: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
-00006a80: 642c 2027 706f 7374 6772 6573 716c 2f31  d, 'postgresql/1
-00006a90: 2729 0a20 2020 2020 2020 2023 2043 6865  ').        # Che
-00006aa0: 636b 206f 7468 6572 2075 6e69 7420 616e  ck other unit an
-00006ab0: 6420 6461 7461 2073 7469 6c6c 2065 7869  d data still exi
-00006ac0: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
-00006ad0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00006ae0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
-00006af0: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
-00006b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b10: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
-00006b20: 6c2f 3027 5d29 0a20 2020 2020 2020 2073  l/0']).        s
-00006b30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006b40: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
-00006b50: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-00006b60: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-00006b70: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
-00006b80: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
-00006b90: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
-00006ba0: 6172 3027 7d29 0a20 2020 2020 2020 2023  ar0'}).        #
-00006bb0: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
-00006bc0: 6465 7061 7274 6564 2077 6173 2072 6169  departed was rai
-00006bd0: 7365 6420 7769 7468 2063 6f72 7265 6374  sed with correct
-00006be0: 2064 6174 610a 2020 2020 2020 2020 7365   data.        se
-00006bf0: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
-00006c00: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
-00006c10: 5f63 6861 6e67 6573 2829 5b30 5d2c 0a20  _changes()[0],. 
-00006c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c30: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00006c40: 2027 7265 6c61 7469 6f6e 2d64 6570 6172   'relation-depar
-00006c50: 7465 6427 2c0a 2020 2020 2020 2020 2020  ted',.          
-00006c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c70: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
-00006c80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006c90: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
-00006ca0: 6127 3a20 7b27 6170 7027 3a20 2770 6f73  a': {'app': 'pos
-00006cb0: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00006cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006cd0: 2020 2020 2020 2020 2020 2020 2027 756e               'un
-00006ce0: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
-00006cf0: 2f31 272c 0a20 2020 2020 2020 2020 2020  /1',.           
-00006d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d10: 2020 2020 2020 2020 2764 6570 6172 7469          'departi
-00006d20: 6e67 5f75 6e69 7427 3a20 2770 6f73 7467  ng_unit': 'postg
-00006d30: 7265 7371 6c2f 3127 2c0a 2020 2020 2020  resql/1',.      
-00006d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d50: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00006d60: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
-00006d70: 6964 7d7d 290a 0a20 2020 2064 6566 2074  id}})..    def t
-00006d80: 6573 745f 7265 6c61 7469 6f6e 5f65 7665  est_relation_eve
-00006d90: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
-00006da0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-00006db0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-00006dc0: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
-00006dd0: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
-00006de0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00006df0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-00006e00: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-00006e10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00006e20: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-00006e30: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-00006e40: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
-00006e50: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00006e60: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00006e70: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00006e80: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-00006e90: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
-00006ea0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-00006eb0: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
-00006ec0: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
-00006ed0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00006ee0: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
-00006ef0: 2e67 6574 5f63 6861 6e67 6573 2829 2c20  .get_changes(), 
-00006f00: 5b5d 290a 2020 2020 2020 2020 7265 6c5f  []).        rel_
-00006f10: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-00006f20: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-00006f30: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
-00006f40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006f50: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
-00006f60: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
-00006f70: 6d2e 6765 745f 6368 616e 6765 7328 292c  m.get_changes(),
-00006f80: 0a20 2020 2020 2020 2020 2020 205b 7b27  .            [{'
-00006f90: 6e61 6d65 273a 2027 7265 6c61 7469 6f6e  name': 'relation
-00006fa0: 2d63 7265 6174 6564 272c 0a20 2020 2020  -created',.     
-00006fb0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-00006fc0: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
-00006fd0: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00006fe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00006ff0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00007000: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00007010: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
-00007020: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00007030: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-00007040: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-00007050: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00007060: 207d 7d5d 290a 2020 2020 2020 2020 6861   }}]).        ha
-00007070: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00007080: 6f6e 5f75 6e69 7428 7265 6c5f 6964 2c20  on_unit(rel_id, 
-00007090: 2770 6f73 7467 7265 7371 6c2f 3027 290a  'postgresql/0').
-000070a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000070b0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-000070c0: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-000070d0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
-000070e0: 292c 0a20 2020 2020 2020 2020 2020 205b  ),.            [
-000070f0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-00007100: 6f6e 2d6a 6f69 6e65 6427 2c0a 2020 2020  on-joined',.    
-00007110: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00007120: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-00007130: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-00007140: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00007150: 2020 2020 2020 2761 7070 273a 2027 706f        'app': 'po
-00007160: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
-00007170: 2020 2020 2020 2020 2020 2020 2027 756e               'un
-00007180: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
-00007190: 2f30 272c 0a20 2020 2020 2020 2020 2020  /0',.           
-000071a0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-000071b0: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
-000071c0: 2020 2020 2020 2020 2020 2020 7d7d 5d29              }}])
-000071d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000071e0: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-000071f0: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
-00007200: 6f73 7467 7265 7371 6c27 2c20 7b27 666f  ostgresql', {'fo
-00007210: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
-00007220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007230: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00007240: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-00007250: 6765 745f 6368 616e 6765 7328 292c 0a20  get_changes(),. 
-00007260: 2020 2020 2020 2020 2020 205b 7b27 6e61             [{'na
-00007270: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
-00007280: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
-00007290: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-000072a0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
-000072b0: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
-000072c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000072d0: 2020 2027 6170 7027 3a20 2770 6f73 7467     'app': 'postg
-000072e0: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
-000072f0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
-00007300: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00007310: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00007320: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
-00007330: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
-00007340: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
-00007350: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00007360: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00007370: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
-00007380: 207b 2762 617a 273a 2027 6269 6e67 277d   {'baz': 'bing'}
-00007390: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000073a0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-000073b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000073c0: 6368 6172 6d2e 6765 745f 6368 616e 6765  charm.get_change
-000073d0: 7328 292c 0a20 2020 2020 2020 2020 2020  s(),.           
-000073e0: 205b 7b27 6e61 6d65 273a 2027 7265 6c61   [{'name': 'rela
-000073f0: 7469 6f6e 2d63 6861 6e67 6564 272c 0a20  tion-changed',. 
-00007400: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00007410: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-00007420: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-00007430: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
-00007440: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
-00007450: 2770 6f73 7467 7265 7371 6c27 2c0a 2020  'postgresql',.  
-00007460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007470: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
-00007480: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
-00007490: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-000074a0: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
-000074b0: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
-000074c0: 7d5d 290a 0a20 2020 2064 6566 2074 6573  }])..    def tes
-000074d0: 745f 6765 745f 7265 6c61 7469 6f6e 5f64  t_get_relation_d
-000074e0: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
-000074f0: 2020 2063 6861 726d 5f6d 6574 6120 3d20     charm_meta = 
-00007500: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00007510: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
-00007520: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-00007530: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-00007540: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
-00007550: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-00007560: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
-00007570: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00007580: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-00007590: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-000075a0: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
-000075b0: 6574 613d 6368 6172 6d5f 6d65 7461 290a  eta=charm_meta).
-000075c0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-000075d0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-000075e0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-000075f0: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-00007600: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-00007610: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-00007620: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00007630: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00007640: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-00007650: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
-00007660: 7265 6d6f 7465 273a 2027 6461 7461 277d  remote': 'data'}
-00007670: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00007680: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-00007690: 7373 2e67 6574 5f72 656c 6174 696f 6e5f  ss.get_relation_
-000076a0: 6461 7461 2872 656c 5f69 642c 2027 7465  data(rel_id, 'te
-000076b0: 7374 2d61 7070 2729 2c20 7b7d 290a 2020  st-app'), {}).  
-000076c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000076d0: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
-000076e0: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
-000076f0: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
-00007700: 7070 2f30 2729 2c20 7b7d 290a 2020 2020  pp/0'), {}).    
+00005220: 2020 2020 2020 2020 2020 2020 2020 2770                'p
+00005230: 6f73 7467 7265 7371 6c27 3a20 7b7d 7d7d  ostgresql': {}}}
+00005240: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00005250: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+00005260: 6573 732e 6368 6172 6d2e 6765 745f 6368  ess.charm.get_ch
+00005270: 616e 6765 7328 295b 305d 290a 0a20 2020  anges()[0])..   
+00005280: 2064 6566 2074 6573 745f 7265 6d6f 7669   def test_removi
+00005290: 6e67 5f72 656c 6174 696f 6e5f 7265 6d6f  ng_relation_remo
+000052a0: 7665 735f 7265 6d6f 7465 5f61 7070 5f64  ves_remote_app_d
+000052b0: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
+000052c0: 2020 2023 206c 616e 6775 6167 653d 5941     # language=YA
+000052d0: 4d4c 0a20 2020 2020 2020 2068 6172 6e65  ML.        harne
+000052e0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+000052f0: 2e48 6172 6e65 7373 2852 656c 6174 696f  .Harness(Relatio
+00005300: 6e45 7665 6e74 4368 6172 6d2c 206d 6574  nEventCharm, met
+00005310: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00005320: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00005330: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00005340: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00005350: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00005360: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00005370: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00005380: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00005390: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+000053a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+000053b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+000053c0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+000053d0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+000053e0: 732e 6368 6172 6d2e 6f62 7365 7276 655f  s.charm.observe_
+000053f0: 7265 6c61 7469 6f6e 5f65 7665 6e74 7328  relation_events(
+00005400: 2764 6227 290a 2020 2020 2020 2020 2320  'db').        # 
+00005410: 4164 6420 6120 7265 6c61 7469 6f6e 2061  Add a relation a
+00005420: 6e64 2075 7064 6174 6520 6170 7020 6461  nd update app da
+00005430: 7461 0a20 2020 2020 2020 2072 656d 6f74  ta.        remot
+00005440: 655f 6170 7020 3d20 2770 6f73 7467 7265  e_app = 'postgre
+00005450: 7371 6c27 0a20 2020 2020 2020 2072 656c  sql'.        rel
+00005460: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+00005470: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+00005480: 2072 656d 6f74 655f 6170 7029 0a20 2020   remote_app).   
+00005490: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+000054a0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+000054b0: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
+000054c0: 7265 7371 6c27 2c20 7b27 6170 7027 3a20  resql', {'app': 
+000054d0: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
+000054e0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+000054f0: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00005500: 6e74 290a 2020 2020 2020 2020 2320 4368  nt).        # Ch
+00005510: 6563 6b20 7265 6c61 7469 6f6e 2061 7070  eck relation app
+00005520: 2064 6174 6120 6578 6973 7473 0a20 2020   data exists.   
+00005530: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
+00005540: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
+00005550: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005560: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
+00005570: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
+00005580: 6227 292c 205b 7265 6c5f 6964 5d29 0a20  b'), [rel_id]). 
+00005590: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000055a0: 7274 4571 7561 6c28 7b27 6170 7027 3a20  rtEqual({'app': 
+000055b0: 2764 6174 6127 7d2c 2062 6163 6b65 6e64  'data'}, backend
+000055c0: 2e72 656c 6174 696f 6e5f 6765 7428 7265  .relation_get(re
+000055d0: 6c5f 6964 2c20 7265 6d6f 7465 5f61 7070  l_id, remote_app
+000055e0: 2c20 6973 5f61 7070 3d54 7275 6529 290a  , is_app=True)).
+000055f0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00005600: 7265 6d6f 7665 5f72 656c 6174 696f 6e28  remove_relation(
+00005610: 7265 6c5f 6964 290a 2020 2020 2020 2020  rel_id).        
+00005620: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
+00005630: 2061 6e64 2061 7070 2064 6174 6120 6172   and app data ar
+00005640: 6520 7265 6d6f 7665 640a 2020 2020 2020  e removed.      
+00005650: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00005660: 616c 2862 6163 6b65 6e64 2e72 656c 6174  al(backend.relat
+00005670: 696f 6e5f 6964 7328 2764 6227 292c 205b  ion_ids('db'), [
+00005680: 5d29 0a20 2020 2020 2020 2077 6974 6820  ]).        with 
+00005690: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
+000056a0: 6f6e 7465 7874 2827 666f 6f27 293a 0a20  ontext('foo'):. 
+000056b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000056c0: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+000056d0: 2e52 656c 6174 696f 6e4e 6f74 466f 756e  .RelationNotFoun
+000056e0: 6445 7272 6f72 2c20 6261 636b 656e 642e  dError, backend.
+000056f0: 7265 6c61 7469 6f6e 5f67 6574 2c0a 2020  relation_get,.  
+00005700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005710: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+00005720: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
+00005730: 6973 5f61 7070 3d54 7275 6529 0a0a 2020  is_app=True)..  
+00005740: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
+00005750: 696e 675f 7265 6c61 7469 6f6e 5f72 6566  ing_relation_ref
+00005760: 7265 7368 6573 5f63 6861 726d 5f6d 6f64  reshes_charm_mod
+00005770: 656c 2873 656c 6629 3a0a 2020 2020 2020  el(self):.      
+00005780: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
+00005790: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
+000057a0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+000057b0: 4861 726e 6573 7328 5265 6c61 7469 6f6e  Harness(Relation
+000057c0: 4576 656e 7443 6861 726d 2c20 6d65 7461  EventCharm, meta
+000057d0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+000057e0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+000057f0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00005800: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00005810: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+00005820: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00005830: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
+00005840: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00005850: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00005860: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00005870: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00005880: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+00005890: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000058a0: 2e63 6861 726d 2e6f 6273 6572 7665 5f72  .charm.observe_r
+000058b0: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
+000058c0: 6462 2729 0a20 2020 2020 2020 2023 2041  db').        # A
+000058d0: 6464 2061 2072 656c 6174 696f 6e20 616e  dd a relation an
+000058e0: 6420 7570 6461 7465 2061 7070 2064 6174  d update app dat
+000058f0: 610a 2020 2020 2020 2020 7265 6d6f 7465  a.        remote
+00005900: 5f61 7070 203d 2027 706f 7374 6772 6573  _app = 'postgres
+00005910: 716c 270a 2020 2020 2020 2020 7265 6c5f  ql'.        rel_
+00005920: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00005930: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00005940: 7265 6d6f 7465 5f61 7070 290a 2020 2020  remote_app).    
+00005950: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00005960: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00005970: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+00005980: 6573 716c 272c 207b 2761 7070 273a 2027  esql', {'app': '
+00005990: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
+000059a0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+000059b0: 7461 6e63 6528 7265 6c5f 6964 2c20 696e  tance(rel_id, in
+000059c0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+000059d0: 6173 7365 7274 4973 4e6f 744e 6f6e 6528  assertIsNotNone(
+000059e0: 7365 6c66 2e5f 6669 6e64 5f72 656c 6174  self._find_relat
+000059f0: 696f 6e5f 696e 5f6d 6f64 656c 5f62 795f  ion_in_model_by_
+00005a00: 6964 2868 6172 6e65 7373 2c20 7265 6c5f  id(harness, rel_
+00005a10: 6964 2929 0a0a 2020 2020 2020 2020 2320  id))..        # 
+00005a20: 4368 6563 6b20 7265 6c61 7469 6f6e 2061  Check relation a
+00005a30: 7070 2064 6174 6120 6578 6973 7473 0a20  pp data exists. 
+00005a40: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+00005a50: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+00005a60: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+00005a70: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
+00005a80: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
+00005a90: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
+00005aa0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00005ab0: 7365 7274 4571 7561 6c28 7b27 6170 7027  sertEqual({'app'
+00005ac0: 3a20 2764 6174 6127 7d2c 2062 6163 6b65  : 'data'}, backe
+00005ad0: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00005ae0: 7265 6c5f 6964 2c20 7265 6d6f 7465 5f61  rel_id, remote_a
+00005af0: 7070 2c20 6973 5f61 7070 3d54 7275 6529  pp, is_app=True)
+00005b00: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00005b10: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
+00005b20: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
+00005b30: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+00005b40: 6f6e 6528 7365 6c66 2e5f 6669 6e64 5f72  one(self._find_r
+00005b50: 656c 6174 696f 6e5f 696e 5f6d 6f64 656c  elation_in_model
+00005b60: 5f62 795f 6964 2868 6172 6e65 7373 2c20  _by_id(harness, 
+00005b70: 7265 6c5f 6964 2929 0a0a 2020 2020 6465  rel_id))..    de
+00005b80: 6620 5f66 696e 645f 7265 6c61 7469 6f6e  f _find_relation
+00005b90: 5f69 6e5f 6d6f 6465 6c5f 6279 5f69 6428  _in_model_by_id(
+00005ba0: 7365 6c66 2c20 6861 726e 6573 732c 2072  self, harness, r
+00005bb0: 656c 5f69 6429 3a0a 2020 2020 2020 2020  el_id):.        
+00005bc0: 666f 7220 7265 6c61 7469 6f6e 7320 696e  for relations in
+00005bd0: 2068 6172 6e65 7373 2e63 6861 726d 2e6d   harness.charm.m
+00005be0: 6f64 656c 2e72 656c 6174 696f 6e73 2e76  odel.relations.v
+00005bf0: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00005c00: 2020 2020 2066 6f72 2072 656c 6174 696f       for relatio
+00005c10: 6e20 696e 2072 656c 6174 696f 6e73 3a0a  n in relations:.
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c30: 6966 2072 656c 5f69 6420 3d3d 2072 656c  if rel_id == rel
+00005c40: 6174 696f 6e2e 6964 3a0a 2020 2020 2020  ation.id:.      
+00005c50: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00005c60: 7475 726e 2072 656c 6174 696f 6e0a 2020  turn relation.  
+00005c70: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00005c80: 650a 0a20 2020 2064 6566 2074 6573 745f  e..    def test_
+00005c90: 7265 6d6f 7669 6e67 5f72 656c 6174 696f  removing_relatio
+00005ca0: 6e5f 756e 6974 5f72 656d 6f76 6573 5f64  n_unit_removes_d
+00005cb0: 6174 615f 616c 736f 2873 656c 6629 3a0a  ata_also(self):.
+00005cc0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00005cd0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+00005ce0: 726e 6573 7328 5265 6c61 7469 6f6e 4576  rness(RelationEv
+00005cf0: 656e 7443 6861 726d 2c20 6d65 7461 3d27  entCharm, meta='
+00005d00: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+00005d10: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+00005d20: 2020 2020 2020 2020 2020 7265 7175 6972            requir
+00005d30: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00005d40: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+00005d50: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00005d60: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
+00005d70: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00005d80: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00005d90: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+00005da0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
+00005db0: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
+00005dc0: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
+00005dd0: 6861 726d 2e6f 6273 6572 7665 5f72 656c  harm.observe_rel
+00005de0: 6174 696f 6e5f 6576 656e 7473 2827 6462  ation_events('db
+00005df0: 2729 0a20 2020 2020 2020 2023 2041 6464  ').        # Add
+00005e00: 2061 2072 656c 6174 696f 6e20 616e 6420   a relation and 
+00005e10: 756e 6974 2077 6974 6820 6461 7461 0a20  unit with data. 
+00005e20: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+00005e30: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00005e40: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+00005e50: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+00005e60: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00005e70: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00005e80: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
+00005e90: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00005ea0: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
+00005eb0: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
+00005ec0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00005ed0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00005ee0: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+00005ef0: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
+00005f00: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+00005f10: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
+00005f20: 696f 6e2c 2075 6e69 7420 616e 6420 6461  ion, unit and da
+00005f30: 7461 2065 7869 7374 0a20 2020 2020 2020  ta exist.       
+00005f40: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+00005f50: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+00005f60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00005f70: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00005f80: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
+00005f90: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
+00005fa0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00005fb0: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00005fc0: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
+00005fd0: 292c 205b 2770 6f73 7467 7265 7371 6c2f  ), ['postgresql/
+00005fe0: 3027 5d29 0a20 2020 2020 2020 2073 656c  0']).        sel
+00005ff0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00006000: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
+00006010: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00006020: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+00006030: 7371 6c2f 3027 2c20 6973 5f61 7070 3d46  sql/0', is_app=F
+00006040: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+00006050: 2020 207b 2766 6f6f 273a 2027 6261 7227     {'foo': 'bar'
+00006060: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
+00006070: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+00006080: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
+00006090: 2020 2320 6967 6e6f 7265 2072 656c 6174    # ignore relat
+000060a0: 696f 6e20 6372 6561 7465 6420 6576 656e  ion created even
+000060b0: 7473 0a20 2020 2020 2020 2023 2052 656d  ts.        # Rem
+000060c0: 6f76 6520 756e 6974 2062 7574 206e 6f74  ove unit but not
+000060d0: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
+000060e0: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
+000060f0: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00006100: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00006110: 716c 2f30 2729 0a20 2020 2020 2020 2023  ql/0').        #
+00006120: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00006130: 6578 6973 7473 2062 7574 2075 6e69 7420  exists but unit 
+00006140: 616e 6420 6461 7461 2061 7265 2072 656d  and data are rem
+00006150: 6f76 6564 0a20 2020 2020 2020 2073 656c  oved.        sel
+00006160: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00006170: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
+00006180: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
+00006190: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
+000061a0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+000061b0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+000061c0: 7374 2872 656c 5f69 6429 2c20 5b5d 290a  st(rel_id), []).
+000061d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000061e0: 6572 7452 6169 7365 7328 4b65 7945 7272  ertRaises(KeyErr
+000061f0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00006200: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00006210: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00006220: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00006230: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00006240: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
+00006250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006260: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
+00006270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006280: 2020 2020 2020 2020 2020 6973 5f61 7070            is_app
+00006290: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
+000062a0: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
+000062b0: 2064 6570 6172 7465 6420 7761 7320 7261   departed was ra
+000062c0: 6973 6564 2077 6974 6820 636f 7272 6563  ised with correc
+000062d0: 7420 6461 7461 0a20 2020 2020 2020 2073  t data.        s
+000062e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000062f0: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+00006300: 745f 6368 616e 6765 7328 295b 305d 2c0a  t_changes()[0],.
+00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006320: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00006330: 3a20 2772 656c 6174 696f 6e2d 6465 7061  : 'relation-depa
+00006340: 7274 6564 272c 0a20 2020 2020 2020 2020  rted',.         
+00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006360: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
+00006370: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00006380: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+00006390: 7461 273a 207b 2761 7070 273a 2027 706f  ta': {'app': 'po
+000063a0: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
+000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063c0: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+000063d0: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
+000063e0: 6c2f 3027 2c0a 2020 2020 2020 2020 2020  l/0',.          
+000063f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006400: 2020 2020 2020 2020 2027 6465 7061 7274           'depart
+00006410: 696e 675f 756e 6974 273a 2027 706f 7374  ing_unit': 'post
+00006420: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
+00006430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006440: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00006450: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
+00006460: 5f69 647d 7d29 0a0a 2020 2020 6465 6620  _id}})..    def 
+00006470: 7465 7374 5f72 656d 6f76 696e 675f 7265  test_removing_re
+00006480: 6c61 7469 6f6e 5f75 6e69 745f 646f 6573  lation_unit_does
+00006490: 5f6e 6f74 5f72 656d 6f76 655f 6f74 6865  _not_remove_othe
+000064a0: 725f 756e 6974 5f61 6e64 5f64 6174 6128  r_unit_and_data(
+000064b0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+000064c0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+000064d0: 7469 6e67 2e48 6172 6e65 7373 2852 656c  ting.Harness(Rel
+000064e0: 6174 696f 6e45 7665 6e74 4368 6172 6d2c  ationEventCharm,
+000064f0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00006500: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00006510: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00006520: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00006530: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00006540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006550: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00006560: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00006570: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00006580: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00006590: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+000065a0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+000065b0: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+000065c0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+000065d0: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
+000065e0: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
+000065f0: 2020 2320 4164 6420 6120 7265 6c61 7469    # Add a relati
+00006600: 6f6e 2077 6974 6820 7477 6f20 756e 6974  on with two unit
+00006610: 7320 7769 7468 2064 6174 610a 2020 2020  s with data.    
+00006620: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
+00006630: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00006640: 6e28 2764 6227 2c20 2770 6f73 7467 7265  n('db', 'postgre
+00006650: 7371 6c27 290a 2020 2020 2020 2020 7365  sql').        se
+00006660: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+00006670: 6e63 6528 7265 6c5f 6964 2c20 696e 7429  nce(rel_id, int)
+00006680: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00006690: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+000066a0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
+000066b0: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
+000066c0: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+000066d0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+000066e0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+000066f0: 2f31 2729 0a20 2020 2020 2020 2068 6172  /1').        har
+00006700: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00006710: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00006720: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00006730: 2c20 7b27 666f 6f30 273a 2027 6261 7230  , {'foo0': 'bar0
+00006740: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
+00006750: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00006760: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00006770: 2027 706f 7374 6772 6573 716c 2f31 272c   'postgresql/1',
+00006780: 207b 2766 6f6f 3127 3a20 2762 6172 3127   {'foo1': 'bar1'
+00006790: 7d29 0a20 2020 2020 2020 2023 2043 6865  }).        # Che
+000067a0: 636b 2062 6f74 6820 756e 6974 2061 6e64  ck both unit and
+000067b0: 2064 6174 6120 6172 6520 7072 6573 656e   data are presen
+000067c0: 740a 2020 2020 2020 2020 6261 636b 656e  t.        backen
+000067d0: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
+000067e0: 6b65 6e64 0a20 2020 2020 2020 2073 656c  kend.        sel
+000067f0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00006800: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
+00006810: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
+00006820: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
+00006830: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00006840: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+00006850: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
+00006860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006870: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
+00006880: 6c2f 3027 2c20 2770 6f73 7467 7265 7371  l/0', 'postgresq
+00006890: 6c2f 3127 5d29 0a20 2020 2020 2020 2073  l/1']).        s
+000068a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000068b0: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+000068c0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+000068d0: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+000068e0: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
+000068f0: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00006900: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
+00006910: 6172 3027 7d29 0a20 2020 2020 2020 2073  ar0'}).        s
+00006920: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006930: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+00006940: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00006950: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00006960: 7265 7371 6c2f 3127 2c20 6973 5f61 7070  resql/1', is_app
+00006970: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00006980: 2020 2020 207b 2766 6f6f 3127 3a20 2762       {'foo1': 'b
+00006990: 6172 3127 7d29 0a20 2020 2020 2020 2068  ar1'}).        h
+000069a0: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
+000069b0: 5f63 6861 6e67 6573 2872 6573 6574 3d54  _changes(reset=T
+000069c0: 7275 6529 2020 2320 6967 6e6f 7265 2072  rue)  # ignore r
+000069d0: 656c 6174 696f 6e20 6372 6561 7465 6420  elation created 
+000069e0: 6576 656e 7473 0a20 2020 2020 2020 2023  events.        #
+000069f0: 2052 656d 6f76 6520 6f6e 6c79 206f 6e65   Remove only one
+00006a00: 2075 6e69 740a 2020 2020 2020 2020 6861   unit.        ha
+00006a10: 726e 6573 732e 7265 6d6f 7665 5f72 656c  rness.remove_rel
+00006a20: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
+00006a30: 642c 2027 706f 7374 6772 6573 716c 2f31  d, 'postgresql/1
+00006a40: 2729 0a20 2020 2020 2020 2023 2043 6865  ').        # Che
+00006a50: 636b 206f 7468 6572 2075 6e69 7420 616e  ck other unit an
+00006a60: 6420 6461 7461 2073 7469 6c6c 2065 7869  d data still exi
+00006a70: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
+00006a80: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00006a90: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+00006aa0: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
+00006ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ac0: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
+00006ad0: 6c2f 3027 5d29 0a20 2020 2020 2020 2073  l/0']).        s
+00006ae0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006af0: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+00006b00: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00006b10: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00006b20: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
+00006b30: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00006b40: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
+00006b50: 6172 3027 7d29 0a20 2020 2020 2020 2023  ar0'}).        #
+00006b60: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00006b70: 6465 7061 7274 6564 2077 6173 2072 6169  departed was rai
+00006b80: 7365 6420 7769 7468 2063 6f72 7265 6374  sed with correct
+00006b90: 2064 6174 610a 2020 2020 2020 2020 7365   data.        se
+00006ba0: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+00006bb0: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
+00006bc0: 5f63 6861 6e67 6573 2829 5b30 5d2c 0a20  _changes()[0],. 
+00006bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006be0: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00006bf0: 2027 7265 6c61 7469 6f6e 2d64 6570 6172   'relation-depar
+00006c00: 7465 6427 2c0a 2020 2020 2020 2020 2020  ted',.          
+00006c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c20: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
+00006c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006c40: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
+00006c50: 6127 3a20 7b27 6170 7027 3a20 2770 6f73  a': {'app': 'pos
+00006c60: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c80: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00006c90: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
+00006ca0: 2f31 272c 0a20 2020 2020 2020 2020 2020  /1',.           
+00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cc0: 2020 2020 2020 2020 2764 6570 6172 7469          'departi
+00006cd0: 6e67 5f75 6e69 7427 3a20 2770 6f73 7467  ng_unit': 'postg
+00006ce0: 7265 7371 6c2f 3127 2c0a 2020 2020 2020  resql/1',.      
+00006cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d00: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00006d10: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
+00006d20: 6964 7d7d 290a 0a20 2020 2064 6566 2074  id}})..    def t
+00006d30: 6573 745f 7265 6c61 7469 6f6e 5f65 7665  est_relation_eve
+00006d40: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+00006d50: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+00006d60: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+00006d70: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
+00006d80: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
+00006d90: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00006da0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
+00006db0: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
+00006dc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00006dd0: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
+00006de0: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+00006df0: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
+00006e00: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00006e10: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00006e20: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00006e30: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00006e40: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+00006e50: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00006e60: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
+00006e70: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
+00006e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006e90: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
+00006ea0: 2e67 6574 5f63 6861 6e67 6573 2829 2c20  .get_changes(), 
+00006eb0: 5b5d 290a 2020 2020 2020 2020 7265 6c5f  []).        rel_
+00006ec0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00006ed0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00006ee0: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+00006ef0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006f00: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00006f10: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
+00006f20: 6d2e 6765 745f 6368 616e 6765 7328 292c  m.get_changes(),
+00006f30: 0a20 2020 2020 2020 2020 2020 205b 7b27  .            [{'
+00006f40: 6e61 6d65 273a 2027 7265 6c61 7469 6f6e  name': 'relation
+00006f50: 2d63 7265 6174 6564 272c 0a20 2020 2020  -created',.     
+00006f60: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00006f70: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+00006f80: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00006f90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00006fa0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00006fb0: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00006fc0: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
+00006fd0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00006fe0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00006ff0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
+00007000: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00007010: 207d 7d5d 290a 2020 2020 2020 2020 6861   }}]).        ha
+00007020: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00007030: 6f6e 5f75 6e69 7428 7265 6c5f 6964 2c20  on_unit(rel_id, 
+00007040: 2770 6f73 7467 7265 7371 6c2f 3027 290a  'postgresql/0').
+00007050: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007060: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00007070: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+00007080: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
+00007090: 292c 0a20 2020 2020 2020 2020 2020 205b  ),.            [
+000070a0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+000070b0: 6f6e 2d6a 6f69 6e65 6427 2c0a 2020 2020  on-joined',.    
+000070c0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000070d0: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+000070e0: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
+000070f0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00007100: 2020 2020 2020 2761 7070 273a 2027 706f        'app': 'po
+00007110: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
+00007120: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00007130: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
+00007140: 2f30 272c 0a20 2020 2020 2020 2020 2020  /0',.           
+00007150: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00007160: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+00007170: 2020 2020 2020 2020 2020 2020 7d7d 5d29              }}])
+00007180: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00007190: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+000071a0: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
+000071b0: 6f73 7467 7265 7371 6c27 2c20 7b27 666f  ostgresql', {'fo
+000071c0: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
+000071d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000071e0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+000071f0: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
+00007200: 6765 745f 6368 616e 6765 7328 292c 0a20  get_changes(),. 
+00007210: 2020 2020 2020 2020 2020 205b 7b27 6e61             [{'na
+00007220: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+00007230: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
+00007240: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00007250: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+00007260: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
+00007270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007280: 2020 2027 6170 7027 3a20 2770 6f73 7467     'app': 'postg
+00007290: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
+000072a0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+000072b0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000072c0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000072d0: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
+000072e0: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
+000072f0: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
+00007300: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00007310: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00007320: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
+00007330: 207b 2762 617a 273a 2027 6269 6e67 277d   {'baz': 'bing'}
+00007340: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007350: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
+00007360: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00007370: 6368 6172 6d2e 6765 745f 6368 616e 6765  charm.get_change
+00007380: 7328 292c 0a20 2020 2020 2020 2020 2020  s(),.           
+00007390: 205b 7b27 6e61 6d65 273a 2027 7265 6c61   [{'name': 'rela
+000073a0: 7469 6f6e 2d63 6861 6e67 6564 272c 0a20  tion-changed',. 
+000073b0: 2020 2020 2020 2020 2020 2020 2027 7265               're
+000073c0: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+000073d0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+000073e0: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+000073f0: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
+00007400: 2770 6f73 7467 7265 7371 6c27 2c0a 2020  'postgresql',.  
+00007410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007420: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
+00007430: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
+00007440: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00007450: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
+00007460: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
+00007470: 7d5d 290a 0a20 2020 2064 6566 2074 6573  }])..    def tes
+00007480: 745f 6765 745f 7265 6c61 7469 6f6e 5f64  t_get_relation_d
+00007490: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
+000074a0: 2020 2063 6861 726d 5f6d 6574 6120 3d20     charm_meta = 
+000074b0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+000074c0: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+000074d0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+000074e0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+000074f0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+00007500: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00007510: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+00007520: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00007530: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+00007540: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+00007550: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
+00007560: 6574 613d 6368 6172 6d5f 6d65 7461 290a  eta=charm_meta).
+00007570: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00007580: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00007590: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+000075a0: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
+000075b0: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+000075c0: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+000075d0: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+000075e0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
+000075f0: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
+00007600: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
+00007610: 7265 6d6f 7465 273a 2027 6461 7461 277d  remote': 'data'}
+00007620: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007630: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+00007640: 7373 2e67 6574 5f72 656c 6174 696f 6e5f  ss.get_relation_
+00007650: 6461 7461 2872 656c 5f69 642c 2027 7465  data(rel_id, 'te
+00007660: 7374 2d61 7070 2729 2c20 7b7d 290a 2020  st-app'), {}).  
+00007670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007680: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
+00007690: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
+000076a0: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+000076b0: 7070 2f30 2729 2c20 7b7d 290a 2020 2020  pp/0'), {}).    
+000076c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000076d0: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
+000076e0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000076f0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00007700: 2f31 2729 2c20 4e6f 6e65 290a 2020 2020  /1'), None).    
 00007710: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
 00007720: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
 00007730: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00007740: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
-00007750: 2f31 2729 2c20 4e6f 6e65 290a 2020 2020  /1'), None).    
-00007760: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007770: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
-00007780: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00007790: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-000077a0: 716c 2729 2c20 7b27 7265 6d6f 7465 273a  ql'), {'remote':
-000077b0: 2027 6461 7461 277d 290a 2020 2020 2020   'data'}).      
-000077c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000077d0: 7274 5261 6973 6573 284b 6579 4572 726f  rtRaises(KeyErro
-000077e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000077f0: 2320 756e 6b6e 6f77 6e20 7265 6c61 7469  # unknown relati
-00007800: 6f6e 2069 640a 2020 2020 2020 2020 2020  on id.          
-00007810: 2020 6861 726e 6573 732e 6765 745f 7265    harness.get_re
-00007820: 6c61 7469 6f6e 5f64 6174 6128 3939 2c20  lation_data(99, 
-00007830: 2770 6f73 7467 7265 7371 6c27 290a 0a20  'postgresql').. 
-00007840: 2020 2020 2020 206d 6574 6120 3d20 7961         meta = ya
-00007850: 6d6c 2e73 6166 655f 6c6f 6164 2863 6861  ml.safe_load(cha
-00007860: 726d 5f6d 6574 6129 0a20 2020 2020 2020  rm_meta).       
-00007870: 2074 5f61 7070 203d 206f 7073 2e41 7070   t_app = ops.App
-00007880: 6c69 6361 7469 6f6e 2827 7465 7374 2d61  lication('test-a
-00007890: 7070 272c 206d 6574 612c 2068 6172 6e65  pp', meta, harne
-000078a0: 7373 2e5f 6261 636b 656e 642c 204e 6f6e  ss._backend, Non
-000078b0: 6529 0a20 2020 2020 2020 2074 5f75 6e69  e).        t_uni
-000078c0: 7430 203d 206f 7073 2e55 6e69 7428 2774  t0 = ops.Unit('t
-000078d0: 6573 742d 6170 702f 3027 2c20 6d65 7461  est-app/0', meta
-000078e0: 2c20 6861 726e 6573 732e 5f62 6163 6b65  , harness._backe
-000078f0: 6e64 2c20 7b6f 7073 2e41 7070 6c69 6361  nd, {ops.Applica
-00007900: 7469 6f6e 3a20 745f 6170 707d 290a 2020  tion: t_app}).  
-00007910: 2020 2020 2020 745f 756e 6974 3120 3d20        t_unit1 = 
-00007920: 6f70 732e 556e 6974 2827 7465 7374 2d61  ops.Unit('test-a
-00007930: 7070 2f31 272c 206d 6574 612c 2068 6172  pp/1', meta, har
-00007940: 6e65 7373 2e5f 6261 636b 656e 642c 207b  ness._backend, {
-00007950: 6f70 732e 4170 706c 6963 6174 696f 6e3a  ops.Application:
-00007960: 2074 5f61 7070 7d29 0a20 2020 2020 2020   t_app}).       
-00007970: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007980: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
-00007990: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-000079a0: 6964 2c20 745f 6170 7029 2c20 7b7d 290a  id, t_app), {}).
-000079b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000079c0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-000079d0: 2e67 6574 5f72 656c 6174 696f 6e5f 6461  .get_relation_da
-000079e0: 7461 2872 656c 5f69 642c 2074 5f75 6e69  ta(rel_id, t_uni
-000079f0: 7430 292c 207b 7d29 0a20 2020 2020 2020  t0), {}).       
-00007a00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007a10: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
-00007a20: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-00007a30: 6964 2c20 745f 756e 6974 3129 2c20 4e6f  id, t_unit1), No
-00007a40: 6e65 290a 2020 2020 2020 2020 7067 5f61  ne).        pg_a
-00007a50: 7070 203d 206f 7073 2e41 7070 6c69 6361  pp = ops.Applica
-00007a60: 7469 6f6e 2827 706f 7374 6772 6573 716c  tion('postgresql
-00007a70: 272c 206d 6574 612c 2068 6172 6e65 7373  ', meta, harness
-00007a80: 2e5f 6261 636b 656e 642c 204e 6f6e 6529  ._backend, None)
-00007a90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00007aa0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-00007ab0: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
-00007ac0: 6174 6128 7265 6c5f 6964 2c20 7067 5f61  ata(rel_id, pg_a
-00007ad0: 7070 292c 207b 2772 656d 6f74 6527 3a20  pp), {'remote': 
-00007ae0: 2764 6174 6127 7d29 0a0a 2020 2020 6465  'data'})..    de
-00007af0: 6620 7465 7374 5f63 7265 6174 655f 6861  f test_create_ha
-00007b00: 726e 6573 735f 7477 6963 6528 7365 6c66  rness_twice(self
-00007b10: 293a 0a20 2020 2020 2020 206d 6574 6164  ):.        metad
-00007b20: 6174 6120 3d20 2727 270a 2020 2020 2020  ata = '''.      
-00007b30: 2020 2020 2020 6e61 6d65 3a20 6d79 2d63        name: my-c
-00007b40: 6861 726d 0a20 2020 2020 2020 2020 2020  harm.           
-00007b50: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-00007b60: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
-00007b70: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-00007b80: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
-00007b90: 2020 2020 2020 2020 2020 2727 270a 2020            '''.  
-00007ba0: 2020 2020 2020 6861 726e 6573 7331 203d        harness1 =
-00007bb0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-00007bc0: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
-00007bd0: 7365 2c20 6d65 7461 3d6d 6574 6164 6174  se, meta=metadat
-00007be0: 6129 0a20 2020 2020 2020 2073 656c 662e  a).        self.
-00007bf0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00007c00: 7373 312e 636c 6561 6e75 7029 0a20 2020  ss1.cleanup).   
-00007c10: 2020 2020 2068 6172 6e65 7373 3220 3d20       harness2 = 
-00007c20: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
-00007c30: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
-00007c40: 652c 206d 6574 613d 6d65 7461 6461 7461  e, meta=metadata
-00007c50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00007c60: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00007c70: 7332 2e63 6c65 616e 7570 290a 2020 2020  s2.cleanup).    
-00007c80: 2020 2020 6861 726e 6573 7331 2e62 6567      harness1.beg
-00007c90: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
-00007ca0: 6e65 7373 322e 6265 6769 6e28 290a 2020  ness2.begin().  
-00007cb0: 2020 2020 2020 6865 6c70 6572 3120 3d20        helper1 = 
-00007cc0: 4442 5265 6c61 7469 6f6e 4368 616e 6765  DBRelationChange
-00007cd0: 6448 656c 7065 7228 6861 726e 6573 7331  dHelper(harness1
-00007ce0: 2e63 6861 726d 2c20 2268 656c 7065 7231  .charm, "helper1
-00007cf0: 2229 0a20 2020 2020 2020 2068 656c 7065  ").        helpe
-00007d00: 7232 203d 2044 4252 656c 6174 696f 6e43  r2 = DBRelationC
-00007d10: 6861 6e67 6564 4865 6c70 6572 2868 6172  hangedHelper(har
-00007d20: 6e65 7373 322e 6368 6172 6d2c 2022 6865  ness2.charm, "he
-00007d30: 6c70 6572 3222 290a 2020 2020 2020 2020  lper2").        
-00007d40: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-00007d50: 322e 6164 645f 7265 6c61 7469 6f6e 2827  2.add_relation('
-00007d60: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-00007d70: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00007d80: 7373 322e 7570 6461 7465 5f72 656c 6174  ss2.update_relat
-00007d90: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00007da0: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
-00007db0: 276b 6579 273a 2027 7661 6c75 6527 7d29  'key': 'value'})
-00007dc0: 0a20 2020 2020 2020 2023 2048 656c 7065  .        # Helpe
-00007dd0: 7232 2073 686f 756c 6420 7365 6520 7468  r2 should see th
-00007de0: 6520 6576 656e 7420 7472 6967 6765 7265  e event triggere
-00007df0: 6420 6279 2068 6172 6e65 7373 322c 2062  d by harness2, b
-00007e00: 7574 2068 656c 7065 7231 2073 686f 756c  ut helper1 shoul
-00007e10: 6420 7365 6520 6e6f 2065 7665 6e74 732e  d see no events.
-00007e20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00007e30: 7365 7274 4571 7561 6c28 6865 6c70 6572  sertEqual(helper
-00007e40: 312e 6368 616e 6765 732c 205b 5d29 0a20  1.changes, []). 
-00007e50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007e60: 7274 4571 7561 6c28 6865 6c70 6572 322e  rtEqual(helper2.
-00007e70: 6368 616e 6765 732c 205b 2872 656c 5f69  changes, [(rel_i
-00007e80: 642c 2027 706f 7374 6772 6573 716c 2729  d, 'postgresql')
-00007e90: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00007ea0: 5f62 6567 696e 5f74 7769 6365 2873 656c  _begin_twice(sel
-00007eb0: 6629 3a0a 2020 2020 2020 2020 2320 6c61  f):.        # la
-00007ec0: 6e67 7561 6765 3d59 414d 4c0a 2020 2020  nguage=YAML.    
-00007ed0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-00007ee0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-00007ef0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-00007f00: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-00007f10: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-00007f20: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-00007f30: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-00007f40: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f60: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-00007f70: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-00007f80: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00007f90: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00007fa0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00007fb0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-00007fc0: 6769 6e28 290a 2020 2020 2020 2020 7769  gin().        wi
-00007fd0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00007fe0: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
-00007ff0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00008000: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-00008010: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
-00008020: 6461 7465 5f72 656c 6174 696f 6e5f 6578  date_relation_ex
-00008030: 706f 7365 735f 6e65 775f 6461 7461 2873  poses_new_data(s
-00008040: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-00008050: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-00008060: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
-00008070: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-00008080: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00008090: 6e61 6d65 3a20 6d79 2d63 6861 726d 0a20  name: my-charm. 
-000080a0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-000080b0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-000080c0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-000080d0: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-000080e0: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
-000080f0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00008100: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-00008110: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-00008120: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00008130: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
-00008140: 2020 7669 6577 6572 203d 2052 656c 6174    viewer = Relat
-00008150: 696f 6e43 6861 6e67 6564 5669 6577 6572  ionChangedViewer
-00008160: 2868 6172 6e65 7373 2e63 6861 726d 2c20  (harness.charm, 
-00008170: 2764 6227 290a 2020 2020 2020 2020 7265  'db').        re
-00008180: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
-00008190: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
-000081a0: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
-000081b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000081c0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-000081d0: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-000081e0: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
-000081f0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00008200: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00008210: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00008220: 716c 2f30 272c 207b 2769 6e69 7469 616c  ql/0', {'initial
-00008230: 273a 2027 6461 7461 277d 290a 2020 2020  ': 'data'}).    
-00008240: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00008250: 7175 616c 2876 6965 7765 722e 6368 616e  qual(viewer.chan
-00008260: 6765 732c 205b 7b27 696e 6974 6961 6c27  ges, [{'initial'
-00008270: 3a20 2764 6174 6127 7d5d 290a 2020 2020  : 'data'}]).    
-00008280: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-00008290: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-000082a0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-000082b0: 6573 716c 2f30 272c 207b 276e 6577 273a  esql/0', {'new':
-000082c0: 2027 7661 6c75 6527 7d29 0a20 2020 2020   'value'}).     
-000082d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000082e0: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
-000082f0: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
-00008300: 2027 6461 7461 277d 2c0a 2020 2020 2020   'data'},.      
-00008310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008330: 2020 2020 7b27 696e 6974 6961 6c27 3a20      {'initial': 
-00008340: 2764 6174 6127 2c20 276e 6577 273a 2027  'data', 'new': '
-00008350: 7661 6c75 6527 7d5d 290a 0a20 2020 2064  value'}])..    d
-00008360: 6566 2074 6573 745f 7570 6461 7465 5f72  ef test_update_r
-00008370: 656c 6174 696f 6e5f 6e6f 5f6c 6f63 616c  elation_no_local
-00008380: 5f75 6e69 745f 6368 616e 6765 5f65 7665  _unit_change_eve
-00008390: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-000083a0: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
-000083b0: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
-000083c0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-000083d0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
-000083e0: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-000083f0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00008400: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
-00008410: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00008420: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-00008430: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-00008440: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-00008450: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-00008460: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00008470: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00008480: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00008490: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-000084a0: 6769 6e28 290a 2020 2020 2020 2020 6865  gin().        he
-000084b0: 6c70 6572 203d 2044 4252 656c 6174 696f  lper = DBRelatio
-000084c0: 6e43 6861 6e67 6564 4865 6c70 6572 2868  nChangedHelper(h
-000084d0: 6172 6e65 7373 2e63 6861 726d 2c20 2268  arness.charm, "h
-000084e0: 656c 7065 7222 290a 2020 2020 2020 2020  elper").        
-000084f0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-00008500: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00008510: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-00008520: 290a 2020 2020 2020 2020 7265 6c20 3d20  ).        rel = 
-00008530: 6861 726e 6573 732e 6368 6172 6d2e 6d6f  harness.charm.mo
-00008540: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00008550: 2827 6462 2729 0a20 2020 2020 2020 2072  ('db').        r
-00008560: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
-00008570: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
-00008580: 5d5b 276b 6579 275d 203d 2027 7661 6c75  ]['key'] = 'valu
-00008590: 6527 0a20 2020 2020 2020 2023 2074 6865  e'.        # the
-000085a0: 7265 2073 686f 756c 6420 6265 206e 6f20  re should be no 
-000085b0: 6576 656e 7420 666f 7220 7570 6461 7469  event for updati
-000085c0: 6e67 206f 7572 206f 776e 2064 6174 610a  ng our own data.
-000085d0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000085e0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-000085f0: 6461 7461 2872 656c 5f69 642c 2027 6d79  data(rel_id, 'my
-00008600: 2d63 6861 726d 2f30 272c 207b 276e 6577  -charm/0', {'new
-00008610: 273a 2027 6f74 6865 7227 7d29 0a20 2020  ': 'other'}).   
-00008620: 2020 2020 2023 2062 7574 2074 6865 2064       # but the d
-00008630: 6174 6120 7769 6c6c 2062 6520 7570 6461  ata will be upda
-00008640: 7465 642e 0a20 2020 2020 2020 2073 656c  ted..        sel
-00008650: 662e 6173 7365 7274 4571 7561 6c28 7b27  f.assertEqual({'
-00008660: 6b65 7927 3a20 2776 616c 7565 272c 2027  key': 'value', '
-00008670: 6e65 7727 3a20 276f 7468 6572 277d 2c20  new': 'other'}, 
-00008680: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
-00008690: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
-000086a0: 745d 290a 0a20 2020 2020 2020 2072 656c  t])..        rel
-000086b0: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
-000086c0: 6172 6d2e 6d6f 6465 6c2e 756e 6974 5d5b  arm.model.unit][
-000086d0: 276e 6577 275d 203d 2027 7661 6c75 6527  'new'] = 'value'
-000086e0: 0a20 2020 2020 2020 2023 204f 7572 2075  .        # Our u
-000086f0: 6e69 7420 6461 7461 2062 6167 2067 6f74  nit data bag got
-00008700: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
-00008710: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008720: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
-00008730: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
-00008740: 756e 6974 5d5b 276e 6577 275d 2c20 2776  unit]['new'], 'v
-00008750: 616c 7565 2729 0a20 2020 2020 2020 2023  alue').        #
-00008760: 2042 7574 2074 6865 7265 2077 6572 6520   But there were 
-00008770: 6e6f 2063 6861 6e67 6564 2065 7665 6e74  no changed event
-00008780: 7320 7265 6769 7374 6572 6564 2062 7920  s registered by 
-00008790: 6f75 7220 756e 6974 2e0a 2020 2020 2020  our unit..      
-000087a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000087b0: 616c 285b 5d2c 2068 656c 7065 722e 6368  al([], helper.ch
-000087c0: 616e 6765 7329 0a0a 2020 2020 6465 6620  anges)..    def 
-000087d0: 7465 7374 5f75 7064 6174 655f 7065 6572  test_update_peer
-000087e0: 5f72 656c 6174 696f 6e5f 6e6f 5f6c 6f63  _relation_no_loc
-000087f0: 616c 5f75 6e69 745f 6368 616e 6765 5f65  al_unit_change_e
-00008800: 7665 6e74 2873 656c 6629 3a0a 2020 2020  vent(self):.    
-00008810: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
-00008820: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
-00008830: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00008840: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-00008850: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-00008860: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-00008870: 6d65 3a20 706f 7374 6772 6573 716c 0a20  me: postgresql. 
-00008880: 2020 2020 2020 2020 2020 2070 6565 7273             peers
-00008890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000088a0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-000088b0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-000088c0: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-000088d0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-000088e0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-000088f0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00008900: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00008910: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
-00008920: 656c 7065 7220 3d20 4442 5265 6c61 7469  elper = DBRelati
-00008930: 6f6e 4368 616e 6765 6448 656c 7065 7228  onChangedHelper(
-00008940: 6861 726e 6573 732e 6368 6172 6d2c 2022  harness.charm, "
-00008950: 6865 6c70 6572 2229 0a20 2020 2020 2020  helper").       
-00008960: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-00008970: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-00008980: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-00008990: 2729 0a0a 2020 2020 2020 2020 7265 6c20  ')..        rel 
-000089a0: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
-000089b0: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
-000089c0: 6f6e 2827 6462 2729 0a20 2020 2020 2020  on('db').       
-000089d0: 2072 656c 2e64 6174 615b 6861 726e 6573   rel.data[harnes
-000089e0: 732e 6368 6172 6d2e 6d6f 6465 6c2e 756e  s.charm.model.un
-000089f0: 6974 5d5b 276b 6579 275d 203d 2027 7661  it]['key'] = 'va
-00008a00: 6c75 6527 0a20 2020 2020 2020 2072 656c  lue'.        rel
-00008a10: 203d 2068 6172 6e65 7373 2e63 6861 726d   = harness.charm
-00008a20: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
-00008a30: 696f 6e28 2764 6227 290a 2020 2020 2020  ion('db').      
-00008a40: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00008a50: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00008a60: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00008a70: 716c 2f30 272c 207b 276b 6579 273a 2027  ql/0', {'key': '
-00008a80: 7631 277d 290a 2020 2020 2020 2020 7365  v1'}).        se
-00008a90: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
-00008aa0: 276b 6579 273a 2027 7631 277d 2c20 7265  'key': 'v1'}, re
-00008ab0: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
-00008ac0: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
-00008ad0: 290a 2020 2020 2020 2020 2320 4d61 6b65  ).        # Make
-00008ae0: 2073 7572 6520 7468 6572 6520 7761 7320   sure there was 
-00008af0: 6e6f 2065 7665 6e74 0a20 2020 2020 2020  no event.       
-00008b00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008b10: 6c28 5b5d 2c20 6865 6c70 6572 2e63 6861  l([], helper.cha
-00008b20: 6e67 6573 290a 0a20 2020 2020 2020 2072  nges)..        r
-00008b30: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
-00008b40: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
-00008b50: 5d5b 276b 6579 275d 203d 2027 7632 270a  ]['key'] = 'v2'.
-00008b60: 2020 2020 2020 2020 2320 4f75 7220 756e          # Our un
-00008b70: 6974 2064 6174 6120 6261 6720 676f 7420  it data bag got 
-00008b80: 7570 6461 7465 642e 0a20 2020 2020 2020  updated..       
-00008b90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008ba0: 6c28 7b27 6b65 7927 3a20 2776 3227 7d2c  l({'key': 'v2'},
-00008bb0: 2064 6963 7428 7265 6c2e 6461 7461 5b68   dict(rel.data[h
-00008bc0: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
-00008bd0: 656c 2e75 6e69 745d 2929 0a20 2020 2020  el.unit])).     
-00008be0: 2020 2023 2042 7574 2074 6865 7265 2077     # But there w
-00008bf0: 6572 6520 6e6f 2063 6861 6e67 6564 2065  ere no changed e
-00008c00: 7665 6e74 7320 7265 6769 7374 6572 6564  vents registered
-00008c10: 2062 7920 6f75 7220 756e 6974 2e0a 2020   by our unit..  
-00008c20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00008c30: 7445 7175 616c 285b 5d2c 2068 656c 7065  tEqual([], helpe
-00008c40: 722e 6368 616e 6765 7329 0a0a 2020 2020  r.changes)..    
-00008c50: 2020 2020 2320 5361 6d65 2066 6f72 2077      # Same for w
-00008c60: 6865 6e20 6f75 7220 756e 6974 2069 7320  hen our unit is 
-00008c70: 6120 6c65 6164 6572 2e0a 2020 2020 2020  a leader..      
-00008c80: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-00008c90: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
-00008ca0: 7275 6529 0a20 2020 2020 2020 2068 6172  rue).        har
-00008cb0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00008cc0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00008cd0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
-00008ce0: 2c20 7b27 6b65 7927 3a20 2776 3327 7d29  , {'key': 'v3'})
-00008cf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008d00: 7365 7274 4571 7561 6c28 7b27 6b65 7927  sertEqual({'key'
-00008d10: 3a20 2776 3327 7d2c 2064 6963 7428 7265  : 'v3'}, dict(re
-00008d20: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
-00008d30: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
-00008d40: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00008d50: 6173 7365 7274 4571 7561 6c28 5b5d 2c20  assertEqual([], 
-00008d60: 6865 6c70 6572 2e63 6861 6e67 6573 290a  helper.changes).
-00008d70: 0a20 2020 2020 2020 2072 656c 2e64 6174  .        rel.dat
-00008d80: 615b 6861 726e 6573 732e 6368 6172 6d2e  a[harness.charm.
-00008d90: 6d6f 6465 6c2e 756e 6974 5d5b 276b 6579  model.unit]['key
-00008da0: 275d 203d 2027 7634 270a 2020 2020 2020  '] = 'v4'.      
-00008db0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008dc0: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
-00008dd0: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
-00008de0: 756e 6974 5d5b 276b 6579 275d 2c20 2776  unit]['key'], 'v
-00008df0: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
-00008e00: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
-00008e10: 2068 656c 7065 722e 6368 616e 6765 7329   helper.changes)
-00008e20: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
-00008e30: 6172 6e65 7373 5f6c 6561 6465 725f 6d69  arness_leader_mi
-00008e40: 7363 6f6e 6669 6728 7365 6c66 293a 0a20  sconfig(self):. 
-00008e50: 2020 2020 2020 2023 206c 616e 6775 6167         # languag
-00008e60: 653d 5941 4d4c 0a20 2020 2020 2020 2068  e=YAML.        h
-00008e70: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-00008e80: 7469 6e67 2e48 6172 6e65 7373 2853 6574  ting.Harness(Set
-00008e90: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
-00008ea0: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
-00008eb0: 2020 2020 2020 2020 6e61 6d65 3a20 706f          name: po
-00008ec0: 7374 6772 6573 716c 0a20 2020 2020 2020  stgresql.       
-00008ed0: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
-00008ee0: 2020 2020 2020 2020 2020 7065 6572 3a0a            peer:.
-00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f00: 696e 7465 7266 6163 653a 2066 6f6f 0a20  interface: foo. 
-00008f10: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00008f20: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00008f30: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00008f40: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00008f50: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
-00008f60: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-00008f70: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00008f80: 2852 756e 7469 6d65 4572 726f 7229 2061  (RuntimeError) a
-00008f90: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-00008fa0: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-00008fb0: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
-00008fc0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-00008fd0: 662e 6173 7365 7274 5472 7565 2863 6d2e  f.assertTrue(cm.
-00008fe0: 6578 6365 7074 696f 6e2e 6172 6773 5b30  exception.args[0
-00008ff0: 5d2e 6669 6e64 2827 7573 6520 4861 726e  ].find('use Harn
-00009000: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00009010: 2729 2021 3d20 2d31 290a 0a20 2020 2064  ') != -1)..    d
-00009020: 6566 2074 6573 745f 7570 6461 7465 5f70  ef test_update_p
-00009030: 6565 725f 7265 6c61 7469 6f6e 5f61 7070  eer_relation_app
-00009040: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
-00009050: 2020 2020 2023 206c 616e 6775 6167 653d       # language=
-00009060: 5941 4d4c 0a20 2020 2020 2020 2068 6172  YAML.        har
-00009070: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-00009080: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
-00009090: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-000090a0: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-000090b0: 616d 653a 2070 6f73 7467 7265 7371 6c0a  ame: postgresql.
-000090c0: 2020 2020 2020 2020 2020 2020 7065 6572              peer
-000090d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000090e0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-000090f0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-00009100: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-00009110: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-00009120: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00009130: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00009140: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00009150: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-00009160: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
-00009170: 6572 2869 735f 6c65 6164 6572 3d54 7275  er(is_leader=Tru
-00009180: 6529 0a20 2020 2020 2020 2068 656c 7065  e).        helpe
-00009190: 7220 3d20 4442 5265 6c61 7469 6f6e 4368  r = DBRelationCh
-000091a0: 616e 6765 6448 656c 7065 7228 6861 726e  angedHelper(harn
-000091b0: 6573 732e 6368 6172 6d2c 2022 6865 6c70  ess.charm, "help
-000091c0: 6572 2229 0a20 2020 2020 2020 2072 656c  er").        rel
-000091d0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-000091e0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-000091f0: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
-00009200: 2020 2020 2020 2072 656c 203d 2068 6172         rel = har
-00009210: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
-00009220: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00009230: 6227 290a 2020 2020 2020 2020 7265 6c2e  b').        rel.
-00009240: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-00009250: 726d 2e61 7070 5d5b 276b 6579 275d 203d  rm.app]['key'] =
-00009260: 2027 7661 6c75 6527 0a20 2020 2020 2020   'value'.       
-00009270: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-00009280: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-00009290: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-000092a0: 6c27 2c20 7b27 6b65 7927 3a20 2776 3127  l', {'key': 'v1'
-000092b0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-000092c0: 6173 7365 7274 4571 7561 6c28 7b27 6b65  assertEqual({'ke
-000092d0: 7927 3a20 2776 3127 7d2c 2072 656c 2e64  y': 'v1'}, rel.d
-000092e0: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-000092f0: 6d2e 6170 705d 290a 2020 2020 2020 2020  m.app]).        
-00009300: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00009310: 285b 5d2c 2068 656c 7065 722e 6368 616e  ([], helper.chan
-00009320: 6765 7329 0a0a 2020 2020 2020 2020 7265  ges)..        re
-00009330: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
-00009340: 6861 726d 2e61 7070 5d5b 276b 6579 275d  harm.app]['key']
-00009350: 203d 2027 7632 270a 2020 2020 2020 2020   = 'v2'.        
-00009360: 2320 4f75 7220 756e 6974 2064 6174 6120  # Our unit data 
-00009370: 6261 6720 676f 7420 7570 6461 7465 642e  bag got updated.
-00009380: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00009390: 7365 7274 4571 7561 6c28 7265 6c2e 6461  sertEqual(rel.da
-000093a0: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
-000093b0: 2e6d 6f64 656c 2e61 7070 5d5b 276b 6579  .model.app]['key
-000093c0: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
-000093d0: 2020 2320 4275 7420 7468 6572 6520 7765    # But there we
-000093e0: 7265 206e 6f20 6368 616e 6765 6420 6576  re no changed ev
-000093f0: 656e 7473 2072 6567 6973 7465 7265 6420  ents registered 
-00009400: 6279 206f 7572 2075 6e69 742e 0a20 2020  by our unit..   
-00009410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00009420: 4571 7561 6c28 5b5d 2c20 6865 6c70 6572  Equal([], helper
-00009430: 2e63 6861 6e67 6573 290a 0a20 2020 2020  .changes)..     
-00009440: 2020 2023 2049 6620 6f75 7220 756e 6974     # If our unit
-00009450: 2069 7320 6e6f 7420 6120 6c65 6164 6572   is not a leader
-00009460: 2075 6e69 7420 7765 2067 6574 2061 6e20   unit we get an 
-00009470: 7570 6461 7465 2061 626f 7574 2070 6565  update about pee
-00009480: 7220 6170 7020 7265 6c61 7469 6f6e 2064  r app relation d
-00009490: 6174 6120 6368 616e 6765 732e 0a20 2020  ata changes..   
-000094a0: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-000094b0: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
-000094c0: 723d 4661 6c73 6529 0a20 2020 2020 2020  r=False).       
-000094d0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-000094e0: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-000094f0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-00009500: 6c27 2c20 7b27 6b32 273a 2027 7632 277d  l', {'k2': 'v2'}
-00009510: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009520: 7373 6572 7445 7175 616c 2872 656c 2e64  ssertEqual(rel.d
-00009530: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-00009540: 6d2e 6d6f 6465 6c2e 6170 705d 5b27 6b32  m.model.app]['k2
-00009550: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
-00009560: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00009570: 616c 2868 656c 7065 722e 6368 616e 6765  al(helper.change
-00009580: 732c 205b 2830 2c20 2770 6f73 7467 7265  s, [(0, 'postgre
-00009590: 7371 6c27 295d 290a 0a20 2020 2064 6566  sql')])..    def
-000095a0: 2074 6573 745f 7570 6461 7465 5f72 656c   test_update_rel
-000095b0: 6174 696f 6e5f 6e6f 5f6c 6f63 616c 5f61  ation_no_local_a
-000095c0: 7070 5f63 6861 6e67 655f 6576 656e 7428  pp_change_event(
-000095d0: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-000095e0: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
-000095f0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00009600: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-00009610: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
-00009620: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
-00009630: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
-00009640: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
-00009650: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-00009660: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009680: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00009690: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-000096a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000096b0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-000096c0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-000096d0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-000096e0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-000096f0: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
-00009700: 6c73 6529 0a20 2020 2020 2020 2068 656c  lse).        hel
-00009710: 7065 7220 3d20 4442 5265 6c61 7469 6f6e  per = DBRelation
-00009720: 4368 616e 6765 6448 656c 7065 7228 6861  ChangedHelper(ha
-00009730: 726e 6573 732e 6368 6172 6d2c 2022 6865  rness.charm, "he
-00009740: 6c70 6572 2229 0a20 2020 2020 2020 2072  lper").        r
-00009750: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
-00009760: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00009770: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
-00009780: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-00009790: 2072 656d 6f76 6520 7468 6973 2061 7320   remove this as 
-000097a0: 736f 6f6e 2061 7320 6874 7470 733a 2f2f  soon as https://
-000097b0: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
-000097c0: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
-000097d0: 7375 6573 2f31 3735 2069 7320 6669 7865  sues/175 is fixe
-000097e0: 642e 0a20 2020 2020 2020 2068 6172 6e65  d..        harne
-000097f0: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-00009800: 756e 6974 2872 656c 5f69 642c 2027 706f  unit(rel_id, 'po
-00009810: 7374 6772 6573 716c 2f30 2729 0a20 2020  stgresql/0').   
-00009820: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00009830: 4571 7561 6c28 6865 6c70 6572 2e63 6861  Equal(helper.cha
-00009840: 6e67 6573 2c20 5b5d 290a 0a20 2020 2020  nges, [])..     
-00009850: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00009860: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00009870: 7265 6c5f 6964 2c20 276d 792d 6368 6172  rel_id, 'my-char
-00009880: 6d27 2c20 7b27 6e65 7727 3a20 2776 616c  m', {'new': 'val
-00009890: 7565 277d 290a 2020 2020 2020 2020 7265  ue'}).        re
-000098a0: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
-000098b0: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
-000098c0: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
-000098d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000098e0: 7561 6c28 7265 6c2e 6461 7461 5b68 6172  ual(rel.data[har
-000098f0: 6e65 7373 2e63 6861 726d 2e61 7070 5d5b  ness.charm.app][
-00009900: 276e 6577 275d 2c20 2776 616c 7565 2729  'new'], 'value')
-00009910: 0a0a 2020 2020 2020 2020 2320 4f75 7220  ..        # Our 
-00009920: 6170 7020 6461 7461 2062 6167 2067 6f74  app data bag got
-00009930: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
-00009940: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00009950: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
-00009960: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
-00009970: 6170 705d 5b27 6e65 7727 5d2c 2027 7661  app]['new'], 'va
-00009980: 6c75 6527 290a 2020 2020 2020 2020 2320  lue').        # 
-00009990: 4275 7420 7468 6572 6520 7765 7265 206e  But there were n
-000099a0: 6f20 6368 616e 6765 6420 6576 656e 7473  o changed events
-000099b0: 2072 6567 6973 7465 7265 6420 6279 206f   registered by o
-000099c0: 7572 2075 6e69 742e 0a20 2020 2020 2020  ur unit..       
-000099d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000099e0: 6c28 6865 6c70 6572 2e63 6861 6e67 6573  l(helper.changes
-000099f0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
-00009a00: 6573 745f 7570 6461 7465 5f72 656c 6174  est_update_relat
-00009a10: 696f 6e5f 7265 6d6f 7665 5f64 6174 6128  ion_remove_data(
-00009a20: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-00009a30: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-00009a40: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
-00009a50: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
-00009a60: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00009a70: 206e 616d 653a 206d 792d 6368 6172 6d0a   name: my-charm.
-00009a80: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-00009a90: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
-00009aa0: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00009ab0: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-00009ac0: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-00009ad0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00009ae0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00009af0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00009b00: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-00009b10: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-00009b20: 2020 2076 6965 7765 7220 3d20 5265 6c61     viewer = Rela
-00009b30: 7469 6f6e 4368 616e 6765 6456 6965 7765  tionChangedViewe
-00009b40: 7228 6861 726e 6573 732e 6368 6172 6d2c  r(harness.charm,
-00009b50: 2027 6462 2729 0a20 2020 2020 2020 2072   'db').        r
-00009b60: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
-00009b70: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00009b80: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
-00009b90: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00009ba0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-00009bb0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
-00009bc0: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
-00009bd0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00009be0: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00009bf0: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
-00009c00: 7371 6c2f 3027 2c20 7b27 696e 6974 6961  sql/0', {'initia
-00009c10: 6c27 3a20 2764 6174 6127 7d29 0a20 2020  l': 'data'}).   
-00009c20: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-00009c30: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00009c40: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
-00009c50: 7265 7371 6c2f 3027 2c20 7b27 696e 6974  resql/0', {'init
-00009c60: 6961 6c27 3a20 2727 7d29 0a20 2020 2020  ial': ''}).     
-00009c70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00009c80: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
-00009c90: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
-00009ca0: 2027 6461 7461 277d 2c20 7b7d 5d29 0a0a   'data'}, {}])..
-00009cb0: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
-00009cc0: 6576 656e 745f 6f6e 5f65 6d70 7479 5f75  event_on_empty_u
-00009cd0: 7064 6174 655f 7265 6c61 7469 6f6e 5f75  pdate_relation_u
-00009ce0: 6e69 745f 6170 7028 7365 6c66 293a 0a20  nit_app(self):. 
-00009cf0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00009d00: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-00009d10: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
-00009d20: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
-00009d30: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
-00009d40: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
-00009d50: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-00009d60: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d80: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00009d90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00009da0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009db0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00009dc0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00009dd0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00009de0: 2829 0a20 2020 2020 2020 2076 6965 7765  ().        viewe
-00009df0: 7220 3d20 5265 6c61 7469 6f6e 4368 616e  r = RelationChan
-00009e00: 6765 6456 6965 7765 7228 6861 726e 6573  gedViewer(harnes
-00009e10: 732e 6368 6172 6d2c 2027 6462 2729 0a20  s.charm, 'db'). 
-00009e20: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-00009e30: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00009e40: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-00009e50: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-00009e60: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00009e70: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
-00009e80: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
-00009e90: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00007740: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00007750: 716c 2729 2c20 7b27 7265 6d6f 7465 273a  ql'), {'remote':
+00007760: 2027 6461 7461 277d 290a 2020 2020 2020   'data'}).      
+00007770: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00007780: 7274 5261 6973 6573 284b 6579 4572 726f  rtRaises(KeyErro
+00007790: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000077a0: 2320 756e 6b6e 6f77 6e20 7265 6c61 7469  # unknown relati
+000077b0: 6f6e 2069 640a 2020 2020 2020 2020 2020  on id.          
+000077c0: 2020 6861 726e 6573 732e 6765 745f 7265    harness.get_re
+000077d0: 6c61 7469 6f6e 5f64 6174 6128 3939 2c20  lation_data(99, 
+000077e0: 2770 6f73 7467 7265 7371 6c27 290a 0a20  'postgresql').. 
+000077f0: 2020 2020 2020 206d 6574 6120 3d20 7961         meta = ya
+00007800: 6d6c 2e73 6166 655f 6c6f 6164 2863 6861  ml.safe_load(cha
+00007810: 726d 5f6d 6574 6129 0a20 2020 2020 2020  rm_meta).       
+00007820: 2074 5f61 7070 203d 206f 7073 2e41 7070   t_app = ops.App
+00007830: 6c69 6361 7469 6f6e 2827 7465 7374 2d61  lication('test-a
+00007840: 7070 272c 206d 6574 612c 2068 6172 6e65  pp', meta, harne
+00007850: 7373 2e5f 6261 636b 656e 642c 204e 6f6e  ss._backend, Non
+00007860: 6529 0a20 2020 2020 2020 2074 5f75 6e69  e).        t_uni
+00007870: 7430 203d 206f 7073 2e55 6e69 7428 2774  t0 = ops.Unit('t
+00007880: 6573 742d 6170 702f 3027 2c20 6d65 7461  est-app/0', meta
+00007890: 2c20 6861 726e 6573 732e 5f62 6163 6b65  , harness._backe
+000078a0: 6e64 2c20 7b6f 7073 2e41 7070 6c69 6361  nd, {ops.Applica
+000078b0: 7469 6f6e 3a20 745f 6170 707d 290a 2020  tion: t_app}).  
+000078c0: 2020 2020 2020 745f 756e 6974 3120 3d20        t_unit1 = 
+000078d0: 6f70 732e 556e 6974 2827 7465 7374 2d61  ops.Unit('test-a
+000078e0: 7070 2f31 272c 206d 6574 612c 2068 6172  pp/1', meta, har
+000078f0: 6e65 7373 2e5f 6261 636b 656e 642c 207b  ness._backend, {
+00007900: 6f70 732e 4170 706c 6963 6174 696f 6e3a  ops.Application:
+00007910: 2074 5f61 7070 7d29 0a20 2020 2020 2020   t_app}).       
+00007920: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007930: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+00007940: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+00007950: 6964 2c20 745f 6170 7029 2c20 7b7d 290a  id, t_app), {}).
+00007960: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007970: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+00007980: 2e67 6574 5f72 656c 6174 696f 6e5f 6461  .get_relation_da
+00007990: 7461 2872 656c 5f69 642c 2074 5f75 6e69  ta(rel_id, t_uni
+000079a0: 7430 292c 207b 7d29 0a20 2020 2020 2020  t0), {}).       
+000079b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000079c0: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+000079d0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+000079e0: 6964 2c20 745f 756e 6974 3129 2c20 4e6f  id, t_unit1), No
+000079f0: 6e65 290a 2020 2020 2020 2020 7067 5f61  ne).        pg_a
+00007a00: 7070 203d 206f 7073 2e41 7070 6c69 6361  pp = ops.Applica
+00007a10: 7469 6f6e 2827 706f 7374 6772 6573 716c  tion('postgresql
+00007a20: 272c 206d 6574 612c 2068 6172 6e65 7373  ', meta, harness
+00007a30: 2e5f 6261 636b 656e 642c 204e 6f6e 6529  ._backend, None)
+00007a40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007a50: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+00007a60: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
+00007a70: 6174 6128 7265 6c5f 6964 2c20 7067 5f61  ata(rel_id, pg_a
+00007a80: 7070 292c 207b 2772 656d 6f74 6527 3a20  pp), {'remote': 
+00007a90: 2764 6174 6127 7d29 0a0a 2020 2020 6465  'data'})..    de
+00007aa0: 6620 7465 7374 5f63 7265 6174 655f 6861  f test_create_ha
+00007ab0: 726e 6573 735f 7477 6963 6528 7365 6c66  rness_twice(self
+00007ac0: 293a 0a20 2020 2020 2020 206d 6574 6164  ):.        metad
+00007ad0: 6174 6120 3d20 2727 270a 2020 2020 2020  ata = '''.      
+00007ae0: 2020 2020 2020 6e61 6d65 3a20 6d79 2d63        name: my-c
+00007af0: 6861 726d 0a20 2020 2020 2020 2020 2020  harm.           
+00007b00: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00007b10: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
+00007b20: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00007b30: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+00007b40: 2020 2020 2020 2020 2020 2727 270a 2020            '''.  
+00007b50: 2020 2020 2020 6861 726e 6573 7331 203d        harness1 =
+00007b60: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00007b70: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00007b80: 7365 2c20 6d65 7461 3d6d 6574 6164 6174  se, meta=metadat
+00007b90: 6129 0a20 2020 2020 2020 2073 656c 662e  a).        self.
+00007ba0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00007bb0: 7373 312e 636c 6561 6e75 7029 0a20 2020  ss1.cleanup).   
+00007bc0: 2020 2020 2068 6172 6e65 7373 3220 3d20       harness2 = 
+00007bd0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00007be0: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+00007bf0: 652c 206d 6574 613d 6d65 7461 6461 7461  e, meta=metadata
+00007c00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007c10: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00007c20: 7332 2e63 6c65 616e 7570 290a 2020 2020  s2.cleanup).    
+00007c30: 2020 2020 6861 726e 6573 7331 2e62 6567      harness1.beg
+00007c40: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
+00007c50: 6e65 7373 322e 6265 6769 6e28 290a 2020  ness2.begin().  
+00007c60: 2020 2020 2020 6865 6c70 6572 3120 3d20        helper1 = 
+00007c70: 4442 5265 6c61 7469 6f6e 4368 616e 6765  DBRelationChange
+00007c80: 6448 656c 7065 7228 6861 726e 6573 7331  dHelper(harness1
+00007c90: 2e63 6861 726d 2c20 2268 656c 7065 7231  .charm, "helper1
+00007ca0: 2229 0a20 2020 2020 2020 2068 656c 7065  ").        helpe
+00007cb0: 7232 203d 2044 4252 656c 6174 696f 6e43  r2 = DBRelationC
+00007cc0: 6861 6e67 6564 4865 6c70 6572 2868 6172  hangedHelper(har
+00007cd0: 6e65 7373 322e 6368 6172 6d2c 2022 6865  ness2.charm, "he
+00007ce0: 6c70 6572 3222 290a 2020 2020 2020 2020  lper2").        
+00007cf0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00007d00: 322e 6164 645f 7265 6c61 7469 6f6e 2827  2.add_relation('
+00007d10: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00007d20: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00007d30: 7373 322e 7570 6461 7465 5f72 656c 6174  ss2.update_relat
+00007d40: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00007d50: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
+00007d60: 276b 6579 273a 2027 7661 6c75 6527 7d29  'key': 'value'})
+00007d70: 0a20 2020 2020 2020 2023 2048 656c 7065  .        # Helpe
+00007d80: 7232 2073 686f 756c 6420 7365 6520 7468  r2 should see th
+00007d90: 6520 6576 656e 7420 7472 6967 6765 7265  e event triggere
+00007da0: 6420 6279 2068 6172 6e65 7373 322c 2062  d by harness2, b
+00007db0: 7574 2068 656c 7065 7231 2073 686f 756c  ut helper1 shoul
+00007dc0: 6420 7365 6520 6e6f 2065 7665 6e74 732e  d see no events.
+00007dd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007de0: 7365 7274 4571 7561 6c28 6865 6c70 6572  sertEqual(helper
+00007df0: 312e 6368 616e 6765 732c 205b 5d29 0a20  1.changes, []). 
+00007e00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007e10: 7274 4571 7561 6c28 6865 6c70 6572 322e  rtEqual(helper2.
+00007e20: 6368 616e 6765 732c 205b 2872 656c 5f69  changes, [(rel_i
+00007e30: 642c 2027 706f 7374 6772 6573 716c 2729  d, 'postgresql')
+00007e40: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+00007e50: 5f62 6567 696e 5f74 7769 6365 2873 656c  _begin_twice(sel
+00007e60: 6629 3a0a 2020 2020 2020 2020 2320 6c61  f):.        # la
+00007e70: 6e67 7561 6765 3d59 414d 4c0a 2020 2020  nguage=YAML.    
+00007e80: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+00007e90: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+00007ea0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+00007eb0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00007ec0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00007ed0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00007ee0: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00007ef0: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00007f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f10: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00007f20: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00007f30: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00007f40: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00007f50: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00007f60: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00007f70: 6769 6e28 290a 2020 2020 2020 2020 7769  gin().        wi
+00007f80: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00007f90: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+00007fa0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00007fb0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+00007fc0: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
+00007fd0: 6461 7465 5f72 656c 6174 696f 6e5f 6578  date_relation_ex
+00007fe0: 706f 7365 735f 6e65 775f 6461 7461 2873  poses_new_data(s
+00007ff0: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00008000: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00008010: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+00008020: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+00008030: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00008040: 6e61 6d65 3a20 6d79 2d63 6861 726d 0a20  name: my-charm. 
+00008050: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+00008060: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00008070: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00008080: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+00008090: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
+000080a0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+000080b0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+000080c0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+000080d0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+000080e0: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
+000080f0: 2020 7669 6577 6572 203d 2052 656c 6174    viewer = Relat
+00008100: 696f 6e43 6861 6e67 6564 5669 6577 6572  ionChangedViewer
+00008110: 2868 6172 6e65 7373 2e63 6861 726d 2c20  (harness.charm, 
+00008120: 2764 6227 290a 2020 2020 2020 2020 7265  'db').        re
+00008130: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
+00008140: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
+00008150: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
+00008160: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00008170: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00008180: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00008190: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
+000081a0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+000081b0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000081c0: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+000081d0: 716c 2f30 272c 207b 2769 6e69 7469 616c  ql/0', {'initial
+000081e0: 273a 2027 6461 7461 277d 290a 2020 2020  ': 'data'}).    
+000081f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008200: 7175 616c 2876 6965 7765 722e 6368 616e  qual(viewer.chan
+00008210: 6765 732c 205b 7b27 696e 6974 6961 6c27  ges, [{'initial'
+00008220: 3a20 2764 6174 6127 7d5d 290a 2020 2020  : 'data'}]).    
+00008230: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00008240: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00008250: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+00008260: 6573 716c 2f30 272c 207b 276e 6577 273a  esql/0', {'new':
+00008270: 2027 7661 6c75 6527 7d29 0a20 2020 2020   'value'}).     
+00008280: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00008290: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
+000082a0: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
+000082b0: 2027 6461 7461 277d 2c0a 2020 2020 2020   'data'},.      
+000082c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082e0: 2020 2020 7b27 696e 6974 6961 6c27 3a20      {'initial': 
+000082f0: 2764 6174 6127 2c20 276e 6577 273a 2027  'data', 'new': '
+00008300: 7661 6c75 6527 7d5d 290a 0a20 2020 2064  value'}])..    d
+00008310: 6566 2074 6573 745f 7570 6461 7465 5f72  ef test_update_r
+00008320: 656c 6174 696f 6e5f 6e6f 5f6c 6f63 616c  elation_no_local
+00008330: 5f75 6e69 745f 6368 616e 6765 5f65 7665  _unit_change_eve
+00008340: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
+00008350: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
+00008360: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
+00008370: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00008380: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00008390: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+000083a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000083b0: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
+000083c0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+000083d0: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
+000083e0: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
+000083f0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00008400: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00008410: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00008420: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00008430: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00008440: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00008450: 6769 6e28 290a 2020 2020 2020 2020 6865  gin().        he
+00008460: 6c70 6572 203d 2044 4252 656c 6174 696f  lper = DBRelatio
+00008470: 6e43 6861 6e67 6564 4865 6c70 6572 2868  nChangedHelper(h
+00008480: 6172 6e65 7373 2e63 6861 726d 2c20 2268  arness.charm, "h
+00008490: 656c 7065 7222 290a 2020 2020 2020 2020  elper").        
+000084a0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+000084b0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+000084c0: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+000084d0: 290a 2020 2020 2020 2020 7265 6c20 3d20  ).        rel = 
+000084e0: 6861 726e 6573 732e 6368 6172 6d2e 6d6f  harness.charm.mo
+000084f0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00008500: 2827 6462 2729 0a20 2020 2020 2020 2072  ('db').        r
+00008510: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
+00008520: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
+00008530: 5d5b 276b 6579 275d 203d 2027 7661 6c75  ]['key'] = 'valu
+00008540: 6527 0a20 2020 2020 2020 2023 2074 6865  e'.        # the
+00008550: 7265 2073 686f 756c 6420 6265 206e 6f20  re should be no 
+00008560: 6576 656e 7420 666f 7220 7570 6461 7469  event for updati
+00008570: 6e67 206f 7572 206f 776e 2064 6174 610a  ng our own data.
+00008580: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00008590: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+000085a0: 6461 7461 2872 656c 5f69 642c 2027 6d79  data(rel_id, 'my
+000085b0: 2d63 6861 726d 2f30 272c 207b 276e 6577  -charm/0', {'new
+000085c0: 273a 2027 6f74 6865 7227 7d29 0a20 2020  ': 'other'}).   
+000085d0: 2020 2020 2023 2062 7574 2074 6865 2064       # but the d
+000085e0: 6174 6120 7769 6c6c 2062 6520 7570 6461  ata will be upda
+000085f0: 7465 642e 0a20 2020 2020 2020 2073 656c  ted..        sel
+00008600: 662e 6173 7365 7274 4571 7561 6c28 7b27  f.assertEqual({'
+00008610: 6b65 7927 3a20 2776 616c 7565 272c 2027  key': 'value', '
+00008620: 6e65 7727 3a20 276f 7468 6572 277d 2c20  new': 'other'}, 
+00008630: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
+00008640: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
+00008650: 745d 290a 0a20 2020 2020 2020 2072 656c  t])..        rel
+00008660: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
+00008670: 6172 6d2e 6d6f 6465 6c2e 756e 6974 5d5b  arm.model.unit][
+00008680: 276e 6577 275d 203d 2027 7661 6c75 6527  'new'] = 'value'
+00008690: 0a20 2020 2020 2020 2023 204f 7572 2075  .        # Our u
+000086a0: 6e69 7420 6461 7461 2062 6167 2067 6f74  nit data bag got
+000086b0: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
+000086c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000086d0: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+000086e0: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+000086f0: 756e 6974 5d5b 276e 6577 275d 2c20 2776  unit]['new'], 'v
+00008700: 616c 7565 2729 0a20 2020 2020 2020 2023  alue').        #
+00008710: 2042 7574 2074 6865 7265 2077 6572 6520   But there were 
+00008720: 6e6f 2063 6861 6e67 6564 2065 7665 6e74  no changed event
+00008730: 7320 7265 6769 7374 6572 6564 2062 7920  s registered by 
+00008740: 6f75 7220 756e 6974 2e0a 2020 2020 2020  our unit..      
+00008750: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008760: 616c 285b 5d2c 2068 656c 7065 722e 6368  al([], helper.ch
+00008770: 616e 6765 7329 0a0a 2020 2020 6465 6620  anges)..    def 
+00008780: 7465 7374 5f75 7064 6174 655f 7065 6572  test_update_peer
+00008790: 5f72 656c 6174 696f 6e5f 6e6f 5f6c 6f63  _relation_no_loc
+000087a0: 616c 5f75 6e69 745f 6368 616e 6765 5f65  al_unit_change_e
+000087b0: 7665 6e74 2873 656c 6629 3a0a 2020 2020  vent(self):.    
+000087c0: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
+000087d0: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
+000087e0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+000087f0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00008800: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00008810: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00008820: 6d65 3a20 706f 7374 6772 6573 716c 0a20  me: postgresql. 
+00008830: 2020 2020 2020 2020 2020 2070 6565 7273             peers
+00008840: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008850: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+00008860: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00008870: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00008880: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00008890: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+000088a0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+000088b0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+000088c0: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+000088d0: 656c 7065 7220 3d20 4442 5265 6c61 7469  elper = DBRelati
+000088e0: 6f6e 4368 616e 6765 6448 656c 7065 7228  onChangedHelper(
+000088f0: 6861 726e 6573 732e 6368 6172 6d2c 2022  harness.charm, "
+00008900: 6865 6c70 6572 2229 0a20 2020 2020 2020  helper").       
+00008910: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
+00008920: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+00008930: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00008940: 2729 0a0a 2020 2020 2020 2020 7265 6c20  ')..        rel 
+00008950: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
+00008960: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
+00008970: 6f6e 2827 6462 2729 0a20 2020 2020 2020  on('db').       
+00008980: 2072 656c 2e64 6174 615b 6861 726e 6573   rel.data[harnes
+00008990: 732e 6368 6172 6d2e 6d6f 6465 6c2e 756e  s.charm.model.un
+000089a0: 6974 5d5b 276b 6579 275d 203d 2027 7661  it]['key'] = 'va
+000089b0: 6c75 6527 0a20 2020 2020 2020 2072 656c  lue'.        rel
+000089c0: 203d 2068 6172 6e65 7373 2e63 6861 726d   = harness.charm
+000089d0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+000089e0: 696f 6e28 2764 6227 290a 2020 2020 2020  ion('db').      
+000089f0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00008a00: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00008a10: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00008a20: 716c 2f30 272c 207b 276b 6579 273a 2027  ql/0', {'key': '
+00008a30: 7631 277d 290a 2020 2020 2020 2020 7365  v1'}).        se
+00008a40: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
+00008a50: 276b 6579 273a 2027 7631 277d 2c20 7265  'key': 'v1'}, re
+00008a60: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+00008a70: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
+00008a80: 290a 2020 2020 2020 2020 2320 4d61 6b65  ).        # Make
+00008a90: 2073 7572 6520 7468 6572 6520 7761 7320   sure there was 
+00008aa0: 6e6f 2065 7665 6e74 0a20 2020 2020 2020  no event.       
+00008ab0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008ac0: 6c28 5b5d 2c20 6865 6c70 6572 2e63 6861  l([], helper.cha
+00008ad0: 6e67 6573 290a 0a20 2020 2020 2020 2072  nges)..        r
+00008ae0: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
+00008af0: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
+00008b00: 5d5b 276b 6579 275d 203d 2027 7632 270a  ]['key'] = 'v2'.
+00008b10: 2020 2020 2020 2020 2320 4f75 7220 756e          # Our un
+00008b20: 6974 2064 6174 6120 6261 6720 676f 7420  it data bag got 
+00008b30: 7570 6461 7465 642e 0a20 2020 2020 2020  updated..       
+00008b40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008b50: 6c28 7b27 6b65 7927 3a20 2776 3227 7d2c  l({'key': 'v2'},
+00008b60: 2064 6963 7428 7265 6c2e 6461 7461 5b68   dict(rel.data[h
+00008b70: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
+00008b80: 656c 2e75 6e69 745d 2929 0a20 2020 2020  el.unit])).     
+00008b90: 2020 2023 2042 7574 2074 6865 7265 2077     # But there w
+00008ba0: 6572 6520 6e6f 2063 6861 6e67 6564 2065  ere no changed e
+00008bb0: 7665 6e74 7320 7265 6769 7374 6572 6564  vents registered
+00008bc0: 2062 7920 6f75 7220 756e 6974 2e0a 2020   by our unit..  
+00008bd0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008be0: 7445 7175 616c 285b 5d2c 2068 656c 7065  tEqual([], helpe
+00008bf0: 722e 6368 616e 6765 7329 0a0a 2020 2020  r.changes)..    
+00008c00: 2020 2020 2320 5361 6d65 2066 6f72 2077      # Same for w
+00008c10: 6865 6e20 6f75 7220 756e 6974 2069 7320  hen our unit is 
+00008c20: 6120 6c65 6164 6572 2e0a 2020 2020 2020  a leader..      
+00008c30: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+00008c40: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
+00008c50: 7275 6529 0a20 2020 2020 2020 2068 6172  rue).        har
+00008c60: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00008c70: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00008c80: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00008c90: 2c20 7b27 6b65 7927 3a20 2776 3327 7d29  , {'key': 'v3'})
+00008ca0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008cb0: 7365 7274 4571 7561 6c28 7b27 6b65 7927  sertEqual({'key'
+00008cc0: 3a20 2776 3327 7d2c 2064 6963 7428 7265  : 'v3'}, dict(re
+00008cd0: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+00008ce0: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
+00008cf0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00008d00: 6173 7365 7274 4571 7561 6c28 5b5d 2c20  assertEqual([], 
+00008d10: 6865 6c70 6572 2e63 6861 6e67 6573 290a  helper.changes).
+00008d20: 0a20 2020 2020 2020 2072 656c 2e64 6174  .        rel.dat
+00008d30: 615b 6861 726e 6573 732e 6368 6172 6d2e  a[harness.charm.
+00008d40: 6d6f 6465 6c2e 756e 6974 5d5b 276b 6579  model.unit]['key
+00008d50: 275d 203d 2027 7634 270a 2020 2020 2020  '] = 'v4'.      
+00008d60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008d70: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+00008d80: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00008d90: 756e 6974 5d5b 276b 6579 275d 2c20 2776  unit]['key'], 'v
+00008da0: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
+00008db0: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
+00008dc0: 2068 656c 7065 722e 6368 616e 6765 7329   helper.changes)
+00008dd0: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
+00008de0: 6172 6e65 7373 5f6c 6561 6465 725f 6d69  arness_leader_mi
+00008df0: 7363 6f6e 6669 6728 7365 6c66 293a 0a20  sconfig(self):. 
+00008e00: 2020 2020 2020 2023 206c 616e 6775 6167         # languag
+00008e10: 653d 5941 4d4c 0a20 2020 2020 2020 2068  e=YAML.        h
+00008e20: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00008e30: 7469 6e67 2e48 6172 6e65 7373 2853 6574  ting.Harness(Set
+00008e40: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
+00008e50: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
+00008e60: 2020 2020 2020 2020 6e61 6d65 3a20 706f          name: po
+00008e70: 7374 6772 6573 716c 0a20 2020 2020 2020  stgresql.       
+00008e80: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
+00008e90: 2020 2020 2020 2020 2020 7065 6572 3a0a            peer:.
+00008ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008eb0: 696e 7465 7266 6163 653a 2066 6f6f 0a20  interface: foo. 
+00008ec0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00008ed0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00008ee0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00008ef0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00008f00: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+00008f10: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+00008f20: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00008f30: 2852 756e 7469 6d65 4572 726f 7229 2061  (RuntimeError) a
+00008f40: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00008f50: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+00008f60: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
+00008f70: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00008f80: 662e 6173 7365 7274 5472 7565 2863 6d2e  f.assertTrue(cm.
+00008f90: 6578 6365 7074 696f 6e2e 6172 6773 5b30  exception.args[0
+00008fa0: 5d2e 6669 6e64 2827 7573 6520 4861 726e  ].find('use Harn
+00008fb0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00008fc0: 2729 2021 3d20 2d31 290a 0a20 2020 2064  ') != -1)..    d
+00008fd0: 6566 2074 6573 745f 7570 6461 7465 5f70  ef test_update_p
+00008fe0: 6565 725f 7265 6c61 7469 6f6e 5f61 7070  eer_relation_app
+00008ff0: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
+00009000: 2020 2020 2023 206c 616e 6775 6167 653d       # language=
+00009010: 5941 4d4c 0a20 2020 2020 2020 2068 6172  YAML.        har
+00009020: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00009030: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+00009040: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+00009050: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+00009060: 616d 653a 2070 6f73 7467 7265 7371 6c0a  ame: postgresql.
+00009070: 2020 2020 2020 2020 2020 2020 7065 6572              peer
+00009080: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00009090: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+000090a0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+000090b0: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
+000090c0: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+000090d0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+000090e0: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+000090f0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00009100: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00009110: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
+00009120: 6572 2869 735f 6c65 6164 6572 3d54 7275  er(is_leader=Tru
+00009130: 6529 0a20 2020 2020 2020 2068 656c 7065  e).        helpe
+00009140: 7220 3d20 4442 5265 6c61 7469 6f6e 4368  r = DBRelationCh
+00009150: 616e 6765 6448 656c 7065 7228 6861 726e  angedHelper(harn
+00009160: 6573 732e 6368 6172 6d2c 2022 6865 6c70  ess.charm, "help
+00009170: 6572 2229 0a20 2020 2020 2020 2072 656c  er").        rel
+00009180: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+00009190: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+000091a0: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
+000091b0: 2020 2020 2020 2072 656c 203d 2068 6172         rel = har
+000091c0: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
+000091d0: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
+000091e0: 6227 290a 2020 2020 2020 2020 7265 6c2e  b').        rel.
+000091f0: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
+00009200: 726d 2e61 7070 5d5b 276b 6579 275d 203d  rm.app]['key'] =
+00009210: 2027 7661 6c75 6527 0a20 2020 2020 2020   'value'.       
+00009220: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+00009230: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
+00009240: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+00009250: 6c27 2c20 7b27 6b65 7927 3a20 2776 3127  l', {'key': 'v1'
+00009260: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+00009270: 6173 7365 7274 4571 7561 6c28 7b27 6b65  assertEqual({'ke
+00009280: 7927 3a20 2776 3127 7d2c 2072 656c 2e64  y': 'v1'}, rel.d
+00009290: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+000092a0: 6d2e 6170 705d 290a 2020 2020 2020 2020  m.app]).        
+000092b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000092c0: 285b 5d2c 2068 656c 7065 722e 6368 616e  ([], helper.chan
+000092d0: 6765 7329 0a0a 2020 2020 2020 2020 7265  ges)..        re
+000092e0: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+000092f0: 6861 726d 2e61 7070 5d5b 276b 6579 275d  harm.app]['key']
+00009300: 203d 2027 7632 270a 2020 2020 2020 2020   = 'v2'.        
+00009310: 2320 4f75 7220 756e 6974 2064 6174 6120  # Our unit data 
+00009320: 6261 6720 676f 7420 7570 6461 7465 642e  bag got updated.
+00009330: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00009340: 7365 7274 4571 7561 6c28 7265 6c2e 6461  sertEqual(rel.da
+00009350: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
+00009360: 2e6d 6f64 656c 2e61 7070 5d5b 276b 6579  .model.app]['key
+00009370: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
+00009380: 2020 2320 4275 7420 7468 6572 6520 7765    # But there we
+00009390: 7265 206e 6f20 6368 616e 6765 6420 6576  re no changed ev
+000093a0: 656e 7473 2072 6567 6973 7465 7265 6420  ents registered 
+000093b0: 6279 206f 7572 2075 6e69 742e 0a20 2020  by our unit..   
+000093c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000093d0: 4571 7561 6c28 5b5d 2c20 6865 6c70 6572  Equal([], helper
+000093e0: 2e63 6861 6e67 6573 290a 0a20 2020 2020  .changes)..     
+000093f0: 2020 2023 2049 6620 6f75 7220 756e 6974     # If our unit
+00009400: 2069 7320 6e6f 7420 6120 6c65 6164 6572   is not a leader
+00009410: 2075 6e69 7420 7765 2067 6574 2061 6e20   unit we get an 
+00009420: 7570 6461 7465 2061 626f 7574 2070 6565  update about pee
+00009430: 7220 6170 7020 7265 6c61 7469 6f6e 2064  r app relation d
+00009440: 6174 6120 6368 616e 6765 732e 0a20 2020  ata changes..   
+00009450: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+00009460: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
+00009470: 723d 4661 6c73 6529 0a20 2020 2020 2020  r=False).       
+00009480: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+00009490: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
+000094a0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+000094b0: 6c27 2c20 7b27 6b32 273a 2027 7632 277d  l', {'k2': 'v2'}
+000094c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000094d0: 7373 6572 7445 7175 616c 2872 656c 2e64  ssertEqual(rel.d
+000094e0: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+000094f0: 6d2e 6d6f 6465 6c2e 6170 705d 5b27 6b32  m.model.app]['k2
+00009500: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
+00009510: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009520: 616c 2868 656c 7065 722e 6368 616e 6765  al(helper.change
+00009530: 732c 205b 2830 2c20 2770 6f73 7467 7265  s, [(0, 'postgre
+00009540: 7371 6c27 295d 290a 0a20 2020 2064 6566  sql')])..    def
+00009550: 2074 6573 745f 7570 6461 7465 5f72 656c   test_update_rel
+00009560: 6174 696f 6e5f 6e6f 5f6c 6f63 616c 5f61  ation_no_local_a
+00009570: 7070 5f63 6861 6e67 655f 6576 656e 7428  pp_change_event(
+00009580: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+00009590: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
+000095a0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+000095b0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+000095c0: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+000095d0: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
+000095e0: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
+000095f0: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
+00009600: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00009610: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00009620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009630: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00009640: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00009650: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009660: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00009670: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00009680: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00009690: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+000096a0: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
+000096b0: 6c73 6529 0a20 2020 2020 2020 2068 656c  lse).        hel
+000096c0: 7065 7220 3d20 4442 5265 6c61 7469 6f6e  per = DBRelation
+000096d0: 4368 616e 6765 6448 656c 7065 7228 6861  ChangedHelper(ha
+000096e0: 726e 6573 732e 6368 6172 6d2c 2022 6865  rness.charm, "he
+000096f0: 6c70 6572 2229 0a20 2020 2020 2020 2072  lper").        r
+00009700: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
+00009710: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00009720: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
+00009730: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
+00009740: 2072 656d 6f76 6520 7468 6973 2061 7320   remove this as 
+00009750: 736f 6f6e 2061 7320 6874 7470 733a 2f2f  soon as https://
+00009760: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
+00009770: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
+00009780: 7375 6573 2f31 3735 2069 7320 6669 7865  sues/175 is fixe
+00009790: 642e 0a20 2020 2020 2020 2068 6172 6e65  d..        harne
+000097a0: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
+000097b0: 756e 6974 2872 656c 5f69 642c 2027 706f  unit(rel_id, 'po
+000097c0: 7374 6772 6573 716c 2f30 2729 0a20 2020  stgresql/0').   
+000097d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000097e0: 4571 7561 6c28 6865 6c70 6572 2e63 6861  Equal(helper.cha
+000097f0: 6e67 6573 2c20 5b5d 290a 0a20 2020 2020  nges, [])..     
+00009800: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00009810: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00009820: 7265 6c5f 6964 2c20 276d 792d 6368 6172  rel_id, 'my-char
+00009830: 6d27 2c20 7b27 6e65 7727 3a20 2776 616c  m', {'new': 'val
+00009840: 7565 277d 290a 2020 2020 2020 2020 7265  ue'}).        re
+00009850: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
+00009860: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
+00009870: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
+00009880: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00009890: 7561 6c28 7265 6c2e 6461 7461 5b68 6172  ual(rel.data[har
+000098a0: 6e65 7373 2e63 6861 726d 2e61 7070 5d5b  ness.charm.app][
+000098b0: 276e 6577 275d 2c20 2776 616c 7565 2729  'new'], 'value')
+000098c0: 0a0a 2020 2020 2020 2020 2320 4f75 7220  ..        # Our 
+000098d0: 6170 7020 6461 7461 2062 6167 2067 6f74  app data bag got
+000098e0: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
+000098f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009900: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+00009910: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00009920: 6170 705d 5b27 6e65 7727 5d2c 2027 7661  app]['new'], 'va
+00009930: 6c75 6527 290a 2020 2020 2020 2020 2320  lue').        # 
+00009940: 4275 7420 7468 6572 6520 7765 7265 206e  But there were n
+00009950: 6f20 6368 616e 6765 6420 6576 656e 7473  o changed events
+00009960: 2072 6567 6973 7465 7265 6420 6279 206f   registered by o
+00009970: 7572 2075 6e69 742e 0a20 2020 2020 2020  ur unit..       
+00009980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009990: 6c28 6865 6c70 6572 2e63 6861 6e67 6573  l(helper.changes
+000099a0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+000099b0: 6573 745f 7570 6461 7465 5f72 656c 6174  est_update_relat
+000099c0: 696f 6e5f 7265 6d6f 7665 5f64 6174 6128  ion_remove_data(
+000099d0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+000099e0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+000099f0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+00009a00: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+00009a10: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00009a20: 206e 616d 653a 206d 792d 6368 6172 6d0a   name: my-charm.
+00009a30: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00009a40: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00009a50: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+00009a60: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+00009a70: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
+00009a80: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00009a90: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00009aa0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00009ab0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+00009ac0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+00009ad0: 2020 2076 6965 7765 7220 3d20 5265 6c61     viewer = Rela
+00009ae0: 7469 6f6e 4368 616e 6765 6456 6965 7765  tionChangedViewe
+00009af0: 7228 6861 726e 6573 732e 6368 6172 6d2c  r(harness.charm,
+00009b00: 2027 6462 2729 0a20 2020 2020 2020 2072   'db').        r
+00009b10: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
+00009b20: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00009b30: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
+00009b40: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00009b50: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+00009b60: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
+00009b70: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
+00009b80: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00009b90: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00009ba0: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+00009bb0: 7371 6c2f 3027 2c20 7b27 696e 6974 6961  sql/0', {'initia
+00009bc0: 6c27 3a20 2764 6174 6127 7d29 0a20 2020  l': 'data'}).   
+00009bd0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+00009be0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00009bf0: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
+00009c00: 7265 7371 6c2f 3027 2c20 7b27 696e 6974  resql/0', {'init
+00009c10: 6961 6c27 3a20 2727 7d29 0a20 2020 2020  ial': ''}).     
+00009c20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00009c30: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
+00009c40: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
+00009c50: 2027 6461 7461 277d 2c20 7b7d 5d29 0a0a   'data'}, {}])..
+00009c60: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
+00009c70: 6576 656e 745f 6f6e 5f65 6d70 7479 5f75  event_on_empty_u
+00009c80: 7064 6174 655f 7265 6c61 7469 6f6e 5f75  pdate_relation_u
+00009c90: 6e69 745f 6170 7028 7365 6c66 293a 0a20  nit_app(self):. 
+00009ca0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00009cb0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00009cc0: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00009cd0: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
+00009ce0: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
+00009cf0: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
+00009d00: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00009d10: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00009d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d30: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00009d40: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00009d50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009d60: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00009d70: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00009d80: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00009d90: 2829 0a20 2020 2020 2020 2076 6965 7765  ().        viewe
+00009da0: 7220 3d20 5265 6c61 7469 6f6e 4368 616e  r = RelationChan
+00009db0: 6765 6456 6965 7765 7228 6861 726e 6573  gedViewer(harnes
+00009dc0: 732e 6368 6172 6d2c 2027 6462 2729 0a20  s.charm, 'db'). 
+00009dd0: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+00009de0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00009df0: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+00009e00: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+00009e10: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00009e20: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
+00009e30: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
+00009e40: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00009e50: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
+00009e60: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
+00009e70: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
+00009e80: 696e 6974 6961 6c27 3a20 2764 6174 6127  initial': 'data'
+00009e90: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
 00009ea0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
 00009eb0: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-00009ec0: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
-00009ed0: 696e 6974 6961 6c27 3a20 2764 6174 6127  initial': 'data'
-00009ee0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-00009ef0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00009f00: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-00009f10: 2770 6f73 7467 7265 7371 6c27 2c20 7b7d  'postgresql', {}
-00009f20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009f30: 7373 6572 7445 7175 616c 2876 6965 7765  ssertEqual(viewe
-00009f40: 722e 6368 616e 6765 732c 205b 7b27 696e  r.changes, [{'in
-00009f50: 6974 6961 6c27 3a20 2764 6174 6127 7d5d  itial': 'data'}]
-00009f60: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00009f70: 6e6f 5f65 7665 6e74 5f6f 6e5f 6e6f 5f64  no_event_on_no_d
-00009f80: 6966 665f 7570 6461 7465 5f72 656c 6174  iff_update_relat
-00009f90: 696f 6e5f 756e 6974 5f61 7070 2873 656c  ion_unit_app(sel
-00009fa0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00009fb0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00009fc0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-00009fd0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-00009fe0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-00009ff0: 6d65 3a20 6d79 2d63 6861 726d 0a20 2020  me: my-charm.   
-0000a000: 2020 2020 2020 2020 2072 6571 7569 7265           require
-0000a010: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000a020: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-0000a030: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-0000a040: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-0000a050: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-0000a060: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-0000a070: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-0000a080: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000a090: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-0000a0a0: 7669 6577 6572 203d 2052 656c 6174 696f  viewer = Relatio
-0000a0b0: 6e43 6861 6e67 6564 5669 6577 6572 2868  nChangedViewer(h
-0000a0c0: 6172 6e65 7373 2e63 6861 726d 2c20 2764  arness.charm, 'd
-0000a0d0: 6227 290a 2020 2020 2020 2020 7265 6c5f  b').        rel_
-0000a0e0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-0000a0f0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-0000a100: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
-0000a110: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
-0000a120: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-0000a130: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
-0000a140: 7371 6c2f 3027 290a 2020 2020 2020 2020  sql/0').        
+00009ec0: 2770 6f73 7467 7265 7371 6c27 2c20 7b7d  'postgresql', {}
+00009ed0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009ee0: 7373 6572 7445 7175 616c 2876 6965 7765  ssertEqual(viewe
+00009ef0: 722e 6368 616e 6765 732c 205b 7b27 696e  r.changes, [{'in
+00009f00: 6974 6961 6c27 3a20 2764 6174 6127 7d5d  itial': 'data'}]
+00009f10: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00009f20: 6e6f 5f65 7665 6e74 5f6f 6e5f 6e6f 5f64  no_event_on_no_d
+00009f30: 6966 665f 7570 6461 7465 5f72 656c 6174  iff_update_relat
+00009f40: 696f 6e5f 756e 6974 5f61 7070 2873 656c  ion_unit_app(sel
+00009f50: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00009f60: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00009f70: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00009f80: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00009f90: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00009fa0: 6d65 3a20 6d79 2d63 6861 726d 0a20 2020  me: my-charm.   
+00009fb0: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00009fc0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00009fd0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00009fe0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00009ff0: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
+0000a000: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+0000a010: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+0000a020: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+0000a030: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000a040: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+0000a050: 7669 6577 6572 203d 2052 656c 6174 696f  viewer = Relatio
+0000a060: 6e43 6861 6e67 6564 5669 6577 6572 2868  nChangedViewer(h
+0000a070: 6172 6e65 7373 2e63 6861 726d 2c20 2764  arness.charm, 'd
+0000a080: 6227 290a 2020 2020 2020 2020 7265 6c5f  b').        rel_
+0000a090: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+0000a0a0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+0000a0b0: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+0000a0c0: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0000a0d0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+0000a0e0: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+0000a0f0: 7371 6c2f 3027 290a 2020 2020 2020 2020  sql/0').        
+0000a100: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
+0000a110: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
+0000a120: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+0000a130: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
+0000a140: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
 0000a150: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
 0000a160: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
 0000a170: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
 0000a180: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
 0000a190: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
-0000a1a0: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
-0000a1b0: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-0000a1c0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-0000a1d0: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
-0000a1e0: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
-0000a1f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000a200: 2876 6965 7765 722e 6368 616e 6765 732c  (viewer.changes,
-0000a210: 205b 7b27 696e 6974 6961 6c27 3a20 2764   [{'initial': 'd
-0000a220: 6174 6127 7d5d 290a 0a20 2020 2064 6566  ata'}])..    def
-0000a230: 2074 6573 745f 6e6f 5f65 7665 6e74 5f6f   test_no_event_o
-0000a240: 6e5f 656d 7074 795f 7570 6461 7465 5f72  n_empty_update_r
-0000a250: 656c 6174 696f 6e5f 756e 6974 5f62 6167  elation_unit_bag
-0000a260: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000a270: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0000a280: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0000a290: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0000a2a0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000a2b0: 2020 6e61 6d65 3a20 6d79 2d63 6861 726d    name: my-charm
-0000a2c0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-0000a2d0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-0000a2e0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
-0000a2f0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0000a300: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-0000a310: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000a320: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000a330: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0000a340: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-0000a350: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0000a360: 2020 2020 7669 6577 6572 203d 2052 656c      viewer = Rel
-0000a370: 6174 696f 6e43 6861 6e67 6564 5669 6577  ationChangedView
-0000a380: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
-0000a390: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
-0000a3a0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-0000a3b0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-0000a3c0: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-0000a3d0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0000a3e0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-0000a3f0: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
-0000a400: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
-0000a410: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000a420: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-0000a430: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-0000a440: 6573 716c 2f30 272c 207b 2769 6e69 7469  esql/0', {'initi
-0000a450: 616c 273a 2027 6461 7461 277d 290a 2020  al': 'data'}).  
-0000a460: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
-0000a470: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-0000a480: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
-0000a490: 6772 6573 716c 2f30 272c 207b 7d29 0a20  gresql/0', {}). 
-0000a4a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000a4b0: 7274 4571 7561 6c28 7669 6577 6572 2e63  rtEqual(viewer.c
-0000a4c0: 6861 6e67 6573 2c20 5b7b 2769 6e69 7469  hanges, [{'initi
-0000a4d0: 616c 273a 2027 6461 7461 277d 5d29 0a0a  al': 'data'}])..
-0000a4e0: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
-0000a4f0: 6576 656e 745f 6f6e 5f6e 6f5f 6469 6666  event_on_no_diff
-0000a500: 5f75 7064 6174 655f 7265 6c61 7469 6f6e  _update_relation
-0000a510: 5f75 6e69 745f 6261 6728 7365 6c66 293a  _unit_bag(self):
-0000a520: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000a530: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
-0000a540: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
-0000a550: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-0000a560: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000a570: 206d 792d 6368 6172 6d0a 2020 2020 2020   my-charm.      
-0000a580: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-0000a590: 2020 2020 2020 2020 2020 2020 2020 6462                db
-0000a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a5b0: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
-0000a5c0: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
-0000a5d0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-0000a5e0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0000a5f0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-0000a600: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-0000a610: 696e 2829 0a20 2020 2020 2020 2076 6965  in().        vie
-0000a620: 7765 7220 3d20 5265 6c61 7469 6f6e 4368  wer = RelationCh
-0000a630: 616e 6765 6456 6965 7765 7228 6861 726e  angedViewer(harn
-0000a640: 6573 732e 6368 6172 6d2c 2027 6462 2729  ess.charm, 'db')
-0000a650: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
-0000a660: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
-0000a670: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
-0000a680: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
-0000a690: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-0000a6a0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-0000a6b0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-0000a6c0: 2f30 2729 0a20 2020 2020 2020 2068 6172  /0').        har
-0000a6d0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-0000a6e0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-0000a6f0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
-0000a700: 2c20 7b27 696e 6974 6961 6c27 3a20 2764  , {'initial': 'd
-0000a710: 6174 6127 7d29 0a20 2020 2020 2020 2068  ata'}).        h
-0000a720: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-0000a730: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-0000a740: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-0000a750: 3027 2c20 7b27 696e 6974 6961 6c27 3a20  0', {'initial': 
-0000a760: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-0000a770: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000a780: 6c28 7669 6577 6572 2e63 6861 6e67 6573  l(viewer.changes
-0000a790: 2c20 5b7b 2769 6e69 7469 616c 273a 2027  , [{'initial': '
-0000a7a0: 6461 7461 277d 5d29 0a0a 2020 2020 6465  data'}])..    de
-0000a7b0: 6620 7465 7374 5f65 6d70 7479 5f63 6f6e  f test_empty_con
-0000a7c0: 6669 675f 7261 6973 6573 2873 656c 6629  fig_raises(self)
-0000a7d0: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
-0000a7e0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0000a7f0: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
-0000a800: 2020 2020 2020 2020 206f 7073 2e74 6573           ops.tes
-0000a810: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
-0000a820: 6f72 6469 6e67 4368 6172 6d2c 2063 6f6e  ordingCharm, con
-0000a830: 6669 673d 2727 290a 0a20 2020 2064 6566  fig='')..    def
-0000a840: 2074 6573 745f 7570 6461 7465 5f63 6f6e   test_update_con
-0000a850: 6669 6728 7365 6c66 293a 0a20 2020 2020  fig(self):.     
-0000a860: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-0000a870: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0000a880: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
-0000a890: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
-0000a8a0: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
-0000a8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a8c0: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
-0000a8d0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-0000a8e0: 696f 6e3a 2061 2063 6f6e 6669 6720 6f70  ion: a config op
-0000a8f0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-0000a900: 2020 2020 2020 2020 2074 7970 653a 2073           type: s
-0000a910: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
-0000a920: 2020 2020 2020 623a 0a20 2020 2020 2020        b:.       
-0000a930: 2020 2020 2020 2020 2020 2020 2064 6573               des
-0000a940: 6372 6970 7469 6f6e 3a20 616e 6f74 6865  cription: anothe
-0000a950: 7220 636f 6e66 6967 206f 7074 696f 6e0a  r config option.
-0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a970: 2020 2020 7479 7065 3a20 696e 740a 2020      type: int.  
-0000a980: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-0000a990: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0000a9a0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0000a9b0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0000a9c0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-0000a9d0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000a9e0: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
-0000a9f0: 795f 7661 6c75 6573 3d7b 2761 273a 2027  y_values={'a': '
-0000aa00: 666f 6f27 2c20 2762 273a 2032 7d29 0a20  foo', 'b': 2}). 
-0000aa10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000aa20: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-0000aa30: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-0000aa40: 726d 2e63 6861 6e67 6573 2c0a 2020 2020  rm.changes,.    
-0000aa50: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
-0000aa60: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
-0000aa70: 6427 2c20 2764 6174 6127 3a20 7b27 6127  d', 'data': {'a'
-0000aa80: 3a20 2766 6f6f 272c 2027 6227 3a20 327d  : 'foo', 'b': 2}
-0000aa90: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
-0000aaa0: 6573 732e 7570 6461 7465 5f63 6f6e 6669  ess.update_confi
-0000aab0: 6728 6b65 795f 7661 6c75 6573 3d7b 2762  g(key_values={'b
-0000aac0: 273a 2033 7d29 0a20 2020 2020 2020 2073  ': 3}).        s
-0000aad0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000aae0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-0000aaf0: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
-0000ab00: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0000ab10: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
-0000ab20: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
-0000ab30: 6127 3a20 7b27 6127 3a20 2766 6f6f 272c  a': {'a': 'foo',
-0000ab40: 2027 6227 3a20 327d 7d2c 0a20 2020 2020   'b': 2}},.     
-0000ab50: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-0000ab60: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
-0000ab70: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
-0000ab80: 2027 666f 6f27 2c20 2762 273a 2033 7d7d   'foo', 'b': 3}}
-0000ab90: 5d29 0a20 2020 2020 2020 2023 2079 6f75  ]).        # you
-0000aba0: 2063 616e 2073 6574 2063 6f6e 6669 6720   can set config 
-0000abb0: 7661 6c75 6573 2074 6f20 7468 6520 656d  values to the em
-0000abc0: 7074 7920 7374 7269 6e67 2c20 796f 7520  pty string, you 
-0000abd0: 6361 6e20 7573 6520 756e 7365 7420 746f  can use unset to
-0000abe0: 2061 6374 7561 6c6c 7920 7265 6d6f 7665   actually remove
-0000abf0: 2069 7465 6d73 0a20 2020 2020 2020 2068   items.        h
-0000ac00: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
-0000ac10: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
-0000ac20: 7b27 6127 3a20 2727 7d2c 2075 6e73 6574  {'a': ''}, unset
-0000ac30: 3d73 6574 2827 6227 2929 0a20 2020 2020  =set('b')).     
-0000ac40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ac50: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-0000ac60: 2068 6172 6e65 7373 2e63 6861 726d 2e63   harness.charm.c
-0000ac70: 6861 6e67 6573 2c0a 2020 2020 2020 2020  hanges,.        
-0000ac80: 2020 2020 5b7b 276e 616d 6527 3a20 2763      [{'name': 'c
-0000ac90: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
-0000aca0: 2764 6174 6127 3a20 7b27 6127 3a20 2766  'data': {'a': 'f
-0000acb0: 6f6f 272c 2027 6227 3a20 327d 7d2c 0a20  oo', 'b': 2}},. 
-0000acc0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-0000acd0: 6d65 273a 2027 636f 6e66 6967 2d63 6861  me': 'config-cha
-0000ace0: 6e67 6564 272c 2027 6461 7461 273a 207b  nged', 'data': {
-0000acf0: 2761 273a 2027 666f 6f27 2c20 2762 273a  'a': 'foo', 'b':
-0000ad00: 2033 7d7d 2c0a 2020 2020 2020 2020 2020   3}},.          
-0000ad10: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
-0000ad20: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
-0000ad30: 6174 6127 3a20 7b27 6127 3a20 2727 7d7d  ata': {'a': ''}}
-0000ad40: 2c0a 2020 2020 2020 2020 2020 2020 205d  ,.             ]
-0000ad50: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000ad60: 7570 6461 7465 5f63 6f6e 6669 675f 756e  update_config_un
-0000ad70: 6465 6669 6e65 645f 6f70 7469 6f6e 2873  defined_option(s
-0000ad80: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-0000ad90: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-0000ada0: 696e 672e 4861 726e 6573 7328 5265 636f  ing.Harness(Reco
-0000adb0: 7264 696e 6743 6861 726d 290a 2020 2020  rdingCharm).    
-0000adc0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0000add0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0000ade0: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
-0000adf0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-0000ae00: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000ae10: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
-0000ae20: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000ae30: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000ae40: 6174 655f 636f 6e66 6967 286b 6579 5f76  ate_config(key_v
-0000ae50: 616c 7565 733d 7b27 6e6f 6e65 7869 7374  alues={'nonexist
-0000ae60: 656e 7427 3a20 2766 6f6f 277d 290a 0a20  ent': 'foo'}).. 
-0000ae70: 2020 2064 6566 2074 6573 745f 7570 6461     def test_upda
-0000ae80: 7465 5f63 6f6e 6669 675f 6261 645f 7479  te_config_bad_ty
-0000ae90: 7065 2873 656c 6629 3a0a 2020 2020 2020  pe(self):.      
-0000aea0: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0000aeb0: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0000aec0: 5265 636f 7264 696e 6743 6861 726d 2c20  RecordingCharm, 
-0000aed0: 636f 6e66 6967 3d27 2727 0a20 2020 2020  config='''.     
-0000aee0: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
-0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af00: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
-0000af10: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-0000af20: 6f6e 3a20 6120 636f 6e66 6967 206f 7074  on: a config opt
-0000af30: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0000af40: 2020 2020 2020 2020 7479 7065 3a20 626f          type: bo
-0000af50: 6f6c 6561 6e0a 2020 2020 2020 2020 2020  olean.          
-0000af60: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
-0000af70: 743a 2066 616c 7365 0a20 2020 2020 2020  t: false.       
-0000af80: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0000af90: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0000afa0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0000afb0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-0000afc0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-0000afd0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000afe0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-0000aff0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000b000: 2020 2020 2023 2063 616e 6e6f 7420 6361       # cannot ca
-0000b010: 7374 2074 6f20 626f 6f6c 0a20 2020 2020  st to bool.     
-0000b020: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
-0000b030: 7064 6174 655f 636f 6e66 6967 286b 6579  pdate_config(key
-0000b040: 5f76 616c 7565 733d 7b27 6127 3a20 2766  _values={'a': 'f
-0000b050: 6f6f 277d 290a 0a20 2020 2020 2020 2077  oo'})..        w
-0000b060: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000b070: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-0000b080: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000b090: 2023 2063 616e 6e6f 7420 6361 7374 2074   # cannot cast t
-0000b0a0: 6f20 666c 6f61 740a 2020 2020 2020 2020  o float.        
-0000b0b0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000b0c0: 7465 5f63 6f6e 6669 6728 6b65 795f 7661  te_config(key_va
-0000b0d0: 6c75 6573 3d7b 2761 273a 2034 322e 3432  lues={'a': 42.42
-0000b0e0: 7d29 0a0a 2020 2020 2020 2020 7769 7468  })..        with
-0000b0f0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000b100: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000b110: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000b120: 6361 6e6e 6f74 2063 6173 7420 746f 2069  cannot cast to i
-0000b130: 6e74 0a20 2020 2020 2020 2020 2020 2068  nt.            h
-0000b140: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
-0000b150: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
-0000b160: 7b27 6127 3a20 3432 7d29 0a0a 2020 2020  {'a': 42})..    
-0000b170: 2020 2020 2320 6361 6e20 6361 7374 2074      # can cast t
-0000b180: 6f20 626f 6f6c 210a 2020 2020 2020 2020  o bool!.        
-0000b190: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-0000b1a0: 6f6e 6669 6728 6b65 795f 7661 6c75 6573  onfig(key_values
-0000b1b0: 3d7b 2761 273a 2046 616c 7365 7d29 0a0a  ={'a': False})..
-0000b1c0: 2020 2020 6465 6620 7465 7374 5f62 6164      def test_bad
-0000b1d0: 5f63 6f6e 6669 675f 6f70 7469 6f6e 5f74  _config_option_t
-0000b1e0: 7970 6528 7365 6c66 293a 0a20 2020 2020  ype(self):.     
-0000b1f0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000b200: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-0000b210: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000b220: 2020 2020 206f 7073 2e74 6573 7469 6e67       ops.testing
-0000b230: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
-0000b240: 6e67 4368 6172 6d2c 2063 6f6e 6669 673d  ngCharm, config=
-0000b250: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0000b260: 2020 2020 6f70 7469 6f6e 733a 0a20 2020      options:.   
+0000a1a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000a1b0: 2876 6965 7765 722e 6368 616e 6765 732c  (viewer.changes,
+0000a1c0: 205b 7b27 696e 6974 6961 6c27 3a20 2764   [{'initial': 'd
+0000a1d0: 6174 6127 7d5d 290a 0a20 2020 2064 6566  ata'}])..    def
+0000a1e0: 2074 6573 745f 6e6f 5f65 7665 6e74 5f6f   test_no_event_o
+0000a1f0: 6e5f 656d 7074 795f 7570 6461 7465 5f72  n_empty_update_r
+0000a200: 656c 6174 696f 6e5f 756e 6974 5f62 6167  elation_unit_bag
+0000a210: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000a220: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000a230: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0000a240: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0000a250: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000a260: 2020 6e61 6d65 3a20 6d79 2d63 6861 726d    name: my-charm
+0000a270: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000a280: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000a290: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+0000a2a0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+0000a2b0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+0000a2c0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+0000a2d0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0000a2e0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+0000a2f0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+0000a300: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000a310: 2020 2020 7669 6577 6572 203d 2052 656c      viewer = Rel
+0000a320: 6174 696f 6e43 6861 6e67 6564 5669 6577  ationChangedView
+0000a330: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
+0000a340: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
+0000a350: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+0000a360: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0000a370: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+0000a380: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0000a390: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+0000a3a0: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+0000a3b0: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+0000a3c0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000a3d0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+0000a3e0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+0000a3f0: 6573 716c 2f30 272c 207b 2769 6e69 7469  esql/0', {'initi
+0000a400: 616c 273a 2027 6461 7461 277d 290a 2020  al': 'data'}).  
+0000a410: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+0000a420: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+0000a430: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+0000a440: 6772 6573 716c 2f30 272c 207b 7d29 0a20  gresql/0', {}). 
+0000a450: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000a460: 7274 4571 7561 6c28 7669 6577 6572 2e63  rtEqual(viewer.c
+0000a470: 6861 6e67 6573 2c20 5b7b 2769 6e69 7469  hanges, [{'initi
+0000a480: 616c 273a 2027 6461 7461 277d 5d29 0a0a  al': 'data'}])..
+0000a490: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
+0000a4a0: 6576 656e 745f 6f6e 5f6e 6f5f 6469 6666  event_on_no_diff
+0000a4b0: 5f75 7064 6174 655f 7265 6c61 7469 6f6e  _update_relation
+0000a4c0: 5f75 6e69 745f 6261 6728 7365 6c66 293a  _unit_bag(self):
+0000a4d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000a4e0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0000a4f0: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0000a500: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+0000a510: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+0000a520: 206d 792d 6368 6172 6d0a 2020 2020 2020   my-charm.      
+0000a530: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+0000a540: 2020 2020 2020 2020 2020 2020 2020 6462                db
+0000a550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a560: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
+0000a570: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
+0000a580: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000a590: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000a5a0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+0000a5b0: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+0000a5c0: 696e 2829 0a20 2020 2020 2020 2076 6965  in().        vie
+0000a5d0: 7765 7220 3d20 5265 6c61 7469 6f6e 4368  wer = RelationCh
+0000a5e0: 616e 6765 6456 6965 7765 7228 6861 726e  angedViewer(harn
+0000a5f0: 6573 732e 6368 6172 6d2c 2027 6462 2729  ess.charm, 'db')
+0000a600: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
+0000a610: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
+0000a620: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
+0000a630: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
+0000a640: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+0000a650: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+0000a660: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+0000a670: 2f30 2729 0a20 2020 2020 2020 2068 6172  /0').        har
+0000a680: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+0000a690: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+0000a6a0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+0000a6b0: 2c20 7b27 696e 6974 6961 6c27 3a20 2764  , {'initial': 'd
+0000a6c0: 6174 6127 7d29 0a20 2020 2020 2020 2068  ata'}).        h
+0000a6d0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+0000a6e0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+0000a6f0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
+0000a700: 3027 2c20 7b27 696e 6974 6961 6c27 3a20  0', {'initial': 
+0000a710: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
+0000a720: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000a730: 6c28 7669 6577 6572 2e63 6861 6e67 6573  l(viewer.changes
+0000a740: 2c20 5b7b 2769 6e69 7469 616c 273a 2027  , [{'initial': '
+0000a750: 6461 7461 277d 5d29 0a0a 2020 2020 6465  data'}])..    de
+0000a760: 6620 7465 7374 5f65 6d70 7479 5f63 6f6e  f test_empty_con
+0000a770: 6669 675f 7261 6973 6573 2873 656c 6629  fig_raises(self)
+0000a780: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
+0000a790: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000a7a0: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0000a7b0: 2020 2020 2020 2020 206f 7073 2e74 6573           ops.tes
+0000a7c0: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
+0000a7d0: 6f72 6469 6e67 4368 6172 6d2c 2063 6f6e  ordingCharm, con
+0000a7e0: 6669 673d 2727 290a 0a20 2020 2064 6566  fig='')..    def
+0000a7f0: 2074 6573 745f 7570 6461 7465 5f63 6f6e   test_update_con
+0000a800: 6669 6728 7365 6c66 293a 0a20 2020 2020  fig(self):.     
+0000a810: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000a820: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000a830: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
+0000a840: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
+0000a850: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
+0000a860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a870: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
+0000a880: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+0000a890: 696f 6e3a 2061 2063 6f6e 6669 6720 6f70  ion: a config op
+0000a8a0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+0000a8b0: 2020 2020 2020 2020 2074 7970 653a 2073           type: s
+0000a8c0: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
+0000a8d0: 2020 2020 2020 623a 0a20 2020 2020 2020        b:.       
+0000a8e0: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0000a8f0: 6372 6970 7469 6f6e 3a20 616e 6f74 6865  cription: anothe
+0000a900: 7220 636f 6e66 6967 206f 7074 696f 6e0a  r config option.
+0000a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a920: 2020 2020 7479 7065 3a20 696e 740a 2020      type: int.  
+0000a930: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0000a940: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000a950: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000a960: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000a970: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+0000a980: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000a990: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
+0000a9a0: 795f 7661 6c75 6573 3d7b 2761 273a 2027  y_values={'a': '
+0000a9b0: 666f 6f27 2c20 2762 273a 2032 7d29 0a20  foo', 'b': 2}). 
+0000a9c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000a9d0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000a9e0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000a9f0: 726d 2e63 6861 6e67 6573 2c0a 2020 2020  rm.changes,.    
+0000aa00: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000aa10: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000aa20: 6427 2c20 2764 6174 6127 3a20 7b27 6127  d', 'data': {'a'
+0000aa30: 3a20 2766 6f6f 272c 2027 6227 3a20 327d  : 'foo', 'b': 2}
+0000aa40: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
+0000aa50: 6573 732e 7570 6461 7465 5f63 6f6e 6669  ess.update_confi
+0000aa60: 6728 6b65 795f 7661 6c75 6573 3d7b 2762  g(key_values={'b
+0000aa70: 273a 2033 7d29 0a20 2020 2020 2020 2073  ': 3}).        s
+0000aa80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000aa90: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000aaa0: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
+0000aab0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000aac0: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
+0000aad0: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
+0000aae0: 6127 3a20 7b27 6127 3a20 2766 6f6f 272c  a': {'a': 'foo',
+0000aaf0: 2027 6227 3a20 327d 7d2c 0a20 2020 2020   'b': 2}},.     
+0000ab00: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+0000ab10: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+0000ab20: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
+0000ab30: 2027 666f 6f27 2c20 2762 273a 2033 7d7d   'foo', 'b': 3}}
+0000ab40: 5d29 0a20 2020 2020 2020 2023 2079 6f75  ]).        # you
+0000ab50: 2063 616e 2073 6574 2063 6f6e 6669 6720   can set config 
+0000ab60: 7661 6c75 6573 2074 6f20 7468 6520 656d  values to the em
+0000ab70: 7074 7920 7374 7269 6e67 2c20 796f 7520  pty string, you 
+0000ab80: 6361 6e20 7573 6520 756e 7365 7420 746f  can use unset to
+0000ab90: 2061 6374 7561 6c6c 7920 7265 6d6f 7665   actually remove
+0000aba0: 2069 7465 6d73 0a20 2020 2020 2020 2068   items.        h
+0000abb0: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
+0000abc0: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
+0000abd0: 7b27 6127 3a20 2727 7d2c 2075 6e73 6574  {'a': ''}, unset
+0000abe0: 3d73 6574 2827 6227 2929 0a20 2020 2020  =set('b')).     
+0000abf0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ac00: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+0000ac10: 2068 6172 6e65 7373 2e63 6861 726d 2e63   harness.charm.c
+0000ac20: 6861 6e67 6573 2c0a 2020 2020 2020 2020  hanges,.        
+0000ac30: 2020 2020 5b7b 276e 616d 6527 3a20 2763      [{'name': 'c
+0000ac40: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
+0000ac50: 2764 6174 6127 3a20 7b27 6127 3a20 2766  'data': {'a': 'f
+0000ac60: 6f6f 272c 2027 6227 3a20 327d 7d2c 0a20  oo', 'b': 2}},. 
+0000ac70: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+0000ac80: 6d65 273a 2027 636f 6e66 6967 2d63 6861  me': 'config-cha
+0000ac90: 6e67 6564 272c 2027 6461 7461 273a 207b  nged', 'data': {
+0000aca0: 2761 273a 2027 666f 6f27 2c20 2762 273a  'a': 'foo', 'b':
+0000acb0: 2033 7d7d 2c0a 2020 2020 2020 2020 2020   3}},.          
+0000acc0: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
+0000acd0: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
+0000ace0: 6174 6127 3a20 7b27 6127 3a20 2727 7d7d  ata': {'a': ''}}
+0000acf0: 2c0a 2020 2020 2020 2020 2020 2020 205d  ,.             ]
+0000ad00: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000ad10: 7570 6461 7465 5f63 6f6e 6669 675f 756e  update_config_un
+0000ad20: 6465 6669 6e65 645f 6f70 7469 6f6e 2873  defined_option(s
+0000ad30: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+0000ad40: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+0000ad50: 696e 672e 4861 726e 6573 7328 5265 636f  ing.Harness(Reco
+0000ad60: 7264 696e 6743 6861 726d 290a 2020 2020  rdingCharm).    
+0000ad70: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0000ad80: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0000ad90: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
+0000ada0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0000adb0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000adc0: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
+0000add0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000ade0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+0000adf0: 6174 655f 636f 6e66 6967 286b 6579 5f76  ate_config(key_v
+0000ae00: 616c 7565 733d 7b27 6e6f 6e65 7869 7374  alues={'nonexist
+0000ae10: 656e 7427 3a20 2766 6f6f 277d 290a 0a20  ent': 'foo'}).. 
+0000ae20: 2020 2064 6566 2074 6573 745f 7570 6461     def test_upda
+0000ae30: 7465 5f63 6f6e 6669 675f 6261 645f 7479  te_config_bad_ty
+0000ae40: 7065 2873 656c 6629 3a0a 2020 2020 2020  pe(self):.      
+0000ae50: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+0000ae60: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+0000ae70: 5265 636f 7264 696e 6743 6861 726d 2c20  RecordingCharm, 
+0000ae80: 636f 6e66 6967 3d27 2727 0a20 2020 2020  config='''.     
+0000ae90: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
+0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aeb0: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
+0000aec0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
+0000aed0: 6f6e 3a20 6120 636f 6e66 6967 206f 7074  on: a config opt
+0000aee0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000aef0: 2020 2020 2020 2020 7479 7065 3a20 626f          type: bo
+0000af00: 6f6c 6561 6e0a 2020 2020 2020 2020 2020  olean.          
+0000af10: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
+0000af20: 743a 2066 616c 7365 0a20 2020 2020 2020  t: false.       
+0000af30: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+0000af40: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0000af50: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0000af60: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+0000af70: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0000af80: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000af90: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+0000afa0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000afb0: 2020 2020 2023 2063 616e 6e6f 7420 6361       # cannot ca
+0000afc0: 7374 2074 6f20 626f 6f6c 0a20 2020 2020  st to bool.     
+0000afd0: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
+0000afe0: 7064 6174 655f 636f 6e66 6967 286b 6579  pdate_config(key
+0000aff0: 5f76 616c 7565 733d 7b27 6127 3a20 2766  _values={'a': 'f
+0000b000: 6f6f 277d 290a 0a20 2020 2020 2020 2077  oo'})..        w
+0000b010: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000b020: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+0000b030: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000b040: 2023 2063 616e 6e6f 7420 6361 7374 2074   # cannot cast t
+0000b050: 6f20 666c 6f61 740a 2020 2020 2020 2020  o float.        
+0000b060: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000b070: 7465 5f63 6f6e 6669 6728 6b65 795f 7661  te_config(key_va
+0000b080: 6c75 6573 3d7b 2761 273a 2034 322e 3432  lues={'a': 42.42
+0000b090: 7d29 0a0a 2020 2020 2020 2020 7769 7468  })..        with
+0000b0a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000b0b0: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0000b0c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000b0d0: 6361 6e6e 6f74 2063 6173 7420 746f 2069  cannot cast to i
+0000b0e0: 6e74 0a20 2020 2020 2020 2020 2020 2068  nt.            h
+0000b0f0: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
+0000b100: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
+0000b110: 7b27 6127 3a20 3432 7d29 0a0a 2020 2020  {'a': 42})..    
+0000b120: 2020 2020 2320 6361 6e20 6361 7374 2074      # can cast t
+0000b130: 6f20 626f 6f6c 210a 2020 2020 2020 2020  o bool!.        
+0000b140: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
+0000b150: 6f6e 6669 6728 6b65 795f 7661 6c75 6573  onfig(key_values
+0000b160: 3d7b 2761 273a 2046 616c 7365 7d29 0a0a  ={'a': False})..
+0000b170: 2020 2020 6465 6620 7465 7374 5f62 6164      def test_bad
+0000b180: 5f63 6f6e 6669 675f 6f70 7469 6f6e 5f74  _config_option_t
+0000b190: 7970 6528 7365 6c66 293a 0a20 2020 2020  ype(self):.     
+0000b1a0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000b1b0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+0000b1c0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000b1d0: 2020 2020 206f 7073 2e74 6573 7469 6e67       ops.testing
+0000b1e0: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
+0000b1f0: 6e67 4368 6172 6d2c 2063 6f6e 6669 673d  ngCharm, config=
+0000b200: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+0000b210: 2020 2020 6f70 7469 6f6e 733a 0a20 2020      options:.   
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
+0000b240: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+0000b250: 7269 7074 696f 6e3a 2061 2063 6f6e 6669  ription: a confi
+0000b260: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
 0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b280: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
-0000b290: 2020 2020 2020 2020 2020 2020 6465 7363              desc
-0000b2a0: 7269 7074 696f 6e3a 2061 2063 6f6e 6669  ription: a confi
-0000b2b0: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2d0: 2074 7970 653a 2067 6962 6265 7269 7368   type: gibberish
-0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b2f0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-0000b300: 3a20 4661 6c73 650a 2020 2020 2020 2020  : False.        
-0000b310: 2020 2020 2020 2020 2727 2729 0a0a 2020          ''')..  
-0000b320: 2020 6465 6620 7465 7374 5f6e 6f5f 636f    def test_no_co
-0000b330: 6e66 6967 5f6f 7074 696f 6e5f 7479 7065  nfig_option_type
-0000b340: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000b350: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000b360: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
-0000b370: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000b380: 2020 6f70 732e 7465 7374 696e 672e 4861    ops.testing.Ha
-0000b390: 726e 6573 7328 5265 636f 7264 696e 6743  rness(RecordingC
-0000b3a0: 6861 726d 2c20 636f 6e66 6967 3d27 2727  harm, config='''
-0000b3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b3c0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
-0000b3d0: 2020 2020 2020 2020 2020 2020 2020 613a                a:
-0000b3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b3f0: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-0000b400: 7469 6f6e 3a20 6120 636f 6e66 6967 206f  tion: a config o
-0000b410: 7074 696f 6e0a 2020 2020 2020 2020 2020  ption.          
-0000b420: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000b430: 6661 756c 743a 2046 616c 7365 0a20 2020  fault: False.   
-0000b440: 2020 2020 2020 2020 2020 2020 2027 2727               '''
-0000b450: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000b460: 756e 6361 7374 6162 6c65 5f63 6f6e 6669  uncastable_confi
-0000b470: 675f 6f70 7469 6f6e 5f74 7970 6528 7365  g_option_type(se
-0000b480: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
-0000b490: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000b4a0: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-0000b4b0: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
-0000b4c0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-0000b4d0: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
-0000b4e0: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
-0000b4f0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-0000b500: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-0000b510: 2020 2020 2020 2020 2020 2061 3a0a 2020             a:.  
-0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b530: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-0000b540: 6e3a 2061 2063 6f6e 6669 6720 6f70 7469  n: a config opti
-0000b550: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-0000b560: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-0000b570: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
-0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b590: 2064 6566 6175 6c74 3a20 7065 656b 2d61   default: peek-a
-0000b5a0: 2d62 6f6f 6c21 0a20 2020 2020 2020 2020  -bool!.         
-0000b5b0: 2020 2020 2020 2027 2727 290a 0a20 2020         ''')..   
-0000b5c0: 2064 6566 2074 6573 745f 7570 6461 7465   def test_update
-0000b5d0: 5f63 6f6e 6669 675f 756e 7365 745f 626f  _config_unset_bo
-0000b5e0: 6f6c 6561 6e28 7365 6c66 293a 0a20 2020  olean(self):.   
-0000b5f0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-0000b600: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-0000b610: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
-0000b620: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
-0000b630: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
-0000b640: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000b650: 2020 2061 3a0a 2020 2020 2020 2020 2020     a:.          
-0000b660: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-0000b670: 7074 696f 6e3a 2061 2063 6f6e 6669 6720  ption: a config 
-0000b680: 6f70 7469 6f6e 0a20 2020 2020 2020 2020  option.         
-0000b690: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-0000b6a0: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
-0000b6b0: 2020 2020 2020 2020 2020 2020 2064 6566               def
-0000b6c0: 6175 6c74 3a20 4661 6c73 650a 2020 2020  ault: False.    
-0000b6d0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-0000b6e0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0000b6f0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0000b700: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
-0000b710: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-0000b720: 2020 2020 2020 2320 4368 6563 6b20 7468        # Check th
-0000b730: 6520 6465 6661 756c 7420 7761 7320 7365  e default was se
-0000b740: 7420 636f 7272 6563 746c 790a 2020 2020  t correctly.    
-0000b750: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000b760: 7175 616c 2868 6172 6e65 7373 2e63 6861  qual(harness.cha
-0000b770: 726d 2e63 6f6e 6669 672c 207b 2761 273a  rm.config, {'a':
-0000b780: 2046 616c 7365 7d29 0a20 2020 2020 2020   False}).       
-0000b790: 2023 2053 6574 2074 6865 2062 6f6f 6c65   # Set the boole
-0000b7a0: 616e 2076 616c 7565 2074 6f20 5472 7565  an value to True
-0000b7b0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000b7c0: 2e75 7064 6174 655f 636f 6e66 6967 286b  .update_config(k
-0000b7d0: 6579 5f76 616c 7565 733d 7b27 6127 3a20  ey_values={'a': 
-0000b7e0: 5472 7565 7d29 0a20 2020 2020 2020 2073  True}).        s
-0000b7f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000b800: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
-0000b810: 616e 6765 732c 205b 7b27 6e61 6d65 273a  anges, [{'name':
-0000b820: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
-0000b830: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
-0000b840: 2054 7275 657d 7d5d 290a 2020 2020 2020   True}}]).      
-0000b850: 2020 2320 556e 7365 7420 7468 6520 626f    # Unset the bo
-0000b860: 6f6c 6561 6e20 7661 6c75 650a 2020 2020  olean value.    
-0000b870: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000b880: 7465 5f63 6f6e 6669 6728 756e 7365 743d  te_config(unset=
-0000b890: 7b27 6127 7d29 0a20 2020 2020 2020 2073  {'a'}).        s
-0000b8a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000b8b0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-0000b8c0: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
-0000b8d0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0000b8e0: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
-0000b8f0: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
-0000b900: 6127 3a20 7b27 6127 3a20 5472 7565 7d7d  a': {'a': True}}
-0000b910: 2c0a 2020 2020 2020 2020 2020 2020 207b  ,.             {
-0000b920: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
-0000b930: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
-0000b940: 3a20 7b27 6127 3a20 4661 6c73 657d 7d5d  : {'a': False}}]
-0000b950: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000b960: 7365 745f 6c65 6164 6572 2873 656c 6629  set_leader(self)
-0000b970: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-0000b980: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-0000b990: 4861 726e 6573 7328 5265 636f 7264 696e  Harness(Recordin
-0000b9a0: 6743 6861 726d 290a 2020 2020 2020 2020  gCharm).        
-0000b9b0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-0000b9c0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-0000b9d0: 0a20 2020 2020 2020 2023 204e 6f20 6576  .        # No ev
-0000b9e0: 656e 7420 6861 7070 656e 7320 6865 7265  ent happens here
-0000b9f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000ba00: 2e73 6574 5f6c 6561 6465 7228 4661 6c73  .set_leader(Fals
-0000ba10: 6529 0a20 2020 2020 2020 2068 6172 6e65  e).        harne
-0000ba20: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-0000ba30: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
-0000ba40: 6c73 6528 6861 726e 6573 732e 6368 6172  lse(harness.char
-0000ba50: 6d2e 6d6f 6465 6c2e 756e 6974 2e69 735f  m.model.unit.is_
-0000ba60: 6c65 6164 6572 2829 290a 2020 2020 2020  leader()).      
-0000ba70: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-0000ba80: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
-0000ba90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000baa0: 7561 6c28 6861 726e 6573 732e 6368 6172  ual(harness.char
-0000bab0: 6d2e 6765 745f 6368 616e 6765 7328 7265  m.get_changes(re
-0000bac0: 7365 743d 5472 7565 292c 205b 7b27 6e61  set=True), [{'na
-0000bad0: 6d65 273a 2027 6c65 6164 6572 2d65 6c65  me': 'leader-ele
-0000bae0: 6374 6564 277d 5d29 0a20 2020 2020 2020  cted'}]).       
-0000baf0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000bb00: 2868 6172 6e65 7373 2e63 6861 726d 2e6d  (harness.charm.m
-0000bb10: 6f64 656c 2e75 6e69 742e 6973 5f6c 6561  odel.unit.is_lea
-0000bb20: 6465 7228 2929 0a20 2020 2020 2020 2068  der()).        h
-0000bb30: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-0000bb40: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
-0000bb50: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
-0000bb60: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
-0000bb70: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
-0000bb80: 6164 6572 2829 290a 2020 2020 2020 2020  ader()).        
-0000bb90: 2320 4e6f 2068 6f6f 6b20 6576 656e 7420  # No hook event 
-0000bba0: 7768 656e 2079 6f75 206c 6f73 6520 6c65  when you lose le
-0000bbb0: 6164 6572 7368 6970 2e0a 2020 2020 2020  adership..      
-0000bbc0: 2020 2320 544f 444f 3a20 7665 7269 6679    # TODO: verify
-0000bbd0: 2069 6620 4a75 6a75 2061 6c77 6179 7320   if Juju always 
-0000bbe0: 7472 6967 6765 7273 2060 6c65 6164 6572  triggers `leader
-0000bbf0: 2d73 6574 7469 6e67 732d 6368 616e 6765  -settings-change
-0000bc00: 6460 2069 6620 796f 750a 2020 2020 2020  d` if you.      
-0000bc10: 2020 2320 2020 6c6f 7365 206c 6561 6465    #   lose leade
-0000bc20: 7273 6869 702e 0a20 2020 2020 2020 2073  rship..        s
-0000bc30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000bc40: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-0000bc50: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
-0000bc60: 5472 7565 292c 205b 5d29 0a20 2020 2020  True), []).     
-0000bc70: 2020 2068 6172 6e65 7373 2e64 6973 6162     harness.disab
-0000bc80: 6c65 5f68 6f6f 6b73 2829 0a20 2020 2020  le_hooks().     
-0000bc90: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
-0000bca0: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
-0000bcb0: 2020 2020 2320 4e6f 2068 6f6f 6b20 6576      # No hook ev
-0000bcc0: 656e 7420 6966 2079 6f75 2068 6176 6520  ent if you have 
-0000bcd0: 6469 7361 626c 6564 2074 6865 6d0a 2020  disabled them.  
-0000bce0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bcf0: 7445 7175 616c 2868 6172 6e65 7373 2e63  tEqual(harness.c
-0000bd00: 6861 726d 2e67 6574 5f63 6861 6e67 6573  harm.get_changes
-0000bd10: 2872 6573 6574 3d54 7275 6529 2c20 5b5d  (reset=True), []
-0000bd20: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000bd30: 7265 6c61 7469 6f6e 5f73 6574 5f61 7070  relation_set_app
-0000bd40: 5f6e 6f74 5f6c 6561 6465 7228 7365 6c66  _not_leader(self
-0000bd50: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0000bd60: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0000bd70: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
-0000bd80: 6e67 4368 6172 6d2c 206d 6574 613d 2727  ngCharm, meta=''
-0000bd90: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0000bda0: 6d65 3a20 7465 7374 2d63 6861 726d 0a20  me: test-charm. 
-0000bdb0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-0000bdc0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-0000bdd0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
-0000bde0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0000bdf0: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
-0000be00: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-0000be10: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0000be20: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0000be30: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0000be40: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-0000be50: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000be60: 7365 745f 6c65 6164 6572 2846 616c 7365  set_leader(False
-0000be70: 290a 2020 2020 2020 2020 7265 6c5f 6964  ).        rel_id
-0000be80: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
-0000be90: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
-0000bea0: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
-0000beb0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-0000bec0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-0000bed0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-0000bee0: 6c2f 3027 290a 2020 2020 2020 2020 7265  l/0').        re
-0000bef0: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
-0000bf00: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
-0000bf10: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
-0000bf20: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
-0000bf30: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
-0000bf40: 666f 6f27 293a 0a20 2020 2020 2020 2020  foo'):.         
-0000bf50: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000bf60: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
-0000bf70: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
-0000bf80: 2020 2020 2020 2020 2020 2072 656c 2e64             rel.d
-0000bf90: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-0000bfa0: 6d2e 6170 705d 5b27 666f 6f27 5d20 3d20  m.app]['foo'] = 
-0000bfb0: 2762 6172 270a 2020 2020 2020 2020 2320  'bar'.        # 
-0000bfc0: 5468 6520 6461 7461 2068 6173 206e 6f74  The data has not
-0000bfd0: 2061 6374 7561 6c6c 7920 6265 656e 2063   actually been c
-0000bfe0: 6861 6e67 6564 0a20 2020 2020 2020 2073  hanged.        s
-0000bff0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000c000: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
-0000c010: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-0000c020: 2c20 2774 6573 742d 6368 6172 6d27 292c  , 'test-charm'),
-0000c030: 207b 7d29 0a20 2020 2020 2020 2068 6172   {}).        har
-0000c040: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
-0000c050: 5472 7565 290a 2020 2020 2020 2020 7265  True).        re
-0000c060: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
-0000c070: 6861 726d 2e61 7070 5d5b 2766 6f6f 275d  harm.app]['foo']
-0000c080: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
-0000c090: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000c0a0: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
-0000c0b0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-0000c0c0: 6964 2c20 2774 6573 742d 6368 6172 6d27  id, 'test-charm'
-0000c0d0: 292c 207b 2766 6f6f 273a 2027 6261 7227  ), {'foo': 'bar'
-0000c0e0: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-0000c0f0: 5f68 6f6f 6b73 5f65 6e61 626c 6564 5f61  _hooks_enabled_a
-0000c100: 6e64 5f64 6973 6162 6c65 6428 7365 6c66  nd_disabled(self
-0000c110: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0000c120: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0000c130: 2e48 6172 6e65 7373 280a 2020 2020 2020  .Harness(.      
-0000c140: 2020 2020 2020 5265 636f 7264 696e 6743        RecordingC
-0000c150: 6861 726d 2c0a 2020 2020 2020 2020 2020  harm,.          
-0000c160: 2020 6d65 7461 3d27 2727 0a20 2020 2020    meta='''.     
-0000c170: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000c180: 616d 653a 2074 6573 742d 6368 6172 6d0a  ame: test-charm.
+0000b280: 2074 7970 653a 2067 6962 6265 7269 7368   type: gibberish
+0000b290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b2a0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
+0000b2b0: 3a20 4661 6c73 650a 2020 2020 2020 2020  : False.        
+0000b2c0: 2020 2020 2020 2020 2727 2729 0a0a 2020          ''')..  
+0000b2d0: 2020 6465 6620 7465 7374 5f6e 6f5f 636f    def test_no_co
+0000b2e0: 6e66 6967 5f6f 7074 696f 6e5f 7479 7065  nfig_option_type
+0000b2f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000b300: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000b310: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
+0000b320: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000b330: 2020 6f70 732e 7465 7374 696e 672e 4861    ops.testing.Ha
+0000b340: 726e 6573 7328 5265 636f 7264 696e 6743  rness(RecordingC
+0000b350: 6861 726d 2c20 636f 6e66 6967 3d27 2727  harm, config='''
+0000b360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b370: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
+0000b380: 2020 2020 2020 2020 2020 2020 2020 613a                a:
+0000b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3a0: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+0000b3b0: 7469 6f6e 3a20 6120 636f 6e66 6967 206f  tion: a config o
+0000b3c0: 7074 696f 6e0a 2020 2020 2020 2020 2020  ption.          
+0000b3d0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000b3e0: 6661 756c 743a 2046 616c 7365 0a20 2020  fault: False.   
+0000b3f0: 2020 2020 2020 2020 2020 2020 2027 2727               '''
+0000b400: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000b410: 756e 6361 7374 6162 6c65 5f63 6f6e 6669  uncastable_confi
+0000b420: 675f 6f70 7469 6f6e 5f74 7970 6528 7365  g_option_type(se
+0000b430: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
+0000b440: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000b450: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
+0000b460: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
+0000b470: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0000b480: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
+0000b490: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
+0000b4a0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000b4b0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+0000b4c0: 2020 2020 2020 2020 2020 2061 3a0a 2020             a:.  
+0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4e0: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+0000b4f0: 6e3a 2061 2063 6f6e 6669 6720 6f70 7469  n: a config opti
+0000b500: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0000b510: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000b520: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+0000b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b540: 2064 6566 6175 6c74 3a20 7065 656b 2d61   default: peek-a
+0000b550: 2d62 6f6f 6c21 0a20 2020 2020 2020 2020  -bool!.         
+0000b560: 2020 2020 2020 2027 2727 290a 0a20 2020         ''')..   
+0000b570: 2064 6566 2074 6573 745f 7570 6461 7465   def test_update
+0000b580: 5f63 6f6e 6669 675f 756e 7365 745f 626f  _config_unset_bo
+0000b590: 6f6c 6561 6e28 7365 6c66 293a 0a20 2020  olean(self):.   
+0000b5a0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0000b5b0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0000b5c0: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
+0000b5d0: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
+0000b5e0: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+0000b5f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000b600: 2020 2061 3a0a 2020 2020 2020 2020 2020     a:.          
+0000b610: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0000b620: 7074 696f 6e3a 2061 2063 6f6e 6669 6720  ption: a config 
+0000b630: 6f70 7469 6f6e 0a20 2020 2020 2020 2020  option.         
+0000b640: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000b650: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+0000b660: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000b670: 6175 6c74 3a20 4661 6c73 650a 2020 2020  ault: False.    
+0000b680: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+0000b690: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0000b6a0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0000b6b0: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
+0000b6c0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+0000b6d0: 2020 2020 2020 2320 4368 6563 6b20 7468        # Check th
+0000b6e0: 6520 6465 6661 756c 7420 7761 7320 7365  e default was se
+0000b6f0: 7420 636f 7272 6563 746c 790a 2020 2020  t correctly.    
+0000b700: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000b710: 7175 616c 2868 6172 6e65 7373 2e63 6861  qual(harness.cha
+0000b720: 726d 2e63 6f6e 6669 672c 207b 2761 273a  rm.config, {'a':
+0000b730: 2046 616c 7365 7d29 0a20 2020 2020 2020   False}).       
+0000b740: 2023 2053 6574 2074 6865 2062 6f6f 6c65   # Set the boole
+0000b750: 616e 2076 616c 7565 2074 6f20 5472 7565  an value to True
+0000b760: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000b770: 2e75 7064 6174 655f 636f 6e66 6967 286b  .update_config(k
+0000b780: 6579 5f76 616c 7565 733d 7b27 6127 3a20  ey_values={'a': 
+0000b790: 5472 7565 7d29 0a20 2020 2020 2020 2073  True}).        s
+0000b7a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000b7b0: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
+0000b7c0: 616e 6765 732c 205b 7b27 6e61 6d65 273a  anges, [{'name':
+0000b7d0: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+0000b7e0: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
+0000b7f0: 2054 7275 657d 7d5d 290a 2020 2020 2020   True}}]).      
+0000b800: 2020 2320 556e 7365 7420 7468 6520 626f    # Unset the bo
+0000b810: 6f6c 6561 6e20 7661 6c75 650a 2020 2020  olean value.    
+0000b820: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000b830: 7465 5f63 6f6e 6669 6728 756e 7365 743d  te_config(unset=
+0000b840: 7b27 6127 7d29 0a20 2020 2020 2020 2073  {'a'}).        s
+0000b850: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000b860: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000b870: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
+0000b880: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000b890: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
+0000b8a0: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
+0000b8b0: 6127 3a20 7b27 6127 3a20 5472 7565 7d7d  a': {'a': True}}
+0000b8c0: 2c0a 2020 2020 2020 2020 2020 2020 207b  ,.             {
+0000b8d0: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
+0000b8e0: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
+0000b8f0: 3a20 7b27 6127 3a20 4661 6c73 657d 7d5d  : {'a': False}}]
+0000b900: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000b910: 7365 745f 6c65 6164 6572 2873 656c 6629  set_leader(self)
+0000b920: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0000b930: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0000b940: 4861 726e 6573 7328 5265 636f 7264 696e  Harness(Recordin
+0000b950: 6743 6861 726d 290a 2020 2020 2020 2020  gCharm).        
+0000b960: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0000b970: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0000b980: 0a20 2020 2020 2020 2023 204e 6f20 6576  .        # No ev
+0000b990: 656e 7420 6861 7070 656e 7320 6865 7265  ent happens here
+0000b9a0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000b9b0: 2e73 6574 5f6c 6561 6465 7228 4661 6c73  .set_leader(Fals
+0000b9c0: 6529 0a20 2020 2020 2020 2068 6172 6e65  e).        harne
+0000b9d0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0000b9e0: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+0000b9f0: 6c73 6528 6861 726e 6573 732e 6368 6172  lse(harness.char
+0000ba00: 6d2e 6d6f 6465 6c2e 756e 6974 2e69 735f  m.model.unit.is_
+0000ba10: 6c65 6164 6572 2829 290a 2020 2020 2020  leader()).      
+0000ba20: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+0000ba30: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
+0000ba40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ba50: 7561 6c28 6861 726e 6573 732e 6368 6172  ual(harness.char
+0000ba60: 6d2e 6765 745f 6368 616e 6765 7328 7265  m.get_changes(re
+0000ba70: 7365 743d 5472 7565 292c 205b 7b27 6e61  set=True), [{'na
+0000ba80: 6d65 273a 2027 6c65 6164 6572 2d65 6c65  me': 'leader-ele
+0000ba90: 6374 6564 277d 5d29 0a20 2020 2020 2020  cted'}]).       
+0000baa0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000bab0: 2868 6172 6e65 7373 2e63 6861 726d 2e6d  (harness.charm.m
+0000bac0: 6f64 656c 2e75 6e69 742e 6973 5f6c 6561  odel.unit.is_lea
+0000bad0: 6465 7228 2929 0a20 2020 2020 2020 2068  der()).        h
+0000bae0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+0000baf0: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
+0000bb00: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
+0000bb10: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+0000bb20: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
+0000bb30: 6164 6572 2829 290a 2020 2020 2020 2020  ader()).        
+0000bb40: 2320 4e6f 2068 6f6f 6b20 6576 656e 7420  # No hook event 
+0000bb50: 7768 656e 2079 6f75 206c 6f73 6520 6c65  when you lose le
+0000bb60: 6164 6572 7368 6970 2e0a 2020 2020 2020  adership..      
+0000bb70: 2020 2320 544f 444f 3a20 7665 7269 6679    # TODO: verify
+0000bb80: 2069 6620 4a75 6a75 2061 6c77 6179 7320   if Juju always 
+0000bb90: 7472 6967 6765 7273 2060 6c65 6164 6572  triggers `leader
+0000bba0: 2d73 6574 7469 6e67 732d 6368 616e 6765  -settings-change
+0000bbb0: 6460 2069 6620 796f 750a 2020 2020 2020  d` if you.      
+0000bbc0: 2020 2320 2020 6c6f 7365 206c 6561 6465    #   lose leade
+0000bbd0: 7273 6869 702e 0a20 2020 2020 2020 2073  rship..        s
+0000bbe0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000bbf0: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+0000bc00: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
+0000bc10: 5472 7565 292c 205b 5d29 0a20 2020 2020  True), []).     
+0000bc20: 2020 2068 6172 6e65 7373 2e64 6973 6162     harness.disab
+0000bc30: 6c65 5f68 6f6f 6b73 2829 0a20 2020 2020  le_hooks().     
+0000bc40: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
+0000bc50: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
+0000bc60: 2020 2020 2320 4e6f 2068 6f6f 6b20 6576      # No hook ev
+0000bc70: 656e 7420 6966 2079 6f75 2068 6176 6520  ent if you have 
+0000bc80: 6469 7361 626c 6564 2074 6865 6d0a 2020  disabled them.  
+0000bc90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bca0: 7445 7175 616c 2868 6172 6e65 7373 2e63  tEqual(harness.c
+0000bcb0: 6861 726d 2e67 6574 5f63 6861 6e67 6573  harm.get_changes
+0000bcc0: 2872 6573 6574 3d54 7275 6529 2c20 5b5d  (reset=True), []
+0000bcd0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000bce0: 7265 6c61 7469 6f6e 5f73 6574 5f61 7070  relation_set_app
+0000bcf0: 5f6e 6f74 5f6c 6561 6465 7228 7365 6c66  _not_leader(self
+0000bd00: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000bd10: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000bd20: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
+0000bd30: 6e67 4368 6172 6d2c 206d 6574 613d 2727  ngCharm, meta=''
+0000bd40: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+0000bd50: 6d65 3a20 7465 7374 2d63 6861 726d 0a20  me: test-charm. 
+0000bd60: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+0000bd70: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+0000bd80: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+0000bd90: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0000bda0: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+0000bdb0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0000bdc0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000bdd0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000bde0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000bdf0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+0000be00: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000be10: 7365 745f 6c65 6164 6572 2846 616c 7365  set_leader(False
+0000be20: 290a 2020 2020 2020 2020 7265 6c5f 6964  ).        rel_id
+0000be30: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
+0000be40: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
+0000be50: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
+0000be60: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0000be70: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+0000be80: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+0000be90: 6c2f 3027 290a 2020 2020 2020 2020 7265  l/0').        re
+0000bea0: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
+0000beb0: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
+0000bec0: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
+0000bed0: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
+0000bee0: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+0000bef0: 666f 6f27 293a 0a20 2020 2020 2020 2020  foo'):.         
+0000bf00: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000bf10: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+0000bf20: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+0000bf30: 2020 2020 2020 2020 2020 2072 656c 2e64             rel.d
+0000bf40: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+0000bf50: 6d2e 6170 705d 5b27 666f 6f27 5d20 3d20  m.app]['foo'] = 
+0000bf60: 2762 6172 270a 2020 2020 2020 2020 2320  'bar'.        # 
+0000bf70: 5468 6520 6461 7461 2068 6173 206e 6f74  The data has not
+0000bf80: 2061 6374 7561 6c6c 7920 6265 656e 2063   actually been c
+0000bf90: 6861 6e67 6564 0a20 2020 2020 2020 2073  hanged.        s
+0000bfa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000bfb0: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+0000bfc0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+0000bfd0: 2c20 2774 6573 742d 6368 6172 6d27 292c  , 'test-charm'),
+0000bfe0: 207b 7d29 0a20 2020 2020 2020 2068 6172   {}).        har
+0000bff0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+0000c000: 5472 7565 290a 2020 2020 2020 2020 7265  True).        re
+0000c010: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+0000c020: 6861 726d 2e61 7070 5d5b 2766 6f6f 275d  harm.app]['foo']
+0000c030: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+0000c040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c050: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+0000c060: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+0000c070: 6964 2c20 2774 6573 742d 6368 6172 6d27  id, 'test-charm'
+0000c080: 292c 207b 2766 6f6f 273a 2027 6261 7227  ), {'foo': 'bar'
+0000c090: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+0000c0a0: 5f68 6f6f 6b73 5f65 6e61 626c 6564 5f61  _hooks_enabled_a
+0000c0b0: 6e64 5f64 6973 6162 6c65 6428 7365 6c66  nd_disabled(self
+0000c0c0: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000c0d0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000c0e0: 2e48 6172 6e65 7373 280a 2020 2020 2020  .Harness(.      
+0000c0f0: 2020 2020 2020 5265 636f 7264 696e 6743        RecordingC
+0000c100: 6861 726d 2c0a 2020 2020 2020 2020 2020  harm,.          
+0000c110: 2020 6d65 7461 3d27 2727 0a20 2020 2020    meta='''.     
+0000c120: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000c130: 616d 653a 2074 6573 742d 6368 6172 6d0a  ame: test-charm.
+0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c150: 2727 272c 0a20 2020 2020 2020 2020 2020  ''',.           
+0000c160: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
+0000c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c180: 6f70 7469 6f6e 733a 0a20 2020 2020 2020  options:.       
 0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1a0: 2727 272c 0a20 2020 2020 2020 2020 2020  ''',.           
-0000c1b0: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
-0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1d0: 6f70 7469 6f6e 733a 0a20 2020 2020 2020  options:.       
-0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1f0: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
-0000c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c210: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-0000c220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c230: 2020 2020 2020 2020 2074 6869 7264 3a0a           third:.
-0000c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c250: 2020 2020 2020 2020 2020 2020 7479 7065              type
-0000c260: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
-0000c270: 2020 2020 2020 2020 2020 2020 2027 2727               '''
-0000c280: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c290: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0000c2a0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-0000c2b0: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
-0000c2c0: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
-0000c2d0: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
-0000c2e0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000c2f0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
-0000c300: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
-0000c310: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
-0000c320: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
-0000c330: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
-0000c340: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
-0000c350: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
-0000c360: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0000c370: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000c380: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
-0000c390: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
-0000c3a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000c3b0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-0000c3c0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-0000c3d0: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-0000c3e0: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
-0000c3f0: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
-0000c400: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
-0000c410: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
-0000c420: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
-0000c430: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
-0000c440: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
-0000c450: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
-0000c460: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
-0000c470: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
-0000c480: 2020 2020 2020 2068 6172 6e65 7373 2e64         harness.d
-0000c490: 6973 6162 6c65 5f68 6f6f 6b73 2829 0a20  isable_hooks(). 
-0000c4a0: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
-0000c4b0: 7064 6174 655f 636f 6e66 6967 287b 2774  pdate_config({'t
-0000c4c0: 6869 7264 273a 2027 3327 7d29 0a20 2020  hird': '3'}).   
-0000c4d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000c4e0: 4571 7561 6c28 6861 726e 6573 732e 6368  Equal(harness.ch
-0000c4f0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
-0000c500: 7265 7365 743d 5472 7565 292c 205b 5d29  reset=True), [])
-0000c510: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000c520: 2e65 6e61 626c 655f 686f 6f6b 7328 290a  .enable_hooks().
-0000c530: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000c540: 7570 6461 7465 5f63 6f6e 6669 6728 7b27  update_config({'
-0000c550: 7661 6c75 6527 3a20 2766 6f75 7274 6827  value': 'fourth'
-0000c560: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-0000c570: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-0000c580: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-0000c590: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
-0000c5a0: 6573 2872 6573 6574 3d54 7275 6529 2c0a  es(reset=True),.
-0000c5b0: 2020 2020 2020 2020 2020 2020 5b7b 276e              [{'n
-0000c5c0: 616d 6527 3a20 2763 6f6e 6669 672d 6368  ame': 'config-ch
-0000c5d0: 616e 6765 6427 2c20 2764 6174 6127 3a20  anged', 'data': 
-0000c5e0: 7b27 7661 6c75 6527 3a20 2766 6f75 7274  {'value': 'fourt
-0000c5f0: 6827 2c20 2774 6869 7264 273a 2027 3327  h', 'third': '3'
-0000c600: 7d7d 5d29 0a0a 2020 2020 6465 6620 7465  }}])..    def te
-0000c610: 7374 5f68 6f6f 6b73 5f64 6973 6162 6c65  st_hooks_disable
-0000c620: 645f 636f 6e74 6578 746d 616e 6167 6572  d_contextmanager
-0000c630: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000c640: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0000c650: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
-0000c660: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
-0000c670: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-0000c680: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000c690: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
-0000c6a0: 2020 2020 2020 2020 2727 272c 2063 6f6e          ''', con
-0000c6b0: 6669 673d 2727 270a 2020 2020 2020 2020  fig='''.        
-0000c6c0: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
-0000c6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c6e0: 2020 2020 2076 616c 7565 3a0a 2020 2020       value:.    
-0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c700: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-0000c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c720: 2020 2020 2074 6869 7264 3a0a 2020 2020       third:.    
-0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c740: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-0000c750: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0000c760: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c770: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0000c780: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-0000c790: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
-0000c7a0: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
-0000c7b0: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
-0000c7c0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000c7d0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
-0000c7e0: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
-0000c7f0: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
-0000c800: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
-0000c810: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
-0000c820: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
-0000c830: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
-0000c840: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0000c850: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000c860: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
-0000c870: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
-0000c880: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000c890: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-0000c8a0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-0000c8b0: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-0000c8c0: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
-0000c8d0: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
-0000c8e0: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
-0000c8f0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
-0000c900: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
-0000c910: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
-0000c920: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
-0000c930: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
-0000c940: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
-0000c950: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
-0000c960: 2020 2020 2020 2077 6974 6820 6861 726e         with harn
-0000c970: 6573 732e 686f 6f6b 735f 6469 7361 626c  ess.hooks_disabl
-0000c980: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
-0000c990: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-0000c9a0: 5f63 6f6e 6669 6728 7b27 7468 6972 6427  _config({'third'
-0000c9b0: 3a20 2733 277d 290a 2020 2020 2020 2020  : '3'}).        
-0000c9c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c9d0: 2868 6172 6e65 7373 2e63 6861 726d 2e67  (harness.charm.g
-0000c9e0: 6574 5f63 6861 6e67 6573 2872 6573 6574  et_changes(reset
-0000c9f0: 3d54 7275 6529 2c20 5b5d 290a 2020 2020  =True), []).    
-0000ca00: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000ca10: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
-0000ca20: 6527 3a20 2766 6f75 7274 6827 7d29 0a20  e': 'fourth'}). 
-0000ca30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ca40: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-0000ca50: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-0000ca60: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-0000ca70: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
-0000ca80: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
-0000ca90: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
-0000caa0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
-0000cab0: 6c75 6527 3a20 2766 6f75 7274 6827 2c20  lue': 'fourth', 
-0000cac0: 2774 6869 7264 273a 2027 3327 7d7d 5d29  'third': '3'}}])
-0000cad0: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
-0000cae0: 6f6f 6b73 5f64 6973 6162 6c65 645f 6e65  ooks_disabled_ne
-0000caf0: 7374 6564 5f63 6f6e 7465 7874 6d61 6e61  sted_contextmana
-0000cb00: 6765 7228 7365 6c66 293a 0a20 2020 2020  ger(self):.     
-0000cb10: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-0000cb20: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0000cb30: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
-0000cb40: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0000cb50: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-0000cb60: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
-0000cb70: 2020 2020 2020 2027 2727 2c20 636f 6e66         ''', conf
-0000cb80: 6967 3d27 2727 0a20 2020 2020 2020 2020  ig='''.         
-0000cb90: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
-0000cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbb0: 2020 2020 6669 6674 683a 0a20 2020 2020      fifth:.     
-0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbd0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
-0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbf0: 2020 2020 7369 7874 683a 0a20 2020 2020      sixth:.     
-0000cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc10: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
-0000cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc30: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000cc40: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000cc50: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-0000cc60: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-0000cc70: 6769 6e28 290a 2020 2020 2020 2020 2320  gin().        # 
-0000cc80: 436f 6e74 6578 7420 6d61 6e61 6765 7220  Context manager 
-0000cc90: 6361 6e20 6265 206e 6573 7465 642c 2073  can be nested, s
-0000cca0: 6f20 6120 7465 7374 2075 7369 6e67 2069  o a test using i
-0000ccb0: 7420 6361 6e20 696e 766f 6b65 2061 2068  t can invoke a h
-0000ccc0: 656c 7065 7220 7573 696e 6720 6974 2e0a  elper using it..
-0000ccd0: 2020 2020 2020 2020 7769 7468 2068 6172          with har
-0000cce0: 6e65 7373 2e68 6f6f 6b73 5f64 6973 6162  ness.hooks_disab
-0000ccf0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-0000cd00: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
-0000cd10: 686f 6f6b 735f 6469 7361 626c 6564 2829  hooks_disabled()
-0000cd20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cd30: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-0000cd40: 5f63 6f6e 6669 6728 7b27 6669 6674 6827  _config({'fifth'
-0000cd50: 3a20 2735 277d 290a 2020 2020 2020 2020  : '5'}).        
-0000cd60: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-0000cd70: 7465 5f63 6f6e 6669 6728 7b27 7369 7874  te_config({'sixt
-0000cd80: 6827 3a20 2736 277d 290a 2020 2020 2020  h': '6'}).      
-0000cd90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000cda0: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
-0000cdb0: 2e67 6574 5f63 6861 6e67 6573 2872 6573  .get_changes(res
-0000cdc0: 6574 3d54 7275 6529 2c20 5b5d 290a 0a20  et=True), []).. 
-0000cdd0: 2020 2064 6566 2074 6573 745f 686f 6f6b     def test_hook
-0000cde0: 735f 6469 7361 626c 6564 5f6e 6f6f 7028  s_disabled_noop(
-0000cdf0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0000ce00: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-0000ce10: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
-0000ce20: 6f72 6469 6e67 4368 6172 6d2c 206d 6574  ordingCharm, met
-0000ce30: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000ce40: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0000ce50: 2d63 6861 726d 0a20 2020 2020 2020 2020  -charm.         
-0000ce60: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
-0000ce70: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
-0000ce80: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-0000ce90: 2020 2020 2020 2020 7365 7665 6e74 683a          seventh:
-0000cea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ceb0: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
-0000cec0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0000ced0: 2020 6569 6768 7468 3a0a 2020 2020 2020    eighth:.      
-0000cee0: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-0000cef0: 7065 3a20 7374 7269 6e67 0a20 2020 2020  pe: string.     
-0000cf00: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0000cf10: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0000cf20: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0000cf30: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
-0000cf40: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-0000cf50: 2020 2020 2023 2049 6620 686f 6f6b 7320       # If hooks 
-0000cf60: 6172 6520 616c 7265 6164 7920 6469 7361  are already disa
-0000cf70: 626c 6564 2c20 6974 2069 7320 6120 6e6f  bled, it is a no
-0000cf80: 206f 702c 2061 6e64 206f 6e20 6578 6974   op, and on exit
-0000cf90: 2068 6f6f 6b73 2072 656d 6169 6e20 6469   hooks remain di
-0000cfa0: 7361 626c 6564 2e0a 2020 2020 2020 2020  sabled..        
-0000cfb0: 6861 726e 6573 732e 6469 7361 626c 655f  harness.disable_
-0000cfc0: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
-0000cfd0: 7769 7468 2068 6172 6e65 7373 2e68 6f6f  with harness.hoo
-0000cfe0: 6b73 5f64 6973 6162 6c65 6428 293a 0a20  ks_disabled():. 
-0000cff0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-0000d000: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
-0000d010: 287b 2773 6576 656e 7468 273a 2027 3727  ({'seventh': '7'
-0000d020: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-0000d030: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
-0000d040: 287b 2765 6967 6874 6827 3a20 2738 277d  ({'eighth': '8'}
-0000d050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000d060: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-0000d070: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
-0000d080: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
-0000d090: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
-0000d0a0: 6573 745f 6d65 7461 6461 7461 5f66 726f  est_metadata_fro
-0000d0b0: 6d5f 6469 7265 6374 6f72 7928 7365 6c66  m_directory(self
-0000d0c0: 293a 0a20 2020 2020 2020 2074 6d70 203d  ):.        tmp =
-0000d0d0: 2070 6174 686c 6962 2e50 6174 6828 7465   pathlib.Path(te
-0000d0e0: 6d70 6669 6c65 2e6d 6b64 7465 6d70 2829  mpfile.mkdtemp()
-0000d0f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000d100: 6464 436c 6561 6e75 7028 7368 7574 696c  ddCleanup(shutil
-0000d110: 2e72 6d74 7265 652c 2073 7472 2874 6d70  .rmtree, str(tmp
-0000d120: 2929 0a20 2020 2020 2020 206d 6574 6164  )).        metad
-0000d130: 6174 615f 6669 6c65 6e61 6d65 203d 2074  ata_filename = t
-0000d140: 6d70 202f 2027 6d65 7461 6461 7461 2e79  mp / 'metadata.y
-0000d150: 616d 6c27 0a20 2020 2020 2020 2077 6974  aml'.        wit
-0000d160: 6820 6d65 7461 6461 7461 5f66 696c 656e  h metadata_filen
-0000d170: 616d 652e 6f70 656e 2827 7774 2729 2061  ame.open('wt') a
-0000d180: 7320 6d65 7461 6461 7461 3a0a 2020 2020  s metadata:.    
-0000d190: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-0000d1a0: 2e77 7269 7465 2874 6578 7477 7261 702e  .write(textwrap.
-0000d1b0: 6465 6465 6e74 2827 2727 0a20 2020 2020  dedent('''.     
-0000d1c0: 2020 2020 2020 206e 616d 653a 206d 792d         name: my-
-0000d1d0: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
-0000d1e0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-0000d1f0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d210: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-0000d220: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-0000d230: 2027 2727 2929 0a20 2020 2020 2020 2068   ''')).        h
-0000d240: 6172 6e65 7373 203d 2073 656c 662e 5f67  arness = self._g
-0000d250: 6574 5f64 756d 6d79 5f63 6861 726d 5f68  et_dummy_charm_h
-0000d260: 6172 6e65 7373 2874 6d70 290a 2020 2020  arness(tmp).    
-0000d270: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-0000d280: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
-0000d290: 2e61 7373 6572 7445 7175 616c 286c 6973  .assertEqual(lis
-0000d2a0: 7428 6861 726e 6573 732e 6d6f 6465 6c2e  t(harness.model.
-0000d2b0: 7265 6c61 7469 6f6e 7329 2c20 5b27 6462  relations), ['db
-0000d2c0: 275d 290a 2020 2020 2020 2020 2320 5468  ']).        # Th
-0000d2d0: 6520 6368 6172 6d5f 6469 7220 616c 736f  e charm_dir also
-0000d2e0: 2067 6574 7320 7365 740a 2020 2020 2020   gets set.      
-0000d2f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000d300: 616c 2868 6172 6e65 7373 2e66 7261 6d65  al(harness.frame
-0000d310: 776f 726b 2e63 6861 726d 5f64 6972 2c20  work.charm_dir, 
-0000d320: 746d 7029 0a0a 2020 2020 6465 6620 7465  tmp)..    def te
-0000d330: 7374 5f63 6f6e 6669 675f 6672 6f6d 5f64  st_config_from_d
-0000d340: 6972 6563 746f 7279 2873 656c 6629 3a0a  irectory(self):.
-0000d350: 2020 2020 2020 2020 746d 7020 3d20 7061          tmp = pa
-0000d360: 7468 6c69 622e 5061 7468 2874 656d 7066  thlib.Path(tempf
-0000d370: 696c 652e 6d6b 6474 656d 7028 2929 0a20  ile.mkdtemp()). 
-0000d380: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0000d390: 6c65 616e 7570 2873 6875 7469 6c2e 726d  leanup(shutil.rm
-0000d3a0: 7472 6565 2c20 7374 7228 746d 7029 290a  tree, str(tmp)).
-0000d3b0: 2020 2020 2020 2020 636f 6e66 6967 5f66          config_f
-0000d3c0: 696c 656e 616d 6520 3d20 746d 7020 2f20  ilename = tmp / 
-0000d3d0: 2763 6f6e 6669 672e 7961 6d6c 270a 2020  'config.yaml'.  
-0000d3e0: 2020 2020 2020 7769 7468 2063 6f6e 6669        with confi
-0000d3f0: 675f 6669 6c65 6e61 6d65 2e6f 7065 6e28  g_filename.open(
-0000d400: 2777 7427 2920 6173 2063 6f6e 6669 673a  'wt') as config:
-0000d410: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000d420: 6669 672e 7772 6974 6528 7465 7874 7772  fig.write(textwr
-0000d430: 6170 2e64 6564 656e 7428 2727 270a 2020  ap.dedent('''.  
-0000d440: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
-0000d450: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000d460: 2020 206f 7074 5f73 7472 3a0a 2020 2020     opt_str:.    
-0000d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d480: 7479 7065 3a20 7374 7269 6e67 0a20 2020  type: string.   
-0000d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4a0: 2064 6566 6175 6c74 3a20 2276 616c 220a   default: "val".
-0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4c0: 6f70 745f 7374 725f 656d 7074 793a 0a20  opt_str_empty:. 
-0000d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4e0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
-0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d500: 2020 2020 6465 6661 756c 743a 2022 220a      default: "".
-0000d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d520: 6f70 745f 6e75 6c6c 3a0a 2020 2020 2020  opt_null:.      
-0000d530: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-0000d540: 7065 3a20 7374 7269 6e67 0a20 2020 2020  pe: string.     
-0000d550: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000d560: 6566 6175 6c74 3a20 6e75 6c6c 0a20 2020  efault: null.   
-0000d570: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-0000d580: 5f62 6f6f 6c3a 0a20 2020 2020 2020 2020  _bool:.         
-0000d590: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-0000d5a0: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
-0000d5b0: 2020 2020 2020 2020 2020 2020 2064 6566               def
-0000d5c0: 6175 6c74 3a20 7472 7565 0a20 2020 2020  ault: true.     
-0000d5d0: 2020 2020 2020 2020 2020 206f 7074 5f69             opt_i
-0000d5e0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-0000d5f0: 2020 2020 2020 2020 7479 7065 3a20 696e          type: in
-0000d600: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0000d610: 2020 2020 2020 6465 6661 756c 743a 2031        default: 1
-0000d620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d630: 206f 7074 5f66 6c6f 6174 3a0a 2020 2020   opt_float:.    
-0000d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d650: 7479 7065 3a20 666c 6f61 740a 2020 2020  type: float.    
-0000d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d670: 6465 6661 756c 743a 2031 2e30 0a20 2020  default: 1.0.   
-0000d680: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-0000d690: 5f6e 6f5f 6465 6661 756c 743a 0a20 2020  _no_default:.   
-0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6b0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
-0000d6c0: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
-0000d6d0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0000d6e0: 3d20 7365 6c66 2e5f 6765 745f 6475 6d6d  = self._get_dumm
-0000d6f0: 795f 6368 6172 6d5f 6861 726e 6573 7328  y_charm_harness(
-0000d700: 746d 7029 0a20 2020 2020 2020 2073 656c  tmp).        sel
-0000d710: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-0000d720: 726e 6573 732e 6d6f 6465 6c2e 636f 6e66  rness.model.conf
-0000d730: 6967 5b27 6f70 745f 7374 7227 5d2c 2027  ig['opt_str'], '
-0000d740: 7661 6c27 290a 2020 2020 2020 2020 7365  val').        se
-0000d750: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
-0000d760: 6172 6e65 7373 2e6d 6f64 656c 2e63 6f6e  arness.model.con
-0000d770: 6669 675b 276f 7074 5f73 7472 5f65 6d70  fig['opt_str_emp
-0000d780: 7479 275d 2c20 2727 290a 2020 2020 2020  ty'], '').      
-0000d790: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
-0000d7a0: 6861 726e 6573 732e 6d6f 6465 6c2e 636f  harness.model.co
-0000d7b0: 6e66 6967 5b27 6f70 745f 626f 6f6c 275d  nfig['opt_bool']
-0000d7c0: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
-0000d7d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000d7e0: 2868 6172 6e65 7373 2e6d 6f64 656c 2e63  (harness.model.c
-0000d7f0: 6f6e 6669 675b 276f 7074 5f69 6e74 275d  onfig['opt_int']
-0000d800: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
-0000d810: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0000d820: 6365 2868 6172 6e65 7373 2e6d 6f64 656c  ce(harness.model
-0000d830: 2e63 6f6e 6669 675b 276f 7074 5f69 6e74  .config['opt_int
-0000d840: 275d 2c20 696e 7429 0a20 2020 2020 2020  '], int).       
-0000d850: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d860: 6c28 6861 726e 6573 732e 6d6f 6465 6c2e  l(harness.model.
-0000d870: 636f 6e66 6967 5b27 6f70 745f 666c 6f61  config['opt_floa
-0000d880: 7427 5d2c 2031 2e30 290a 2020 2020 2020  t'], 1.0).      
-0000d890: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0000d8a0: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-0000d8b0: 6d6f 6465 6c2e 636f 6e66 6967 5b27 6f70  model.config['op
-0000d8c0: 745f 666c 6f61 7427 5d2c 2066 6c6f 6174  t_float'], float
-0000d8d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000d8e0: 7373 6572 7446 616c 7365 2827 6f70 745f  ssertFalse('opt_
-0000d8f0: 6e75 6c6c 2720 696e 2068 6172 6e65 7373  null' in harness
-0000d900: 2e6d 6f64 656c 2e63 6f6e 6669 6729 0a20  .model.config). 
-0000d910: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d920: 7274 4973 4e6f 6e65 2868 6172 6e65 7373  rtIsNone(harness
-0000d930: 2e5f 6261 636b 656e 642e 5f63 6f6e 6669  ._backend._confi
-0000d940: 672e 5f64 6566 6175 6c74 735b 276f 7074  g._defaults['opt
-0000d950: 5f6e 756c 6c27 5d29 0a20 2020 2020 2020  _null']).       
-0000d960: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0000d970: 6e65 2868 6172 6e65 7373 2e5f 6261 636b  ne(harness._back
-0000d980: 656e 642e 5f63 6f6e 6669 672e 5f64 6566  end._config._def
-0000d990: 6175 6c74 735b 276f 7074 5f6e 6f5f 6465  aults['opt_no_de
-0000d9a0: 6661 756c 7427 5d29 0a0a 2020 2020 6465  fault'])..    de
-0000d9b0: 6620 7465 7374 5f73 6574 5f6d 6f64 656c  f test_set_model
-0000d9c0: 5f6e 616d 6528 7365 6c66 293a 0a20 2020  _name(self):.   
-0000d9d0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-0000d9e0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-0000d9f0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
-0000da00: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000da10: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000da20: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
-0000da30: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000da40: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000da50: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-0000da60: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-0000da70: 745f 6d6f 6465 6c5f 6e61 6d65 2827 666f  t_model_name('fo
-0000da80: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
-0000da90: 2e61 7373 6572 7445 7175 616c 2827 666f  .assertEqual('fo
-0000daa0: 6f27 2c20 6861 726e 6573 732e 6d6f 6465  o', harness.mode
-0000dab0: 6c2e 6e61 6d65 290a 0a20 2020 2064 6566  l.name)..    def
-0000dac0: 2074 6573 745f 7365 745f 6d6f 6465 6c5f   test_set_model_
-0000dad0: 6e61 6d65 5f61 6674 6572 5f62 6567 696e  name_after_begin
-0000dae0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000daf0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0000db00: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0000db10: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0000db20: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000db30: 2020 6e61 6d65 3a20 7465 7374 2d63 6861    name: test-cha
-0000db40: 726d 0a20 2020 2020 2020 2027 2727 290a  rm.        ''').
-0000db50: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-0000db60: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-0000db70: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-0000db80: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
-0000db90: 656c 5f6e 616d 6528 2762 6172 2729 0a20  el_name('bar'). 
-0000dba0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-0000dbb0: 6567 696e 2829 0a20 2020 2020 2020 2077  egin().        w
-0000dbc0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000dbd0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-0000dbe0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000dbf0: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
-0000dc00: 656c 5f6e 616d 6528 2766 6f6f 2729 0a20  el_name('foo'). 
-0000dc10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000dc20: 7274 4571 7561 6c28 6861 726e 6573 732e  rtEqual(harness.
-0000dc30: 6d6f 6465 6c2e 6e61 6d65 2c20 2762 6172  model.name, 'bar
-0000dc40: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-0000dc50: 5f73 6574 5f6d 6f64 656c 5f75 7569 645f  _set_model_uuid_
-0000dc60: 6166 7465 725f 6265 6769 6e28 7365 6c66  after_begin(self
-0000dc70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0000dc80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0000dc90: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-0000dca0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-0000dcb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0000dcc0: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
-0000dcd0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000dce0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000dcf0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0000dd00: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-0000dd10: 6573 732e 7365 745f 6d6f 6465 6c5f 6e61  ess.set_model_na
-0000dd20: 6d65 2827 6261 7227 290a 2020 2020 2020  me('bar').      
-0000dd30: 2020 6861 726e 6573 732e 7365 745f 6d6f    harness.set_mo
-0000dd40: 6465 6c5f 7575 6964 2827 3936 3935 3765  del_uuid('96957e
-0000dd50: 3930 2d65 3030 362d 3131 6562 2d62 6138  90-e006-11eb-ba8
-0000dd60: 302d 3032 3432 6163 3133 3030 3034 2729  0-0242ac130004')
-0000dd70: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000dd80: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000dd90: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000dda0: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-0000ddb0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000ddc0: 2020 2068 6172 6e65 7373 2e73 6574 5f6d     harness.set_m
-0000ddd0: 6f64 656c 5f75 7569 6428 2761 6630 3437  odel_uuid('af047
-0000dde0: 3965 612d 6530 3036 2d31 3165 622d 6261  9ea-e006-11eb-ba
-0000ddf0: 3830 2d30 3234 3261 6331 3330 3030 3427  80-0242ac130004'
-0000de00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000de10: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-0000de20: 7373 2e6d 6f64 656c 2e75 7569 642c 2027  ss.model.uuid, '
-0000de30: 3936 3935 3765 3930 2d65 3030 362d 3131  96957e90-e006-11
-0000de40: 6562 2d62 6138 302d 3032 3432 6163 3133  eb-ba80-0242ac13
-0000de50: 3030 3034 2729 0a0a 2020 2020 6465 6620  0004')..    def 
-0000de60: 7465 7374 5f73 6574 5f6d 6f64 656c 5f69  test_set_model_i
-0000de70: 6e66 6f5f 6166 7465 725f 6265 6769 6e28  nfo_after_begin(
-0000de80: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0000de90: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-0000dea0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
-0000deb0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
-0000dec0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-0000ded0: 206e 616d 653a 2074 6573 742d 6368 6172   name: test-char
-0000dee0: 6d0a 2020 2020 2020 2020 2727 2729 0a20  m.        '''). 
-0000def0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0000df00: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0000df10: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0000df20: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
-0000df30: 6c5f 696e 666f 2827 666f 6f27 2c20 2739  l_info('foo', '9
-0000df40: 3639 3537 6539 302d 6530 3036 2d31 3165  6957e90-e006-11e
-0000df50: 622d 6261 3830 2d30 3234 3261 6331 3330  b-ba80-0242ac130
-0000df60: 3030 3427 290a 2020 2020 2020 2020 6861  004').        ha
-0000df70: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-0000df80: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000df90: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0000dfa0: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0000dfb0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000dfc0: 7365 745f 6d6f 6465 6c5f 696e 666f 2827  set_model_info('
-0000dfd0: 6261 7227 2c20 2761 6630 3437 3965 612d  bar', 'af0479ea-
-0000dfe0: 6530 3036 2d31 3165 622d 6261 3830 2d30  e006-11eb-ba80-0
-0000dff0: 3234 3261 6331 3330 3030 3427 290a 2020  242ac130004').  
-0000e000: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000e010: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0000e020: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0000e030: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000e040: 7365 745f 6d6f 6465 6c5f 696e 666f 2827  set_model_info('
-0000e050: 6261 7227 290a 2020 2020 2020 2020 7769  bar').        wi
-0000e060: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000e070: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
-0000e080: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000e090: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
-0000e0a0: 6c5f 696e 666f 2875 7569 643d 2761 6630  l_info(uuid='af0
-0000e0b0: 3437 3965 612d 6530 3036 2d31 3165 622d  479ea-e006-11eb-
-0000e0c0: 6261 3830 2d30 3234 3261 6331 3330 3030  ba80-0242ac13000
-0000e0d0: 3427 290a 2020 2020 2020 2020 7769 7468  4').        with
-0000e0e0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000e0f0: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000e100: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
-0000e110: 726e 6573 732e 7365 745f 6d6f 6465 6c5f  rness.set_model_
-0000e120: 6e61 6d65 2827 6261 7227 290a 2020 2020  name('bar').    
-0000e130: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000e140: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000e150: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0000e160: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-0000e170: 745f 6d6f 6465 6c5f 7575 6964 2827 6166  t_model_uuid('af
-0000e180: 3034 3739 6561 2d65 3030 362d 3131 6562  0479ea-e006-11eb
-0000e190: 2d62 6138 302d 3032 3432 6163 3133 3030  -ba80-0242ac1300
-0000e1a0: 3034 2729 0a20 2020 2020 2020 2073 656c  04').        sel
-0000e1b0: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-0000e1c0: 726e 6573 732e 6d6f 6465 6c2e 6e61 6d65  rness.model.name
-0000e1d0: 2c20 2766 6f6f 2729 0a20 2020 2020 2020  , 'foo').       
-0000e1e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000e1f0: 6c28 6861 726e 6573 732e 6d6f 6465 6c2e  l(harness.model.
-0000e200: 7575 6964 2c20 2739 3639 3537 6539 302d  uuid, '96957e90-
-0000e210: 6530 3036 2d31 3165 622d 6261 3830 2d30  e006-11eb-ba80-0
-0000e220: 3234 3261 6331 3330 3030 3427 290a 0a20  242ac130004').. 
-0000e230: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-0000e240: 7374 6f72 6167 655f 6265 666f 7265 5f68  storage_before_h
-0000e250: 6172 6e65 7373 5f62 6567 696e 2873 656c  arness_begin(sel
-0000e260: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0000e270: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-0000e280: 672e 4861 726e 6573 7328 5374 6f72 6167  g.Harness(Storag
-0000e290: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
-0000e2a0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0000e2b0: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-0000e2c0: 2020 2020 2020 2020 2072 6571 7569 7265           require
-0000e2d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000e2e0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-0000e2f0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-0000e300: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
-0000e310: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
-0000e320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e330: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
-0000e340: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-0000e350: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
-0000e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e370: 6d75 6c74 6970 6c65 3a0a 2020 2020 2020  multiple:.      
-0000e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e390: 2020 7261 6e67 653a 2031 2d33 0a20 2020    range: 1-3.   
-0000e3a0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-0000e3b0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0000e3c0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0000e3d0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
-0000e3e0: 7374 6f72 5f69 6473 203d 2068 6172 6e65  stor_ids = harne
-0000e3f0: 7373 2e61 6464 5f73 746f 7261 6765 2822  ss.add_storage("
-0000e400: 7465 7374 222c 2063 6f75 6e74 3d33 290a  test", count=3).
-0000e410: 2020 2020 2020 2020 666f 7220 7320 696e          for s in
-0000e420: 2073 746f 725f 6964 733a 0a20 2020 2020   stor_ids:.     
-0000e430: 2020 2020 2020 2023 2062 6566 6f72 6520         # before 
-0000e440: 6265 6769 6e2c 2061 6464 696e 6720 7374  begin, adding st
-0000e450: 6f72 6167 6520 646f 6573 206e 6f74 2061  orage does not a
-0000e460: 7474 6163 6820 6974 2e0a 2020 2020 2020  ttach it..      
-0000e470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e480: 744e 6f74 496e 2873 2c20 6861 726e 6573  tNotIn(s, harnes
-0000e490: 732e 5f62 6163 6b65 6e64 2e73 746f 7261  s._backend.stora
-0000e4a0: 6765 5f6c 6973 7428 2274 6573 7422 2929  ge_list("test"))
-0000e4b0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-0000e4c0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0000e4d0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
-0000e4e0: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
-0000e4f0: 726e 6573 732e 5f62 6163 6b65 6e64 2e73  rness._backend.s
-0000e500: 746f 7261 6765 5f67 6574 2822 7465 7374  torage_get("test
-0000e510: 2f30 222c 2022 6c6f 6361 7469 6f6e 2229  /0", "location")
-0000e520: 5b2d 363a 5d0a 0a20 2020 2064 6566 2074  [-6:]..    def t
-0000e530: 6573 745f 6164 645f 7374 6f72 6167 655f  est_add_storage_
-0000e540: 7468 656e 5f68 6172 6e65 7373 5f62 6567  then_harness_beg
-0000e550: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
-0000e560: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0000e570: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0000e580: 5374 6f72 6167 6554 6573 7465 722c 206d  StorageTester, m
-0000e590: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-0000e5a0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-0000e5b0: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
-0000e5c0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
-0000e5d0: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
-0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5f0: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-0000e600: 6c0a 2020 2020 2020 2020 2020 2020 7374  l.            st
-0000e610: 6f72 6167 653a 0a20 2020 2020 2020 2020  orage:.         
-0000e620: 2020 2020 2020 2074 6573 743a 0a20 2020         test:.   
-0000e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e640: 2074 7970 653a 2066 696c 6573 7973 7465   type: filesyste
-0000e650: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-0000e660: 2020 2020 2020 6d75 6c74 6970 6c65 3a0a        multiple:.
-0000e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e680: 2020 2020 2020 2020 7261 6e67 653a 2031          range: 1
-0000e690: 2d33 0a20 2020 2020 2020 2020 2020 2027  -3.            '
-0000e6a0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-0000e6b0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0000e6c0: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
-0000e6d0: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
-0000e6e0: 645f 7374 6f72 6167 6528 2274 6573 7422  d_storage("test"
-0000e6f0: 2c20 636f 756e 743d 3329 0a0a 2020 2020  , count=3)..    
-0000e700: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000e710: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
-0000e720: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-0000e730: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000e740: 5f62 6163 6b65 6e64 2e73 746f 7261 6765  _backend.storage
-0000e750: 5f67 6574 2822 7465 7374 2f30 222c 2022  _get("test/0", "
-0000e760: 6c6f 6361 7469 6f6e 2229 5b2d 363a 5d0a  location")[-6:].
-0000e770: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000e780: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
-0000e790: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
-0000e7a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000e7b0: 7175 616c 286c 656e 2868 6172 6e65 7373  qual(len(harness
-0000e7c0: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
-0000e7d0: 6576 656e 7473 292c 2033 290a 2020 2020  events), 3).    
-0000e7e0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000e7f0: 6765 2833 293a 0a20 2020 2020 2020 2020  ge(3):.         
-0000e800: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000e810: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
-0000e820: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-0000e830: 7276 6564 5f65 7665 6e74 735b 695d 2c20  rved_events[i], 
-0000e840: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
-0000e850: 6865 6445 7665 6e74 2929 0a0a 2020 2020  hedEvent))..    
-0000e860: 2020 2020 7761 6e74 203d 2073 7472 2870      want = str(p
-0000e870: 6174 686c 6962 2e50 7572 6550 6174 6828  athlib.PurePath(
-0000e880: 2774 6573 7427 2c20 2730 2729 290a 2020  'test', '0')).  
-0000e890: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e8a0: 7445 7175 616c 2877 616e 742c 2068 6172  tEqual(want, har
-0000e8b0: 6e65 7373 2e5f 6261 636b 656e 642e 7374  ness._backend.st
-0000e8c0: 6f72 6167 655f 6765 7428 2274 6573 742f  orage_get("test/
-0000e8d0: 3022 2c20 226c 6f63 6174 696f 6e22 295b  0", "location")[
-0000e8e0: 2d36 3a5d 290a 0a20 2020 2064 6566 2074  -6:])..    def t
-0000e8f0: 6573 745f 6164 645f 7374 6f72 6167 655f  est_add_storage_
-0000e900: 6e6f 745f 6174 7461 6368 6564 5f64 6566  not_attached_def
-0000e910: 6175 6c74 2873 656c 6629 3a0a 2020 2020  ault(self):.    
-0000e920: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0000e930: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0000e940: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0000e950: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0000e960: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0000e970: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-0000e980: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-0000e990: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9b0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-0000e9c0: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-0000e9d0: 7374 6f72 6167 653a 0a20 2020 2020 2020  storage:.       
-0000e9e0: 2020 2020 2020 2020 2074 6573 743a 0a20           test:. 
-0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea00: 2020 2074 7970 653a 2066 696c 6573 7973     type: filesys
-0000ea10: 7465 6d0a 2020 2020 2020 2020 2020 2020  tem.            
-0000ea20: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000ea30: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000ea40: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
-0000ea50: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
-0000ea60: 6464 5f73 746f 7261 6765 2827 7465 7374  dd_storage('test
-0000ea70: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-0000ea80: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-0000ea90: 2020 2061 7373 6572 7420 6c65 6e28 6861     assert len(ha
-0000eaa0: 726e 6573 732e 6d6f 6465 6c2e 7374 6f72  rness.model.stor
-0000eab0: 6167 6573 5b27 7465 7374 275d 2920 3d3d  ages['test']) ==
-0000eac0: 2030 2c20 5c0a 2020 2020 2020 2020 2020   0, \.          
-0000ead0: 2020 2773 746f 7261 6765 2073 686f 756c    'storage shoul
-0000eae0: 6420 7374 6172 7420 696e 2064 6574 6163  d start in detac
-0000eaf0: 6865 6420 7374 6174 6520 616e 6420 6265  hed state and be
-0000eb00: 2065 7863 6c75 6465 6420 6672 6f6d 2073   excluded from s
-0000eb10: 746f 7261 6765 206c 6973 7469 6e67 270a  torage listing'.
-0000eb20: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-0000eb30: 645f 7374 6f72 6167 655f 7769 7468 6f75  d_storage_withou
-0000eb40: 745f 6d65 7461 6461 7461 5f6b 6579 5f66  t_metadata_key_f
-0000eb50: 6169 6c73 2873 656c 6629 3a0a 2020 2020  ails(self):.    
-0000eb60: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0000eb70: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0000eb80: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0000eb90: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0000eba0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0000ebb0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-0000ebc0: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-0000ebd0: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebf0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-0000ec00: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-0000ec10: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000ec20: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000ec30: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
-0000ec40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000ec50: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
-0000ec60: 6e74 696d 6545 7272 6f72 2920 6173 2063  ntimeError) as c
-0000ec70: 6d3a 0a20 2020 2020 2020 2020 2020 2068  m:.            h
-0000ec80: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
-0000ec90: 6765 2822 7465 7374 2229 0a20 2020 2020  ge("test").     
-0000eca0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ecb0: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-0000ecc0: 2063 6d2e 6578 6365 7074 696f 6e2e 6172   cm.exception.ar
-0000ecd0: 6773 5b30 5d2c 0a20 2020 2020 2020 2020  gs[0],.         
-0000ece0: 2020 2022 7468 6520 6b65 7920 2774 6573     "the key 'tes
-0000ecf0: 7427 2069 7320 6e6f 7420 7370 6563 6966  t' is not specif
-0000ed00: 6965 6420 6173 2061 2073 746f 7261 6765  ied as a storage
-0000ed10: 206b 6579 2069 6e20 6d65 7461 6461 7461   key in metadata
-0000ed20: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
-0000ed30: 5f61 6464 5f73 746f 7261 6765 5f61 6674  _add_storage_aft
-0000ed40: 6572 5f68 6172 6e65 7373 5f62 6567 696e  er_harness_begin
-0000ed50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ed60: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0000ed70: 7374 696e 672e 4861 726e 6573 7328 5374  sting.Harness(St
-0000ed80: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
-0000ed90: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000eda0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0000edb0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-0000edc0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-0000edd0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-0000ede0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000edf0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-0000ee00: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0000ee10: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
-0000ee20: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
-0000ee30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000ee40: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
-0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee60: 2020 2020 6d75 6c74 6970 6c65 3a0a 2020      multiple:.  
-0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee80: 2020 2020 2020 7261 6e67 653a 2031 2d33        range: 1-3
-0000ee90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0000eea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000eeb0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0000eec0: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
-0000eed0: 2020 2020 2320 5365 7420 7570 2069 6e69      # Set up ini
-0000eee0: 7469 616c 2073 746f 7261 6765 0a20 2020  tial storage.   
-0000eef0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-0000ef00: 5f73 746f 7261 6765 2822 7465 7374 2229  _storage("test")
-0000ef10: 5b30 5d0a 2020 2020 2020 2020 6861 726e  [0].        harn
-0000ef20: 6573 732e 6265 6769 6e5f 7769 7468 5f69  ess.begin_with_i
-0000ef30: 6e69 7469 616c 5f68 6f6f 6b73 2829 0a20  nitial_hooks(). 
-0000ef40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ef50: 7274 4571 7561 6c28 6c65 6e28 6861 726e  rtEqual(len(harn
-0000ef60: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-0000ef70: 6564 5f65 7665 6e74 7329 2c20 3129 0a20  ed_events), 1). 
-0000ef80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ef90: 7274 5472 7565 2869 7369 6e73 7461 6e63  rtTrue(isinstanc
-0000efa0: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
-0000efb0: 6f62 7365 7276 6564 5f65 7665 6e74 735b  observed_events[
-0000efc0: 305d 2c20 6f70 732e 5374 6f72 6167 6541  0], ops.StorageA
-0000efd0: 7474 6163 6865 6445 7665 6e74 2929 0a0a  ttachedEvent))..
-0000efe0: 2020 2020 2020 2020 2320 4164 6420 6164          # Add ad
-0000eff0: 6469 7469 6f6e 616c 2073 746f 7261 6765  ditional storage
-0000f000: 0a20 2020 2020 2020 2073 746f 725f 6964  .        stor_id
-0000f010: 7320 3d20 6861 726e 6573 732e 6164 645f  s = harness.add_
-0000f020: 7374 6f72 6167 6528 2274 6573 7422 2c20  storage("test", 
-0000f030: 636f 756e 743d 332c 2061 7474 6163 683d  count=3, attach=
-0000f040: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
-0000f050: 4e4f 5445 3a20 7374 6f72 5f69 6420 6e6f  NOTE: stor_id no
-0000f060: 7720 7265 666c 6563 7473 2074 6865 2034  w reflects the 4
-0000f070: 7468 2049 442e 2020 5468 6520 326e 6420  th ID.  The 2nd 
-0000f080: 616e 6420 3372 6420 4944 7320 6172 6520  and 3rd IDs are 
-0000f090: 6372 6561 7465 6420 616e 640a 2020 2020  created and.    
-0000f0a0: 2020 2020 2320 7573 6564 2c20 6275 7420      # used, but 
-0000f0b0: 6e6f 7420 7265 7475 726e 6564 2062 7920  not returned by 
-0000f0c0: 4861 726e 6573 732e 6164 645f 7374 6f72  Harness.add_stor
-0000f0d0: 6167 652e 0a20 2020 2020 2020 2023 2028  age..        # (
-0000f0e0: 5368 6f75 6c64 2077 6520 636f 6e73 6964  Should we consid
-0000f0f0: 6572 2063 6861 6e67 696e 6720 6974 7320  er changing its 
-0000f100: 7265 7475 726e 2074 7970 653f 290a 0a20  return type?).. 
-0000f110: 2020 2020 2020 2061 6464 6564 5f69 6e64         added_ind
-0000f120: 6963 6573 203d 207b 7365 6c66 2e5f 6578  ices = {self._ex
-0000f130: 7472 6163 745f 7374 6f72 6167 655f 696e  tract_storage_in
-0000f140: 6465 7828 7374 6f72 5f69 6429 2066 6f72  dex(stor_id) for
-0000f150: 2073 746f 725f 6964 2069 6e20 7374 6f72   stor_id in stor
-0000f160: 5f69 6473 7d0a 2020 2020 2020 2020 7365  _ids}.        se
-0000f170: 6c66 2e61 7373 6572 7454 7275 6528 6164  lf.assertTrue(ad
-0000f180: 6465 645f 696e 6469 6365 732e 6973 7375  ded_indices.issu
-0000f190: 6273 6574 2873 6574 2868 6172 6e65 7373  bset(set(harness
-0000f1a0: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
-0000f1b0: 655f 6c69 7374 2822 7465 7374 2229 2929  e_list("test")))
-0000f1c0: 290a 0a20 2020 2020 2020 2066 6f72 2069  )..        for i
-0000f1d0: 2069 6e20 5b27 3127 2c20 2732 272c 2027   in ['1', '2', '
-0000f1e0: 3327 5d3a 0a20 2020 2020 2020 2020 2020  3']:.           
-0000f1f0: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-0000f200: 6622 7465 7374 2f7b 697d 220a 2020 2020  f"test/{i}".    
-0000f210: 2020 2020 2020 2020 7761 6e74 203d 2073          want = s
-0000f220: 7472 2870 6174 686c 6962 2e50 7572 6550  tr(pathlib.PureP
-0000f230: 6174 6828 2774 6573 7427 2c20 6929 290a  ath('test', i)).
-0000f240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f250: 2e61 7373 6572 7454 7275 6528 6861 726e  .assertTrue(harn
-0000f260: 6573 732e 5f62 6163 6b65 6e64 2e73 746f  ess._backend.sto
-0000f270: 7261 6765 5f67 6574 2873 746f 7261 6765  rage_get(storage
-0000f280: 5f6e 616d 652c 2022 6c6f 6361 7469 6f6e  _name, "location
-0000f290: 2229 2e65 6e64 7377 6974 6828 7761 6e74  ").endswith(want
-0000f2a0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000f2b0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-0000f2c0: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
-0000f2d0: 7365 7276 6564 5f65 7665 6e74 7329 2c20  served_events), 
-0000f2e0: 3429 0a20 2020 2020 2020 2066 6f72 2069  4).        for i
-0000f2f0: 2069 6e20 7261 6e67 6528 312c 2034 293a   in range(1, 4):
-0000f300: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000f310: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
-0000f320: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-0000f330: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-0000f340: 7665 6e74 735b 695d 2c20 6f70 732e 5374  vents[i], ops.St
-0000f350: 6f72 6167 6541 7474 6163 6865 6445 7665  orageAttachedEve
-0000f360: 6e74 2929 0a0a 2020 2020 6465 6620 7465  nt))..    def te
-0000f370: 7374 5f64 6574 6163 685f 7374 6f72 6167  st_detach_storag
-0000f380: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0000f390: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-0000f3a0: 6573 7469 6e67 2e48 6172 6e65 7373 2853  esting.Harness(S
-0000f3b0: 746f 7261 6765 5465 7374 6572 2c20 6d65  torageTester, me
-0000f3c0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-0000f3d0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-0000f3e0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-0000f3f0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-0000f400: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f420: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-0000f430: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0000f440: 7261 6765 3a0a 2020 2020 2020 2020 2020  rage:.          
-0000f450: 2020 2020 2020 7465 7374 3a0a 2020 2020        test:.    
-0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f470: 7479 7065 3a20 6669 6c65 7379 7374 656d  type: filesystem
-0000f480: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0000f490: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f4a0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0000f4b0: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
-0000f4c0: 2020 2020 2320 5365 7420 7570 2069 6e69      # Set up ini
-0000f4d0: 7469 616c 2073 746f 7261 6765 0a20 2020  tial storage.   
-0000f4e0: 2020 2020 2073 746f 725f 6964 203d 2068       stor_id = h
-0000f4f0: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
-0000f500: 6765 2822 7465 7374 2229 5b30 5d0a 2020  ge("test")[0].  
-0000f510: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-0000f520: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
-0000f530: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
-0000f540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f550: 6c28 6c65 6e28 6861 726e 6573 732e 6368  l(len(harness.ch
-0000f560: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
-0000f570: 6e74 7329 2c20 3129 0a20 2020 2020 2020  nts), 1).       
-0000f580: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000f590: 2869 7369 6e73 7461 6e63 6528 6861 726e  (isinstance(harn
-0000f5a0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-0000f5b0: 6564 5f65 7665 6e74 735b 305d 2c20 6f70  ed_events[0], op
-0000f5c0: 732e 5374 6f72 6167 6541 7474 6163 6865  s.StorageAttache
-0000f5d0: 6445 7665 6e74 2929 0a0a 2020 2020 2020  dEvent))..      
-0000f5e0: 2020 2320 4465 7461 6368 2073 746f 7261    # Detach stora
-0000f5f0: 6765 0a20 2020 2020 2020 2068 6172 6e65  ge.        harne
-0000f600: 7373 2e64 6574 6163 685f 7374 6f72 6167  ss.detach_storag
-0000f610: 6528 7374 6f72 5f69 6429 0a20 2020 2020  e(stor_id).     
-0000f620: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f630: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
-0000f640: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-0000f650: 7665 6e74 7329 2c20 3229 0a20 2020 2020  vents), 2).     
-0000f660: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000f670: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
-0000f680: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-0000f690: 7276 6564 5f65 7665 6e74 735b 315d 2c20  rved_events[1], 
-0000f6a0: 6f70 732e 5374 6f72 6167 6544 6574 6163  ops.StorageDetac
-0000f6b0: 6869 6e67 4576 656e 7429 290a 0a20 2020  hingEvent))..   
-0000f6c0: 2020 2020 2023 2056 6572 6966 7920 6261       # Verify ba
-0000f6d0: 636b 656e 6420 6675 6e63 7469 6f6e 7320  ckend functions 
-0000f6e0: 7265 7475 726e 2061 7070 726f 7072 6961  return appropria
-0000f6f0: 7465 2076 616c 7565 732e 0a20 2020 2020  te values..     
-0000f700: 2020 2023 2052 6561 6c20 6261 636b 656e     # Real backen
-0000f710: 6420 776f 756c 6420 7265 7475 726e 2069  d would return i
-0000f720: 6e66 6f20 6f6e 6c79 2066 6f72 2061 6374  nfo only for act
-0000f730: 6976 656c 7920 6174 7461 6368 6564 2073  ively attached s
-0000f740: 746f 7261 6765 2075 6e69 7473 2e0a 2020  torage units..  
-0000f750: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f760: 744e 6f74 496e 2873 746f 725f 6964 2c20  tNotIn(stor_id, 
-0000f770: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
-0000f780: 2e73 746f 7261 6765 5f6c 6973 7428 2274  .storage_list("t
-0000f790: 6573 7422 2929 0a20 2020 2020 2020 2077  est")).        w
-0000f7a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000f7b0: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
-0000f7c0: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-0000f7d0: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-0000f7e0: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
-0000f7f0: 655f 6765 7428 2274 6573 742f 3022 2c20  e_get("test/0", 
-0000f800: 226c 6f63 6174 696f 6e22 290a 2020 2020  "location").    
-0000f810: 2020 2020 2320 4572 726f 7220 6d65 7373      # Error mess
-0000f820: 6167 6520 6d6f 6465 6c65 6420 6166 7465  age modeled afte
-0000f830: 7220 6f75 7470 7574 206f 660a 2020 2020  r output of.    
-0000f840: 2020 2020 2320 2273 746f 7261 6765 2d67      # "storage-g
-0000f850: 6574 202d 7320 3c69 6e76 616c 6964 2f69  et -s <invalid/i
-0000f860: 6e61 6374 6976 6520 6964 3e20 6c6f 6361  nactive id> loca
-0000f870: 7469 6f6e 2220 6f6e 2072 6561 6c20 6465  tion" on real de
-0000f880: 706c 6f79 6d65 6e74 0a20 2020 2020 2020  ployment.       
-0000f890: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f8a0: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
-0000f8b0: 6d2e 6578 6365 7074 696f 6e2e 6172 6773  m.exception.args
-0000f8c0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0000f8d0: 2027 4552 524f 5220 696e 7661 6c69 6420   'ERROR invalid 
-0000f8e0: 7661 6c75 6520 2274 6573 742f 3022 2066  value "test/0" f
-0000f8f0: 6f72 206f 7074 696f 6e20 2d73 3a20 7374  or option -s: st
-0000f900: 6f72 6167 6520 6e6f 7420 666f 756e 6427  orage not found'
-0000f910: 290a 0a20 2020 2020 2020 2023 2052 6574  )..        # Ret
-0000f920: 7279 2064 6574 6163 680a 2020 2020 2020  ry detach.      
-0000f930: 2020 2320 5369 6e63 6520 616c 7265 6164    # Since alread
-0000f940: 7920 6465 7461 6368 6564 2c20 6e6f 206d  y detached, no m
-0000f950: 6f72 6520 686f 6f6b 7320 7368 6f75 6c64  ore hooks should
-0000f960: 2066 6972 650a 2020 2020 2020 2020 6861   fire.        ha
-0000f970: 726e 6573 732e 6465 7461 6368 5f73 746f  rness.detach_sto
-0000f980: 7261 6765 2873 746f 725f 6964 290a 2020  rage(stor_id).  
-0000f990: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f9a0: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
-0000f9b0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-0000f9c0: 645f 6576 656e 7473 292c 2032 290a 2020  d_events), 2).  
-0000f9d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f9e0: 7454 7275 6528 6973 696e 7374 616e 6365  tTrue(isinstance
-0000f9f0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
-0000fa00: 6273 6572 7665 645f 6576 656e 7473 5b31  bserved_events[1
-0000fa10: 5d2c 206f 7073 2e53 746f 7261 6765 4465  ], ops.StorageDe
-0000fa20: 7461 6368 696e 6745 7665 6e74 2929 0a0a  tachingEvent))..
-0000fa30: 2020 2020 6465 6620 7465 7374 5f64 6574      def test_det
-0000fa40: 6163 685f 7374 6f72 6167 655f 6265 666f  ach_storage_befo
-0000fa50: 7265 5f68 6172 6e65 7373 5f62 6567 696e  re_harness_begin
-0000fa60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000fa70: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0000fa80: 7374 696e 672e 4861 726e 6573 7328 5374  sting.Harness(St
-0000fa90: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
-0000faa0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000fab0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0000fac0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-0000fad0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-0000fae0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-0000faf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000fb00: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-0000fb10: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0000fb20: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
-0000fb30: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
-0000fb40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000fb50: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
-0000fb60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-0000fb70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0000fb80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0000fb90: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
-0000fba0: 2020 2073 746f 725f 6964 203d 2068 6172     stor_id = har
-0000fbb0: 6e65 7373 2e61 6464 5f73 746f 7261 6765  ness.add_storage
-0000fbc0: 2822 7465 7374 2229 5b30 5d0a 2020 2020  ("test")[0].    
-0000fbd0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000fbe0: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000fbf0: 6d65 4572 726f 7229 2061 7320 636d 3a0a  meError) as cm:.
-0000fc00: 2020 2020 2020 2020 2020 2020 6861 726e              harn
-0000fc10: 6573 732e 6465 7461 6368 5f73 746f 7261  ess.detach_stora
-0000fc20: 6765 2866 2274 6573 742f 7b73 746f 725f  ge(f"test/{stor_
-0000fc30: 6964 7d22 290a 2020 2020 2020 2020 7365  id}").        se
-0000fc40: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000fc50: 6d2e 6578 6365 7074 696f 6e2e 6172 6773  m.exception.args
-0000fc60: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0000fc70: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-0000fc80: 616e 6e6f 7420 6465 7461 6368 2073 746f  annot detach sto
-0000fc90: 7261 6765 2062 6566 6f72 6520 4861 726e  rage before Harn
-0000fca0: 6573 7320 6973 2069 6e69 7469 616c 6973  ess is initialis
-0000fcb0: 6564 2229 0a0a 2020 2020 6465 6620 7465  ed")..    def te
-0000fcc0: 7374 5f73 746f 7261 6765 5f77 6974 685f  st_storage_with_
-0000fcd0: 6879 7068 656e 735f 776f 726b 7328 7365  hyphens_works(se
-0000fce0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0000fcf0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-0000fd00: 6e67 2e48 6172 6e65 7373 2853 746f 7261  ng.Harness(Stora
-0000fd10: 6765 5465 7374 6572 2c20 6d65 7461 3d27  geTester, meta='
-0000fd20: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-0000fd30: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-0000fd40: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-0000fd50: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000fd60: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-0000fd70: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-0000fd80: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-0000fd90: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0000fda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fdb0: 2020 7465 7374 3a0a 2020 2020 2020 2020    test:.        
-0000fdc0: 2020 2020 2020 2020 2020 2020 7479 7065              type
-0000fdd0: 3a20 6669 6c65 7379 7374 656d 0a20 2020  : filesystem.   
-0000fde0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
-0000fdf0: 742d 7769 7468 2d68 7970 6865 6e73 3a0a  t-with-hyphens:.
-0000fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe10: 2020 2020 7479 7065 3a20 6669 6c65 7379      type: filesy
-0000fe20: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
-0000fe30: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-0000fe40: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0000fe50: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
-0000fe60: 2020 2020 2020 2020 2320 5365 7420 7570          # Set up
-0000fe70: 2069 6e69 7469 616c 2073 746f 7261 6765   initial storage
-0000fe80: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000fe90: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000fea0: 2068 656c 7065 7220 3d20 5374 6f72 6167   helper = Storag
-0000feb0: 6557 6974 6848 7970 6865 6e73 4865 6c70  eWithHyphensHelp
-0000fec0: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
-0000fed0: 2c20 2268 656c 7065 7222 290a 2020 2020  , "helper").    
-0000fee0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-0000fef0: 7374 6f72 6167 6528 2274 6573 742d 7769  storage("test-wi
-0000ff00: 7468 2d68 7970 6865 6e73 222c 2061 7474  th-hyphens", att
-0000ff10: 6163 683d 5472 7565 295b 305d 0a0a 2020  ach=True)[0]..  
-0000ff20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000ff30: 7445 7175 616c 286c 656e 2868 656c 7065  tEqual(len(helpe
-0000ff40: 722e 6368 616e 6765 7329 2c20 3129 0a0a  r.changes), 1)..
-0000ff50: 2020 2020 6465 6620 7465 7374 5f61 7474      def test_att
-0000ff60: 6163 685f 7374 6f72 6167 6528 7365 6c66  ach_storage(self
-0000ff70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0000ff80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0000ff90: 2e48 6172 6e65 7373 2853 746f 7261 6765  .Harness(Storage
-0000ffa0: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
-0000ffb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0000ffc0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-0000ffd0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
-0000ffe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fff0: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
-00010000: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00010010: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
-00010020: 2020 2020 2020 2073 746f 7261 6765 3a0a         storage:.
-00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010040: 7465 7374 3a0a 2020 2020 2020 2020 2020  test:.          
-00010050: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
-00010060: 6669 6c65 7379 7374 656d 0a20 2020 2020  filesystem.     
-00010070: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00010080: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00010090: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-000100a0: 6e75 7029 0a0a 2020 2020 2020 2020 2320  nup)..        # 
-000100b0: 5365 7420 7570 2069 6e69 7469 616c 2073  Set up initial s
-000100c0: 746f 7261 6765 0a20 2020 2020 2020 2073  torage.        s
-000100d0: 746f 725f 6964 203d 2068 6172 6e65 7373  tor_id = harness
-000100e0: 2e61 6464 5f73 746f 7261 6765 2822 7465  .add_storage("te
-000100f0: 7374 2229 5b30 5d0a 2020 2020 2020 2020  st")[0].        
-00010100: 6861 726e 6573 732e 6265 6769 6e5f 7769  harness.begin_wi
-00010110: 7468 5f69 6e69 7469 616c 5f68 6f6f 6b73  th_initial_hooks
-00010120: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00010130: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-00010140: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
-00010150: 7365 7276 6564 5f65 7665 6e74 7329 2c20  served_events), 
-00010160: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
-00010170: 6173 7365 7274 5472 7565 2869 7369 6e73  assertTrue(isins
-00010180: 7461 6e63 6528 6861 726e 6573 732e 6368  tance(harness.ch
-00010190: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
-000101a0: 6e74 735b 305d 2c20 6f70 732e 5374 6f72  nts[0], ops.Stor
-000101b0: 6167 6541 7474 6163 6865 6445 7665 6e74  ageAttachedEvent
-000101c0: 2929 0a0a 2020 2020 2020 2020 2320 4465  ))..        # De
-000101d0: 7461 6368 2073 746f 7261 6765 0a20 2020  tach storage.   
-000101e0: 2020 2020 2068 6172 6e65 7373 2e64 6574       harness.det
-000101f0: 6163 685f 7374 6f72 6167 6528 7374 6f72  ach_storage(stor
-00010200: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
-00010210: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-00010220: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
-00010230: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
-00010240: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
-00010250: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
-00010260: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-00010270: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00010280: 7665 6e74 735b 315d 2c20 6f70 732e 5374  vents[1], ops.St
-00010290: 6f72 6167 6544 6574 6163 6869 6e67 4576  orageDetachingEv
-000102a0: 656e 7429 290a 0a20 2020 2020 2020 2023  ent))..        #
-000102b0: 2052 652d 6174 7461 6368 2073 746f 7261   Re-attach stora
-000102c0: 6765 0a20 2020 2020 2020 2068 6172 6e65  ge.        harne
-000102d0: 7373 2e61 7474 6163 685f 7374 6f72 6167  ss.attach_storag
-000102e0: 6528 7374 6f72 5f69 6429 0a20 2020 2020  e(stor_id).     
-000102f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00010300: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
-00010310: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00010320: 7665 6e74 7329 2c20 3329 0a20 2020 2020  vents), 3).     
-00010330: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00010340: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
-00010350: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-00010360: 7276 6564 5f65 7665 6e74 735b 325d 2c20  rved_events[2], 
-00010370: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
-00010380: 6865 6445 7665 6e74 2929 0a0a 2020 2020  hedEvent))..    
-00010390: 2020 2020 2320 5665 7269 6679 2062 6163      # Verify bac
-000103a0: 6b65 6e64 2066 756e 6374 696f 6e73 2072  kend functions r
-000103b0: 6574 7572 6e20 6170 7072 6f70 7269 6174  eturn appropriat
-000103c0: 6520 7661 6c75 6573 2e0a 2020 2020 2020  e values..      
-000103d0: 2020 2320 5265 616c 2062 6163 6b65 6e64    # Real backend
-000103e0: 2077 6f75 6c64 2072 6574 7572 6e20 696e   would return in
-000103f0: 666f 206f 6e6c 7920 666f 7220 6163 7469  fo only for acti
-00010400: 7665 6c79 2061 7474 6163 6865 6420 7374  vely attached st
-00010410: 6f72 6167 6520 756e 6974 732e 0a20 2020  orage units..   
-00010420: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010430: 496e 2873 656c 662e 5f65 7874 7261 6374  In(self._extract
-00010440: 5f73 746f 7261 6765 5f69 6e64 6578 2873  _storage_index(s
-00010450: 746f 725f 6964 292c 2068 6172 6e65 7373  tor_id), harness
-00010460: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
-00010470: 655f 6c69 7374 2822 7465 7374 2229 290a  e_list("test")).
-00010480: 2020 2020 2020 2020 7761 6e74 203d 2073          want = s
-00010490: 7472 2870 6174 686c 6962 2e50 7572 6550  tr(pathlib.PureP
-000104a0: 6174 6828 2774 6573 7427 2c20 2730 2729  ath('test', '0')
-000104b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000104c0: 7373 6572 7445 7175 616c 2877 616e 742c  ssertEqual(want,
-000104d0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-000104e0: 642e 7374 6f72 6167 655f 6765 7428 2274  d.storage_get("t
-000104f0: 6573 742f 3022 2c20 226c 6f63 6174 696f  est/0", "locatio
-00010500: 6e22 295b 2d36 3a5d 290a 0a20 2020 2020  n")[-6:])..     
-00010510: 2020 2023 2052 6574 7279 2061 7474 6163     # Retry attac
-00010520: 680a 2020 2020 2020 2020 2320 5369 6e63  h.        # Sinc
-00010530: 6520 616c 7265 6164 7920 6465 7461 6368  e already detach
-00010540: 6564 2c20 6e6f 206d 6f72 6520 686f 6f6b  ed, no more hook
-00010550: 7320 7368 6f75 6c64 2066 6972 650a 2020  s should fire.  
-00010560: 2020 2020 2020 6861 726e 6573 732e 6174        harness.at
-00010570: 7461 6368 5f73 746f 7261 6765 2873 746f  tach_storage(sto
-00010580: 725f 6964 290a 2020 2020 2020 2020 7365  r_id).        se
-00010590: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-000105a0: 656e 2868 6172 6e65 7373 2e63 6861 726d  en(harness.charm
-000105b0: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
-000105c0: 292c 2033 290a 2020 2020 2020 2020 7365  ), 3).        se
-000105d0: 6c66 2e61 7373 6572 7454 7275 6528 6973  lf.assertTrue(is
-000105e0: 696e 7374 616e 6365 2868 6172 6e65 7373  instance(harness
-000105f0: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
-00010600: 6576 656e 7473 5b32 5d2c 206f 7073 2e53  events[2], ops.S
-00010610: 746f 7261 6765 4174 7461 6368 6564 4576  torageAttachedEv
-00010620: 656e 7429 290a 0a20 2020 2064 6566 2074  ent))..    def t
-00010630: 6573 745f 6174 7461 6368 5f73 746f 7261  est_attach_stora
-00010640: 6765 5f62 6566 6f72 655f 6861 726e 6573  ge_before_harnes
-00010650: 735f 6265 6769 6e28 7365 6c66 293a 0a20  s_begin(self):. 
-00010660: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00010670: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-00010680: 6e65 7373 2853 746f 7261 6765 5465 7374  ness(StorageTest
-00010690: 6572 2c20 6d65 7461 3d27 2727 0a20 2020  er, meta='''.   
-000106a0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-000106b0: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
-000106c0: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-000106d0: 2020 2020 2020 2020 2020 2020 2020 6462                db
-000106e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000106f0: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
-00010700: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
-00010710: 2020 2073 746f 7261 6765 3a0a 2020 2020     storage:.    
-00010720: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00010730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010740: 2020 2020 2020 7479 7065 3a20 6669 6c65        type: file
-00010750: 7379 7374 656d 0a20 2020 2020 2020 2020  system.         
-00010760: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00010770: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00010780: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00010790: 0a0a 2020 2020 2020 2020 2320 5765 2064  ..        # We d
-000107a0: 656c 6962 6572 6174 656c 7920 646f 6e27  eliberately don'
-000107b0: 7420 6775 6172 6420 6167 6169 6e73 7420  t guard against 
-000107c0: 6174 7461 6368 696e 6720 7374 6f72 6167  attaching storag
-000107d0: 6520 6265 666f 7265 2074 6865 2068 6172  e before the har
-000107e0: 6e65 7373 2062 6567 696e 732c 0a20 2020  ness begins,.   
-000107f0: 2020 2020 2023 2061 7320 7468 6572 6520       # as there 
-00010800: 6172 6520 6c65 6769 7469 6d61 7465 2072  are legitimate r
-00010810: 6561 736f 6e73 2074 6f20 646f 2073 6f2e  easons to do so.
-00010820: 0a20 2020 2020 2020 2073 746f 725f 6964  .        stor_id
-00010830: 203d 2068 6172 6e65 7373 2e61 6464 5f73   = harness.add_s
-00010840: 746f 7261 6765 2822 7465 7374 2229 5b30  torage("test")[0
-00010850: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00010860: 7373 6572 7454 7275 6528 7374 6f72 5f69  ssertTrue(stor_i
-00010870: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
-00010880: 5f72 656d 6f76 655f 7374 6f72 6167 655f  _remove_storage_
-00010890: 6265 666f 7265 5f68 6172 6e65 7373 5f62  before_harness_b
-000108a0: 6567 696e 2873 656c 6629 3a0a 2020 2020  egin(self):.    
-000108b0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-000108c0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-000108d0: 7328 5374 6f72 6167 6554 6573 7465 722c  s(StorageTester,
-000108e0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-000108f0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-00010900: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-00010910: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
-00010920: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-00010930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010940: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-00010950: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-00010960: 7374 6f72 6167 653a 0a20 2020 2020 2020  storage:.       
-00010970: 2020 2020 2020 2020 2074 6573 743a 0a20           test:. 
-00010980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010990: 2020 2074 7970 653a 2066 696c 6573 7973     type: filesys
-000109a0: 7465 6d0a 2020 2020 2020 2020 2020 2020  tem.            
-000109b0: 2020 2020 2020 2020 6d75 6c74 6970 6c65          multiple
-000109c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000109d0: 2020 2020 2020 2020 2020 7261 6e67 653a            range:
-000109e0: 2031 2d33 0a20 2020 2020 2020 2020 2020   1-3.           
-000109f0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00010a00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00010a10: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
-00010a20: 2020 2020 2020 2020 7374 6f72 5f69 6473          stor_ids
-00010a30: 203d 2068 6172 6e65 7373 2e61 6464 5f73   = harness.add_s
-00010a40: 746f 7261 6765 2822 7465 7374 222c 2063  torage("test", c
-00010a50: 6f75 6e74 3d32 290a 2020 2020 2020 2020  ount=2).        
-00010a60: 6861 726e 6573 732e 7265 6d6f 7665 5f73  harness.remove_s
-00010a70: 746f 7261 6765 2873 746f 725f 6964 735b  torage(stor_ids[
-00010a80: 305d 290a 2020 2020 2020 2020 2320 4e6f  0]).        # No
-00010a90: 7465 2072 653a 2064 656c 7461 2062 6574  te re: delta bet
-00010aa0: 7765 656e 2072 6561 6c20 6265 6861 7669  ween real behavi
-00010ab0: 6f72 2061 6e64 2048 6172 6e65 7373 3a20  or and Harness: 
-00010ac0: 4a75 6a75 2064 6f65 736e 2774 2061 6c6c  Juju doesn't all
-00010ad0: 6f77 2072 656d 6f76 616c 0a20 2020 2020  ow removal.     
-00010ae0: 2020 2023 206f 6620 7468 6520 6c61 7374     # of the last
-00010af0: 2061 7474 6163 6865 6420 7374 6f72 6167   attached storag
-00010b00: 6520 756e 6974 2077 6869 6c65 2061 2077  e unit while a w
-00010b10: 6f72 6b6c 6f61 6420 6973 2073 7469 6c6c  orkload is still
-00010b20: 2072 756e 6e69 6e67 2e20 2054 6f20 6d6f   running.  To mo
-00010b30: 7265 0a20 2020 2020 2020 2023 2065 6173  re.        # eas
-00010b40: 696c 7920 616c 6c6f 7720 7465 7374 696e  ily allow testin
-00010b50: 6720 6f66 2073 746f 7261 6765 2072 656d  g of storage rem
-00010b60: 6f76 616c 2c20 4920 616d 2070 7265 7365  oval, I am prese
-00010b70: 6e74 6c79 2069 676e 6f72 696e 6720 7468  ntly ignoring th
-00010b80: 6973 2064 6574 6169 6c2e 0a20 2020 2020  is detail..     
-00010b90: 2020 2023 2028 4f74 6865 7277 6973 652c     # (Otherwise,
-00010ba0: 2074 6865 2075 7365 7220 776f 756c 6420   the user would 
-00010bb0: 6e65 6564 2074 6f20 666c 6167 2073 6f6d  need to flag som
-00010bc0: 6568 6f77 2074 6861 7420 7468 6579 2061  ehow that they a
-00010bd0: 7265 2069 6e74 656e 7469 6f6e 616c 6c79  re intentionally
-00010be0: 0a20 2020 2020 2020 2023 2072 656d 6f76  .        # remov
-00010bf0: 696e 6720 7468 6520 6669 6e61 6c20 756e  ing the final un
-00010c00: 6974 2061 7320 7061 7274 206f 6620 6120  it as part of a 
-00010c10: 7368 7574 646f 776e 2070 726f 6365 6475  shutdown procedu
-00010c20: 7265 2c20 656c 7365 2069 7427 6420 626c  re, else it'd bl
-00010c30: 6f63 6b20 7468 650a 2020 2020 2020 2020  ock the.        
-00010c40: 2320 7265 6d6f 7661 6c2e 2020 4927 6d20  # removal.  I'm 
-00010c50: 6e6f 7420 7375 7265 2073 7563 6820 6265  not sure such be
-00010c60: 6861 7669 6f72 2069 7320 7072 6f64 7563  havior is produc
-00010c70: 7469 7665 2e29 0a0a 2020 2020 2020 2020  tive.)..        
-00010c80: 6861 726e 6573 732e 6265 6769 6e5f 7769  harness.begin_wi
-00010c90: 7468 5f69 6e69 7469 616c 5f68 6f6f 6b73  th_initial_hooks
-00010ca0: 2829 0a20 2020 2020 2020 2023 204f 6e6c  ().        # Onl
-00010cb0: 7920 6f6e 6520 686f 6f6b 2077 696c 6c20  y one hook will 
-00010cc0: 6669 7265 3b20 6f6e 6520 776f 6e27 7420  fire; one won't 
-00010cd0: 7369 6e63 6520 6974 2077 6173 2072 656d  since it was rem
-00010ce0: 6f76 6564 0a20 2020 2020 2020 2073 656c  oved.        sel
-00010cf0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-00010d00: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
-00010d10: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
-00010d20: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
-00010d30: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
-00010d40: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-00010d50: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00010d60: 7665 6e74 735b 305d 2c20 6f70 732e 5374  vents[0], ops.St
-00010d70: 6f72 6167 6541 7474 6163 6865 6445 7665  orageAttachedEve
-00010d80: 6e74 2929 0a0a 2020 2020 6465 6620 7465  nt))..    def te
-00010d90: 7374 5f72 656d 6f76 655f 7374 6f72 6167  st_remove_storag
-00010da0: 655f 7769 7468 6f75 745f 6d65 7461 6461  e_without_metada
-00010db0: 7461 5f6b 6579 5f66 6169 6c73 2873 656c  ta_key_fails(sel
-00010dc0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00010dd0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00010de0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-00010df0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-00010e00: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-00010e10: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-00010e20: 2020 2020 2020 2020 2072 6571 7569 7265           require
-00010e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010e40: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-00010e50: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00010e60: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
-00010e70: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00010e80: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00010e90: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00010ea0: 616e 7570 290a 0a20 2020 2020 2020 2023  anup)..        #
-00010eb0: 2044 6f65 736e 2774 2072 6561 6c6c 7920   Doesn't really 
-00010ec0: 6d61 6b65 2073 656e 7365 2073 696e 6365  make sense since
-00010ed0: 2077 6520 616c 7265 6164 7920 6361 6e27   we already can'
-00010ee0: 7420 6164 6420 7374 6f72 6167 6520 7768  t add storage wh
-00010ef0: 6963 6820 6973 6e27 7420 696e 2074 6865  ich isn't in the
-00010f00: 206d 6574 6164 6174 612c 0a20 2020 2020   metadata,.     
-00010f10: 2020 2023 2062 7574 2069 6e63 6c75 6465     # but include
-00010f20: 6420 666f 7220 636f 6d70 6c65 7465 6e65  d for completene
-00010f30: 7373 2e0a 2020 2020 2020 2020 7769 7468  ss..        with
-00010f40: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00010f50: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-00010f60: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-00010f70: 2020 2020 6861 726e 6573 732e 7265 6d6f      harness.remo
-00010f80: 7665 5f73 746f 7261 6765 2822 7465 7374  ve_storage("test
-00010f90: 2f30 2229 0a20 2020 2020 2020 2073 656c  /0").        sel
-00010fa0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00010fb0: 2020 2020 2020 2020 2020 2063 6d2e 6578             cm.ex
-00010fc0: 6365 7074 696f 6e2e 6172 6773 5b30 5d2c  ception.args[0],
-00010fd0: 0a20 2020 2020 2020 2020 2020 2022 7468  .            "th
-00010fe0: 6520 6b65 7920 2774 6573 7427 2069 7320  e key 'test' is 
-00010ff0: 6e6f 7420 7370 6563 6966 6965 6420 6173  not specified as
-00011000: 2061 2073 746f 7261 6765 206b 6579 2069   a storage key i
-00011010: 6e20 6d65 7461 6461 7461 2229 0a0a 2020  n metadata")..  
-00011020: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
-00011030: 655f 7374 6f72 6167 655f 6166 7465 725f  e_storage_after_
-00011040: 6861 726e 6573 735f 6265 6769 6e28 7365  harness_begin(se
-00011050: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00011060: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-00011070: 6e67 2e48 6172 6e65 7373 2853 746f 7261  ng.Harness(Stora
-00011080: 6765 5465 7374 6572 2c20 6d65 7461 3d27  geTester, meta='
-00011090: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-000110a0: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-000110b0: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-000110c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000110d0: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-000110e0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-000110f0: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-00011100: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00011110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011120: 2020 7465 7374 3a0a 2020 2020 2020 2020    test:.        
-00011130: 2020 2020 2020 2020 2020 2020 7479 7065              type
-00011140: 3a20 6669 6c65 7379 7374 656d 0a20 2020  : filesystem.   
-00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011160: 206d 756c 7469 706c 653a 0a20 2020 2020   multiple:.     
-00011170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011180: 2020 2072 616e 6765 3a20 312d 330a 2020     range: 1-3.  
-00011190: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-000111a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-000111b0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-000111c0: 6c65 616e 7570 290a 0a20 2020 2020 2020  leanup)..       
-000111d0: 2073 746f 725f 6964 7320 3d20 6861 726e   stor_ids = harn
-000111e0: 6573 732e 6164 645f 7374 6f72 6167 6528  ess.add_storage(
-000111f0: 2274 6573 7422 2c20 636f 756e 743d 3229  "test", count=2)
-00011200: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00011210: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
-00011220: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
-00011230: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011240: 7175 616c 286c 656e 2868 6172 6e65 7373  qual(len(harness
-00011250: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
-00011260: 6576 656e 7473 292c 2032 290a 2020 2020  events), 2).    
-00011270: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00011280: 7275 6528 6973 696e 7374 616e 6365 2868  rue(isinstance(h
-00011290: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-000112a0: 6572 7665 645f 6576 656e 7473 5b30 5d2c  erved_events[0],
-000112b0: 206f 7073 2e53 746f 7261 6765 4174 7461   ops.StorageAtta
-000112c0: 6368 6564 4576 656e 7429 290a 2020 2020  chedEvent)).    
-000112d0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-000112e0: 7275 6528 6973 696e 7374 616e 6365 2868  rue(isinstance(h
-000112f0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-00011300: 6572 7665 645f 6576 656e 7473 5b31 5d2c  erved_events[1],
-00011310: 206f 7073 2e53 746f 7261 6765 4174 7461   ops.StorageAtta
-00011320: 6368 6564 4576 656e 7429 290a 0a20 2020  chedEvent))..   
-00011330: 2020 2020 2068 6172 6e65 7373 2e72 656d       harness.rem
-00011340: 6f76 655f 7374 6f72 6167 6528 7374 6f72  ove_storage(stor
-00011350: 5f69 6473 5b31 5d29 0a20 2020 2020 2020  _ids[1]).       
-00011360: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00011370: 6c28 6c65 6e28 6861 726e 6573 732e 6368  l(len(harness.ch
-00011380: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
-00011390: 6e74 7329 2c20 3329 0a20 2020 2020 2020  nts), 3).       
-000113a0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-000113b0: 2869 7369 6e73 7461 6e63 6528 6861 726e  (isinstance(harn
-000113c0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-000113d0: 6564 5f65 7665 6e74 735b 325d 2c20 6f70  ed_events[2], op
-000113e0: 732e 5374 6f72 6167 6544 6574 6163 6869  s.StorageDetachi
-000113f0: 6e67 4576 656e 7429 290a 0a20 2020 2020  ngEvent))..     
-00011400: 2020 2061 7474 6163 6865 645f 7374 6f72     attached_stor
-00011410: 6167 655f 6964 7320 3d20 6861 726e 6573  age_ids = harnes
-00011420: 732e 5f62 6163 6b65 6e64 2e73 746f 7261  s._backend.stora
-00011430: 6765 5f6c 6973 7428 2274 6573 7422 290a  ge_list("test").
-00011440: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011450: 6572 7449 6e28 7365 6c66 2e5f 6578 7472  ertIn(self._extr
-00011460: 6163 745f 7374 6f72 6167 655f 696e 6465  act_storage_inde
-00011470: 7828 7374 6f72 5f69 6473 5b30 5d29 2c20  x(stor_ids[0]), 
-00011480: 6174 7461 6368 6564 5f73 746f 7261 6765  attached_storage
-00011490: 5f69 6473 290a 2020 2020 2020 2020 7365  _ids).        se
-000114a0: 6c66 2e61 7373 6572 744e 6f74 496e 2873  lf.assertNotIn(s
-000114b0: 656c 662e 5f65 7874 7261 6374 5f73 746f  elf._extract_sto
-000114c0: 7261 6765 5f69 6e64 6578 2873 746f 725f  rage_index(stor_
-000114d0: 6964 735b 315d 292c 2061 7474 6163 6865  ids[1]), attache
-000114e0: 645f 7374 6f72 6167 655f 6964 7329 0a0a  d_storage_ids)..
-000114f0: 2020 2020 6465 6620 5f65 7874 7261 6374      def _extract
-00011500: 5f73 746f 7261 6765 5f69 6e64 6578 2873  _storage_index(s
-00011510: 656c 662c 2073 746f 725f 6964 293a 0a20  elf, stor_id):. 
-00011520: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
-00011530: 7428 7374 6f72 5f69 642e 7370 6c69 7428  t(stor_id.split(
-00011540: 272f 2729 5b2d 315d 290a 0a20 2020 2064  '/')[-1])..    d
-00011550: 6566 2074 6573 745f 7265 6d6f 7665 5f64  ef test_remove_d
-00011560: 6574 6163 6865 645f 7374 6f72 6167 6528  etached_storage(
-00011570: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-00011580: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-00011590: 7469 6e67 2e48 6172 6e65 7373 2853 746f  ting.Harness(Sto
-000115a0: 7261 6765 5465 7374 6572 2c20 6d65 7461  rageTester, meta
-000115b0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-000115c0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
-000115d0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-000115e0: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
-000115f0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00011600: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00011610: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
-00011620: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-00011630: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-00011640: 2020 2020 7465 7374 3a0a 2020 2020 2020      test:.      
-00011650: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-00011660: 7065 3a20 6669 6c65 7379 7374 656d 0a20  pe: filesystem. 
-00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011680: 2020 206d 756c 7469 706c 653a 0a20 2020     multiple:.   
-00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116a0: 2020 2020 2072 616e 6765 3a20 312d 330a       range: 1-3.
-000116b0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-000116c0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-000116d0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-000116e0: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
-000116f0: 2020 2073 746f 725f 6964 7320 3d20 6861     stor_ids = ha
-00011700: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
-00011710: 6528 2274 6573 7422 2c20 636f 756e 743d  e("test", count=
-00011720: 3229 0a20 2020 2020 2020 2068 6172 6e65  2).        harne
-00011730: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
-00011740: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
-00011750: 2020 2020 2020 6861 726e 6573 732e 6465        harness.de
-00011760: 7461 6368 5f73 746f 7261 6765 2873 746f  tach_storage(sto
-00011770: 725f 6964 735b 305d 290a 2020 2020 2020  r_ids[0]).      
-00011780: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
-00011790: 5f73 746f 7261 6765 2873 746f 725f 6964  _storage(stor_id
-000117a0: 735b 305d 2920 2023 2041 6c72 6561 6479  s[0])  # Already
-000117b0: 2064 6574 6163 6865 642c 2073 6f20 776f   detached, so wo
-000117c0: 6e27 7420 6669 7265 2061 2068 6f6f 6b0a  n't fire a hook.
-000117d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000117e0: 6572 7445 7175 616c 286c 656e 2868 6172  ertEqual(len(har
-000117f0: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-00011800: 7665 645f 6576 656e 7473 292c 2033 290a  ved_events), 3).
-00011810: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011820: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
-00011830: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
-00011840: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
-00011850: 5b30 5d2c 206f 7073 2e53 746f 7261 6765  [0], ops.Storage
-00011860: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
-00011870: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011880: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
-00011890: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
-000118a0: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
-000118b0: 5b31 5d2c 206f 7073 2e53 746f 7261 6765  [1], ops.Storage
-000118c0: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
-000118d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000118e0: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
-000118f0: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
-00011900: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
-00011910: 5b32 5d2c 206f 7073 2e53 746f 7261 6765  [2], ops.Storage
-00011920: 4465 7461 6368 696e 6745 7665 6e74 2929  DetachingEvent))
-00011930: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-00011940: 6374 696f 6e73 5f66 726f 6d5f 6469 7265  ctions_from_dire
-00011950: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
-00011960: 2020 2020 2074 6d70 203d 2070 6174 686c       tmp = pathl
-00011970: 6962 2e50 6174 6828 7465 6d70 6669 6c65  ib.Path(tempfile
-00011980: 2e6d 6b64 7465 6d70 2829 290a 2020 2020  .mkdtemp()).    
-00011990: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-000119a0: 6e75 7028 7368 7574 696c 2e72 6d74 7265  nup(shutil.rmtre
-000119b0: 652c 2073 7472 2874 6d70 2929 0a20 2020  e, str(tmp)).   
-000119c0: 2020 2020 2061 6374 696f 6e73 5f66 696c       actions_fil
-000119d0: 656e 616d 6520 3d20 746d 7020 2f20 2761  ename = tmp / 'a
-000119e0: 6374 696f 6e73 2e79 616d 6c27 0a20 2020  ctions.yaml'.   
-000119f0: 2020 2020 2077 6974 6820 6163 7469 6f6e       with action
-00011a00: 735f 6669 6c65 6e61 6d65 2e6f 7065 6e28  s_filename.open(
-00011a10: 2777 7427 2920 6173 2061 6374 696f 6e73  'wt') as actions
-00011a20: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
-00011a30: 7469 6f6e 732e 7772 6974 6528 7465 7874  tions.write(text
-00011a40: 7772 6170 2e64 6564 656e 7428 2727 270a  wrap.dedent('''.
-00011a50: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00011a60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011a70: 2020 6465 7363 7269 7074 696f 6e3a 2061    description: a
-00011a80: 2064 756d 6d79 2061 6374 696f 6e0a 2020   dummy action.  
-00011a90: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
-00011aa0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00011ab0: 3d20 7365 6c66 2e5f 6765 745f 6475 6d6d  = self._get_dumm
-00011ac0: 795f 6368 6172 6d5f 6861 726e 6573 7328  y_charm_harness(
-00011ad0: 746d 7029 0a20 2020 2020 2020 2068 6172  tmp).        har
-00011ae0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-00011af0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00011b00: 4571 7561 6c28 6c69 7374 2868 6172 6e65  Equal(list(harne
-00011b10: 7373 2e66 7261 6d65 776f 726b 2e6d 6574  ss.framework.met
-00011b20: 612e 6163 7469 6f6e 7329 2c20 5b27 7465  a.actions), ['te
-00011b30: 7374 275d 290a 2020 2020 2020 2020 2320  st']).        # 
-00011b40: 5468 6520 6368 6172 6d5f 6469 7220 616c  The charm_dir al
-00011b50: 736f 2067 6574 7320 7365 740a 2020 2020  so gets set.    
-00011b60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011b70: 7175 616c 2868 6172 6e65 7373 2e66 7261  qual(harness.fra
-00011b80: 6d65 776f 726b 2e63 6861 726d 5f64 6972  mework.charm_dir
-00011b90: 2c20 746d 7029 0a0a 2020 2020 6465 6620  , tmp)..    def 
-00011ba0: 5f67 6574 5f64 756d 6d79 5f63 6861 726d  _get_dummy_charm
-00011bb0: 5f68 6172 6e65 7373 2873 656c 662c 2074  _harness(self, t
-00011bc0: 6d70 293a 0a20 2020 2020 2020 2073 656c  mp):.        sel
-00011bd0: 662e 5f77 7269 7465 5f64 756d 6d79 5f63  f._write_dummy_c
-00011be0: 6861 726d 2874 6d70 290a 2020 2020 2020  harm(tmp).      
-00011bf0: 2020 6368 6172 6d5f 6d6f 6420 3d20 696d    charm_mod = im
-00011c00: 706f 7274 6c69 622e 696d 706f 7274 5f6d  portlib.import_m
-00011c10: 6f64 756c 6528 2774 6573 7463 6861 726d  odule('testcharm
-00011c20: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00011c30: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-00011c40: 2e48 6172 6e65 7373 2863 6861 726d 5f6d  .Harness(charm_m
-00011c50: 6f64 2e4d 7954 6573 7469 6e67 4368 6172  od.MyTestingChar
-00011c60: 6d29 0a20 2020 2020 2020 2073 656c 662e  m).        self.
-00011c70: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00011c80: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00011c90: 2020 2020 7265 7475 726e 2068 6172 6e65      return harne
-00011ca0: 7373 0a0a 2020 2020 6465 6620 5f77 7269  ss..    def _wri
-00011cb0: 7465 5f64 756d 6d79 5f63 6861 726d 2873  te_dummy_charm(s
-00011cc0: 656c 662c 2074 6d70 293a 0a20 2020 2020  elf, tmp):.     
-00011cd0: 2020 2073 7263 6469 7220 3d20 746d 7020     srcdir = tmp 
-00011ce0: 2f20 2773 7263 270a 2020 2020 2020 2020  / 'src'.        
-00011cf0: 7372 6364 6972 2e6d 6b64 6972 2830 6f37  srcdir.mkdir(0o7
-00011d00: 3535 290a 2020 2020 2020 2020 6368 6172  55).        char
-00011d10: 6d5f 6669 6c65 6e61 6d65 203d 2073 7263  m_filename = src
-00011d20: 6469 7220 2f20 2774 6573 7463 6861 726d  dir / 'testcharm
-00011d30: 2e70 7927 0a20 2020 2020 2020 2077 6974  .py'.        wit
-00011d40: 6820 6368 6172 6d5f 6669 6c65 6e61 6d65  h charm_filename
-00011d50: 2e6f 7065 6e28 2777 7427 2920 6173 2063  .open('wt') as c
-00011d60: 6861 726d 7079 3a0a 2020 2020 2020 2020  harmpy:.        
-00011d70: 2020 2020 2320 6c61 6e67 7561 6765 3d50      # language=P
-00011d80: 7974 686f 6e0a 2020 2020 2020 2020 2020  ython.          
-00011d90: 2020 6368 6172 6d70 792e 7772 6974 6528    charmpy.write(
-00011da0: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
-00011db0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00011dc0: 2020 2020 6672 6f6d 206f 7073 2069 6d70      from ops imp
-00011dd0: 6f72 7420 4368 6172 6d42 6173 650a 2020  ort CharmBase.  
-00011de0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00011df0: 6173 7320 4d79 5465 7374 696e 6743 6861  ass MyTestingCha
-00011e00: 726d 2843 6861 726d 4261 7365 293a 0a20  rm(CharmBase):. 
-00011e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e20: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00011e30: 2020 2020 2020 2020 2727 2729 290a 2020          ''')).  
-00011e40: 2020 2020 2020 6f72 6967 203d 2073 7973        orig = sys
-00011e50: 2e70 6174 685b 3a5d 0a20 2020 2020 2020  .path[:].       
-00011e60: 2073 7973 2e70 6174 682e 6170 7065 6e64   sys.path.append
-00011e70: 2873 7472 2873 7263 6469 7229 290a 0a20  (str(srcdir)).. 
-00011e80: 2020 2020 2020 2064 6566 2063 6c65 616e         def clean
-00011e90: 7570 2829 3a0a 2020 2020 2020 2020 2020  up():.          
-00011ea0: 2020 7379 732e 7061 7468 203d 206f 7269    sys.path = ori
-00011eb0: 670a 2020 2020 2020 2020 2020 2020 7379  g.            sy
-00011ec0: 732e 6d6f 6475 6c65 732e 706f 7028 2774  s.modules.pop('t
-00011ed0: 6573 7463 6861 726d 2729 0a0a 2020 2020  estcharm')..    
-00011ee0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00011ef0: 6e75 7028 636c 6561 6e75 7029 0a0a 2020  nup(cleanup)..  
-00011f00: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
-00011f10: 6e73 5f70 6173 7365 645f 696e 2873 656c  ns_passed_in(sel
-00011f20: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00011f30: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00011f40: 672e 4861 726e 6573 7328 0a20 2020 2020  g.Harness(.     
-00011f50: 2020 2020 2020 206f 7073 2e43 6861 726d         ops.Charm
-00011f60: 4261 7365 2c0a 2020 2020 2020 2020 2020  Base,.          
-00011f70: 2020 6d65 7461 3d27 2727 0a20 2020 2020    meta='''.     
-00011f80: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00011f90: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-00011fa0: 2020 2020 2020 2727 272c 0a20 2020 2020        ''',.     
-00011fb0: 2020 2020 2020 2061 6374 696f 6e73 3d27         actions='
-00011fc0: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
-00011fd0: 2020 2074 6573 742d 6163 7469 6f6e 3a0a     test-action:.
-00011fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ff0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-00012000: 2061 2064 756d 6d79 2074 6573 7420 6163   a dummy test ac
-00012010: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00012020: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00012030: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00012040: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00012050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00012060: 7274 4571 7561 6c28 6c69 7374 2868 6172  rtEqual(list(har
-00012070: 6e65 7373 2e66 7261 6d65 776f 726b 2e6d  ness.framework.m
-00012080: 6574 612e 6163 7469 6f6e 7329 2c20 5b27  eta.actions), ['
-00012090: 7465 7374 2d61 6374 696f 6e27 5d29 0a0a  test-action'])..
-000120a0: 2020 2020 6465 6620 7465 7374 5f65 7665      def test_eve
-000120b0: 6e74 5f63 6f6e 7465 7874 2873 656c 6629  nt_context(self)
-000120c0: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
-000120d0: 4d79 4368 6172 6d28 6f70 732e 4368 6172  MyCharm(ops.Char
-000120e0: 6d42 6173 6529 3a0a 2020 2020 2020 2020  mBase):.        
-000120f0: 2020 2020 6465 6620 6576 656e 745f 6861      def event_ha
-00012100: 6e64 6c65 7228 7365 6c66 2c20 6576 7429  ndler(self, evt)
-00012110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012120: 2020 6576 742e 7265 6c61 7469 6f6e 2e64    evt.relation.d
-00012130: 6174 615b 6576 742e 7265 6c61 7469 6f6e  ata[evt.relation
-00012140: 2e61 7070 5d5b 2766 6f6f 275d 203d 2027  .app]['foo'] = '
-00012150: 6261 7227 0a0a 2020 2020 2020 2020 6861  bar'..        ha
-00012160: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-00012170: 696e 672e 4861 726e 6573 7328 4d79 4368  ing.Harness(MyCh
-00012180: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
-00012190: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000121a0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
-000121b0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-000121c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000121d0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-000121e0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-000121f0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00012200: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00012210: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00012220: 2829 0a20 2020 2020 2020 2072 656c 5f69  ().        rel_i
-00012230: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
-00012240: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-00012250: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-00012260: 2020 2020 2072 656c 203d 2068 6172 6e65       rel = harne
-00012270: 7373 2e63 6861 726d 2e6d 6f64 656c 2e67  ss.charm.model.g
-00012280: 6574 5f72 656c 6174 696f 6e28 2764 6227  et_relation('db'
-00012290: 2c20 7265 6c5f 6964 290a 0a20 2020 2020  , rel_id)..     
-000122a0: 2020 2065 7665 6e74 203d 204d 6167 6963     event = Magic
-000122b0: 4d6f 636b 2829 0a20 2020 2020 2020 2065  Mock().        e
-000122c0: 7665 6e74 2e72 656c 6174 696f 6e20 3d20  vent.relation = 
-000122d0: 7265 6c0a 0a20 2020 2020 2020 2077 6974  rel..        wit
-000122e0: 6820 6861 726e 6573 732e 5f65 7665 6e74  h harness._event
-000122f0: 5f63 6f6e 7465 7874 2827 6d79 5f72 656c  _context('my_rel
-00012300: 6174 696f 6e5f 6a6f 696e 6564 2729 3a0a  ation_joined'):.
-00012310: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00012320: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00012330: 6573 286f 7073 2e52 656c 6174 696f 6e44  es(ops.RelationD
-00012340: 6174 6145 7272 6f72 293a 0a20 2020 2020  ataError):.     
-00012350: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-00012360: 7373 2e63 6861 726d 2e65 7665 6e74 5f68  ss.charm.event_h
-00012370: 616e 646c 6572 2865 7665 6e74 290a 0a20  andler(event).. 
-00012380: 2020 2064 6566 2074 6573 745f 6576 656e     def test_even
-00012390: 745f 636f 6e74 6578 745f 696e 7665 7273  t_context_invers
-000123a0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-000123b0: 2063 6c61 7373 204d 7943 6861 726d 286f   class MyCharm(o
-000123c0: 7073 2e43 6861 726d 4261 7365 293a 0a20  ps.CharmBase):. 
-000123d0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-000123e0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
-000123f0: 616d 6577 6f72 6b3a 206f 7073 2e46 7261  amework: ops.Fra
-00012400: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
-00012410: 2020 2020 2020 2020 2073 7570 6572 2829           super()
-00012420: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-00012430: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
-00012440: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-00012450: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-00012460: 2e6f 6e2e 6462 5f72 656c 6174 696f 6e5f  .on.db_relation_
-00012470: 6a6f 696e 6564 2c0a 2020 2020 2020 2020  joined,.        
-00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000124a0: 656c 662e 5f6a 6f69 6e5f 6462 290a 0a20  elf._join_db).. 
-000124b0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-000124c0: 6a6f 696e 5f64 6228 7365 6c66 2c20 6576  join_db(self, ev
-000124d0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-000124e0: 2020 2020 2020 2320 646f 2074 6869 6e67        # do thing
-000124f0: 7320 7769 7468 2041 5049 7320 7765 2063  s with APIs we c
-00012500: 616e 6e6f 7420 6561 7369 6c79 206d 6f63  annot easily moc
-00012510: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-00012520: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-00012530: 6d65 6e74 6564 4572 726f 720a 0a20 2020  mentedError..   
-00012540: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-00012550: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-00012560: 7373 284d 7943 6861 726d 2c20 6d65 7461  ss(MyCharm, meta
-00012570: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00012580: 206e 616d 653a 2074 6573 742d 6368 6172   name: test-char
-00012590: 6d0a 2020 2020 2020 2020 2020 2020 7265  m.            re
-000125a0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-000125b0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-000125c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125d0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-000125e0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-000125f0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00012600: 732e 6265 6769 6e28 290a 0a20 2020 2020  s.begin()..     
-00012610: 2020 2064 6566 206d 6f63 6b5f 6a6f 696e     def mock_join
-00012620: 5f64 6228 6576 656e 7429 3a0a 2020 2020  _db(event):.    
-00012630: 2020 2020 2020 2020 2320 7468 6520 6861          # the ha
-00012640: 726e 6573 7320 7468 696e 6b73 2077 6527  rness thinks we'
-00012650: 7265 2069 6e73 6964 6520 6120 6462 5f72  re inside a db_r
-00012660: 656c 6174 696f 6e5f 6a6f 696e 6564 2068  elation_joined h
-00012670: 6f6f 6b0a 2020 2020 2020 2020 2020 2020  ook.            
-00012680: 2320 6275 7420 7765 2077 616e 7420 746f  # but we want to
-00012690: 206d 6f63 6b20 7468 6520 7265 6d6f 7465   mock the remote
-000126a0: 2064 6174 6120 6865 7265 3a0a 2020 2020   data here:.    
-000126b0: 2020 2020 2020 2020 7769 7468 2068 6172          with har
-000126c0: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
-000126d0: 6578 7428 2727 293a 0a20 2020 2020 2020  ext(''):.       
-000126e0: 2020 2020 2020 2020 2023 2070 7265 7465           # prete
-000126f0: 6e64 2066 6f72 2061 206d 6f6d 656e 7420  nd for a moment 
-00012700: 7765 2772 6520 6e6f 7420 696e 2061 2068  we're not in a h
-00012710: 6f6f 6b20 636f 6e74 6578 742c 0a20 2020  ook context,.   
-00012720: 2020 2020 2020 2020 2020 2020 2023 2073               # s
-00012730: 6f20 7468 6520 6861 726e 6573 7320 7769  o the harness wi
-00012740: 6c6c 206c 6574 2075 733a 0a20 2020 2020  ll let us:.     
-00012750: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00012760: 2865 7665 6e74 2e72 656c 6174 696f 6e2e  (event.relation.
-00012770: 6170 7029 0a20 2020 2020 2020 2020 2020  app).           
-00012780: 2020 2020 2065 7665 6e74 2e72 656c 6174       event.relat
-00012790: 696f 6e2e 6461 7461 5b68 6172 6e65 7373  ion.data[harness
-000127a0: 2e63 6861 726d 2e61 7070 5d5b 2766 6f6f  .charm.app]['foo
-000127b0: 275d 203d 2027 6261 7227 0a0a 2020 2020  '] = 'bar'..    
-000127c0: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
-000127d0: 6d2e 5f6a 6f69 6e5f 6462 203d 206d 6f63  m._join_db = moc
-000127e0: 6b5f 6a6f 696e 5f64 620a 2020 2020 2020  k_join_db.      
-000127f0: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
-00012800: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00012810: 2764 6227 2c20 2772 656d 6f74 6527 290a  'db', 'remote').
-00012820: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00012830: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00012840: 7428 7265 6c5f 6964 2c20 2772 656d 6f74  t(rel_id, 'remot
-00012850: 652f 3027 290a 2020 2020 2020 2020 7265  e/0').        re
-00012860: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
-00012870: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
-00012880: 7469 6f6e 2827 6462 272c 2072 656c 5f69  tion('db', rel_i
-00012890: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-000128a0: 6173 7365 7274 4571 7561 6c28 7b27 666f  assertEqual({'fo
-000128b0: 6f27 3a20 2762 6172 277d 2c0a 2020 2020  o': 'bar'},.    
-000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128d0: 2020 2020 2068 6172 6e65 7373 2e67 6574       harness.get
-000128e0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-000128f0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
-00012900: 726d 2729 290a 0a20 2020 2020 2020 2023  rm'))..        #
-00012910: 206e 6f77 2077 6527 7265 206f 7574 7369   now we're outsi
-00012920: 6465 206f 6620 7468 6520 686f 6f6b 2063  de of the hook c
-00012930: 6f6e 7465 7874 3a0a 2020 2020 2020 2020  ontext:.        
-00012940: 6173 7365 7274 206e 6f74 2068 6172 6e65  assert not harne
-00012950: 7373 2e5f 6261 636b 656e 642e 5f68 6f6f  ss._backend._hoo
-00012960: 6b5f 6973 5f72 756e 6e69 6e67 0a20 2020  k_is_running.   
-00012970: 2020 2020 2061 7373 6572 7420 7265 6c2e       assert rel.
-00012980: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-00012990: 726d 2e61 7070 5d5b 2766 6f6f 275d 203d  rm.app]['foo'] =
-000129a0: 3d20 2762 6172 270a 0a20 2020 2064 6566  = 'bar'..    def
-000129b0: 2074 6573 745f 7265 6c61 7469 6f6e 5f73   test_relation_s
-000129c0: 6574 5f64 656c 6574 6573 2873 656c 6629  et_deletes(self)
-000129d0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-000129e0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-000129f0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
-00012a00: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-00012a10: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00012a20: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
-00012a30: 2020 2020 2020 2020 2072 6571 7569 7265           require
-00012a40: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00012a50: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-00012a60: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00012a70: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
-00012a80: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00012a90: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00012aa0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00012ab0: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
-00012ac0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-00012ad0: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-00012ae0: 745f 6c65 6164 6572 2846 616c 7365 290a  t_leader(False).
-00012af0: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
-00012b00: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00012b10: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-00012b20: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-00012b30: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00012b40: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00012b50: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
-00012b60: 726d 2f30 272c 207b 2766 6f6f 273a 2027  rm/0', {'foo': '
-00012b70: 6261 7227 7d29 0a20 2020 2020 2020 2068  bar'}).        h
-00012b80: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00012b90: 696f 6e5f 756e 6974 2872 656c 5f69 642c  ion_unit(rel_id,
-00012ba0: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
-00012bb0: 0a20 2020 2020 2020 2072 656c 203d 2068  .        rel = h
-00012bc0: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
-00012bd0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-00012be0: 2764 6227 2c20 7265 6c5f 6964 290a 2020  'db', rel_id).  
-00012bf0: 2020 2020 2020 6465 6c20 7265 6c2e 6461        del rel.da
-00012c00: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
-00012c10: 2e6d 6f64 656c 2e75 6e69 745d 5b27 666f  .model.unit]['fo
-00012c20: 6f27 5d0a 2020 2020 2020 2020 7365 6c66  o'].        self
-00012c30: 2e61 7373 6572 7445 7175 616c 287b 7d2c  .assertEqual({},
-00012c40: 2068 6172 6e65 7373 2e67 6574 5f72 656c   harness.get_rel
-00012c50: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-00012c60: 642c 2027 7465 7374 2d63 6861 726d 2f30  d, 'test-charm/0
-00012c70: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
-00012c80: 745f 7265 6c61 7469 6f6e 5f73 6574 5f6e  t_relation_set_n
-00012c90: 6f6e 7374 7269 6e67 2873 656c 6629 3a0a  onstring(self):.
-00012ca0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00012cb0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-00012cc0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
-00012cd0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
-00012ce0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00012cf0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
-00012d00: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00012d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d20: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-00012d30: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00012d40: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00012d50: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00012d60: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00012d70: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00012d80: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00012d90: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00012da0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-00012db0: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
-00012dc0: 2020 2020 2020 7265 6c5f 6964 203d 2068        rel_id = h
-00012dd0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00012de0: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
-00012df0: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
-00012e00: 666f 7220 696e 7661 6c69 645f 7661 6c75  for invalid_valu
-00012e10: 6520 696e 2028 312c 2031 2e32 2c20 7b7d  e in (1, 1.2, {}
-00012e20: 2c20 5b5d 2c20 7365 7428 292c 2054 7275  , [], set(), Tru
-00012e30: 652c 206f 626a 6563 7428 292c 2074 7970  e, object(), typ
-00012e40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00012e50: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00012e60: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
-00012e70: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
-00012e80: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00012e90: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00012ea0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-00012eb0: 6964 2c20 2774 6573 742d 6368 6172 6d2f  id, 'test-charm/
-00012ec0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ef0: 207b 2766 6f6f 273a 2069 6e76 616c 6964   {'foo': invalid
-00012f00: 5f76 616c 7565 7d29 0a0a 2020 2020 6465  _value})..    de
-00012f10: 6620 7465 7374 5f73 6574 5f77 6f72 6b6c  f test_set_workl
-00012f20: 6f61 645f 7665 7273 696f 6e28 7365 6c66  oad_version(self
-00012f30: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00012f40: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-00012f50: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-00012f60: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-00012f70: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00012f80: 653a 2061 7070 0a20 2020 2020 2020 2020  e: app.         
-00012f90: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00012fa0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00012fb0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00012fc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00012fd0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-00012fe0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-00012ff0: 6e65 2868 6172 6e65 7373 2e67 6574 5f77  ne(harness.get_w
-00013000: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
-00013010: 2929 0a20 2020 2020 2020 2068 6172 6e65  )).        harne
-00013020: 7373 2e63 6861 726d 2e6d 6f64 656c 2e75  ss.charm.model.u
-00013030: 6e69 742e 7365 745f 776f 726b 6c6f 6164  nit.set_workload
-00013040: 5f76 6572 7369 6f6e 2827 312e 322e 3327  _version('1.2.3'
-00013050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00013060: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-00013070: 7373 2e67 6574 5f77 6f72 6b6c 6f61 645f  ss.get_workload_
-00013080: 7665 7273 696f 6e28 292c 2027 312e 322e  version(), '1.2.
-00013090: 3327 290a 0a20 2020 2064 6566 2074 6573  3')..    def tes
-000130a0: 745f 6765 745f 6261 636b 656e 645f 6361  t_get_backend_ca
-000130b0: 6c6c 7328 7365 6c66 293a 0a20 2020 2020  lls(self):.     
-000130c0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-000130d0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-000130e0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
-000130f0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-00013100: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-00013110: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
-00013120: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-00013130: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013150: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-00013160: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-00013170: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00013180: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00013190: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-000131a0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-000131b0: 6567 696e 2829 0a20 2020 2020 2020 2023  egin().        #
-000131c0: 204e 6f20 6361 6c6c 7320 746f 2074 6865   No calls to the
-000131d0: 2062 6163 6b65 6e64 2079 6574 0a20 2020   backend yet.   
-000131e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000131f0: 4571 7561 6c28 6861 726e 6573 732e 5f67  Equal(harness._g
-00013200: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
-00013210: 2829 2c20 5b5d 290a 2020 2020 2020 2020  (), []).        
-00013220: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-00013230: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00013240: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-00013250: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00013260: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-00013270: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-00013280: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
-00013290: 6174 696f 6e5f 6964 7327 2c20 2764 6227  ation_ids', 'db'
-000132a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000132b0: 2020 2028 2772 656c 6174 696f 6e5f 6c69     ('relation_li
-000132c0: 7374 272c 2072 656c 5f69 6429 2c0a 2020  st', rel_id),.  
-000132d0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-000132e0: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-000132f0: 6170 705f 6e61 6d65 272c 2030 292c 0a20  app_name', 0),. 
-00013300: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00013310: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
-00013320: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
-00013330: 616c 6c73 2829 290a 0a20 2020 2020 2020  alls())..       
-00013340: 2023 2075 7064 6174 655f 7265 6c61 7469   # update_relati
-00013350: 6f6e 5f64 6174 6120 656e 7375 7265 7320  on_data ensures 
-00013360: 7468 6520 6361 6368 6564 2064 6174 6120  the cached data 
-00013370: 666f 7220 7468 6520 7265 6c61 7469 6f6e  for the relation
-00013380: 2069 7320 7769 7065 640a 2020 2020 2020   is wiped.      
-00013390: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-000133a0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-000133b0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
-000133c0: 726d 2f30 272c 207b 2766 6f6f 273a 2027  rm/0', {'foo': '
-000133d0: 6261 7227 7d29 0a20 2020 2020 2020 2074  bar'}).        t
-000133e0: 6573 745f 6368 6172 6d5f 756e 6974 203d  est_charm_unit =
-000133f0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e67   harness.model.g
-00013400: 6574 5f75 6e69 7428 2774 6573 742d 6368  et_unit('test-ch
-00013410: 6172 6d2f 3027 290a 2020 2020 2020 2020  arm/0').        
-00013420: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013430: 280a 2020 2020 2020 2020 2020 2020 5b0a  (.            [.
-00013440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013450: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
-00013460: 2030 2c20 2774 6573 742d 6368 6172 6d2f   0, 'test-charm/
-00013470: 3027 2c20 4661 6c73 6529 2c0a 2020 2020  0', False),.    
-00013480: 2020 2020 2020 2020 2020 2020 2827 7570              ('up
-00013490: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-000134a0: 7461 272c 2030 2c20 7465 7374 5f63 6861  ta', 0, test_cha
-000134b0: 726d 5f75 6e69 742c 2027 666f 6f27 2c20  rm_unit, 'foo', 
-000134c0: 2762 6172 2729 0a20 2020 2020 2020 2020  'bar').         
-000134d0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-000134e0: 2020 6861 726e 6573 732e 5f67 6574 5f62    harness._get_b
-000134f0: 6163 6b65 6e64 5f63 616c 6c73 2872 6573  ackend_calls(res
-00013500: 6574 3d54 7275 6529 290a 2020 2020 2020  et=True)).      
-00013510: 2020 2320 6164 645f 7265 6c61 7469 6f6e    # add_relation
-00013520: 5f75 6e69 7420 7265 7365 7473 2074 6865  _unit resets the
-00013530: 2072 656c 6174 696f 6e5f 6c69 7374 2c20   relation_list, 
-00013540: 6275 7420 646f 6573 6e27 7420 7472 6967  but doesn't trig
-00013550: 6765 7220 6261 636b 656e 6420 6361 6c6c  ger backend call
-00013560: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
-00013570: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-00013580: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
-00013590: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
-000135a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000135b0: 7175 616c 285b 5d2c 2068 6172 6e65 7373  qual([], harness
-000135c0: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
-000135d0: 6c6c 7328 7265 7365 743d 4661 6c73 6529  lls(reset=False)
-000135e0: 290a 2020 2020 2020 2020 2320 686f 7765  ).        # howe
-000135f0: 7665 722c 2075 7064 6174 655f 7265 6c61  ver, update_rela
-00013600: 7469 6f6e 5f64 6174 6120 646f 6573 2c20  tion_data does, 
-00013610: 6265 6361 7573 6520 7765 2061 7265 2070  because we are p
-00013620: 7265 7061 7269 6e67 2072 656c 6174 696f  reparing relatio
-00013630: 6e2d 6368 616e 6765 640a 2020 2020 2020  n-changed.      
-00013640: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00013650: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00013660: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00013670: 716c 2f30 272c 207b 2766 6f6f 273a 2027  ql/0', {'foo': '
-00013680: 6261 7227 7d29 0a20 2020 2020 2020 2070  bar'}).        p
-00013690: 6771 6c5f 756e 6974 203d 2068 6172 6e65  gql_unit = harne
-000136a0: 7373 2e6d 6f64 656c 2e67 6574 5f75 6e69  ss.model.get_uni
-000136b0: 7428 2770 6f73 7467 7265 7371 6c2f 3027  t('postgresql/0'
-000136c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000136d0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-000136e0: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-000136f0: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
-00013700: 6c6c 7328 7265 7365 743d 4661 6c73 6529  lls(reset=False)
-00013710: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00013720: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
-00013730: 6473 272c 2027 6462 2729 2c0a 2020 2020  ds', 'db'),.    
-00013740: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
-00013750: 6c61 7469 6f6e 5f6c 6973 7427 2c20 7265  lation_list', re
-00013760: 6c5f 6964 292c 0a20 2020 2020 2020 2020  l_id),.         
-00013770: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00013780: 6e5f 6765 7427 2c20 302c 2027 706f 7374  n_get', 0, 'post
-00013790: 6772 6573 716c 2f30 272c 2046 616c 7365  gresql/0', False
-000137a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000137b0: 2020 2028 2775 7064 6174 655f 7265 6c61     ('update_rela
-000137c0: 7469 6f6e 5f64 6174 6127 2c20 302c 2070  tion_data', 0, p
-000137d0: 6771 6c5f 756e 6974 2c20 2766 6f6f 272c  gql_unit, 'foo',
-000137e0: 2027 6261 7227 290a 2020 2020 2020 2020   'bar').        
-000137f0: 2020 2020 5d29 0a20 2020 2020 2020 2023      ]).        #
-00013800: 2049 6620 7765 2063 6865 636b 2061 6761   If we check aga
-00013810: 696e 2c20 7468 6579 2061 7265 2073 7469  in, they are sti
-00013820: 6c6c 2074 6865 7265 2c20 6275 7420 6e6f  ll there, but no
-00013830: 7720 7765 2072 6573 6574 2069 740a 2020  w we reset it.  
-00013840: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013850: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
-00013860: 2020 2020 6861 726e 6573 732e 5f67 6574      harness._get
-00013870: 5f62 6163 6b65 6e64 5f63 616c 6c73 2872  _backend_calls(r
-00013880: 6573 6574 3d54 7275 6529 2c20 5b0a 2020  eset=True), [.  
-00013890: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-000138a0: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
-000138b0: 6462 2729 2c0a 2020 2020 2020 2020 2020  db'),.          
-000138c0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-000138d0: 5f6c 6973 7427 2c20 7265 6c5f 6964 292c  _list', rel_id),
-000138e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000138f0: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
-00013900: 2c20 302c 2027 706f 7374 6772 6573 716c  , 0, 'postgresql
-00013910: 2f30 272c 2046 616c 7365 292c 0a20 2020  /0', False),.   
-00013920: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
-00013930: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00013940: 6174 6127 2c20 302c 2070 6771 6c5f 756e  ata', 0, pgql_un
-00013950: 6974 2c20 2766 6f6f 272c 2027 6261 7227  it, 'foo', 'bar'
-00013960: 290a 2020 2020 2020 2020 2020 2020 5d29  ).            ])
-00013970: 0a20 2020 2020 2020 2023 2041 6e64 2074  .        # And t
-00013980: 6865 2063 616c 6c73 2061 7265 2067 6f6e  he calls are gon
-00013990: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
-000139a0: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-000139b0: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
-000139c0: 6361 6c6c 7328 292c 205b 5d29 0a0a 2020  calls(), [])..  
-000139d0: 2020 6465 6620 7465 7374 5f67 6574 5f62    def test_get_b
-000139e0: 6163 6b65 6e64 5f63 616c 6c73 5f77 6974  ackend_calls_wit
-000139f0: 685f 6b77 6172 6773 2873 656c 6629 3a0a  h_kwargs(self):.
-00013a00: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00013a10: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-00013a20: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
-00013a30: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
-00013a40: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00013a50: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
-00013a60: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00013a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013a80: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-00013a90: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00013aa0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00013ab0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00013ac0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00013ad0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00013ae0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00013af0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00013b00: 2020 2020 756e 6974 203d 2068 6172 6e65      unit = harne
-00013b10: 7373 2e63 6861 726d 2e6d 6f64 656c 2e75  ss.charm.model.u
-00013b20: 6e69 740a 2020 2020 2020 2020 2320 5265  nit.        # Re
-00013b30: 7365 7420 7468 6520 6c69 7374 2c20 6265  set the list, be
-00013b40: 6361 7573 6520 7765 2064 6f6e 2774 2063  cause we don't c
-00013b50: 6172 6520 7768 6174 2069 7420 746f 6f6b  are what it took
-00013b60: 2074 6f20 6765 7420 6865 7265 0a20 2020   to get here.   
-00013b70: 2020 2020 2068 6172 6e65 7373 2e5f 6765       harness._ge
-00013b80: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
-00013b90: 7265 7365 743d 5472 7565 290a 2020 2020  reset=True).    
-00013ba0: 2020 2020 756e 6974 2e73 7461 7475 7320      unit.status 
-00013bb0: 3d20 6f70 732e 4163 7469 7665 5374 6174  = ops.ActiveStat
-00013bc0: 7573 2829 0a20 2020 2020 2020 2073 656c  us().        sel
-00013bd0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00013be0: 2020 2020 2020 2020 2020 205b 2827 7374             [('st
-00013bf0: 6174 7573 5f73 6574 272c 2027 6163 7469  atus_set', 'acti
-00013c00: 7665 272c 2027 272c 207b 2769 735f 6170  ve', '', {'is_ap
-00013c10: 7027 3a20 4661 6c73 657d 295d 2c20 6861  p': False})], ha
-00013c20: 726e 6573 732e 5f67 6574 5f62 6163 6b65  rness._get_backe
-00013c30: 6e64 5f63 616c 6c73 2829 290a 2020 2020  nd_calls()).    
-00013c40: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-00013c50: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
-00013c60: 2020 2020 2061 7070 203d 2068 6172 6e65       app = harne
-00013c70: 7373 2e63 6861 726d 2e6d 6f64 656c 2e61  ss.charm.model.a
-00013c80: 7070 0a20 2020 2020 2020 2068 6172 6e65  pp.        harne
-00013c90: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
-00013ca0: 6361 6c6c 7328 7265 7365 743d 5472 7565  calls(reset=True
-00013cb0: 290a 2020 2020 2020 2020 6170 702e 7374  ).        app.st
-00013cc0: 6174 7573 203d 206f 7073 2e41 6374 6976  atus = ops.Activ
-00013cd0: 6553 7461 7475 7328 276d 6573 7361 6765  eStatus('message
-00013ce0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00013cf0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-00013d00: 2020 2020 2020 2020 205b 2827 6973 5f6c           [('is_l
-00013d10: 6561 6465 7227 2c29 2c0a 2020 2020 2020  eader',),.      
-00013d20: 2020 2020 2020 2028 2773 7461 7475 735f         ('status_
-00013d30: 7365 7427 2c20 2761 6374 6976 6527 2c20  set', 'active', 
-00013d40: 276d 6573 7361 6765 272c 207b 2769 735f  'message', {'is_
-00013d50: 6170 7027 3a20 5472 7565 7d29 5d2c 0a20  app': True})],. 
-00013d60: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-00013d70: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
-00013d80: 6361 6c6c 7328 2929 0a0a 2020 2020 6465  calls())..    de
-00013d90: 6620 7465 7374 5f75 6e69 745f 7374 6174  f test_unit_stat
-00013da0: 7573 2873 656c 6629 3a0a 2020 2020 2020  us(self):.      
-00013db0: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-00013dc0: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-00013dd0: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
-00013de0: 6574 613d 276e 616d 653a 2074 6573 742d  eta='name: test-
-00013df0: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
-00013e00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00013e10: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00013e20: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
-00013e30: 6574 5f6c 6561 6465 7228 5472 7565 290a  et_leader(True).
-00013e40: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00013e50: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-00013e60: 2320 6465 6661 756c 7420 7374 6174 7573  # default status
-00013e70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00013e80: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-00013e90: 732e 6d6f 6465 6c2e 756e 6974 2e73 7461  s.model.unit.sta
-00013ea0: 7475 732c 206f 7073 2e4d 6169 6e74 656e  tus, ops.Mainten
-00013eb0: 616e 6365 5374 6174 7573 2827 2729 290a  anceStatus('')).
-00013ec0: 2020 2020 2020 2020 7374 6174 7573 203d          status =
-00013ed0: 206f 7073 2e41 6374 6976 6553 7461 7475   ops.ActiveStatu
-00013ee0: 7328 276d 6573 7361 6765 2729 0a20 2020  s('message').   
-00013ef0: 2020 2020 2068 6172 6e65 7373 2e6d 6f64       harness.mod
-00013f00: 656c 2e75 6e69 742e 7374 6174 7573 203d  el.unit.status =
-00013f10: 2073 7461 7475 730a 2020 2020 2020 2020   status.        
-00013f20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013f30: 2868 6172 6e65 7373 2e6d 6f64 656c 2e75  (harness.model.u
-00013f40: 6e69 742e 7374 6174 7573 2c20 7374 6174  nit.status, stat
-00013f50: 7573 290a 0a20 2020 2064 6566 2074 6573  us)..    def tes
-00013f60: 745f 6170 705f 7374 6174 7573 2873 656c  t_app_status(sel
-00013f70: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00013f80: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-00013f90: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-00013fa0: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
-00013fb0: 616d 653a 2074 6573 742d 6170 7027 290a  ame: test-app').
-00013fc0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00013fd0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00013fe0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00013ff0: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
-00014000: 6465 7228 5472 7565 290a 2020 2020 2020  der(True).      
-00014010: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-00014020: 290a 2020 2020 2020 2020 2320 6465 6661  ).        # defa
-00014030: 756c 7420 7374 6174 7573 0a20 2020 2020  ult status.     
-00014040: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00014050: 7561 6c28 6861 726e 6573 732e 6d6f 6465  ual(harness.mode
-00014060: 6c2e 6170 702e 7374 6174 7573 2c20 6f70  l.app.status, op
-00014070: 732e 556e 6b6e 6f77 6e53 7461 7475 7328  s.UnknownStatus(
-00014080: 2929 0a20 2020 2020 2020 2073 7461 7475  )).        statu
-00014090: 7320 3d20 6f70 732e 4163 7469 7665 5374  s = ops.ActiveSt
-000140a0: 6174 7573 2827 6d65 7373 6167 6527 290a  atus('message').
-000140b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000140c0: 6d6f 6465 6c2e 6170 702e 7374 6174 7573  model.app.status
-000140d0: 203d 2073 7461 7475 730a 2020 2020 2020   = status.      
-000140e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000140f0: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
-00014100: 2e61 7070 2e73 7461 7475 732c 2073 7461  .app.status, sta
-00014110: 7475 7329 0a0a 2020 2020 6465 6620 7465  tus)..    def te
-00014120: 7374 5f70 6f70 756c 6174 655f 6f63 695f  st_populate_oci_
-00014130: 7265 736f 7572 6365 7328 7365 6c66 293a  resources(self):
-00014140: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00014150: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
-00014160: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
-00014170: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-00014180: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00014190: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-000141a0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
-000141b0: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
-000141c0: 6d61 6765 3a0a 2020 2020 2020 2020 2020  mage:.          
-000141d0: 2020 2020 2020 7479 7065 3a20 6f63 692d        type: oci-
-000141e0: 696d 6167 650a 2020 2020 2020 2020 2020  image.          
-000141f0: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-00014200: 6e3a 2022 496d 6167 6520 746f 2064 6570  n: "Image to dep
-00014210: 6c6f 792e 220a 2020 2020 2020 2020 2020  loy.".          
-00014220: 2020 2020 696d 6167 6532 3a0a 2020 2020      image2:.    
-00014230: 2020 2020 2020 2020 2020 2020 7479 7065              type
-00014240: 3a20 6f63 692d 696d 6167 650a 2020 2020  : oci-image.    
-00014250: 2020 2020 2020 2020 2020 2020 6465 7363              desc
-00014260: 7269 7074 696f 6e3a 2022 416e 6f74 6865  ription: "Anothe
-00014270: 7220 696d 6167 652e 220a 2020 2020 2020  r image.".      
-00014280: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00014290: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-000142a0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-000142b0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-000142c0: 6573 732e 706f 7075 6c61 7465 5f6f 6369  ess.populate_oci
-000142d0: 5f72 6573 6f75 7263 6573 2829 0a20 2020  _resources().   
-000142e0: 2020 2020 2070 6174 6820 3d20 6861 726e       path = harn
-000142f0: 6573 732e 6d6f 6465 6c2e 7265 736f 7572  ess.model.resour
-00014300: 6365 732e 6665 7463 6828 2769 6d61 6765  ces.fetch('image
-00014310: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00014320: 6173 7365 7274 4571 7561 6c28 7061 7468  assertEqual(path
-00014330: 2e6e 616d 652c 2027 636f 6e74 656e 7473  .name, 'contents
-00014340: 2e79 616d 6c27 290a 2020 2020 2020 2020  .yaml').        
-00014350: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00014360: 2870 6174 682e 7061 7265 6e74 2e6e 616d  (path.parent.nam
-00014370: 652c 2027 696d 6167 6527 290a 2020 2020  e, 'image').    
-00014380: 2020 2020 7769 7468 2070 6174 682e 6f70      with path.op
-00014390: 656e 2827 7227 2920 6173 2072 6573 6f75  en('r') as resou
-000143a0: 7263 655f 6669 6c65 3a0a 2020 2020 2020  rce_file:.      
-000143b0: 2020 2020 2020 636f 6e74 656e 7473 203d        contents =
-000143c0: 2079 616d 6c2e 7361 6665 5f6c 6f61 6428   yaml.safe_load(
-000143d0: 7265 736f 7572 6365 5f66 696c 652e 7265  resource_file.re
-000143e0: 6164 2829 290a 2020 2020 2020 2020 7365  ad()).        se
-000143f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00014400: 6f6e 7465 6e74 735b 2772 6567 6973 7472  ontents['registr
-00014410: 7970 6174 6827 5d2c 2027 7265 6769 7374  ypath'], 'regist
-00014420: 7279 7061 7468 2729 0a20 2020 2020 2020  rypath').       
-00014430: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00014440: 6c28 636f 6e74 656e 7473 5b27 7573 6572  l(contents['user
-00014450: 6e61 6d65 275d 2c20 2775 7365 726e 616d  name'], 'usernam
-00014460: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
-00014470: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
-00014480: 7465 6e74 735b 2770 6173 7377 6f72 6427  tents['password'
-00014490: 5d2c 2027 7061 7373 776f 7264 2729 0a20  ], 'password'). 
-000144a0: 2020 2020 2020 2070 6174 6820 3d20 6861         path = ha
-000144b0: 726e 6573 732e 6d6f 6465 6c2e 7265 736f  rness.model.reso
-000144c0: 7572 6365 732e 6665 7463 6828 2769 6d61  urces.fetch('ima
-000144d0: 6765 3227 290a 2020 2020 2020 2020 7365  ge2').        se
-000144e0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-000144f0: 6174 682e 6e61 6d65 2c20 2763 6f6e 7465  ath.name, 'conte
-00014500: 6e74 732e 7961 6d6c 2729 0a20 2020 2020  nts.yaml').     
-00014510: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00014520: 7561 6c28 7061 7468 2e70 6172 656e 742e  ual(path.parent.
-00014530: 6e61 6d65 2c20 2769 6d61 6765 3227 290a  name, 'image2').
-00014540: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
-00014550: 736f 7572 6365 5f66 6f6c 6465 725f 636c  source_folder_cl
-00014560: 6561 6e75 7028 7365 6c66 293a 0a20 2020  eanup(self):.   
-00014570: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-00014580: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-00014590: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
-000145a0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000145b0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-000145c0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-000145d0: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
-000145e0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-000145f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014600: 2020 7479 7065 3a20 6f63 692d 696d 6167    type: oci-imag
-00014610: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00014620: 2020 6465 7363 7269 7074 696f 6e3a 2022    description: "
-00014630: 496d 6167 6520 746f 2064 6570 6c6f 792e  Image to deploy.
-00014640: 220a 2020 2020 2020 2020 2020 2020 2727  ".            ''
-00014650: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00014660: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00014670: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00014680: 2020 2020 6861 726e 6573 732e 706f 7075      harness.popu
-00014690: 6c61 7465 5f6f 6369 5f72 6573 6f75 7263  late_oci_resourc
-000146a0: 6573 2829 0a20 2020 2020 2020 2070 6174  es().        pat
-000146b0: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
-000146c0: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
-000146d0: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
-000146e0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000146f0: 7565 2870 6174 682e 6578 6973 7473 2829  ue(path.exists()
-00014700: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00014710: 732e 636c 6561 6e75 7028 290a 2020 2020  s.cleanup().    
-00014720: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
-00014730: 616c 7365 2870 6174 682e 6578 6973 7473  alse(path.exists
-00014740: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-00014750: 2e61 7373 6572 7446 616c 7365 2870 6174  .assertFalse(pat
-00014760: 682e 7061 7265 6e74 2e65 7869 7374 7328  h.parent.exists(
-00014770: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00014780: 6173 7365 7274 4661 6c73 6528 7061 7468  assertFalse(path
-00014790: 2e70 6172 656e 742e 7061 7265 6e74 2e65  .parent.parent.e
-000147a0: 7869 7374 7328 2929 0a0a 2020 2020 6465  xists())..    de
-000147b0: 6620 7465 7374 5f63 6f6e 7461 696e 6572  f test_container
-000147c0: 5f69 7364 6972 5f61 6e64 5f65 7869 7374  _isdir_and_exist
-000147d0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-000147e0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-000147f0: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-00014800: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-00014810: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00014820: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00014830: 700a 2020 2020 2020 2020 2020 2020 636f  p.            co
-00014840: 6e74 6169 6e65 7273 3a0a 2020 2020 2020  ntainers:.      
-00014850: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-00014860: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00014870: 6f75 7263 653a 2066 6f6f 2d69 6d61 6765  ource: foo-image
-00014880: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00014890: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000148a0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-000148b0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-000148c0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-000148d0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-000148e0: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
-000148f0: 6374 2827 666f 6f27 2c20 5472 7565 290a  ct('foo', True).
-00014900: 2020 2020 2020 2020 6320 3d20 6861 726e          c = harn
-00014910: 6573 732e 6d6f 6465 6c2e 756e 6974 2e63  ess.model.unit.c
-00014920: 6f6e 7461 696e 6572 735b 2766 6f6f 275d  ontainers['foo']
-00014930: 0a0a 2020 2020 2020 2020 6469 725f 7061  ..        dir_pa
-00014940: 7468 203d 2027 2f74 6d70 2f66 6f6f 2f64  th = '/tmp/foo/d
-00014950: 6972 270a 2020 2020 2020 2020 6669 6c65  ir'.        file
-00014960: 5f70 6174 6820 3d20 272f 746d 702f 666f  _path = '/tmp/fo
-00014970: 6f2f 6669 6c65 270a 0a20 2020 2020 2020  o/file'..       
-00014980: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
-00014990: 6528 632e 6973 6469 7228 6469 725f 7061  e(c.isdir(dir_pa
-000149a0: 7468 2929 0a20 2020 2020 2020 2073 656c  th)).        sel
-000149b0: 662e 6173 7365 7274 4661 6c73 6528 632e  f.assertFalse(c.
-000149c0: 6578 6973 7473 2864 6972 5f70 6174 6829  exists(dir_path)
-000149d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000149e0: 7373 6572 7446 616c 7365 2863 2e69 7364  ssertFalse(c.isd
-000149f0: 6972 2866 696c 655f 7061 7468 2929 0a20  ir(file_path)). 
-00014a00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00014a10: 7274 4661 6c73 6528 632e 6578 6973 7473  rtFalse(c.exists
-00014a20: 2866 696c 655f 7061 7468 2929 0a0a 2020  (file_path))..  
-00014a30: 2020 2020 2020 632e 6d61 6b65 5f64 6972        c.make_dir
-00014a40: 2864 6972 5f70 6174 682c 206d 616b 655f  (dir_path, make_
-00014a50: 7061 7265 6e74 733d 5472 7565 290a 2020  parents=True).  
-00014a60: 2020 2020 2020 632e 7075 7368 2866 696c        c.push(fil
-00014a70: 655f 7061 7468 2c20 2764 6174 6127 290a  e_path, 'data').
-00014a80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014a90: 7365 7274 5472 7565 2863 2e69 7364 6972  sertTrue(c.isdir
-00014aa0: 2864 6972 5f70 6174 6829 290a 2020 2020  (dir_path)).    
-00014ab0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00014ac0: 7275 6528 632e 6578 6973 7473 2864 6972  rue(c.exists(dir
-00014ad0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
-00014ae0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
-00014af0: 2863 2e69 7364 6972 2866 696c 655f 7061  (c.isdir(file_pa
-00014b00: 7468 2929 0a20 2020 2020 2020 2073 656c  th)).        sel
-00014b10: 662e 6173 7365 7274 5472 7565 2863 2e65  f.assertTrue(c.e
-00014b20: 7869 7374 7328 6669 6c65 5f70 6174 6829  xists(file_path)
-00014b30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00014b40: 6164 645f 6f63 695f 7265 736f 7572 6365  add_oci_resource
-00014b50: 5f63 7573 746f 6d28 7365 6c66 293a 0a20  _custom(self):. 
-00014b60: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00014b70: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-00014b80: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
-00014b90: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
-00014ba0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-00014bb0: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
-00014bc0: 2020 2020 7265 736f 7572 6365 733a 0a20      resources:. 
-00014bd0: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
-00014be0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-00014bf0: 2020 2020 7479 7065 3a20 6f63 692d 696d      type: oci-im
-00014c00: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
-00014c10: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-00014c20: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
-00014c30: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
-00014c40: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00014c50: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00014c60: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00014c70: 2020 2020 2020 6375 7374 6f6d 203d 207b        custom = {
-00014c80: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-00014c90: 6769 7374 7279 7061 7468 223a 2022 6375  gistrypath": "cu
-00014ca0: 7374 6f6d 7061 7468 222c 0a20 2020 2020  stompath",.     
-00014cb0: 2020 2020 2020 2022 7573 6572 6e61 6d65         "username
-00014cc0: 223a 2022 6375 7374 6f6d 5f75 7365 726e  ": "custom_usern
-00014cd0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
-00014ce0: 2020 2270 6173 7377 6f72 6422 3a20 2263    "password": "c
-00014cf0: 7573 746f 6d5f 7061 7373 776f 7264 222c  ustom_password",
-00014d00: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00014d10: 2020 2068 6172 6e65 7373 2e61 6464 5f6f     harness.add_o
-00014d20: 6369 5f72 6573 6f75 7263 6528 2769 6d61  ci_resource('ima
-00014d30: 6765 272c 2063 7573 746f 6d29 0a20 2020  ge', custom).   
-00014d40: 2020 2020 2072 6573 6f75 7263 6520 3d20       resource = 
-00014d50: 6861 726e 6573 732e 6d6f 6465 6c2e 7265  harness.model.re
-00014d60: 736f 7572 6365 732e 6665 7463 6828 2769  sources.fetch('i
-00014d70: 6d61 6765 2729 0a20 2020 2020 2020 2077  mage').        w
-00014d80: 6974 6820 7265 736f 7572 6365 2e6f 7065  ith resource.ope
-00014d90: 6e28 2772 2729 2061 7320 7265 736f 7572  n('r') as resour
-00014da0: 6365 5f66 696c 653a 0a20 2020 2020 2020  ce_file:.       
-00014db0: 2020 2020 2063 6f6e 7465 6e74 7320 3d20       contents = 
-00014dc0: 7961 6d6c 2e73 6166 655f 6c6f 6164 2872  yaml.safe_load(r
-00014dd0: 6573 6f75 7263 655f 6669 6c65 2e72 6561  esource_file.rea
-00014de0: 6428 2929 0a20 2020 2020 2020 2073 656c  d()).        sel
-00014df0: 662e 6173 7365 7274 4571 7561 6c28 636f  f.assertEqual(co
-00014e00: 6e74 656e 7473 5b27 7265 6769 7374 7279  ntents['registry
-00014e10: 7061 7468 275d 2c20 2763 7573 746f 6d70  path'], 'customp
-00014e20: 6174 6827 290a 2020 2020 2020 2020 7365  ath').        se
-00014e30: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00014e40: 6f6e 7465 6e74 735b 2775 7365 726e 616d  ontents['usernam
-00014e50: 6527 5d2c 2027 6375 7374 6f6d 5f75 7365  e'], 'custom_use
-00014e60: 726e 616d 6527 290a 2020 2020 2020 2020  rname').        
-00014e70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00014e80: 2863 6f6e 7465 6e74 735b 2770 6173 7377  (contents['passw
-00014e90: 6f72 6427 5d2c 2027 6375 7374 6f6d 5f70  ord'], 'custom_p
-00014ea0: 6173 7377 6f72 6427 290a 0a20 2020 2064  assword')..    d
-00014eb0: 6566 2074 6573 745f 6164 645f 6f63 695f  ef test_add_oci_
-00014ec0: 7265 736f 7572 6365 5f6e 6f5f 696d 6167  resource_no_imag
-00014ed0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00014ee0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-00014ef0: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-00014f00: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-00014f10: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00014f20: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00014f30: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00014f40: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-00014f50: 2020 2020 2020 2069 6d61 6765 3a0a 2020         image:.  
-00014f60: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-00014f70: 7065 3a20 6669 6c65 0a20 2020 2020 2020  pe: file.       
-00014f80: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-00014f90: 7469 6f6e 3a20 2249 6d61 6765 2074 6f20  tion: "Image to 
-00014fa0: 6465 706c 6f79 2e22 0a20 2020 2020 2020  deploy.".       
-00014fb0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00014fc0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00014fd0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00014fe0: 7029 0a20 2020 2020 2020 2077 6974 6820  p).        with 
-00014ff0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00015000: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-00015010: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-00015020: 6e65 7373 2e61 6464 5f6f 6369 5f72 6573  ness.add_oci_res
-00015030: 6f75 7263 6528 2269 6d61 6765 2229 0a20  ource("image"). 
-00015040: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00015050: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
-00015060: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
-00015070: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-00015080: 2e61 6464 5f6f 6369 5f72 6573 6f75 7263  .add_oci_resourc
-00015090: 6528 226d 6973 7369 6e67 2d72 6573 6f75  e("missing-resou
-000150a0: 7263 6522 290a 2020 2020 2020 2020 7365  rce").        se
-000150b0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-000150c0: 656e 2868 6172 6e65 7373 2e5f 6261 636b  en(harness._back
-000150d0: 656e 642e 5f72 6573 6f75 7263 6573 5f6d  end._resources_m
-000150e0: 6170 292c 2030 290a 0a20 2020 2064 6566  ap), 0)..    def
-000150f0: 2074 6573 745f 6164 645f 7265 736f 7572   test_add_resour
-00015100: 6365 5f75 6e6b 6e6f 776e 2873 656c 6629  ce_unknown(self)
-00015110: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-00015120: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
-00015130: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
-00015140: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-00015150: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00015160: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00015170: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00015180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015190: 696d 6167 653a 0a20 2020 2020 2020 2020  image:.         
-000151a0: 2020 2020 2020 2074 7970 653a 2066 696c         type: fil
-000151b0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000151c0: 2020 6465 7363 7269 7074 696f 6e3a 2022    description: "
-000151d0: 496d 6167 6520 746f 2064 6570 6c6f 792e  Image to deploy.
-000151e0: 220a 2020 2020 2020 2020 2020 2020 2727  ".            ''
-000151f0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00015200: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00015210: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00015220: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00015230: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-00015240: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-00015250: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
-00015260: 645f 7265 736f 7572 6365 2827 756e 6b6e  d_resource('unkn
-00015270: 6f77 6e27 2c20 2763 6f6e 7465 6e74 2729  own', 'content')
-00015280: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-00015290: 6464 5f72 6573 6f75 7263 655f 6275 745f  dd_resource_but_
-000152a0: 6f63 6928 7365 6c66 293a 0a20 2020 2020  oci(self):.     
-000152b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-000152c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-000152d0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
-000152e0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-000152f0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-00015300: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
-00015310: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
-00015320: 2020 2020 2020 2020 2069 6d61 6765 3a0a           image:.
-00015330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015340: 7479 7065 3a20 6f63 692d 696d 6167 650a  type: oci-image.
-00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015360: 6465 7363 7269 7074 696f 6e3a 2022 496d  description: "Im
-00015370: 6167 6520 746f 2064 6570 6c6f 792e 220a  age to deploy.".
-00015380: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00015390: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-000153a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-000153b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-000153c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000153d0: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-000153e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000153f0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-00015400: 7265 736f 7572 6365 2827 696d 6167 6527  resource('image'
-00015410: 2c20 2763 6f6e 7465 6e74 2729 0a0a 2020  , 'content')..  
-00015420: 2020 6465 6620 7465 7374 5f61 6464 5f72    def test_add_r
-00015430: 6573 6f75 7263 655f 7374 7269 6e67 2873  esource_string(s
-00015440: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-00015450: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-00015460: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
-00015470: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-00015480: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00015490: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
-000154a0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-000154b0: 7263 6573 3a0a 2020 2020 2020 2020 2020  rces:.          
-000154c0: 2020 2020 696d 6167 653a 0a20 2020 2020      image:.     
-000154d0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-000154e0: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
-000154f0: 2020 2020 2020 6669 6c65 6e61 6d65 3a20        filename: 
-00015500: 666f 6f2e 7478 740a 2020 2020 2020 2020  foo.txt.        
-00015510: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-00015520: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
-00015530: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
-00015540: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00015550: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-00015560: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-00015570: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00015580: 732e 6164 645f 7265 736f 7572 6365 2827  s.add_resource('
-00015590: 696d 6167 6527 2c20 2766 6f6f 2063 6f6e  image', 'foo con
-000155a0: 7465 6e74 735c 6e27 290a 2020 2020 2020  tents\n').      
-000155b0: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
-000155c0: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
-000155d0: 2e66 6574 6368 2827 696d 6167 6527 290a  .fetch('image').
-000155e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000155f0: 6572 7445 7175 616c 2870 6174 682e 6e61  ertEqual(path.na
-00015600: 6d65 2c20 2766 6f6f 2e74 7874 2729 0a20  me, 'foo.txt'). 
-00015610: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015620: 7274 4571 7561 6c28 7061 7468 2e70 6172  rtEqual(path.par
-00015630: 656e 742e 6e61 6d65 2c20 2769 6d61 6765  ent.name, 'image
-00015640: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-00015650: 7061 7468 2e6f 7065 6e28 2772 7427 2920  path.open('rt') 
-00015660: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00015670: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015680: 616c 2827 666f 6f20 636f 6e74 656e 7473  al('foo contents
-00015690: 5c6e 272c 2066 2e72 6561 6428 2929 0a0a  \n', f.read())..
-000156a0: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
-000156b0: 5f72 6573 6f75 7263 655f 6279 7465 7328  _resource_bytes(
-000156c0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-000156d0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-000156e0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
-000156f0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
-00015700: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00015710: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
-00015720: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-00015730: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
-00015740: 2020 2020 2069 6d61 6765 3a0a 2020 2020       image:.    
-00015750: 2020 2020 2020 2020 2020 2020 7479 7065              type
-00015760: 3a20 6669 6c65 0a20 2020 2020 2020 2020  : file.         
-00015770: 2020 2020 2020 2066 696c 656e 616d 653a         filename:
-00015780: 2066 6f6f 2e7a 6970 0a20 2020 2020 2020   foo.zip.       
-00015790: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-000157a0: 7469 6f6e 3a20 2249 6d61 6765 2074 6f20  tion: "Image to 
-000157b0: 6465 706c 6f79 2e22 0a20 2020 2020 2020  deploy.".       
-000157c0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-000157d0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-000157e0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-000157f0: 7029 0a20 2020 2020 2020 2072 6177 5f63  p).        raw_c
-00015800: 6f6e 7465 6e74 7320 3d20 6227 5c78 6666  ontents = b'\xff
-00015810: 5c78 6666 5c78 3030 626c 6168 5c6e 270a  \xff\x00blah\n'.
-00015820: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00015830: 6164 645f 7265 736f 7572 6365 2827 696d  add_resource('im
-00015840: 6167 6527 2c20 7261 775f 636f 6e74 656e  age', raw_conten
-00015850: 7473 290a 2020 2020 2020 2020 7061 7468  ts).        path
-00015860: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
-00015870: 2e72 6573 6f75 7263 6573 2e66 6574 6368  .resources.fetch
-00015880: 2827 696d 6167 6527 290a 2020 2020 2020  ('image').      
-00015890: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000158a0: 616c 2870 6174 682e 6e61 6d65 2c20 2766  al(path.name, 'f
-000158b0: 6f6f 2e7a 6970 2729 0a20 2020 2020 2020  oo.zip').       
-000158c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000158d0: 6c28 7061 7468 2e70 6172 656e 742e 6e61  l(path.parent.na
-000158e0: 6d65 2c20 2769 6d61 6765 2729 0a20 2020  me, 'image').   
-000158f0: 2020 2020 2077 6974 6820 7061 7468 2e6f       with path.o
-00015900: 7065 6e28 2772 6227 2920 6173 2066 3a0a  pen('rb') as f:.
-00015910: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015920: 2e61 7373 6572 7445 7175 616c 2872 6177  .assertEqual(raw
-00015930: 5f63 6f6e 7465 6e74 732c 2066 2e72 6561  _contents, f.rea
-00015940: 6428 2929 0a0a 2020 2020 6465 6620 7465  d())..    def te
-00015950: 7374 5f61 6464 5f72 6573 6f75 7263 655f  st_add_resource_
-00015960: 756e 6b6e 6f77 6e5f 6669 6c65 6e61 6d65  unknown_filename
-00015970: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00015980: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-00015990: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-000159a0: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-000159b0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-000159c0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-000159d0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000159e0: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-000159f0: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
-00015a00: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-00015a10: 653a 2066 696c 650a 2020 2020 2020 2020  e: file.        
-00015a20: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-00015a30: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
-00015a40: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
-00015a50: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00015a60: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-00015a70: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-00015a80: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00015a90: 732e 6164 645f 7265 736f 7572 6365 2827  s.add_resource('
-00015aa0: 696d 6167 6527 2c20 2766 6f6f 2063 6f6e  image', 'foo con
-00015ab0: 7465 6e74 735c 6e27 290a 2020 2020 2020  tents\n').      
-00015ac0: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
-00015ad0: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
-00015ae0: 2e66 6574 6368 2827 696d 6167 6527 290a  .fetch('image').
-00015af0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015b00: 6572 7445 7175 616c 2870 6174 682e 6e61  ertEqual(path.na
-00015b10: 6d65 2c20 2769 6d61 6765 2729 0a20 2020  me, 'image').   
-00015b20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00015b30: 4571 7561 6c28 7061 7468 2e70 6172 656e  Equal(path.paren
-00015b40: 742e 6e61 6d65 2c20 2769 6d61 6765 2729  t.name, 'image')
-00015b50: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-00015b60: 6574 5f70 6f64 5f73 7065 6328 7365 6c66  et_pod_spec(self
-00015b70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00015b80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-00015b90: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-00015ba0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-00015bb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00015bc0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-00015bd0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00015be0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00015bf0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00015c00: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
-00015c10: 726e 6573 732e 7365 745f 6c65 6164 6572  rness.set_leader
-00015c20: 2854 7275 6529 0a20 2020 2020 2020 2063  (True).        c
-00015c30: 6f6e 7461 696e 6572 5f73 7065 6320 3d20  ontainer_spec = 
-00015c40: 7b27 636f 6e74 6169 6e65 7227 3a20 2773  {'container': 's
-00015c50: 7065 6327 7d0a 2020 2020 2020 2020 6b38  pec'}.        k8
-00015c60: 735f 7265 736f 7572 6365 7320 3d20 7b27  s_resources = {'
-00015c70: 6b38 7327 3a20 2773 7065 6327 7d0a 2020  k8s': 'spec'}.  
-00015c80: 2020 2020 2020 6861 726e 6573 732e 6d6f        harness.mo
-00015c90: 6465 6c2e 706f 642e 7365 745f 7370 6563  del.pod.set_spec
-00015ca0: 2863 6f6e 7461 696e 6572 5f73 7065 632c  (container_spec,
-00015cb0: 206b 3873 5f72 6573 6f75 7263 6573 290a   k8s_resources).
-00015cc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015cd0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-00015ce0: 2e67 6574 5f70 6f64 5f73 7065 6328 292c  .get_pod_spec(),
-00015cf0: 2028 636f 6e74 6169 6e65 725f 7370 6563   (container_spec
-00015d00: 2c20 6b38 735f 7265 736f 7572 6365 7329  , k8s_resources)
-00015d10: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00015d20: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
-00015d30: 616c 5f68 6f6f 6b73 5f6e 6f5f 7265 6c61  al_hooks_no_rela
-00015d40: 7469 6f6e 7328 7365 6c66 293a 0a20 2020  tions(self):.   
-00015d50: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-00015d60: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-00015d70: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
-00015d80: 6d2c 206d 6574 613d 2727 270a 2020 2020  m, meta='''.    
-00015d90: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-00015da0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-00015db0: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
-00015dc0: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
-00015dd0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-00015de0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-00015df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e00: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
-00015e10: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
-00015e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e30: 2020 7479 7065 3a20 7374 7269 6e67 0a20    type: string. 
-00015e40: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00015e50: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00015e60: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00015e70: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00015e80: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-00015e90: 636f 6e66 6967 287b 2766 6f6f 273a 2027  config({'foo': '
-00015ea0: 6261 7227 7d29 0a20 2020 2020 2020 2068  bar'}).        h
-00015eb0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-00015ec0: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
-00015ed0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00015ee0: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
-00015ef0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00015f00: 2020 5f20 3d20 6861 726e 6573 732e 6368    _ = harness.ch
-00015f10: 6172 6d0a 2020 2020 2020 2020 6861 726e  arm.        harn
-00015f20: 6573 732e 6265 6769 6e5f 7769 7468 5f69  ess.begin_with_i
-00015f30: 6e69 7469 616c 5f68 6f6f 6b73 2829 0a20  nitial_hooks(). 
-00015f40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015f50: 7274 4973 4e6f 744e 6f6e 6528 6861 726e  rtIsNotNone(harn
-00015f60: 6573 732e 6368 6172 6d29 0a20 2020 2020  ess.charm).     
-00015f70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00015f80: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-00015f90: 2068 6172 6e65 7373 2e63 6861 726d 2e63   harness.charm.c
-00015fa0: 6861 6e67 6573 2c0a 2020 2020 2020 2020  hanges,.        
-00015fb0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00015fc0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00015fd0: 696e 7374 616c 6c27 7d2c 0a20 2020 2020  install'},.     
-00015fe0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00015ff0: 6527 3a20 276c 6561 6465 722d 656c 6563  e': 'leader-elec
-00016000: 7465 6427 7d2c 0a20 2020 2020 2020 2020  ted'},.         
-00016010: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00016020: 2763 6f6e 6669 672d 6368 616e 6765 6427  'config-changed'
-00016030: 2c20 2764 6174 6127 3a20 7b27 666f 6f27  , 'data': {'foo'
-00016040: 3a20 2762 6172 277d 7d2c 0a20 2020 2020  : 'bar'}},.     
-00016050: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00016060: 6527 3a20 2773 7461 7274 277d 2c0a 2020  e': 'start'},.  
-00016070: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00016080: 2020 2020 290a 0a20 2020 2064 6566 2074      )..    def t
-00016090: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
-000160a0: 6e69 7469 616c 5f68 6f6f 6b73 5f6e 6f5f  nitial_hooks_no_
-000160b0: 7265 6c61 7469 6f6e 735f 6e6f 745f 6c65  relations_not_le
-000160c0: 6164 6572 2873 656c 6629 3a0a 2020 2020  ader(self):.    
-000160d0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-000160e0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-000160f0: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-00016100: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-00016110: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-00016120: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-00016130: 2020 2727 272c 2063 6f6e 6669 673d 2727    ''', config=''
-00016140: 270a 2020 2020 2020 2020 2020 2020 6f70  '.            op
-00016150: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-00016160: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-00016170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016180: 6465 7363 7269 7074 696f 6e3a 2061 2063  description: a c
-00016190: 6f6e 6669 6720 6f70 7469 6f6e 0a20 2020  onfig option.   
-000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161b0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
-000161c0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-000161d0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-000161e0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-000161f0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-00016200: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-00016210: 6f6e 6669 6728 7b27 666f 6f27 3a20 2762  onfig({'foo': 'b
-00016220: 6172 277d 290a 2020 2020 2020 2020 7769  ar'}).        wi
-00016230: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00016240: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
-00016250: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00016260: 5f20 3d20 6861 726e 6573 732e 6368 6172  _ = harness.char
-00016270: 6d0a 2020 2020 2020 2020 6861 726e 6573  m.        harnes
-00016280: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
-00016290: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
-000162a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000162b0: 4973 4e6f 744e 6f6e 6528 6861 726e 6573  IsNotNone(harnes
-000162c0: 732e 6368 6172 6d29 0a20 2020 2020 2020  s.charm).       
-000162d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000162e0: 6c28 0a20 2020 2020 2020 2020 2020 2068  l(.            h
-000162f0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
-00016300: 6e67 6573 2c0a 2020 2020 2020 2020 2020  nges,.          
-00016310: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00016320: 2020 2020 7b27 6e61 6d65 273a 2027 696e      {'name': 'in
-00016330: 7374 616c 6c27 7d2c 0a20 2020 2020 2020  stall'},.       
-00016340: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-00016350: 3a20 276c 6561 6465 722d 7365 7474 696e  : 'leader-settin
-00016360: 6773 2d63 6861 6e67 6564 277d 2c0a 2020  gs-changed'},.  
-00016370: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-00016380: 6e61 6d65 273a 2027 636f 6e66 6967 2d63  name': 'config-c
-00016390: 6861 6e67 6564 272c 2027 6461 7461 273a  hanged', 'data':
-000163a0: 207b 2766 6f6f 273a 2027 6261 7227 7d7d   {'foo': 'bar'}}
-000163b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000163c0: 2020 7b27 6e61 6d65 273a 2027 7374 6172    {'name': 'star
-000163d0: 7427 7d2c 0a20 2020 2020 2020 2020 2020  t'},.           
-000163e0: 205d 0a20 2020 2020 2020 2029 0a0a 2020   ].        )..  
-000163f0: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
-00016400: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
-00016410: 6f6b 735f 7769 7468 5f70 6565 725f 7265  oks_with_peer_re
-00016420: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
-00016430: 2020 2020 2020 636c 6173 7320 5065 6572        class Peer
-00016440: 4368 6172 6d28 5265 6c61 7469 6f6e 4576  Charm(RelationEv
-00016450: 656e 7443 6861 726d 293a 0a20 2020 2020  entCharm):.     
-00016460: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
-00016470: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
-00016480: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
-00016490: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-000164a0: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
-000164b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000164c0: 2020 7365 6c66 2e6f 6273 6572 7665 5f72    self.observe_r
-000164d0: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
-000164e0: 7065 6572 2729 0a20 2020 2020 2020 2068  peer').        h
-000164f0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-00016500: 7469 6e67 2e48 6172 6e65 7373 2850 6565  ting.Harness(Pee
-00016510: 7243 6861 726d 2c20 6d65 7461 3d27 2727  rCharm, meta='''
-00016520: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00016530: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-00016540: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
-00016550: 2020 2020 2020 2020 2020 2020 2070 6565               pee
-00016560: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00016570: 2020 2069 6e74 6572 6661 6365 3a20 6170     interface: ap
-00016580: 702d 7065 6572 0a20 2020 2020 2020 2020  p-peer.         
-00016590: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
-000165a0: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
-000165b0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-000165c0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165e0: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
-000165f0: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
-00016600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016610: 2020 7479 7065 3a20 7374 7269 6e67 0a20    type: string. 
-00016620: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00016630: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00016640: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00016650: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00016660: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-00016670: 636f 6e66 6967 287b 2766 6f6f 273a 2027  config({'foo': '
-00016680: 6261 7227 7d29 0a20 2020 2020 2020 2077  bar'}).        w
-00016690: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000166a0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-000166b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000166c0: 205f 203d 2068 6172 6e65 7373 2e63 6861   _ = harness.cha
-000166d0: 726d 0a20 2020 2020 2020 2068 6172 6e65  rm.        harne
-000166e0: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
-000166f0: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
-00016700: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00016710: 7449 734e 6f74 4e6f 6e65 2868 6172 6e65  tIsNotNone(harne
-00016720: 7373 2e63 6861 726d 290a 2020 2020 2020  ss.charm).      
-00016730: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
-00016740: 7373 2e6d 6f64 656c 2e67 6574 5f72 656c  ss.model.get_rel
-00016750: 6174 696f 6e28 2770 6565 7227 292e 6964  ation('peer').id
-00016760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00016770: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-00016780: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
-00016790: 6861 726d 2e63 6861 6e67 6573 2c0a 2020  harm.changes,.  
-000167a0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-000167b0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-000167c0: 6d65 273a 2027 696e 7374 616c 6c27 7d2c  me': 'install'},
-000167d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000167e0: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
-000167f0: 696f 6e2d 6372 6561 7465 6427 2c0a 2020  ion-created',.  
-00016800: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00016810: 7265 6c61 7469 6f6e 273a 2027 7065 6572  relation': 'peer
-00016820: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00016830: 2020 2020 2764 6174 6127 3a20 7b0a 2020      'data': {.  
-00016840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016850: 2020 2027 7265 6c61 7469 6f6e 5f69 6427     'relation_id'
-00016860: 3a20 7265 6c5f 6964 2c0a 2020 2020 2020  : rel_id,.      
-00016870: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00016880: 756e 6974 273a 204e 6f6e 652c 0a20 2020  unit': None,.   
-00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168a0: 2020 2761 7070 273a 2027 7465 7374 2d61    'app': 'test-a
-000168b0: 7070 272c 0a20 2020 2020 2020 2020 2020  pp',.           
-000168c0: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
-000168d0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-000168e0: 273a 2027 6c65 6164 6572 2d73 6574 7469  ': 'leader-setti
-000168f0: 6e67 732d 6368 616e 6765 6427 7d2c 0a20  ngs-changed'},. 
-00016900: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00016910: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
-00016920: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
-00016930: 3a20 7b27 666f 6f27 3a20 2762 6172 277d  : {'foo': 'bar'}
-00016940: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00016950: 2020 207b 276e 616d 6527 3a20 2773 7461     {'name': 'sta
-00016960: 7274 277d 2c0a 2020 2020 2020 2020 2020  rt'},.          
-00016970: 2020 5d29 0a20 2020 2020 2020 2023 2057    ]).        # W
-00016980: 6974 6820 6120 7369 6e67 6c65 2075 6e69  ith a single uni
-00016990: 742c 206e 6f20 7065 6572 2d72 656c 6174  t, no peer-relat
-000169a0: 696f 6e2d 6a6f 696e 6564 2069 7320 6669  ion-joined is fi
-000169b0: 7265 640a 0a20 2020 2064 6566 2074 6573  red..    def tes
-000169c0: 745f 6265 6769 6e5f 7769 7468 5f69 6e69  t_begin_with_ini
-000169d0: 7469 616c 5f68 6f6f 6b73 5f70 6565 725f  tial_hooks_peer_
-000169e0: 7265 6c61 7469 6f6e 5f70 7265 5f64 6566  relation_pre_def
-000169f0: 696e 6564 2873 656c 6629 3a0a 2020 2020  ined(self):.    
-00016a00: 2020 2020 636c 6173 7320 5065 6572 4368      class PeerCh
-00016a10: 6172 6d28 5265 6c61 7469 6f6e 4576 656e  arm(RelationEven
-00016a20: 7443 6861 726d 293a 0a20 2020 2020 2020  tCharm):.       
-00016a30: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
-00016a40: 5f28 7365 6c66 2c20 6672 616d 6577 6f72  _(self, framewor
-00016a50: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
-00016a60: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00016a70: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
-00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a90: 7365 6c66 2e6f 6273 6572 7665 5f72 656c  self.observe_rel
-00016aa0: 6174 696f 6e5f 6576 656e 7473 2827 7065  ation_events('pe
-00016ab0: 6572 2729 0a20 2020 2020 2020 2068 6172  er').        har
-00016ac0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-00016ad0: 6e67 2e48 6172 6e65 7373 2850 6565 7243  ng.Harness(PeerC
-00016ae0: 6861 726d 2c20 6d65 7461 3d27 2727 0a20  harm, meta='''. 
-00016af0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00016b00: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-00016b10: 2020 2020 2020 7065 6572 733a 0a20 2020        peers:.   
-00016b20: 2020 2020 2020 2020 2020 2070 6565 723a             peer:
-00016b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b40: 2069 6e74 6572 6661 6365 3a20 6170 702d   interface: app-
-00016b50: 7065 6572 0a20 2020 2020 2020 2020 2020  peer.           
-00016b60: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00016b70: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00016b80: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00016b90: 2020 2020 2020 2070 6565 725f 7265 6c5f         peer_rel_
-00016ba0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-00016bb0: 5f72 656c 6174 696f 6e28 2770 6565 7227  _relation('peer'
-00016bc0: 2c20 2774 6573 742d 6170 7027 290a 2020  , 'test-app').  
-00016bd0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-00016be0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
-00016bf0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
-00016c00: 2023 2049 6620 7468 6520 7065 6572 2072   # If the peer r
-00016c10: 656c 6174 696f 6e20 6973 2061 6c72 6561  elation is alrea
-00016c20: 6479 2064 6566 696e 6564 2062 7920 7468  dy defined by th
-00016c30: 6520 7573 6572 2c20 7765 2064 6f6e 2774  e user, we don't
-00016c40: 2063 7265 6174 6520 7468 6520 7265 6c61   create the rela
-00016c50: 7469 6f6e 2061 0a20 2020 2020 2020 2023  tion a.        #
-00016c60: 2073 6563 6f6e 6420 7469 6d65 2c20 6275   second time, bu
-00016c70: 7420 7765 2064 6f20 7374 696c 6c20 6669  t we do still fi
-00016c80: 7265 2072 656c 6174 696f 6e2d 6372 6561  re relation-crea
-00016c90: 7465 642e 0a20 2020 2020 2020 2073 656c  ted..        sel
-00016ca0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00016cb0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-00016cc0: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
-00016cd0: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
-00016ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cf0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
-00016d00: 6c27 7d2c 0a20 2020 2020 2020 2020 2020  l'},.           
-00016d10: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
-00016d20: 656c 6174 696f 6e2d 6372 6561 7465 6427  elation-created'
-00016d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016d40: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
-00016d50: 7065 6572 272c 0a20 2020 2020 2020 2020  peer',.         
-00016d60: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-00016d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00016d80: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-00016d90: 5f69 6427 3a20 7065 6572 5f72 656c 5f69  _id': peer_rel_i
-00016da0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00016db0: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
-00016dc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00016dd0: 2020 2020 2020 2020 2020 2027 6170 7027             'app'
-00016de0: 3a20 2774 6573 742d 6170 7027 2c0a 2020  : 'test-app',.  
-00016df0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00016e00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00016e10: 2020 207b 276e 616d 6527 3a20 276c 6561     {'name': 'lea
-00016e20: 6465 722d 7365 7474 696e 6773 2d63 6861  der-settings-cha
-00016e30: 6e67 6564 277d 2c0a 2020 2020 2020 2020  nged'},.        
-00016e40: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00016e50: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
-00016e60: 272c 2027 6461 7461 273a 207b 7d7d 2c0a  ', 'data': {}},.
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e80: 7b27 6e61 6d65 273a 2027 7374 6172 7427  {'name': 'start'
-00016e90: 7d2c 0a20 2020 2020 2020 2020 2020 205d  },.            ]
-00016ea0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00016eb0: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
-00016ec0: 616c 5f68 6f6f 6b73 5f72 656c 6174 696f  al_hooks_relatio
-00016ed0: 6e5f 6368 6172 6d5f 7769 7468 5f6e 6f5f  n_charm_with_no_
-00016ee0: 7265 6c61 7469 6f6e 2873 656c 6629 3a0a  relation(self):.
-00016ef0: 2020 2020 2020 2020 636c 6173 7320 4368          class Ch
-00016f00: 6172 6d57 6974 6844 4228 5265 6c61 7469  armWithDB(Relati
-00016f10: 6f6e 4576 656e 7443 6861 726d 293a 0a20  onEventCharm):. 
-00016f20: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-00016f30: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
-00016f40: 616d 6577 6f72 6b29 3a0a 2020 2020 2020  amework):.      
-00016f50: 2020 2020 2020 2020 2020 7375 7065 7228            super(
-00016f60: 292e 5f5f 696e 6974 5f5f 2866 7261 6d65  ).__init__(frame
-00016f70: 776f 726b 290a 2020 2020 2020 2020 2020  work).          
-00016f80: 2020 2020 2020 7365 6c66 2e6f 6273 6572        self.obser
-00016f90: 7665 5f72 656c 6174 696f 6e5f 6576 656e  ve_relation_even
-00016fa0: 7473 2827 6462 2729 0a20 2020 2020 2020  ts('db').       
-00016fb0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-00016fc0: 6573 7469 6e67 2e48 6172 6e65 7373 2843  esting.Harness(C
-00016fd0: 6861 726d 5769 7468 4442 2c20 6d65 7461  harmWithDB, meta
-00016fe0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00016ff0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
-00017000: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-00017010: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
-00017020: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00017030: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-00017040: 653a 2073 716c 0a20 2020 2020 2020 2020  e: sql.         
-00017050: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00017060: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00017070: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00017080: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00017090: 2e73 6574 5f6c 6561 6465 7228 290a 2020  .set_leader().  
-000170a0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-000170b0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
-000170c0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
-000170d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000170e0: 6c28 0a20 2020 2020 2020 2020 2020 2068  l(.            h
-000170f0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
-00017100: 6e67 6573 2c0a 2020 2020 2020 2020 2020  nges,.          
-00017110: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00017120: 2020 2020 7b27 6e61 6d65 273a 2027 696e      {'name': 'in
-00017130: 7374 616c 6c27 7d2c 0a20 2020 2020 2020  stall'},.       
-00017140: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-00017150: 3a20 276c 6561 6465 722d 656c 6563 7465  : 'leader-electe
-00017160: 6427 7d2c 0a20 2020 2020 2020 2020 2020  d'},.           
-00017170: 2020 2020 207b 276e 616d 6527 3a20 2763       {'name': 'c
-00017180: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
-00017190: 2764 6174 6127 3a20 7b7d 7d2c 0a20 2020  'data': {}},.   
-000171a0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-000171b0: 616d 6527 3a20 2773 7461 7274 277d 2c0a  ame': 'start'},.
-000171c0: 2020 2020 2020 2020 2020 2020 5d29 0a0a              ])..
-000171d0: 2020 2020 6465 6620 7465 7374 5f62 6567      def test_beg
-000171e0: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
-000171f0: 686f 6f6b 735f 7769 7468 5f6f 6e65 5f72  hooks_with_one_r
-00017200: 656c 6174 696f 6e28 7365 6c66 293a 0a20  elation(self):. 
-00017210: 2020 2020 2020 2063 6c61 7373 2043 6861         class Cha
-00017220: 726d 5769 7468 4442 2852 656c 6174 696f  rmWithDB(Relatio
-00017230: 6e45 7665 6e74 4368 6172 6d29 3a0a 2020  nEventCharm):.  
-00017240: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
-00017250: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
-00017260: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
-00017270: 2020 2020 2020 2020 2073 7570 6572 2829           super()
-00017280: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-00017290: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
-000172a0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-000172b0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-000172c0: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
-000172d0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-000172e0: 7374 696e 672e 4861 726e 6573 7328 4368  sting.Harness(Ch
-000172f0: 6172 6d57 6974 6844 422c 206d 6574 613d  armWithDB, meta=
-00017300: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00017310: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
-00017320: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-00017330: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-00017340: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-00017350: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-00017360: 3a20 7371 6c0a 2020 2020 2020 2020 2020  : sql.          
-00017370: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-00017380: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00017390: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-000173a0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000173b0: 7365 745f 6c65 6164 6572 2829 0a20 2020  set_leader().   
-000173c0: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
-000173d0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-000173e0: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
-000173f0: 6573 716c 2729 0a20 2020 2020 2020 2068  esql').        h
-00017400: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00017410: 696f 6e5f 756e 6974 2872 656c 5f69 642c  ion_unit(rel_id,
-00017420: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
-00017430: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00017440: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-00017450: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
-00017460: 6f73 7467 7265 7371 6c2f 3027 2c20 7b27  ostgresql/0', {'
-00017470: 6e65 7727 3a20 2764 6174 6127 7d29 0a20  new': 'data'}). 
-00017480: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00017490: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
-000174a0: 6c5f 686f 6f6b 7328 290a 2020 2020 2020  l_hooks().      
-000174b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000174c0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-000174d0: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
-000174e0: 616e 6765 732c 0a20 2020 2020 2020 2020  anges,.         
-000174f0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00017500: 2020 2020 207b 276e 616d 6527 3a20 2769       {'name': 'i
-00017510: 6e73 7461 6c6c 277d 2c0a 2020 2020 2020  nstall'},.      
-00017520: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00017530: 273a 2027 7265 6c61 7469 6f6e 2d63 7265  ': 'relation-cre
-00017540: 6174 6564 272c 0a20 2020 2020 2020 2020  ated',.         
-00017550: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
-00017560: 6e27 3a20 2764 6227 2c0a 2020 2020 2020  n': 'db',.      
-00017570: 2020 2020 2020 2020 2020 2027 6461 7461             'data
-00017580: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00017590: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-000175a0: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
-000175b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000175c0: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
-000175d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000175e0: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
-000175f0: 2770 6f73 7467 7265 7371 6c27 2c0a 2020  'postgresql',.  
-00017600: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00017610: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00017620: 2020 207b 276e 616d 6527 3a20 276c 6561     {'name': 'lea
-00017630: 6465 722d 656c 6563 7465 6427 7d2c 0a20  der-elected'},. 
-00017640: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00017650: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
-00017660: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
-00017670: 3a20 7b7d 7d2c 0a20 2020 2020 2020 2020  : {}},.         
-00017680: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00017690: 2773 7461 7274 277d 2c0a 2020 2020 2020  'start'},.      
-000176a0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-000176b0: 273a 2027 7265 6c61 7469 6f6e 2d6a 6f69  ': 'relation-joi
-000176c0: 6e65 6427 2c0a 2020 2020 2020 2020 2020  ned',.          
-000176d0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-000176e0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
-000176f0: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-00017700: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00017710: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-00017720: 6f6e 5f69 6427 3a20 7265 6c5f 6964 2c0a  on_id': rel_id,.
-00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017740: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
-00017750: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
-00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017770: 2020 2761 7070 273a 2027 706f 7374 6772    'app': 'postgr
-00017780: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
-00017790: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
-000177a0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-000177b0: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
-000177c0: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
-000177d0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-000177e0: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-000177f0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-00017800: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
-00017810: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-00017820: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-00017830: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00017840: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
-00017850: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
-00017860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017870: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00017880: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00017890: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
-000178a0: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
-000178b0: 2020 2064 6566 2074 6573 745f 6265 6769     def test_begi
-000178c0: 6e5f 7769 7468 5f69 6e69 7469 616c 5f68  n_with_initial_h
-000178d0: 6f6f 6b73 5f77 6974 685f 6170 706c 6963  ooks_with_applic
-000178e0: 6174 696f 6e5f 6461 7461 2873 656c 6629  ation_data(self)
-000178f0: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
-00017900: 4368 6172 6d57 6974 6844 4228 5265 6c61  CharmWithDB(Rela
-00017910: 7469 6f6e 4576 656e 7443 6861 726d 293a  tionEventCharm):
-00017920: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
-00017930: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00017940: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
-00017950: 2020 2020 2020 2020 2020 2020 7375 7065              supe
-00017960: 7228 292e 5f5f 696e 6974 5f5f 2866 7261  r().__init__(fra
-00017970: 6d65 776f 726b 290a 2020 2020 2020 2020  mework).        
-00017980: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
-00017990: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
-000179a0: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
-000179b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-000179c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-000179d0: 2843 6861 726d 5769 7468 4442 2c20 6d65  (CharmWithDB, me
-000179e0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-000179f0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00017a00: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00017a10: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00017a20: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00017a30: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00017a40: 6163 653a 2073 716c 0a20 2020 2020 2020  ace: sql.       
-00017a50: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00017a60: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00017a70: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00017a80: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-00017a90: 7373 2e73 6574 5f6c 6561 6465 7228 290a  ss.set_leader().
-00017aa0: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
-00017ab0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00017ac0: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-00017ad0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-00017ae0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-00017af0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00017b00: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00017b10: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
-00017b20: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00017b30: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00017b40: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
-00017b50: 207b 276e 6577 273a 2027 6461 7461 277d   {'new': 'data'}
-00017b60: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00017b70: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00017b80: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
-00017b90: 706f 7374 6772 6573 716c 272c 207b 2761  postgresql', {'a
-00017ba0: 7070 273a 2027 6461 7461 277d 290a 2020  pp': 'data'}).  
-00017bb0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-00017bc0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
-00017bd0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
-00017be0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00017bf0: 6c28 0a20 2020 2020 2020 2020 2020 205b  l(.            [
-00017c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017c10: 207b 276e 616d 6527 3a20 2769 6e73 7461   {'name': 'insta
-00017c20: 6c6c 277d 2c0a 2020 2020 2020 2020 2020  ll'},.          
-00017c30: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00017c40: 7265 6c61 7469 6f6e 2d63 7265 6174 6564  relation-created
-00017c50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017c60: 2020 2020 2772 656c 6174 696f 6e27 3a20      'relation': 
-00017c70: 2764 6227 2c0a 2020 2020 2020 2020 2020  'db',.          
-00017c80: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
-00017c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017ca0: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
-00017cb0: 6964 273a 2072 656c 5f69 642c 0a20 2020  id': rel_id,.   
-00017cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cd0: 2020 2775 6e69 7427 3a20 4e6f 6e65 2c0a    'unit': None,.
-00017ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cf0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00017d00: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00017d10: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
-00017d20: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00017d30: 276e 616d 6527 3a20 276c 6561 6465 722d  'name': 'leader-
-00017d40: 656c 6563 7465 6427 7d2c 0a20 2020 2020  elected'},.     
-00017d50: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00017d60: 6527 3a20 2763 6f6e 6669 672d 6368 616e  e': 'config-chan
-00017d70: 6765 6427 2c20 2764 6174 6127 3a20 7b7d  ged', 'data': {}
-00017d80: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00017d90: 2020 207b 276e 616d 6527 3a20 2773 7461     {'name': 'sta
-00017da0: 7274 277d 2c0a 2020 2020 2020 2020 2020  rt'},.          
-00017db0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00017dc0: 7265 6c61 7469 6f6e 2d63 6861 6e67 6564  relation-changed
-00017dd0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017de0: 2020 2020 2772 656c 6174 696f 6e27 3a20      'relation': 
-00017df0: 2764 6227 2c0a 2020 2020 2020 2020 2020  'db',.          
-00017e00: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
-00017e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017e20: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
-00017e30: 6964 273a 2072 656c 5f69 642c 0a20 2020  id': rel_id,.   
-00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e50: 2020 2775 6e69 7427 3a20 4e6f 6e65 2c0a    'unit': None,.
-00017e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e70: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00017e80: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00017e90: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
-00017ea0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00017eb0: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
-00017ec0: 6e2d 6a6f 696e 6564 272c 0a20 2020 2020  n-joined',.     
-00017ed0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-00017ee0: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
-00017ef0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00017f00: 6461 7461 273a 207b 0a20 2020 2020 2020  data': {.       
-00017f10: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00017f20: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
-00017f30: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00017f40: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
-00017f50: 3a20 2770 6f73 7467 7265 7371 6c2f 3027  : 'postgresql/0'
-00017f60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017f70: 2020 2020 2020 2027 6170 7027 3a20 2770         'app': 'p
-00017f80: 6f73 7467 7265 7371 6c27 2c0a 2020 2020  ostgresql',.    
-00017f90: 2020 2020 2020 2020 2020 2020 207d 7d2c               }},
-00017fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fb0: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
-00017fc0: 696f 6e2d 6368 616e 6765 6427 2c0a 2020  ion-changed',.  
-00017fd0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00017fe0: 7265 6c61 7469 6f6e 273a 2027 6462 272c  relation': 'db',
-00017ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018000: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
+0000c1a0: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
+0000c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1c0: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c1e0: 2020 2020 2020 2020 2074 6869 7264 3a0a           third:.
+0000c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c200: 2020 2020 2020 2020 2020 2020 7479 7065              type
+0000c210: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
+0000c220: 2020 2020 2020 2020 2020 2020 2027 2727               '''
+0000c230: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c240: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000c250: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0000c260: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
+0000c270: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
+0000c280: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
+0000c290: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+0000c2a0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
+0000c2b0: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
+0000c2c0: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
+0000c2d0: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
+0000c2e0: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
+0000c2f0: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
+0000c300: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
+0000c310: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000c320: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000c330: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000c340: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
+0000c350: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000c360: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000c370: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000c380: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000c390: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000c3a0: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000c3b0: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000c3c0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000c3d0: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
+0000c3e0: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
+0000c3f0: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
+0000c400: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
+0000c410: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
+0000c420: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
+0000c430: 2020 2020 2020 2068 6172 6e65 7373 2e64         harness.d
+0000c440: 6973 6162 6c65 5f68 6f6f 6b73 2829 0a20  isable_hooks(). 
+0000c450: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
+0000c460: 7064 6174 655f 636f 6e66 6967 287b 2774  pdate_config({'t
+0000c470: 6869 7264 273a 2027 3327 7d29 0a20 2020  hird': '3'}).   
+0000c480: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c490: 4571 7561 6c28 6861 726e 6573 732e 6368  Equal(harness.ch
+0000c4a0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
+0000c4b0: 7265 7365 743d 5472 7565 292c 205b 5d29  reset=True), [])
+0000c4c0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000c4d0: 2e65 6e61 626c 655f 686f 6f6b 7328 290a  .enable_hooks().
+0000c4e0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000c4f0: 7570 6461 7465 5f63 6f6e 6669 6728 7b27  update_config({'
+0000c500: 7661 6c75 6527 3a20 2766 6f75 7274 6827  value': 'fourth'
+0000c510: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+0000c520: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+0000c530: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+0000c540: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
+0000c550: 6573 2872 6573 6574 3d54 7275 6529 2c0a  es(reset=True),.
+0000c560: 2020 2020 2020 2020 2020 2020 5b7b 276e              [{'n
+0000c570: 616d 6527 3a20 2763 6f6e 6669 672d 6368  ame': 'config-ch
+0000c580: 616e 6765 6427 2c20 2764 6174 6127 3a20  anged', 'data': 
+0000c590: 7b27 7661 6c75 6527 3a20 2766 6f75 7274  {'value': 'fourt
+0000c5a0: 6827 2c20 2774 6869 7264 273a 2027 3327  h', 'third': '3'
+0000c5b0: 7d7d 5d29 0a0a 2020 2020 6465 6620 7465  }}])..    def te
+0000c5c0: 7374 5f68 6f6f 6b73 5f64 6973 6162 6c65  st_hooks_disable
+0000c5d0: 645f 636f 6e74 6578 746d 616e 6167 6572  d_contextmanager
+0000c5e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000c5f0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000c600: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+0000c610: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
+0000c620: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0000c630: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0000c640: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
+0000c650: 2020 2020 2020 2020 2727 272c 2063 6f6e          ''', con
+0000c660: 6669 673d 2727 270a 2020 2020 2020 2020  fig='''.        
+0000c670: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
+0000c680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c690: 2020 2020 2076 616c 7565 3a0a 2020 2020       value:.    
+0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6b0: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c6d0: 2020 2020 2074 6869 7264 3a0a 2020 2020       third:.    
+0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6f0: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c700: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0000c710: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c720: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000c730: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0000c740: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
+0000c750: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
+0000c760: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
+0000c770: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+0000c780: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
+0000c790: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
+0000c7a0: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
+0000c7b0: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
+0000c7c0: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
+0000c7d0: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
+0000c7e0: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
+0000c7f0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000c800: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000c810: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000c820: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
+0000c830: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000c840: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000c850: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000c860: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000c870: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000c880: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000c890: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000c8a0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000c8b0: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
+0000c8c0: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
+0000c8d0: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
+0000c8e0: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
+0000c8f0: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
+0000c900: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
+0000c910: 2020 2020 2020 2077 6974 6820 6861 726e         with harn
+0000c920: 6573 732e 686f 6f6b 735f 6469 7361 626c  ess.hooks_disabl
+0000c930: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
+0000c940: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+0000c950: 5f63 6f6e 6669 6728 7b27 7468 6972 6427  _config({'third'
+0000c960: 3a20 2733 277d 290a 2020 2020 2020 2020  : '3'}).        
+0000c970: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c980: 2868 6172 6e65 7373 2e63 6861 726d 2e67  (harness.charm.g
+0000c990: 6574 5f63 6861 6e67 6573 2872 6573 6574  et_changes(reset
+0000c9a0: 3d54 7275 6529 2c20 5b5d 290a 2020 2020  =True), []).    
+0000c9b0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000c9c0: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000c9d0: 6527 3a20 2766 6f75 7274 6827 7d29 0a20  e': 'fourth'}). 
+0000c9e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000c9f0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000ca00: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000ca10: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000ca20: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000ca30: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000ca40: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000ca50: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000ca60: 6c75 6527 3a20 2766 6f75 7274 6827 2c20  lue': 'fourth', 
+0000ca70: 2774 6869 7264 273a 2027 3327 7d7d 5d29  'third': '3'}}])
+0000ca80: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
+0000ca90: 6f6f 6b73 5f64 6973 6162 6c65 645f 6e65  ooks_disabled_ne
+0000caa0: 7374 6564 5f63 6f6e 7465 7874 6d61 6e61  sted_contextmana
+0000cab0: 6765 7228 7365 6c66 293a 0a20 2020 2020  ger(self):.     
+0000cac0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000cad0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000cae0: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
+0000caf0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0000cb00: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0000cb10: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+0000cb20: 2020 2020 2020 2027 2727 2c20 636f 6e66         ''', conf
+0000cb30: 6967 3d27 2727 0a20 2020 2020 2020 2020  ig='''.         
+0000cb40: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
+0000cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb60: 2020 2020 6669 6674 683a 0a20 2020 2020      fifth:.     
+0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb80: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cba0: 2020 2020 7369 7874 683a 0a20 2020 2020      sixth:.     
+0000cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbc0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbe0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0000cbf0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0000cc00: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0000cc10: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0000cc20: 6769 6e28 290a 2020 2020 2020 2020 2320  gin().        # 
+0000cc30: 436f 6e74 6578 7420 6d61 6e61 6765 7220  Context manager 
+0000cc40: 6361 6e20 6265 206e 6573 7465 642c 2073  can be nested, s
+0000cc50: 6f20 6120 7465 7374 2075 7369 6e67 2069  o a test using i
+0000cc60: 7420 6361 6e20 696e 766f 6b65 2061 2068  t can invoke a h
+0000cc70: 656c 7065 7220 7573 696e 6720 6974 2e0a  elper using it..
+0000cc80: 2020 2020 2020 2020 7769 7468 2068 6172          with har
+0000cc90: 6e65 7373 2e68 6f6f 6b73 5f64 6973 6162  ness.hooks_disab
+0000cca0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
+0000ccb0: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
+0000ccc0: 686f 6f6b 735f 6469 7361 626c 6564 2829  hooks_disabled()
+0000ccd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cce0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+0000ccf0: 5f63 6f6e 6669 6728 7b27 6669 6674 6827  _config({'fifth'
+0000cd00: 3a20 2735 277d 290a 2020 2020 2020 2020  : '5'}).        
+0000cd10: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000cd20: 7465 5f63 6f6e 6669 6728 7b27 7369 7874  te_config({'sixt
+0000cd30: 6827 3a20 2736 277d 290a 2020 2020 2020  h': '6'}).      
+0000cd40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000cd50: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
+0000cd60: 2e67 6574 5f63 6861 6e67 6573 2872 6573  .get_changes(res
+0000cd70: 6574 3d54 7275 6529 2c20 5b5d 290a 0a20  et=True), []).. 
+0000cd80: 2020 2064 6566 2074 6573 745f 686f 6f6b     def test_hook
+0000cd90: 735f 6469 7361 626c 6564 5f6e 6f6f 7028  s_disabled_noop(
+0000cda0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0000cdb0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0000cdc0: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
+0000cdd0: 6f72 6469 6e67 4368 6172 6d2c 206d 6574  ordingCharm, met
+0000cde0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000cdf0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0000ce00: 2d63 6861 726d 0a20 2020 2020 2020 2020  -charm.         
+0000ce10: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
+0000ce20: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
+0000ce30: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+0000ce40: 2020 2020 2020 2020 7365 7665 6e74 683a          seventh:
+0000ce50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ce60: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
+0000ce70: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+0000ce80: 2020 6569 6768 7468 3a0a 2020 2020 2020    eighth:.      
+0000ce90: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+0000cea0: 7065 3a20 7374 7269 6e67 0a20 2020 2020  pe: string.     
+0000ceb0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0000cec0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0000ced0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0000cee0: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
+0000cef0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0000cf00: 2020 2020 2023 2049 6620 686f 6f6b 7320       # If hooks 
+0000cf10: 6172 6520 616c 7265 6164 7920 6469 7361  are already disa
+0000cf20: 626c 6564 2c20 6974 2069 7320 6120 6e6f  bled, it is a no
+0000cf30: 206f 702c 2061 6e64 206f 6e20 6578 6974   op, and on exit
+0000cf40: 2068 6f6f 6b73 2072 656d 6169 6e20 6469   hooks remain di
+0000cf50: 7361 626c 6564 2e0a 2020 2020 2020 2020  sabled..        
+0000cf60: 6861 726e 6573 732e 6469 7361 626c 655f  harness.disable_
+0000cf70: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
+0000cf80: 7769 7468 2068 6172 6e65 7373 2e68 6f6f  with harness.hoo
+0000cf90: 6b73 5f64 6973 6162 6c65 6428 293a 0a20  ks_disabled():. 
+0000cfa0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+0000cfb0: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
+0000cfc0: 287b 2773 6576 656e 7468 273a 2027 3727  ({'seventh': '7'
+0000cfd0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
+0000cfe0: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
+0000cff0: 287b 2765 6967 6874 6827 3a20 2738 277d  ({'eighth': '8'}
+0000d000: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000d010: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+0000d020: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+0000d030: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
+0000d040: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+0000d050: 6573 745f 6d65 7461 6461 7461 5f66 726f  est_metadata_fro
+0000d060: 6d5f 6469 7265 6374 6f72 7928 7365 6c66  m_directory(self
+0000d070: 293a 0a20 2020 2020 2020 2074 6d70 203d  ):.        tmp =
+0000d080: 2070 6174 686c 6962 2e50 6174 6828 7465   pathlib.Path(te
+0000d090: 6d70 6669 6c65 2e6d 6b64 7465 6d70 2829  mpfile.mkdtemp()
+0000d0a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000d0b0: 6464 436c 6561 6e75 7028 7368 7574 696c  ddCleanup(shutil
+0000d0c0: 2e72 6d74 7265 652c 2073 7472 2874 6d70  .rmtree, str(tmp
+0000d0d0: 2929 0a20 2020 2020 2020 206d 6574 6164  )).        metad
+0000d0e0: 6174 615f 6669 6c65 6e61 6d65 203d 2074  ata_filename = t
+0000d0f0: 6d70 202f 2027 6d65 7461 6461 7461 2e79  mp / 'metadata.y
+0000d100: 616d 6c27 0a20 2020 2020 2020 2077 6974  aml'.        wit
+0000d110: 6820 6d65 7461 6461 7461 5f66 696c 656e  h metadata_filen
+0000d120: 616d 652e 6f70 656e 2827 7774 2729 2061  ame.open('wt') a
+0000d130: 7320 6d65 7461 6461 7461 3a0a 2020 2020  s metadata:.    
+0000d140: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+0000d150: 2e77 7269 7465 2874 6578 7477 7261 702e  .write(textwrap.
+0000d160: 6465 6465 6e74 2827 2727 0a20 2020 2020  dedent('''.     
+0000d170: 2020 2020 2020 206e 616d 653a 206d 792d         name: my-
+0000d180: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+0000d190: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+0000d1a0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1c0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+0000d1d0: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+0000d1e0: 2027 2727 2929 0a20 2020 2020 2020 2068   ''')).        h
+0000d1f0: 6172 6e65 7373 203d 2073 656c 662e 5f67  arness = self._g
+0000d200: 6574 5f64 756d 6d79 5f63 6861 726d 5f68  et_dummy_charm_h
+0000d210: 6172 6e65 7373 2874 6d70 290a 2020 2020  arness(tmp).    
+0000d220: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+0000d230: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+0000d240: 2e61 7373 6572 7445 7175 616c 286c 6973  .assertEqual(lis
+0000d250: 7428 6861 726e 6573 732e 6d6f 6465 6c2e  t(harness.model.
+0000d260: 7265 6c61 7469 6f6e 7329 2c20 5b27 6462  relations), ['db
+0000d270: 275d 290a 2020 2020 2020 2020 2320 5468  ']).        # Th
+0000d280: 6520 6368 6172 6d5f 6469 7220 616c 736f  e charm_dir also
+0000d290: 2067 6574 7320 7365 740a 2020 2020 2020   gets set.      
+0000d2a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000d2b0: 616c 2868 6172 6e65 7373 2e66 7261 6d65  al(harness.frame
+0000d2c0: 776f 726b 2e63 6861 726d 5f64 6972 2c20  work.charm_dir, 
+0000d2d0: 746d 7029 0a0a 2020 2020 6465 6620 7465  tmp)..    def te
+0000d2e0: 7374 5f6d 6574 6164 6174 615f 6672 6f6d  st_metadata_from
+0000d2f0: 5f64 6972 6563 746f 7279 5f63 6861 726d  _directory_charm
+0000d300: 6372 6166 745f 7961 6d6c 2873 656c 6629  craft_yaml(self)
+0000d310: 3a0a 2020 2020 2020 2020 746d 7020 3d20  :.        tmp = 
+0000d320: 7061 7468 6c69 622e 5061 7468 2874 656d  pathlib.Path(tem
+0000d330: 7066 696c 652e 6d6b 6474 656d 7028 2929  pfile.mkdtemp())
+0000d340: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0000d350: 6443 6c65 616e 7570 2873 6875 7469 6c2e  dCleanup(shutil.
+0000d360: 726d 7472 6565 2c20 746d 7029 0a20 2020  rmtree, tmp).   
+0000d370: 2020 2020 2063 6861 726d 6372 6166 745f       charmcraft_
+0000d380: 6669 6c65 6e61 6d65 203d 2074 6d70 202f  filename = tmp /
+0000d390: 2027 6368 6172 6d63 7261 6674 2e79 616d   'charmcraft.yam
+0000d3a0: 6c27 0a20 2020 2020 2020 2063 6861 726d  l'.        charm
+0000d3b0: 6372 6166 745f 6669 6c65 6e61 6d65 2e77  craft_filename.w
+0000d3c0: 7269 7465 5f74 6578 7428 7465 7874 7772  rite_text(textwr
+0000d3d0: 6170 2e64 6564 656e 7428 2727 270a 2020  ap.dedent('''.  
+0000d3e0: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
+0000d3f0: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+0000d400: 2020 6261 7365 733a 0a20 2020 2020 2020    bases:.       
+0000d410: 2020 2020 2020 202d 2062 7569 6c64 2d6f         - build-o
+0000d420: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0000d430: 2020 202d 206e 616d 653a 2075 6275 6e74     - name: ubunt
+0000d440: 750a 2020 2020 2020 2020 2020 2020 2020  u.              
+0000d450: 2020 2020 6368 616e 6e65 6c3a 2022 3232      channel: "22
+0000d460: 2e30 3422 0a20 2020 2020 2020 2020 2020  .04".           
+0000d470: 2020 2020 2072 756e 2d6f 6e3a 0a20 2020       run-on:.   
+0000d480: 2020 2020 2020 2020 2020 2020 202d 206e               - n
+0000d490: 616d 653a 2075 6275 6e74 750a 2020 2020  ame: ubuntu.    
+0000d4a0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0000d4b0: 616e 6e65 6c3a 2022 3232 2e30 3422 0a0a  annel: "22.04"..
+0000d4c0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000d4d0: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
+0000d4e0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+0000d4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d500: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+0000d510: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+0000d520: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+0000d530: 2020 2020 2020 2727 2729 290a 2020 2020        ''')).    
+0000d540: 2020 2020 6861 726e 6573 7320 3d20 7365      harness = se
+0000d550: 6c66 2e5f 6765 745f 6475 6d6d 795f 6368  lf._get_dummy_ch
+0000d560: 6172 6d5f 6861 726e 6573 7328 746d 7029  arm_harness(tmp)
+0000d570: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000d580: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+0000d590: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000d5a0: 6c28 6c69 7374 2868 6172 6e65 7373 2e6d  l(list(harness.m
+0000d5b0: 6f64 656c 2e72 656c 6174 696f 6e73 292c  odel.relations),
+0000d5c0: 205b 2764 6227 5d29 0a20 2020 2020 2020   ['db']).       
+0000d5d0: 2023 2054 6865 2063 6861 726d 5f64 6972   # The charm_dir
+0000d5e0: 2061 6c73 6f20 6765 7473 2073 6574 0a20   also gets set. 
+0000d5f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d600: 7274 4571 7561 6c28 6861 726e 6573 732e  rtEqual(harness.
+0000d610: 6672 616d 6577 6f72 6b2e 6368 6172 6d5f  framework.charm_
+0000d620: 6469 722c 2074 6d70 290a 0a20 2020 2064  dir, tmp)..    d
+0000d630: 6566 2074 6573 745f 636f 6e66 6967 5f66  ef test_config_f
+0000d640: 726f 6d5f 6469 7265 6374 6f72 7928 7365  rom_directory(se
+0000d650: 6c66 293a 0a20 2020 2020 2020 2074 6d70  lf):.        tmp
+0000d660: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+0000d670: 7465 6d70 6669 6c65 2e6d 6b64 7465 6d70  tempfile.mkdtemp
+0000d680: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+0000d690: 2e61 6464 436c 6561 6e75 7028 7368 7574  .addCleanup(shut
+0000d6a0: 696c 2e72 6d74 7265 652c 2073 7472 2874  il.rmtree, str(t
+0000d6b0: 6d70 2929 0a20 2020 2020 2020 2063 6f6e  mp)).        con
+0000d6c0: 6669 675f 6669 6c65 6e61 6d65 203d 2074  fig_filename = t
+0000d6d0: 6d70 202f 2027 636f 6e66 6967 2e79 616d  mp / 'config.yam
+0000d6e0: 6c27 0a20 2020 2020 2020 2077 6974 6820  l'.        with 
+0000d6f0: 636f 6e66 6967 5f66 696c 656e 616d 652e  config_filename.
+0000d700: 6f70 656e 2827 7774 2729 2061 7320 636f  open('wt') as co
+0000d710: 6e66 6967 3a0a 2020 2020 2020 2020 2020  nfig:.          
+0000d720: 2020 636f 6e66 6967 2e77 7269 7465 2874    config.write(t
+0000d730: 6578 7477 7261 702e 6465 6465 6e74 2827  extwrap.dedent('
+0000d740: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
+0000d750: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+0000d760: 2020 2020 2020 2020 6f70 745f 7374 723a          opt_str:
+0000d770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d780: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
+0000d790: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+0000d7a0: 2020 2020 2020 6465 6661 756c 743a 2022        default: "
+0000d7b0: 7661 6c22 0a20 2020 2020 2020 2020 2020  val".           
+0000d7c0: 2020 2020 206f 7074 5f73 7472 5f65 6d70       opt_str_emp
+0000d7d0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+0000d7e0: 2020 2020 2020 2020 7479 7065 3a20 7374          type: st
+0000d7f0: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
+0000d800: 2020 2020 2020 2020 2064 6566 6175 6c74           default
+0000d810: 3a20 2222 0a20 2020 2020 2020 2020 2020  : "".           
+0000d820: 2020 2020 206f 7074 5f6e 756c 6c3a 0a20       opt_null:. 
+0000d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d840: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d860: 2020 2020 6465 6661 756c 743a 206e 756c      default: nul
+0000d870: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+0000d880: 2020 6f70 745f 626f 6f6c 3a0a 2020 2020    opt_bool:.    
+0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8a0: 7479 7065 3a20 626f 6f6c 6561 6e0a 2020  type: boolean.  
+0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8c0: 2020 6465 6661 756c 743a 2074 7275 650a    default: true.
+0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8e0: 6f70 745f 696e 743a 0a20 2020 2020 2020  opt_int:.       
+0000d8f0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+0000d900: 653a 2069 6e74 0a20 2020 2020 2020 2020  e: int.         
+0000d910: 2020 2020 2020 2020 2020 2064 6566 6175             defau
+0000d920: 6c74 3a20 310a 2020 2020 2020 2020 2020  lt: 1.          
+0000d930: 2020 2020 2020 6f70 745f 666c 6f61 743a        opt_float:
+0000d940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d950: 2020 2020 2074 7970 653a 2066 6c6f 6174       type: float
+0000d960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d970: 2020 2020 2064 6566 6175 6c74 3a20 312e       default: 1.
+0000d980: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000d990: 2020 6f70 745f 6e6f 5f64 6566 6175 6c74    opt_no_default
+0000d9a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d9b0: 2020 2020 2020 7479 7065 3a20 7374 7269        type: stri
+0000d9c0: 6e67 0a20 2020 2020 2020 2020 2020 2027  ng.            '
+0000d9d0: 2727 2929 0a20 2020 2020 2020 2068 6172  '')).        har
+0000d9e0: 6e65 7373 203d 2073 656c 662e 5f67 6574  ness = self._get
+0000d9f0: 5f64 756d 6d79 5f63 6861 726d 5f68 6172  _dummy_charm_har
+0000da00: 6e65 7373 2874 6d70 290a 2020 2020 2020  ness(tmp).      
+0000da10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000da20: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
+0000da30: 2e63 6f6e 6669 675b 276f 7074 5f73 7472  .config['opt_str
+0000da40: 275d 2c20 2776 616c 2729 0a20 2020 2020  '], 'val').     
+0000da50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000da60: 7561 6c28 6861 726e 6573 732e 6d6f 6465  ual(harness.mode
+0000da70: 6c2e 636f 6e66 6967 5b27 6f70 745f 7374  l.config['opt_st
+0000da80: 725f 656d 7074 7927 5d2c 2027 2729 0a20  r_empty'], ''). 
+0000da90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000daa0: 7274 4973 2868 6172 6e65 7373 2e6d 6f64  rtIs(harness.mod
+0000dab0: 656c 2e63 6f6e 6669 675b 276f 7074 5f62  el.config['opt_b
+0000dac0: 6f6f 6c27 5d2c 2054 7275 6529 0a20 2020  ool'], True).   
+0000dad0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000dae0: 4571 7561 6c28 6861 726e 6573 732e 6d6f  Equal(harness.mo
+0000daf0: 6465 6c2e 636f 6e66 6967 5b27 6f70 745f  del.config['opt_
+0000db00: 696e 7427 5d2c 2031 290a 2020 2020 2020  int'], 1).      
+0000db10: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0000db20: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+0000db30: 6d6f 6465 6c2e 636f 6e66 6967 5b27 6f70  model.config['op
+0000db40: 745f 696e 7427 5d2c 2069 6e74 290a 2020  t_int'], int).  
+0000db50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000db60: 7445 7175 616c 2868 6172 6e65 7373 2e6d  tEqual(harness.m
+0000db70: 6f64 656c 2e63 6f6e 6669 675b 276f 7074  odel.config['opt
+0000db80: 5f66 6c6f 6174 275d 2c20 312e 3029 0a20  _float'], 1.0). 
+0000db90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000dba0: 7274 4973 496e 7374 616e 6365 2868 6172  rtIsInstance(har
+0000dbb0: 6e65 7373 2e6d 6f64 656c 2e63 6f6e 6669  ness.model.confi
+0000dbc0: 675b 276f 7074 5f66 6c6f 6174 275d 2c20  g['opt_float'], 
+0000dbd0: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
+0000dbe0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+0000dbf0: 276f 7074 5f6e 756c 6c27 2069 6e20 6861  'opt_null' in ha
+0000dc00: 726e 6573 732e 6d6f 6465 6c2e 636f 6e66  rness.model.conf
+0000dc10: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
+0000dc20: 2e61 7373 6572 7449 734e 6f6e 6528 6861  .assertIsNone(ha
+0000dc30: 726e 6573 732e 5f62 6163 6b65 6e64 2e5f  rness._backend._
+0000dc40: 636f 6e66 6967 2e5f 6465 6661 756c 7473  config._defaults
+0000dc50: 5b27 6f70 745f 6e75 6c6c 275d 290a 2020  ['opt_null']).  
+0000dc60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000dc70: 7449 734e 6f6e 6528 6861 726e 6573 732e  tIsNone(harness.
+0000dc80: 5f62 6163 6b65 6e64 2e5f 636f 6e66 6967  _backend._config
+0000dc90: 2e5f 6465 6661 756c 7473 5b27 6f70 745f  ._defaults['opt_
+0000dca0: 6e6f 5f64 6566 6175 6c74 275d 290a 0a20  no_default']).. 
+0000dcb0: 2020 2064 6566 2074 6573 745f 636f 6e66     def test_conf
+0000dcc0: 6967 5f66 726f 6d5f 6469 7265 6374 6f72  ig_from_director
+0000dcd0: 795f 6368 6172 6d63 7261 6674 5f79 616d  y_charmcraft_yam
+0000dce0: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
+0000dcf0: 2074 6d70 203d 2070 6174 686c 6962 2e50   tmp = pathlib.P
+0000dd00: 6174 6828 7465 6d70 6669 6c65 2e6d 6b64  ath(tempfile.mkd
+0000dd10: 7465 6d70 2829 290a 2020 2020 2020 2020  temp()).        
+0000dd20: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0000dd30: 7368 7574 696c 2e72 6d74 7265 652c 2074  shutil.rmtree, t
+0000dd40: 6d70 290a 2020 2020 2020 2020 6368 6172  mp).        char
+0000dd50: 6d63 7261 6674 5f66 696c 656e 616d 6520  mcraft_filename 
+0000dd60: 3d20 746d 7020 2f20 2763 6861 726d 6372  = tmp / 'charmcr
+0000dd70: 6166 742e 7961 6d6c 270a 2020 2020 2020  aft.yaml'.      
+0000dd80: 2020 6368 6172 6d63 7261 6674 5f66 696c    charmcraft_fil
+0000dd90: 656e 616d 652e 7772 6974 655f 7465 7874  ename.write_text
+0000dda0: 2874 6578 7477 7261 702e 6465 6465 6e74  (textwrap.dedent
+0000ddb0: 2827 2727 0a20 2020 2020 2020 2020 2020  ('''.           
+0000ddc0: 2074 7970 653a 2063 6861 726d 0a20 2020   type: charm.   
+0000ddd0: 2020 2020 2020 2020 2062 6173 6573 3a0a           bases:.
+0000dde0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+0000ddf0: 6275 696c 642d 6f6e 3a0a 2020 2020 2020  build-on:.      
+0000de00: 2020 2020 2020 2020 2020 2d20 6e61 6d65            - name
+0000de10: 3a20 7562 756e 7475 0a20 2020 2020 2020  : ubuntu.       
+0000de20: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
+0000de30: 656c 3a20 2232 322e 3034 220a 2020 2020  el: "22.04".    
+0000de40: 2020 2020 2020 2020 2020 2020 7275 6e2d              run-
+0000de50: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+0000de60: 2020 2020 2d20 6e61 6d65 3a20 7562 756e      - name: ubun
+0000de70: 7475 0a20 2020 2020 2020 2020 2020 2020  tu.             
+0000de80: 2020 2020 2063 6861 6e6e 656c 3a20 2232       channel: "2
+0000de90: 322e 3034 220a 0a20 2020 2020 2020 2020  2.04"..         
+0000dea0: 2020 2063 6f6e 6669 673a 0a20 2020 2020     config:.     
+0000deb0: 2020 2020 2020 2020 2020 206f 7074 696f             optio
+0000dec0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000ded0: 2020 2020 2020 2020 6f70 745f 7374 723a          opt_str:
+0000dee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000def0: 2020 2020 2020 2020 2074 7970 653a 2073           type: s
+0000df00: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
+0000df10: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000df20: 6661 756c 743a 2022 7661 6c22 0a20 2020  fault: "val".   
+0000df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df40: 206f 7074 5f69 6e74 3a0a 2020 2020 2020   opt_int:.      
+0000df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df60: 2020 7479 7065 3a20 696e 740a 2020 2020    type: int.    
+0000df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df80: 2020 2020 6465 6661 756c 743a 2031 0a20      default: 1. 
+0000df90: 2020 2020 2020 2020 2020 2027 2727 2929             '''))
+0000dfa0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000dfb0: 203d 2073 656c 662e 5f67 6574 5f64 756d   = self._get_dum
+0000dfc0: 6d79 5f63 6861 726d 5f68 6172 6e65 7373  my_charm_harness
+0000dfd0: 2874 6d70 290a 2020 2020 2020 2020 7365  (tmp).        se
+0000dfe0: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+0000dff0: 6172 6e65 7373 2e6d 6f64 656c 2e63 6f6e  arness.model.con
+0000e000: 6669 675b 276f 7074 5f73 7472 275d 2c20  fig['opt_str'], 
+0000e010: 2776 616c 2729 0a20 2020 2020 2020 2073  'val').        s
+0000e020: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000e030: 6861 726e 6573 732e 6d6f 6465 6c2e 636f  harness.model.co
+0000e040: 6e66 6967 5b27 6f70 745f 696e 7427 5d2c  nfig['opt_int'],
+0000e050: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+0000e060: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+0000e070: 6528 6861 726e 6573 732e 6d6f 6465 6c2e  e(harness.model.
+0000e080: 636f 6e66 6967 5b27 6f70 745f 696e 7427  config['opt_int'
+0000e090: 5d2c 2069 6e74 290a 0a20 2020 2064 6566  ], int)..    def
+0000e0a0: 2074 6573 745f 7365 745f 6d6f 6465 6c5f   test_set_model_
+0000e0b0: 6e61 6d65 2873 656c 6629 3a0a 2020 2020  name(self):.    
+0000e0c0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0000e0d0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0000e0e0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0000e0f0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0000e100: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0000e110: 2d63 6861 726d 0a20 2020 2020 2020 2027  -charm.        '
+0000e120: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000e130: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000e140: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+0000e150: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+0000e160: 5f6d 6f64 656c 5f6e 616d 6528 2766 6f6f  _model_name('foo
+0000e170: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000e180: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
+0000e190: 272c 2068 6172 6e65 7373 2e6d 6f64 656c  ', harness.model
+0000e1a0: 2e6e 616d 6529 0a0a 2020 2020 6465 6620  .name)..    def 
+0000e1b0: 7465 7374 5f73 6574 5f6d 6f64 656c 5f6e  test_set_model_n
+0000e1c0: 616d 655f 6166 7465 725f 6265 6769 6e28  ame_after_begin(
+0000e1d0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0000e1e0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0000e1f0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+0000e200: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+0000e210: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+0000e220: 206e 616d 653a 2074 6573 742d 6368 6172   name: test-char
+0000e230: 6d0a 2020 2020 2020 2020 2727 2729 0a20  m.        '''). 
+0000e240: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000e250: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000e260: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000e270: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
+0000e280: 6c5f 6e61 6d65 2827 6261 7227 290a 2020  l_name('bar').  
+0000e290: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0000e2a0: 6769 6e28 290a 2020 2020 2020 2020 7769  gin().        wi
+0000e2b0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000e2c0: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+0000e2d0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000e2e0: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
+0000e2f0: 6c5f 6e61 6d65 2827 666f 6f27 290a 2020  l_name('foo').  
+0000e300: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000e310: 7445 7175 616c 2868 6172 6e65 7373 2e6d  tEqual(harness.m
+0000e320: 6f64 656c 2e6e 616d 652c 2027 6261 7227  odel.name, 'bar'
+0000e330: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000e340: 7365 745f 6d6f 6465 6c5f 7575 6964 5f61  set_model_uuid_a
+0000e350: 6674 6572 5f62 6567 696e 2873 656c 6629  fter_begin(self)
+0000e360: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0000e370: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0000e380: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0000e390: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+0000e3a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000e3b0: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
+0000e3c0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+0000e3d0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0000e3e0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0000e3f0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+0000e400: 7373 2e73 6574 5f6d 6f64 656c 5f6e 616d  ss.set_model_nam
+0000e410: 6528 2762 6172 2729 0a20 2020 2020 2020  e('bar').       
+0000e420: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
+0000e430: 656c 5f75 7569 6428 2739 3639 3537 6539  el_uuid('96957e9
+0000e440: 302d 6530 3036 2d31 3165 622d 6261 3830  0-e006-11eb-ba80
+0000e450: 2d30 3234 3261 6331 3330 3030 3427 290a  -0242ac130004').
+0000e460: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000e470: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+0000e480: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000e490: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
+0000e4a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000e4b0: 2020 6861 726e 6573 732e 7365 745f 6d6f    harness.set_mo
+0000e4c0: 6465 6c5f 7575 6964 2827 6166 3034 3739  del_uuid('af0479
+0000e4d0: 6561 2d65 3030 362d 3131 6562 2d62 6138  ea-e006-11eb-ba8
+0000e4e0: 302d 3032 3432 6163 3133 3030 3034 2729  0-0242ac130004')
+0000e4f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e500: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+0000e510: 732e 6d6f 6465 6c2e 7575 6964 2c20 2739  s.model.uuid, '9
+0000e520: 3639 3537 6539 302d 6530 3036 2d31 3165  6957e90-e006-11e
+0000e530: 622d 6261 3830 2d30 3234 3261 6331 3330  b-ba80-0242ac130
+0000e540: 3030 3427 290a 0a20 2020 2064 6566 2074  004')..    def t
+0000e550: 6573 745f 7365 745f 6d6f 6465 6c5f 696e  est_set_model_in
+0000e560: 666f 5f61 6674 6572 5f62 6567 696e 2873  fo_after_begin(s
+0000e570: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+0000e580: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+0000e590: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+0000e5a0: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+0000e5b0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+0000e5c0: 6e61 6d65 3a20 7465 7374 2d63 6861 726d  name: test-charm
+0000e5d0: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
+0000e5e0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0000e5f0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0000e600: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
+0000e610: 6172 6e65 7373 2e73 6574 5f6d 6f64 656c  arness.set_model
+0000e620: 5f69 6e66 6f28 2766 6f6f 272c 2027 3936  _info('foo', '96
+0000e630: 3935 3765 3930 2d65 3030 362d 3131 6562  957e90-e006-11eb
+0000e640: 2d62 6138 302d 3032 3432 6163 3133 3030  -ba80-0242ac1300
+0000e650: 3034 2729 0a20 2020 2020 2020 2068 6172  04').        har
+0000e660: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0000e670: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000e680: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
+0000e690: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
+0000e6a0: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+0000e6b0: 6574 5f6d 6f64 656c 5f69 6e66 6f28 2762  et_model_info('b
+0000e6c0: 6172 272c 2027 6166 3034 3739 6561 2d65  ar', 'af0479ea-e
+0000e6d0: 3030 362d 3131 6562 2d62 6138 302d 3032  006-11eb-ba80-02
+0000e6e0: 3432 6163 3133 3030 3034 2729 0a20 2020  42ac130004').   
+0000e6f0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000e700: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
+0000e710: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
+0000e720: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+0000e730: 6574 5f6d 6f64 656c 5f69 6e66 6f28 2762  et_model_info('b
+0000e740: 6172 2729 0a20 2020 2020 2020 2077 6974  ar').        wit
+0000e750: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000e760: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
+0000e770: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
+0000e780: 6172 6e65 7373 2e73 6574 5f6d 6f64 656c  arness.set_model
+0000e790: 5f69 6e66 6f28 7575 6964 3d27 6166 3034  _info(uuid='af04
+0000e7a0: 3739 6561 2d65 3030 362d 3131 6562 2d62  79ea-e006-11eb-b
+0000e7b0: 6138 302d 3032 3432 6163 3133 3030 3034  a80-0242ac130004
+0000e7c0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+0000e7d0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0000e7e0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+0000e7f0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000e800: 6e65 7373 2e73 6574 5f6d 6f64 656c 5f6e  ness.set_model_n
+0000e810: 616d 6528 2762 6172 2729 0a20 2020 2020  ame('bar').     
+0000e820: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000e830: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+0000e840: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000e850: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+0000e860: 5f6d 6f64 656c 5f75 7569 6428 2761 6630  _model_uuid('af0
+0000e870: 3437 3965 612d 6530 3036 2d31 3165 622d  479ea-e006-11eb-
+0000e880: 6261 3830 2d30 3234 3261 6331 3330 3030  ba80-0242ac13000
+0000e890: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
+0000e8a0: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
+0000e8b0: 6e65 7373 2e6d 6f64 656c 2e6e 616d 652c  ness.model.name,
+0000e8c0: 2027 666f 6f27 290a 2020 2020 2020 2020   'foo').        
+0000e8d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e8e0: 2868 6172 6e65 7373 2e6d 6f64 656c 2e75  (harness.model.u
+0000e8f0: 7569 642c 2027 3936 3935 3765 3930 2d65  uid, '96957e90-e
+0000e900: 3030 362d 3131 6562 2d62 6138 302d 3032  006-11eb-ba80-02
+0000e910: 3432 6163 3133 3030 3034 2729 0a0a 2020  42ac130004')..  
+0000e920: 2020 6465 6620 7465 7374 5f61 6464 5f73    def test_add_s
+0000e930: 746f 7261 6765 5f62 6566 6f72 655f 6861  torage_before_ha
+0000e940: 726e 6573 735f 6265 6769 6e28 7365 6c66  rness_begin(self
+0000e950: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000e960: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000e970: 2e48 6172 6e65 7373 2853 746f 7261 6765  .Harness(Storage
+0000e980: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
+0000e990: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000e9a0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+0000e9b0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
+0000e9c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e9d0: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
+0000e9e0: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+0000e9f0: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
+0000ea00: 2020 2020 2020 2073 746f 7261 6765 3a0a         storage:.
+0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea20: 7465 7374 3a0a 2020 2020 2020 2020 2020  test:.          
+0000ea30: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
+0000ea40: 6669 6c65 7379 7374 656d 0a20 2020 2020  filesystem.     
+0000ea50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000ea60: 756c 7469 706c 653a 0a20 2020 2020 2020  ultiple:.       
+0000ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea80: 2072 616e 6765 3a20 312d 330a 2020 2020   range: 1-3.    
+0000ea90: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+0000eaa0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0000eab0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0000eac0: 616e 7570 290a 0a20 2020 2020 2020 2073  anup)..        s
+0000ead0: 746f 725f 6964 7320 3d20 6861 726e 6573  tor_ids = harnes
+0000eae0: 732e 6164 645f 7374 6f72 6167 6528 2274  s.add_storage("t
+0000eaf0: 6573 7422 2c20 636f 756e 743d 3329 0a20  est", count=3). 
+0000eb00: 2020 2020 2020 2066 6f72 2073 2069 6e20         for s in 
+0000eb10: 7374 6f72 5f69 6473 3a0a 2020 2020 2020  stor_ids:.      
+0000eb20: 2020 2020 2020 2320 6265 666f 7265 2062        # before b
+0000eb30: 6567 696e 2c20 6164 6469 6e67 2073 746f  egin, adding sto
+0000eb40: 7261 6765 2064 6f65 7320 6e6f 7420 6174  rage does not at
+0000eb50: 7461 6368 2069 742e 0a20 2020 2020 2020  tach it..       
+0000eb60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000eb70: 4e6f 7449 6e28 732c 2068 6172 6e65 7373  NotIn(s, harness
+0000eb80: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
+0000eb90: 655f 6c69 7374 2822 7465 7374 2229 290a  e_list("test")).
+0000eba0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000ebb0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000ebc0: 6f70 732e 4d6f 6465 6c45 7272 6f72 293a  ops.ModelError):
+0000ebd0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000ebe0: 6e65 7373 2e5f 6261 636b 656e 642e 7374  ness._backend.st
+0000ebf0: 6f72 6167 655f 6765 7428 2274 6573 742f  orage_get("test/
+0000ec00: 3022 2c20 226c 6f63 6174 696f 6e22 295b  0", "location")[
+0000ec10: 2d36 3a5d 0a0a 2020 2020 6465 6620 7465  -6:]..    def te
+0000ec20: 7374 5f61 6464 5f73 746f 7261 6765 5f74  st_add_storage_t
+0000ec30: 6865 6e5f 6861 726e 6573 735f 6265 6769  hen_harness_begi
+0000ec40: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+0000ec50: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+0000ec60: 6573 7469 6e67 2e48 6172 6e65 7373 2853  esting.Harness(S
+0000ec70: 746f 7261 6765 5465 7374 6572 2c20 6d65  torageTester, me
+0000ec80: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0000ec90: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+0000eca0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+0000ecb0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+0000ecc0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ece0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+0000ecf0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0000ed00: 7261 6765 3a0a 2020 2020 2020 2020 2020  rage:.          
+0000ed10: 2020 2020 2020 7465 7374 3a0a 2020 2020        test:.    
+0000ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed30: 7479 7065 3a20 6669 6c65 7379 7374 656d  type: filesystem
+0000ed40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ed50: 2020 2020 206d 756c 7469 706c 653a 0a20       multiple:. 
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed70: 2020 2020 2020 2072 616e 6765 3a20 312d         range: 1-
+0000ed80: 330a 2020 2020 2020 2020 2020 2020 2727  3.            ''
+0000ed90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000eda0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+0000edb0: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
+0000edc0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
+0000edd0: 5f73 746f 7261 6765 2822 7465 7374 222c  _storage("test",
+0000ede0: 2063 6f75 6e74 3d33 290a 0a20 2020 2020   count=3)..     
+0000edf0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000ee00: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+0000ee10: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+0000ee20: 2020 2020 2020 2068 6172 6e65 7373 2e5f         harness._
+0000ee30: 6261 636b 656e 642e 7374 6f72 6167 655f  backend.storage_
+0000ee40: 6765 7428 2274 6573 742f 3022 2c20 226c  get("test/0", "l
+0000ee50: 6f63 6174 696f 6e22 295b 2d36 3a5d 0a0a  ocation")[-6:]..
+0000ee60: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000ee70: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
+0000ee80: 616c 5f68 6f6f 6b73 2829 0a20 2020 2020  al_hooks().     
+0000ee90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000eea0: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
+0000eeb0: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+0000eec0: 7665 6e74 7329 2c20 3329 0a20 2020 2020  vents), 3).     
+0000eed0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0000eee0: 6528 3329 3a0a 2020 2020 2020 2020 2020  e(3):.          
+0000eef0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000ef00: 6528 6973 696e 7374 616e 6365 2868 6172  e(isinstance(har
+0000ef10: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+0000ef20: 7665 645f 6576 656e 7473 5b69 5d2c 206f  ved_events[i], o
+0000ef30: 7073 2e53 746f 7261 6765 4174 7461 6368  ps.StorageAttach
+0000ef40: 6564 4576 656e 7429 290a 0a20 2020 2020  edEvent))..     
+0000ef50: 2020 2077 616e 7420 3d20 7374 7228 7061     want = str(pa
+0000ef60: 7468 6c69 622e 5075 7265 5061 7468 2827  thlib.PurePath('
+0000ef70: 7465 7374 272c 2027 3027 2929 0a20 2020  test', '0')).   
+0000ef80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000ef90: 4571 7561 6c28 7761 6e74 2c20 6861 726e  Equal(want, harn
+0000efa0: 6573 732e 5f62 6163 6b65 6e64 2e73 746f  ess._backend.sto
+0000efb0: 7261 6765 5f67 6574 2822 7465 7374 2f30  rage_get("test/0
+0000efc0: 222c 2022 6c6f 6361 7469 6f6e 2229 5b2d  ", "location")[-
+0000efd0: 363a 5d29 0a0a 2020 2020 6465 6620 7465  6:])..    def te
+0000efe0: 7374 5f61 6464 5f73 746f 7261 6765 5f6e  st_add_storage_n
+0000eff0: 6f74 5f61 7474 6163 6865 645f 6465 6661  ot_attached_defa
+0000f000: 756c 7428 7365 6c66 293a 0a20 2020 2020  ult(self):.     
+0000f010: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000f020: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000f030: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0000f040: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+0000f050: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+0000f060: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
+0000f070: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
+0000f080: 2020 2020 2020 2020 2020 6462 3a0a 2020            db:.  
+0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0a0: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
+0000f0b0: 716c 0a20 2020 2020 2020 2020 2020 2073  ql.            s
+0000f0c0: 746f 7261 6765 3a0a 2020 2020 2020 2020  torage:.        
+0000f0d0: 2020 2020 2020 2020 7465 7374 3a0a 2020          test:.  
+0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0f0: 2020 7479 7065 3a20 6669 6c65 7379 7374    type: filesyst
+0000f100: 656d 0a20 2020 2020 2020 2020 2020 2027  em.            '
+0000f110: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000f120: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000f130: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0000f140: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0000f150: 645f 7374 6f72 6167 6528 2774 6573 7427  d_storage('test'
+0000f160: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0000f170: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
+0000f180: 2020 6173 7365 7274 206c 656e 2868 6172    assert len(har
+0000f190: 6e65 7373 2e6d 6f64 656c 2e73 746f 7261  ness.model.stora
+0000f1a0: 6765 735b 2774 6573 7427 5d29 203d 3d20  ges['test']) == 
+0000f1b0: 302c 205c 0a20 2020 2020 2020 2020 2020  0, \.           
+0000f1c0: 2027 7374 6f72 6167 6520 7368 6f75 6c64   'storage should
+0000f1d0: 2073 7461 7274 2069 6e20 6465 7461 6368   start in detach
+0000f1e0: 6564 2073 7461 7465 2061 6e64 2062 6520  ed state and be 
+0000f1f0: 6578 636c 7564 6564 2066 726f 6d20 7374  excluded from st
+0000f200: 6f72 6167 6520 6c69 7374 696e 6727 0a0a  orage listing'..
+0000f210: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+0000f220: 5f73 746f 7261 6765 5f77 6974 686f 7574  _storage_without
+0000f230: 5f6d 6574 6164 6174 615f 6b65 795f 6661  _metadata_key_fa
+0000f240: 696c 7328 7365 6c66 293a 0a20 2020 2020  ils(self):.     
+0000f250: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000f260: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000f270: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0000f280: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+0000f290: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+0000f2a0: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
+0000f2b0: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
+0000f2c0: 2020 2020 2020 2020 2020 6462 3a0a 2020            db:.  
+0000f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2e0: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
+0000f2f0: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
+0000f300: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000f310: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000f320: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0000f330: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000f340: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0000f350: 7469 6d65 4572 726f 7229 2061 7320 636d  timeError) as cm
+0000f360: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
+0000f370: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
+0000f380: 6528 2274 6573 7422 290a 2020 2020 2020  e("test").      
+0000f390: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000f3a0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+0000f3b0: 636d 2e65 7863 6570 7469 6f6e 2e61 7267  cm.exception.arg
+0000f3c0: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+0000f3d0: 2020 2274 6865 206b 6579 2027 7465 7374    "the key 'test
+0000f3e0: 2720 6973 206e 6f74 2073 7065 6369 6669  ' is not specifi
+0000f3f0: 6564 2061 7320 6120 7374 6f72 6167 6520  ed as a storage 
+0000f400: 6b65 7920 696e 206d 6574 6164 6174 6122  key in metadata"
+0000f410: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000f420: 6164 645f 7374 6f72 6167 655f 6166 7465  add_storage_afte
+0000f430: 725f 6861 726e 6573 735f 6265 6769 6e28  r_harness_begin(
+0000f440: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0000f450: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0000f460: 7469 6e67 2e48 6172 6e65 7373 2853 746f  ting.Harness(Sto
+0000f470: 7261 6765 5465 7374 6572 2c20 6d65 7461  rageTester, meta
+0000f480: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+0000f490: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+0000f4a0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+0000f4b0: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+0000f4c0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+0000f4d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000f4e0: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
+0000f4f0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0000f500: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+0000f510: 2020 2020 7465 7374 3a0a 2020 2020 2020      test:.      
+0000f520: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+0000f530: 7065 3a20 6669 6c65 7379 7374 656d 0a20  pe: filesystem. 
+0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f550: 2020 206d 756c 7469 706c 653a 0a20 2020     multiple:.   
+0000f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f570: 2020 2020 2072 616e 6765 3a20 312d 330a       range: 1-3.
+0000f580: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0000f590: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0000f5a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0000f5b0: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+0000f5c0: 2020 2023 2053 6574 2075 7020 696e 6974     # Set up init
+0000f5d0: 6961 6c20 7374 6f72 6167 650a 2020 2020  ial storage.    
+0000f5e0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0000f5f0: 7374 6f72 6167 6528 2274 6573 7422 295b  storage("test")[
+0000f600: 305d 0a20 2020 2020 2020 2068 6172 6e65  0].        harne
+0000f610: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
+0000f620: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
+0000f630: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f640: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
+0000f650: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+0000f660: 645f 6576 656e 7473 292c 2031 290a 2020  d_events), 1).  
+0000f670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f680: 7454 7275 6528 6973 696e 7374 616e 6365  tTrue(isinstance
+0000f690: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
+0000f6a0: 6273 6572 7665 645f 6576 656e 7473 5b30  bserved_events[0
+0000f6b0: 5d2c 206f 7073 2e53 746f 7261 6765 4174  ], ops.StorageAt
+0000f6c0: 7461 6368 6564 4576 656e 7429 290a 0a20  tachedEvent)).. 
+0000f6d0: 2020 2020 2020 2023 2041 6464 2061 6464         # Add add
+0000f6e0: 6974 696f 6e61 6c20 7374 6f72 6167 650a  itional storage.
+0000f6f0: 2020 2020 2020 2020 7374 6f72 5f69 6473          stor_ids
+0000f700: 203d 2068 6172 6e65 7373 2e61 6464 5f73   = harness.add_s
+0000f710: 746f 7261 6765 2822 7465 7374 222c 2063  torage("test", c
+0000f720: 6f75 6e74 3d33 2c20 6174 7461 6368 3d54  ount=3, attach=T
+0000f730: 7275 6529 0a20 2020 2020 2020 2023 204e  rue).        # N
+0000f740: 4f54 453a 2073 746f 725f 6964 206e 6f77  OTE: stor_id now
+0000f750: 2072 6566 6c65 6374 7320 7468 6520 3474   reflects the 4t
+0000f760: 6820 4944 2e20 2054 6865 2032 6e64 2061  h ID.  The 2nd a
+0000f770: 6e64 2033 7264 2049 4473 2061 7265 2063  nd 3rd IDs are c
+0000f780: 7265 6174 6564 2061 6e64 0a20 2020 2020  reated and.     
+0000f790: 2020 2023 2075 7365 642c 2062 7574 206e     # used, but n
+0000f7a0: 6f74 2072 6574 7572 6e65 6420 6279 2048  ot returned by H
+0000f7b0: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
+0000f7c0: 6765 2e0a 2020 2020 2020 2020 2320 2853  ge..        # (S
+0000f7d0: 686f 756c 6420 7765 2063 6f6e 7369 6465  hould we conside
+0000f7e0: 7220 6368 616e 6769 6e67 2069 7473 2072  r changing its r
+0000f7f0: 6574 7572 6e20 7479 7065 3f29 0a0a 2020  eturn type?)..  
+0000f800: 2020 2020 2020 6164 6465 645f 696e 6469        added_indi
+0000f810: 6365 7320 3d20 7b73 656c 662e 5f65 7874  ces = {self._ext
+0000f820: 7261 6374 5f73 746f 7261 6765 5f69 6e64  ract_storage_ind
+0000f830: 6578 2873 746f 725f 6964 2920 666f 7220  ex(stor_id) for 
+0000f840: 7374 6f72 5f69 6420 696e 2073 746f 725f  stor_id in stor_
+0000f850: 6964 737d 0a20 2020 2020 2020 2073 656c  ids}.        sel
+0000f860: 662e 6173 7365 7274 5472 7565 2861 6464  f.assertTrue(add
+0000f870: 6564 5f69 6e64 6963 6573 2e69 7373 7562  ed_indices.issub
+0000f880: 7365 7428 7365 7428 6861 726e 6573 732e  set(set(harness.
+0000f890: 5f62 6163 6b65 6e64 2e73 746f 7261 6765  _backend.storage
+0000f8a0: 5f6c 6973 7428 2274 6573 7422 2929 2929  _list("test"))))
+0000f8b0: 0a0a 2020 2020 2020 2020 666f 7220 6920  ..        for i 
+0000f8c0: 696e 205b 2731 272c 2027 3227 2c20 2733  in ['1', '2', '3
+0000f8d0: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+0000f8e0: 7374 6f72 6167 655f 6e61 6d65 203d 2066  storage_name = f
+0000f8f0: 2274 6573 742f 7b69 7d22 0a20 2020 2020  "test/{i}".     
+0000f900: 2020 2020 2020 2077 616e 7420 3d20 7374         want = st
+0000f910: 7228 7061 7468 6c69 622e 5075 7265 5061  r(pathlib.PurePa
+0000f920: 7468 2827 7465 7374 272c 2069 2929 0a20  th('test', i)). 
+0000f930: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f940: 6173 7365 7274 5472 7565 2868 6172 6e65  assertTrue(harne
+0000f950: 7373 2e5f 6261 636b 656e 642e 7374 6f72  ss._backend.stor
+0000f960: 6167 655f 6765 7428 7374 6f72 6167 655f  age_get(storage_
+0000f970: 6e61 6d65 2c20 226c 6f63 6174 696f 6e22  name, "location"
+0000f980: 292e 656e 6473 7769 7468 2877 616e 7429  ).endswith(want)
+0000f990: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f9a0: 7373 6572 7445 7175 616c 286c 656e 2868  ssertEqual(len(h
+0000f9b0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+0000f9c0: 6572 7665 645f 6576 656e 7473 292c 2034  erved_events), 4
+0000f9d0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+0000f9e0: 696e 2072 616e 6765 2831 2c20 3429 3a0a  in range(1, 4):.
+0000f9f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fa00: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
+0000fa10: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
+0000fa20: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
+0000fa30: 656e 7473 5b69 5d2c 206f 7073 2e53 746f  ents[i], ops.Sto
+0000fa40: 7261 6765 4174 7461 6368 6564 4576 656e  rageAttachedEven
+0000fa50: 7429 290a 0a20 2020 2064 6566 2074 6573  t))..    def tes
+0000fa60: 745f 6465 7461 6368 5f73 746f 7261 6765  t_detach_storage
+0000fa70: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000fa80: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000fa90: 7374 696e 672e 4861 726e 6573 7328 5374  sting.Harness(St
+0000faa0: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
+0000fab0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000fac0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0000fad0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000fae0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000faf0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+0000fb00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000fb10: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+0000fb20: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0000fb30: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0000fb40: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000fb60: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
+0000fb70: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0000fb80: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0000fb90: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0000fba0: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+0000fbb0: 2020 2023 2053 6574 2075 7020 696e 6974     # Set up init
+0000fbc0: 6961 6c20 7374 6f72 6167 650a 2020 2020  ial storage.    
+0000fbd0: 2020 2020 7374 6f72 5f69 6420 3d20 6861      stor_id = ha
+0000fbe0: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
+0000fbf0: 6528 2274 6573 7422 295b 305d 0a20 2020  e("test")[0].   
+0000fc00: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+0000fc10: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
+0000fc20: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
+0000fc30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000fc40: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
+0000fc50: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
+0000fc60: 7473 292c 2031 290a 2020 2020 2020 2020  ts), 1).        
+0000fc70: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000fc80: 6973 696e 7374 616e 6365 2868 6172 6e65  isinstance(harne
+0000fc90: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+0000fca0: 645f 6576 656e 7473 5b30 5d2c 206f 7073  d_events[0], ops
+0000fcb0: 2e53 746f 7261 6765 4174 7461 6368 6564  .StorageAttached
+0000fcc0: 4576 656e 7429 290a 0a20 2020 2020 2020  Event))..       
+0000fcd0: 2023 2044 6574 6163 6820 7374 6f72 6167   # Detach storag
+0000fce0: 650a 2020 2020 2020 2020 6861 726e 6573  e.        harnes
+0000fcf0: 732e 6465 7461 6368 5f73 746f 7261 6765  s.detach_storage
+0000fd00: 2873 746f 725f 6964 290a 2020 2020 2020  (stor_id).      
+0000fd10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000fd20: 616c 286c 656e 2868 6172 6e65 7373 2e63  al(len(harness.c
+0000fd30: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
+0000fd40: 656e 7473 292c 2032 290a 2020 2020 2020  ents), 2).      
+0000fd50: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000fd60: 6528 6973 696e 7374 616e 6365 2868 6172  e(isinstance(har
+0000fd70: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+0000fd80: 7665 645f 6576 656e 7473 5b31 5d2c 206f  ved_events[1], o
+0000fd90: 7073 2e53 746f 7261 6765 4465 7461 6368  ps.StorageDetach
+0000fda0: 696e 6745 7665 6e74 2929 0a0a 2020 2020  ingEvent))..    
+0000fdb0: 2020 2020 2320 5665 7269 6679 2062 6163      # Verify bac
+0000fdc0: 6b65 6e64 2066 756e 6374 696f 6e73 2072  kend functions r
+0000fdd0: 6574 7572 6e20 6170 7072 6f70 7269 6174  eturn appropriat
+0000fde0: 6520 7661 6c75 6573 2e0a 2020 2020 2020  e values..      
+0000fdf0: 2020 2320 5265 616c 2062 6163 6b65 6e64    # Real backend
+0000fe00: 2077 6f75 6c64 2072 6574 7572 6e20 696e   would return in
+0000fe10: 666f 206f 6e6c 7920 666f 7220 6163 7469  fo only for acti
+0000fe20: 7665 6c79 2061 7474 6163 6865 6420 7374  vely attached st
+0000fe30: 6f72 6167 6520 756e 6974 732e 0a20 2020  orage units..   
+0000fe40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000fe50: 4e6f 7449 6e28 7374 6f72 5f69 642c 2068  NotIn(stor_id, h
+0000fe60: 6172 6e65 7373 2e5f 6261 636b 656e 642e  arness._backend.
+0000fe70: 7374 6f72 6167 655f 6c69 7374 2822 7465  storage_list("te
+0000fe80: 7374 2229 290a 2020 2020 2020 2020 7769  st")).        wi
+0000fe90: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000fea0: 6973 6573 286f 7073 2e4d 6f64 656c 4572  ises(ops.ModelEr
+0000feb0: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+0000fec0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000fed0: 5f62 6163 6b65 6e64 2e73 746f 7261 6765  _backend.storage
+0000fee0: 5f67 6574 2822 7465 7374 2f30 222c 2022  _get("test/0", "
+0000fef0: 6c6f 6361 7469 6f6e 2229 0a20 2020 2020  location").     
+0000ff00: 2020 2023 2045 7272 6f72 206d 6573 7361     # Error messa
+0000ff10: 6765 206d 6f64 656c 6564 2061 6674 6572  ge modeled after
+0000ff20: 206f 7574 7075 7420 6f66 0a20 2020 2020   output of.     
+0000ff30: 2020 2023 2022 7374 6f72 6167 652d 6765     # "storage-ge
+0000ff40: 7420 2d73 203c 696e 7661 6c69 642f 696e  t -s <invalid/in
+0000ff50: 6163 7469 7665 2069 643e 206c 6f63 6174  active id> locat
+0000ff60: 696f 6e22 206f 6e20 7265 616c 2064 6570  ion" on real dep
+0000ff70: 6c6f 796d 656e 740a 2020 2020 2020 2020  loyment.        
+0000ff80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000ff90: 280a 2020 2020 2020 2020 2020 2020 636d  (.            cm
+0000ffa0: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
+0000ffb0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0000ffc0: 2745 5252 4f52 2069 6e76 616c 6964 2076  'ERROR invalid v
+0000ffd0: 616c 7565 2022 7465 7374 2f30 2220 666f  alue "test/0" fo
+0000ffe0: 7220 6f70 7469 6f6e 202d 733a 2073 746f  r option -s: sto
+0000fff0: 7261 6765 206e 6f74 2066 6f75 6e64 2729  rage not found')
+00010000: 0a0a 2020 2020 2020 2020 2320 5265 7472  ..        # Retr
+00010010: 7920 6465 7461 6368 0a20 2020 2020 2020  y detach.       
+00010020: 2023 2053 696e 6365 2061 6c72 6561 6479   # Since already
+00010030: 2064 6574 6163 6865 642c 206e 6f20 6d6f   detached, no mo
+00010040: 7265 2068 6f6f 6b73 2073 686f 756c 6420  re hooks should 
+00010050: 6669 7265 0a20 2020 2020 2020 2068 6172  fire.        har
+00010060: 6e65 7373 2e64 6574 6163 685f 7374 6f72  ness.detach_stor
+00010070: 6167 6528 7374 6f72 5f69 6429 0a20 2020  age(stor_id).   
+00010080: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010090: 4571 7561 6c28 6c65 6e28 6861 726e 6573  Equal(len(harnes
+000100a0: 732e 6368 6172 6d2e 6f62 7365 7276 6564  s.charm.observed
+000100b0: 5f65 7665 6e74 7329 2c20 3229 0a20 2020  _events), 2).   
+000100c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000100d0: 5472 7565 2869 7369 6e73 7461 6e63 6528  True(isinstance(
+000100e0: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
+000100f0: 7365 7276 6564 5f65 7665 6e74 735b 315d  served_events[1]
+00010100: 2c20 6f70 732e 5374 6f72 6167 6544 6574  , ops.StorageDet
+00010110: 6163 6869 6e67 4576 656e 7429 290a 0a20  achingEvent)).. 
+00010120: 2020 2064 6566 2074 6573 745f 6465 7461     def test_deta
+00010130: 6368 5f73 746f 7261 6765 5f62 6566 6f72  ch_storage_befor
+00010140: 655f 6861 726e 6573 735f 6265 6769 6e28  e_harness_begin(
+00010150: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+00010160: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00010170: 7469 6e67 2e48 6172 6e65 7373 2853 746f  ting.Harness(Sto
+00010180: 7261 6765 5465 7374 6572 2c20 6d65 7461  rageTester, meta
+00010190: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+000101a0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+000101b0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+000101c0: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+000101d0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+000101e0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000101f0: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
+00010200: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00010210: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+00010220: 2020 2020 7465 7374 3a0a 2020 2020 2020      test:.      
+00010230: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00010240: 7065 3a20 6669 6c65 7379 7374 656d 0a20  pe: filesystem. 
+00010250: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00010260: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00010270: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00010280: 636c 6561 6e75 7029 0a0a 2020 2020 2020  cleanup)..      
+00010290: 2020 7374 6f72 5f69 6420 3d20 6861 726e    stor_id = harn
+000102a0: 6573 732e 6164 645f 7374 6f72 6167 6528  ess.add_storage(
+000102b0: 2274 6573 7422 295b 305d 0a20 2020 2020  "test")[0].     
+000102c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+000102d0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+000102e0: 6545 7272 6f72 2920 6173 2063 6d3a 0a20  eError) as cm:. 
+000102f0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00010300: 7373 2e64 6574 6163 685f 7374 6f72 6167  ss.detach_storag
+00010310: 6528 6622 7465 7374 2f7b 7374 6f72 5f69  e(f"test/{stor_i
+00010320: 647d 2229 0a20 2020 2020 2020 2073 656c  d}").        sel
+00010330: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+00010340: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
+00010350: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00010360: 2020 2020 2020 2020 2020 2020 2022 6361               "ca
+00010370: 6e6e 6f74 2064 6574 6163 6820 7374 6f72  nnot detach stor
+00010380: 6167 6520 6265 666f 7265 2048 6172 6e65  age before Harne
+00010390: 7373 2069 7320 696e 6974 6961 6c69 7365  ss is initialise
+000103a0: 6422 290a 0a20 2020 2064 6566 2074 6573  d")..    def tes
+000103b0: 745f 7374 6f72 6167 655f 7769 7468 5f68  t_storage_with_h
+000103c0: 7970 6865 6e73 5f77 6f72 6b73 2873 656c  yphens_works(sel
+000103d0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+000103e0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+000103f0: 672e 4861 726e 6573 7328 5374 6f72 6167  g.Harness(Storag
+00010400: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
+00010410: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00010420: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00010430: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00010440: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00010450: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00010460: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00010470: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+00010480: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
+00010490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000104a0: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
+000104b0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+000104c0: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
+000104d0: 2020 2020 2020 2020 2020 2020 7465 7374              test
+000104e0: 2d77 6974 682d 6879 7068 656e 733a 0a20  -with-hyphens:. 
+000104f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010500: 2020 2074 7970 653a 2066 696c 6573 7973     type: filesys
+00010510: 7465 6d0a 2020 2020 2020 2020 2020 2020  tem.            
+00010520: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00010530: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00010540: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
+00010550: 2020 2020 2020 2023 2053 6574 2075 7020         # Set up 
+00010560: 696e 6974 6961 6c20 7374 6f72 6167 650a  initial storage.
+00010570: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00010580: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00010590: 6865 6c70 6572 203d 2053 746f 7261 6765  helper = Storage
+000105a0: 5769 7468 4879 7068 656e 7348 656c 7065  WithHyphensHelpe
+000105b0: 7228 6861 726e 6573 732e 6368 6172 6d2c  r(harness.charm,
+000105c0: 2022 6865 6c70 6572 2229 0a20 2020 2020   "helper").     
+000105d0: 2020 2068 6172 6e65 7373 2e61 6464 5f73     harness.add_s
+000105e0: 746f 7261 6765 2822 7465 7374 2d77 6974  torage("test-wit
+000105f0: 682d 6879 7068 656e 7322 2c20 6174 7461  h-hyphens", atta
+00010600: 6368 3d54 7275 6529 5b30 5d0a 0a20 2020  ch=True)[0]..   
+00010610: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010620: 4571 7561 6c28 6c65 6e28 6865 6c70 6572  Equal(len(helper
+00010630: 2e63 6861 6e67 6573 292c 2031 290a 0a20  .changes), 1).. 
+00010640: 2020 2064 6566 2074 6573 745f 6174 7461     def test_atta
+00010650: 6368 5f73 746f 7261 6765 2873 656c 6629  ch_storage(self)
+00010660: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+00010670: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00010680: 4861 726e 6573 7328 5374 6f72 6167 6554  Harness(StorageT
+00010690: 6573 7465 722c 206d 6574 613d 2727 270a  ester, meta='''.
+000106a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000106b0: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+000106c0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+000106d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000106e0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+000106f0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+00010700: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00010710: 2020 2020 2020 7374 6f72 6167 653a 0a20        storage:. 
+00010720: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00010730: 6573 743a 0a20 2020 2020 2020 2020 2020  est:.           
+00010740: 2020 2020 2020 2020 2074 7970 653a 2066           type: f
+00010750: 696c 6573 7973 7465 6d0a 2020 2020 2020  ilesystem.      
+00010760: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00010770: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00010780: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00010790: 7570 290a 0a20 2020 2020 2020 2023 2053  up)..        # S
+000107a0: 6574 2075 7020 696e 6974 6961 6c20 7374  et up initial st
+000107b0: 6f72 6167 650a 2020 2020 2020 2020 7374  orage.        st
+000107c0: 6f72 5f69 6420 3d20 6861 726e 6573 732e  or_id = harness.
+000107d0: 6164 645f 7374 6f72 6167 6528 2274 6573  add_storage("tes
+000107e0: 7422 295b 305d 0a20 2020 2020 2020 2068  t")[0].        h
+000107f0: 6172 6e65 7373 2e62 6567 696e 5f77 6974  arness.begin_wit
+00010800: 685f 696e 6974 6961 6c5f 686f 6f6b 7328  h_initial_hooks(
+00010810: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010820: 7373 6572 7445 7175 616c 286c 656e 2868  ssertEqual(len(h
+00010830: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+00010840: 6572 7665 645f 6576 656e 7473 292c 2031  erved_events), 1
+00010850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00010860: 7373 6572 7454 7275 6528 6973 696e 7374  ssertTrue(isinst
+00010870: 616e 6365 2868 6172 6e65 7373 2e63 6861  ance(harness.cha
+00010880: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
+00010890: 7473 5b30 5d2c 206f 7073 2e53 746f 7261  ts[0], ops.Stora
+000108a0: 6765 4174 7461 6368 6564 4576 656e 7429  geAttachedEvent)
+000108b0: 290a 0a20 2020 2020 2020 2023 2044 6574  )..        # Det
+000108c0: 6163 6820 7374 6f72 6167 650a 2020 2020  ach storage.    
+000108d0: 2020 2020 6861 726e 6573 732e 6465 7461      harness.deta
+000108e0: 6368 5f73 746f 7261 6765 2873 746f 725f  ch_storage(stor_
+000108f0: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
+00010900: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00010910: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
+00010920: 6273 6572 7665 645f 6576 656e 7473 292c  bserved_events),
+00010930: 2032 290a 2020 2020 2020 2020 7365 6c66   2).        self
+00010940: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
+00010950: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
+00010960: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
+00010970: 656e 7473 5b31 5d2c 206f 7073 2e53 746f  ents[1], ops.Sto
+00010980: 7261 6765 4465 7461 6368 696e 6745 7665  rageDetachingEve
+00010990: 6e74 2929 0a0a 2020 2020 2020 2020 2320  nt))..        # 
+000109a0: 5265 2d61 7474 6163 6820 7374 6f72 6167  Re-attach storag
+000109b0: 650a 2020 2020 2020 2020 6861 726e 6573  e.        harnes
+000109c0: 732e 6174 7461 6368 5f73 746f 7261 6765  s.attach_storage
+000109d0: 2873 746f 725f 6964 290a 2020 2020 2020  (stor_id).      
+000109e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000109f0: 616c 286c 656e 2868 6172 6e65 7373 2e63  al(len(harness.c
+00010a00: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
+00010a10: 656e 7473 292c 2033 290a 2020 2020 2020  ents), 3).      
+00010a20: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00010a30: 6528 6973 696e 7374 616e 6365 2868 6172  e(isinstance(har
+00010a40: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+00010a50: 7665 645f 6576 656e 7473 5b32 5d2c 206f  ved_events[2], o
+00010a60: 7073 2e53 746f 7261 6765 4174 7461 6368  ps.StorageAttach
+00010a70: 6564 4576 656e 7429 290a 0a20 2020 2020  edEvent))..     
+00010a80: 2020 2023 2056 6572 6966 7920 6261 636b     # Verify back
+00010a90: 656e 6420 6675 6e63 7469 6f6e 7320 7265  end functions re
+00010aa0: 7475 726e 2061 7070 726f 7072 6961 7465  turn appropriate
+00010ab0: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
+00010ac0: 2023 2052 6561 6c20 6261 636b 656e 6420   # Real backend 
+00010ad0: 776f 756c 6420 7265 7475 726e 2069 6e66  would return inf
+00010ae0: 6f20 6f6e 6c79 2066 6f72 2061 6374 6976  o only for activ
+00010af0: 656c 7920 6174 7461 6368 6564 2073 746f  ely attached sto
+00010b00: 7261 6765 2075 6e69 7473 2e0a 2020 2020  rage units..    
+00010b10: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00010b20: 6e28 7365 6c66 2e5f 6578 7472 6163 745f  n(self._extract_
+00010b30: 7374 6f72 6167 655f 696e 6465 7828 7374  storage_index(st
+00010b40: 6f72 5f69 6429 2c20 6861 726e 6573 732e  or_id), harness.
+00010b50: 5f62 6163 6b65 6e64 2e73 746f 7261 6765  _backend.storage
+00010b60: 5f6c 6973 7428 2274 6573 7422 2929 0a20  _list("test")). 
+00010b70: 2020 2020 2020 2077 616e 7420 3d20 7374         want = st
+00010b80: 7228 7061 7468 6c69 622e 5075 7265 5061  r(pathlib.PurePa
+00010b90: 7468 2827 7465 7374 272c 2027 3027 2929  th('test', '0'))
+00010ba0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010bb0: 7365 7274 4571 7561 6c28 7761 6e74 2c20  sertEqual(want, 
+00010bc0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+00010bd0: 2e73 746f 7261 6765 5f67 6574 2822 7465  .storage_get("te
+00010be0: 7374 2f30 222c 2022 6c6f 6361 7469 6f6e  st/0", "location
+00010bf0: 2229 5b2d 363a 5d29 0a0a 2020 2020 2020  ")[-6:])..      
+00010c00: 2020 2320 5265 7472 7920 6174 7461 6368    # Retry attach
+00010c10: 0a20 2020 2020 2020 2023 2053 696e 6365  .        # Since
+00010c20: 2061 6c72 6561 6479 2064 6574 6163 6865   already detache
+00010c30: 642c 206e 6f20 6d6f 7265 2068 6f6f 6b73  d, no more hooks
+00010c40: 2073 686f 756c 6420 6669 7265 0a20 2020   should fire.   
+00010c50: 2020 2020 2068 6172 6e65 7373 2e61 7474       harness.att
+00010c60: 6163 685f 7374 6f72 6167 6528 7374 6f72  ach_storage(stor
+00010c70: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
+00010c80: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00010c90: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
+00010ca0: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
+00010cb0: 2c20 3329 0a20 2020 2020 2020 2073 656c  , 3).        sel
+00010cc0: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
+00010cd0: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+00010ce0: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00010cf0: 7665 6e74 735b 325d 2c20 6f70 732e 5374  vents[2], ops.St
+00010d00: 6f72 6167 6541 7474 6163 6865 6445 7665  orageAttachedEve
+00010d10: 6e74 2929 0a0a 2020 2020 6465 6620 7465  nt))..    def te
+00010d20: 7374 5f61 7474 6163 685f 7374 6f72 6167  st_attach_storag
+00010d30: 655f 6265 666f 7265 5f68 6172 6e65 7373  e_before_harness
+00010d40: 5f62 6567 696e 2873 656c 6629 3a0a 2020  _begin(self):.  
+00010d50: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+00010d60: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00010d70: 6573 7328 5374 6f72 6167 6554 6573 7465  ess(StorageTeste
+00010d80: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
+00010d90: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+00010da0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+00010db0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
+00010dc0: 2020 2020 2020 2020 2020 2020 2064 623a               db:
+00010dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010de0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00010df0: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
+00010e00: 2020 7374 6f72 6167 653a 0a20 2020 2020    storage:.     
+00010e10: 2020 2020 2020 2020 2020 2074 6573 743a             test:
+00010e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e30: 2020 2020 2074 7970 653a 2066 696c 6573       type: files
+00010e40: 7973 7465 6d0a 2020 2020 2020 2020 2020  ystem.          
+00010e50: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+00010e60: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+00010e70: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+00010e80: 0a20 2020 2020 2020 2023 2057 6520 6465  .        # We de
+00010e90: 6c69 6265 7261 7465 6c79 2064 6f6e 2774  liberately don't
+00010ea0: 2067 7561 7264 2061 6761 696e 7374 2061   guard against a
+00010eb0: 7474 6163 6869 6e67 2073 746f 7261 6765  ttaching storage
+00010ec0: 2062 6566 6f72 6520 7468 6520 6861 726e   before the harn
+00010ed0: 6573 7320 6265 6769 6e73 2c0a 2020 2020  ess begins,.    
+00010ee0: 2020 2020 2320 6173 2074 6865 7265 2061      # as there a
+00010ef0: 7265 206c 6567 6974 696d 6174 6520 7265  re legitimate re
+00010f00: 6173 6f6e 7320 746f 2064 6f20 736f 2e0a  asons to do so..
+00010f10: 2020 2020 2020 2020 7374 6f72 5f69 6420          stor_id 
+00010f20: 3d20 6861 726e 6573 732e 6164 645f 7374  = harness.add_st
+00010f30: 6f72 6167 6528 2274 6573 7422 295b 305d  orage("test")[0]
+00010f40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00010f50: 7365 7274 5472 7565 2873 746f 725f 6964  sertTrue(stor_id
+00010f60: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00010f70: 7265 6d6f 7665 5f73 746f 7261 6765 5f62  remove_storage_b
+00010f80: 6566 6f72 655f 6861 726e 6573 735f 6265  efore_harness_be
+00010f90: 6769 6e28 7365 6c66 293a 0a20 2020 2020  gin(self):.     
+00010fa0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+00010fb0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+00010fc0: 2853 746f 7261 6765 5465 7374 6572 2c20  (StorageTester, 
+00010fd0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+00010fe0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00010ff0: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
+00011000: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
+00011010: 2020 2020 2020 2020 2020 6462 3a0a 2020            db:.  
+00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011030: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
+00011040: 716c 0a20 2020 2020 2020 2020 2020 2073  ql.            s
+00011050: 746f 7261 6765 3a0a 2020 2020 2020 2020  torage:.        
+00011060: 2020 2020 2020 2020 7465 7374 3a0a 2020          test:.  
+00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011080: 2020 7479 7065 3a20 6669 6c65 7379 7374    type: filesyst
+00011090: 656d 0a20 2020 2020 2020 2020 2020 2020  em.             
+000110a0: 2020 2020 2020 206d 756c 7469 706c 653a         multiple:
+000110b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000110c0: 2020 2020 2020 2020 2072 616e 6765 3a20           range: 
+000110d0: 312d 330a 2020 2020 2020 2020 2020 2020  1-3.            
+000110e0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+000110f0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00011100: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
+00011110: 2020 2020 2020 2073 746f 725f 6964 7320         stor_ids 
+00011120: 3d20 6861 726e 6573 732e 6164 645f 7374  = harness.add_st
+00011130: 6f72 6167 6528 2274 6573 7422 2c20 636f  orage("test", co
+00011140: 756e 743d 3229 0a20 2020 2020 2020 2068  unt=2).        h
+00011150: 6172 6e65 7373 2e72 656d 6f76 655f 7374  arness.remove_st
+00011160: 6f72 6167 6528 7374 6f72 5f69 6473 5b30  orage(stor_ids[0
+00011170: 5d29 0a20 2020 2020 2020 2023 204e 6f74  ]).        # Not
+00011180: 6520 7265 3a20 6465 6c74 6120 6265 7477  e re: delta betw
+00011190: 6565 6e20 7265 616c 2062 6568 6176 696f  een real behavio
+000111a0: 7220 616e 6420 4861 726e 6573 733a 204a  r and Harness: J
+000111b0: 756a 7520 646f 6573 6e27 7420 616c 6c6f  uju doesn't allo
+000111c0: 7720 7265 6d6f 7661 6c0a 2020 2020 2020  w removal.      
+000111d0: 2020 2320 6f66 2074 6865 206c 6173 7420    # of the last 
+000111e0: 6174 7461 6368 6564 2073 746f 7261 6765  attached storage
+000111f0: 2075 6e69 7420 7768 696c 6520 6120 776f   unit while a wo
+00011200: 726b 6c6f 6164 2069 7320 7374 696c 6c20  rkload is still 
+00011210: 7275 6e6e 696e 672e 2020 546f 206d 6f72  running.  To mor
+00011220: 650a 2020 2020 2020 2020 2320 6561 7369  e.        # easi
+00011230: 6c79 2061 6c6c 6f77 2074 6573 7469 6e67  ly allow testing
+00011240: 206f 6620 7374 6f72 6167 6520 7265 6d6f   of storage remo
+00011250: 7661 6c2c 2049 2061 6d20 7072 6573 656e  val, I am presen
+00011260: 746c 7920 6967 6e6f 7269 6e67 2074 6869  tly ignoring thi
+00011270: 7320 6465 7461 696c 2e0a 2020 2020 2020  s detail..      
+00011280: 2020 2320 284f 7468 6572 7769 7365 2c20    # (Otherwise, 
+00011290: 7468 6520 7573 6572 2077 6f75 6c64 206e  the user would n
+000112a0: 6565 6420 746f 2066 6c61 6720 736f 6d65  eed to flag some
+000112b0: 686f 7720 7468 6174 2074 6865 7920 6172  how that they ar
+000112c0: 6520 696e 7465 6e74 696f 6e61 6c6c 790a  e intentionally.
+000112d0: 2020 2020 2020 2020 2320 7265 6d6f 7669          # removi
+000112e0: 6e67 2074 6865 2066 696e 616c 2075 6e69  ng the final uni
+000112f0: 7420 6173 2070 6172 7420 6f66 2061 2073  t as part of a s
+00011300: 6875 7464 6f77 6e20 7072 6f63 6564 7572  hutdown procedur
+00011310: 652c 2065 6c73 6520 6974 2764 2062 6c6f  e, else it'd blo
+00011320: 636b 2074 6865 0a20 2020 2020 2020 2023  ck the.        #
+00011330: 2072 656d 6f76 616c 2e20 2049 276d 206e   removal.  I'm n
+00011340: 6f74 2073 7572 6520 7375 6368 2062 6568  ot sure such beh
+00011350: 6176 696f 7220 6973 2070 726f 6475 6374  avior is product
+00011360: 6976 652e 290a 0a20 2020 2020 2020 2068  ive.)..        h
+00011370: 6172 6e65 7373 2e62 6567 696e 5f77 6974  arness.begin_wit
+00011380: 685f 696e 6974 6961 6c5f 686f 6f6b 7328  h_initial_hooks(
+00011390: 290a 2020 2020 2020 2020 2320 4f6e 6c79  ).        # Only
+000113a0: 206f 6e65 2068 6f6f 6b20 7769 6c6c 2066   one hook will f
+000113b0: 6972 653b 206f 6e65 2077 6f6e 2774 2073  ire; one won't s
+000113c0: 696e 6365 2069 7420 7761 7320 7265 6d6f  ince it was remo
+000113d0: 7665 640a 2020 2020 2020 2020 7365 6c66  ved.        self
+000113e0: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+000113f0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
+00011400: 6273 6572 7665 645f 6576 656e 7473 292c  bserved_events),
+00011410: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+00011420: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
+00011430: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
+00011440: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
+00011450: 656e 7473 5b30 5d2c 206f 7073 2e53 746f  ents[0], ops.Sto
+00011460: 7261 6765 4174 7461 6368 6564 4576 656e  rageAttachedEven
+00011470: 7429 290a 0a20 2020 2064 6566 2074 6573  t))..    def tes
+00011480: 745f 7265 6d6f 7665 5f73 746f 7261 6765  t_remove_storage
+00011490: 5f77 6974 686f 7574 5f6d 6574 6164 6174  _without_metadat
+000114a0: 615f 6b65 795f 6661 696c 7328 7365 6c66  a_key_fails(self
+000114b0: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+000114c0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+000114d0: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+000114e0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+000114f0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00011500: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+00011510: 2020 2020 2020 2020 7265 7175 6972 6573          requires
+00011520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011530: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
+00011540: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+00011550: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
+00011560: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00011570: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00011580: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+00011590: 6e75 7029 0a0a 2020 2020 2020 2020 2320  nup)..        # 
+000115a0: 446f 6573 6e27 7420 7265 616c 6c79 206d  Doesn't really m
+000115b0: 616b 6520 7365 6e73 6520 7369 6e63 6520  ake sense since 
+000115c0: 7765 2061 6c72 6561 6479 2063 616e 2774  we already can't
+000115d0: 2061 6464 2073 746f 7261 6765 2077 6869   add storage whi
+000115e0: 6368 2069 736e 2774 2069 6e20 7468 6520  ch isn't in the 
+000115f0: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
+00011600: 2020 2320 6275 7420 696e 636c 7564 6564    # but included
+00011610: 2066 6f72 2063 6f6d 706c 6574 656e 6573   for completenes
+00011620: 732e 0a20 2020 2020 2020 2077 6974 6820  s..        with 
+00011630: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00011640: 7328 5275 6e74 696d 6545 7272 6f72 2920  s(RuntimeError) 
+00011650: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+00011660: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
+00011670: 655f 7374 6f72 6167 6528 2274 6573 742f  e_storage("test/
+00011680: 3022 290a 2020 2020 2020 2020 7365 6c66  0").        self
+00011690: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+000116a0: 2020 2020 2020 2020 2020 636d 2e65 7863            cm.exc
+000116b0: 6570 7469 6f6e 2e61 7267 735b 305d 2c0a  eption.args[0],.
+000116c0: 2020 2020 2020 2020 2020 2020 2274 6865              "the
+000116d0: 206b 6579 2027 7465 7374 2720 6973 206e   key 'test' is n
+000116e0: 6f74 2073 7065 6369 6669 6564 2061 7320  ot specified as 
+000116f0: 6120 7374 6f72 6167 6520 6b65 7920 696e  a storage key in
+00011700: 206d 6574 6164 6174 6122 290a 0a20 2020   metadata")..   
+00011710: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
+00011720: 5f73 746f 7261 6765 5f61 6674 6572 5f68  _storage_after_h
+00011730: 6172 6e65 7373 5f62 6567 696e 2873 656c  arness_begin(sel
+00011740: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00011750: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00011760: 672e 4861 726e 6573 7328 5374 6f72 6167  g.Harness(Storag
+00011770: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
+00011780: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00011790: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+000117a0: 2020 2020 2020 2020 2072 6571 7569 7265           require
+000117b0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000117c0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+000117d0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+000117e0: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+000117f0: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
+00011800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011810: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
+00011820: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+00011830: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
+00011840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011850: 6d75 6c74 6970 6c65 3a0a 2020 2020 2020  multiple:.      
+00011860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011870: 2020 7261 6e67 653a 2031 2d33 0a20 2020    range: 1-3.   
+00011880: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00011890: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+000118a0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+000118b0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
+000118c0: 7374 6f72 5f69 6473 203d 2068 6172 6e65  stor_ids = harne
+000118d0: 7373 2e61 6464 5f73 746f 7261 6765 2822  ss.add_storage("
+000118e0: 7465 7374 222c 2063 6f75 6e74 3d32 290a  test", count=2).
+000118f0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00011900: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
+00011910: 616c 5f68 6f6f 6b73 2829 0a20 2020 2020  al_hooks().     
+00011920: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00011930: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
+00011940: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00011950: 7665 6e74 7329 2c20 3229 0a20 2020 2020  vents), 2).     
+00011960: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00011970: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
+00011980: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00011990: 7276 6564 5f65 7665 6e74 735b 305d 2c20  rved_events[0], 
+000119a0: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
+000119b0: 6865 6445 7665 6e74 2929 0a20 2020 2020  hedEvent)).     
+000119c0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+000119d0: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
+000119e0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+000119f0: 7276 6564 5f65 7665 6e74 735b 315d 2c20  rved_events[1], 
+00011a00: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
+00011a10: 6865 6445 7665 6e74 2929 0a0a 2020 2020  hedEvent))..    
+00011a20: 2020 2020 6861 726e 6573 732e 7265 6d6f      harness.remo
+00011a30: 7665 5f73 746f 7261 6765 2873 746f 725f  ve_storage(stor_
+00011a40: 6964 735b 315d 290a 2020 2020 2020 2020  ids[1]).        
+00011a50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00011a60: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
+00011a70: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
+00011a80: 7473 292c 2033 290a 2020 2020 2020 2020  ts), 3).        
+00011a90: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+00011aa0: 6973 696e 7374 616e 6365 2868 6172 6e65  isinstance(harne
+00011ab0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+00011ac0: 645f 6576 656e 7473 5b32 5d2c 206f 7073  d_events[2], ops
+00011ad0: 2e53 746f 7261 6765 4465 7461 6368 696e  .StorageDetachin
+00011ae0: 6745 7665 6e74 2929 0a0a 2020 2020 2020  gEvent))..      
+00011af0: 2020 6174 7461 6368 6564 5f73 746f 7261    attached_stora
+00011b00: 6765 5f69 6473 203d 2068 6172 6e65 7373  ge_ids = harness
+00011b10: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
+00011b20: 655f 6c69 7374 2822 7465 7374 2229 0a20  e_list("test"). 
+00011b30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011b40: 7274 496e 2873 656c 662e 5f65 7874 7261  rtIn(self._extra
+00011b50: 6374 5f73 746f 7261 6765 5f69 6e64 6578  ct_storage_index
+00011b60: 2873 746f 725f 6964 735b 305d 292c 2061  (stor_ids[0]), a
+00011b70: 7474 6163 6865 645f 7374 6f72 6167 655f  ttached_storage_
+00011b80: 6964 7329 0a20 2020 2020 2020 2073 656c  ids).        sel
+00011b90: 662e 6173 7365 7274 4e6f 7449 6e28 7365  f.assertNotIn(se
+00011ba0: 6c66 2e5f 6578 7472 6163 745f 7374 6f72  lf._extract_stor
+00011bb0: 6167 655f 696e 6465 7828 7374 6f72 5f69  age_index(stor_i
+00011bc0: 6473 5b31 5d29 2c20 6174 7461 6368 6564  ds[1]), attached
+00011bd0: 5f73 746f 7261 6765 5f69 6473 290a 0a20  _storage_ids).. 
+00011be0: 2020 2064 6566 205f 6578 7472 6163 745f     def _extract_
+00011bf0: 7374 6f72 6167 655f 696e 6465 7828 7365  storage_index(se
+00011c00: 6c66 2c20 7374 6f72 5f69 6429 3a0a 2020  lf, stor_id):.  
+00011c10: 2020 2020 2020 7265 7475 726e 2069 6e74        return int
+00011c20: 2873 746f 725f 6964 2e73 706c 6974 2827  (stor_id.split('
+00011c30: 2f27 295b 2d31 5d29 0a0a 2020 2020 6465  /')[-1])..    de
+00011c40: 6620 7465 7374 5f72 656d 6f76 655f 6465  f test_remove_de
+00011c50: 7461 6368 6564 5f73 746f 7261 6765 2873  tached_storage(s
+00011c60: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00011c70: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00011c80: 696e 672e 4861 726e 6573 7328 5374 6f72  ing.Harness(Stor
+00011c90: 6167 6554 6573 7465 722c 206d 6574 613d  ageTester, meta=
+00011ca0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00011cb0: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+00011cc0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+00011cd0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00011ce0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+00011cf0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00011d00: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+00011d10: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00011d20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00011d30: 2020 2074 6573 743a 0a20 2020 2020 2020     test:.       
+00011d40: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00011d50: 653a 2066 696c 6573 7973 7465 6d0a 2020  e: filesystem.  
+00011d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d70: 2020 6d75 6c74 6970 6c65 3a0a 2020 2020    multiple:.    
+00011d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d90: 2020 2020 7261 6e67 653a 2031 2d33 0a20      range: 1-3. 
+00011da0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00011db0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00011dc0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00011dd0: 636c 6561 6e75 7029 0a0a 2020 2020 2020  cleanup)..      
+00011de0: 2020 7374 6f72 5f69 6473 203d 2068 6172    stor_ids = har
+00011df0: 6e65 7373 2e61 6464 5f73 746f 7261 6765  ness.add_storage
+00011e00: 2822 7465 7374 222c 2063 6f75 6e74 3d32  ("test", count=2
+00011e10: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00011e20: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
+00011e30: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
+00011e40: 2020 2020 2068 6172 6e65 7373 2e64 6574       harness.det
+00011e50: 6163 685f 7374 6f72 6167 6528 7374 6f72  ach_storage(stor
+00011e60: 5f69 6473 5b30 5d29 0a20 2020 2020 2020  _ids[0]).       
+00011e70: 2068 6172 6e65 7373 2e72 656d 6f76 655f   harness.remove_
+00011e80: 7374 6f72 6167 6528 7374 6f72 5f69 6473  storage(stor_ids
+00011e90: 5b30 5d29 2020 2320 416c 7265 6164 7920  [0])  # Already 
+00011ea0: 6465 7461 6368 6564 2c20 736f 2077 6f6e  detached, so won
+00011eb0: 2774 2066 6972 6520 6120 686f 6f6b 0a20  't fire a hook. 
+00011ec0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011ed0: 7274 4571 7561 6c28 6c65 6e28 6861 726e  rtEqual(len(harn
+00011ee0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+00011ef0: 6564 5f65 7665 6e74 7329 2c20 3329 0a20  ed_events), 3). 
+00011f00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011f10: 7274 5472 7565 2869 7369 6e73 7461 6e63  rtTrue(isinstanc
+00011f20: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+00011f30: 6f62 7365 7276 6564 5f65 7665 6e74 735b  observed_events[
+00011f40: 305d 2c20 6f70 732e 5374 6f72 6167 6541  0], ops.StorageA
+00011f50: 7474 6163 6865 6445 7665 6e74 2929 0a20  ttachedEvent)). 
+00011f60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011f70: 7274 5472 7565 2869 7369 6e73 7461 6e63  rtTrue(isinstanc
+00011f80: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+00011f90: 6f62 7365 7276 6564 5f65 7665 6e74 735b  observed_events[
+00011fa0: 315d 2c20 6f70 732e 5374 6f72 6167 6541  1], ops.StorageA
+00011fb0: 7474 6163 6865 6445 7665 6e74 2929 0a20  ttachedEvent)). 
+00011fc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011fd0: 7274 5472 7565 2869 7369 6e73 7461 6e63  rtTrue(isinstanc
+00011fe0: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+00011ff0: 6f62 7365 7276 6564 5f65 7665 6e74 735b  observed_events[
+00012000: 325d 2c20 6f70 732e 5374 6f72 6167 6544  2], ops.StorageD
+00012010: 6574 6163 6869 6e67 4576 656e 7429 290a  etachingEvent)).
+00012020: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
+00012030: 7469 6f6e 735f 6672 6f6d 5f64 6972 6563  tions_from_direc
+00012040: 746f 7279 2873 656c 6629 3a0a 2020 2020  tory(self):.    
+00012050: 2020 2020 746d 7020 3d20 7061 7468 6c69      tmp = pathli
+00012060: 622e 5061 7468 2874 656d 7066 696c 652e  b.Path(tempfile.
+00012070: 6d6b 6474 656d 7028 2929 0a20 2020 2020  mkdtemp()).     
+00012080: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00012090: 7570 2873 6875 7469 6c2e 726d 7472 6565  up(shutil.rmtree
+000120a0: 2c20 7374 7228 746d 7029 290a 2020 2020  , str(tmp)).    
+000120b0: 2020 2020 6163 7469 6f6e 735f 6669 6c65      actions_file
+000120c0: 6e61 6d65 203d 2074 6d70 202f 2027 6163  name = tmp / 'ac
+000120d0: 7469 6f6e 732e 7961 6d6c 270a 2020 2020  tions.yaml'.    
+000120e0: 2020 2020 7769 7468 2061 6374 696f 6e73      with actions
+000120f0: 5f66 696c 656e 616d 652e 6f70 656e 2827  _filename.open('
+00012100: 7774 2729 2061 7320 6163 7469 6f6e 733a  wt') as actions:
+00012110: 0a20 2020 2020 2020 2020 2020 2061 6374  .            act
+00012120: 696f 6e73 2e77 7269 7465 2874 6578 7477  ions.write(textw
+00012130: 7261 702e 6465 6465 6e74 2827 2727 0a20  rap.dedent('''. 
+00012140: 2020 2020 2020 2020 2020 2074 6573 743a             test:
+00012150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012160: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
+00012170: 6475 6d6d 7920 6163 7469 6f6e 0a20 2020  dummy action.   
+00012180: 2020 2020 2020 2020 2027 2727 2929 0a20           ''')). 
+00012190: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+000121a0: 2073 656c 662e 5f67 6574 5f64 756d 6d79   self._get_dummy
+000121b0: 5f63 6861 726d 5f68 6172 6e65 7373 2874  _charm_harness(t
+000121c0: 6d70 290a 2020 2020 2020 2020 6861 726e  mp).        harn
+000121d0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+000121e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000121f0: 7175 616c 286c 6973 7428 6861 726e 6573  qual(list(harnes
+00012200: 732e 6672 616d 6577 6f72 6b2e 6d65 7461  s.framework.meta
+00012210: 2e61 6374 696f 6e73 292c 205b 2774 6573  .actions), ['tes
+00012220: 7427 5d29 0a20 2020 2020 2020 2023 2054  t']).        # T
+00012230: 6865 2063 6861 726d 5f64 6972 2061 6c73  he charm_dir als
+00012240: 6f20 6765 7473 2073 6574 0a20 2020 2020  o gets set.     
+00012250: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00012260: 7561 6c28 6861 726e 6573 732e 6672 616d  ual(harness.fram
+00012270: 6577 6f72 6b2e 6368 6172 6d5f 6469 722c  ework.charm_dir,
+00012280: 2074 6d70 290a 0a20 2020 2064 6566 2074   tmp)..    def t
+00012290: 6573 745f 6163 7469 6f6e 735f 6672 6f6d  est_actions_from
+000122a0: 5f64 6972 6563 746f 7279 5f63 6861 726d  _directory_charm
+000122b0: 6372 6166 745f 7961 6d6c 2873 656c 6629  craft_yaml(self)
+000122c0: 3a0a 2020 2020 2020 2020 746d 7020 3d20  :.        tmp = 
+000122d0: 7061 7468 6c69 622e 5061 7468 2874 656d  pathlib.Path(tem
+000122e0: 7066 696c 652e 6d6b 6474 656d 7028 2929  pfile.mkdtemp())
+000122f0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00012300: 6443 6c65 616e 7570 2873 6875 7469 6c2e  dCleanup(shutil.
+00012310: 726d 7472 6565 2c20 746d 7029 0a20 2020  rmtree, tmp).   
+00012320: 2020 2020 2063 6861 726d 6372 6166 745f       charmcraft_
+00012330: 6669 6c65 6e61 6d65 203d 2074 6d70 202f  filename = tmp /
+00012340: 2027 6368 6172 6d63 7261 6674 2e79 616d   'charmcraft.yam
+00012350: 6c27 0a20 2020 2020 2020 2063 6861 726d  l'.        charm
+00012360: 6372 6166 745f 6669 6c65 6e61 6d65 2e77  craft_filename.w
+00012370: 7269 7465 5f74 6578 7428 7465 7874 7772  rite_text(textwr
+00012380: 6170 2e64 6564 656e 7428 2727 270a 2020  ap.dedent('''.  
+00012390: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
+000123a0: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+000123b0: 2020 6261 7365 733a 0a20 2020 2020 2020    bases:.       
+000123c0: 2020 2020 2020 202d 2062 7569 6c64 2d6f         - build-o
+000123d0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000123e0: 2020 2020 202d 206e 616d 653a 2075 6275       - name: ubu
+000123f0: 6e74 750a 2020 2020 2020 2020 2020 2020  ntu.            
+00012400: 2020 2020 2020 2020 6368 616e 6e65 6c3a          channel:
+00012410: 2022 3232 2e30 3422 0a20 2020 2020 2020   "22.04".       
+00012420: 2020 2020 2020 2020 2072 756e 2d6f 6e3a           run-on:
+00012430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012440: 2020 202d 206e 616d 653a 2075 6275 6e74     - name: ubunt
+00012450: 750a 2020 2020 2020 2020 2020 2020 2020  u.              
+00012460: 2020 2020 2020 6368 616e 6e65 6c3a 2022        channel: "
+00012470: 3232 2e30 3422 0a0a 2020 2020 2020 2020  22.04"..        
+00012480: 2020 2020 6163 7469 6f6e 733a 0a20 2020      actions:.   
+00012490: 2020 2020 2020 2020 2020 2074 6573 743a             test:
+000124a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124b0: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
+000124c0: 6475 6d6d 7920 6163 7469 6f6e 0a20 2020  dummy action.   
+000124d0: 2020 2020 2027 2727 2929 0a20 2020 2020       ''')).     
+000124e0: 2020 2068 6172 6e65 7373 203d 2073 656c     harness = sel
+000124f0: 662e 5f67 6574 5f64 756d 6d79 5f63 6861  f._get_dummy_cha
+00012500: 726d 5f68 6172 6e65 7373 2874 6d70 290a  rm_harness(tmp).
+00012510: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00012520: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00012530: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012540: 286c 6973 7428 6861 726e 6573 732e 6672  (list(harness.fr
+00012550: 616d 6577 6f72 6b2e 6d65 7461 2e61 6374  amework.meta.act
+00012560: 696f 6e73 292c 205b 2774 6573 7427 5d29  ions), ['test'])
+00012570: 0a20 2020 2020 2020 2023 2054 6865 2063  .        # The c
+00012580: 6861 726d 5f64 6972 2061 6c73 6f20 6765  harm_dir also ge
+00012590: 7473 2073 6574 0a20 2020 2020 2020 2073  ts set.        s
+000125a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000125b0: 6861 726e 6573 732e 6672 616d 6577 6f72  harness.framewor
+000125c0: 6b2e 6368 6172 6d5f 6469 722c 2074 6d70  k.charm_dir, tmp
+000125d0: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
+000125e0: 6475 6d6d 795f 6368 6172 6d5f 6861 726e  dummy_charm_harn
+000125f0: 6573 7328 7365 6c66 2c20 746d 7029 3a0a  ess(self, tmp):.
+00012600: 2020 2020 2020 2020 7365 6c66 2e5f 7772          self._wr
+00012610: 6974 655f 6475 6d6d 795f 6368 6172 6d28  ite_dummy_charm(
+00012620: 746d 7029 0a20 2020 2020 2020 2063 6861  tmp).        cha
+00012630: 726d 5f6d 6f64 203d 2069 6d70 6f72 746c  rm_mod = importl
+00012640: 6962 2e69 6d70 6f72 745f 6d6f 6475 6c65  ib.import_module
+00012650: 2827 7465 7374 6368 6172 6d27 290a 2020  ('testcharm').  
+00012660: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+00012670: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00012680: 6573 7328 6368 6172 6d5f 6d6f 642e 4d79  ess(charm_mod.My
+00012690: 5465 7374 696e 6743 6861 726d 290a 2020  TestingCharm).  
+000126a0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+000126b0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+000126c0: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
+000126d0: 6574 7572 6e20 6861 726e 6573 730a 0a20  eturn harness.. 
+000126e0: 2020 2064 6566 205f 7772 6974 655f 6475     def _write_du
+000126f0: 6d6d 795f 6368 6172 6d28 7365 6c66 2c20  mmy_charm(self, 
+00012700: 746d 7029 3a0a 2020 2020 2020 2020 7372  tmp):.        sr
+00012710: 6364 6972 203d 2074 6d70 202f 2027 7372  cdir = tmp / 'sr
+00012720: 6327 0a20 2020 2020 2020 2073 7263 6469  c'.        srcdi
+00012730: 722e 6d6b 6469 7228 306f 3735 3529 0a20  r.mkdir(0o755). 
+00012740: 2020 2020 2020 2063 6861 726d 5f66 696c         charm_fil
+00012750: 656e 616d 6520 3d20 7372 6364 6972 202f  ename = srcdir /
+00012760: 2027 7465 7374 6368 6172 6d2e 7079 270a   'testcharm.py'.
+00012770: 2020 2020 2020 2020 7769 7468 2063 6861          with cha
+00012780: 726d 5f66 696c 656e 616d 652e 6f70 656e  rm_filename.open
+00012790: 2827 7774 2729 2061 7320 6368 6172 6d70  ('wt') as charmp
+000127a0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+000127b0: 206c 616e 6775 6167 653d 5079 7468 6f6e   language=Python
+000127c0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+000127d0: 726d 7079 2e77 7269 7465 2874 6578 7477  rmpy.write(textw
+000127e0: 7261 702e 6465 6465 6e74 2827 2727 0a20  rap.dedent('''. 
+000127f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012800: 726f 6d20 6f70 7320 696d 706f 7274 2043  rom ops import C
+00012810: 6861 726d 4261 7365 0a20 2020 2020 2020  harmBase.       
+00012820: 2020 2020 2020 2020 2063 6c61 7373 204d           class M
+00012830: 7954 6573 7469 6e67 4368 6172 6d28 4368  yTestingCharm(Ch
+00012840: 6172 6d42 6173 6529 3a0a 2020 2020 2020  armBase):.      
+00012850: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00012860: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00012870: 2020 2027 2727 2929 0a20 2020 2020 2020     ''')).       
+00012880: 206f 7269 6720 3d20 7379 732e 7061 7468   orig = sys.path
+00012890: 5b3a 5d0a 2020 2020 2020 2020 7379 732e  [:].        sys.
+000128a0: 7061 7468 2e61 7070 656e 6428 7374 7228  path.append(str(
+000128b0: 7372 6364 6972 2929 0a0a 2020 2020 2020  srcdir))..      
+000128c0: 2020 6465 6620 636c 6561 6e75 7028 293a    def cleanup():
+000128d0: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
+000128e0: 2e70 6174 6820 3d20 6f72 6967 0a20 2020  .path = orig.   
+000128f0: 2020 2020 2020 2020 2073 7973 2e6d 6f64           sys.mod
+00012900: 756c 6573 2e70 6f70 2827 7465 7374 6368  ules.pop('testch
+00012910: 6172 6d27 290a 0a20 2020 2020 2020 2073  arm')..        s
+00012920: 656c 662e 6164 6443 6c65 616e 7570 2863  elf.addCleanup(c
+00012930: 6c65 616e 7570 290a 0a20 2020 2064 6566  leanup)..    def
+00012940: 2074 6573 745f 6163 7469 6f6e 735f 7061   test_actions_pa
+00012950: 7373 6564 5f69 6e28 7365 6c66 293a 0a20  ssed_in(self):. 
+00012960: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00012970: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00012980: 6e65 7373 280a 2020 2020 2020 2020 2020  ness(.          
+00012990: 2020 6f70 732e 4368 6172 6d42 6173 652c    ops.CharmBase,
+000129a0: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+000129b0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+000129c0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+000129d0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+000129e0: 2027 2727 2c0a 2020 2020 2020 2020 2020   ''',.          
+000129f0: 2020 6163 7469 6f6e 733d 2727 270a 2020    actions='''.  
+00012a00: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00012a10: 7374 2d61 6374 696f 6e3a 0a20 2020 2020  st-action:.     
+00012a20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00012a30: 6573 6372 6970 7469 6f6e 3a20 6120 6475  escription: a du
+00012a40: 6d6d 7920 7465 7374 2061 6374 696f 6e0a  mmy test action.
+00012a50: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00012a60: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00012a70: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00012a80: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00012a90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00012aa0: 616c 286c 6973 7428 6861 726e 6573 732e  al(list(harness.
+00012ab0: 6672 616d 6577 6f72 6b2e 6d65 7461 2e61  framework.meta.a
+00012ac0: 6374 696f 6e73 292c 205b 2774 6573 742d  ctions), ['test-
+00012ad0: 6163 7469 6f6e 275d 290a 0a20 2020 2064  action'])..    d
+00012ae0: 6566 2074 6573 745f 6576 656e 745f 636f  ef test_event_co
+00012af0: 6e74 6578 7428 7365 6c66 293a 0a20 2020  ntext(self):.   
+00012b00: 2020 2020 2063 6c61 7373 204d 7943 6861       class MyCha
+00012b10: 726d 286f 7073 2e43 6861 726d 4261 7365  rm(ops.CharmBase
+00012b20: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+00012b30: 6566 2065 7665 6e74 5f68 616e 646c 6572  ef event_handler
+00012b40: 2873 656c 662c 2065 7674 293a 0a20 2020  (self, evt):.   
+00012b50: 2020 2020 2020 2020 2020 2020 2065 7674               evt
+00012b60: 2e72 656c 6174 696f 6e2e 6461 7461 5b65  .relation.data[e
+00012b70: 7674 2e72 656c 6174 696f 6e2e 6170 705d  vt.relation.app]
+00012b80: 5b27 666f 6f27 5d20 3d20 2762 6172 270a  ['foo'] = 'bar'.
+00012b90: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00012ba0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00012bb0: 6172 6e65 7373 284d 7943 6861 726d 2c20  arness(MyCharm, 
+00012bc0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+00012bd0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00012be0: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+00012bf0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+00012c00: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00012c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c20: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00012c30: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00012c40: 2027 2727 290a 2020 2020 2020 2020 6861   ''').        ha
+00012c50: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+00012c60: 2020 2020 2020 7265 6c5f 6964 203d 2068        rel_id = h
+00012c70: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00012c80: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
+00012c90: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
+00012ca0: 7265 6c20 3d20 6861 726e 6573 732e 6368  rel = harness.ch
+00012cb0: 6172 6d2e 6d6f 6465 6c2e 6765 745f 7265  arm.model.get_re
+00012cc0: 6c61 7469 6f6e 2827 6462 272c 2072 656c  lation('db', rel
+00012cd0: 5f69 6429 0a0a 2020 2020 2020 2020 6576  _id)..        ev
+00012ce0: 656e 7420 3d20 4d61 6769 634d 6f63 6b28  ent = MagicMock(
+00012cf0: 290a 2020 2020 2020 2020 6576 656e 742e  ).        event.
+00012d00: 7265 6c61 7469 6f6e 203d 2072 656c 0a0a  relation = rel..
+00012d10: 2020 2020 2020 2020 7769 7468 2068 6172          with har
+00012d20: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
+00012d30: 6578 7428 276d 795f 7265 6c61 7469 6f6e  ext('my_relation
+00012d40: 5f6a 6f69 6e65 6427 293a 0a20 2020 2020  _joined'):.     
+00012d50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00012d60: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00012d70: 732e 5265 6c61 7469 6f6e 4461 7461 4572  s.RelationDataEr
+00012d80: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00012d90: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+00012da0: 6172 6d2e 6576 656e 745f 6861 6e64 6c65  arm.event_handle
+00012db0: 7228 6576 656e 7429 0a0a 2020 2020 6465  r(event)..    de
+00012dc0: 6620 7465 7374 5f65 7665 6e74 5f63 6f6e  f test_event_con
+00012dd0: 7465 7874 5f69 6e76 6572 7365 2873 656c  text_inverse(sel
+00012de0: 6629 3a0a 2020 2020 2020 2020 636c 6173  f):.        clas
+00012df0: 7320 4d79 4368 6172 6d28 6f70 732e 4368  s MyCharm(ops.Ch
+00012e00: 6172 6d42 6173 6529 3a0a 2020 2020 2020  armBase):.      
+00012e10: 2020 2020 2020 6465 6620 5f5f 696e 6974        def __init
+00012e20: 5f5f 2873 656c 662c 2066 7261 6d65 776f  __(self, framewo
+00012e30: 726b 3a20 6f70 732e 4672 616d 6577 6f72  rk: ops.Framewor
+00012e40: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
+00012e50: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00012e60: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
+00012e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e80: 7365 6c66 2e66 7261 6d65 776f 726b 2e6f  self.framework.o
+00012e90: 6273 6572 7665 2873 656c 662e 6f6e 2e64  bserve(self.on.d
+00012ea0: 625f 7265 6c61 7469 6f6e 5f6a 6f69 6e65  b_relation_joine
+00012eb0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ed0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00012ee0: 6a6f 696e 5f64 6229 0a0a 2020 2020 2020  join_db)..      
+00012ef0: 2020 2020 2020 6465 6620 5f6a 6f69 6e5f        def _join_
+00012f00: 6462 2873 656c 662c 2065 7665 6e74 293a  db(self, event):
+00012f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f20: 2023 2064 6f20 7468 696e 6773 2077 6974   # do things wit
+00012f30: 6820 4150 4973 2077 6520 6361 6e6e 6f74  h APIs we cannot
+00012f40: 2065 6173 696c 7920 6d6f 636b 0a20 2020   easily mock.   
+00012f50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00012f60: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+00012f70: 6445 7272 6f72 0a0a 2020 2020 2020 2020  dError..        
+00012f80: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00012f90: 7374 696e 672e 4861 726e 6573 7328 4d79  sting.Harness(My
+00012fa0: 4368 6172 6d2c 206d 6574 613d 2727 270a  Charm, meta='''.
+00012fb0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00012fc0: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
+00012fd0: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00012fe0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00012ff0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00013000: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00013010: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+00013020: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00013030: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+00013040: 696e 2829 0a0a 2020 2020 2020 2020 6465  in()..        de
+00013050: 6620 6d6f 636b 5f6a 6f69 6e5f 6462 2865  f mock_join_db(e
+00013060: 7665 6e74 293a 0a20 2020 2020 2020 2020  vent):.         
+00013070: 2020 2023 2074 6865 2068 6172 6e65 7373     # the harness
+00013080: 2074 6869 6e6b 7320 7765 2772 6520 696e   thinks we're in
+00013090: 7369 6465 2061 2064 625f 7265 6c61 7469  side a db_relati
+000130a0: 6f6e 5f6a 6f69 6e65 6420 686f 6f6b 0a20  on_joined hook. 
+000130b0: 2020 2020 2020 2020 2020 2023 2062 7574             # but
+000130c0: 2077 6520 7761 6e74 2074 6f20 6d6f 636b   we want to mock
+000130d0: 2074 6865 2072 656d 6f74 6520 6461 7461   the remote data
+000130e0: 2068 6572 653a 0a20 2020 2020 2020 2020   here:.         
+000130f0: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
+00013100: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00013110: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00013120: 2020 2020 2320 7072 6574 656e 6420 666f      # pretend fo
+00013130: 7220 6120 6d6f 6d65 6e74 2077 6527 7265  r a moment we're
+00013140: 206e 6f74 2069 6e20 6120 686f 6f6b 2063   not in a hook c
+00013150: 6f6e 7465 7874 2c0a 2020 2020 2020 2020  ontext,.        
+00013160: 2020 2020 2020 2020 2320 736f 2074 6865          # so the
+00013170: 2068 6172 6e65 7373 2077 696c 6c20 6c65   harness will le
+00013180: 7420 7573 3a0a 2020 2020 2020 2020 2020  t us:.          
+00013190: 2020 2020 2020 7072 696e 7428 6576 656e        print(even
+000131a0: 742e 7265 6c61 7469 6f6e 2e61 7070 290a  t.relation.app).
+000131b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131c0: 6576 656e 742e 7265 6c61 7469 6f6e 2e64  event.relation.d
+000131d0: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+000131e0: 6d2e 6170 705d 5b27 666f 6f27 5d20 3d20  m.app]['foo'] = 
+000131f0: 2762 6172 270a 0a20 2020 2020 2020 2068  'bar'..        h
+00013200: 6172 6e65 7373 2e63 6861 726d 2e5f 6a6f  arness.charm._jo
+00013210: 696e 5f64 6220 3d20 6d6f 636b 5f6a 6f69  in_db = mock_joi
+00013220: 6e5f 6462 0a20 2020 2020 2020 2072 656c  n_db.        rel
+00013230: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+00013240: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+00013250: 2027 7265 6d6f 7465 2729 0a20 2020 2020   'remote').     
+00013260: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+00013270: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00013280: 5f69 642c 2027 7265 6d6f 7465 2f30 2729  _id, 'remote/0')
+00013290: 0a20 2020 2020 2020 2072 656c 203d 2068  .        rel = h
+000132a0: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
+000132b0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+000132c0: 2764 6227 2c20 7265 6c5f 6964 290a 2020  'db', rel_id).  
+000132d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000132e0: 7445 7175 616c 287b 2766 6f6f 273a 2027  tEqual({'foo': '
+000132f0: 6261 7227 7d2c 0a20 2020 2020 2020 2020  bar'},.         
+00013300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013310: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+00013320: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00013330: 2c20 2774 6573 742d 6368 6172 6d27 2929  , 'test-charm'))
+00013340: 0a0a 2020 2020 2020 2020 2320 6e6f 7720  ..        # now 
+00013350: 7765 2772 6520 6f75 7473 6964 6520 6f66  we're outside of
+00013360: 2074 6865 2068 6f6f 6b20 636f 6e74 6578   the hook contex
+00013370: 743a 0a20 2020 2020 2020 2061 7373 6572  t:.        asser
+00013380: 7420 6e6f 7420 6861 726e 6573 732e 5f62  t not harness._b
+00013390: 6163 6b65 6e64 2e5f 686f 6f6b 5f69 735f  ackend._hook_is_
+000133a0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+000133b0: 6173 7365 7274 2072 656c 2e64 6174 615b  assert rel.data[
+000133c0: 6861 726e 6573 732e 6368 6172 6d2e 6170  harness.charm.ap
+000133d0: 705d 5b27 666f 6f27 5d20 3d3d 2027 6261  p]['foo'] == 'ba
+000133e0: 7227 0a0a 2020 2020 6465 6620 7465 7374  r'..    def test
+000133f0: 5f72 656c 6174 696f 6e5f 7365 745f 6465  _relation_set_de
+00013400: 6c65 7465 7328 7365 6c66 293a 0a20 2020  letes(self):.   
+00013410: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00013420: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00013430: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+00013440: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+00013450: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+00013460: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
+00013470: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00013480: 2020 2020 2020 2020 2020 2020 2020 6462                db
+00013490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000134a0: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
+000134b0: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
+000134c0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+000134d0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+000134e0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+000134f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00013500: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+00013510: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
+00013520: 6465 7228 4661 6c73 6529 0a20 2020 2020  der(False).     
+00013530: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
+00013540: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00013550: 2827 6462 272c 2027 706f 7374 6772 6573  ('db', 'postgres
+00013560: 716c 2729 0a20 2020 2020 2020 2068 6172  ql').        har
+00013570: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00013580: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00013590: 2c20 2774 6573 742d 6368 6172 6d2f 3027  , 'test-charm/0'
+000135a0: 2c20 7b27 666f 6f27 3a20 2762 6172 277d  , {'foo': 'bar'}
+000135b0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+000135c0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+000135d0: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+000135e0: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+000135f0: 2020 2020 7265 6c20 3d20 6861 726e 6573      rel = harnes
+00013600: 732e 6368 6172 6d2e 6d6f 6465 6c2e 6765  s.charm.model.ge
+00013610: 745f 7265 6c61 7469 6f6e 2827 6462 272c  t_relation('db',
+00013620: 2072 656c 5f69 6429 0a20 2020 2020 2020   rel_id).       
+00013630: 2064 656c 2072 656c 2e64 6174 615b 6861   del rel.data[ha
+00013640: 726e 6573 732e 6368 6172 6d2e 6d6f 6465  rness.charm.mode
+00013650: 6c2e 756e 6974 5d5b 2766 6f6f 275d 0a20  l.unit]['foo']. 
+00013660: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00013670: 7274 4571 7561 6c28 7b7d 2c20 6861 726e  rtEqual({}, harn
+00013680: 6573 732e 6765 745f 7265 6c61 7469 6f6e  ess.get_relation
+00013690: 5f64 6174 6128 7265 6c5f 6964 2c20 2774  _data(rel_id, 't
+000136a0: 6573 742d 6368 6172 6d2f 3027 2929 0a0a  est-charm/0'))..
+000136b0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+000136c0: 6174 696f 6e5f 7365 745f 6e6f 6e73 7472  ation_set_nonstr
+000136d0: 696e 6728 7365 6c66 293a 0a20 2020 2020  ing(self):.     
+000136e0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+000136f0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+00013700: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+00013710: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+00013720: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00013730: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+00013740: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+00013750: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00013760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013770: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00013780: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00013790: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+000137a0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+000137b0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+000137c0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+000137d0: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+000137e0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+000137f0: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
+00013800: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
+00013810: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+00013820: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00013830: 2729 0a20 2020 2020 2020 2066 6f72 2069  ').        for i
+00013840: 6e76 616c 6964 5f76 616c 7565 2069 6e20  nvalid_value in 
+00013850: 2831 2c20 312e 322c 207b 7d2c 205b 5d2c  (1, 1.2, {}, [],
+00013860: 2073 6574 2829 2c20 5472 7565 2c20 6f62   set(), True, ob
+00013870: 6a65 6374 2829 2c20 7479 7065 293a 0a20  ject(), type):. 
+00013880: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00013890: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000138a0: 7328 6f70 732e 5265 6c61 7469 6f6e 4461  s(ops.RelationDa
+000138b0: 7461 4572 726f 7229 3a0a 2020 2020 2020  taError):.      
+000138c0: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+000138d0: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+000138e0: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+000138f0: 7465 7374 2d63 6861 726d 2f30 272c 0a20  test-charm/0',. 
+00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013920: 2020 2020 2020 2020 2020 2020 7b27 666f              {'fo
+00013930: 6f27 3a20 696e 7661 6c69 645f 7661 6c75  o': invalid_valu
+00013940: 657d 290a 0a20 2020 2064 6566 2074 6573  e})..    def tes
+00013950: 745f 7365 745f 776f 726b 6c6f 6164 5f76  t_set_workload_v
+00013960: 6572 7369 6f6e 2873 656c 6629 3a0a 2020  ersion(self):.  
+00013970: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+00013980: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00013990: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+000139a0: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+000139b0: 2020 2020 2020 2020 6e61 6d65 3a20 6170          name: ap
+000139c0: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
+000139d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000139e0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+000139f0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00013a00: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+00013a10: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+00013a20: 2e61 7373 6572 7449 734e 6f6e 6528 6861  .assertIsNone(ha
+00013a30: 726e 6573 732e 6765 745f 776f 726b 6c6f  rness.get_worklo
+00013a40: 6164 5f76 6572 7369 6f6e 2829 290a 2020  ad_version()).  
+00013a50: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+00013a60: 6172 6d2e 6d6f 6465 6c2e 756e 6974 2e73  arm.model.unit.s
+00013a70: 6574 5f77 6f72 6b6c 6f61 645f 7665 7273  et_workload_vers
+00013a80: 696f 6e28 2731 2e32 2e33 2729 0a20 2020  ion('1.2.3').   
+00013a90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013aa0: 4571 7561 6c28 6861 726e 6573 732e 6765  Equal(harness.ge
+00013ab0: 745f 776f 726b 6c6f 6164 5f76 6572 7369  t_workload_versi
+00013ac0: 6f6e 2829 2c20 2731 2e32 2e33 2729 0a0a  on(), '1.2.3')..
+00013ad0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+00013ae0: 5f62 6163 6b65 6e64 5f63 616c 6c73 2873  _backend_calls(s
+00013af0: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00013b00: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00013b10: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+00013b20: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+00013b30: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00013b40: 6e61 6d65 3a20 7465 7374 2d63 6861 726d  name: test-charm
+00013b50: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00013b60: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00013b70: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00013b80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00013b90: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00013ba0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00013bb0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00013bc0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00013bd0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00013be0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+00013bf0: 290a 2020 2020 2020 2020 2320 4e6f 2063  ).        # No c
+00013c00: 616c 6c73 2074 6f20 7468 6520 6261 636b  alls to the back
+00013c10: 656e 6420 7965 740a 2020 2020 2020 2020  end yet.        
+00013c20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013c30: 2868 6172 6e65 7373 2e5f 6765 745f 6261  (harness._get_ba
+00013c40: 636b 656e 645f 6361 6c6c 7328 292c 205b  ckend_calls(), [
+00013c50: 5d29 0a20 2020 2020 2020 2072 656c 5f69  ]).        rel_i
+00013c60: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+00013c70: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+00013c80: 706f 7374 6772 6573 716c 2729 0a0a 2020  postgresql')..  
+00013c90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013ca0: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00013cb0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00013cc0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+00013cd0: 5f69 6473 272c 2027 6462 2729 2c0a 2020  _ids', 'db'),.  
+00013ce0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+00013cf0: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
+00013d00: 7265 6c5f 6964 292c 0a20 2020 2020 2020  rel_id),.       
+00013d10: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+00013d20: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
+00013d30: 616d 6527 2c20 3029 2c0a 2020 2020 2020  ame', 0),.      
+00013d40: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00013d50: 2020 2020 2068 6172 6e65 7373 2e5f 6765       harness._ge
+00013d60: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
+00013d70: 2929 0a0a 2020 2020 2020 2020 2320 7570  ))..        # up
+00013d80: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00013d90: 7461 2065 6e73 7572 6573 2074 6865 2063  ta ensures the c
+00013da0: 6163 6865 6420 6461 7461 2066 6f72 2074  ached data for t
+00013db0: 6865 2072 656c 6174 696f 6e20 6973 2077  he relation is w
+00013dc0: 6970 6564 0a20 2020 2020 2020 2068 6172  iped.        har
+00013dd0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00013de0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00013df0: 2c20 2774 6573 742d 6368 6172 6d2f 3027  , 'test-charm/0'
+00013e00: 2c20 7b27 666f 6f27 3a20 2762 6172 277d  , {'foo': 'bar'}
+00013e10: 290a 2020 2020 2020 2020 7465 7374 5f63  ).        test_c
+00013e20: 6861 726d 5f75 6e69 7420 3d20 6861 726e  harm_unit = harn
+00013e30: 6573 732e 6d6f 6465 6c2e 6765 745f 756e  ess.model.get_un
+00013e40: 6974 2827 7465 7374 2d63 6861 726d 2f30  it('test-charm/0
+00013e50: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00013e60: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00013e70: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00013e80: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+00013e90: 6174 696f 6e5f 6765 7427 2c20 302c 2027  ation_get', 0, '
+00013ea0: 7465 7374 2d63 6861 726d 2f30 272c 2046  test-charm/0', F
+00013eb0: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+00013ec0: 2020 2020 2020 2028 2775 7064 6174 655f         ('update_
+00013ed0: 7265 6c61 7469 6f6e 5f64 6174 6127 2c20  relation_data', 
+00013ee0: 302c 2074 6573 745f 6368 6172 6d5f 756e  0, test_charm_un
+00013ef0: 6974 2c20 2766 6f6f 272c 2027 6261 7227  it, 'foo', 'bar'
+00013f00: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
+00013f10: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+00013f20: 6e65 7373 2e5f 6765 745f 6261 636b 656e  ness._get_backen
+00013f30: 645f 6361 6c6c 7328 7265 7365 743d 5472  d_calls(reset=Tr
+00013f40: 7565 2929 0a20 2020 2020 2020 2023 2061  ue)).        # a
+00013f50: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+00013f60: 2072 6573 6574 7320 7468 6520 7265 6c61   resets the rela
+00013f70: 7469 6f6e 5f6c 6973 742c 2062 7574 2064  tion_list, but d
+00013f80: 6f65 736e 2774 2074 7269 6767 6572 2062  oesn't trigger b
+00013f90: 6163 6b65 6e64 2063 616c 6c73 0a20 2020  ackend calls.   
+00013fa0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
+00013fb0: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00013fc0: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00013fd0: 716c 2f30 2729 0a20 2020 2020 2020 2073  ql/0').        s
+00013fe0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00013ff0: 5b5d 2c20 6861 726e 6573 732e 5f67 6574  [], harness._get
+00014000: 5f62 6163 6b65 6e64 5f63 616c 6c73 2872  _backend_calls(r
+00014010: 6573 6574 3d46 616c 7365 2929 0a20 2020  eset=False)).   
+00014020: 2020 2020 2023 2068 6f77 6576 6572 2c20       # however, 
+00014030: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+00014040: 6461 7461 2064 6f65 732c 2062 6563 6175  data does, becau
+00014050: 7365 2077 6520 6172 6520 7072 6570 6172  se we are prepar
+00014060: 696e 6720 7265 6c61 7469 6f6e 2d63 6861  ing relation-cha
+00014070: 6e67 6564 0a20 2020 2020 2020 2068 6172  nged.        har
+00014080: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00014090: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+000140a0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+000140b0: 2c20 7b27 666f 6f27 3a20 2762 6172 277d  , {'foo': 'bar'}
+000140c0: 290a 2020 2020 2020 2020 7067 716c 5f75  ).        pgql_u
+000140d0: 6e69 7420 3d20 6861 726e 6573 732e 6d6f  nit = harness.mo
+000140e0: 6465 6c2e 6765 745f 756e 6974 2827 706f  del.get_unit('po
+000140f0: 7374 6772 6573 716c 2f30 2729 0a0a 2020  stgresql/0')..  
+00014100: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014110: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00014120: 2020 2020 6861 726e 6573 732e 5f67 6574      harness._get
+00014130: 5f62 6163 6b65 6e64 5f63 616c 6c73 2872  _backend_calls(r
+00014140: 6573 6574 3d46 616c 7365 292c 205b 0a20  eset=False), [. 
+00014150: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00014160: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
+00014170: 2764 6227 292c 0a20 2020 2020 2020 2020  'db'),.         
+00014180: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00014190: 6e5f 6c69 7374 272c 2072 656c 5f69 6429  n_list', rel_id)
+000141a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000141b0: 2020 2827 7265 6c61 7469 6f6e 5f67 6574    ('relation_get
+000141c0: 272c 2030 2c20 2770 6f73 7467 7265 7371  ', 0, 'postgresq
+000141d0: 6c2f 3027 2c20 4661 6c73 6529 2c0a 2020  l/0', False),.  
+000141e0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000141f0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+00014200: 6461 7461 272c 2030 2c20 7067 716c 5f75  data', 0, pgql_u
+00014210: 6e69 742c 2027 666f 6f27 2c20 2762 6172  nit, 'foo', 'bar
+00014220: 2729 0a20 2020 2020 2020 2020 2020 205d  ').            ]
+00014230: 290a 2020 2020 2020 2020 2320 4966 2077  ).        # If w
+00014240: 6520 6368 6563 6b20 6167 6169 6e2c 2074  e check again, t
+00014250: 6865 7920 6172 6520 7374 696c 6c20 7468  hey are still th
+00014260: 6572 652c 2062 7574 206e 6f77 2077 6520  ere, but now we 
+00014270: 7265 7365 7420 6974 0a20 2020 2020 2020  reset it.       
+00014280: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00014290: 6c28 0a20 2020 2020 2020 2020 2020 2068  l(.            h
+000142a0: 6172 6e65 7373 2e5f 6765 745f 6261 636b  arness._get_back
+000142b0: 656e 645f 6361 6c6c 7328 7265 7365 743d  end_calls(reset=
+000142c0: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
+000142d0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+000142e0: 696f 6e5f 6964 7327 2c20 2764 6227 292c  ion_ids', 'db'),
+000142f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014300: 2028 2772 656c 6174 696f 6e5f 6c69 7374   ('relation_list
+00014310: 272c 2072 656c 5f69 6429 2c0a 2020 2020  ', rel_id),.    
+00014320: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
+00014330: 6c61 7469 6f6e 5f67 6574 272c 2030 2c20  lation_get', 0, 
+00014340: 2770 6f73 7467 7265 7371 6c2f 3027 2c20  'postgresql/0', 
+00014350: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+00014360: 2020 2020 2020 2020 2827 7570 6461 7465          ('update
+00014370: 5f72 656c 6174 696f 6e5f 6461 7461 272c  _relation_data',
+00014380: 2030 2c20 7067 716c 5f75 6e69 742c 2027   0, pgql_unit, '
+00014390: 666f 6f27 2c20 2762 6172 2729 0a20 2020  foo', 'bar').   
+000143a0: 2020 2020 2020 2020 205d 290a 2020 2020           ]).    
+000143b0: 2020 2020 2320 416e 6420 7468 6520 6361      # And the ca
+000143c0: 6c6c 7320 6172 6520 676f 6e65 0a20 2020  lls are gone.   
+000143d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000143e0: 4571 7561 6c28 6861 726e 6573 732e 5f67  Equal(harness._g
+000143f0: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
+00014400: 2829 2c20 5b5d 290a 0a20 2020 2064 6566  (), [])..    def
+00014410: 2074 6573 745f 6765 745f 6261 636b 656e   test_get_backen
+00014420: 645f 6361 6c6c 735f 7769 7468 5f6b 7761  d_calls_with_kwa
+00014430: 7267 7328 7365 6c66 293a 0a20 2020 2020  rgs(self):.     
+00014440: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+00014450: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+00014460: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+00014470: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+00014480: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00014490: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+000144a0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+000144b0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+000144c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144d0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+000144e0: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+000144f0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00014500: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00014510: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00014520: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00014530: 6567 696e 2829 0a20 2020 2020 2020 2075  egin().        u
+00014540: 6e69 7420 3d20 6861 726e 6573 732e 6368  nit = harness.ch
+00014550: 6172 6d2e 6d6f 6465 6c2e 756e 6974 0a20  arm.model.unit. 
+00014560: 2020 2020 2020 2023 2052 6573 6574 2074         # Reset t
+00014570: 6865 206c 6973 742c 2062 6563 6175 7365  he list, because
+00014580: 2077 6520 646f 6e27 7420 6361 7265 2077   we don't care w
+00014590: 6861 7420 6974 2074 6f6f 6b20 746f 2067  hat it took to g
+000145a0: 6574 2068 6572 650a 2020 2020 2020 2020  et here.        
+000145b0: 6861 726e 6573 732e 5f67 6574 5f62 6163  harness._get_bac
+000145c0: 6b65 6e64 5f63 616c 6c73 2872 6573 6574  kend_calls(reset
+000145d0: 3d54 7275 6529 0a20 2020 2020 2020 2075  =True).        u
+000145e0: 6e69 742e 7374 6174 7573 203d 206f 7073  nit.status = ops
+000145f0: 2e41 6374 6976 6553 7461 7475 7328 290a  .ActiveStatus().
+00014600: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014610: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00014620: 2020 2020 2020 5b28 2773 7461 7475 735f        [('status_
+00014630: 7365 7427 2c20 2761 6374 6976 6527 2c20  set', 'active', 
+00014640: 2727 2c20 7b27 6973 5f61 7070 273a 2046  '', {'is_app': F
+00014650: 616c 7365 7d29 5d2c 2068 6172 6e65 7373  alse})], harness
+00014660: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
+00014670: 6c6c 7328 2929 0a20 2020 2020 2020 2068  lls()).        h
+00014680: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+00014690: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
+000146a0: 6170 7020 3d20 6861 726e 6573 732e 6368  app = harness.ch
+000146b0: 6172 6d2e 6d6f 6465 6c2e 6170 700a 2020  arm.model.app.  
+000146c0: 2020 2020 2020 6861 726e 6573 732e 5f67        harness._g
+000146d0: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
+000146e0: 2872 6573 6574 3d54 7275 6529 0a20 2020  (reset=True).   
+000146f0: 2020 2020 2061 7070 2e73 7461 7475 7320       app.status 
+00014700: 3d20 6f70 732e 4163 7469 7665 5374 6174  = ops.ActiveStat
+00014710: 7573 2827 6d65 7373 6167 6527 290a 2020  us('message').  
+00014720: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014730: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00014740: 2020 2020 5b28 2769 735f 6c65 6164 6572      [('is_leader
+00014750: 272c 292c 0a20 2020 2020 2020 2020 2020  ',),.           
+00014760: 2020 2827 7374 6174 7573 5f73 6574 272c    ('status_set',
+00014770: 2027 6163 7469 7665 272c 2027 6d65 7373   'active', 'mess
+00014780: 6167 6527 2c20 7b27 6973 5f61 7070 273a  age', {'is_app':
+00014790: 2054 7275 657d 295d 2c0a 2020 2020 2020   True})],.      
+000147a0: 2020 2020 2020 6861 726e 6573 732e 5f67        harness._g
+000147b0: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
+000147c0: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
+000147d0: 745f 756e 6974 5f73 7461 7475 7328 7365  t_unit_status(se
+000147e0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+000147f0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00014800: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+00014810: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+00014820: 6e61 6d65 3a20 7465 7374 2d61 7070 2729  name: test-app')
+00014830: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00014840: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00014850: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00014860: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+00014870: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
+00014880: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00014890: 2829 0a20 2020 2020 2020 2023 2064 6566  ().        # def
+000148a0: 6175 6c74 2073 7461 7475 730a 2020 2020  ault status.    
+000148b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000148c0: 7175 616c 2868 6172 6e65 7373 2e6d 6f64  qual(harness.mod
+000148d0: 656c 2e75 6e69 742e 7374 6174 7573 2c20  el.unit.status, 
+000148e0: 6f70 732e 4d61 696e 7465 6e61 6e63 6553  ops.MaintenanceS
+000148f0: 7461 7475 7328 2727 2929 0a20 2020 2020  tatus('')).     
+00014900: 2020 2073 7461 7475 7320 3d20 6f70 732e     status = ops.
+00014910: 4163 7469 7665 5374 6174 7573 2827 6d65  ActiveStatus('me
+00014920: 7373 6167 6527 290a 2020 2020 2020 2020  ssage').        
+00014930: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
+00014940: 6974 2e73 7461 7475 7320 3d20 7374 6174  it.status = stat
+00014950: 7573 0a20 2020 2020 2020 2073 656c 662e  us.        self.
+00014960: 6173 7365 7274 4571 7561 6c28 6861 726e  assertEqual(harn
+00014970: 6573 732e 6d6f 6465 6c2e 756e 6974 2e73  ess.model.unit.s
+00014980: 7461 7475 732c 2073 7461 7475 7329 0a0a  tatus, status)..
+00014990: 2020 2020 6465 6620 7465 7374 5f61 7070      def test_app
+000149a0: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
+000149b0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+000149c0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+000149d0: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+000149e0: 7365 2c20 6d65 7461 3d27 6e61 6d65 3a20  se, meta='name: 
+000149f0: 7465 7374 2d61 7070 2729 0a20 2020 2020  test-app').     
+00014a00: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00014a10: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00014a20: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+00014a30: 6573 732e 7365 745f 6c65 6164 6572 2854  ess.set_leader(T
+00014a40: 7275 6529 0a20 2020 2020 2020 2068 6172  rue).        har
+00014a50: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+00014a60: 2020 2020 2023 2064 6566 6175 6c74 2073       # default s
+00014a70: 7461 7475 730a 2020 2020 2020 2020 7365  tatus.        se
+00014a80: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+00014a90: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
+00014aa0: 2e73 7461 7475 732c 206f 7073 2e55 6e6b  .status, ops.Unk
+00014ab0: 6e6f 776e 5374 6174 7573 2829 290a 2020  nownStatus()).  
+00014ac0: 2020 2020 2020 7374 6174 7573 203d 206f        status = o
+00014ad0: 7073 2e41 6374 6976 6553 7461 7475 7328  ps.ActiveStatus(
+00014ae0: 276d 6573 7361 6765 2729 0a20 2020 2020  'message').     
+00014af0: 2020 2068 6172 6e65 7373 2e6d 6f64 656c     harness.model
+00014b00: 2e61 7070 2e73 7461 7475 7320 3d20 7374  .app.status = st
+00014b10: 6174 7573 0a20 2020 2020 2020 2073 656c  atus.        sel
+00014b20: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
+00014b30: 726e 6573 732e 6d6f 6465 6c2e 6170 702e  rness.model.app.
+00014b40: 7374 6174 7573 2c20 7374 6174 7573 290a  status, status).
+00014b50: 0a20 2020 2064 6566 2074 6573 745f 706f  .    def test_po
+00014b60: 7075 6c61 7465 5f6f 6369 5f72 6573 6f75  pulate_oci_resou
+00014b70: 7263 6573 2873 656c 6629 3a0a 2020 2020  rces(self):.    
+00014b80: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+00014b90: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+00014ba0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+00014bb0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00014bc0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00014bd0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00014be0: 2072 6573 6f75 7263 6573 3a0a 2020 2020   resources:.    
+00014bf0: 2020 2020 2020 2020 2020 696d 6167 653a            image:
+00014c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014c10: 2074 7970 653a 206f 6369 2d69 6d61 6765   type: oci-image
+00014c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014c30: 2064 6573 6372 6970 7469 6f6e 3a20 2249   description: "I
+00014c40: 6d61 6765 2074 6f20 6465 706c 6f79 2e22  mage to deploy."
+00014c50: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
+00014c60: 6d61 6765 323a 0a20 2020 2020 2020 2020  mage2:.         
+00014c70: 2020 2020 2020 2074 7970 653a 206f 6369         type: oci
+00014c80: 2d69 6d61 6765 0a20 2020 2020 2020 2020  -image.         
+00014c90: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
+00014ca0: 6f6e 3a20 2241 6e6f 7468 6572 2069 6d61  on: "Another ima
+00014cb0: 6765 2e22 0a20 2020 2020 2020 2020 2020  ge.".           
+00014cc0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00014cd0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00014ce0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00014cf0: 2020 2020 2020 2068 6172 6e65 7373 2e70         harness.p
+00014d00: 6f70 756c 6174 655f 6f63 695f 7265 736f  opulate_oci_reso
+00014d10: 7572 6365 7328 290a 2020 2020 2020 2020  urces().        
+00014d20: 7061 7468 203d 2068 6172 6e65 7373 2e6d  path = harness.m
+00014d30: 6f64 656c 2e72 6573 6f75 7263 6573 2e66  odel.resources.f
+00014d40: 6574 6368 2827 696d 6167 6527 290a 2020  etch('image').  
+00014d50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014d60: 7445 7175 616c 2870 6174 682e 6e61 6d65  tEqual(path.name
+00014d70: 2c20 2763 6f6e 7465 6e74 732e 7961 6d6c  , 'contents.yaml
+00014d80: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00014d90: 6173 7365 7274 4571 7561 6c28 7061 7468  assertEqual(path
+00014da0: 2e70 6172 656e 742e 6e61 6d65 2c20 2769  .parent.name, 'i
+00014db0: 6d61 6765 2729 0a20 2020 2020 2020 2077  mage').        w
+00014dc0: 6974 6820 7061 7468 2e6f 7065 6e28 2772  ith path.open('r
+00014dd0: 2729 2061 7320 7265 736f 7572 6365 5f66  ') as resource_f
+00014de0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+00014df0: 2063 6f6e 7465 6e74 7320 3d20 7961 6d6c   contents = yaml
+00014e00: 2e73 6166 655f 6c6f 6164 2872 6573 6f75  .safe_load(resou
+00014e10: 7263 655f 6669 6c65 2e72 6561 6428 2929  rce_file.read())
+00014e20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00014e30: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
+00014e40: 7473 5b27 7265 6769 7374 7279 7061 7468  ts['registrypath
+00014e50: 275d 2c20 2772 6567 6973 7472 7970 6174  '], 'registrypat
+00014e60: 6827 290a 2020 2020 2020 2020 7365 6c66  h').        self
+00014e70: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
+00014e80: 7465 6e74 735b 2775 7365 726e 616d 6527  tents['username'
+00014e90: 5d2c 2027 7573 6572 6e61 6d65 2729 0a20  ], 'username'). 
+00014ea0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00014eb0: 7274 4571 7561 6c28 636f 6e74 656e 7473  rtEqual(contents
+00014ec0: 5b27 7061 7373 776f 7264 275d 2c20 2770  ['password'], 'p
+00014ed0: 6173 7377 6f72 6427 290a 2020 2020 2020  assword').      
+00014ee0: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
+00014ef0: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
+00014f00: 2e66 6574 6368 2827 696d 6167 6532 2729  .fetch('image2')
+00014f10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00014f20: 7365 7274 4571 7561 6c28 7061 7468 2e6e  sertEqual(path.n
+00014f30: 616d 652c 2027 636f 6e74 656e 7473 2e79  ame, 'contents.y
+00014f40: 616d 6c27 290a 2020 2020 2020 2020 7365  aml').        se
+00014f50: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00014f60: 6174 682e 7061 7265 6e74 2e6e 616d 652c  ath.parent.name,
+00014f70: 2027 696d 6167 6532 2729 0a0a 2020 2020   'image2')..    
+00014f80: 6465 6620 7465 7374 5f72 6573 6f75 7263  def test_resourc
+00014f90: 655f 666f 6c64 6572 5f63 6c65 616e 7570  e_folder_cleanup
+00014fa0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00014fb0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00014fc0: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+00014fd0: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+00014fe0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00014ff0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00015000: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00015010: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+00015020: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
+00015030: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00015040: 653a 206f 6369 2d69 6d61 6765 0a20 2020  e: oci-image.   
+00015050: 2020 2020 2020 2020 2020 2020 2064 6573               des
+00015060: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
+00015070: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
+00015080: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00015090: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+000150a0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+000150b0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
+000150c0: 6172 6e65 7373 2e70 6f70 756c 6174 655f  arness.populate_
+000150d0: 6f63 695f 7265 736f 7572 6365 7328 290a  oci_resources().
+000150e0: 2020 2020 2020 2020 7061 7468 203d 2068          path = h
+000150f0: 6172 6e65 7373 2e6d 6f64 656c 2e72 6573  arness.model.res
+00015100: 6f75 7263 6573 2e66 6574 6368 2827 696d  ources.fetch('im
+00015110: 6167 6527 290a 2020 2020 2020 2020 7365  age').        se
+00015120: 6c66 2e61 7373 6572 7454 7275 6528 7061  lf.assertTrue(pa
+00015130: 7468 2e65 7869 7374 7328 2929 0a20 2020  th.exists()).   
+00015140: 2020 2020 2068 6172 6e65 7373 2e63 6c65       harness.cle
+00015150: 616e 7570 2829 0a20 2020 2020 2020 2073  anup().        s
+00015160: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+00015170: 7061 7468 2e65 7869 7374 7328 2929 0a20  path.exists()). 
+00015180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015190: 7274 4661 6c73 6528 7061 7468 2e70 6172  rtFalse(path.par
+000151a0: 656e 742e 6578 6973 7473 2829 290a 2020  ent.exists()).  
+000151b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000151c0: 7446 616c 7365 2870 6174 682e 7061 7265  tFalse(path.pare
+000151d0: 6e74 2e70 6172 656e 742e 6578 6973 7473  nt.parent.exists
+000151e0: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
+000151f0: 745f 636f 6e74 6169 6e65 725f 6973 6469  t_container_isdi
+00015200: 725f 616e 645f 6578 6973 7473 2873 656c  r_and_exists(sel
+00015210: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00015220: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00015230: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00015240: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00015250: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00015260: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00015270: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
+00015280: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00015290: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+000152a0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+000152b0: 3a20 666f 6f2d 696d 6167 650a 2020 2020  : foo-image.    
+000152c0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+000152d0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+000152e0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+000152f0: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
+00015300: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+00015310: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
+00015320: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
+00015330: 6f6f 272c 2054 7275 6529 0a20 2020 2020  oo', True).     
+00015340: 2020 2063 203d 2068 6172 6e65 7373 2e6d     c = harness.m
+00015350: 6f64 656c 2e75 6e69 742e 636f 6e74 6169  odel.unit.contai
+00015360: 6e65 7273 5b27 666f 6f27 5d0a 0a20 2020  ners['foo']..   
+00015370: 2020 2020 2064 6972 5f70 6174 6820 3d20       dir_path = 
+00015380: 272f 746d 702f 666f 6f2f 6469 7227 0a20  '/tmp/foo/dir'. 
+00015390: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+000153a0: 203d 2027 2f74 6d70 2f66 6f6f 2f66 696c   = '/tmp/foo/fil
+000153b0: 6527 0a0a 2020 2020 2020 2020 7365 6c66  e'..        self
+000153c0: 2e61 7373 6572 7446 616c 7365 2863 2e69  .assertFalse(c.i
+000153d0: 7364 6972 2864 6972 5f70 6174 6829 290a  sdir(dir_path)).
+000153e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000153f0: 6572 7446 616c 7365 2863 2e65 7869 7374  ertFalse(c.exist
+00015400: 7328 6469 725f 7061 7468 2929 0a20 2020  s(dir_path)).   
+00015410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00015420: 4661 6c73 6528 632e 6973 6469 7228 6669  False(c.isdir(fi
+00015430: 6c65 5f70 6174 6829 290a 2020 2020 2020  le_path)).      
+00015440: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00015450: 7365 2863 2e65 7869 7374 7328 6669 6c65  se(c.exists(file
+00015460: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
+00015470: 2063 2e6d 616b 655f 6469 7228 6469 725f   c.make_dir(dir_
+00015480: 7061 7468 2c20 6d61 6b65 5f70 6172 656e  path, make_paren
+00015490: 7473 3d54 7275 6529 0a20 2020 2020 2020  ts=True).       
+000154a0: 2063 2e70 7573 6828 6669 6c65 5f70 6174   c.push(file_pat
+000154b0: 682c 2027 6461 7461 2729 0a0a 2020 2020  h, 'data')..    
+000154c0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+000154d0: 7275 6528 632e 6973 6469 7228 6469 725f  rue(c.isdir(dir_
+000154e0: 7061 7468 2929 0a20 2020 2020 2020 2073  path)).        s
+000154f0: 656c 662e 6173 7365 7274 5472 7565 2863  elf.assertTrue(c
+00015500: 2e65 7869 7374 7328 6469 725f 7061 7468  .exists(dir_path
+00015510: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00015520: 6173 7365 7274 4661 6c73 6528 632e 6973  assertFalse(c.is
+00015530: 6469 7228 6669 6c65 5f70 6174 6829 290a  dir(file_path)).
+00015540: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015550: 6572 7454 7275 6528 632e 6578 6973 7473  ertTrue(c.exists
+00015560: 2866 696c 655f 7061 7468 2929 0a0a 2020  (file_path))..  
+00015570: 2020 6465 6620 7465 7374 5f61 6464 5f6f    def test_add_o
+00015580: 6369 5f72 6573 6f75 7263 655f 6375 7374  ci_resource_cust
+00015590: 6f6d 2873 656c 6629 3a0a 2020 2020 2020  om(self):.      
+000155a0: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+000155b0: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+000155c0: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
+000155d0: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+000155e0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+000155f0: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
+00015600: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
+00015610: 2020 2020 2020 2020 696d 6167 653a 0a20          image:. 
+00015620: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00015630: 7970 653a 206f 6369 2d69 6d61 6765 0a20  ype: oci-image. 
+00015640: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015650: 6573 6372 6970 7469 6f6e 3a20 2249 6d61  escription: "Ima
+00015660: 6765 2074 6f20 6465 706c 6f79 2e22 0a20  ge to deploy.". 
+00015670: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00015680: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00015690: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+000156a0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+000156b0: 2063 7573 746f 6d20 3d20 7b0a 2020 2020   custom = {.    
+000156c0: 2020 2020 2020 2020 2272 6567 6973 7472          "registr
+000156d0: 7970 6174 6822 3a20 2263 7573 746f 6d70  ypath": "customp
+000156e0: 6174 6822 2c0a 2020 2020 2020 2020 2020  ath",.          
+000156f0: 2020 2275 7365 726e 616d 6522 3a20 2263    "username": "c
+00015700: 7573 746f 6d5f 7573 6572 6e61 6d65 222c  ustom_username",
+00015710: 0a20 2020 2020 2020 2020 2020 2022 7061  .            "pa
+00015720: 7373 776f 7264 223a 2022 6375 7374 6f6d  ssword": "custom
+00015730: 5f70 6173 7377 6f72 6422 2c0a 2020 2020  _password",.    
+00015740: 2020 2020 7d0a 2020 2020 2020 2020 6861      }.        ha
+00015750: 726e 6573 732e 6164 645f 6f63 695f 7265  rness.add_oci_re
+00015760: 736f 7572 6365 2827 696d 6167 6527 2c20  source('image', 
+00015770: 6375 7374 6f6d 290a 2020 2020 2020 2020  custom).        
+00015780: 7265 736f 7572 6365 203d 2068 6172 6e65  resource = harne
+00015790: 7373 2e6d 6f64 656c 2e72 6573 6f75 7263  ss.model.resourc
+000157a0: 6573 2e66 6574 6368 2827 696d 6167 6527  es.fetch('image'
+000157b0: 290a 2020 2020 2020 2020 7769 7468 2072  ).        with r
+000157c0: 6573 6f75 7263 652e 6f70 656e 2827 7227  esource.open('r'
+000157d0: 2920 6173 2072 6573 6f75 7263 655f 6669  ) as resource_fi
+000157e0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+000157f0: 636f 6e74 656e 7473 203d 2079 616d 6c2e  contents = yaml.
+00015800: 7361 6665 5f6c 6f61 6428 7265 736f 7572  safe_load(resour
+00015810: 6365 5f66 696c 652e 7265 6164 2829 290a  ce_file.read()).
+00015820: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015830: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
+00015840: 735b 2772 6567 6973 7472 7970 6174 6827  s['registrypath'
+00015850: 5d2c 2027 6375 7374 6f6d 7061 7468 2729  ], 'custompath')
+00015860: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00015870: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
+00015880: 7473 5b27 7573 6572 6e61 6d65 275d 2c20  ts['username'], 
+00015890: 2763 7573 746f 6d5f 7573 6572 6e61 6d65  'custom_username
+000158a0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000158b0: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
+000158c0: 656e 7473 5b27 7061 7373 776f 7264 275d  ents['password']
+000158d0: 2c20 2763 7573 746f 6d5f 7061 7373 776f  , 'custom_passwo
+000158e0: 7264 2729 0a0a 2020 2020 6465 6620 7465  rd')..    def te
+000158f0: 7374 5f61 6464 5f6f 6369 5f72 6573 6f75  st_add_oci_resou
+00015900: 7263 655f 6e6f 5f69 6d61 6765 2873 656c  rce_no_image(sel
+00015910: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00015920: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00015930: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00015940: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00015950: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00015960: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00015970: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00015980: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00015990: 2020 696d 6167 653a 0a20 2020 2020 2020    image:.       
+000159a0: 2020 2020 2020 2020 2074 7970 653a 2066           type: f
+000159b0: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
+000159c0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+000159d0: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
+000159e0: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
+000159f0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00015a00: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00015a10: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00015a20: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00015a30: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+00015a40: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+00015a50: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00015a60: 6164 645f 6f63 695f 7265 736f 7572 6365  add_oci_resource
+00015a70: 2822 696d 6167 6522 290a 2020 2020 2020  ("image").      
+00015a80: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00015a90: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
+00015aa0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00015ab0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+00015ac0: 6f63 695f 7265 736f 7572 6365 2822 6d69  oci_resource("mi
+00015ad0: 7373 696e 672d 7265 736f 7572 6365 2229  ssing-resource")
+00015ae0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00015af0: 7365 7274 4571 7561 6c28 6c65 6e28 6861  sertEqual(len(ha
+00015b00: 726e 6573 732e 5f62 6163 6b65 6e64 2e5f  rness._backend._
+00015b10: 7265 736f 7572 6365 735f 6d61 7029 2c20  resources_map), 
+00015b20: 3029 0a0a 2020 2020 6465 6620 7465 7374  0)..    def test
+00015b30: 5f61 6464 5f72 6573 6f75 7263 655f 756e  _add_resource_un
+00015b40: 6b6e 6f77 6e28 7365 6c66 293a 0a20 2020  known(self):.   
+00015b50: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00015b60: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00015b70: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+00015b80: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+00015b90: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+00015ba0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+00015bb0: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
+00015bc0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00015bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015be0: 2020 7479 7065 3a20 6669 6c65 0a20 2020    type: file.   
+00015bf0: 2020 2020 2020 2020 2020 2020 2064 6573               des
+00015c00: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
+00015c10: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
+00015c20: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00015c30: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00015c40: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+00015c50: 6561 6e75 7029 0a20 2020 2020 2020 2077  eanup).        w
+00015c60: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00015c70: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+00015c80: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00015c90: 2068 6172 6e65 7373 2e61 6464 5f72 6573   harness.add_res
+00015ca0: 6f75 7263 6528 2775 6e6b 6e6f 776e 272c  ource('unknown',
+00015cb0: 2027 636f 6e74 656e 7427 290a 0a20 2020   'content')..   
+00015cc0: 2064 6566 2074 6573 745f 6164 645f 7265   def test_add_re
+00015cd0: 736f 7572 6365 5f62 7574 5f6f 6369 2873  source_but_oci(s
+00015ce0: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00015cf0: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00015d00: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+00015d10: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+00015d20: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00015d30: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+00015d40: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+00015d50: 7263 6573 3a0a 2020 2020 2020 2020 2020  rces:.          
+00015d60: 2020 2020 696d 6167 653a 0a20 2020 2020      image:.     
+00015d70: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+00015d80: 206f 6369 2d69 6d61 6765 0a20 2020 2020   oci-image.     
+00015d90: 2020 2020 2020 2020 2020 2064 6573 6372             descr
+00015da0: 6970 7469 6f6e 3a20 2249 6d61 6765 2074  iption: "Image t
+00015db0: 6f20 6465 706c 6f79 2e22 0a20 2020 2020  o deploy.".     
+00015dc0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00015dd0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00015de0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+00015df0: 6e75 7029 0a20 2020 2020 2020 2077 6974  nup).        wit
+00015e00: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00015e10: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
+00015e20: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
+00015e30: 6172 6e65 7373 2e61 6464 5f72 6573 6f75  arness.add_resou
+00015e40: 7263 6528 2769 6d61 6765 272c 2027 636f  rce('image', 'co
+00015e50: 6e74 656e 7427 290a 0a20 2020 2064 6566  ntent')..    def
+00015e60: 2074 6573 745f 6164 645f 7265 736f 7572   test_add_resour
+00015e70: 6365 5f73 7472 696e 6728 7365 6c66 293a  ce_string(self):
+00015e80: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00015e90: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00015ea0: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+00015eb0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+00015ec0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00015ed0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00015ee0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
+00015ef0: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
+00015f00: 6d61 6765 3a0a 2020 2020 2020 2020 2020  mage:.          
+00015f10: 2020 2020 2020 7479 7065 3a20 6669 6c65        type: file
+00015f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015f30: 2066 696c 656e 616d 653a 2066 6f6f 2e74   filename: foo.t
+00015f40: 7874 0a20 2020 2020 2020 2020 2020 2020  xt.             
+00015f50: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
+00015f60: 2249 6d61 6765 2074 6f20 6465 706c 6f79  "Image to deploy
+00015f70: 2e22 0a20 2020 2020 2020 2020 2020 2027  .".            '
+00015f80: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+00015f90: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+00015fa0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+00015fb0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
+00015fc0: 5f72 6573 6f75 7263 6528 2769 6d61 6765  _resource('image
+00015fd0: 272c 2027 666f 6f20 636f 6e74 656e 7473  ', 'foo contents
+00015fe0: 5c6e 2729 0a20 2020 2020 2020 2070 6174  \n').        pat
+00015ff0: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
+00016000: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
+00016010: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
+00016020: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016030: 7561 6c28 7061 7468 2e6e 616d 652c 2027  ual(path.name, '
+00016040: 666f 6f2e 7478 7427 290a 2020 2020 2020  foo.txt').      
+00016050: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00016060: 616c 2870 6174 682e 7061 7265 6e74 2e6e  al(path.parent.n
+00016070: 616d 652c 2027 696d 6167 6527 290a 2020  ame, 'image').  
+00016080: 2020 2020 2020 7769 7468 2070 6174 682e        with path.
+00016090: 6f70 656e 2827 7274 2729 2061 7320 663a  open('rt') as f:
+000160a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000160b0: 662e 6173 7365 7274 4571 7561 6c28 2766  f.assertEqual('f
+000160c0: 6f6f 2063 6f6e 7465 6e74 735c 6e27 2c20  oo contents\n', 
+000160d0: 662e 7265 6164 2829 290a 0a20 2020 2064  f.read())..    d
+000160e0: 6566 2074 6573 745f 6164 645f 7265 736f  ef test_add_reso
+000160f0: 7572 6365 5f62 7974 6573 2873 656c 6629  urce_bytes(self)
+00016100: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+00016110: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00016120: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00016130: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+00016140: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00016150: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+00016160: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00016170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016180: 696d 6167 653a 0a20 2020 2020 2020 2020  image:.         
+00016190: 2020 2020 2020 2074 7970 653a 2066 696c         type: fil
+000161a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000161b0: 2020 6669 6c65 6e61 6d65 3a20 666f 6f2e    filename: foo.
+000161c0: 7a69 700a 2020 2020 2020 2020 2020 2020  zip.            
+000161d0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+000161e0: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
+000161f0: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
+00016200: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00016210: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00016220: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00016230: 2020 2020 2020 7261 775f 636f 6e74 656e        raw_conten
+00016240: 7473 203d 2062 275c 7866 665c 7866 665c  ts = b'\xff\xff\
+00016250: 7830 3062 6c61 685c 6e27 0a20 2020 2020  x00blah\n'.     
+00016260: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+00016270: 6573 6f75 7263 6528 2769 6d61 6765 272c  esource('image',
+00016280: 2072 6177 5f63 6f6e 7465 6e74 7329 0a20   raw_contents). 
+00016290: 2020 2020 2020 2070 6174 6820 3d20 6861         path = ha
+000162a0: 726e 6573 732e 6d6f 6465 6c2e 7265 736f  rness.model.reso
+000162b0: 7572 6365 732e 6665 7463 6828 2769 6d61  urces.fetch('ima
+000162c0: 6765 2729 0a20 2020 2020 2020 2073 656c  ge').        sel
+000162d0: 662e 6173 7365 7274 4571 7561 6c28 7061  f.assertEqual(pa
+000162e0: 7468 2e6e 616d 652c 2027 666f 6f2e 7a69  th.name, 'foo.zi
+000162f0: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
+00016300: 2e61 7373 6572 7445 7175 616c 2870 6174  .assertEqual(pat
+00016310: 682e 7061 7265 6e74 2e6e 616d 652c 2027  h.parent.name, '
+00016320: 696d 6167 6527 290a 2020 2020 2020 2020  image').        
+00016330: 7769 7468 2070 6174 682e 6f70 656e 2827  with path.open('
+00016340: 7262 2729 2061 7320 663a 0a20 2020 2020  rb') as f:.     
+00016350: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00016360: 7274 4571 7561 6c28 7261 775f 636f 6e74  rtEqual(raw_cont
+00016370: 656e 7473 2c20 662e 7265 6164 2829 290a  ents, f.read()).
+00016380: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+00016390: 645f 7265 736f 7572 6365 5f75 6e6b 6e6f  d_resource_unkno
+000163a0: 776e 5f66 696c 656e 616d 6528 7365 6c66  wn_filename(self
+000163b0: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+000163c0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+000163d0: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+000163e0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+000163f0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00016400: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+00016410: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+00016420: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00016430: 2069 6d61 6765 3a0a 2020 2020 2020 2020   image:.        
+00016440: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
+00016450: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+00016460: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
+00016470: 2249 6d61 6765 2074 6f20 6465 706c 6f79  "Image to deploy
+00016480: 2e22 0a20 2020 2020 2020 2020 2020 2027  .".            '
+00016490: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+000164a0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+000164b0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+000164c0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
+000164d0: 5f72 6573 6f75 7263 6528 2769 6d61 6765  _resource('image
+000164e0: 272c 2027 666f 6f20 636f 6e74 656e 7473  ', 'foo contents
+000164f0: 5c6e 2729 0a20 2020 2020 2020 2070 6174  \n').        pat
+00016500: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
+00016510: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
+00016520: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
+00016530: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016540: 7561 6c28 7061 7468 2e6e 616d 652c 2027  ual(path.name, '
+00016550: 696d 6167 6527 290a 2020 2020 2020 2020  image').        
+00016560: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016570: 2870 6174 682e 7061 7265 6e74 2e6e 616d  (path.parent.nam
+00016580: 652c 2027 696d 6167 6527 290a 0a20 2020  e, 'image')..   
+00016590: 2064 6566 2074 6573 745f 6765 745f 706f   def test_get_po
+000165a0: 645f 7370 6563 2873 656c 6629 3a0a 2020  d_spec(self):.  
+000165b0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+000165c0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+000165d0: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+000165e0: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+000165f0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+00016600: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+00016610: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00016620: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+00016630: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+00016640: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00016650: 2e73 6574 5f6c 6561 6465 7228 5472 7565  .set_leader(True
+00016660: 290a 2020 2020 2020 2020 636f 6e74 6169  ).        contai
+00016670: 6e65 725f 7370 6563 203d 207b 2763 6f6e  ner_spec = {'con
+00016680: 7461 696e 6572 273a 2027 7370 6563 277d  tainer': 'spec'}
+00016690: 0a20 2020 2020 2020 206b 3873 5f72 6573  .        k8s_res
+000166a0: 6f75 7263 6573 203d 207b 276b 3873 273a  ources = {'k8s':
+000166b0: 2027 7370 6563 277d 0a20 2020 2020 2020   'spec'}.       
+000166c0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e70   harness.model.p
+000166d0: 6f64 2e73 6574 5f73 7065 6328 636f 6e74  od.set_spec(cont
+000166e0: 6169 6e65 725f 7370 6563 2c20 6b38 735f  ainer_spec, k8s_
+000166f0: 7265 736f 7572 6365 7329 0a20 2020 2020  resources).     
+00016700: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016710: 7561 6c28 6861 726e 6573 732e 6765 745f  ual(harness.get_
+00016720: 706f 645f 7370 6563 2829 2c20 2863 6f6e  pod_spec(), (con
+00016730: 7461 696e 6572 5f73 7065 632c 206b 3873  tainer_spec, k8s
+00016740: 5f72 6573 6f75 7263 6573 2929 0a0a 2020  _resources))..  
+00016750: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
+00016760: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
+00016770: 6f6b 735f 6e6f 5f72 656c 6174 696f 6e73  oks_no_relations
+00016780: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00016790: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+000167a0: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+000167b0: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
+000167c0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+000167d0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+000167e0: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
+000167f0: 272c 2063 6f6e 6669 673d 2727 270a 2020  ', config='''.  
+00016800: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+00016810: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00016820: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+00016830: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+00016840: 7269 7074 696f 6e3a 2061 2063 6f6e 6669  ription: a confi
+00016850: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
+00016860: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00016870: 653a 2073 7472 696e 670a 2020 2020 2020  e: string.      
+00016880: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00016890: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+000168a0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+000168b0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+000168c0: 6573 732e 7570 6461 7465 5f63 6f6e 6669  ess.update_confi
+000168d0: 6728 7b27 666f 6f27 3a20 2762 6172 277d  g({'foo': 'bar'}
+000168e0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+000168f0: 732e 7365 745f 6c65 6164 6572 2854 7275  s.set_leader(Tru
+00016900: 6529 0a20 2020 2020 2020 2077 6974 6820  e).        with 
+00016910: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00016920: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+00016930: 0a20 2020 2020 2020 2020 2020 205f 203d  .            _ =
+00016940: 2068 6172 6e65 7373 2e63 6861 726d 0a20   harness.charm. 
+00016950: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00016960: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+00016970: 6c5f 686f 6f6b 7328 290a 2020 2020 2020  l_hooks().      
+00016980: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+00016990: 6f74 4e6f 6e65 2868 6172 6e65 7373 2e63  otNone(harness.c
+000169a0: 6861 726d 290a 2020 2020 2020 2020 7365  harm).        se
+000169b0: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+000169c0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+000169d0: 6573 732e 6368 6172 6d2e 6368 616e 6765  ess.charm.change
+000169e0: 732c 0a20 2020 2020 2020 2020 2020 205b  s,.            [
+000169f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a00: 207b 276e 616d 6527 3a20 2769 6e73 7461   {'name': 'insta
+00016a10: 6c6c 277d 2c0a 2020 2020 2020 2020 2020  ll'},.          
+00016a20: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00016a30: 6c65 6164 6572 2d65 6c65 6374 6564 277d  leader-elected'}
+00016a40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016a50: 2020 7b27 6e61 6d65 273a 2027 636f 6e66    {'name': 'conf
+00016a60: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
+00016a70: 7461 273a 207b 2766 6f6f 273a 2027 6261  ta': {'foo': 'ba
+00016a80: 7227 7d7d 2c0a 2020 2020 2020 2020 2020  r'}},.          
+00016a90: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00016aa0: 7374 6172 7427 7d2c 0a20 2020 2020 2020  start'},.       
+00016ab0: 2020 2020 205d 0a20 2020 2020 2020 2029       ].        )
+00016ac0: 0a0a 2020 2020 6465 6620 7465 7374 5f62  ..    def test_b
+00016ad0: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+00016ae0: 6c5f 686f 6f6b 735f 6e6f 5f72 656c 6174  l_hooks_no_relat
+00016af0: 696f 6e73 5f6e 6f74 5f6c 6561 6465 7228  ions_not_leader(
+00016b00: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+00016b10: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00016b20: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
+00016b30: 6f72 6469 6e67 4368 6172 6d2c 206d 6574  ordingCharm, met
+00016b40: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00016b50: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00016b60: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00016b70: 2c20 636f 6e66 6967 3d27 2727 0a20 2020  , config='''.   
+00016b80: 2020 2020 2020 2020 206f 7074 696f 6e73           options
+00016b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016ba0: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
+00016bb0: 2020 2020 2020 2020 2020 2064 6573 6372             descr
+00016bc0: 6970 7469 6f6e 3a20 6120 636f 6e66 6967  iption: a config
+00016bd0: 206f 7074 696f 6e0a 2020 2020 2020 2020   option.        
+00016be0: 2020 2020 2020 2020 2020 2020 7479 7065              type
+00016bf0: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
+00016c00: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00016c10: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00016c20: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00016c30: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+00016c40: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
+00016c50: 287b 2766 6f6f 273a 2027 6261 7227 7d29  ({'foo': 'bar'})
+00016c60: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00016c70: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00016c80: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
+00016c90: 2020 2020 2020 2020 2020 205f 203d 2068             _ = h
+00016ca0: 6172 6e65 7373 2e63 6861 726d 0a20 2020  arness.charm.   
+00016cb0: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+00016cc0: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
+00016cd0: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
+00016ce0: 7365 6c66 2e61 7373 6572 7449 734e 6f74  self.assertIsNot
+00016cf0: 4e6f 6e65 2868 6172 6e65 7373 2e63 6861  None(harness.cha
+00016d00: 726d 290a 2020 2020 2020 2020 7365 6c66  rm).        self
+00016d10: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+00016d20: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+00016d30: 732e 6368 6172 6d2e 6368 616e 6765 732c  s.charm.changes,
+00016d40: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00016d50: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00016d60: 276e 616d 6527 3a20 2769 6e73 7461 6c6c  'name': 'install
+00016d70: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00016d80: 2020 2020 7b27 6e61 6d65 273a 2027 6c65      {'name': 'le
+00016d90: 6164 6572 2d73 6574 7469 6e67 732d 6368  ader-settings-ch
+00016da0: 616e 6765 6427 7d2c 0a20 2020 2020 2020  anged'},.       
+00016db0: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00016dc0: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+00016dd0: 6427 2c20 2764 6174 6127 3a20 7b27 666f  d', 'data': {'fo
+00016de0: 6f27 3a20 2762 6172 277d 7d2c 0a20 2020  o': 'bar'}},.   
+00016df0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
+00016e00: 616d 6527 3a20 2773 7461 7274 277d 2c0a  ame': 'start'},.
+00016e10: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00016e20: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00016e30: 2074 6573 745f 6265 6769 6e5f 7769 7468   test_begin_with
+00016e40: 5f69 6e69 7469 616c 5f68 6f6f 6b73 5f77  _initial_hooks_w
+00016e50: 6974 685f 7065 6572 5f72 656c 6174 696f  ith_peer_relatio
+00016e60: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+00016e70: 2063 6c61 7373 2050 6565 7243 6861 726d   class PeerCharm
+00016e80: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
+00016e90: 6172 6d29 3a0a 2020 2020 2020 2020 2020  arm):.          
+00016ea0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00016eb0: 656c 662c 2066 7261 6d65 776f 726b 293a  elf, framework):
+00016ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016ed0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00016ee0: 5f28 6672 616d 6577 6f72 6b29 0a20 2020  _(framework).   
+00016ef0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00016f00: 662e 6f62 7365 7276 655f 7265 6c61 7469  f.observe_relati
+00016f10: 6f6e 5f65 7665 6e74 7328 2770 6565 7227  on_events('peer'
+00016f20: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00016f30: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00016f40: 4861 726e 6573 7328 5065 6572 4368 6172  Harness(PeerChar
+00016f50: 6d2c 206d 6574 613d 2727 270a 2020 2020  m, meta='''.    
+00016f60: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+00016f70: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+00016f80: 2020 2070 6565 7273 3a0a 2020 2020 2020     peers:.      
+00016f90: 2020 2020 2020 2020 7065 6572 3a0a 2020          peer:.  
+00016fa0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00016fb0: 7465 7266 6163 653a 2061 7070 2d70 6565  terface: app-pee
+00016fc0: 720a 2020 2020 2020 2020 2020 2020 2727  r.            ''
+00016fd0: 272c 2063 6f6e 6669 673d 2727 270a 2020  ', config='''.  
+00016fe0: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+00016ff0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00017000: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+00017010: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+00017020: 7269 7074 696f 6e3a 2061 2063 6f6e 6669  ription: a confi
+00017030: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
+00017040: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00017050: 653a 2073 7472 696e 670a 2020 2020 2020  e: string.      
+00017060: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00017070: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00017080: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00017090: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+000170a0: 6573 732e 7570 6461 7465 5f63 6f6e 6669  ess.update_confi
+000170b0: 6728 7b27 666f 6f27 3a20 2762 6172 277d  g({'foo': 'bar'}
+000170c0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000170d0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000170e0: 2852 756e 7469 6d65 4572 726f 7229 3a0a  (RuntimeError):.
+000170f0: 2020 2020 2020 2020 2020 2020 5f20 3d20              _ = 
+00017100: 6861 726e 6573 732e 6368 6172 6d0a 2020  harness.charm.  
+00017110: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00017120: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
+00017130: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
+00017140: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+00017150: 744e 6f6e 6528 6861 726e 6573 732e 6368  tNone(harness.ch
+00017160: 6172 6d29 0a20 2020 2020 2020 2072 656c  arm).        rel
+00017170: 5f69 6420 3d20 6861 726e 6573 732e 6d6f  _id = harness.mo
+00017180: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00017190: 2827 7065 6572 2729 2e69 640a 2020 2020  ('peer').id.    
+000171a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000171b0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+000171c0: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
+000171d0: 6368 616e 6765 732c 0a20 2020 2020 2020  changes,.       
+000171e0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000171f0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00017200: 2769 6e73 7461 6c6c 277d 2c0a 2020 2020  'install'},.    
+00017210: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+00017220: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+00017230: 7265 6174 6564 272c 0a20 2020 2020 2020  reated',.       
+00017240: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00017250: 696f 6e27 3a20 2770 6565 7227 2c0a 2020  ion': 'peer',.  
+00017260: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00017270: 6461 7461 273a 207b 0a20 2020 2020 2020  data': {.       
+00017280: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00017290: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
+000172a0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+000172b0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+000172c0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000172d0: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+000172e0: 7027 3a20 2774 6573 742d 6170 7027 2c0a  p': 'test-app',.
+000172f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017300: 207d 7d2c 0a20 2020 2020 2020 2020 2020   }},.           
+00017310: 2020 2020 207b 276e 616d 6527 3a20 276c       {'name': 'l
+00017320: 6561 6465 722d 7365 7474 696e 6773 2d63  eader-settings-c
+00017330: 6861 6e67 6564 277d 2c0a 2020 2020 2020  hanged'},.      
+00017340: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+00017350: 273a 2027 636f 6e66 6967 2d63 6861 6e67  ': 'config-chang
+00017360: 6564 272c 2027 6461 7461 273a 207b 2766  ed', 'data': {'f
+00017370: 6f6f 273a 2027 6261 7227 7d7d 2c0a 2020  oo': 'bar'}},.  
+00017380: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00017390: 6e61 6d65 273a 2027 7374 6172 7427 7d2c  name': 'start'},
+000173a0: 0a20 2020 2020 2020 2020 2020 205d 290a  .            ]).
+000173b0: 2020 2020 2020 2020 2320 5769 7468 2061          # With a
+000173c0: 2073 696e 676c 6520 756e 6974 2c20 6e6f   single unit, no
+000173d0: 2070 6565 722d 7265 6c61 7469 6f6e 2d6a   peer-relation-j
+000173e0: 6f69 6e65 6420 6973 2066 6972 6564 0a0a  oined is fired..
+000173f0: 2020 2020 6465 6620 7465 7374 5f62 6567      def test_beg
+00017400: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
+00017410: 686f 6f6b 735f 7065 6572 5f72 656c 6174  hooks_peer_relat
+00017420: 696f 6e5f 7072 655f 6465 6669 6e65 6428  ion_pre_defined(
+00017430: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+00017440: 6c61 7373 2050 6565 7243 6861 726d 2852  lass PeerCharm(R
+00017450: 656c 6174 696f 6e45 7665 6e74 4368 6172  elationEventChar
+00017460: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
+00017470: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00017480: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
+00017490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000174a0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+000174b0: 6672 616d 6577 6f72 6b29 0a20 2020 2020  framework).     
+000174c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000174d0: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
+000174e0: 5f65 7665 6e74 7328 2770 6565 7227 290a  _events('peer').
+000174f0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00017500: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+00017510: 726e 6573 7328 5065 6572 4368 6172 6d2c  rness(PeerCharm,
+00017520: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00017530: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00017540: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00017550: 2070 6565 7273 3a0a 2020 2020 2020 2020   peers:.        
+00017560: 2020 2020 2020 7065 6572 3a0a 2020 2020        peer:.    
+00017570: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00017580: 7266 6163 653a 2061 7070 2d70 6565 720a  rface: app-peer.
+00017590: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+000175a0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+000175b0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+000175c0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+000175d0: 2020 7065 6572 5f72 656c 5f69 6420 3d20    peer_rel_id = 
+000175e0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+000175f0: 7469 6f6e 2827 7065 6572 272c 2027 7465  tion('peer', 'te
+00017600: 7374 2d61 7070 2729 0a20 2020 2020 2020  st-app').       
+00017610: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
+00017620: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
+00017630: 7328 290a 2020 2020 2020 2020 2320 4966  s().        # If
+00017640: 2074 6865 2070 6565 7220 7265 6c61 7469   the peer relati
+00017650: 6f6e 2069 7320 616c 7265 6164 7920 6465  on is already de
+00017660: 6669 6e65 6420 6279 2074 6865 2075 7365  fined by the use
+00017670: 722c 2077 6520 646f 6e27 7420 6372 6561  r, we don't crea
+00017680: 7465 2074 6865 2072 656c 6174 696f 6e20  te the relation 
+00017690: 610a 2020 2020 2020 2020 2320 7365 636f  a.        # seco
+000176a0: 6e64 2074 696d 652c 2062 7574 2077 6520  nd time, but we 
+000176b0: 646f 2073 7469 6c6c 2066 6972 6520 7265  do still fire re
+000176c0: 6c61 7469 6f6e 2d63 7265 6174 6564 2e0a  lation-created..
+000176d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000176e0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000176f0: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+00017700: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
+00017710: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00017720: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00017730: 6527 3a20 2769 6e73 7461 6c6c 277d 2c0a  e': 'install'},.
+00017740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017750: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00017760: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
+00017770: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00017780: 656c 6174 696f 6e27 3a20 2770 6565 7227  elation': 'peer'
+00017790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000177a0: 2020 2027 6461 7461 273a 207b 0a20 2020     'data': {.   
+000177b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177c0: 2020 2772 656c 6174 696f 6e5f 6964 273a    'relation_id':
+000177d0: 2070 6565 725f 7265 6c5f 6964 2c0a 2020   peer_rel_id,.  
+000177e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177f0: 2020 2027 756e 6974 273a 204e 6f6e 652c     'unit': None,
+00017800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017810: 2020 2020 2020 2761 7070 273a 2027 7465        'app': 'te
+00017820: 7374 2d61 7070 272c 0a20 2020 2020 2020  st-app',.       
+00017830: 2020 2020 2020 2020 2020 7d7d 2c0a 2020            }},.  
+00017840: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00017850: 6e61 6d65 273a 2027 6c65 6164 6572 2d73  name': 'leader-s
+00017860: 6574 7469 6e67 732d 6368 616e 6765 6427  ettings-changed'
+00017870: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00017880: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
+00017890: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
+000178a0: 6174 6127 3a20 7b7d 7d2c 0a20 2020 2020  ata': {}},.     
+000178b0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+000178c0: 6527 3a20 2773 7461 7274 277d 2c0a 2020  e': 'start'},.  
+000178d0: 2020 2020 2020 2020 2020 5d29 0a0a 2020            ])..  
+000178e0: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
+000178f0: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
+00017900: 6f6b 735f 7265 6c61 7469 6f6e 5f63 6861  oks_relation_cha
+00017910: 726d 5f77 6974 685f 6e6f 5f72 656c 6174  rm_with_no_relat
+00017920: 696f 6e28 7365 6c66 293a 0a20 2020 2020  ion(self):.     
+00017930: 2020 2063 6c61 7373 2043 6861 726d 5769     class CharmWi
+00017940: 7468 4442 2852 656c 6174 696f 6e45 7665  thDB(RelationEve
+00017950: 6e74 4368 6172 6d29 3a0a 2020 2020 2020  ntCharm):.      
+00017960: 2020 2020 2020 6465 6620 5f5f 696e 6974        def __init
+00017970: 5f5f 2873 656c 662c 2066 7261 6d65 776f  __(self, framewo
+00017980: 726b 293a 0a20 2020 2020 2020 2020 2020  rk):.           
+00017990: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+000179a0: 6e69 745f 5f28 6672 616d 6577 6f72 6b29  nit__(framework)
+000179b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179c0: 2073 656c 662e 6f62 7365 7276 655f 7265   self.observe_re
+000179d0: 6c61 7469 6f6e 5f65 7665 6e74 7328 2764  lation_events('d
+000179e0: 6227 290a 2020 2020 2020 2020 6861 726e  b').        harn
+000179f0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00017a00: 672e 4861 726e 6573 7328 4368 6172 6d57  g.Harness(CharmW
+00017a10: 6974 6844 422c 206d 6574 613d 2727 270a  ithDB, meta='''.
+00017a20: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00017a30: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+00017a40: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00017a50: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
+00017a60: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
+00017a70: 2020 2069 6e74 6572 6661 6365 3a20 7371     interface: sq
+00017a80: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
+00017a90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00017aa0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00017ab0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00017ac0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+00017ad0: 6c65 6164 6572 2829 0a20 2020 2020 2020  leader().       
+00017ae0: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
+00017af0: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
+00017b00: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+00017b10: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+00017b20: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+00017b30: 732e 6368 6172 6d2e 6368 616e 6765 732c  s.charm.changes,
+00017b40: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00017b50: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00017b60: 276e 616d 6527 3a20 2769 6e73 7461 6c6c  'name': 'install
+00017b70: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00017b80: 2020 2020 7b27 6e61 6d65 273a 2027 6c65      {'name': 'le
+00017b90: 6164 6572 2d65 6c65 6374 6564 277d 2c0a  ader-elected'},.
+00017ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bb0: 7b27 6e61 6d65 273a 2027 636f 6e66 6967  {'name': 'config
+00017bc0: 2d63 6861 6e67 6564 272c 2027 6461 7461  -changed', 'data
+00017bd0: 273a 207b 7d7d 2c0a 2020 2020 2020 2020  ': {}},.        
+00017be0: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00017bf0: 2027 7374 6172 7427 7d2c 0a20 2020 2020   'start'},.     
+00017c00: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
+00017c10: 6566 2074 6573 745f 6265 6769 6e5f 7769  ef test_begin_wi
+00017c20: 7468 5f69 6e69 7469 616c 5f68 6f6f 6b73  th_initial_hooks
+00017c30: 5f77 6974 685f 6f6e 655f 7265 6c61 7469  _with_one_relati
+00017c40: 6f6e 2873 656c 6629 3a0a 2020 2020 2020  on(self):.      
+00017c50: 2020 636c 6173 7320 4368 6172 6d57 6974    class CharmWit
+00017c60: 6844 4228 5265 6c61 7469 6f6e 4576 656e  hDB(RelationEven
+00017c70: 7443 6861 726d 293a 0a20 2020 2020 2020  tCharm):.       
+00017c80: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
+00017c90: 5f28 7365 6c66 2c20 6672 616d 6577 6f72  _(self, framewor
+00017ca0: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
+00017cb0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00017cc0: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
+00017cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ce0: 7365 6c66 2e6f 6273 6572 7665 5f72 656c  self.observe_rel
+00017cf0: 6174 696f 6e5f 6576 656e 7473 2827 6462  ation_events('db
+00017d00: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00017d10: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+00017d20: 2e48 6172 6e65 7373 2843 6861 726d 5769  .Harness(CharmWi
+00017d30: 7468 4442 2c20 6d65 7461 3d27 2727 0a20  thDB, meta='''. 
+00017d40: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00017d50: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00017d60: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+00017d70: 2020 2020 2020 2020 2020 2020 2020 6462                db
+00017d80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017d90: 2020 696e 7465 7266 6163 653a 2073 716c    interface: sql
+00017da0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00017db0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00017dc0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00017dd0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00017de0: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
+00017df0: 6561 6465 7228 290a 2020 2020 2020 2020  eader().        
+00017e00: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00017e10: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00017e20: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+00017e30: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00017e40: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00017e50: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+00017e60: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+00017e70: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00017e80: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00017e90: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+00017ea0: 6573 716c 2f30 272c 207b 276e 6577 273a  esql/0', {'new':
+00017eb0: 2027 6461 7461 277d 290a 2020 2020 2020   'data'}).      
+00017ec0: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
+00017ed0: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
+00017ee0: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
+00017ef0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00017f00: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00017f10: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
+00017f20: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+00017f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f40: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
+00017f50: 6c27 7d2c 0a20 2020 2020 2020 2020 2020  l'},.           
+00017f60: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+00017f70: 656c 6174 696f 6e2d 6372 6561 7465 6427  elation-created'
+00017f80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017f90: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
+00017fa0: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
+00017fb0: 2020 2020 2020 2764 6174 6127 3a20 7b0a        'data': {.
+00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fd0: 2020 2020 2027 7265 6c61 7469 6f6e 5f69       'relation_i
+00017fe0: 6427 3a20 7265 6c5f 6964 2c0a 2020 2020  d': rel_id,.    
+00017ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018000: 2027 756e 6974 273a 204e 6f6e 652c 0a20   'unit': None,. 
 00018010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018020: 2027 7265 6c61 7469 6f6e 5f69 6427 3a20   'relation_id': 
-00018030: 7265 6c5f 6964 2c0a 2020 2020 2020 2020  rel_id,.        
-00018040: 2020 2020 2020 2020 2020 2020 2027 756e               'un
-00018050: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
-00018060: 2f30 272c 0a20 2020 2020 2020 2020 2020  /0',.           
-00018070: 2020 2020 2020 2020 2020 2761 7070 273a            'app':
-00018080: 2027 706f 7374 6772 6573 716c 272c 0a20   'postgresql',. 
-00018090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180a0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
-000180b0: 5d2c 0a20 2020 2020 2020 2020 2020 2068  ],.            h
-000180c0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
-000180d0: 6e67 6573 290a 0a20 2020 2064 6566 2074  nges)..    def t
-000180e0: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
-000180f0: 6e69 7469 616c 5f68 6f6f 6b73 5f77 6974  nitial_hooks_wit
-00018100: 685f 6d75 6c74 6970 6c65 5f75 6e69 7473  h_multiple_units
-00018110: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00018120: 636c 6173 7320 4368 6172 6d57 6974 6844  class CharmWithD
-00018130: 4228 5265 6c61 7469 6f6e 4576 656e 7443  B(RelationEventC
-00018140: 6861 726d 293a 0a20 2020 2020 2020 2020  harm):.         
-00018150: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00018160: 7365 6c66 2c20 6672 616d 6577 6f72 6b29  self, framework)
-00018170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018180: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-00018190: 5f5f 2866 7261 6d65 776f 726b 290a 2020  __(framework).  
-000181a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000181b0: 6c66 2e6f 6273 6572 7665 5f72 656c 6174  lf.observe_relat
-000181c0: 696f 6e5f 6576 656e 7473 2827 6462 2729  ion_events('db')
-000181d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000181e0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
-000181f0: 6172 6e65 7373 2843 6861 726d 5769 7468  arness(CharmWith
-00018200: 4442 2c20 6d65 7461 3d27 2727 0a20 2020  DB, meta='''.   
-00018210: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-00018220: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
-00018230: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-00018240: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00018250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018260: 696e 7465 7266 6163 653a 2073 716c 0a20  interface: sql. 
-00018270: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00018280: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00018290: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-000182a0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-000182b0: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
-000182c0: 6465 7228 290a 2020 2020 2020 2020 7265  der().        re
-000182d0: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
-000182e0: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
-000182f0: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
-00018300: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00018310: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00018320: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-00018330: 7265 7371 6c2f 3127 290a 2020 2020 2020  resql/1').      
-00018340: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00018350: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00018360: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00018370: 716c 2f31 272c 207b 276e 6577 273a 2027  ql/1', {'new': '
-00018380: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
-00018390: 2320 5765 2069 6e74 656e 7469 6f6e 616c  # We intentional
-000183a0: 6c79 2061 6464 2030 2061 6674 6572 2031  ly add 0 after 1
-000183b0: 2074 6f20 6173 7365 7274 2074 6861 7420   to assert that 
-000183c0: 7468 6520 636f 6465 2074 7269 6767 6572  the code trigger
-000183d0: 7320 7468 656d 2069 6e20 6f72 6465 720a  s them in order.
-000183e0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-000183f0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00018400: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-00018410: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
-00018420: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
-00018430: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
-00018440: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
-00018450: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00018460: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-00018470: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
-00018480: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
-00018490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184a0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
-000184b0: 6c27 7d2c 0a20 2020 2020 2020 2020 2020  l'},.           
-000184c0: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
-000184d0: 656c 6174 696f 6e2d 6372 6561 7465 6427  elation-created'
-000184e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000184f0: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
-00018500: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
-00018510: 2020 2020 2020 2764 6174 6127 3a20 7b0a        'data': {.
-00018520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018530: 2020 2020 2027 7265 6c61 7469 6f6e 5f69       'relation_i
-00018540: 6427 3a20 7265 6c5f 6964 2c0a 2020 2020  d': rel_id,.    
-00018550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018560: 2027 756e 6974 273a 204e 6f6e 652c 0a20   'unit': None,. 
-00018570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018580: 2020 2020 2761 7070 273a 2027 706f 7374      'app': 'post
-00018590: 6772 6573 716c 272c 0a20 2020 2020 2020  gresql',.       
-000185a0: 2020 2020 2020 2020 2020 7d7d 2c0a 2020            }},.  
-000185b0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-000185c0: 6e61 6d65 273a 2027 6c65 6164 6572 2d65  name': 'leader-e
-000185d0: 6c65 6374 6564 277d 2c0a 2020 2020 2020  lected'},.      
-000185e0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-000185f0: 273a 2027 636f 6e66 6967 2d63 6861 6e67  ': 'config-chang
-00018600: 6564 272c 2027 6461 7461 273a 207b 7d7d  ed', 'data': {}}
-00018610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018620: 2020 7b27 6e61 6d65 273a 2027 7374 6172    {'name': 'star
-00018630: 7427 7d2c 0a20 2020 2020 2020 2020 2020  t'},.           
-00018640: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
-00018650: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
+00018020: 2020 2020 2761 7070 273a 2027 706f 7374      'app': 'post
+00018030: 6772 6573 716c 272c 0a20 2020 2020 2020  gresql',.       
+00018040: 2020 2020 2020 2020 2020 7d7d 2c0a 2020            }},.  
+00018050: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00018060: 6e61 6d65 273a 2027 6c65 6164 6572 2d65  name': 'leader-e
+00018070: 6c65 6374 6564 277d 2c0a 2020 2020 2020  lected'},.      
+00018080: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+00018090: 273a 2027 636f 6e66 6967 2d63 6861 6e67  ': 'config-chang
+000180a0: 6564 272c 2027 6461 7461 273a 207b 7d7d  ed', 'data': {}}
+000180b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000180c0: 2020 7b27 6e61 6d65 273a 2027 7374 6172    {'name': 'star
+000180d0: 7427 7d2c 0a20 2020 2020 2020 2020 2020  t'},.           
+000180e0: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+000180f0: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
+00018100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018110: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
+00018120: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00018130: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
+00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018150: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00018160: 273a 2072 656c 5f69 642c 0a20 2020 2020  ': rel_id,.     
+00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018180: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
+00018190: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
+000181a0: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+000181b0: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
+000181c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000181d0: 2020 207d 7d2c 0a20 2020 2020 2020 2020     }},.         
+000181e0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+000181f0: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
+00018200: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00018210: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
+00018220: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
+00018230: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+00018240: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00018250: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00018260: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+00018270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018280: 2020 2027 756e 6974 273a 2027 706f 7374     'unit': 'post
+00018290: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
+000182a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182b0: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
+000182c0: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
+000182d0: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+000182e0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+000182f0: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
+00018300: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
+00018310: 7769 7468 5f61 7070 6c69 6361 7469 6f6e  with_application
+00018320: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
+00018330: 2020 2020 2063 6c61 7373 2043 6861 726d       class Charm
+00018340: 5769 7468 4442 2852 656c 6174 696f 6e45  WithDB(RelationE
+00018350: 7665 6e74 4368 6172 6d29 3a0a 2020 2020  ventCharm):.    
+00018360: 2020 2020 2020 2020 6465 6620 5f5f 696e          def __in
+00018370: 6974 5f5f 2873 656c 662c 2066 7261 6d65  it__(self, frame
+00018380: 776f 726b 293a 0a20 2020 2020 2020 2020  work):.         
+00018390: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+000183a0: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
+000183b0: 6b29 0a20 2020 2020 2020 2020 2020 2020  k).             
+000183c0: 2020 2073 656c 662e 6f62 7365 7276 655f     self.observe_
+000183d0: 7265 6c61 7469 6f6e 5f65 7665 6e74 7328  relation_events(
+000183e0: 2764 6227 290a 2020 2020 2020 2020 6861  'db').        ha
+000183f0: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00018400: 696e 672e 4861 726e 6573 7328 4368 6172  ing.Harness(Char
+00018410: 6d57 6974 6844 422c 206d 6574 613d 2727  mWithDB, meta=''
+00018420: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00018430: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00018440: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00018450: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00018460: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00018470: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00018480: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00018490: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+000184a0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+000184b0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+000184c0: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
+000184d0: 745f 6c65 6164 6572 2829 0a20 2020 2020  t_leader().     
+000184e0: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
+000184f0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00018500: 2827 6462 272c 2027 706f 7374 6772 6573  ('db', 'postgres
+00018510: 716c 2729 0a20 2020 2020 2020 2068 6172  ql').        har
+00018520: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00018530: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
+00018540: 706f 7374 6772 6573 716c 2f30 2729 0a20  postgresql/0'). 
+00018550: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
+00018560: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00018570: 6174 6128 7265 6c5f 6964 2c20 2770 6f73  ata(rel_id, 'pos
+00018580: 7467 7265 7371 6c2f 3027 2c20 7b27 6e65  tgresql/0', {'ne
+00018590: 7727 3a20 2764 6174 6127 7d29 0a20 2020  w': 'data'}).   
+000185a0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+000185b0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+000185c0: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
+000185d0: 7265 7371 6c27 2c20 7b27 6170 7027 3a20  resql', {'app': 
+000185e0: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
+000185f0: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
+00018600: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
+00018610: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+00018620: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+00018630: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+00018640: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+00018650: 6d65 273a 2027 696e 7374 616c 6c27 7d2c  me': 'install'},
 00018660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018670: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
-00018680: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00018690: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
-000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186b0: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
-000186c0: 273a 2072 656c 5f69 642c 0a20 2020 2020  ': rel_id,.     
+00018670: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
+00018680: 696f 6e2d 6372 6561 7465 6427 2c0a 2020  ion-created',.  
+00018690: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000186a0: 7265 6c61 7469 6f6e 273a 2027 6462 272c  relation': 'db',
+000186b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000186c0: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
 000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186e0: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
-000186f0: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
-00018700: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
-00018710: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
-00018720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018730: 2020 207d 7d2c 0a20 2020 2020 2020 2020     }},.         
-00018740: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00018750: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
-00018760: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00018770: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
-00018780: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
-00018790: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-000187a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000187b0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-000187c0: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
-000187d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187e0: 2020 2027 756e 6974 273a 2027 706f 7374     'unit': 'post
-000187f0: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
-00018800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018810: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
-00018820: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
-00018830: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
-00018840: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00018850: 273a 2027 7265 6c61 7469 6f6e 2d6a 6f69  ': 'relation-joi
-00018860: 6e65 6427 2c0a 2020 2020 2020 2020 2020  ned',.          
-00018870: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-00018880: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
-00018890: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-000188a0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000188b0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-000188c0: 6f6e 5f69 6427 3a20 7265 6c5f 6964 2c0a  on_id': rel_id,.
-000188d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188e0: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
-000188f0: 7374 6772 6573 716c 2f31 272c 0a20 2020  stgresql/1',.   
-00018900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018910: 2020 2761 7070 273a 2027 706f 7374 6772    'app': 'postgr
-00018920: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
-00018930: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
-00018940: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-00018950: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
-00018960: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
-00018970: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00018980: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-00018990: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-000189a0: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
-000189b0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-000189c0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-000189d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000189e0: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
-000189f0: 2770 6f73 7467 7265 7371 6c2f 3127 2c0a  'postgresql/1',.
-00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a10: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00018a20: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00018a30: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
-00018a40: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
-00018a50: 2020 2064 6566 2074 6573 745f 6265 6769     def test_begi
-00018a60: 6e5f 7769 7468 5f69 6e69 7469 616c 5f68  n_with_initial_h
-00018a70: 6f6f 6b73 5f6d 756c 7469 706c 655f 7265  ooks_multiple_re
-00018a80: 6c61 7469 6f6e 5f73 616d 655f 656e 6470  lation_same_endp
-00018a90: 6f69 6e74 2873 656c 6629 3a0a 2020 2020  oint(self):.    
-00018aa0: 2020 2020 636c 6173 7320 4368 6172 6d57      class CharmW
-00018ab0: 6974 6844 4228 5265 6c61 7469 6f6e 4576  ithDB(RelationEv
-00018ac0: 656e 7443 6861 726d 293a 0a20 2020 2020  entCharm):.     
-00018ad0: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
-00018ae0: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
-00018af0: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
-00018b00: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00018b10: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
-00018b20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018b30: 2020 7365 6c66 2e6f 6273 6572 7665 5f72    self.observe_r
-00018b40: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
-00018b50: 6462 2729 0a20 2020 2020 2020 2068 6172  db').        har
-00018b60: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
-00018b70: 6e67 2e48 6172 6e65 7373 2843 6861 726d  ng.Harness(Charm
-00018b80: 5769 7468 4442 2c20 6d65 7461 3d27 2727  WithDB, meta='''
-00018b90: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00018ba0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-00018bb0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
-00018bc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018bd0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-00018be0: 2020 2020 696e 7465 7266 6163 653a 2073      interface: s
-00018bf0: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
-00018c00: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-00018c10: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-00018c20: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-00018c30: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-00018c40: 5f6c 6561 6465 7228 290a 2020 2020 2020  _leader().      
-00018c50: 2020 7265 6c5f 6964 5f61 203d 2068 6172    rel_id_a = har
-00018c60: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00018c70: 6e28 2764 6227 2c20 2770 672d 6127 290a  n('db', 'pg-a').
-00018c80: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00018c90: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00018ca0: 7428 7265 6c5f 6964 5f61 2c20 2770 672d  t(rel_id_a, 'pg-
-00018cb0: 612f 3027 290a 2020 2020 2020 2020 7265  a/0').        re
-00018cc0: 6c5f 6964 5f62 203d 2068 6172 6e65 7373  l_id_b = harness
-00018cd0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00018ce0: 6227 2c20 2770 672d 6227 290a 2020 2020  b', 'pg-b').    
-00018cf0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-00018d00: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00018d10: 6c5f 6964 5f62 2c20 2770 672d 622f 3027  l_id_b, 'pg-b/0'
-00018d20: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00018d30: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
-00018d40: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
-00018d50: 2020 2020 2063 6861 6e67 6573 203d 2068       changes = h
-00018d60: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
-00018d70: 6e67 6573 5b3a 5d0a 2020 2020 2020 2020  nges[:].        
-00018d80: 6578 7065 6374 6564 5f70 7265 6669 7820  expected_prefix 
-00018d90: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00018da0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
-00018db0: 6c27 7d2c 0a20 2020 2020 2020 205d 0a20  l'},.        ]. 
-00018dc0: 2020 2020 2020 2023 2054 6865 2066 6972         # The fir
-00018dd0: 7374 2065 7665 6e74 7320 6172 6520 616c  st events are al
-00018de0: 7761 7973 2074 6865 2073 616d 650a 2020  ways the same.  
-00018df0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018e00: 7445 7175 616c 2863 6861 6e67 6573 5b3a  tEqual(changes[:
-00018e10: 6c65 6e28 6578 7065 6374 6564 5f70 7265  len(expected_pre
-00018e20: 6669 7829 5d2c 2065 7870 6563 7465 645f  fix)], expected_
-00018e30: 7072 6566 6978 290a 2020 2020 2020 2020  prefix).        
-00018e40: 6368 616e 6765 7320 3d20 6368 616e 6765  changes = change
-00018e50: 735b 6c65 6e28 6578 7065 6374 6564 5f70  s[len(expected_p
-00018e60: 7265 6669 7829 3a5d 0a20 2020 2020 2020  refix):].       
-00018e70: 2023 2048 6f77 6576 6572 2c20 7468 6520   # However, the 
-00018e80: 6f72 6465 7220 6f66 2072 656c 6174 696f  order of relatio
-00018e90: 6e2d 6372 6561 7465 6420 6576 656e 7473  n-created events
-00018ea0: 2063 616e 2062 6520 696e 2061 6e79 206f   can be in any o
-00018eb0: 7264 6572 0a20 2020 2020 2020 2065 7870  rder.        exp
-00018ec0: 6563 7465 645f 7265 6c61 7469 6f6e 5f63  ected_relation_c
-00018ed0: 7265 6174 6564 203d 205b 0a20 2020 2020  reated = [.     
-00018ee0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00018ef0: 2772 656c 6174 696f 6e2d 6372 6561 7465  'relation-create
-00018f00: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00018f10: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
-00018f20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00018f30: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
-00018f40: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00018f50: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
-00018f60: 5f61 2c0a 2020 2020 2020 2020 2020 2020  _a,.            
-00018f70: 2020 2020 2027 756e 6974 273a 204e 6f6e       'unit': Non
-00018f80: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00018f90: 2020 2020 2761 7070 273a 2027 7067 2d61      'app': 'pg-a
-00018fa0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00018fb0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
-00018fc0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-00018fd0: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
-00018fe0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00018ff0: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-00019000: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00019010: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00019020: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
-00019030: 273a 2072 656c 5f69 645f 622c 0a20 2020  ': rel_id_b,.   
-00019040: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00019050: 6e69 7427 3a20 4e6f 6e65 2c0a 2020 2020  nit': None,.    
-00019060: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
-00019070: 7027 3a20 2770 672d 6227 2c0a 2020 2020  p': 'pg-b',.    
-00019080: 2020 2020 2020 2020 207d 7d2c 0a20 2020           }},.   
-00019090: 2020 2020 205d 0a20 2020 2020 2020 2069       ].        i
-000190a0: 6620 6368 616e 6765 735b 3a32 5d20 213d  f changes[:2] !=
-000190b0: 2065 7870 6563 7465 645f 7265 6c61 7469   expected_relati
-000190c0: 6f6e 5f63 7265 6174 6564 3a0a 2020 2020  on_created:.    
-000190d0: 2020 2020 2020 2020 2320 6368 616e 6765          # change
-000190e0: 2074 6865 206f 7264 6572 0a20 2020 2020   the order.     
-000190f0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00019100: 7265 6c61 7469 6f6e 5f63 7265 6174 6564  relation_created
-00019110: 203d 205b 6578 7065 6374 6564 5f72 656c   = [expected_rel
-00019120: 6174 696f 6e5f 6372 6561 7465 645b 315d  ation_created[1]
-00019130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019150: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-00019160: 7465 645f 7265 6c61 7469 6f6e 5f63 7265  ted_relation_cre
-00019170: 6174 6564 5b30 5d5d 0a20 2020 2020 2020  ated[0]].       
-00019180: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019190: 6c28 6368 616e 6765 735b 3a32 5d2c 2065  l(changes[:2], e
-000191a0: 7870 6563 7465 645f 7265 6c61 7469 6f6e  xpected_relation
-000191b0: 5f63 7265 6174 6564 290a 2020 2020 2020  _created).      
-000191c0: 2020 6368 616e 6765 7320 3d20 6368 616e    changes = chan
-000191d0: 6765 735b 323a 5d0a 2020 2020 2020 2020  ges[2:].        
-000191e0: 6578 7065 6374 6564 5f6d 6964 646c 6520  expected_middle 
-000191f0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00019200: 7b27 6e61 6d65 273a 2027 6c65 6164 6572  {'name': 'leader
-00019210: 2d65 6c65 6374 6564 277d 2c0a 2020 2020  -elected'},.    
-00019220: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00019230: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
-00019240: 272c 2027 6461 7461 273a 207b 7d7d 2c0a  ', 'data': {}},.
-00019250: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-00019260: 6d65 273a 2027 7374 6172 7427 7d2c 0a20  me': 'start'},. 
-00019270: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00019280: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019290: 6c28 6368 616e 6765 735b 3a6c 656e 2865  l(changes[:len(e
-000192a0: 7870 6563 7465 645f 6d69 6464 6c65 295d  xpected_middle)]
-000192b0: 2c20 6578 7065 6374 6564 5f6d 6964 646c  , expected_middl
-000192c0: 6529 0a20 2020 2020 2020 2063 6861 6e67  e).        chang
-000192d0: 6573 203d 2063 6861 6e67 6573 5b6c 656e  es = changes[len
-000192e0: 2865 7870 6563 7465 645f 6d69 6464 6c65  (expected_middle
-000192f0: 293a 5d0a 2020 2020 2020 2020 615f 6669  ):].        a_fi
-00019300: 7273 7420 3d20 5b0a 2020 2020 2020 2020  rst = [.        
-00019310: 2020 2020 7b27 6e61 6d65 273a 2027 7265      {'name': 're
-00019320: 6c61 7469 6f6e 2d6a 6f69 6e65 6427 2c0a  lation-joined',.
-00019330: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00019340: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-00019350: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
-00019360: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
-00019370: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-00019380: 5f69 6427 3a20 7265 6c5f 6964 5f61 2c0a  _id': rel_id_a,.
-00019390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193a0: 2027 756e 6974 273a 2027 7067 2d61 2f30   'unit': 'pg-a/0
-000193b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000193c0: 2020 2020 2761 7070 273a 2027 7067 2d61      'app': 'pg-a
-000193d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000193e0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
-000193f0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-00019400: 6f6e 2d63 6861 6e67 6564 272c 0a20 2020  on-changed',.   
-00019410: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00019420: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-00019430: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00019440: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00019450: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
-00019460: 273a 2072 656c 5f69 645f 612c 0a20 2020  ': rel_id_a,.   
-00019470: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00019480: 6e69 7427 3a20 2770 672d 612f 3027 2c0a  nit': 'pg-a/0',.
-00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194a0: 2027 6170 7027 3a20 2770 672d 6127 2c0a   'app': 'pg-a',.
-000194b0: 2020 2020 2020 2020 2020 2020 207d 7d2c               }},
-000194c0: 0a20 2020 2020 2020 2020 2020 207b 276e  .            {'n
-000194d0: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
-000194e0: 6a6f 696e 6564 272c 0a20 2020 2020 2020  joined',.       
-000194f0: 2020 2020 2020 2772 656c 6174 696f 6e27        'relation'
-00019500: 3a20 2764 6227 2c0a 2020 2020 2020 2020  : 'db',.        
-00019510: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
-00019520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019530: 2772 656c 6174 696f 6e5f 6964 273a 2072  'relation_id': r
-00019540: 656c 5f69 645f 622c 0a20 2020 2020 2020  el_id_b,.       
-00019550: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
-00019560: 3a20 2770 672d 622f 3027 2c0a 2020 2020  : 'pg-b/0',.    
-00019570: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
-00019580: 7027 3a20 2770 672d 6227 2c0a 2020 2020  p': 'pg-b',.    
-00019590: 2020 2020 2020 2020 207d 7d2c 0a20 2020           }},.   
-000195a0: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-000195b0: 3a20 2772 656c 6174 696f 6e2d 6368 616e  : 'relation-chan
-000195c0: 6765 6427 2c0a 2020 2020 2020 2020 2020  ged',.          
-000195d0: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
-000195e0: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
-000195f0: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
-00019600: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00019610: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
-00019620: 6964 5f62 2c0a 2020 2020 2020 2020 2020  id_b,.          
-00019630: 2020 2020 2020 2027 756e 6974 273a 2027         'unit': '
-00019640: 7067 2d62 2f30 272c 0a20 2020 2020 2020  pg-b/0',.       
-00019650: 2020 2020 2020 2020 2020 2761 7070 273a            'app':
-00019660: 2027 7067 2d62 272c 0a20 2020 2020 2020   'pg-b',.       
-00019670: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
-00019680: 2020 5d0a 2020 2020 2020 2020 6966 2063    ].        if c
-00019690: 6861 6e67 6573 2021 3d20 615f 6669 7273  hanges != a_firs
-000196a0: 743a 0a20 2020 2020 2020 2020 2020 2062  t:.            b
-000196b0: 5f66 6972 7374 203d 205b 615f 6669 7273  _first = [a_firs
-000196c0: 745b 325d 2c20 615f 6669 7273 745b 335d  t[2], a_first[3]
-000196d0: 2c20 615f 6669 7273 745b 305d 2c20 615f  , a_first[0], a_
-000196e0: 6669 7273 745b 315d 5d0a 2020 2020 2020  first[1]].      
-000196f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019700: 7445 7175 616c 2863 6861 6e67 6573 2c20  tEqual(changes, 
-00019710: 625f 6669 7273 7429 0a0a 2020 2020 6465  b_first)..    de
-00019720: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
-00019730: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
-00019740: 756e 6b6e 6f77 6e5f 7374 6174 7573 2873  unknown_status(s
-00019750: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-00019760: 5665 7269 6679 2074 6861 7420 6120 6368  Verify that a ch
-00019770: 6172 6d20 7468 6174 2064 6f65 7320 6e6f  arm that does no
-00019780: 7420 7365 7420 6120 7374 6174 7573 2069  t set a status i
-00019790: 6e20 7468 6520 696e 7374 616c 6c20 686f  n the install ho
-000197a0: 6f6b 2077 696c 6c20 6861 7665 2061 6e0a  ok will have an.
-000197b0: 2020 2020 2020 2020 2320 756e 6b6e 6f77          # unknow
-000197c0: 6e20 7374 6174 7573 2069 6e20 7468 6520  n status in the 
-000197d0: 6861 726e 6573 732e 0a20 2020 2020 2020  harness..       
-000197e0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-000197f0: 6573 7469 6e67 2e48 6172 6e65 7373 2852  esting.Harness(R
-00019800: 6563 6f72 6469 6e67 4368 6172 6d2c 206d  ecordingCharm, m
-00019810: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00019820: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00019830: 7070 0a20 2020 2020 2020 2020 2020 2027  pp.            '
-00019840: 2727 2c20 636f 6e66 6967 3d27 2727 0a20  '', config='''. 
-00019850: 2020 2020 2020 2020 206f 7074 696f 6e73           options
-00019860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019870: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
-00019880: 2020 2020 2020 2020 2020 2064 6573 6372             descr
-00019890: 6970 7469 6f6e 3a20 6120 636f 6e66 6967  iption: a config
-000198a0: 206f 7074 696f 6e0a 2020 2020 2020 2020   option.        
-000198b0: 2020 2020 2020 2020 2020 2020 7479 7065              type
-000198c0: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
-000198d0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-000198e0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-000198f0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00019900: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
-00019910: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-00019920: 636b 656e 640a 2020 2020 2020 2020 6861  ckend.        ha
-00019930: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
-00019940: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
-00019950: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00019960: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-00019970: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
-00019980: 7374 6174 7573 5f67 6574 2869 735f 6170  status_get(is_ap
-00019990: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-000199a0: 2020 2020 2020 7b27 7374 6174 7573 273a        {'status':
-000199b0: 2027 756e 6b6e 6f77 6e27 2c20 276d 6573   'unknown', 'mes
-000199c0: 7361 6765 273a 2027 277d 290a 0a20 2020  sage': ''})..   
-000199d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000199e0: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-000199f0: 2020 2062 6163 6b65 6e64 2e73 7461 7475     backend.statu
-00019a00: 735f 6765 7428 6973 5f61 7070 3d54 7275  s_get(is_app=Tru
-00019a10: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00019a20: 7b27 7374 6174 7573 273a 2027 756e 6b6e  {'status': 'unkn
-00019a30: 6f77 6e27 2c20 276d 6573 7361 6765 273a  own', 'message':
-00019a40: 2027 277d 290a 0a20 2020 2064 6566 2074   ''})..    def t
-00019a50: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
-00019a60: 6e69 7469 616c 5f68 6f6f 6b73 5f69 6e73  nitial_hooks_ins
-00019a70: 7461 6c6c 5f73 6574 735f 7374 6174 7573  tall_sets_status
-00019a80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00019a90: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-00019aa0: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
-00019ab0: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
-00019ac0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00019ad0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00019ae0: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
-00019af0: 272c 2063 6f6e 6669 673d 2727 270a 2020  ', config='''.  
-00019b00: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
-00019b10: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00019b20: 2020 2073 6574 5f73 7461 7475 733a 0a20     set_status:. 
-00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b40: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-00019b50: 6120 636f 6e66 6967 206f 7074 696f 6e0a  a config option.
-00019b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b70: 2020 2020 7479 7065 3a20 626f 6f6c 6561      type: boolea
-00019b80: 6e0a 0a20 2020 2020 2020 2020 2020 2027  n..            '
-00019b90: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-00019ba0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-00019bb0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-00019bc0: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
-00019bd0: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
-00019be0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00019bf0: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
-00019c00: 795f 7661 6c75 6573 3d7b 2273 6574 5f73  y_values={"set_s
-00019c10: 7461 7475 7322 3a20 5472 7565 7d29 0a20  tatus": True}). 
-00019c20: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00019c30: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
-00019c40: 6c5f 686f 6f6b 7328 290a 0a20 2020 2020  l_hooks()..     
-00019c50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00019c60: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-00019c70: 2062 6163 6b65 6e64 2e73 7461 7475 735f   backend.status_
-00019c80: 6765 7428 6973 5f61 7070 3d46 616c 7365  get(is_app=False
-00019c90: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
-00019ca0: 2773 7461 7475 7327 3a20 276d 6169 6e74  'status': 'maint
-00019cb0: 656e 616e 6365 272c 2027 6d65 7373 6167  enance', 'messag
-00019cc0: 6527 3a20 2753 7461 7475 7320 7365 7420  e': 'Status set 
-00019cd0: 6f6e 2069 6e73 7461 6c6c 277d 290a 0a20  on install'}).. 
-00019ce0: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-00019cf0: 7065 6262 6c65 5f63 6f6e 7461 696e 6572  pebble_container
-00019d00: 5f70 6c61 6e28 7365 6c66 293a 0a20 2020  _plan(self):.   
-00019d10: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-00019d20: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-00019d30: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
-00019d40: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-00019d50: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-00019d60: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-00019d70: 2020 636f 6e74 6169 6e65 7273 3a0a 2020    containers:.  
-00019d80: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-00019d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019da0: 2072 6573 6f75 7263 653a 2066 6f6f 2d69   resource: foo-i
-00019db0: 6d61 6765 0a20 2020 2020 2020 2020 2020  mage.           
-00019dc0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00019dd0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00019de0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00019df0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00019e00: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
-00019e10: 6172 6e65 7373 2e73 6574 5f63 616e 5f63  arness.set_can_c
-00019e20: 6f6e 6e65 6374 2827 666f 6f27 2c20 5472  onnect('foo', Tr
-00019e30: 7565 290a 2020 2020 2020 2020 696e 6974  ue).        init
-00019e40: 6961 6c5f 706c 616e 203d 2068 6172 6e65  ial_plan = harne
-00019e50: 7373 2e67 6574 5f63 6f6e 7461 696e 6572  ss.get_container
-00019e60: 5f70 6562 626c 655f 706c 616e 2827 666f  _pebble_plan('fo
-00019e70: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
-00019e80: 2e61 7373 6572 7445 7175 616c 2869 6e69  .assertEqual(ini
-00019e90: 7469 616c 5f70 6c61 6e2e 746f 5f79 616d  tial_plan.to_yam
-00019ea0: 6c28 292c 2027 7b7d 5c6e 2729 0a20 2020  l(), '{}\n').   
-00019eb0: 2020 2020 2063 6f6e 7461 696e 6572 203d       container =
-00019ec0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e75   harness.model.u
-00019ed0: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
-00019ee0: 7228 2766 6f6f 2729 0a20 2020 2020 2020  r('foo').       
-00019ef0: 2063 6f6e 7461 696e 6572 2e70 6562 626c   container.pebbl
-00019f00: 652e 6164 645f 6c61 7965 7228 2774 6573  e.add_layer('tes
-00019f10: 742d 6162 272c 2027 2727 5c0a 2020 2020  t-ab', '''\.    
-00019f20: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-00019f30: 2074 6573 742d 6c61 7965 720a 2020 2020   test-layer.    
-00019f40: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-00019f50: 696f 6e3a 2061 206c 6179 6572 2074 6861  ion: a layer tha
-00019f60: 7420 7765 2063 616e 2075 7365 2066 6f72  t we can use for
-00019f70: 2074 6573 7469 6e67 0a20 2020 2020 2020   testing.       
-00019f80: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-00019f90: 2020 2020 2020 2020 2020 2020 2061 3a0a               a:.
-00019fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fb0: 636f 6d6d 616e 643a 202f 6269 6e2f 6563  command: /bin/ec
-00019fc0: 686f 2068 656c 6c6f 2066 726f 6d20 610a  ho hello from a.
-00019fd0: 2020 2020 2020 2020 2020 2020 2020 623a                b:
-00019fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ff0: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
-0001a000: 6368 6f20 6865 6c6c 6f20 6672 6f6d 2062  cho hello from b
-0001a010: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0001a020: 290a 2020 2020 2020 2020 636f 6e74 6169  ).        contai
-0001a030: 6e65 722e 7065 6262 6c65 2e61 6464 5f6c  ner.pebble.add_l
-0001a040: 6179 6572 2827 7465 7374 2d63 272c 2027  ayer('test-c', '
-0001a050: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
-0001a060: 7375 6d6d 6172 793a 2074 6573 742d 666f  summary: test-fo
-0001a070: 722d 630a 2020 2020 2020 2020 2020 2020  r-c.            
-0001a080: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
-0001a090: 2020 2020 2020 2020 633a 0a20 2020 2020          c:.     
-0001a0a0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-0001a0b0: 6e64 3a20 2f62 696e 2f65 6368 6f20 6865  nd: /bin/echo he
-0001a0c0: 6c6c 6f20 6672 6f6d 2063 0a20 2020 2020  llo from c.     
-0001a0d0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0001a0e0: 2020 2020 706c 616e 203d 2063 6f6e 7461      plan = conta
-0001a0f0: 696e 6572 2e70 6562 626c 652e 6765 745f  iner.pebble.get_
-0001a100: 706c 616e 2829 0a20 2020 2020 2020 2073  plan().        s
-0001a110: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a120: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
-0001a130: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
-0001a140: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
-0001a150: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
-0001a160: 2020 2020 2020 2020 2061 3a0a 2020 2020           a:.    
-0001a170: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-0001a180: 616e 643a 202f 6269 6e2f 6563 686f 2068  and: /bin/echo h
-0001a190: 656c 6c6f 2066 726f 6d20 610a 2020 2020  ello from a.    
-0001a1a0: 2020 2020 2020 2020 2020 623a 0a20 2020            b:.   
-0001a1b0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0001a1c0: 6d61 6e64 3a20 2f62 696e 2f65 6368 6f20  mand: /bin/echo 
-0001a1d0: 6865 6c6c 6f20 6672 6f6d 2062 0a20 2020  hello from b.   
-0001a1e0: 2020 2020 2020 2020 2020 2063 3a0a 2020             c:.  
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001a200: 6d6d 616e 643a 202f 6269 6e2f 6563 686f  mmand: /bin/echo
-0001a210: 2068 656c 6c6f 2066 726f 6d20 630a 2020   hello from c.  
-0001a220: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
-0001a230: 2020 2020 2020 2020 6861 726e 6573 735f          harness_
-0001a240: 706c 616e 203d 2068 6172 6e65 7373 2e67  plan = harness.g
-0001a250: 6574 5f63 6f6e 7461 696e 6572 5f70 6562  et_container_peb
-0001a260: 626c 655f 706c 616e 2827 666f 6f27 290a  ble_plan('foo').
-0001a270: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001a280: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-0001a290: 5f70 6c61 6e2e 746f 5f79 616d 6c28 292c  _plan.to_yaml(),
-0001a2a0: 2070 6c61 6e2e 746f 5f79 616d 6c28 2929   plan.to_yaml())
-0001a2b0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0001a2c0: 6574 5f70 6562 626c 655f 636f 6e74 6169  et_pebble_contai
-0001a2d0: 6e65 725f 706c 616e 5f75 6e6b 6e6f 776e  ner_plan_unknown
-0001a2e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001a2f0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0001a300: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0001a310: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0001a320: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0001a330: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0001a340: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0001a350: 7461 696e 6572 733a 0a20 2020 2020 2020  tainers:.       
-0001a360: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-0001a370: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001a380: 7572 6365 3a20 666f 6f2d 696d 6167 650a  urce: foo-image.
-0001a390: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-0001a3a0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001a3b0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0001a3c0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-0001a3d0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-0001a3e0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0001a3f0: 732e 7365 745f 6361 6e5f 636f 6e6e 6563  s.set_can_connec
-0001a400: 7428 2766 6f6f 272c 2054 7275 6529 0a20  t('foo', True). 
-0001a410: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0001a420: 2e61 7373 6572 7452 6169 7365 7328 4b65  .assertRaises(Ke
-0001a430: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
-0001a440: 2020 2020 2068 6172 6e65 7373 2e67 6574       harness.get
-0001a450: 5f63 6f6e 7461 696e 6572 5f70 6562 626c  _container_pebbl
-0001a460: 655f 706c 616e 2827 756e 6b6e 6f77 6e27  e_plan('unknown'
-0001a470: 290a 2020 2020 2020 2020 706c 616e 203d  ).        plan =
-0001a480: 2068 6172 6e65 7373 2e67 6574 5f63 6f6e   harness.get_con
-0001a490: 7461 696e 6572 5f70 6562 626c 655f 706c  tainer_pebble_pl
-0001a4a0: 616e 2827 666f 6f27 290a 2020 2020 2020  an('foo').      
-0001a4b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a4c0: 616c 2870 6c61 6e2e 746f 5f79 616d 6c28  al(plan.to_yaml(
-0001a4d0: 292c 2022 7b7d 5c6e 2229 0a0a 2020 2020  ), "{}\n")..    
-0001a4e0: 6465 6620 7465 7374 5f63 6f6e 7461 696e  def test_contain
-0001a4f0: 6572 5f70 6562 626c 655f 7265 6164 7928  er_pebble_ready(
-0001a500: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0001a510: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-0001a520: 7469 6e67 2e48 6172 6e65 7373 2843 6f6e  ting.Harness(Con
-0001a530: 7461 696e 6572 4576 656e 7443 6861 726d  tainerEventCharm
-0001a540: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0001a550: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0001a560: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-0001a570: 2020 636f 6e74 6169 6e65 7273 3a0a 2020    containers:.  
-0001a580: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-0001a590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a5a0: 2072 6573 6f75 7263 653a 2066 6f6f 2d69   resource: foo-i
-0001a5b0: 6d61 6765 0a20 2020 2020 2020 2027 2727  mage.        '''
-0001a5c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001a5d0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0001a5e0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-0001a5f0: 2020 2023 2054 6869 7320 6973 2061 206e     # This is a n
-0001a600: 6f2d 6f70 2069 6620 6974 2069 7320 6361  o-op if it is ca
-0001a610: 6c6c 6564 2062 6566 6f72 6520 6265 6769  lled before begi
-0001a620: 6e28 292c 2062 7574 2069 7420 6973 6e27  n(), but it isn'
-0001a630: 7420 616e 2065 7272 6f72 0a20 2020 2020  t an error.     
-0001a640: 2020 2068 6172 6e65 7373 2e63 6f6e 7461     harness.conta
-0001a650: 696e 6572 5f70 6562 626c 655f 7265 6164  iner_pebble_read
-0001a660: 7928 2766 6f6f 2729 0a20 2020 2020 2020  y('foo').       
-0001a670: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
-0001a680: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0001a690: 2e63 6861 726d 2e6f 6273 6572 7665 5f63  .charm.observe_c
-0001a6a0: 6f6e 7461 696e 6572 5f65 7665 6e74 7328  ontainer_events(
-0001a6b0: 2766 6f6f 2729 0a20 2020 2020 2020 2068  'foo').        h
-0001a6c0: 6172 6e65 7373 2e63 6f6e 7461 696e 6572  arness.container
-0001a6d0: 5f70 6562 626c 655f 7265 6164 7928 2766  _pebble_ready('f
-0001a6e0: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
-0001a6f0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-0001a700: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-0001a710: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
-0001a720: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
-0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a740: 7b27 6e61 6d65 273a 2027 7065 6262 6c65  {'name': 'pebble
-0001a750: 2d72 6561 6479 272c 0a20 2020 2020 2020  -ready',.       
-0001a760: 2020 2020 2020 2020 2020 2763 6f6e 7461            'conta
-0001a770: 696e 6572 273a 2027 666f 6f27 2c0a 2020  iner': 'foo',.  
-0001a780: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0001a790: 2c0a 2020 2020 2020 2020 2020 2020 5d0a  ,.            ].
-0001a7a0: 2020 2020 2020 2020 290a 0a0a 636c 6173          )...clas
-0001a7b0: 7320 5465 7374 4e65 7477 6f72 6b28 756e  s TestNetwork(un
-0001a7c0: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
-0001a7d0: 3a0a 2020 2020 6465 6620 7365 7455 7028  :.    def setUp(
-0001a7e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0001a7f0: 656c 662e 6861 726e 6573 7320 3d20 6f70  elf.harness = op
-0001a800: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0001a810: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0001a820: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0001a830: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0001a840: 2d63 6861 726d 0a20 2020 2020 2020 2020  -charm.         
-0001a850: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-0001a860: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-0001a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a880: 2069 6e74 6572 6661 6365 3a20 6461 7461   interface: data
-0001a890: 6261 7365 0a20 2020 2020 2020 2020 2020  base.           
-0001a8a0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-0001a8b0: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-0001a8c0: 6163 653a 2078 797a 0a20 2020 2020 2020  ace: xyz.       
-0001a8d0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0001a8e0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0001a8f0: 7028 7365 6c66 2e68 6172 6e65 7373 2e63  p(self.harness.c
-0001a900: 6c65 616e 7570 290a 0a20 2020 2064 6566  leanup)..    def
-0001a910: 2074 6573 745f 6164 645f 6e65 7477 6f72   test_add_networ
-0001a920: 6b5f 6465 6661 756c 7473 2873 656c 6629  k_defaults(self)
-0001a930: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-0001a940: 6172 6e65 7373 2e61 6464 5f6e 6574 776f  arness.add_netwo
-0001a950: 726b 2827 3130 2e30 2e30 2e31 3027 290a  rk('10.0.0.10').
-0001a960: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
-0001a970: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-0001a980: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-0001a990: 6728 2764 6227 290a 2020 2020 2020 2020  g('db').        
-0001a9a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001a9b0: 2862 696e 6469 6e67 2e6e 616d 652c 2027  (binding.name, '
-0001a9c0: 6462 2729 0a20 2020 2020 2020 206e 6574  db').        net
-0001a9d0: 776f 726b 203d 2062 696e 6469 6e67 2e6e  work = binding.n
-0001a9e0: 6574 776f 726b 0a20 2020 2020 2020 2073  etwork.        s
-0001a9f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001aa00: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
-0001aa10: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
-0001aa20: 4950 7634 4164 6472 6573 7328 2731 302e  IPv4Address('10.
-0001aa30: 302e 302e 3130 2729 290a 2020 2020 2020  0.0.10')).      
-0001aa40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001aa50: 616c 286e 6574 776f 726b 2e69 6e67 7265  al(network.ingre
-0001aa60: 7373 5f61 6464 7265 7373 2c20 6970 6164  ss_address, ipad
-0001aa70: 6472 6573 732e 4950 7634 4164 6472 6573  dress.IPv4Addres
-0001aa80: 7328 2731 302e 302e 302e 3130 2729 290a  s('10.0.0.10')).
-0001aa90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001aaa0: 6572 7445 7175 616c 286e 6574 776f 726b  ertEqual(network
-0001aab0: 2e69 6e67 7265 7373 5f61 6464 7265 7373  .ingress_address
-0001aac0: 6573 2c20 5b69 7061 6464 7265 7373 2e49  es, [ipaddress.I
-0001aad0: 5076 3441 6464 7265 7373 2827 3130 2e30  Pv4Address('10.0
-0001aae0: 2e30 2e31 3027 295d 290a 2020 2020 2020  .0.10')]).      
-0001aaf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001ab00: 616c 286e 6574 776f 726b 2e65 6772 6573  al(network.egres
-0001ab10: 735f 7375 626e 6574 732c 205b 6970 6164  s_subnets, [ipad
-0001ab20: 6472 6573 732e 4950 7634 4e65 7477 6f72  dress.IPv4Networ
-0001ab30: 6b28 2731 302e 302e 302e 302f 3234 2729  k('10.0.0.0/24')
-0001ab40: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-0001ab50: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-0001ab60: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-0001ab70: 6573 292c 2031 290a 2020 2020 2020 2020  es), 1).        
-0001ab80: 696e 7465 7266 6163 6520 3d20 6e65 7477  interface = netw
-0001ab90: 6f72 6b2e 696e 7465 7266 6163 6573 5b30  ork.interfaces[0
-0001aba0: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-0001abb0: 7373 6572 7445 7175 616c 2869 6e74 6572  ssertEqual(inter
-0001abc0: 6661 6365 2e6e 616d 652c 2027 6574 6830  face.name, 'eth0
-0001abd0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001abe0: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
-0001abf0: 7266 6163 652e 6164 6472 6573 732c 2069  rface.address, i
-0001ac00: 7061 6464 7265 7373 2e49 5076 3441 6464  paddress.IPv4Add
-0001ac10: 7265 7373 2827 3130 2e30 2e30 2e31 3027  ress('10.0.0.10'
-0001ac20: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0001ac30: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
-0001ac40: 7266 6163 652e 7375 626e 6574 2c20 6970  rface.subnet, ip
-0001ac50: 6164 6472 6573 732e 4950 7634 4e65 7477  address.IPv4Netw
-0001ac60: 6f72 6b28 2731 302e 302e 302e 302f 3234  ork('10.0.0.0/24
-0001ac70: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
-0001ac80: 745f 6164 645f 6e65 7477 6f72 6b5f 616c  t_add_network_al
-0001ac90: 6c5f 6172 6773 2873 656c 6629 3a0a 2020  l_args(self):.  
-0001aca0: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
-0001acb0: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
-0001acc0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-0001acd0: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-0001ace0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-0001acf0: 6172 6e65 7373 2e61 6464 5f6e 6574 776f  arness.add_netwo
-0001ad00: 726b 2827 3130 2e30 2e30 2e31 3027 2c0a  rk('10.0.0.10',.
-0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad30: 2065 6e64 706f 696e 743d 2764 6227 2c0a   endpoint='db',.
-0001ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad60: 2072 656c 6174 696f 6e5f 6964 3d72 656c   relation_id=rel
-0001ad70: 6174 696f 6e5f 6964 2c0a 2020 2020 2020  ation_id,.      
-0001ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad90: 2020 2020 2020 2020 2020 2063 6964 723d             cidr=
-0001ada0: 2731 302e 302e 302e 302f 3827 2c0a 2020  '10.0.0.0/8',.  
-0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001add0: 6e74 6572 6661 6365 3d27 6574 6831 272c  nterface='eth1',
-0001ade0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae00: 2020 696e 6772 6573 735f 6164 6472 6573    ingress_addres
-0001ae10: 7365 733d 5b27 3130 2e30 2e30 2e31 272c  ses=['10.0.0.1',
-0001ae20: 2027 3130 2e30 2e30 2e32 275d 2c0a 2020   '10.0.0.2'],.  
-0001ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001ae50: 6772 6573 735f 7375 626e 6574 733d 5b27  gress_subnets=['
-0001ae60: 3130 2e30 2e30 2e30 2f38 272c 2027 3130  10.0.0.0/8', '10
-0001ae70: 2e31 302e 302e 302f 3136 275d 290a 0a20  .10.0.0/16']).. 
-0001ae80: 2020 2020 2020 2072 656c 6174 696f 6e20         relation 
-0001ae90: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
-0001aea0: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-0001aeb0: 6e28 2764 6227 2c20 7265 6c61 7469 6f6e  n('db', relation
-0001aec0: 5f69 6429 0a20 2020 2020 2020 2062 696e  _id).        bin
-0001aed0: 6469 6e67 203d 2073 656c 662e 6861 726e  ding = self.harn
-0001aee0: 6573 732e 6d6f 6465 6c2e 6765 745f 6269  ess.model.get_bi
-0001aef0: 6e64 696e 6728 7265 6c61 7469 6f6e 290a  nding(relation).
-0001af00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001af10: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-0001af20: 2e6e 616d 652c 2027 6462 2729 0a20 2020  .name, 'db').   
-0001af30: 2020 2020 206e 6574 776f 726b 203d 2062       network = b
-0001af40: 696e 6469 6e67 2e6e 6574 776f 726b 0a20  inding.network. 
-0001af50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001af60: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
-0001af70: 6269 6e64 5f61 6464 7265 7373 2c20 6970  bind_address, ip
-0001af80: 6164 6472 6573 732e 4950 7634 4164 6472  address.IPv4Addr
-0001af90: 6573 7328 2731 302e 302e 302e 3130 2729  ess('10.0.0.10')
-0001afa0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001afb0: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
-0001afc0: 726b 2e69 6e67 7265 7373 5f61 6464 7265  rk.ingress_addre
-0001afd0: 7373 2c20 6970 6164 6472 6573 732e 4950  ss, ipaddress.IP
-0001afe0: 7634 4164 6472 6573 7328 2731 302e 302e  v4Address('10.0.
-0001aff0: 302e 3127 2929 0a20 2020 2020 2020 2073  0.1')).        s
-0001b000: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001b010: 6e65 7477 6f72 6b2e 696e 6772 6573 735f  network.ingress_
-0001b020: 6164 6472 6573 7365 732c 0a20 2020 2020  addresses,.     
-0001b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b040: 2020 2020 5b69 7061 6464 7265 7373 2e49      [ipaddress.I
-0001b050: 5076 3441 6464 7265 7373 2827 3130 2e30  Pv4Address('10.0
-0001b060: 2e30 2e31 2729 2c20 6970 6164 6472 6573  .0.1'), ipaddres
-0001b070: 732e 4950 7634 4164 6472 6573 7328 2731  s.IPv4Address('1
-0001b080: 302e 302e 302e 3227 295d 290a 2020 2020  0.0.0.2')]).    
-0001b090: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b0a0: 7175 616c 286e 6574 776f 726b 2e65 6772  qual(network.egr
-0001b0b0: 6573 735f 7375 626e 6574 732c 0a20 2020  ess_subnets,.   
-0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0d0: 2020 2020 2020 5b69 7061 6464 7265 7373        [ipaddress
-0001b0e0: 2e49 5076 344e 6574 776f 726b 2827 3130  .IPv4Network('10
-0001b0f0: 2e30 2e30 2e30 2f38 2729 2c0a 2020 2020  .0.0.0/8'),.    
-0001b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b110: 2020 2020 2020 6970 6164 6472 6573 732e        ipaddress.
-0001b120: 4950 7634 4e65 7477 6f72 6b28 2731 302e  IPv4Network('10.
-0001b130: 3130 2e30 2e30 2f31 3627 295d 290a 2020  10.0.0/16')]).  
-0001b140: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b150: 7445 7175 616c 286c 656e 286e 6574 776f  tEqual(len(netwo
-0001b160: 726b 2e69 6e74 6572 6661 6365 7329 2c20  rk.interfaces), 
-0001b170: 3129 0a20 2020 2020 2020 2069 6e74 6572  1).        inter
-0001b180: 6661 6365 203d 206e 6574 776f 726b 2e69  face = network.i
-0001b190: 6e74 6572 6661 6365 735b 305d 0a20 2020  nterfaces[0].   
-0001b1a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001b1b0: 4571 7561 6c28 696e 7465 7266 6163 652e  Equal(interface.
-0001b1c0: 6e61 6d65 2c20 2765 7468 3127 290a 2020  name, 'eth1').  
-0001b1d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b1e0: 7445 7175 616c 2869 6e74 6572 6661 6365  tEqual(interface
-0001b1f0: 2e61 6464 7265 7373 2c20 6970 6164 6472  .address, ipaddr
-0001b200: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
-0001b210: 2731 302e 302e 302e 3130 2729 290a 2020  '10.0.0.10')).  
-0001b220: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b230: 7445 7175 616c 2869 6e74 6572 6661 6365  tEqual(interface
-0001b240: 2e73 7562 6e65 742c 2069 7061 6464 7265  .subnet, ipaddre
-0001b250: 7373 2e49 5076 344e 6574 776f 726b 2827  ss.IPv4Network('
-0001b260: 3130 2e30 2e30 2e30 2f38 2729 290a 0a20  10.0.0.0/8')).. 
-0001b270: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-0001b280: 6e65 7477 6f72 6b5f 7370 6563 6966 6963  network_specific
-0001b290: 5f65 6e64 706f 696e 7428 7365 6c66 293a  _endpoint(self):
-0001b2a0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-0001b2b0: 726e 6573 732e 6164 645f 6e65 7477 6f72  rness.add_networ
-0001b2c0: 6b28 2731 302e 302e 302e 3127 290a 2020  k('10.0.0.1').  
-0001b2d0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0001b2e0: 7373 2e61 6464 5f6e 6574 776f 726b 2827  ss.add_network('
-0001b2f0: 3130 2e30 2e32 2e31 272c 2065 6e64 706f  10.0.2.1', endpo
-0001b300: 696e 743d 2764 6227 290a 0a20 2020 2020  int='db')..     
-0001b310: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
-0001b320: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
-0001b330: 6765 745f 6269 6e64 696e 6728 2764 6227  get_binding('db'
-0001b340: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001b350: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-0001b360: 6e67 2e6e 616d 652c 2027 6462 2729 0a20  ng.name, 'db'). 
-0001b370: 2020 2020 2020 206e 6574 776f 726b 203d         network =
-0001b380: 2062 696e 6469 6e67 2e6e 6574 776f 726b   binding.network
-0001b390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001b3a0: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
-0001b3b0: 6b2e 6269 6e64 5f61 6464 7265 7373 2c20  k.bind_address, 
-0001b3c0: 6970 6164 6472 6573 732e 4950 7634 4164  ipaddress.IPv4Ad
-0001b3d0: 6472 6573 7328 2731 302e 302e 322e 3127  dress('10.0.2.1'
-0001b3e0: 2929 0a0a 2020 2020 2020 2020 2320 456e  ))..        # En
-0001b3f0: 7375 7265 2062 696e 6469 6e67 2066 6f72  sure binding for
-0001b400: 2074 6865 206f 7468 6572 2069 6e74 6572   the other inter
-0001b410: 6661 6365 2069 7320 7374 696c 6c20 6f6e  face is still on
-0001b420: 2074 6865 2064 6566 6175 6c74 2076 616c   the default val
-0001b430: 7565 0a20 2020 2020 2020 2073 656c 662e  ue.        self.
-0001b440: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0001b450: 2e68 6172 6e65 7373 2e6d 6f64 656c 2e67  .harness.model.g
-0001b460: 6574 5f62 696e 6469 6e67 2827 666f 6f27  et_binding('foo'
-0001b470: 292e 6e65 7477 6f72 6b2e 6269 6e64 5f61  ).network.bind_a
-0001b480: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-0001b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4a0: 2069 7061 6464 7265 7373 2e49 5076 3441   ipaddress.IPv4A
-0001b4b0: 6464 7265 7373 2827 3130 2e30 2e30 2e31  ddress('10.0.0.1
-0001b4c0: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
-0001b4d0: 745f 6164 645f 6e65 7477 6f72 6b5f 7370  t_add_network_sp
-0001b4e0: 6563 6966 6963 5f72 656c 6174 696f 6e28  ecific_relation(
-0001b4f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0001b500: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-0001b510: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
-0001b520: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-0001b530: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
-0001b540: 776f 726b 2827 3130 2e30 2e32 2e31 272c  work('10.0.2.1',
-0001b550: 2065 6e64 706f 696e 743d 2764 6227 290a   endpoint='db').
-0001b560: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-0001b570: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
-0001b580: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-0001b590: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
-0001b5a0: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-0001b5b0: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
-0001b5c0: 776f 726b 2827 3335 2e30 2e30 2e31 272c  work('35.0.0.1',
-0001b5d0: 2065 6e64 706f 696e 743d 2764 6227 2c20   endpoint='db', 
-0001b5e0: 7265 6c61 7469 6f6e 5f69 643d 7265 6c61  relation_id=rela
-0001b5f0: 7469 6f6e 5f69 6429 0a0a 2020 2020 2020  tion_id)..      
-0001b600: 2020 7265 6c61 7469 6f6e 203d 2073 656c    relation = sel
-0001b610: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
-0001b620: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-0001b630: 272c 2072 656c 6174 696f 6e5f 6964 290a  ', relation_id).
-0001b640: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
-0001b650: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
-0001b660: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
-0001b670: 2872 656c 6174 696f 6e29 0a20 2020 2020  (relation).     
-0001b680: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001b690: 7561 6c28 6269 6e64 696e 672e 6e61 6d65  ual(binding.name
-0001b6a0: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
-0001b6b0: 6e65 7477 6f72 6b20 3d20 6269 6e64 696e  network = bindin
-0001b6c0: 672e 6e65 7477 6f72 6b0a 2020 2020 2020  g.network.      
-0001b6d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001b6e0: 616c 286e 6574 776f 726b 2e62 696e 645f  al(network.bind_
-0001b6f0: 6164 6472 6573 732c 2069 7061 6464 7265  address, ipaddre
-0001b700: 7373 2e49 5076 3441 6464 7265 7373 2827  ss.IPv4Address('
-0001b710: 3335 2e30 2e30 2e31 2729 290a 0a20 2020  35.0.0.1'))..   
-0001b720: 2020 2020 2023 2045 6e73 7572 6520 6269       # Ensure bi
-0001b730: 6e64 696e 6720 666f 7220 7468 6520 6f74  nding for the ot
-0001b740: 6865 7220 696e 7465 7266 6163 6520 6973  her interface is
-0001b750: 2073 7469 6c6c 206f 6e20 7468 6520 6465   still on the de
-0001b760: 6661 756c 7420 7661 6c75 650a 2020 2020  fault value.    
-0001b770: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b780: 7175 616c 2873 656c 662e 6861 726e 6573  qual(self.harnes
-0001b790: 732e 6d6f 6465 6c2e 6765 745f 6269 6e64  s.model.get_bind
-0001b7a0: 696e 6728 2766 6f6f 2729 2e6e 6574 776f  ing('foo').netwo
-0001b7b0: 726b 2e62 696e 645f 6164 6472 6573 732c  rk.bind_address,
-0001b7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b7d0: 2020 2020 2020 2020 2020 6970 6164 6472            ipaddr
-0001b7e0: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
-0001b7f0: 2731 302e 302e 302e 3127 2929 0a0a 2020  '10.0.0.1'))..  
-0001b800: 2020 6465 6620 7465 7374 5f61 6464 5f6e    def test_add_n
-0001b810: 6574 776f 726b 5f65 6e64 706f 696e 745f  etwork_endpoint_
-0001b820: 6661 6c6c 6261 636b 2873 656c 6629 3a0a  fallback(self):.
-0001b830: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-0001b840: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
-0001b850: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-0001b860: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
-0001b870: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-0001b880: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
-0001b890: 776f 726b 2827 3130 2e30 2e30 2e31 3027  work('10.0.0.10'
-0001b8a0: 2c20 656e 6470 6f69 6e74 3d27 6462 2729  , endpoint='db')
-0001b8b0: 0a0a 2020 2020 2020 2020 7265 6c61 7469  ..        relati
-0001b8c0: 6f6e 203d 2073 656c 662e 6861 726e 6573  on = self.harnes
-0001b8d0: 732e 6d6f 6465 6c2e 6765 745f 7265 6c61  s.model.get_rela
-0001b8e0: 7469 6f6e 2827 6462 272c 2072 656c 6174  tion('db', relat
-0001b8f0: 696f 6e5f 6964 290a 2020 2020 2020 2020  ion_id).        
-0001b900: 6269 6e64 696e 6720 3d20 7365 6c66 2e68  binding = self.h
-0001b910: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
-0001b920: 5f62 696e 6469 6e67 2872 656c 6174 696f  _binding(relatio
-0001b930: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
-0001b940: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
-0001b950: 696e 672e 6e61 6d65 2c20 2764 6227 290a  ing.name, 'db').
-0001b960: 2020 2020 2020 2020 6e65 7477 6f72 6b20          network 
-0001b970: 3d20 6269 6e64 696e 672e 6e65 7477 6f72  = binding.networ
-0001b980: 6b0a 2020 2020 2020 2020 7365 6c66 2e61  k.        self.a
-0001b990: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
-0001b9a0: 726b 2e62 696e 645f 6164 6472 6573 732c  rk.bind_address,
-0001b9b0: 2069 7061 6464 7265 7373 2e49 5076 3441   ipaddress.IPv4A
-0001b9c0: 6464 7265 7373 2827 3130 2e30 2e30 2e31  ddress('10.0.0.1
-0001b9d0: 3027 2929 0a0a 2020 2020 6465 6620 7465  0'))..    def te
-0001b9e0: 7374 5f61 6464 5f6e 6574 776f 726b 5f64  st_add_network_d
-0001b9f0: 6566 6175 6c74 5f66 616c 6c62 6163 6b28  efault_fallback(
-0001ba00: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0001ba10: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-0001ba20: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
-0001ba30: 3130 2729 0a0a 2020 2020 2020 2020 6269  10')..        bi
-0001ba40: 6e64 696e 6720 3d20 7365 6c66 2e68 6172  nding = self.har
-0001ba50: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f62  ness.model.get_b
-0001ba60: 696e 6469 6e67 2827 6462 2729 0a20 2020  inding('db').   
-0001ba70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001ba80: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
-0001ba90: 6d65 2c20 2764 6227 290a 2020 2020 2020  me, 'db').      
-0001baa0: 2020 6e65 7477 6f72 6b20 3d20 6269 6e64    network = bind
-0001bab0: 696e 672e 6e65 7477 6f72 6b0a 2020 2020  ing.network.    
-0001bac0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001bad0: 7175 616c 286e 6574 776f 726b 2e62 696e  qual(network.bin
-0001bae0: 645f 6164 6472 6573 732c 2069 7061 6464  d_address, ipadd
-0001baf0: 7265 7373 2e49 5076 3441 6464 7265 7373  ress.IPv4Address
-0001bb00: 2827 3130 2e30 2e30 2e31 3027 2929 0a0a  ('10.0.0.10'))..
-0001bb10: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
-0001bb20: 5f6e 6574 776f 726b 5f69 7076 3628 7365  _network_ipv6(se
-0001bb30: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0001bb40: 662e 6861 726e 6573 732e 6164 645f 6e65  f.harness.add_ne
-0001bb50: 7477 6f72 6b28 2732 3030 313a 3064 6238  twork('2001:0db8
-0001bb60: 3a3a 613a 303a 303a 3127 290a 0a20 2020  ::a:0:0:1')..   
-0001bb70: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
-0001bb80: 656c 662e 6861 726e 6573 732e 6d6f 6465  elf.harness.mode
-0001bb90: 6c2e 6765 745f 6269 6e64 696e 6728 2764  l.get_binding('d
-0001bba0: 6227 290a 2020 2020 2020 2020 7365 6c66  b').        self
-0001bbb0: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
-0001bbc0: 6469 6e67 2e6e 616d 652c 2027 6462 2729  ding.name, 'db')
-0001bbd0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-0001bbe0: 203d 2062 696e 6469 6e67 2e6e 6574 776f   = binding.netwo
-0001bbf0: 726b 0a20 2020 2020 2020 2073 656c 662e  rk.        self.
-0001bc00: 6173 7365 7274 4571 7561 6c28 6e65 7477  assertEqual(netw
-0001bc10: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
-0001bc20: 2c20 6970 6164 6472 6573 732e 4950 7636  , ipaddress.IPv6
-0001bc30: 4164 6472 6573 7328 2732 3030 313a 3064  Address('2001:0d
-0001bc40: 6238 3a3a 613a 303a 303a 3127 2929 0a20  b8::a:0:0:1')). 
-0001bc50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001bc60: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
-0001bc70: 696e 6772 6573 735f 6164 6472 6573 732c  ingress_address,
-0001bc80: 2069 7061 6464 7265 7373 2e49 5076 3641   ipaddress.IPv6A
-0001bc90: 6464 7265 7373 2827 3230 3031 3a30 6462  ddress('2001:0db
-0001bca0: 383a 3a61 3a30 3a30 3a31 2729 290a 2020  8::a:0:0:1')).  
-0001bcb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001bcc0: 7445 7175 616c 286e 6574 776f 726b 2e69  tEqual(network.i
-0001bcd0: 6e67 7265 7373 5f61 6464 7265 7373 6573  ngress_addresses
-0001bce0: 2c20 5b69 7061 6464 7265 7373 2e49 5076  , [ipaddress.IPv
-0001bcf0: 3641 6464 7265 7373 2827 3230 3031 3a30  6Address('2001:0
-0001bd00: 6462 383a 3a61 3a30 3a30 3a31 2729 5d29  db8::a:0:0:1')])
-0001bd10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001bd20: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
-0001bd30: 6b2e 6567 7265 7373 5f73 7562 6e65 7473  k.egress_subnets
-0001bd40: 2c20 5b69 7061 6464 7265 7373 2e49 5076  , [ipaddress.IPv
-0001bd50: 364e 6574 776f 726b 2827 3230 3031 3a30  6Network('2001:0
-0001bd60: 6462 383a 3a30 3a30 3a30 3a30 2f36 3427  db8::0:0:0:0/64'
-0001bd70: 295d 290a 2020 2020 2020 2020 7365 6c66  )]).        self
-0001bd80: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-0001bd90: 286e 6574 776f 726b 2e69 6e74 6572 6661  (network.interfa
-0001bda0: 6365 7329 2c20 3129 0a20 2020 2020 2020  ces), 1).       
-0001bdb0: 2069 6e74 6572 6661 6365 203d 206e 6574   interface = net
-0001bdc0: 776f 726b 2e69 6e74 6572 6661 6365 735b  work.interfaces[
-0001bdd0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-0001bde0: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
-0001bdf0: 7266 6163 652e 6e61 6d65 2c20 2765 7468  rface.name, 'eth
-0001be00: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
-0001be10: 2e61 7373 6572 7445 7175 616c 2869 6e74  .assertEqual(int
-0001be20: 6572 6661 6365 2e61 6464 7265 7373 2c20  erface.address, 
-0001be30: 6970 6164 6472 6573 732e 4950 7636 4164  ipaddress.IPv6Ad
-0001be40: 6472 6573 7328 2732 3030 313a 3064 6238  dress('2001:0db8
-0001be50: 3a3a 613a 303a 303a 3127 2929 0a20 2020  ::a:0:0:1')).   
-0001be60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001be70: 4571 7561 6c28 696e 7465 7266 6163 652e  Equal(interface.
-0001be80: 7375 626e 6574 2c20 6970 6164 6472 6573  subnet, ipaddres
-0001be90: 732e 4950 7636 4e65 7477 6f72 6b28 2732  s.IPv6Network('2
-0001bea0: 3030 313a 3064 6238 3a3a 303a 303a 303a  001:0db8::0:0:0:
-0001beb0: 302f 3634 2729 290a 0a20 2020 2064 6566  0/64'))..    def
-0001bec0: 2074 6573 745f 6e65 7477 6f72 6b5f 6765   test_network_ge
-0001bed0: 745f 7265 6c61 7469 6f6e 5f6e 6f74 5f66  t_relation_not_f
-0001bee0: 6f75 6e64 2873 656c 6629 3a0a 2020 2020  ound(self):.    
-0001bef0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0001bf00: 7365 7274 5261 6973 6573 286f 7073 2e52  sertRaises(ops.R
-0001bf10: 656c 6174 696f 6e4e 6f74 466f 756e 6445  elationNotFoundE
-0001bf20: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0001bf30: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-0001bf40: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-0001bf50: 6728 2764 6227 292e 6e65 7477 6f72 6b0a  g('db').network.
-0001bf60: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-0001bf70: 645f 6e65 7477 6f72 6b5f 656e 6470 6f69  d_network_endpoi
-0001bf80: 6e74 5f6e 6f74 5f69 6e5f 6d65 7461 2873  nt_not_in_meta(s
-0001bf90: 656c 6629 3a0a 2020 2020 2020 2020 7769  elf):.        wi
-0001bfa0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001bfb0: 6973 6573 286f 7073 2e4d 6f64 656c 4572  ises(ops.ModelEr
-0001bfc0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0001bfd0: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
-0001bfe0: 6464 5f6e 6574 776f 726b 2827 3335 2e30  dd_network('35.0
-0001bff0: 2e30 2e31 272c 2065 6e64 706f 696e 743d  .0.1', endpoint=
-0001c000: 2778 797a 2729 0a0a 2020 2020 6465 6620  'xyz')..    def 
-0001c010: 7465 7374 5f61 6464 5f6e 6574 776f 726b  test_add_network
-0001c020: 5f72 656c 6174 696f 6e5f 6964 5f73 6574  _relation_id_set
-0001c030: 5f65 6e64 706f 696e 745f 6e6f 745f 7365  _endpoint_not_se
-0001c040: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0001c050: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
-0001c060: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-0001c070: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-0001c080: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-0001c090: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0001c0a0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0001c0b0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0001c0c0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0001c0d0: 2e61 6464 5f6e 6574 776f 726b 2827 3335  .add_network('35
-0001c0e0: 2e30 2e30 2e31 272c 2072 656c 6174 696f  .0.0.1', relatio
-0001c0f0: 6e5f 6964 3d72 656c 6174 696f 6e5f 6964  n_id=relation_id
-0001c100: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001c110: 6164 645f 6e65 7477 6f72 6b5f 7265 6c61  add_network_rela
-0001c120: 7469 6f6e 5f69 645f 696e 636f 7272 6563  tion_id_incorrec
-0001c130: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0001c140: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
-0001c150: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-0001c160: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-0001c170: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-0001c180: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0001c190: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-0001c1a0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-0001c1b0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-0001c1c0: 726e 6573 732e 6164 645f 6e65 7477 6f72  rness.add_networ
-0001c1d0: 6b28 2733 352e 302e 302e 3127 2c20 656e  k('35.0.0.1', en
-0001c1e0: 6470 6f69 6e74 3d27 6462 272c 2072 656c  dpoint='db', rel
-0001c1f0: 6174 696f 6e5f 6964 3d72 656c 6174 696f  ation_id=relatio
-0001c200: 6e5f 6964 202b 2031 290a 0a20 2020 2064  n_id + 1)..    d
-0001c210: 6566 2074 6573 745f 6164 645f 6e65 7477  ef test_add_netw
-0001c220: 6f72 6b5f 656e 6470 6f69 6e74 5f61 6e64  ork_endpoint_and
-0001c230: 5f72 656c 6174 696f 6e5f 6964 5f64 6f5f  _relation_id_do_
-0001c240: 6e6f 745f 636f 7272 6573 706f 6e64 2873  not_correspond(s
-0001c250: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0001c260: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
-0001c270: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-0001c280: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-0001c290: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-0001c2a0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001c2b0: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
-0001c2c0: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
-0001c2d0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0001c2e0: 7373 2e61 6464 5f6e 6574 776f 726b 2827  ss.add_network('
-0001c2f0: 3335 2e30 2e30 2e31 272c 2065 6e64 706f  35.0.0.1', endpo
-0001c300: 696e 743d 2766 6f6f 272c 2072 656c 6174  int='foo', relat
-0001c310: 696f 6e5f 6964 3d72 656c 6174 696f 6e5f  ion_id=relation_
-0001c320: 6964 290a 0a0a 636c 6173 7320 4442 5265  id)...class DBRe
-0001c330: 6c61 7469 6f6e 4368 616e 6765 6448 656c  lationChangedHel
-0001c340: 7065 7228 6f70 732e 4f62 6a65 6374 293a  per(ops.Object):
-0001c350: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0001c360: 5f28 7365 6c66 2c20 7061 7265 6e74 2c20  _(self, parent, 
-0001c370: 6b65 7929 3a0a 2020 2020 2020 2020 7375  key):.        su
-0001c380: 7065 7228 292e 5f5f 696e 6974 5f5f 2870  per().__init__(p
-0001c390: 6172 656e 742c 206b 6579 290a 2020 2020  arent, key).    
-0001c3a0: 2020 2020 7365 6c66 2e63 6861 6e67 6573      self.changes
-0001c3b0: 203d 205b 5d0a 2020 2020 2020 2020 7061   = [].        pa
-0001c3c0: 7265 6e74 2e66 7261 6d65 776f 726b 2e6f  rent.framework.o
-0001c3d0: 6273 6572 7665 2870 6172 656e 742e 6f6e  bserve(parent.on
-0001c3e0: 2e64 625f 7265 6c61 7469 6f6e 5f63 6861  .db_relation_cha
-0001c3f0: 6e67 6564 2c20 7365 6c66 2e6f 6e5f 7265  nged, self.on_re
-0001c400: 6c61 7469 6f6e 5f63 6861 6e67 6564 290a  lation_changed).
-0001c410: 0a20 2020 2064 6566 206f 6e5f 7265 6c61  .    def on_rela
-0001c420: 7469 6f6e 5f63 6861 6e67 6564 2873 656c  tion_changed(sel
-0001c430: 662c 2065 7665 6e74 293a 0a20 2020 2020  f, event):.     
-0001c440: 2020 2069 6620 6576 656e 742e 756e 6974     if event.unit
-0001c450: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001c460: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0001c470: 6861 6e67 6573 2e61 7070 656e 6428 2865  hanges.append((e
-0001c480: 7665 6e74 2e72 656c 6174 696f 6e2e 6964  vent.relation.id
-0001c490: 2c20 6576 656e 742e 756e 6974 2e6e 616d  , event.unit.nam
-0001c4a0: 6529 290a 2020 2020 2020 2020 656c 7365  e)).        else
-0001c4b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001c4c0: 6c66 2e63 6861 6e67 6573 2e61 7070 656e  lf.changes.appen
-0001c4d0: 6428 2865 7665 6e74 2e72 656c 6174 696f  d((event.relatio
-0001c4e0: 6e2e 6964 2c20 6576 656e 742e 6170 702e  n.id, event.app.
-0001c4f0: 6e61 6d65 2929 0a0a 0a63 6c61 7373 2052  name))...class R
-0001c500: 656c 6174 696f 6e43 6861 6e67 6564 5669  elationChangedVi
-0001c510: 6577 6572 286f 7073 2e4f 626a 6563 7429  ewer(ops.Object)
-0001c520: 3a0a 2020 2020 2222 2254 7261 636b 2072  :.    """Track r
-0001c530: 656c 6174 696f 6e5f 6368 616e 6765 6420  elation_changed 
-0001c540: 6576 656e 7473 2061 6e64 2073 6176 6573  events and saves
-0001c550: 2074 6865 2064 6174 6120 7365 656e 2069   the data seen i
-0001c560: 6e20 7468 6520 7265 6c61 7469 6f6e 2062  n the relation b
-0001c570: 7563 6b65 742e 2222 220a 0a20 2020 2064  ucket."""..    d
-0001c580: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-0001c590: 2c20 6368 6172 6d2c 2072 656c 6174 696f  , charm, relatio
-0001c5a0: 6e5f 6e61 6d65 293a 0a20 2020 2020 2020  n_name):.       
-0001c5b0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-0001c5c0: 5f28 6368 6172 6d2c 2072 656c 6174 696f  _(charm, relatio
-0001c5d0: 6e5f 6e61 6d65 290a 2020 2020 2020 2020  n_name).        
-0001c5e0: 7365 6c66 2e63 6861 6e67 6573 203d 205b  self.changes = [
-0001c5f0: 5d0a 2020 2020 2020 2020 6368 6172 6d2e  ].        charm.
-0001c600: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
-0001c610: 6528 6368 6172 6d2e 6f6e 5b72 656c 6174  e(charm.on[relat
-0001c620: 696f 6e5f 6e61 6d65 5d2e 7265 6c61 7469  ion_name].relati
-0001c630: 6f6e 5f63 6861 6e67 6564 2c20 7365 6c66  on_changed, self
-0001c640: 2e6f 6e5f 7265 6c61 7469 6f6e 5f63 6861  .on_relation_cha
-0001c650: 6e67 6564 290a 0a20 2020 2064 6566 206f  nged)..    def o
-0001c660: 6e5f 7265 6c61 7469 6f6e 5f63 6861 6e67  n_relation_chang
-0001c670: 6564 2873 656c 662c 2065 7665 6e74 293a  ed(self, event):
-0001c680: 0a20 2020 2020 2020 2069 6620 6576 656e  .        if even
-0001c690: 742e 756e 6974 2069 7320 6e6f 7420 4e6f  t.unit is not No
-0001c6a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001c6b0: 6461 7461 203d 2065 7665 6e74 2e72 656c  data = event.rel
-0001c6c0: 6174 696f 6e2e 6461 7461 5b65 7665 6e74  ation.data[event
-0001c6d0: 2e75 6e69 745d 0a20 2020 2020 2020 2065  .unit].        e
-0001c6e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001c6f0: 2064 6174 6120 3d20 6576 656e 742e 7265   data = event.re
-0001c700: 6c61 7469 6f6e 2e64 6174 615b 6576 656e  lation.data[even
-0001c710: 742e 6170 705d 0a20 2020 2020 2020 2073  t.app].        s
-0001c720: 656c 662e 6368 616e 6765 732e 6170 7065  elf.changes.appe
-0001c730: 6e64 2864 6963 7428 6461 7461 2929 0a0a  nd(dict(data))..
-0001c740: 0a63 6c61 7373 2052 6563 6f72 6469 6e67  .class Recording
-0001c750: 4368 6172 6d28 6f70 732e 4368 6172 6d42  Charm(ops.CharmB
-0001c760: 6173 6529 3a0a 2020 2020 2222 2252 6563  ase):.    """Rec
-0001c770: 6f72 6420 7468 6520 6576 656e 7473 2074  ord the events t
-0001c780: 6861 7420 7765 2073 6565 2c20 616e 6420  hat we see, and 
-0001c790: 616e 7920 6173 736f 6369 6174 6564 2064  any associated d
-0001c7a0: 6174 612e 2222 220a 0a20 2020 2064 6566  ata."""..    def
-0001c7b0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001c7c0: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
-0001c7d0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-0001c7e0: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
-0001c7f0: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
-0001c800: 6e67 6573 203d 205b 5d0a 2020 2020 2020  nges = [].      
-0001c810: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-0001c820: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-0001c830: 2e63 6f6e 6669 675f 6368 616e 6765 642c  .config_changed,
-0001c840: 2073 656c 662e 5f6f 6e5f 636f 6e66 6967   self._on_config
-0001c850: 5f63 6861 6e67 6564 290a 2020 2020 2020  _changed).      
-0001c860: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-0001c870: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-0001c880: 2e6c 6561 6465 725f 656c 6563 7465 642c  .leader_elected,
-0001c890: 2073 656c 662e 5f6f 6e5f 6c65 6164 6572   self._on_leader
-0001c8a0: 5f65 6c65 6374 6564 290a 2020 2020 2020  _elected).      
-0001c8b0: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-0001c8c0: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-0001c8d0: 2e6c 6561 6465 725f 7365 7474 696e 6773  .leader_settings
-0001c8e0: 5f63 6861 6e67 6564 2c20 7365 6c66 2e5f  _changed, self._
-0001c8f0: 6f6e 5f6c 6561 6465 725f 7365 7474 696e  on_leader_settin
-0001c900: 6773 5f63 6861 6e67 6564 290a 2020 2020  gs_changed).    
-0001c910: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
-0001c920: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
-0001c930: 6f6e 2e69 6e73 7461 6c6c 2c20 7365 6c66  on.install, self
-0001c940: 2e5f 6f6e 5f69 6e73 7461 6c6c 290a 2020  ._on_install).  
-0001c950: 2020 2020 2020 7365 6c66 2e66 7261 6d65        self.frame
-0001c960: 776f 726b 2e6f 6273 6572 7665 2873 656c  work.observe(sel
-0001c970: 662e 6f6e 2e73 7461 7274 2c20 7365 6c66  f.on.start, self
-0001c980: 2e5f 6f6e 5f73 7461 7274 290a 2020 2020  ._on_start).    
-0001c990: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
-0001c9a0: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
-0001c9b0: 6f6e 2e73 746f 702c 2073 656c 662e 5f6f  on.stop, self._o
-0001c9c0: 6e5f 7374 6f70 290a 2020 2020 2020 2020  n_stop).        
-0001c9d0: 7365 6c66 2e66 7261 6d65 776f 726b 2e6f  self.framework.o
-0001c9e0: 6273 6572 7665 2873 656c 662e 6f6e 2e72  bserve(self.on.r
-0001c9f0: 656d 6f76 652c 2073 656c 662e 5f6f 6e5f  emove, self._on_
-0001ca00: 7265 6d6f 7665 290a 2020 2020 2020 2020  remove).        
-0001ca10: 7365 6c66 2e66 7261 6d65 776f 726b 2e6f  self.framework.o
-0001ca20: 6273 6572 7665 2873 656c 662e 6f6e 2e75  bserve(self.on.u
-0001ca30: 7067 7261 6465 5f63 6861 726d 2c20 7365  pgrade_charm, se
-0001ca40: 6c66 2e5f 6f6e 5f75 7067 7261 6465 5f63  lf._on_upgrade_c
-0001ca50: 6861 726d 290a 2020 2020 2020 2020 7365  harm).        se
-0001ca60: 6c66 2e66 7261 6d65 776f 726b 2e6f 6273  lf.framework.obs
-0001ca70: 6572 7665 2873 656c 662e 6f6e 2e75 7064  erve(self.on.upd
-0001ca80: 6174 655f 7374 6174 7573 2c20 7365 6c66  ate_status, self
-0001ca90: 2e5f 6f6e 5f75 7064 6174 655f 7374 6174  ._on_update_stat
-0001caa0: 7573 290a 0a20 2020 2064 6566 2067 6574  us)..    def get
-0001cab0: 5f63 6861 6e67 6573 2873 656c 662c 2072  _changes(self, r
-0001cac0: 6573 6574 3d54 7275 6529 3a0a 2020 2020  eset=True):.    
-0001cad0: 2020 2020 6368 616e 6765 7320 3d20 7365      changes = se
-0001cae0: 6c66 2e63 6861 6e67 6573 0a20 2020 2020  lf.changes.     
-0001caf0: 2020 2069 6620 7265 7365 743a 0a20 2020     if reset:.   
-0001cb00: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
-0001cb10: 616e 6765 7320 3d20 5b5d 0a20 2020 2020  anges = [].     
-0001cb20: 2020 2072 6574 7572 6e20 6368 616e 6765     return change
-0001cb30: 730a 0a20 2020 2064 6566 205f 6f6e 5f69  s..    def _on_i
-0001cb40: 6e73 7461 6c6c 2873 656c 662c 205f 293a  nstall(self, _):
-0001cb50: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001cb60: 2e63 6f6e 6669 672e 6765 7428 2773 6574  .config.get('set
-0001cb70: 5f73 7461 7475 7327 293a 0a20 2020 2020  _status'):.     
-0001cb80: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001cb90: 2e73 7461 7475 7320 3d20 6f70 732e 4d61  .status = ops.Ma
-0001cba0: 696e 7465 6e61 6e63 6553 7461 7475 7328  intenanceStatus(
-0001cbb0: 2253 7461 7475 7320 7365 7420 6f6e 2069  "Status set on i
-0001cbc0: 6e73 7461 6c6c 2229 0a20 2020 2020 2020  nstall").       
-0001cbd0: 2073 656c 662e 6368 616e 6765 732e 6170   self.changes.ap
-0001cbe0: 7065 6e64 2864 6963 7428 6e61 6d65 3d27  pend(dict(name='
-0001cbf0: 696e 7374 616c 6c27 2929 0a0a 2020 2020  install'))..    
-0001cc00: 6465 6620 5f6f 6e5f 7374 6172 7428 7365  def _on_start(se
-0001cc10: 6c66 2c20 5f29 3a0a 2020 2020 2020 2020  lf, _):.        
-0001cc20: 7365 6c66 2e63 6861 6e67 6573 2e61 7070  self.changes.app
-0001cc30: 656e 6428 6469 6374 286e 616d 653d 2773  end(dict(name='s
-0001cc40: 7461 7274 2729 290a 0a20 2020 2064 6566  tart'))..    def
-0001cc50: 205f 6f6e 5f73 746f 7028 7365 6c66 2c20   _on_stop(self, 
-0001cc60: 5f29 3a0a 2020 2020 2020 2020 7365 6c66  _):.        self
-0001cc70: 2e63 6861 6e67 6573 2e61 7070 656e 6428  .changes.append(
-0001cc80: 6469 6374 286e 616d 653d 2773 746f 7027  dict(name='stop'
-0001cc90: 2929 0a0a 2020 2020 6465 6620 5f6f 6e5f  ))..    def _on_
-0001cca0: 7265 6d6f 7665 2873 656c 662c 205f 293a  remove(self, _):
-0001ccb0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001ccc0: 616e 6765 732e 6170 7065 6e64 2864 6963  anges.append(dic
-0001ccd0: 7428 6e61 6d65 3d27 7265 6d6f 7665 2729  t(name='remove')
-0001cce0: 290a 0a20 2020 2064 6566 205f 6f6e 5f63  )..    def _on_c
-0001ccf0: 6f6e 6669 675f 6368 616e 6765 6428 7365  onfig_changed(se
-0001cd00: 6c66 2c20 5f29 3a0a 2020 2020 2020 2020  lf, _):.        
-0001cd10: 7365 6c66 2e63 6861 6e67 6573 2e61 7070  self.changes.app
-0001cd20: 656e 6428 6469 6374 286e 616d 653d 2763  end(dict(name='c
-0001cd30: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
-0001cd40: 6461 7461 3d64 6963 7428 7365 6c66 2e66  data=dict(self.f
-0001cd50: 7261 6d65 776f 726b 2e6d 6f64 656c 2e63  ramework.model.c
-0001cd60: 6f6e 6669 6729 2929 0a0a 2020 2020 6465  onfig)))..    de
-0001cd70: 6620 5f6f 6e5f 6c65 6164 6572 5f65 6c65  f _on_leader_ele
-0001cd80: 6374 6564 2873 656c 662c 205f 293a 0a20  cted(self, _):. 
-0001cd90: 2020 2020 2020 2073 656c 662e 6368 616e         self.chan
-0001cda0: 6765 732e 6170 7065 6e64 2864 6963 7428  ges.append(dict(
-0001cdb0: 6e61 6d65 3d27 6c65 6164 6572 2d65 6c65  name='leader-ele
-0001cdc0: 6374 6564 2729 290a 0a20 2020 2064 6566  cted'))..    def
-0001cdd0: 205f 6f6e 5f6c 6561 6465 725f 7365 7474   _on_leader_sett
-0001cde0: 696e 6773 5f63 6861 6e67 6564 2873 656c  ings_changed(sel
-0001cdf0: 662c 205f 293a 0a20 2020 2020 2020 2073  f, _):.        s
-0001ce00: 656c 662e 6368 616e 6765 732e 6170 7065  elf.changes.appe
-0001ce10: 6e64 2864 6963 7428 6e61 6d65 3d27 6c65  nd(dict(name='le
-0001ce20: 6164 6572 2d73 6574 7469 6e67 732d 6368  ader-settings-ch
-0001ce30: 616e 6765 6427 2929 0a0a 2020 2020 6465  anged'))..    de
-0001ce40: 6620 5f6f 6e5f 7570 6772 6164 655f 6368  f _on_upgrade_ch
-0001ce50: 6172 6d28 7365 6c66 2c20 5f29 3a0a 2020  arm(self, _):.  
-0001ce60: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
-0001ce70: 6573 2e61 7070 656e 6428 6469 6374 286e  es.append(dict(n
-0001ce80: 616d 653d 2775 7067 7261 6465 2d63 6861  ame='upgrade-cha
-0001ce90: 726d 2729 290a 0a20 2020 2064 6566 205f  rm'))..    def _
-0001cea0: 6f6e 5f75 7064 6174 655f 7374 6174 7573  on_update_status
-0001ceb0: 2873 656c 662c 205f 293a 0a20 2020 2020  (self, _):.     
-0001cec0: 2020 2073 656c 662e 6368 616e 6765 732e     self.changes.
-0001ced0: 6170 7065 6e64 2864 6963 7428 6e61 6d65  append(dict(name
-0001cee0: 3d27 7570 6461 7465 2d73 7461 7475 7327  ='update-status'
-0001cef0: 2929 0a0a 0a63 6c61 7373 2052 656c 6174  ))...class Relat
-0001cf00: 696f 6e45 7665 6e74 4368 6172 6d28 5265  ionEventCharm(Re
-0001cf10: 636f 7264 696e 6743 6861 726d 293a 0a20  cordingCharm):. 
-0001cf20: 2020 2022 2222 5265 636f 7264 2065 7665     """Record eve
-0001cf30: 6e74 7320 7265 6c61 7465 6420 746f 2072  nts related to r
-0001cf40: 656c 6174 696f 6e20 6c69 6665 6379 636c  elation lifecycl
-0001cf50: 6573 2e22 2222 0a0a 2020 2020 6465 6620  es."""..    def 
-0001cf60: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-0001cf70: 7261 6d65 776f 726b 293a 0a20 2020 2020  ramework):.     
-0001cf80: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-0001cf90: 745f 5f28 6672 616d 6577 6f72 6b29 0a20  t__(framework). 
-0001cfa0: 2020 2020 2020 2023 2057 6865 6e20 7365         # When se
-0001cfb0: 742c 2074 6869 7320 696e 7374 7275 6374  t, this instruct
-0001cfc0: 7320 7468 6520 6368 6172 6d20 746f 2069  s the charm to i
-0001cfd0: 6e63 6c75 6465 2061 2027 7265 6c61 7469  nclude a 'relati
-0001cfe0: 6f6e 5f64 6174 6127 2066 6965 6c64 2069  on_data' field i
-0001cff0: 6e20 7468 6520 2764 6174 6127 0a20 2020  n the 'data'.   
-0001d000: 2020 2020 2023 2073 6563 7469 6f6e 206f       # section o
-0001d010: 6620 6561 6368 2063 6861 6e67 6520 6974  f each change it
-0001d020: 206c 6f67 732c 2077 6869 6368 2061 6c6c   logs, which all
-0001d030: 6f77 7320 7573 2074 6f20 7465 7374 2077  ows us to test w
-0001d040: 6869 6368 2072 656c 6174 696f 6e20 6461  hich relation da
-0001d050: 7461 2077 6173 2061 7661 696c 6162 6c65  ta was available
-0001d060: 0a20 2020 2020 2020 2023 2069 6e20 6561  .        # in ea
-0001d070: 6368 2068 6f6f 6b20 696e 766f 6361 7469  ch hook invocati
-0001d080: 6f6e 0a20 2020 2020 2020 2073 656c 662e  on.        self.
-0001d090: 7265 636f 7264 5f72 656c 6174 696f 6e5f  record_relation_
-0001d0a0: 6461 7461 5f6f 6e5f 6576 656e 7473 203d  data_on_events =
-0001d0b0: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
-0001d0c0: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
-0001d0d0: 5f65 7665 6e74 7328 7365 6c66 2c20 7265  _events(self, re
-0001d0e0: 6c61 7469 6f6e 5f6e 616d 6529 3a0a 2020  lation_name):.  
-0001d0f0: 2020 2020 2020 7365 6c66 2e72 656c 6174        self.relat
-0001d100: 696f 6e5f 6e61 6d65 203d 2072 656c 6174  ion_name = relat
-0001d110: 696f 6e5f 6e61 6d65 0a20 2020 2020 2020  ion_name.       
-0001d120: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
-0001d130: 6f62 7365 7276 6528 7365 6c66 2e6f 6e5b  observe(self.on[
-0001d140: 7265 6c61 7469 6f6e 5f6e 616d 655d 2e72  relation_name].r
-0001d150: 656c 6174 696f 6e5f 6372 6561 7465 642c  elation_created,
-0001d160: 2073 656c 662e 5f6f 6e5f 7265 6c61 7469   self._on_relati
-0001d170: 6f6e 5f63 7265 6174 6564 290a 2020 2020  on_created).    
-0001d180: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
-0001d190: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
-0001d1a0: 6f6e 5b72 656c 6174 696f 6e5f 6e61 6d65  on[relation_name
-0001d1b0: 5d2e 7265 6c61 7469 6f6e 5f6a 6f69 6e65  ].relation_joine
-0001d1c0: 642c 2073 656c 662e 5f6f 6e5f 7265 6c61  d, self._on_rela
-0001d1d0: 7469 6f6e 5f6a 6f69 6e65 6429 0a20 2020  tion_joined).   
-0001d1e0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-0001d1f0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-0001d200: 2e6f 6e5b 7265 6c61 7469 6f6e 5f6e 616d  .on[relation_nam
-0001d210: 655d 2e72 656c 6174 696f 6e5f 6368 616e  e].relation_chan
-0001d220: 6765 642c 2073 656c 662e 5f6f 6e5f 7265  ged, self._on_re
-0001d230: 6c61 7469 6f6e 5f63 6861 6e67 6564 290a  lation_changed).
-0001d240: 2020 2020 2020 2020 7365 6c66 2e66 7261          self.fra
-0001d250: 6d65 776f 726b 2e6f 6273 6572 7665 2873  mework.observe(s
-0001d260: 656c 662e 6f6e 5b72 656c 6174 696f 6e5f  elf.on[relation_
-0001d270: 6e61 6d65 5d2e 7265 6c61 7469 6f6e 5f64  name].relation_d
-0001d280: 6570 6172 7465 642c 0a20 2020 2020 2020  eparted,.       
-0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2a0: 2020 2020 2020 2020 7365 6c66 2e5f 6f6e          self._on
-0001d2b0: 5f72 656c 6174 696f 6e5f 6465 7061 7274  _relation_depart
-0001d2c0: 6564 290a 2020 2020 2020 2020 7365 6c66  ed).        self
-0001d2d0: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
-0001d2e0: 7665 2873 656c 662e 6f6e 5b72 656c 6174  ve(self.on[relat
-0001d2f0: 696f 6e5f 6e61 6d65 5d2e 7265 6c61 7469  ion_name].relati
-0001d300: 6f6e 5f62 726f 6b65 6e2c 2073 656c 662e  on_broken, self.
-0001d310: 5f6f 6e5f 7265 6c61 7469 6f6e 5f62 726f  _on_relation_bro
-0001d320: 6b65 6e29 0a0a 2020 2020 6465 6620 5f6f  ken)..    def _o
-0001d330: 6e5f 7265 6c61 7469 6f6e 5f63 7265 6174  n_relation_creat
-0001d340: 6564 2873 656c 662c 2065 7665 6e74 293a  ed(self, event):
-0001d350: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
-0001d360: 6273 6572 7665 5f72 656c 6174 696f 6e5f  bserve_relation_
-0001d370: 6576 656e 7428 2772 656c 6174 696f 6e2d  event('relation-
-0001d380: 6372 6561 7465 6427 2c20 6576 656e 7429  created', event)
-0001d390: 0a0a 2020 2020 6465 6620 5f6f 6e5f 7265  ..    def _on_re
-0001d3a0: 6c61 7469 6f6e 5f6a 6f69 6e65 6428 7365  lation_joined(se
-0001d3b0: 6c66 2c20 6576 656e 7429 3a0a 2020 2020  lf, event):.    
-0001d3c0: 2020 2020 7365 6c66 2e5f 6f62 7365 7276      self._observ
-0001d3d0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-0001d3e0: 2827 7265 6c61 7469 6f6e 2d6a 6f69 6e65  ('relation-joine
-0001d3f0: 6427 2c20 6576 656e 7429 0a0a 2020 2020  d', event)..    
-0001d400: 6465 6620 5f6f 6e5f 7265 6c61 7469 6f6e  def _on_relation
-0001d410: 5f63 6861 6e67 6564 2873 656c 662c 2065  _changed(self, e
-0001d420: 7665 6e74 293a 0a20 2020 2020 2020 2073  vent):.        s
-0001d430: 656c 662e 5f6f 6273 6572 7665 5f72 656c  elf._observe_rel
-0001d440: 6174 696f 6e5f 6576 656e 7428 2772 656c  ation_event('rel
-0001d450: 6174 696f 6e2d 6368 616e 6765 6427 2c20  ation-changed', 
-0001d460: 6576 656e 7429 0a0a 2020 2020 6465 6620  event)..    def 
-0001d470: 5f6f 6e5f 7265 6c61 7469 6f6e 5f64 6570  _on_relation_dep
-0001d480: 6172 7465 6428 7365 6c66 2c20 6576 656e  arted(self, even
-0001d490: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
-0001d4a0: 2e5f 6f62 7365 7276 655f 7265 6c61 7469  ._observe_relati
-0001d4b0: 6f6e 5f65 7665 6e74 2827 7265 6c61 7469  on_event('relati
-0001d4c0: 6f6e 2d64 6570 6172 7465 6427 2c20 6576  on-departed', ev
-0001d4d0: 656e 7429 0a0a 2020 2020 6465 6620 5f6f  ent)..    def _o
-0001d4e0: 6e5f 7265 6c61 7469 6f6e 5f62 726f 6b65  n_relation_broke
-0001d4f0: 6e28 7365 6c66 2c20 6576 656e 7429 3a0a  n(self, event):.
-0001d500: 2020 2020 2020 2020 7365 6c66 2e5f 6f62          self._ob
-0001d510: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
-0001d520: 7665 6e74 2827 7265 6c61 7469 6f6e 2d62  vent('relation-b
-0001d530: 726f 6b65 6e27 2c20 6576 656e 7429 0a0a  roken', event)..
-0001d540: 2020 2020 6465 6620 5f6f 6273 6572 7665      def _observe
-0001d550: 5f72 656c 6174 696f 6e5f 6576 656e 7428  _relation_event(
-0001d560: 7365 6c66 2c20 6576 656e 745f 6e61 6d65  self, event_name
-0001d570: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-0001d580: 2020 756e 6974 5f6e 616d 6520 3d20 4e6f    unit_name = No
-0001d590: 6e65 0a20 2020 2020 2020 2069 6620 6576  ne.        if ev
-0001d5a0: 656e 742e 756e 6974 2069 7320 6e6f 7420  ent.unit is not 
-0001d5b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001d5c0: 2020 756e 6974 5f6e 616d 6520 3d20 6576    unit_name = ev
-0001d5d0: 656e 742e 756e 6974 2e6e 616d 650a 2020  ent.unit.name.  
-0001d5e0: 2020 2020 2020 6170 705f 6e61 6d65 203d        app_name =
-0001d5f0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-0001d600: 2065 7665 6e74 2e61 7070 2069 7320 6e6f   event.app is no
-0001d610: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001d620: 2020 2020 6170 705f 6e61 6d65 203d 2065      app_name = e
-0001d630: 7665 6e74 2e61 7070 2e6e 616d 650a 0a20  vent.app.name.. 
-0001d640: 2020 2020 2020 2064 6174 6120 3d20 6469         data = di
-0001d650: 6374 2861 7070 3d61 7070 5f6e 616d 652c  ct(app=app_name,
-0001d660: 2075 6e69 743d 756e 6974 5f6e 616d 652c   unit=unit_name,
-0001d670: 2072 656c 6174 696f 6e5f 6964 3d65 7665   relation_id=eve
-0001d680: 6e74 2e72 656c 6174 696f 6e2e 6964 290a  nt.relation.id).
-0001d690: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001d6a0: 7461 6e63 6528 6576 656e 742c 206f 7073  tance(event, ops
-0001d6b0: 2e52 656c 6174 696f 6e44 6570 6172 7465  .RelationDeparte
-0001d6c0: 6445 7665 6e74 293a 0a20 2020 2020 2020  dEvent):.       
-0001d6d0: 2020 2020 2064 6174 615b 2764 6570 6172       data['depar
-0001d6e0: 7469 6e67 5f75 6e69 7427 5d20 3d20 6576  ting_unit'] = ev
-0001d6f0: 656e 742e 6465 7061 7274 696e 675f 756e  ent.departing_un
-0001d700: 6974 2e6e 616d 650a 0a20 2020 2020 2020  it.name..       
-0001d710: 2072 6563 6f72 6469 6e67 203d 2064 6963   recording = dic
-0001d720: 7428 6e61 6d65 3d65 7665 6e74 5f6e 616d  t(name=event_nam
-0001d730: 652c 2072 656c 6174 696f 6e3d 6576 656e  e, relation=even
-0001d740: 742e 7265 6c61 7469 6f6e 2e6e 616d 652c  t.relation.name,
-0001d750: 2064 6174 613d 6461 7461 290a 0a20 2020   data=data)..   
-0001d760: 2020 2020 2069 6620 7365 6c66 2e72 6563       if self.rec
-0001d770: 6f72 645f 7265 6c61 7469 6f6e 5f64 6174  ord_relation_dat
-0001d780: 615f 6f6e 5f65 7665 6e74 733a 0a20 2020  a_on_events:.   
-0001d790: 2020 2020 2020 2020 2072 6563 6f72 6469           recordi
-0001d7a0: 6e67 5b22 6461 7461 225d 2e75 7064 6174  ng["data"].updat
-0001d7b0: 6528 7b27 7265 6c61 7469 6f6e 5f64 6174  e({'relation_dat
-0001d7c0: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
-0001d7d0: 2020 2020 2020 7374 7228 782e 6e61 6d65        str(x.name
-0001d7e0: 293a 2064 6963 7428 6576 656e 742e 7265  ): dict(event.re
-0001d7f0: 6c61 7469 6f6e 2e64 6174 615b 785d 290a  lation.data[x]).
-0001d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d810: 666f 7220 7820 696e 2065 7665 6e74 2e72  for x in event.r
-0001d820: 656c 6174 696f 6e2e 6461 7461 0a20 2020  elation.data.   
-0001d830: 2020 2020 2020 2020 207d 7d29 0a0a 2020           }})..  
-0001d840: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
-0001d850: 6573 2e61 7070 656e 6428 7265 636f 7264  es.append(record
-0001d860: 696e 6729 0a0a 0a63 6c61 7373 2052 656c  ing)...class Rel
-0001d870: 6174 696f 6e42 726f 6b65 6e54 6573 7465  ationBrokenTeste
-0001d880: 7228 5265 6c61 7469 6f6e 4576 656e 7443  r(RelationEventC
-0001d890: 6861 726d 293a 0a20 2020 2022 2222 4163  harm):.    """Ac
-0001d8a0: 6365 7373 2069 6e61 6363 6573 7369 626c  cess inaccessibl
-0001d8b0: 6520 7265 6c61 7469 6f6e 2064 6174 612e  e relation data.
-0001d8c0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-0001d8d0: 6e69 745f 5f28 7365 6c66 2c20 6672 616d  nit__(self, fram
-0001d8e0: 6577 6f72 6b29 3a0a 2020 2020 2020 2020  ework):.        
-0001d8f0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-0001d900: 2866 7261 6d65 776f 726b 290a 0a20 2020  (framework)..   
-0001d910: 2064 6566 205f 6f6e 5f72 656c 6174 696f   def _on_relatio
-0001d920: 6e5f 6272 6f6b 656e 2873 656c 662c 2065  n_broken(self, e
-0001d930: 7665 6e74 293a 0a20 2020 2020 2020 2070  vent):.        p
-0001d940: 7269 6e74 2865 7665 6e74 2e72 656c 6174  rint(event.relat
-0001d950: 696f 6e2e 6461 7461 5b65 7665 6e74 2e72  ion.data[event.r
-0001d960: 656c 6174 696f 6e2e 6170 705d 5b27 6261  elation.app]['ba
-0001d970: 7227 5d29 0a0a 0a63 6c61 7373 2043 6f6e  r'])...class Con
-0001d980: 7461 696e 6572 4576 656e 7443 6861 726d  tainerEventCharm
-0001d990: 2852 6563 6f72 6469 6e67 4368 6172 6d29  (RecordingCharm)
-0001d9a0: 3a0a 2020 2020 2222 2252 6563 6f72 6420  :.    """Record 
-0001d9b0: 6576 656e 7473 2072 656c 6174 6564 2074  events related t
-0001d9c0: 6f20 636f 6e74 6169 6e65 7220 6c69 6665  o container life
-0001d9d0: 6379 636c 6573 2e22 2222 0a0a 2020 2020  cycles."""..    
-0001d9e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-0001d9f0: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
-0001da00: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-0001da10: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
-0001da20: 6b29 0a0a 2020 2020 6465 6620 6f62 7365  k)..    def obse
-0001da30: 7276 655f 636f 6e74 6169 6e65 725f 6576  rve_container_ev
-0001da40: 656e 7473 2873 656c 662c 2063 6f6e 7461  ents(self, conta
-0001da50: 696e 6572 5f6e 616d 6529 3a0a 2020 2020  iner_name):.    
-0001da60: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
-0001da70: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
-0001da80: 6f6e 5b63 6f6e 7461 696e 6572 5f6e 616d  on[container_nam
-0001da90: 655d 2e70 6562 626c 655f 7265 6164 792c  e].pebble_ready,
-0001daa0: 2073 656c 662e 5f6f 6e5f 7065 6262 6c65   self._on_pebble
-0001dab0: 5f72 6561 6479 290a 0a20 2020 2064 6566  _ready)..    def
-0001dac0: 205f 6f6e 5f70 6562 626c 655f 7265 6164   _on_pebble_read
-0001dad0: 7928 7365 6c66 2c20 6576 656e 7429 3a0a  y(self, event):.
-0001dae0: 2020 2020 2020 2020 7365 6c66 2e5f 6f62          self._ob
-0001daf0: 7365 7276 655f 636f 6e74 6169 6e65 725f  serve_container_
-0001db00: 6576 656e 7428 2770 6562 626c 652d 7265  event('pebble-re
-0001db10: 6164 7927 2c20 6576 656e 7429 0a0a 2020  ady', event)..  
-0001db20: 2020 6465 6620 5f6f 6273 6572 7665 5f63    def _observe_c
-0001db30: 6f6e 7461 696e 6572 5f65 7665 6e74 2873  ontainer_event(s
-0001db40: 656c 662c 2065 7665 6e74 5f6e 616d 652c  elf, event_name,
-0001db50: 2065 7665 6e74 3a20 6f70 732e 5065 6262   event: ops.Pebb
-0001db60: 6c65 5265 6164 7945 7665 6e74 293a 0a20  leReadyEvent):. 
-0001db70: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
-0001db80: 5f6e 616d 6520 3d20 4e6f 6e65 0a20 2020  _name = None.   
-0001db90: 2020 2020 2069 6620 6576 656e 742e 776f       if event.wo
-0001dba0: 726b 6c6f 6164 2069 7320 6e6f 7420 4e6f  rkload is not No
-0001dbb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001dbc0: 636f 6e74 6169 6e65 725f 6e61 6d65 203d  container_name =
-0001dbd0: 2065 7665 6e74 2e77 6f72 6b6c 6f61 642e   event.workload.
-0001dbe0: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
-0001dbf0: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
-0001dc00: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
-0001dc10: 6374 286e 616d 653d 6576 656e 745f 6e61  ct(name=event_na
-0001dc20: 6d65 2c20 636f 6e74 6169 6e65 723d 636f  me, container=co
-0001dc30: 6e74 6169 6e65 725f 6e61 6d65 2929 0a0a  ntainer_name))..
-0001dc40: 0a64 6566 2067 6574 5f70 7562 6c69 635f  .def get_public_
-0001dc50: 6d65 7468 6f64 7328 6f62 6a29 3a0a 2020  methods(obj):.  
-0001dc60: 2020 2222 2247 6574 2074 6865 2070 7562    """Get the pub
-0001dc70: 6c69 6320 6174 7472 6962 7574 6573 206f  lic attributes o
-0001dc80: 6620 6f62 6a20 746f 2063 6f6d 7061 7265  f obj to compare
-0001dc90: 2074 6f20 616e 6f74 6865 7220 6f62 6a65   to another obje
-0001dca0: 6374 2e22 2222 0a20 2020 2070 7562 6c69  ct.""".    publi
-0001dcb0: 6320 3d20 7365 7428 290a 2020 2020 6d65  c = set().    me
-0001dcc0: 6d62 6572 7320 3d20 696e 7370 6563 742e  mbers = inspect.
-0001dcd0: 6765 746d 656d 6265 7273 286f 626a 290a  getmembers(obj).
-0001dce0: 2020 2020 666f 7220 6e61 6d65 2c20 6d65      for name, me
-0001dcf0: 6d62 6572 2069 6e20 6d65 6d62 6572 733a  mber in members:
-0001dd00: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
-0001dd10: 2e73 7461 7274 7377 6974 6828 275f 2729  .startswith('_')
-0001dd20: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0001dd30: 6e74 696e 7565 0a20 2020 2020 2020 2069  ntinue.        i
-0001dd40: 6620 696e 7370 6563 742e 6973 6675 6e63  f inspect.isfunc
-0001dd50: 7469 6f6e 286d 656d 6265 7229 206f 7220  tion(member) or 
-0001dd60: 696e 7370 6563 742e 6973 6d65 7468 6f64  inspect.ismethod
-0001dd70: 286d 656d 6265 7229 3a0a 2020 2020 2020  (member):.      
-0001dd80: 2020 2020 2020 7075 626c 6963 2e61 6464        public.add
-0001dd90: 286e 616d 6529 0a20 2020 2072 6574 7572  (name).    retur
-0001dda0: 6e20 7075 626c 6963 0a0a 0a63 6c61 7373  n public...class
-0001ddb0: 2054 6573 7454 6573 7469 6e67 4d6f 6465   TestTestingMode
-0001ddc0: 6c42 6163 6b65 6e64 2875 6e69 7474 6573  lBackend(unittes
-0001ddd0: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
-0001dde0: 2020 6465 6620 7465 7374 5f63 6f6e 666f    def test_confo
-0001ddf0: 726d 735f 746f 5f6d 6f64 656c 5f62 6163  rms_to_model_bac
-0001de00: 6b65 6e64 2873 656c 6629 3a0a 2020 2020  kend(self):.    
-0001de10: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0001de20: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0001de30: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0001de40: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0001de50: 2020 2020 2020 6e61 6d65 3a20 6170 700a        name: app.
-0001de60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-0001de70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001de80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0001de90: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-0001dea0: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
-0001deb0: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
-0001dec0: 2020 2020 206d 625f 6d65 7468 6f64 7320       mb_methods 
-0001ded0: 3d20 6765 745f 7075 626c 6963 5f6d 6574  = get_public_met
-0001dee0: 686f 6473 285f 4d6f 6465 6c42 6163 6b65  hods(_ModelBacke
-0001def0: 6e64 290a 2020 2020 2020 2020 6261 636b  nd).        back
-0001df00: 656e 645f 6d65 7468 6f64 7320 3d20 6765  end_methods = ge
-0001df10: 745f 7075 626c 6963 5f6d 6574 686f 6473  t_public_methods
-0001df20: 2862 6163 6b65 6e64 290a 2020 2020 2020  (backend).      
-0001df30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001df40: 616c 286d 625f 6d65 7468 6f64 732c 2062  al(mb_methods, b
-0001df50: 6163 6b65 6e64 5f6d 6574 686f 6473 290a  ackend_methods).
-0001df60: 0a20 2020 2064 6566 2074 6573 745f 6d6f  .    def test_mo
-0001df70: 6465 6c5f 7575 6964 5f69 735f 7575 6964  del_uuid_is_uuid
-0001df80: 5f76 3428 7365 6c66 293a 0a20 2020 2020  _v4(self):.     
-0001df90: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-0001dfa0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0001dfb0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
-0001dfc0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-0001dfd0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-0001dfe0: 6368 6172 6d0a 2020 2020 2020 2020 2727  charm.        ''
-0001dff0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001e000: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0001e010: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-0001e020: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
-0001e030: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
-0001e040: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001e050: 7274 4571 7561 6c28 7575 6964 2e55 5549  rtEqual(uuid.UUI
-0001e060: 4428 6261 636b 656e 642e 6d6f 6465 6c5f  D(backend.model_
-0001e070: 7575 6964 292e 7665 7273 696f 6e2c 2034  uuid).version, 4
-0001e080: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001e090: 7374 6174 7573 5f73 6574 5f67 6574 5f75  status_set_get_u
-0001e0a0: 6e69 7428 7365 6c66 293a 0a20 2020 2020  nit(self):.     
-0001e0b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-0001e0c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0001e0d0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
-0001e0e0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-0001e0f0: 2020 2020 206e 616d 653a 2061 7070 0a20       name: app. 
-0001e100: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-0001e110: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-0001e120: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-0001e130: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-0001e140: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
-0001e150: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
-0001e160: 2020 2020 6261 636b 656e 642e 7374 6174      backend.stat
-0001e170: 7573 5f73 6574 2827 626c 6f63 6b65 6427  us_set('blocked'
-0001e180: 2c20 276d 6573 7361 6765 272c 2069 735f  , 'message', is_
-0001e190: 6170 703d 4661 6c73 6529 0a20 2020 2020  app=False).     
-0001e1a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001e1b0: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-0001e1c0: 2062 6163 6b65 6e64 2e73 7461 7475 735f   backend.status_
-0001e1d0: 6765 7428 6973 5f61 7070 3d46 616c 7365  get(is_app=False
-0001e1e0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
-0001e1f0: 2773 7461 7475 7327 3a20 2762 6c6f 636b  'status': 'block
-0001e200: 6564 272c 2027 6d65 7373 6167 6527 3a20  ed', 'message': 
-0001e210: 276d 6573 7361 6765 277d 290a 2020 2020  'message'}).    
-0001e220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001e230: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0001e240: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
-0001e250: 5f67 6574 2869 735f 6170 703d 5472 7565  _get(is_app=True
-0001e260: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
-0001e270: 2773 7461 7475 7327 3a20 2775 6e6b 6e6f  'status': 'unkno
-0001e280: 776e 272c 2027 6d65 7373 6167 6527 3a20  wn', 'message': 
-0001e290: 2727 7d29 0a0a 2020 2020 6465 6620 7465  ''})..    def te
-0001e2a0: 7374 5f73 7461 7475 735f 7365 745f 6765  st_status_set_ge
-0001e2b0: 745f 6170 7028 7365 6c66 293a 0a20 2020  t_app(self):.   
-0001e2c0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-0001e2d0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-0001e2e0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
-0001e2f0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0001e300: 2020 2020 2020 206e 616d 653a 2061 7070         name: app
-0001e310: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0001e320: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001e330: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0001e340: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-0001e350: 2020 2062 6163 6b65 6e64 203d 2068 6172     backend = har
-0001e360: 6e65 7373 2e5f 6261 636b 656e 640a 2020  ness._backend.  
-0001e370: 2020 2020 2020 6261 636b 656e 642e 7374        backend.st
-0001e380: 6174 7573 5f73 6574 2827 626c 6f63 6b65  atus_set('blocke
-0001e390: 6427 2c20 276d 6573 7361 6765 272c 2069  d', 'message', i
-0001e3a0: 735f 6170 703d 5472 7565 290a 2020 2020  s_app=True).    
-0001e3b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001e3c0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0001e3d0: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
-0001e3e0: 5f67 6574 2869 735f 6170 703d 5472 7565  _get(is_app=True
-0001e3f0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
-0001e400: 2773 7461 7475 7327 3a20 2762 6c6f 636b  'status': 'block
-0001e410: 6564 272c 2027 6d65 7373 6167 6527 3a20  ed', 'message': 
-0001e420: 276d 6573 7361 6765 277d 290a 2020 2020  'message'}).    
-0001e430: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001e440: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0001e450: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
-0001e460: 5f67 6574 2869 735f 6170 703d 4661 6c73  _get(is_app=Fals
-0001e470: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001e480: 7b27 7374 6174 7573 273a 2027 6d61 696e  {'status': 'main
-0001e490: 7465 6e61 6e63 6527 2c20 276d 6573 7361  tenance', 'messa
-0001e4a0: 6765 273a 2027 277d 290a 0a20 2020 2064  ge': ''})..    d
-0001e4b0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
-0001e4c0: 5f69 6473 5f75 6e6b 6e6f 776e 5f72 656c  _ids_unknown_rel
-0001e4d0: 6174 696f 6e28 7365 6c66 293a 0a20 2020  ation(self):.   
-0001e4e0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
-0001e4f0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
-0001e500: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
-0001e510: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0001e520: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0001e530: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
-0001e540: 2020 2020 7072 6f76 6964 6573 3a0a 2020      provides:.  
-0001e550: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e570: 696e 7465 7266 6163 653a 206d 7964 620a  interface: mydb.
-0001e580: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-0001e590: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001e5a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0001e5b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-0001e5c0: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
-0001e5d0: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
-0001e5e0: 2020 2020 2023 2057 6974 6820 6e6f 2072       # With no r
-0001e5f0: 656c 6174 696f 6e73 2061 6464 6564 2c20  elations added, 
-0001e600: 7765 206a 7573 7420 6765 7420 616e 2065  we just get an e
-0001e610: 6d70 7479 206c 6973 7420 666f 7220 7468  mpty list for th
-0001e620: 6520 696e 7465 7266 6163 650a 2020 2020  e interface.    
-0001e630: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001e640: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
-0001e650: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
-0001e660: 205b 5d29 0a20 2020 2020 2020 2023 2042   []).        # B
-0001e670: 7574 2061 6e20 756e 6b6e 6f77 6e20 696e  ut an unknown in
-0001e680: 7465 7266 6163 6520 7261 6973 6573 2061  terface raises a
-0001e690: 204d 6f64 656c 4572 726f 720a 2020 2020   ModelError.    
-0001e6a0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0001e6b0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
-0001e6c0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-0001e6d0: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
-0001e6e0: 7265 6c61 7469 6f6e 5f69 6473 2827 756e  relation_ids('un
-0001e6f0: 6b6e 6f77 6e27 290a 0a20 2020 2064 6566  known')..    def
-0001e700: 2074 6573 745f 7265 6c61 7469 6f6e 5f67   test_relation_g
-0001e710: 6574 5f75 6e6b 6e6f 776e 5f72 656c 6174  et_unknown_relat
-0001e720: 696f 6e5f 6964 2873 656c 6629 3a0a 2020  ion_id(self):.  
-0001e730: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-0001e740: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
-0001e750: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
-0001e760: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
-0001e770: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-0001e780: 7374 2d63 6861 726d 0a20 2020 2020 2020  st-charm.       
-0001e790: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0001e7a0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0001e7b0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0001e7c0: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
-0001e7d0: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-0001e7e0: 636b 656e 640a 2020 2020 2020 2020 7769  ckend.        wi
-0001e7f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001e800: 6973 6573 286f 7073 2e52 656c 6174 696f  ises(ops.Relatio
-0001e810: 6e4e 6f74 466f 756e 6445 7272 6f72 293a  nNotFoundError):
-0001e820: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
-0001e830: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-0001e840: 7428 3132 3334 2c20 2775 6e69 742f 3027  t(1234, 'unit/0'
-0001e850: 2c20 4661 6c73 6529 0a0a 2020 2020 6465  , False)..    de
-0001e860: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-0001e870: 6c69 7374 5f75 6e6b 6e6f 776e 5f72 656c  list_unknown_rel
-0001e880: 6174 696f 6e5f 6964 2873 656c 6629 3a0a  ation_id(self):.
-0001e890: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0001e8a0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-0001e8b0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
-0001e8c0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
-0001e8d0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-0001e8e0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
-0001e8f0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0001e900: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0001e910: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0001e920: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
-0001e930: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
-0001e940: 6261 636b 656e 640a 2020 2020 2020 2020  backend.        
-0001e950: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0001e960: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
-0001e970: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
-0001e980: 293a 0a20 2020 2020 2020 2020 2020 2062  ):.            b
-0001e990: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-0001e9a0: 6c69 7374 2831 3233 3429 0a0a 2020 2020  list(1234)..    
-0001e9b0: 6465 6620 7465 7374 5f6c 617a 795f 7265  def test_lazy_re
-0001e9c0: 736f 7572 6365 5f64 6972 6563 746f 7279  source_directory
-0001e9d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001e9e0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0001e9f0: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0001ea00: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0001ea10: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0001ea20: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0001ea30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001ea40: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-0001ea50: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
-0001ea60: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0001ea70: 653a 206f 6369 2d69 6d61 6765 0a20 2020  e: oci-image.   
-0001ea80: 2020 2020 2020 2020 2020 2020 2064 6573               des
-0001ea90: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
-0001eaa0: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
-0001eab0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-0001eac0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0001ead0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0001eae0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-0001eaf0: 6172 6e65 7373 2e70 6f70 756c 6174 655f  arness.populate_
-0001eb00: 6f63 695f 7265 736f 7572 6365 7328 290a  oci_resources().
-0001eb10: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
-0001eb20: 3d20 6861 726e 6573 732e 5f62 6163 6b65  = harness._backe
-0001eb30: 6e64 0a20 2020 2020 2020 2073 656c 662e  nd.        self.
-0001eb40: 6173 7365 7274 4973 4e6f 6e65 2862 6163  assertIsNone(bac
-0001eb50: 6b65 6e64 2e5f 7265 736f 7572 6365 5f64  kend._resource_d
-0001eb60: 6972 290a 2020 2020 2020 2020 7061 7468  ir).        path
-0001eb70: 203d 2062 6163 6b65 6e64 2e72 6573 6f75   = backend.resou
-0001eb80: 7263 655f 6765 7428 2769 6d61 6765 2729  rce_get('image')
-0001eb90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001eba0: 7365 7274 4973 4e6f 744e 6f6e 6528 6261  sertIsNotNone(ba
-0001ebb0: 636b 656e 642e 5f72 6573 6f75 7263 655f  ckend._resource_
-0001ebc0: 6469 7229 0a20 2020 2020 2020 2073 656c  dir).        sel
-0001ebd0: 662e 6173 7365 7274 5472 7565 280a 2020  f.assertTrue(.  
-0001ebe0: 2020 2020 2020 2020 2020 7374 7228 7061            str(pa
-0001ebf0: 7468 292e 7374 6172 7473 7769 7468 2873  th).startswith(s
-0001ec00: 7472 2862 6163 6b65 6e64 2e5f 7265 736f  tr(backend._reso
-0001ec10: 7572 6365 5f64 6972 2e6e 616d 6529 292c  urce_dir.name)),
-0001ec20: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-0001ec30: 3d66 2765 7870 6563 7465 6420 7b70 6174  =f'expected {pat
-0001ec40: 687d 2074 6f20 6265 2061 2073 7562 6469  h} to be a subdi
-0001ec50: 7265 6374 6f72 7920 6f66 207b 6261 636b  rectory of {back
-0001ec60: 656e 642e 5f72 6573 6f75 7263 655f 6469  end._resource_di
-0001ec70: 722e 6e61 6d65 7d27 290a 0a20 2020 2064  r.name}')..    d
-0001ec80: 6566 2074 6573 745f 7265 736f 7572 6365  ef test_resource
-0001ec90: 5f67 6574 5f6e 6f5f 7265 736f 7572 6365  _get_no_resource
-0001eca0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001ecb0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0001ecc0: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0001ecd0: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0001ece0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0001ecf0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0001ed00: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001ed10: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-0001ed20: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
-0001ed30: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0001ed40: 653a 2066 696c 650a 2020 2020 2020 2020  e: file.        
-0001ed50: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-0001ed60: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
-0001ed70: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
-0001ed80: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-0001ed90: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0001eda0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0001edb0: 290a 2020 2020 2020 2020 6261 636b 656e  ).        backen
-0001edc0: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
-0001edd0: 6b65 6e64 0a20 2020 2020 2020 2077 6974  kend.        wit
-0001ede0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0001edf0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
-0001ee00: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-0001ee10: 2020 2020 2020 2062 6163 6b65 6e64 2e72         backend.r
-0001ee20: 6573 6f75 7263 655f 6765 7428 2766 6f6f  esource_get('foo
-0001ee30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001ee40: 6173 7365 7274 496e 280a 2020 2020 2020  assertIn(.      
-0001ee50: 2020 2020 2020 2275 6e69 7473 2f75 6e69        "units/uni
-0001ee60: 742d 7465 7374 2d61 7070 2d30 2f72 6573  t-test-app-0/res
-0001ee70: 6f75 7263 6573 2f66 6f6f 3a20 7265 736f  ources/foo: reso
-0001ee80: 7572 6365 2374 6573 742d 6170 702f 666f  urce#test-app/fo
-0001ee90: 6f20 6e6f 7420 666f 756e 6422 2c0a 2020  o not found",.  
-0001eea0: 2020 2020 2020 2020 2020 7374 7228 636d            str(cm
-0001eeb0: 2e65 7863 6570 7469 6f6e 2929 0a0a 2020  .exception))..  
-0001eec0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-0001eed0: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
-0001eee0: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
-0001eef0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
-0001ef00: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0001ef10: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
-0001ef20: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-0001ef30: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-0001ef40: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
-0001ef50: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-0001ef60: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
-0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef80: 696e 7465 7266 6163 653a 2066 6f6f 0a20  interface: foo. 
-0001ef90: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-0001efa0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-0001efb0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-0001efc0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-0001efd0: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
-0001efe0: 7373 2e5f 6261 636b 656e 640a 0a20 2020  ss._backend..   
-0001eff0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f000: 4973 2862 6163 6b65 6e64 2e72 656c 6174  Is(backend.relat
-0001f010: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
-0001f020: 616d 6528 3129 2c20 4e6f 6e65 290a 0a20  ame(1), None).. 
-0001f030: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-0001f040: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-0001f050: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-0001f060: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-0001f070: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001f080: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
-0001f090: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
-0001f0a0: 6d65 2872 656c 5f69 6429 2c20 2770 6f73  me(rel_id), 'pos
-0001f0b0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-0001f0c0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-0001f0d0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-0001f0e0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-0001f0f0: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
-0001f100: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0001f110: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
-0001f120: 6f73 7467 7265 7371 6c2f 3127 290a 2020  ostgresql/1').  
-0001f130: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001f140: 7445 7175 616c 2862 6163 6b65 6e64 2e72  tEqual(backend.r
-0001f150: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
-0001f160: 7070 5f6e 616d 6528 7265 6c5f 6964 292c  pp_name(rel_id),
-0001f170: 2027 706f 7374 6772 6573 716c 2729 0a0a   'postgresql')..
-0001f180: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f190: 6572 7449 7328 6261 636b 656e 642e 7265  ertIs(backend.re
-0001f1a0: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
-0001f1b0: 705f 6e61 6d65 2837 292c 204e 6f6e 6529  p_name(7), None)
-0001f1c0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0001f1d0: 6574 5f70 6562 626c 655f 6d65 7468 6f64  et_pebble_method
-0001f1e0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001f1f0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-0001f200: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-0001f210: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-0001f220: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-0001f230: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-0001f240: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
-0001f250: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001f260: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0001f270: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-0001f280: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
-0001f290: 726e 6573 732e 5f62 6163 6b65 6e64 0a0a  rness._backend..
-0001f2a0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-0001f2b0: 2062 6163 6b65 6e64 2e67 6574 5f70 6562   backend.get_peb
-0001f2c0: 626c 6528 272f 6375 7374 6f6d 2f73 6f63  ble('/custom/soc
-0001f2d0: 6b65 742f 7061 7468 2729 0a20 2020 2020  ket/path').     
-0001f2e0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001f2f0: 496e 7374 616e 6365 2863 6c69 656e 742c  Instance(client,
-0001f300: 205f 5465 7374 696e 6750 6562 626c 6543   _TestingPebbleC
-0001f310: 6c69 656e 7429 0a0a 0a63 6c61 7373 205f  lient)...class _
-0001f320: 5465 7374 696e 6750 6562 626c 6543 6c69  TestingPebbleCli
-0001f330: 656e 744d 6978 696e 3a0a 2020 2020 6465  entMixin:.    de
-0001f340: 6620 6765 745f 7465 7374 696e 675f 636c  f get_testing_cl
-0001f350: 6965 6e74 2873 656c 6629 3a0a 2020 2020  ient(self):.    
-0001f360: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0001f370: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0001f380: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0001f390: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0001f3a0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0001f3b0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-0001f3c0: 2063 6f6e 7461 696e 6572 733a 0a20 2020   containers:.   
-0001f3d0: 2020 2020 2020 2020 2020 206d 7963 6f6e             mycon
-0001f3e0: 7461 696e 6572 3a20 7b7d 0a20 2020 2020  tainer: {}.     
-0001f3f0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0001f400: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0001f410: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0001f420: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
-0001f430: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
-0001f440: 6261 636b 656e 640a 0a20 2020 2020 2020  backend..       
-0001f450: 2063 6c69 656e 7420 3d20 6261 636b 656e   client = backen
-0001f460: 642e 6765 745f 7065 6262 6c65 2827 2f63  d.get_pebble('/c
-0001f470: 6861 726d 2f63 6f6e 7461 696e 6572 732f  harm/containers/
-0001f480: 6d79 636f 6e74 6169 6e65 722f 7065 6262  mycontainer/pebb
-0001f490: 6c65 2e73 6f63 6b65 7427 290a 2020 2020  le.socket').    
-0001f4a0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-0001f4b0: 6361 6e5f 636f 6e6e 6563 7428 276d 7963  can_connect('myc
-0001f4c0: 6f6e 7461 696e 6572 272c 2054 7275 6529  ontainer', True)
-0001f4d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001f4e0: 636c 6965 6e74 0a0a 0a23 2046 6f72 2074  client...# For t
-0001f4f0: 6573 7469 6e67 206e 6f6e 2066 696c 6520  esting non file 
-0001f500: 6f70 7320 6f66 2074 6865 2070 6562 626c  ops of the pebbl
-0001f510: 6520 7465 7374 696e 6720 636c 6965 6e74  e testing client
-0001f520: 2e0a 636c 6173 7320 5465 7374 5465 7374  ..class TestTest
-0001f530: 696e 6750 6562 626c 6543 6c69 656e 7428  ingPebbleClient(
-0001f540: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
-0001f550: 652c 205f 5465 7374 696e 6750 6562 626c  e, _TestingPebbl
-0001f560: 6543 6c69 656e 744d 6978 696e 293a 0a0a  eClientMixin):..
-0001f570: 2020 2020 6465 6620 7465 7374 5f6d 6574      def test_met
-0001f580: 686f 6473 5f6d 6174 6368 5f70 6562 626c  hods_match_pebbl
-0001f590: 655f 636c 6965 6e74 2873 656c 6629 3a0a  e_client(self):.
-0001f5a0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-0001f5b0: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
-0001f5c0: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
-0001f5d0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001f5e0: 4e6f 744e 6f6e 6528 636c 6965 6e74 290a  NotNone(client).
-0001f5f0: 2020 2020 2020 2020 7065 6262 6c65 5f63          pebble_c
-0001f600: 6c69 656e 745f 6d65 7468 6f64 7320 3d20  lient_methods = 
-0001f610: 6765 745f 7075 626c 6963 5f6d 6574 686f  get_public_metho
-0001f620: 6473 2870 6562 626c 652e 436c 6965 6e74  ds(pebble.Client
-0001f630: 290a 2020 2020 2020 2020 7465 7374 696e  ).        testin
-0001f640: 675f 636c 6965 6e74 5f6d 6574 686f 6473  g_client_methods
-0001f650: 203d 2067 6574 5f70 7562 6c69 635f 6d65   = get_public_me
-0001f660: 7468 6f64 7328 636c 6965 6e74 290a 2020  thods(client).  
-0001f670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001f680: 7445 7175 616c 2870 6562 626c 655f 636c  tEqual(pebble_cl
-0001f690: 6965 6e74 5f6d 6574 686f 6473 2c20 7465  ient_methods, te
-0001f6a0: 7374 696e 675f 636c 6965 6e74 5f6d 6574  sting_client_met
-0001f6b0: 686f 6473 290a 0a20 2020 2064 6566 2074  hods)..    def t
-0001f6c0: 6573 745f 6164 645f 6c61 7965 7228 7365  est_add_layer(se
-0001f6d0: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
-0001f6e0: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
-0001f6f0: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
-0001f700: 2020 2020 2020 2020 706c 616e 203d 2063          plan = c
-0001f710: 6c69 656e 742e 6765 745f 706c 616e 2829  lient.get_plan()
-0001f720: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001f730: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
-0001f740: 6c61 6e2c 2070 6562 626c 652e 506c 616e  lan, pebble.Plan
-0001f750: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001f760: 7373 6572 7445 7175 616c 2827 7b7d 5c6e  ssertEqual('{}\n
-0001f770: 272c 2070 6c61 6e2e 746f 5f79 616d 6c28  ', plan.to_yaml(
-0001f780: 2929 0a20 2020 2020 2020 2063 6c69 656e  )).        clien
-0001f790: 742e 6164 645f 6c61 7965 7228 2766 6f6f  t.add_layer('foo
-0001f7a0: 272c 2070 6562 626c 652e 4c61 7965 7228  ', pebble.Layer(
-0001f7b0: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
-0001f7c0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
-0001f7d0: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-0001f7e0: 7074 696f 6e3a 207c 0a20 2020 2020 2020  ption: |.       
-0001f7f0: 2020 2020 2020 2041 206c 6f6e 6765 7220         A longer 
-0001f800: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
-0001f810: 7420 466f 6f0a 2020 2020 2020 2020 2020  t Foo.          
-0001f820: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
-0001f830: 2020 2020 2020 2020 2020 7365 7276 3a0a            serv:.
-0001f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f850: 7375 6d6d 6172 793a 2053 6572 760a 2020  summary: Serv.  
-0001f860: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0001f870: 7363 7269 7074 696f 6e3a 207c 0a20 2020  scription: |.   
-0001f880: 2020 2020 2020 2020 2020 2020 2020 2041                 A
-0001f890: 2064 6573 6372 6970 7469 6f6e 2061 626f   description abo
-0001f8a0: 7574 2053 6572 7620 7468 6520 616d 617a  ut Serv the amaz
-0001f8b0: 696e 6720 7365 7276 6963 652e 0a20 2020  ing service..   
-0001f8c0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001f8d0: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
-0001f8e0: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
-0001f8f0: 6572 7269 6465 3a20 7265 706c 6163 650a  erride: replace.
-0001f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f910: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
-0001f920: 6368 6f20 6865 6c6c 6f27 0a20 2020 2020  cho hello'.     
-0001f930: 2020 2020 2020 2020 2020 2065 6e76 6972             envir
-0001f940: 6f6e 6d65 6e74 3a0a 2020 2020 2020 2020  onment:.        
-0001f950: 2020 2020 2020 2020 2020 4b45 593a 2056            KEY: V
-0001f960: 414c 5545 0a20 2020 2020 2020 2020 2020  ALUE.           
-0001f970: 2027 2727 2929 0a20 2020 2020 2020 2070   ''')).        p
-0001f980: 6c61 6e20 3d20 636c 6965 6e74 2e67 6574  lan = client.get
-0001f990: 5f70 6c61 6e28 290a 2020 2020 2020 2020  _plan().        
-0001f9a0: 2320 5468 6520 5941 4d4c 2073 686f 756c  # The YAML shoul
-0001f9b0: 6420 6265 206e 6f72 6d61 6c69 7a65 640a  d be normalized.
-0001f9c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f9d0: 6572 7445 7175 616c 2874 6578 7477 7261  ertEqual(textwra
-0001f9e0: 702e 6465 6465 6e74 2827 2727 5c0a 2020  p.dedent('''\.  
-0001f9f0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
-0001fa00: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001fa10: 2020 7365 7276 3a0a 2020 2020 2020 2020    serv:.        
-0001fa20: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-0001fa30: 202f 6269 6e2f 6563 686f 2068 656c 6c6f   /bin/echo hello
-0001fa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fa50: 2064 6573 6372 6970 7469 6f6e 3a20 2741   description: 'A
-0001fa60: 2064 6573 6372 6970 7469 6f6e 2061 626f   description abo
-0001fa70: 7574 2053 6572 7620 7468 6520 616d 617a  ut Serv the amaz
-0001fa80: 696e 6720 7365 7276 6963 652e 0a0a 2020  ing service...  
-0001fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001faa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001fab0: 2020 656e 7669 726f 6e6d 656e 743a 0a20    environment:. 
-0001fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fad0: 204b 4559 3a20 5641 4c55 450a 2020 2020   KEY: VALUE.    
-0001fae0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
-0001faf0: 7269 6465 3a20 7265 706c 6163 650a 2020  ride: replace.  
-0001fb00: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001fb10: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
-0001fb20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001fb30: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
-0001fb40: 2020 2020 2020 2020 2027 2727 292c 2070           '''), p
-0001fb50: 6c61 6e2e 746f 5f79 616d 6c28 2929 0a0a  lan.to_yaml())..
-0001fb60: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
-0001fb70: 5f6c 6179 6572 5f6d 6572 6765 2873 656c  _layer_merge(sel
-0001fb80: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
-0001fb90: 6e74 203d 2073 656c 662e 6765 745f 7465  nt = self.get_te
-0001fba0: 7374 696e 675f 636c 6965 6e74 2829 0a20  sting_client(). 
-0001fbb0: 2020 2020 2020 2070 6c61 6e20 3d20 636c         plan = cl
-0001fbc0: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
-0001fbd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001fbe0: 6572 7449 7349 6e73 7461 6e63 6528 706c  ertIsInstance(pl
-0001fbf0: 616e 2c20 7065 6262 6c65 2e50 6c61 6e29  an, pebble.Plan)
-0001fc00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001fc10: 7365 7274 4571 7561 6c28 277b 7d5c 6e27  sertEqual('{}\n'
-0001fc20: 2c20 706c 616e 2e74 6f5f 7961 6d6c 2829  , plan.to_yaml()
-0001fc30: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-0001fc40: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
-0001fc50: 2c20 7065 6262 6c65 2e4c 6179 6572 2827  , pebble.Layer('
-0001fc60: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
-0001fc70: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
-0001fc80: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-0001fc90: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
-0001fca0: 2020 2020 2020 4120 6c6f 6e67 6572 2064        A longer d
-0001fcb0: 6573 6372 6970 7469 6f6e 2061 626f 7574  escription about
-0001fcc0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-0001fcd0: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
-0001fce0: 2020 2020 2020 2020 2073 6572 763a 0a20           serv:. 
-0001fcf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001fd00: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
-0001fd10: 2020 2020 2020 2020 2020 2020 2064 6573               des
-0001fd20: 6372 6970 7469 6f6e 3a20 7c0a 2020 2020  cription: |.    
-0001fd30: 2020 2020 2020 2020 2020 2020 2020 4120                A 
-0001fd40: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
-0001fd50: 7420 5365 7276 2074 6865 2061 6d61 7a69  t Serv the amazi
-0001fd60: 6e67 2073 6572 7669 6365 2e0a 2020 2020  ng service..    
-0001fd70: 2020 2020 2020 2020 2020 2020 7374 6172              star
-0001fd80: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
-0001fd90: 2020 2020 2020 2020 2020 2020 206f 7665               ove
-0001fda0: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
-0001fdb0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001fdc0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-0001fdd0: 686f 2068 656c 6c6f 270a 2020 2020 2020  ho hello'.      
-0001fde0: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
-0001fdf0: 6e6d 656e 743a 0a20 2020 2020 2020 2020  nment:.         
-0001fe00: 2020 2020 2020 2020 204b 4559 313a 2056           KEY1: V
-0001fe10: 414c 5545 310a 2020 2020 2020 2020 2020  ALUE1.          
-0001fe20: 2020 2020 2020 6166 7465 723a 0a20 2020        after:.   
-0001fe30: 2020 2020 2020 2020 2020 2020 202d 2074               - t
-0001fe40: 6869 6e67 310a 2020 2020 2020 2020 2020  hing1.          
-0001fe50: 2020 2020 2020 6265 666f 7265 3a0a 2020        before:.  
-0001fe60: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-0001fe70: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
-0001fe80: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-0001fe90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fea0: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
-0001feb0: 2020 2020 2020 2020 2020 7573 6572 3a20            user: 
-0001fec0: 7573 6572 310a 2020 2020 2020 2020 2020  user1.          
-0001fed0: 2020 2020 2020 7573 6572 2d69 643a 2075        user-id: u
-0001fee0: 7365 7249 4431 0a20 2020 2020 2020 2020  serID1.         
-0001fef0: 2020 2020 2020 2067 726f 7570 3a20 6772         group: gr
-0001ff00: 6f75 7031 0a20 2020 2020 2020 2020 2020  oup1.           
-0001ff10: 2020 2020 2067 726f 7570 2d69 643a 2067       group-id: g
-0001ff20: 726f 7570 4944 310a 2020 2020 2020 2020  roupID1.        
-0001ff30: 2020 2020 2020 2020 6f6e 2d66 6169 6c75          on-failu
-0001ff40: 7265 3a20 7468 696e 6731 0a20 2020 2020  re: thing1.     
-0001ff50: 2020 2020 2020 2020 2020 206f 6e2d 7375             on-su
-0001ff60: 6363 6573 733a 2074 6869 6e67 310a 2020  ccess: thing1.  
-0001ff70: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-0001ff80: 2d63 6865 636b 2d66 6169 6c75 7265 3a0a  -check-failure:.
-0001ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffa0: 2020 4b45 5931 3a20 5641 4c55 4531 0a20    KEY1: VALUE1. 
-0001ffb0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001ffc0: 6163 6b6f 6666 2d64 656c 6179 3a20 310a  ackoff-delay: 1.
-0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffe0: 6261 636b 6f66 662d 6661 6374 6f72 3a20  backoff-factor: 
-0001fff0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-00020000: 2020 6261 636b 6f66 662d 6c69 6d69 743a    backoff-limit:
-00020010: 2031 0a20 2020 2020 2020 2020 2020 2027   1.            '
-00020020: 2727 2929 0a20 2020 2020 2020 2070 6c61  '')).        pla
-00020030: 6e20 3d20 636c 6965 6e74 2e67 6574 5f70  n = client.get_p
-00020040: 6c61 6e28 290a 2020 2020 2020 2020 2320  lan().        # 
-00020050: 5468 6520 5941 4d4c 2073 686f 756c 6420  The YAML should 
-00020060: 6265 206e 6f72 6d61 6c69 7a65 640a 2020  be normalized.  
-00020070: 2020 2020 2020 7365 6c66 2e6d 6178 4469        self.maxDi
-00020080: 6666 203d 204e 6f6e 650a 2020 2020 2020  ff = None.      
-00020090: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000200a0: 616c 2874 6578 7477 7261 702e 6465 6465  al(textwrap.dede
-000200b0: 6e74 2827 2727 5c0a 2020 2020 2020 2020  nt('''\.        
-000200c0: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
-000200d0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-000200e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000200f0: 2020 6166 7465 723a 0a20 2020 2020 2020    after:.       
-00020100: 2020 2020 2020 2020 202d 2074 6869 6e67           - thing
-00020110: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00020120: 2020 6261 636b 6f66 662d 6465 6c61 793a    backoff-delay:
-00020130: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-00020140: 2020 2062 6163 6b6f 6666 2d66 6163 746f     backoff-facto
-00020150: 723a 2032 0a20 2020 2020 2020 2020 2020  r: 2.           
-00020160: 2020 2020 2062 6163 6b6f 6666 2d6c 696d       backoff-lim
-00020170: 6974 3a20 310a 2020 2020 2020 2020 2020  it: 1.          
-00020180: 2020 2020 2020 6265 666f 7265 3a0a 2020        before:.  
-00020190: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-000201a0: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
-000201b0: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-000201c0: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f0a  /bin/echo hello.
-000201d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201e0: 6465 7363 7269 7074 696f 6e3a 2027 4120  description: 'A 
-000201f0: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
-00020200: 7420 5365 7276 2074 6865 2061 6d61 7a69  t Serv the amazi
-00020210: 6e67 2073 6572 7669 6365 2e0a 0a20 2020  ng service...   
-00020220: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020240: 2065 6e76 6972 6f6e 6d65 6e74 3a0a 2020   environment:.  
-00020250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020260: 4b45 5931 3a20 5641 4c55 4531 0a20 2020  KEY1: VALUE1.   
-00020270: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00020280: 7570 3a20 6772 6f75 7031 0a20 2020 2020  up: group1.     
-00020290: 2020 2020 2020 2020 2020 2067 726f 7570             group
-000202a0: 2d69 643a 2067 726f 7570 4944 310a 2020  -id: groupID1.  
-000202b0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-000202c0: 2d63 6865 636b 2d66 6169 6c75 7265 3a0a  -check-failure:.
-000202d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202e0: 2020 4b45 5931 3a20 5641 4c55 4531 0a20    KEY1: VALUE1. 
-000202f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00020300: 6e2d 6661 696c 7572 653a 2074 6869 6e67  n-failure: thing
-00020310: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00020320: 2020 6f6e 2d73 7563 6365 7373 3a20 7468    on-success: th
-00020330: 696e 6731 0a20 2020 2020 2020 2020 2020  ing1.           
-00020340: 2020 2020 206f 7665 7272 6964 653a 2072       override: r
-00020350: 6570 6c61 6365 0a20 2020 2020 2020 2020  eplace.         
-00020360: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00020370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020380: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
-00020390: 2020 2020 2020 2020 2020 7374 6172 7475            startu
-000203a0: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
-000203b0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-000203c0: 7279 3a20 5365 7276 0a20 2020 2020 2020  ry: Serv.       
-000203d0: 2020 2020 2020 2020 2075 7365 723a 2075           user: u
-000203e0: 7365 7231 0a20 2020 2020 2020 2020 2020  ser1.           
-000203f0: 2020 2020 2075 7365 722d 6964 3a20 7573       user-id: us
-00020400: 6572 4944 310a 2020 2020 2020 2020 2020  erID1.          
-00020410: 2020 2727 2729 2c20 706c 616e 2e74 6f5f    '''), plan.to_
-00020420: 7961 6d6c 2829 290a 0a20 2020 2020 2020  yaml())..       
-00020430: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
-00020440: 7228 2766 6f6f 272c 2070 6562 626c 652e  r('foo', pebble.
-00020450: 4c61 7965 7228 2727 275c 0a20 2020 2020  Layer('''\.     
-00020460: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-00020470: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
-00020480: 6465 7363 7269 7074 696f 6e3a 207c 0a20  description: |. 
-00020490: 2020 2020 2020 2020 2020 2020 2041 206c               A l
-000204a0: 6f6e 6765 7220 6465 7363 7269 7074 696f  onger descriptio
-000204b0: 6e20 6162 6f75 7420 466f 6f0a 2020 2020  n about Foo.    
-000204c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-000204d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000204e0: 7365 7276 3a0a 2020 2020 2020 2020 2020  serv:.          
-000204f0: 2020 2020 2020 7375 6d6d 6172 793a 2053        summary: S
-00020500: 6572 760a 2020 2020 2020 2020 2020 2020  erv.            
-00020510: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-00020520: 207c 0a20 2020 2020 2020 2020 2020 2020   |.             
-00020530: 2020 2020 2041 206e 6577 2064 6573 6372       A new descr
-00020540: 6970 7469 6f6e 206f 6620 7468 6520 7468  iption of the th
-00020550: 6520 616d 617a 696e 6720 5365 7276 2073  e amazing Serv s
-00020560: 6572 7669 6365 2e0a 2020 2020 2020 2020  ervice..        
-00020570: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
-00020580: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
-00020590: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
-000205a0: 653a 206d 6572 6765 0a20 2020 2020 2020  e: merge.       
-000205b0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-000205c0: 3a20 272f 6269 6e2f 6563 686f 2068 656c  : '/bin/echo hel
-000205d0: 6c6f 270a 2020 2020 2020 2020 2020 2020  lo'.            
-000205e0: 2020 2020 656e 7669 726f 6e6d 656e 743a      environment:
-000205f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020600: 2020 204b 4559 313a 2056 414c 5545 340a     KEY1: VALUE4.
-00020610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020620: 2020 4b45 5932 3a20 5641 4c55 4532 0a20    KEY2: VALUE2. 
-00020630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020640: 204b 4559 333a 2056 414c 5545 330a 2020   KEY3: VALUE3.  
-00020650: 2020 2020 2020 2020 2020 2020 2020 6166                af
-00020660: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
-00020670: 2020 2020 202d 2074 6869 6e67 320a 2020       - thing2.  
-00020680: 2020 2020 2020 2020 2020 2020 2020 6265                be
-00020690: 666f 7265 3a0a 2020 2020 2020 2020 2020  fore:.          
-000206a0: 2020 2020 2020 2d20 7468 696e 6732 0a20        - thing2. 
-000206b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000206c0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
-000206d0: 2020 2020 2020 2020 202d 2074 6869 6e67           - thing
-000206e0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-000206f0: 2020 7573 6572 3a20 7573 6572 320a 2020    user: user2.  
-00020700: 2020 2020 2020 2020 2020 2020 2020 7573                us
-00020710: 6572 2d69 643a 2075 7365 7249 4432 0a20  er-id: userID2. 
-00020720: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00020730: 726f 7570 3a20 6772 6f75 7032 0a20 2020  roup: group2.   
-00020740: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00020750: 7570 2d69 643a 2067 726f 7570 4944 320a  up-id: groupID2.
-00020760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020770: 6f6e 2d73 7563 6365 7373 3a20 7468 696e  on-success: thin
-00020780: 6732 0a20 2020 2020 2020 2020 2020 2020  g2.             
-00020790: 2020 206f 6e2d 6661 696c 7572 653a 2074     on-failure: t
-000207a0: 6869 6e67 320a 2020 2020 2020 2020 2020  hing2.          
-000207b0: 2020 2020 2020 6f6e 2d63 6865 636b 2d66        on-check-f
-000207c0: 6169 6c75 7265 3a0a 2020 2020 2020 2020  ailure:.        
-000207d0: 2020 2020 2020 2020 2020 4b45 5931 3a20            KEY1: 
-000207e0: 5641 4c55 4534 0a20 2020 2020 2020 2020  VALUE4.         
-000207f0: 2020 2020 2020 2020 204b 4559 323a 2056           KEY2: V
-00020800: 414c 5545 320a 2020 2020 2020 2020 2020  ALUE2.          
-00020810: 2020 2020 2020 2020 4b45 5933 3a20 5641          KEY3: VA
-00020820: 4c55 4533 0a20 2020 2020 2020 2020 2020  LUE3.           
-00020830: 2020 2020 2062 6163 6b6f 6666 2d64 656c       backoff-del
-00020840: 6179 3a20 320a 2020 2020 2020 2020 2020  ay: 2.          
-00020850: 2020 2020 2020 6261 636b 6f66 662d 6661        backoff-fa
-00020860: 6374 6f72 3a20 330a 2020 2020 2020 2020  ctor: 3.        
-00020870: 2020 2020 2020 2020 6261 636b 6f66 662d          backoff-
-00020880: 6c69 6d69 743a 2032 0a20 2020 2020 2020  limit: 2.       
-00020890: 2020 2020 2027 2727 292c 2063 6f6d 6269       '''), combi
-000208a0: 6e65 3d54 7275 6529 0a20 2020 2020 2020  ne=True).       
-000208b0: 2070 6c61 6e20 3d20 636c 6965 6e74 2e67   plan = client.g
-000208c0: 6574 5f70 6c61 6e28 290a 2020 2020 2020  et_plan().      
-000208d0: 2020 2320 5468 6520 5941 4d4c 2073 686f    # The YAML sho
-000208e0: 756c 6420 6265 206e 6f72 6d61 6c69 7a65  uld be normalize
-000208f0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-00020900: 7373 6572 7445 7175 616c 2874 6578 7477  ssertEqual(textw
-00020910: 7261 702e 6465 6465 6e74 2827 2727 5c0a  rap.dedent('''\.
-00020920: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-00020930: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
-00020940: 2020 2020 7365 7276 3a0a 2020 2020 2020      serv:.      
-00020950: 2020 2020 2020 2020 2020 6166 7465 723a            after:
-00020960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020970: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
-00020980: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
-00020990: 6732 0a20 2020 2020 2020 2020 2020 2020  g2.             
-000209a0: 2020 2062 6163 6b6f 6666 2d64 656c 6179     backoff-delay
-000209b0: 3a20 320a 2020 2020 2020 2020 2020 2020  : 2.            
-000209c0: 2020 2020 6261 636b 6f66 662d 6661 6374      backoff-fact
-000209d0: 6f72 3a20 330a 2020 2020 2020 2020 2020  or: 3.          
-000209e0: 2020 2020 2020 6261 636b 6f66 662d 6c69        backoff-li
-000209f0: 6d69 743a 2032 0a20 2020 2020 2020 2020  mit: 2.         
-00020a00: 2020 2020 2020 2062 6566 6f72 653a 0a20         before:. 
-00020a10: 2020 2020 2020 2020 2020 2020 2020 202d                 -
-00020a20: 2074 6869 6e67 310a 2020 2020 2020 2020   thing1.        
-00020a30: 2020 2020 2020 2020 2d20 7468 696e 6732          - thing2
-00020a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020a50: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
-00020a60: 6368 6f20 6865 6c6c 6f0a 2020 2020 2020  cho hello.      
-00020a70: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-00020a80: 7074 696f 6e3a 2027 4120 6e65 7720 6465  ption: 'A new de
-00020a90: 7363 7269 7074 696f 6e20 6f66 2074 6865  scription of the
-00020aa0: 2074 6865 2061 6d61 7a69 6e67 2053 6572   the amazing Ser
-00020ab0: 7620 7365 7276 6963 652e 0a0a 2020 2020  v service...    
-00020ac0: 2020 2020 2020 2020 2020 2020 2020 270a                '.
-00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ae0: 656e 7669 726f 6e6d 656e 743a 0a20 2020  environment:.   
-00020af0: 2020 2020 2020 2020 2020 2020 2020 204b                 K
-00020b00: 4559 313a 2056 414c 5545 340a 2020 2020  EY1: VALUE4.    
-00020b10: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
-00020b20: 5932 3a20 5641 4c55 4532 0a20 2020 2020  Y2: VALUE2.     
-00020b30: 2020 2020 2020 2020 2020 2020 204b 4559               KEY
-00020b40: 333a 2056 414c 5545 330a 2020 2020 2020  3: VALUE3.      
-00020b50: 2020 2020 2020 2020 2020 6772 6f75 703a            group:
-00020b60: 2067 726f 7570 320a 2020 2020 2020 2020   group2.        
-00020b70: 2020 2020 2020 2020 6772 6f75 702d 6964          group-id
-00020b80: 3a20 6772 6f75 7049 4432 0a20 2020 2020  : groupID2.     
-00020b90: 2020 2020 2020 2020 2020 206f 6e2d 6368             on-ch
-00020ba0: 6563 6b2d 6661 696c 7572 653a 0a20 2020  eck-failure:.   
-00020bb0: 2020 2020 2020 2020 2020 2020 2020 204b                 K
-00020bc0: 4559 313a 2056 414c 5545 340a 2020 2020  EY1: VALUE4.    
-00020bd0: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
-00020be0: 5932 3a20 5641 4c55 4532 0a20 2020 2020  Y2: VALUE2.     
-00020bf0: 2020 2020 2020 2020 2020 2020 204b 4559               KEY
-00020c00: 333a 2056 414c 5545 330a 2020 2020 2020  3: VALUE3.      
-00020c10: 2020 2020 2020 2020 2020 6f6e 2d66 6169            on-fai
-00020c20: 6c75 7265 3a20 7468 696e 6732 0a20 2020  lure: thing2.   
-00020c30: 2020 2020 2020 2020 2020 2020 206f 6e2d               on-
-00020c40: 7375 6363 6573 733a 2074 6869 6e67 320a  success: thing2.
-00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c60: 6f76 6572 7269 6465 3a20 6d65 7267 650a  override: merge.
-00020c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c80: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
-00020c90: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
-00020ca0: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
-00020cb0: 2020 202d 2074 6869 6e67 320a 2020 2020     - thing2.    
-00020cc0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00020cd0: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
-00020ce0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-00020cf0: 6d61 7279 3a20 5365 7276 0a20 2020 2020  mary: Serv.     
-00020d00: 2020 2020 2020 2020 2020 2075 7365 723a             user:
-00020d10: 2075 7365 7232 0a20 2020 2020 2020 2020   user2.         
-00020d20: 2020 2020 2020 2075 7365 722d 6964 3a20         user-id: 
-00020d30: 7573 6572 4944 320a 2020 2020 2020 2020  userID2.        
-00020d40: 2020 2020 2727 2729 2c20 706c 616e 2e74      '''), plan.t
-00020d50: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
-00020d60: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
-00020d70: 725f 6e6f 745f 636f 6d62 696e 6564 2873  r_not_combined(s
-00020d80: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00020d90: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
-00020da0: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
-00020db0: 0a20 2020 2020 2020 2070 6c61 6e20 3d20  .        plan = 
-00020dc0: 636c 6965 6e74 2e67 6574 5f70 6c61 6e28  client.get_plan(
-00020dd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00020de0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-00020df0: 706c 616e 2c20 7065 6262 6c65 2e50 6c61  plan, pebble.Pla
-00020e00: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
-00020e10: 6173 7365 7274 4571 7561 6c28 277b 7d5c  assertEqual('{}\
-00020e20: 6e27 2c20 706c 616e 2e74 6f5f 7961 6d6c  n', plan.to_yaml
-00020e30: 2829 290a 2020 2020 2020 2020 7365 7276  ()).        serv
-00020e40: 6963 6520 3d20 7465 7874 7772 6170 2e64  ice = textwrap.d
-00020e50: 6564 656e 7428 2727 275c 0a20 2020 2020  edent('''\.     
-00020e60: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-00020e70: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
-00020e80: 6465 7363 7269 7074 696f 6e3a 207c 0a20  description: |. 
-00020e90: 2020 2020 2020 2020 2020 2020 2041 206c               A l
-00020ea0: 6f6e 6765 7220 6465 7363 7269 7074 696f  onger descriptio
-00020eb0: 6e20 6162 6f75 7420 466f 6f0a 2020 2020  n about Foo.    
-00020ec0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-00020ed0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020ee0: 7365 7276 3a0a 2020 2020 2020 2020 2020  serv:.          
-00020ef0: 2020 2020 2020 7375 6d6d 6172 793a 2053        summary: S
-00020f00: 6572 760a 2020 2020 2020 2020 2020 2020  erv.            
-00020f10: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-00020f20: 207c 0a20 2020 2020 2020 2020 2020 2020   |.             
-00020f30: 2020 2020 2041 2064 6573 6372 6970 7469       A descripti
-00020f40: 6f6e 2061 626f 7574 2053 6572 7620 7468  on about Serv th
-00020f50: 6520 616d 617a 696e 6720 7365 7276 6963  e amazing servic
-00020f60: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
-00020f70: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
-00020f80: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-00020f90: 2020 2020 6f76 6572 7269 6465 3a20 7265      override: re
-00020fa0: 706c 6163 650a 2020 2020 2020 2020 2020  place.          
-00020fb0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-00020fc0: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f27  /bin/echo hello'
-00020fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020fe0: 2065 6e76 6972 6f6e 6d65 6e74 3a0a 2020   environment:.  
-00020ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021000: 4b45 593a 2056 414c 5545 0a20 2020 2020  KEY: VALUE.     
-00021010: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00021020: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
-00021030: 6179 6572 2827 666f 6f27 2c20 7065 6262  ayer('foo', pebb
-00021040: 6c65 2e4c 6179 6572 2873 6572 7669 6365  le.Layer(service
-00021050: 2929 0a20 2020 2020 2020 2023 2054 4f44  )).        # TOD
-00021060: 4f3a 206a 616d 2032 3032 312d 3034 2d31  O: jam 2021-04-1
-00021070: 3920 5765 2073 686f 756c 6420 6861 7665  9 We should have
-00021080: 2061 2063 6c65 6172 6572 2065 7272 6f72   a clearer error
-00021090: 2074 7970 6520 666f 7220 7468 6973 2063   type for this c
-000210a0: 6173 652e 2054 6865 2061 6374 7561 6c0a  ase. The actual.
-000210b0: 2020 2020 2020 2020 2320 2070 6562 626c          #  pebbl
-000210c0: 6520 7261 6973 6573 2061 6e20 4854 5450  e raises an HTTP
-000210d0: 2065 7863 6570 7469 6f6e 2e20 5365 6520   exception. See 
-000210e0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-000210f0: 6f6d 2f63 616e 6f6e 6963 616c 2f6f 7065  om/canonical/ope
-00021100: 7261 746f 722f 6973 7375 6573 2f35 3134  rator/issues/514
-00021110: 0a20 2020 2020 2020 2023 2020 7468 6174  .        #  that
-00021120: 2074 6869 7320 7368 6f75 6c64 2062 6520   this should be 
-00021130: 636c 6561 6e65 6420 7570 2069 6e74 6f20  cleaned up into 
-00021140: 6120 636c 6561 7265 7220 6572 726f 7220  a clearer error 
-00021150: 7479 7065 2c20 686f 7765 7665 722c 2074  type, however, t
-00021160: 6865 7920 7368 6f75 6c64 2067 6574 2061  hey should get a
-00021170: 6e0a 2020 2020 2020 2020 2320 2065 7272  n.        #  err
-00021180: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
-00021190: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000211a0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-000211b0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-000211c0: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
-000211d0: 6f6f 272c 2070 6562 626c 652e 4c61 7965  oo', pebble.Laye
-000211e0: 7228 7365 7276 6963 6529 290a 0a20 2020  r(service))..   
-000211f0: 2064 6566 2074 6573 745f 6164 645f 6c61   def test_add_la
-00021200: 7965 725f 7468 7265 655f 7365 7276 6963  yer_three_servic
-00021210: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-00021220: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00021230: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
-00021240: 6e74 2829 0a20 2020 2020 2020 2063 6c69  nt().        cli
-00021250: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
-00021260: 6f6f 272c 2027 2727 5c0a 2020 2020 2020  oo', '''\.      
-00021270: 2020 2020 2020 7375 6d6d 6172 793a 2066        summary: f
-00021280: 6f6f 0a20 2020 2020 2020 2020 2020 2073  oo.            s
-00021290: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
-000212a0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-000212b0: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-000212c0: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
-000212d0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
-000212e0: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
-000212f0: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
-00021300: 6465 3a20 7265 706c 6163 650a 2020 2020  de: replace.    
-00021310: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00021320: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
-00021330: 666f 6f27 0a20 2020 2020 2020 2020 2020  foo'.           
-00021340: 2027 2727 290a 2020 2020 2020 2020 636c   ''').        cl
-00021350: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
-00021360: 6261 7227 2c20 2727 275c 0a20 2020 2020  bar', '''\.     
-00021370: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-00021380: 6261 720a 2020 2020 2020 2020 2020 2020  bar.            
-00021390: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
-000213a0: 2020 2020 2020 2020 6261 723a 0a20 2020          bar:.   
-000213b0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-000213c0: 6d61 7279 3a20 5468 6520 4772 6561 7420  mary: The Great 
-000213d0: 4261 720a 2020 2020 2020 2020 2020 2020  Bar.            
-000213e0: 2020 2020 7374 6172 7475 703a 2065 6e61      startup: ena
-000213f0: 626c 6564 0a20 2020 2020 2020 2020 2020  bled.           
-00021400: 2020 2020 206f 7665 7272 6964 653a 2072       override: r
-00021410: 6570 6c61 6365 0a20 2020 2020 2020 2020  eplace.         
-00021420: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-00021430: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
-00021440: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00021450: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-00021460: 6164 645f 6c61 7965 7228 2762 617a 272c  add_layer('baz',
-00021470: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
-00021480: 2020 7375 6d6d 6172 793a 2062 617a 0a20    summary: baz. 
-00021490: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-000214a0: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-000214b0: 2020 2062 617a 3a0a 2020 2020 2020 2020     baz:.        
-000214c0: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-000214d0: 204e 6f74 2042 6172 2c20 6275 7420 4261   Not Bar, but Ba
-000214e0: 7a0a 2020 2020 2020 2020 2020 2020 2020  z.              
-000214f0: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
-00021500: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-00021510: 2020 206f 7665 7272 6964 653a 2072 6570     override: rep
-00021520: 6c61 6365 0a20 2020 2020 2020 2020 2020  lace.           
-00021530: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-00021540: 6269 6e2f 6563 686f 2062 617a 270a 2020  bin/echo baz'.  
-00021550: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-00021560: 2020 2020 2020 2070 6c61 6e20 3d20 636c         plan = cl
-00021570: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
-00021580: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
-00021590: 4469 6666 203d 2031 3030 300a 2020 2020  Diff = 1000.    
-000215a0: 2020 2020 2320 416c 7068 6162 6574 6963      # Alphabetic
-000215b0: 616c 2073 6572 7669 6365 732c 2061 6e64  al services, and
-000215c0: 2074 6865 2059 414d 4c20 7368 6f75 6c64   the YAML should
-000215d0: 2062 6520 6e6f 726d 616c 697a 6564 0a20   be normalized. 
-000215e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000215f0: 7274 4571 7561 6c28 7465 7874 7772 6170  rtEqual(textwrap
-00021600: 2e64 6564 656e 7428 2727 275c 0a20 2020  .dedent('''\.   
-00021610: 2020 2020 2020 2020 2073 6572 7669 6365           service
-00021620: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00021630: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
-00021640: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
-00021650: 6269 6e2f 6563 686f 2062 6172 0a20 2020  bin/echo bar.   
-00021660: 2020 2020 2020 2020 2020 2020 206f 7665               ove
-00021670: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
-00021680: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021690: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
-000216a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216b0: 7375 6d6d 6172 793a 2054 6865 2047 7265  summary: The Gre
-000216c0: 6174 2042 6172 0a20 2020 2020 2020 2020  at Bar.         
-000216d0: 2020 2020 2062 617a 3a0a 2020 2020 2020       baz:.      
-000216e0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-000216f0: 643a 202f 6269 6e2f 6563 686f 2062 617a  d: /bin/echo baz
-00021700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021710: 206f 7665 7272 6964 653a 2072 6570 6c61   override: repla
-00021720: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
-00021730: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
-00021740: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-00021750: 2020 2020 7375 6d6d 6172 793a 204e 6f74      summary: Not
-00021760: 2042 6172 2c20 6275 7420 4261 7a0a 2020   Bar, but Baz.  
-00021770: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-00021780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021790: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
-000217a0: 6368 6f20 666f 6f0a 2020 2020 2020 2020  cho foo.        
-000217b0: 2020 2020 2020 2020 6f76 6572 7269 6465          override
-000217c0: 3a20 7265 706c 6163 650a 2020 2020 2020  : replace.      
-000217d0: 2020 2020 2020 2020 2020 7374 6172 7475            startu
-000217e0: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
-000217f0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00021800: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
-00021810: 2020 2020 2727 2729 2c20 706c 616e 2e74      '''), plan.t
-00021820: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
-00021830: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
-00021840: 725f 636f 6d62 696e 655f 6e6f 5f6f 7665  r_combine_no_ove
-00021850: 7272 6964 6528 7365 6c66 293a 0a20 2020  rride(self):.   
-00021860: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
-00021870: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
-00021880: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-00021890: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
-000218a0: 2827 666f 6f27 2c20 2727 275c 0a20 2020  ('foo', '''\.   
-000218b0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-000218c0: 3a20 666f 6f0a 2020 2020 2020 2020 2020  : foo.          
-000218d0: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
-000218e0: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
-000218f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021900: 756d 6d61 7279 3a20 466f 6f0a 2020 2020  ummary: Foo.    
-00021910: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00021920: 2027 2f62 696e 2f65 6368 6f20 666f 6f27   '/bin/echo foo'
-00021930: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00021940: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
-00021950: 3a20 6a61 6d20 3230 3231 2d30 342d 3139  : jam 2021-04-19
-00021960: 2050 6562 626c 6520 6375 7272 656e 746c   Pebble currentl
-00021970: 7920 7261 6973 6573 2061 2048 5454 5020  y raises a HTTP 
-00021980: 4572 726f 7220 3530 3020 496e 7465 726e  Error 500 Intern
-00021990: 616c 2053 6572 7669 6365 2045 7272 6f72  al Service Error
-000219a0: 0a20 2020 2020 2020 2023 2020 6966 2079  .        #  if y
-000219b0: 6f75 2064 6f6e 2774 2073 7570 706c 7920  ou don't supply 
-000219c0: 616e 206f 7665 7272 6964 6520 6469 7265  an override dire
-000219d0: 6374 6976 652e 2054 6861 7420 6e65 6564  ctive. That need
-000219e0: 7320 746f 2062 6520 6669 7865 6420 616e  s to be fixed an
-000219f0: 6420 7468 6973 2074 6573 740a 2020 2020  d this test.    
-00021a00: 2020 2020 2320 2073 686f 756c 6420 6265      #  should be
-00021a10: 2075 7064 6174 6564 2e20 6874 7470 733a   updated. https:
-00021a20: 2f2f 6769 7468 7562 2e63 6f6d 2f63 616e  //github.com/can
-00021a30: 6f6e 6963 616c 2f6f 7065 7261 746f 722f  onical/operator/
-00021a40: 6973 7375 6573 2f35 3134 0a20 2020 2020  issues/514.     
-00021a50: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00021a60: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-00021a70: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00021a80: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-00021a90: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-00021aa0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00021ab0: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-00021ac0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021ad0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
-00021ae0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
-00021af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b00: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-00021b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021b20: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-00021b30: 6269 6e2f 6563 686f 2066 6f6f 270a 2020  bin/echo foo'.  
-00021b40: 2020 2020 2020 2020 2020 2020 2020 2727                ''
-00021b50: 272c 2063 6f6d 6269 6e65 3d54 7275 6529  ', combine=True)
-00021b60: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-00021b70: 6464 5f6c 6179 6572 5f63 6f6d 6269 6e65  dd_layer_combine
-00021b80: 5f6f 7665 7272 6964 655f 7265 706c 6163  _override_replac
-00021b90: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00021ba0: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-00021bb0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-00021bc0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-00021bd0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-00021be0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-00021bf0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-00021c00: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-00021c10: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-00021c20: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
-00021c30: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00021c40: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
-00021c50: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00021c60: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
-00021c70: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-00021c80: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-00021c90: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-00021ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021cb0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-00021cc0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
-00021cd0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00021ce0: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
-00021cf0: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
-00021d00: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00021d10: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
-00021d20: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-00021d30: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
-00021d40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021d50: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00021d60: 2f65 6368 6f20 666f 6f20 6e65 7727 0a20  /echo foo new'. 
-00021d70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00021d80: 7665 7272 6964 653a 2072 6570 6c61 6365  verride: replace
-00021d90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00021da0: 2c20 636f 6d62 696e 653d 5472 7565 290a  , combine=True).
-00021db0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00021dc0: 6572 7445 7175 616c 2874 6578 7477 7261  ertEqual(textwra
-00021dd0: 702e 6465 6465 6e74 2827 2727 5c0a 2020  p.dedent('''\.  
-00021de0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
-00021df0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00021e00: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
-00021e10: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-00021e20: 2f62 696e 2f65 6368 6f20 6261 720a 2020  /bin/echo bar.  
-00021e30: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00021e40: 6d6d 6172 793a 2042 6172 0a20 2020 2020  mmary: Bar.     
-00021e50: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
-00021e60: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00021e70: 6d6d 616e 643a 202f 6269 6e2f 6563 686f  mmand: /bin/echo
-00021e80: 2066 6f6f 206e 6577 0a20 2020 2020 2020   foo new.       
-00021e90: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
-00021ea0: 653a 2072 6570 6c61 6365 0a20 2020 2020  e: replace.     
-00021eb0: 2020 2020 2020 2027 2727 292c 2063 6c69         '''), cli
-00021ec0: 656e 742e 6765 745f 706c 616e 2829 2e74  ent.get_plan().t
-00021ed0: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
-00021ee0: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
-00021ef0: 725f 636f 6d62 696e 655f 6f76 6572 7269  r_combine_overri
-00021f00: 6465 5f6d 6572 6765 2873 656c 6629 3a0a  de_merge(self):.
-00021f10: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00021f20: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
-00021f30: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
-00021f40: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
-00021f50: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
-00021f60: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00021f70: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
-00021f80: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-00021f90: 2020 2020 2020 2020 2020 2020 2062 6172               bar
-00021fa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021fb0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
-00021fc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00021fd0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-00021fe0: 686f 2062 6172 270a 2020 2020 2020 2020  ho bar'.        
-00021ff0: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-00022000: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00022010: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
-00022020: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00022030: 2027 2f62 696e 2f65 6368 6f20 666f 6f27   '/bin/echo foo'
-00022040: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00022050: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00022060: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
-00022070: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
-00022080: 2020 2073 756d 6d61 7279 3a20 666f 6f0a     summary: foo.
-00022090: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-000220a0: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
-000220b0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-000220c0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-000220d0: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
-000220e0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-000220f0: 2f62 696e 2f65 6368 6f20 666f 6f62 270a  /bin/echo foob'.
-00022100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022110: 6f76 6572 7269 6465 3a20 6d65 7267 650a  override: merge.
-00022120: 2020 2020 2020 2020 2020 2020 2727 272c              ''',
-00022130: 2063 6f6d 6269 6e65 3d54 7275 6529 0a20   combine=True). 
-00022140: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00022150: 7274 4571 7561 6c28 7465 7874 7772 6170  rtEqual(textwrap
-00022160: 2e64 6564 656e 7428 2727 275c 0a20 2020  .dedent('''\.   
-00022170: 2020 2020 2020 2020 2073 6572 7669 6365           service
-00022180: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00022190: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
-000221a0: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
-000221b0: 6269 6e2f 6563 686f 2062 6172 0a20 2020  bin/echo bar.   
-000221c0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-000221d0: 6d61 7279 3a20 4261 720a 2020 2020 2020  mary: Bar.      
-000221e0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-000221f0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00022200: 6d61 6e64 3a20 2f62 696e 2f65 6368 6f20  mand: /bin/echo 
-00022210: 666f 6f62 0a20 2020 2020 2020 2020 2020  foob.           
-00022220: 2020 2020 206f 7665 7272 6964 653a 206d       override: m
-00022230: 6572 6765 0a20 2020 2020 2020 2020 2020  erge.           
-00022240: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
-00022250: 6f0a 2020 2020 2020 2020 2020 2020 2727  o.            ''
-00022260: 2729 2c20 636c 6965 6e74 2e67 6574 5f70  '), client.get_p
-00022270: 6c61 6e28 292e 746f 5f79 616d 6c28 2929  lan().to_yaml())
-00022280: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-00022290: 6464 5f6c 6179 6572 5f63 6f6d 6269 6e65  dd_layer_combine
-000222a0: 5f6f 7665 7272 6964 655f 756e 6b6e 6f77  _override_unknow
-000222b0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-000222c0: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-000222d0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-000222e0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-000222f0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-00022300: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-00022310: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-00022320: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-00022330: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-00022340: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
-00022350: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00022360: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
-00022370: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00022380: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
-00022390: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-000223a0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-000223b0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-000223c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000223d0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-000223e0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
-000223f0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00022400: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00022410: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-00022420: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00022430: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-00022440: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-00022450: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00022460: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-00022470: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022480: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
-00022490: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
-000224a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000224b0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-000224c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000224d0: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-000224e0: 6269 6e2f 6563 686f 2066 6f6f 6227 0a20  bin/echo foob'. 
-000224f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022500: 2020 206f 7665 7272 6964 653a 2062 6c61     override: bla
-00022510: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-00022520: 2020 2727 272c 2063 6f6d 6269 6e65 3d54    ''', combine=T
-00022530: 7275 6529 0a0a 2020 2020 6465 6620 7465  rue)..    def te
-00022540: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
-00022550: 6e6f 6e65 2873 656c 6629 3a0a 2020 2020  none(self):.    
-00022560: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
-00022570: 662e 6765 745f 7465 7374 696e 675f 636c  f.get_testing_cl
-00022580: 6965 6e74 2829 0a20 2020 2020 2020 2073  ient().        s
-00022590: 6572 7669 6365 5f69 6e66 6f20 3d20 636c  ervice_info = cl
-000225a0: 6965 6e74 2e67 6574 5f73 6572 7669 6365  ient.get_service
-000225b0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-000225c0: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
-000225d0: 2073 6572 7669 6365 5f69 6e66 6f29 0a0a   service_info)..
-000225e0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-000225f0: 5f73 6572 7669 6365 735f 6e6f 745f 7374  _services_not_st
-00022600: 6172 7465 6428 7365 6c66 293a 0a20 2020  arted(self):.   
-00022610: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
-00022620: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
-00022630: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-00022640: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
-00022650: 2827 666f 6f27 2c20 2727 275c 0a20 2020  ('foo', '''\.   
-00022660: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-00022670: 3a20 666f 6f0a 2020 2020 2020 2020 2020  : foo.          
-00022680: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
-00022690: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
-000226a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000226b0: 756d 6d61 7279 3a20 466f 6f0a 2020 2020  ummary: Foo.    
-000226c0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000226d0: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
-000226e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-000226f0: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
-00022700: 2066 6f6f 270a 2020 2020 2020 2020 2020   foo'.          
-00022710: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
-00022720: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-00022730: 3a20 4261 720a 2020 2020 2020 2020 2020  : Bar.          
-00022740: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-00022750: 2f62 696e 2f65 6368 6f20 6261 7227 0a20  /bin/echo bar'. 
-00022760: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00022770: 2020 2020 2020 2020 696e 666f 7320 3d20          infos = 
-00022780: 636c 6965 6e74 2e67 6574 5f73 6572 7669  client.get_servi
-00022790: 6365 7328 290a 2020 2020 2020 2020 7365  ces().        se
-000227a0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-000227b0: 656e 2869 6e66 6f73 292c 2032 290a 2020  en(infos), 2).  
-000227c0: 2020 2020 2020 6261 725f 696e 666f 203d        bar_info =
-000227d0: 2069 6e66 6f73 5b30 5d0a 2020 2020 2020   infos[0].      
-000227e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000227f0: 616c 2827 6261 7227 2c20 6261 725f 696e  al('bar', bar_in
-00022800: 666f 2e6e 616d 6529 0a20 2020 2020 2020  fo.name).       
-00022810: 2023 2044 6566 6175 6c74 2077 6865 6e20   # Default when 
-00022820: 6e6f 7420 7370 6563 6966 6965 6420 6973  not specified is
-00022830: 2044 4953 4142 4c45 440a 2020 2020 2020   DISABLED.      
-00022840: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00022850: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
-00022860: 6553 7461 7274 7570 2e44 4953 4142 4c45  eStartup.DISABLE
-00022870: 442c 2062 6172 5f69 6e66 6f2e 7374 6172  D, bar_info.star
-00022880: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-00022890: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-000228a0: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-000228b0: 7573 2e49 4e41 4354 4956 452c 2062 6172  us.INACTIVE, bar
-000228c0: 5f69 6e66 6f2e 6375 7272 656e 7429 0a20  _info.current). 
-000228d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000228e0: 7274 4661 6c73 6528 6261 725f 696e 666f  rtFalse(bar_info
-000228f0: 2e69 735f 7275 6e6e 696e 6728 2929 0a20  .is_running()). 
-00022900: 2020 2020 2020 2066 6f6f 5f69 6e66 6f20         foo_info 
-00022910: 3d20 696e 666f 735b 315d 0a20 2020 2020  = infos[1].     
-00022920: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022930: 7561 6c28 2766 6f6f 272c 2066 6f6f 5f69  ual('foo', foo_i
-00022940: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
-00022950: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00022960: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
-00022970: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
-00022980: 2c20 666f 6f5f 696e 666f 2e73 7461 7274  , foo_info.start
-00022990: 7570 290a 2020 2020 2020 2020 7365 6c66  up).        self
-000229a0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-000229b0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-000229c0: 732e 494e 4143 5449 5645 2c20 666f 6f5f  s.INACTIVE, foo_
-000229d0: 696e 666f 2e63 7572 7265 6e74 290a 2020  info.current).  
-000229e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000229f0: 7446 616c 7365 2866 6f6f 5f69 6e66 6f2e  tFalse(foo_info.
-00022a00: 6973 5f72 756e 6e69 6e67 2829 290a 0a20  is_running()).. 
-00022a10: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-00022a20: 7365 7276 6963 6573 5f61 7574 6f73 7461  services_autosta
-00022a30: 7274 2873 656c 6629 3a0a 2020 2020 2020  rt(self):.      
-00022a40: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00022a50: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
-00022a60: 6e74 2829 0a20 2020 2020 2020 2063 6c69  nt().        cli
-00022a70: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
-00022a80: 6f6f 272c 2027 2727 5c0a 2020 2020 2020  oo', '''\.      
-00022a90: 2020 2020 2020 7375 6d6d 6172 793a 2066        summary: f
-00022aa0: 6f6f 0a20 2020 2020 2020 2020 2020 2073  oo.            s
-00022ab0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
-00022ac0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-00022ad0: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00022ae0: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
-00022af0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
-00022b00: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
+000186e0: 2027 7265 6c61 7469 6f6e 5f69 6427 3a20   'relation_id': 
+000186f0: 7265 6c5f 6964 2c0a 2020 2020 2020 2020  rel_id,.        
+00018700: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00018710: 6974 273a 204e 6f6e 652c 0a20 2020 2020  it': None,.     
+00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018730: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
+00018740: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
+00018750: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+00018760: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+00018770: 273a 2027 6c65 6164 6572 2d65 6c65 6374  ': 'leader-elect
+00018780: 6564 277d 2c0a 2020 2020 2020 2020 2020  ed'},.          
+00018790: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+000187a0: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
+000187b0: 2027 6461 7461 273a 207b 7d7d 2c0a 2020   'data': {}},.  
+000187c0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+000187d0: 6e61 6d65 273a 2027 7374 6172 7427 7d2c  name': 'start'},
+000187e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000187f0: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
+00018800: 696f 6e2d 6368 616e 6765 6427 2c0a 2020  ion-changed',.  
+00018810: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00018820: 7265 6c61 7469 6f6e 273a 2027 6462 272c  relation': 'db',
+00018830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018840: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
+00018850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018860: 2027 7265 6c61 7469 6f6e 5f69 6427 3a20   'relation_id': 
+00018870: 7265 6c5f 6964 2c0a 2020 2020 2020 2020  rel_id,.        
+00018880: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00018890: 6974 273a 204e 6f6e 652c 0a20 2020 2020  it': None,.     
+000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188b0: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
+000188c0: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
+000188d0: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+000188e0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+000188f0: 273a 2027 7265 6c61 7469 6f6e 2d6a 6f69  ': 'relation-joi
+00018900: 6e65 6427 2c0a 2020 2020 2020 2020 2020  ned',.          
+00018910: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00018920: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+00018930: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
+00018940: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00018950: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00018960: 6f6e 5f69 6427 3a20 7265 6c5f 6964 2c0a  on_id': rel_id,.
+00018970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018980: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
+00018990: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
+000189a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189b0: 2020 2761 7070 273a 2027 706f 7374 6772    'app': 'postgr
+000189c0: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
+000189d0: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
+000189e0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+000189f0: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+00018a00: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
+00018a10: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00018a20: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+00018a30: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+00018a40: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+00018a50: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00018a60: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
+00018a70: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00018a80: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
+00018a90: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
+00018aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ab0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00018ac0: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00018ad0: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+00018ae0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00018af0: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+00018b00: 732e 6368 6172 6d2e 6368 616e 6765 7329  s.charm.changes)
+00018b10: 0a0a 2020 2020 6465 6620 7465 7374 5f62  ..    def test_b
+00018b20: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+00018b30: 6c5f 686f 6f6b 735f 7769 7468 5f6d 756c  l_hooks_with_mul
+00018b40: 7469 706c 655f 756e 6974 7328 7365 6c66  tiple_units(self
+00018b50: 293a 0a20 2020 2020 2020 2063 6c61 7373  ):.        class
+00018b60: 2043 6861 726d 5769 7468 4442 2852 656c   CharmWithDB(Rel
+00018b70: 6174 696f 6e45 7665 6e74 4368 6172 6d29  ationEventCharm)
+00018b80: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+00018b90: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00018ba0: 2066 7261 6d65 776f 726b 293a 0a20 2020   framework):.   
+00018bb0: 2020 2020 2020 2020 2020 2020 2073 7570               sup
+00018bc0: 6572 2829 2e5f 5f69 6e69 745f 5f28 6672  er().__init__(fr
+00018bd0: 616d 6577 6f72 6b29 0a20 2020 2020 2020  amework).       
+00018be0: 2020 2020 2020 2020 2073 656c 662e 6f62           self.ob
+00018bf0: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
+00018c00: 7665 6e74 7328 2764 6227 290a 2020 2020  vents('db').    
+00018c10: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+00018c20: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+00018c30: 7328 4368 6172 6d57 6974 6844 422c 206d  s(CharmWithDB, m
+00018c40: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+00018c50: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+00018c60: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
+00018c70: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
+00018c80: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00018c90: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00018ca0: 6661 6365 3a20 7371 6c0a 2020 2020 2020  face: sql.      
+00018cb0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00018cc0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00018cd0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00018ce0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+00018cf0: 6573 732e 7365 745f 6c65 6164 6572 2829  ess.set_leader()
+00018d00: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
+00018d10: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
+00018d20: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
+00018d30: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
+00018d40: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+00018d50: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00018d60: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+00018d70: 2f31 2729 0a20 2020 2020 2020 2068 6172  /1').        har
+00018d80: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00018d90: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00018da0: 2c20 2770 6f73 7467 7265 7371 6c2f 3127  , 'postgresql/1'
+00018db0: 2c20 7b27 6e65 7727 3a20 2764 6174 6127  , {'new': 'data'
+00018dc0: 7d29 0a20 2020 2020 2020 2023 2057 6520  }).        # We 
+00018dd0: 696e 7465 6e74 696f 6e61 6c6c 7920 6164  intentionally ad
+00018de0: 6420 3020 6166 7465 7220 3120 746f 2061  d 0 after 1 to a
+00018df0: 7373 6572 7420 7468 6174 2074 6865 2063  ssert that the c
+00018e00: 6f64 6520 7472 6967 6765 7273 2074 6865  ode triggers the
+00018e10: 6d20 696e 206f 7264 6572 0a20 2020 2020  m in order.     
+00018e20: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+00018e30: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00018e40: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+00018e50: 2f30 2729 0a20 2020 2020 2020 2068 6172  /0').        har
+00018e60: 6e65 7373 2e62 6567 696e 5f77 6974 685f  ness.begin_with_
+00018e70: 696e 6974 6961 6c5f 686f 6f6b 7328 290a  initial_hooks().
+00018e80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018e90: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00018ea0: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+00018eb0: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
+00018ec0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00018ed0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00018ee0: 6527 3a20 2769 6e73 7461 6c6c 277d 2c0a  e': 'install'},.
+00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f00: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00018f10: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00018f30: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
+00018f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f50: 2027 6461 7461 273a 207b 0a20 2020 2020   'data': {.     
+00018f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f70: 2772 656c 6174 696f 6e5f 6964 273a 2072  'relation_id': r
+00018f80: 656c 5f69 642c 0a20 2020 2020 2020 2020  el_id,.         
+00018f90: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
+00018fa0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00018fb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00018fc0: 6170 7027 3a20 2770 6f73 7467 7265 7371  app': 'postgresq
+00018fd0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00018fe0: 2020 2020 207d 7d2c 0a20 2020 2020 2020       }},.       
+00018ff0: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00019000: 3a20 276c 6561 6465 722d 656c 6563 7465  : 'leader-electe
+00019010: 6427 7d2c 0a20 2020 2020 2020 2020 2020  d'},.           
+00019020: 2020 2020 207b 276e 616d 6527 3a20 2763       {'name': 'c
+00019030: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
+00019040: 2764 6174 6127 3a20 7b7d 7d2c 0a20 2020  'data': {}},.   
+00019050: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
+00019060: 616d 6527 3a20 2773 7461 7274 277d 2c0a  ame': 'start'},.
+00019070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019080: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00019090: 6f6e 2d6a 6f69 6e65 6427 2c0a 2020 2020  on-joined',.    
+000190a0: 2020 2020 2020 2020 2020 2020 2027 7265               're
+000190b0: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+000190c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190d0: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
+000190e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000190f0: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
+00019100: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
+00019110: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
+00019120: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
+00019130: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00019140: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
+00019150: 706f 7374 6772 6573 716c 272c 0a20 2020  postgresql',.   
+00019160: 2020 2020 2020 2020 2020 2020 2020 7d7d                }}
+00019170: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019180: 2020 7b27 6e61 6d65 273a 2027 7265 6c61    {'name': 'rela
+00019190: 7469 6f6e 2d63 6861 6e67 6564 272c 0a20  tion-changed',. 
+000191a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191b0: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
+000191c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000191d0: 2020 2027 6461 7461 273a 207b 0a20 2020     'data': {.   
+000191e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191f0: 2020 2772 656c 6174 696f 6e5f 6964 273a    'relation_id':
+00019200: 2072 656c 5f69 642c 0a20 2020 2020 2020   rel_id,.       
+00019210: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+00019220: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
+00019230: 6c2f 3027 2c0a 2020 2020 2020 2020 2020  l/0',.          
+00019240: 2020 2020 2020 2020 2020 2027 6170 7027             'app'
+00019250: 3a20 2770 6f73 7467 7265 7371 6c27 2c0a  : 'postgresql',.
+00019260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019270: 207d 7d2c 0a20 2020 2020 2020 2020 2020   }},.           
+00019280: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+00019290: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
+000192a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000192b0: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
+000192c0: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+000192d0: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
+000192e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192f0: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00019300: 273a 2072 656c 5f69 642c 0a20 2020 2020  ': rel_id,.     
+00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019320: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
+00019330: 7371 6c2f 3127 2c0a 2020 2020 2020 2020  sql/1',.        
+00019340: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+00019350: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
+00019360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019370: 2020 207d 7d2c 0a20 2020 2020 2020 2020     }},.         
+00019380: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00019390: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
+000193a0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+000193b0: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
+000193c0: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
+000193d0: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+000193e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000193f0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00019400: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+00019410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019420: 2020 2027 756e 6974 273a 2027 706f 7374     'unit': 'post
+00019430: 6772 6573 716c 2f31 272c 0a20 2020 2020  gresql/1',.     
+00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019450: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
+00019460: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
+00019470: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+00019480: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+00019490: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
+000194a0: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
+000194b0: 6d75 6c74 6970 6c65 5f72 656c 6174 696f  multiple_relatio
+000194c0: 6e5f 7361 6d65 5f65 6e64 706f 696e 7428  n_same_endpoint(
+000194d0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+000194e0: 6c61 7373 2043 6861 726d 5769 7468 4442  lass CharmWithDB
+000194f0: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
+00019500: 6172 6d29 3a0a 2020 2020 2020 2020 2020  arm):.          
+00019510: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00019520: 656c 662c 2066 7261 6d65 776f 726b 293a  elf, framework):
+00019530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019540: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00019550: 5f28 6672 616d 6577 6f72 6b29 0a20 2020  _(framework).   
+00019560: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00019570: 662e 6f62 7365 7276 655f 7265 6c61 7469  f.observe_relati
+00019580: 6f6e 5f65 7665 6e74 7328 2764 6227 290a  on_events('db').
+00019590: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+000195a0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+000195b0: 726e 6573 7328 4368 6172 6d57 6974 6844  rness(CharmWithD
+000195c0: 422c 206d 6574 613d 2727 270a 2020 2020  B, meta='''.    
+000195d0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+000195e0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+000195f0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
+00019600: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00019610: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019620: 6e74 6572 6661 6365 3a20 7371 6c0a 2020  nterface: sql.  
+00019630: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+00019640: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+00019650: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+00019660: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+00019670: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
+00019680: 6572 2829 0a20 2020 2020 2020 2072 656c  er().        rel
+00019690: 5f69 645f 6120 3d20 6861 726e 6573 732e  _id_a = harness.
+000196a0: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+000196b0: 272c 2027 7067 2d61 2729 0a20 2020 2020  ', 'pg-a').     
+000196c0: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+000196d0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+000196e0: 5f69 645f 612c 2027 7067 2d61 2f30 2729  _id_a, 'pg-a/0')
+000196f0: 0a20 2020 2020 2020 2072 656c 5f69 645f  .        rel_id_
+00019700: 6220 3d20 6861 726e 6573 732e 6164 645f  b = harness.add_
+00019710: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+00019720: 7067 2d62 2729 0a20 2020 2020 2020 2068  pg-b').        h
+00019730: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00019740: 696f 6e5f 756e 6974 2872 656c 5f69 645f  ion_unit(rel_id_
+00019750: 622c 2027 7067 2d62 2f30 2729 0a20 2020  b, 'pg-b/0').   
+00019760: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+00019770: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
+00019780: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
+00019790: 6368 616e 6765 7320 3d20 6861 726e 6573  changes = harnes
+000197a0: 732e 6368 6172 6d2e 6368 616e 6765 735b  s.charm.changes[
+000197b0: 3a5d 0a20 2020 2020 2020 2065 7870 6563  :].        expec
+000197c0: 7465 645f 7072 6566 6978 203d 205b 0a20  ted_prefix = [. 
+000197d0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+000197e0: 6527 3a20 2769 6e73 7461 6c6c 277d 2c0a  e': 'install'},.
+000197f0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00019800: 2020 2320 5468 6520 6669 7273 7420 6576    # The first ev
+00019810: 656e 7473 2061 7265 2061 6c77 6179 7320  ents are always 
+00019820: 7468 6520 7361 6d65 0a20 2020 2020 2020  the same.       
+00019830: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00019840: 6c28 6368 616e 6765 735b 3a6c 656e 2865  l(changes[:len(e
+00019850: 7870 6563 7465 645f 7072 6566 6978 295d  xpected_prefix)]
+00019860: 2c20 6578 7065 6374 6564 5f70 7265 6669  , expected_prefi
+00019870: 7829 0a20 2020 2020 2020 2063 6861 6e67  x).        chang
+00019880: 6573 203d 2063 6861 6e67 6573 5b6c 656e  es = changes[len
+00019890: 2865 7870 6563 7465 645f 7072 6566 6978  (expected_prefix
+000198a0: 293a 5d0a 2020 2020 2020 2020 2320 486f  ):].        # Ho
+000198b0: 7765 7665 722c 2074 6865 206f 7264 6572  wever, the order
+000198c0: 206f 6620 7265 6c61 7469 6f6e 2d63 7265   of relation-cre
+000198d0: 6174 6564 2065 7665 6e74 7320 6361 6e20  ated events can 
+000198e0: 6265 2069 6e20 616e 7920 6f72 6465 720a  be in any order.
+000198f0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+00019900: 5f72 656c 6174 696f 6e5f 6372 6561 7465  _relation_create
+00019910: 6420 3d20 5b0a 2020 2020 2020 2020 2020  d = [.          
+00019920: 2020 7b27 6e61 6d65 273a 2027 7265 6c61    {'name': 'rela
+00019930: 7469 6f6e 2d63 7265 6174 6564 272c 0a20  tion-created',. 
+00019940: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00019950: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
+00019960: 2020 2020 2020 2020 2020 2027 6461 7461             'data
+00019970: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00019980: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
+00019990: 6964 273a 2072 656c 5f69 645f 612c 0a20  id': rel_id_a,. 
+000199a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199b0: 2775 6e69 7427 3a20 4e6f 6e65 2c0a 2020  'unit': None,.  
+000199c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000199d0: 6170 7027 3a20 2770 672d 6127 2c0a 2020  app': 'pg-a',.  
+000199e0: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+000199f0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00019a00: 6527 3a20 2772 656c 6174 696f 6e2d 6372  e': 'relation-cr
+00019a10: 6561 7465 6427 2c0a 2020 2020 2020 2020  eated',.        
+00019a20: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
+00019a30: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
+00019a40: 2020 2020 2764 6174 6127 3a20 7b0a 2020      'data': {.  
+00019a50: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00019a60: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
+00019a70: 6c5f 6964 5f62 2c0a 2020 2020 2020 2020  l_id_b,.        
+00019a80: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
+00019a90: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00019aa0: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
+00019ab0: 7067 2d62 272c 0a20 2020 2020 2020 2020  pg-b',.         
+00019ac0: 2020 2020 7d7d 2c0a 2020 2020 2020 2020      }},.        
+00019ad0: 5d0a 2020 2020 2020 2020 6966 2063 6861  ].        if cha
+00019ae0: 6e67 6573 5b3a 325d 2021 3d20 6578 7065  nges[:2] != expe
+00019af0: 6374 6564 5f72 656c 6174 696f 6e5f 6372  cted_relation_cr
+00019b00: 6561 7465 643a 0a20 2020 2020 2020 2020  eated:.         
+00019b10: 2020 2023 2063 6861 6e67 6520 7468 6520     # change the 
+00019b20: 6f72 6465 720a 2020 2020 2020 2020 2020  order.          
+00019b30: 2020 6578 7065 6374 6564 5f72 656c 6174    expected_relat
+00019b40: 696f 6e5f 6372 6561 7465 6420 3d20 5b65  ion_created = [e
+00019b50: 7870 6563 7465 645f 7265 6c61 7469 6f6e  xpected_relation
+00019b60: 5f63 7265 6174 6564 5b31 5d2c 0a20 2020  _created[1],.   
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b90: 2020 2020 2020 6578 7065 6374 6564 5f72        expected_r
+00019ba0: 656c 6174 696f 6e5f 6372 6561 7465 645b  elation_created[
+00019bb0: 305d 5d0a 2020 2020 2020 2020 7365 6c66  0]].        self
+00019bc0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+00019bd0: 6e67 6573 5b3a 325d 2c20 6578 7065 6374  nges[:2], expect
+00019be0: 6564 5f72 656c 6174 696f 6e5f 6372 6561  ed_relation_crea
+00019bf0: 7465 6429 0a20 2020 2020 2020 2063 6861  ted).        cha
+00019c00: 6e67 6573 203d 2063 6861 6e67 6573 5b32  nges = changes[2
+00019c10: 3a5d 0a20 2020 2020 2020 2065 7870 6563  :].        expec
+00019c20: 7465 645f 6d69 6464 6c65 203d 205b 0a20  ted_middle = [. 
+00019c30: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00019c40: 6527 3a20 276c 6561 6465 722d 656c 6563  e': 'leader-elec
+00019c50: 7465 6427 7d2c 0a20 2020 2020 2020 2020  ted'},.         
+00019c60: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
+00019c70: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
+00019c80: 6174 6127 3a20 7b7d 7d2c 0a20 2020 2020  ata': {}},.     
+00019c90: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00019ca0: 2773 7461 7274 277d 2c0a 2020 2020 2020  'start'},.      
+00019cb0: 2020 5d0a 2020 2020 2020 2020 7365 6c66    ].        self
+00019cc0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+00019cd0: 6e67 6573 5b3a 6c65 6e28 6578 7065 6374  nges[:len(expect
+00019ce0: 6564 5f6d 6964 646c 6529 5d2c 2065 7870  ed_middle)], exp
+00019cf0: 6563 7465 645f 6d69 6464 6c65 290a 2020  ected_middle).  
+00019d00: 2020 2020 2020 6368 616e 6765 7320 3d20        changes = 
+00019d10: 6368 616e 6765 735b 6c65 6e28 6578 7065  changes[len(expe
+00019d20: 6374 6564 5f6d 6964 646c 6529 3a5d 0a20  cted_middle):]. 
+00019d30: 2020 2020 2020 2061 5f66 6972 7374 203d         a_first =
+00019d40: 205b 0a20 2020 2020 2020 2020 2020 207b   [.            {
+00019d50: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
+00019d60: 6e2d 6a6f 696e 6564 272c 0a20 2020 2020  n-joined',.     
+00019d70: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
+00019d80: 6e27 3a20 2764 6227 2c0a 2020 2020 2020  n': 'db',.      
+00019d90: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
+00019da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019db0: 2020 2772 656c 6174 696f 6e5f 6964 273a    'relation_id':
+00019dc0: 2072 656c 5f69 645f 612c 0a20 2020 2020   rel_id_a,.     
+00019dd0: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
+00019de0: 7427 3a20 2770 672d 612f 3027 2c0a 2020  t': 'pg-a/0',.  
+00019df0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00019e00: 6170 7027 3a20 2770 672d 6127 2c0a 2020  app': 'pg-a',.  
+00019e10: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+00019e20: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00019e30: 6527 3a20 2772 656c 6174 696f 6e2d 6368  e': 'relation-ch
+00019e40: 616e 6765 6427 2c0a 2020 2020 2020 2020  anged',.        
+00019e50: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
+00019e60: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
+00019e70: 2020 2020 2764 6174 6127 3a20 7b0a 2020      'data': {.  
+00019e80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00019e90: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
+00019ea0: 6c5f 6964 5f61 2c0a 2020 2020 2020 2020  l_id_a,.        
+00019eb0: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
+00019ec0: 2027 7067 2d61 2f30 272c 0a20 2020 2020   'pg-a/0',.     
+00019ed0: 2020 2020 2020 2020 2020 2020 2761 7070              'app
+00019ee0: 273a 2027 7067 2d61 272c 0a20 2020 2020  ': 'pg-a',.     
+00019ef0: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
+00019f00: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00019f10: 2027 7265 6c61 7469 6f6e 2d6a 6f69 6e65   'relation-joine
+00019f20: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00019f30: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
+00019f40: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00019f50: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
+00019f60: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
+00019f70: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
+00019f80: 5f62 2c0a 2020 2020 2020 2020 2020 2020  _b,.            
+00019f90: 2020 2020 2027 756e 6974 273a 2027 7067       'unit': 'pg
+00019fa0: 2d62 2f30 272c 0a20 2020 2020 2020 2020  -b/0',.         
+00019fb0: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
+00019fc0: 7067 2d62 272c 0a20 2020 2020 2020 2020  pg-b',.         
+00019fd0: 2020 2020 7d7d 2c0a 2020 2020 2020 2020      }},.        
+00019fe0: 2020 2020 7b27 6e61 6d65 273a 2027 7265      {'name': 're
+00019ff0: 6c61 7469 6f6e 2d63 6861 6e67 6564 272c  lation-changed',
+0001a000: 0a20 2020 2020 2020 2020 2020 2020 2772  .             'r
+0001a010: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
+0001a020: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+0001a030: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+0001a040: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
+0001a050: 6e5f 6964 273a 2072 656c 5f69 645f 622c  n_id': rel_id_b,
+0001a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a070: 2020 2775 6e69 7427 3a20 2770 672d 622f    'unit': 'pg-b/
+0001a080: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001a090: 2020 2020 2027 6170 7027 3a20 2770 672d       'app': 'pg-
+0001a0a0: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+0001a0b0: 207d 7d2c 0a20 2020 2020 2020 205d 0a20   }},.        ]. 
+0001a0c0: 2020 2020 2020 2069 6620 6368 616e 6765         if change
+0001a0d0: 7320 213d 2061 5f66 6972 7374 3a0a 2020  s != a_first:.  
+0001a0e0: 2020 2020 2020 2020 2020 625f 6669 7273            b_firs
+0001a0f0: 7420 3d20 5b61 5f66 6972 7374 5b32 5d2c  t = [a_first[2],
+0001a100: 2061 5f66 6972 7374 5b33 5d2c 2061 5f66   a_first[3], a_f
+0001a110: 6972 7374 5b30 5d2c 2061 5f66 6972 7374  irst[0], a_first
+0001a120: 5b31 5d5d 0a20 2020 2020 2020 2020 2020  [1]].           
+0001a130: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a140: 6c28 6368 616e 6765 732c 2062 5f66 6972  l(changes, b_fir
+0001a150: 7374 290a 0a20 2020 2064 6566 2074 6573  st)..    def tes
+0001a160: 745f 6265 6769 6e5f 7769 7468 5f69 6e69  t_begin_with_ini
+0001a170: 7469 616c 5f68 6f6f 6b73 5f75 6e6b 6e6f  tial_hooks_unkno
+0001a180: 776e 5f73 7461 7475 7328 7365 6c66 293a  wn_status(self):
+0001a190: 0a20 2020 2020 2020 2023 2056 6572 6966  .        # Verif
+0001a1a0: 7920 7468 6174 2061 2063 6861 726d 2074  y that a charm t
+0001a1b0: 6861 7420 646f 6573 206e 6f74 2073 6574  hat does not set
+0001a1c0: 2061 2073 7461 7475 7320 696e 2074 6865   a status in the
+0001a1d0: 2069 6e73 7461 6c6c 2068 6f6f 6b20 7769   install hook wi
+0001a1e0: 6c6c 2068 6176 6520 616e 0a20 2020 2020  ll have an.     
+0001a1f0: 2020 2023 2075 6e6b 6e6f 776e 2073 7461     # unknown sta
+0001a200: 7475 7320 696e 2074 6865 2068 6172 6e65  tus in the harne
+0001a210: 7373 2e0a 2020 2020 2020 2020 6861 726e  ss..        harn
+0001a220: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+0001a230: 672e 4861 726e 6573 7328 5265 636f 7264  g.Harness(Record
+0001a240: 696e 6743 6861 726d 2c20 6d65 7461 3d27  ingCharm, meta='
+0001a250: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+0001a260: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+0001a270: 2020 2020 2020 2020 2020 2727 272c 2063            ''', c
+0001a280: 6f6e 6669 673d 2727 270a 2020 2020 2020  onfig='''.      
+0001a290: 2020 2020 6f70 7469 6f6e 733a 0a20 2020      options:.   
+0001a2a0: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
+0001a2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a2c0: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+0001a2d0: 6e3a 2061 2063 6f6e 6669 6720 6f70 7469  n: a config opti
+0001a2e0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0001a2f0: 2020 2020 2020 2074 7970 653a 2073 7472         type: str
+0001a300: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0001a310: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0001a320: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0001a330: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0001a340: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
+0001a350: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0001a360: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0001a370: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
+0001a380: 6961 6c5f 686f 6f6b 7328 290a 0a20 2020  ial_hooks()..   
+0001a390: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a3a0: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
+0001a3b0: 2020 2062 6163 6b65 6e64 2e73 7461 7475     backend.statu
+0001a3c0: 735f 6765 7428 6973 5f61 7070 3d46 616c  s_get(is_app=Fal
+0001a3d0: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+0001a3e0: 207b 2773 7461 7475 7327 3a20 2775 6e6b   {'status': 'unk
+0001a3f0: 6e6f 776e 272c 2027 6d65 7373 6167 6527  nown', 'message'
+0001a400: 3a20 2727 7d29 0a0a 2020 2020 2020 2020  : ''})..        
+0001a410: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001a420: 280a 2020 2020 2020 2020 2020 2020 6261  (.            ba
+0001a430: 636b 656e 642e 7374 6174 7573 5f67 6574  ckend.status_get
+0001a440: 2869 735f 6170 703d 5472 7565 292c 0a20  (is_app=True),. 
+0001a450: 2020 2020 2020 2020 2020 207b 2773 7461             {'sta
+0001a460: 7475 7327 3a20 2775 6e6b 6e6f 776e 272c  tus': 'unknown',
+0001a470: 2027 6d65 7373 6167 6527 3a20 2727 7d29   'message': ''})
+0001a480: 0a0a 2020 2020 6465 6620 7465 7374 5f62  ..    def test_b
+0001a490: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+0001a4a0: 6c5f 686f 6f6b 735f 696e 7374 616c 6c5f  l_hooks_install_
+0001a4b0: 7365 7473 5f73 7461 7475 7328 7365 6c66  sets_status(self
+0001a4c0: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0001a4d0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0001a4e0: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
+0001a4f0: 6e67 4368 6172 6d2c 206d 6574 613d 2727  ngCharm, meta=''
+0001a500: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+0001a510: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+0001a520: 2020 2020 2020 2020 2027 2727 2c20 636f           ''', co
+0001a530: 6e66 6967 3d27 2727 0a20 2020 2020 2020  nfig='''.       
+0001a540: 2020 2020 206f 7074 696f 6e73 3a0a 2020       options:.  
+0001a550: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001a560: 745f 7374 6174 7573 3a0a 2020 2020 2020  t_status:.      
+0001a570: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0001a580: 7363 7269 7074 696f 6e3a 2061 2063 6f6e  scription: a con
+0001a590: 6669 6720 6f70 7469 6f6e 0a20 2020 2020  fig option.     
+0001a5a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001a5b0: 7970 653a 2062 6f6f 6c65 616e 0a0a 2020  ype: boolean..  
+0001a5c0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0001a5d0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0001a5e0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0001a5f0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0001a600: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
+0001a610: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
+0001a620: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+0001a630: 655f 636f 6e66 6967 286b 6579 5f76 616c  e_config(key_val
+0001a640: 7565 733d 7b22 7365 745f 7374 6174 7573  ues={"set_status
+0001a650: 223a 2054 7275 657d 290a 2020 2020 2020  ": True}).      
+0001a660: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
+0001a670: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
+0001a680: 6b73 2829 0a0a 2020 2020 2020 2020 7365  ks()..        se
+0001a690: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+0001a6a0: 2020 2020 2020 2020 2020 2020 6261 636b              back
+0001a6b0: 656e 642e 7374 6174 7573 5f67 6574 2869  end.status_get(i
+0001a6c0: 735f 6170 703d 4661 6c73 6529 2c0a 2020  s_app=False),.  
+0001a6d0: 2020 2020 2020 2020 2020 7b27 7374 6174            {'stat
+0001a6e0: 7573 273a 2027 6d61 696e 7465 6e61 6e63  us': 'maintenanc
+0001a6f0: 6527 2c20 276d 6573 7361 6765 273a 2027  e', 'message': '
+0001a700: 5374 6174 7573 2073 6574 206f 6e20 696e  Status set on in
+0001a710: 7374 616c 6c27 7d29 0a0a 2020 2020 6465  stall'})..    de
+0001a720: 6620 7465 7374 5f67 6574 5f70 6562 626c  f test_get_pebbl
+0001a730: 655f 636f 6e74 6169 6e65 725f 706c 616e  e_container_plan
+0001a740: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001a750: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0001a760: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0001a770: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0001a780: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0001a790: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0001a7a0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001a7b0: 7461 696e 6572 733a 0a20 2020 2020 2020  tainers:.       
+0001a7c0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+0001a7d0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0001a7e0: 7572 6365 3a20 666f 6f2d 696d 6167 650a  urce: foo-image.
+0001a7f0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0001a800: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001a810: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0001a820: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0001a830: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0001a840: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0001a850: 732e 7365 745f 6361 6e5f 636f 6e6e 6563  s.set_can_connec
+0001a860: 7428 2766 6f6f 272c 2054 7275 6529 0a20  t('foo', True). 
+0001a870: 2020 2020 2020 2069 6e69 7469 616c 5f70         initial_p
+0001a880: 6c61 6e20 3d20 6861 726e 6573 732e 6765  lan = harness.ge
+0001a890: 745f 636f 6e74 6169 6e65 725f 7065 6262  t_container_pebb
+0001a8a0: 6c65 5f70 6c61 6e28 2766 6f6f 2729 0a20  le_plan('foo'). 
+0001a8b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001a8c0: 7274 4571 7561 6c28 696e 6974 6961 6c5f  rtEqual(initial_
+0001a8d0: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
+0001a8e0: 277b 7d5c 6e27 290a 2020 2020 2020 2020  '{}\n').        
+0001a8f0: 636f 6e74 6169 6e65 7220 3d20 6861 726e  container = harn
+0001a900: 6573 732e 6d6f 6465 6c2e 756e 6974 2e67  ess.model.unit.g
+0001a910: 6574 5f63 6f6e 7461 696e 6572 2827 666f  et_container('fo
+0001a920: 6f27 290a 2020 2020 2020 2020 636f 6e74  o').        cont
+0001a930: 6169 6e65 722e 7065 6262 6c65 2e61 6464  ainer.pebble.add
+0001a940: 5f6c 6179 6572 2827 7465 7374 2d61 6227  _layer('test-ab'
+0001a950: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
+0001a960: 2020 2073 756d 6d61 7279 3a20 7465 7374     summary: test
+0001a970: 2d6c 6179 6572 0a20 2020 2020 2020 2020  -layer.         
+0001a980: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
+0001a990: 6120 6c61 7965 7220 7468 6174 2077 6520  a layer that we 
+0001a9a0: 6361 6e20 7573 6520 666f 7220 7465 7374  can use for test
+0001a9b0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0001a9c0: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+0001a9d0: 2020 2020 2020 2020 613a 0a20 2020 2020          a:.     
+0001a9e0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+0001a9f0: 6e64 3a20 2f62 696e 2f65 6368 6f20 6865  nd: /bin/echo he
+0001aa00: 6c6c 6f20 6672 6f6d 2061 0a20 2020 2020  llo from a.     
+0001aa10: 2020 2020 2020 2020 2062 3a0a 2020 2020           b:.    
+0001aa20: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0001aa30: 616e 643a 202f 6269 6e2f 6563 686f 2068  and: /bin/echo h
+0001aa40: 656c 6c6f 2066 726f 6d20 620a 2020 2020  ello from b.    
+0001aa50: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+0001aa60: 2020 2020 2063 6f6e 7461 696e 6572 2e70       container.p
+0001aa70: 6562 626c 652e 6164 645f 6c61 7965 7228  ebble.add_layer(
+0001aa80: 2774 6573 742d 6327 2c20 2727 275c 0a20  'test-c', '''\. 
+0001aa90: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+0001aaa0: 7279 3a20 7465 7374 2d66 6f72 2d63 0a20  ry: test-for-c. 
+0001aab0: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+0001aac0: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+0001aad0: 2020 2063 3a0a 2020 2020 2020 2020 2020     c:.          
+0001aae0: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
+0001aaf0: 6269 6e2f 6563 686f 2068 656c 6c6f 2066  bin/echo hello f
+0001ab00: 726f 6d20 630a 2020 2020 2020 2020 2020  rom c.          
+0001ab10: 2020 2727 2729 0a20 2020 2020 2020 2070    ''').        p
+0001ab20: 6c61 6e20 3d20 636f 6e74 6169 6e65 722e  lan = container.
+0001ab30: 7065 6262 6c65 2e67 6574 5f70 6c61 6e28  pebble.get_plan(
+0001ab40: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ab50: 7373 6572 7445 7175 616c 2870 6c61 6e2e  ssertEqual(plan.
+0001ab60: 746f 5f79 616d 6c28 292c 2074 6578 7477  to_yaml(), textw
+0001ab70: 7261 702e 6465 6465 6e74 2827 2727 5c0a  rap.dedent('''\.
+0001ab80: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+0001ab90: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
+0001aba0: 2020 2020 613a 0a20 2020 2020 2020 2020      a:.         
+0001abb0: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+0001abc0: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f20  /bin/echo hello 
+0001abd0: 6672 6f6d 2061 0a20 2020 2020 2020 2020  from a.         
+0001abe0: 2020 2020 2062 3a0a 2020 2020 2020 2020       b:.        
+0001abf0: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+0001ac00: 202f 6269 6e2f 6563 686f 2068 656c 6c6f   /bin/echo hello
+0001ac10: 2066 726f 6d20 620a 2020 2020 2020 2020   from b.        
+0001ac20: 2020 2020 2020 633a 0a20 2020 2020 2020        c:.       
+0001ac30: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+0001ac40: 3a20 2f62 696e 2f65 6368 6f20 6865 6c6c  : /bin/echo hell
+0001ac50: 6f20 6672 6f6d 2063 0a20 2020 2020 2020  o from c.       
+0001ac60: 2020 2020 2027 2727 2929 0a20 2020 2020       ''')).     
+0001ac70: 2020 2068 6172 6e65 7373 5f70 6c61 6e20     harness_plan 
+0001ac80: 3d20 6861 726e 6573 732e 6765 745f 636f  = harness.get_co
+0001ac90: 6e74 6169 6e65 725f 7065 6262 6c65 5f70  ntainer_pebble_p
+0001aca0: 6c61 6e28 2766 6f6f 2729 0a20 2020 2020  lan('foo').     
+0001acb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001acc0: 7561 6c28 6861 726e 6573 735f 706c 616e  ual(harness_plan
+0001acd0: 2e74 6f5f 7961 6d6c 2829 2c20 706c 616e  .to_yaml(), plan
+0001ace0: 2e74 6f5f 7961 6d6c 2829 290a 0a20 2020  .to_yaml())..   
+0001acf0: 2064 6566 2074 6573 745f 6765 745f 7065   def test_get_pe
+0001ad00: 6262 6c65 5f63 6f6e 7461 696e 6572 5f70  bble_container_p
+0001ad10: 6c61 6e5f 756e 6b6e 6f77 6e28 7365 6c66  lan_unknown(self
+0001ad20: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0001ad30: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0001ad40: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0001ad50: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+0001ad60: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001ad70: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+0001ad80: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
+0001ad90: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0001ada0: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
+0001adb0: 2020 2020 2020 2072 6573 6f75 7263 653a         resource:
+0001adc0: 2066 6f6f 2d69 6d61 6765 0a20 2020 2020   foo-image.     
+0001add0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0001ade0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0001adf0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0001ae00: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
+0001ae10: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0001ae20: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+0001ae30: 5f63 616e 5f63 6f6e 6e65 6374 2827 666f  _can_connect('fo
+0001ae40: 6f27 2c20 5472 7565 290a 2020 2020 2020  o', True).      
+0001ae50: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001ae60: 7274 5261 6973 6573 284b 6579 4572 726f  rtRaises(KeyErro
+0001ae70: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001ae80: 6861 726e 6573 732e 6765 745f 636f 6e74  harness.get_cont
+0001ae90: 6169 6e65 725f 7065 6262 6c65 5f70 6c61  ainer_pebble_pla
+0001aea0: 6e28 2775 6e6b 6e6f 776e 2729 0a20 2020  n('unknown').   
+0001aeb0: 2020 2020 2070 6c61 6e20 3d20 6861 726e       plan = harn
+0001aec0: 6573 732e 6765 745f 636f 6e74 6169 6e65  ess.get_containe
+0001aed0: 725f 7065 6262 6c65 5f70 6c61 6e28 2766  r_pebble_plan('f
+0001aee0: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
+0001aef0: 662e 6173 7365 7274 4571 7561 6c28 706c  f.assertEqual(pl
+0001af00: 616e 2e74 6f5f 7961 6d6c 2829 2c20 227b  an.to_yaml(), "{
+0001af10: 7d5c 6e22 290a 0a20 2020 2064 6566 2074  }\n")..    def t
+0001af20: 6573 745f 636f 6e74 6169 6e65 725f 7065  est_container_pe
+0001af30: 6262 6c65 5f72 6561 6479 2873 656c 6629  bble_ready(self)
+0001af40: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0001af50: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0001af60: 4861 726e 6573 7328 436f 6e74 6169 6e65  Harness(Containe
+0001af70: 7245 7665 6e74 4368 6172 6d2c 206d 6574  rEventCharm, met
+0001af80: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0001af90: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0001afa0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001afb0: 7461 696e 6572 733a 0a20 2020 2020 2020  tainers:.       
+0001afc0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+0001afd0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0001afe0: 7572 6365 3a20 666f 6f2d 696d 6167 650a  urce: foo-image.
+0001aff0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+0001b000: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0001b010: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0001b020: 616e 7570 290a 2020 2020 2020 2020 2320  anup).        # 
+0001b030: 5468 6973 2069 7320 6120 6e6f 2d6f 7020  This is a no-op 
+0001b040: 6966 2069 7420 6973 2063 616c 6c65 6420  if it is called 
+0001b050: 6265 666f 7265 2062 6567 696e 2829 2c20  before begin(), 
+0001b060: 6275 7420 6974 2069 736e 2774 2061 6e20  but it isn't an 
+0001b070: 6572 726f 720a 2020 2020 2020 2020 6861  error.        ha
+0001b080: 726e 6573 732e 636f 6e74 6169 6e65 725f  rness.container_
+0001b090: 7065 6262 6c65 5f72 6561 6479 2827 666f  pebble_ready('fo
+0001b0a0: 6f27 290a 2020 2020 2020 2020 6861 726e  o').        harn
+0001b0b0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0001b0c0: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
+0001b0d0: 6d2e 6f62 7365 7276 655f 636f 6e74 6169  m.observe_contai
+0001b0e0: 6e65 725f 6576 656e 7473 2827 666f 6f27  ner_events('foo'
+0001b0f0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0001b100: 732e 636f 6e74 6169 6e65 725f 7065 6262  s.container_pebb
+0001b110: 6c65 5f72 6561 6479 2827 666f 6f27 290a  le_ready('foo').
+0001b120: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001b130: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+0001b140: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+0001b150: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
+0001b160: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+0001b170: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+0001b180: 6527 3a20 2770 6562 626c 652d 7265 6164  e': 'pebble-read
+0001b190: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0001b1a0: 2020 2020 2027 636f 6e74 6169 6e65 7227       'container'
+0001b1b0: 3a20 2766 6f6f 272c 0a20 2020 2020 2020  : 'foo',.       
+0001b1c0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0001b1d0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0001b1e0: 2020 2029 0a0a 2020 2020 6465 6620 7465     )..    def te
+0001b1f0: 7374 5f67 6574 5f66 696c 6573 7973 7465  st_get_filesyste
+0001b200: 6d5f 726f 6f74 2873 656c 6629 3a0a 2020  m_root(self):.  
+0001b210: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0001b220: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0001b230: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0001b240: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+0001b250: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+0001b260: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+0001b270: 2020 2063 6f6e 7461 696e 6572 733a 0a20     containers:. 
+0001b280: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
+0001b290: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b2a0: 2020 7265 736f 7572 6365 3a20 666f 6f2d    resource: foo-
+0001b2b0: 696d 6167 650a 2020 2020 2020 2020 2727  image.        ''
+0001b2c0: 2729 0a20 2020 2020 2020 2066 6f6f 5f72  ').        foo_r
+0001b2d0: 6f6f 7420 3d20 6861 726e 6573 732e 6765  oot = harness.ge
+0001b2e0: 745f 6669 6c65 7379 7374 656d 5f72 6f6f  t_filesystem_roo
+0001b2f0: 7428 2266 6f6f 2229 0a20 2020 2020 2020  t("foo").       
+0001b300: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0001b310: 2866 6f6f 5f72 6f6f 742e 6578 6973 7473  (foo_root.exists
+0001b320: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+0001b330: 2e61 7373 6572 7454 7275 6528 666f 6f5f  .assertTrue(foo_
+0001b340: 726f 6f74 2e69 735f 6469 7228 2929 0a20  root.is_dir()). 
+0001b350: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+0001b360: 6567 696e 2829 0a20 2020 2020 2020 2063  egin().        c
+0001b370: 6f6e 7461 696e 6572 203d 2068 6172 6e65  ontainer = harne
+0001b380: 7373 2e63 6861 726d 2e75 6e69 742e 6765  ss.charm.unit.ge
+0001b390: 745f 636f 6e74 6169 6e65 7228 2266 6f6f  t_container("foo
+0001b3a0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0001b3b0: 6173 7365 7274 4571 7561 6c28 666f 6f5f  assertEqual(foo_
+0001b3c0: 726f 6f74 2c20 6861 726e 6573 732e 6765  root, harness.ge
+0001b3d0: 745f 6669 6c65 7379 7374 656d 5f72 6f6f  t_filesystem_roo
+0001b3e0: 7428 636f 6e74 6169 6e65 7229 290a 0a20  t(container)).. 
+0001b3f0: 2020 2064 6566 2074 6573 745f 6576 616c     def test_eval
+0001b400: 7561 7465 5f73 7461 7475 7328 7365 6c66  uate_status(self
+0001b410: 293a 0a20 2020 2020 2020 2063 6c61 7373  ):.        class
+0001b420: 2054 6573 7443 6861 726d 286f 7073 2e43   TestCharm(ops.C
+0001b430: 6861 726d 4261 7365 293a 0a20 2020 2020  harmBase):.     
+0001b440: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
+0001b450: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
+0001b460: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
+0001b470: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+0001b480: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
+0001b490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b4a0: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+0001b4b0: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+0001b4c0: 2e63 6f6c 6c65 6374 5f61 7070 5f73 7461  .collect_app_sta
+0001b4d0: 7475 732c 2073 656c 662e 5f6f 6e5f 636f  tus, self._on_co
+0001b4e0: 6c6c 6563 745f 6170 705f 7374 6174 7573  llect_app_status
+0001b4f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b500: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+0001b510: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+0001b520: 2e63 6f6c 6c65 6374 5f75 6e69 745f 7374  .collect_unit_st
+0001b530: 6174 7573 2c20 7365 6c66 2e5f 6f6e 5f63  atus, self._on_c
+0001b540: 6f6c 6c65 6374 5f75 6e69 745f 7374 6174  ollect_unit_stat
+0001b550: 7573 290a 0a20 2020 2020 2020 2020 2020  us)..           
+0001b560: 2064 6566 205f 6f6e 5f63 6f6c 6c65 6374   def _on_collect
+0001b570: 5f61 7070 5f73 7461 7475 7328 7365 6c66  _app_status(self
+0001b580: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
+0001b590: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+0001b5a0: 6164 645f 7374 6174 7573 286f 7073 2e41  add_status(ops.A
+0001b5b0: 6374 6976 6553 7461 7475 7328 2929 0a0a  ctiveStatus())..
+0001b5c0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+0001b5d0: 5f6f 6e5f 636f 6c6c 6563 745f 756e 6974  _on_collect_unit
+0001b5e0: 5f73 7461 7475 7328 7365 6c66 2c20 6576  _status(self, ev
+0001b5f0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+0001b600: 2020 2020 2020 6576 656e 742e 6164 645f        event.add_
+0001b610: 7374 6174 7573 286f 7073 2e42 6c6f 636b  status(ops.Block
+0001b620: 6564 5374 6174 7573 2827 6261 7227 2929  edStatus('bar'))
+0001b630: 0a0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
+0001b640: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0001b650: 4861 726e 6573 7328 5465 7374 4368 6172  Harness(TestChar
+0001b660: 6d29 0a20 2020 2020 2020 2068 6172 6e65  m).        harne
+0001b670: 7373 2e73 6574 5f6c 6561 6465 7228 5472  ss.set_leader(Tr
+0001b680: 7565 290a 2020 2020 2020 2020 6861 726e  ue).        harn
+0001b690: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0001b6a0: 2020 2020 2320 5465 7374 7320 666f 7220      # Tests for 
+0001b6b0: 7468 6520 6265 6861 7669 6f75 7220 6f66  the behaviour of
+0001b6c0: 2073 7461 7475 7320 6576 616c 7561 7469   status evaluati
+0001b6d0: 6f6e 2061 7265 2069 6e20 7465 7374 5f63  on are in test_c
+0001b6e0: 6861 726d 2e70 790a 2020 2020 2020 2020  harm.py.        
+0001b6f0: 6861 726e 6573 732e 6576 616c 7561 7465  harness.evaluate
+0001b700: 5f73 7461 7475 7328 290a 2020 2020 2020  _status().      
+0001b710: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001b720: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
+0001b730: 2e61 7070 2e73 7461 7475 732c 206f 7073  .app.status, ops
+0001b740: 2e41 6374 6976 6553 7461 7475 7328 2929  .ActiveStatus())
+0001b750: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001b760: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+0001b770: 732e 6d6f 6465 6c2e 756e 6974 2e73 7461  s.model.unit.sta
+0001b780: 7475 732c 206f 7073 2e42 6c6f 636b 6564  tus, ops.Blocked
+0001b790: 5374 6174 7573 2827 6261 7227 2929 0a0a  Status('bar'))..
+0001b7a0: 0a63 6c61 7373 2054 6573 744e 6574 776f  .class TestNetwo
+0001b7b0: 726b 2875 6e69 7474 6573 742e 5465 7374  rk(unittest.Test
+0001b7c0: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
+0001b7d0: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
+0001b7e0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0001b7f0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0001b800: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0001b810: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+0001b820: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+0001b830: 2074 6573 742d 6368 6172 6d0a 2020 2020   test-charm.    
+0001b840: 2020 2020 2020 2020 7265 7175 6972 6573          requires
+0001b850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b860: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+0001b870: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
+0001b880: 2064 6174 6162 6173 650a 2020 2020 2020   database.      
+0001b890: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
+0001b8a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b8b0: 6e74 6572 6661 6365 3a20 7879 7a0a 2020  nterface: xyz.  
+0001b8c0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0001b8d0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0001b8e0: 6c65 616e 7570 2873 656c 662e 6861 726e  leanup(self.harn
+0001b8f0: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0001b900: 2020 6465 6620 7465 7374 5f61 6464 5f6e    def test_add_n
+0001b910: 6574 776f 726b 5f64 6566 6175 6c74 7328  etwork_defaults(
+0001b920: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001b930: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001b940: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
+0001b950: 3130 2729 0a0a 2020 2020 2020 2020 6269  10')..        bi
+0001b960: 6e64 696e 6720 3d20 7365 6c66 2e68 6172  nding = self.har
+0001b970: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f62  ness.model.get_b
+0001b980: 696e 6469 6e67 2827 6462 2729 0a20 2020  inding('db').   
+0001b990: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001b9a0: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
+0001b9b0: 6d65 2c20 2764 6227 290a 2020 2020 2020  me, 'db').      
+0001b9c0: 2020 6e65 7477 6f72 6b20 3d20 6269 6e64    network = bind
+0001b9d0: 696e 672e 6e65 7477 6f72 6b0a 2020 2020  ing.network.    
+0001b9e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b9f0: 7175 616c 286e 6574 776f 726b 2e62 696e  qual(network.bin
+0001ba00: 645f 6164 6472 6573 732c 2069 7061 6464  d_address, ipadd
+0001ba10: 7265 7373 2e49 5076 3441 6464 7265 7373  ress.IPv4Address
+0001ba20: 2827 3130 2e30 2e30 2e31 3027 2929 0a20  ('10.0.0.10')). 
+0001ba30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001ba40: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
+0001ba50: 696e 6772 6573 735f 6164 6472 6573 732c  ingress_address,
+0001ba60: 2069 7061 6464 7265 7373 2e49 5076 3441   ipaddress.IPv4A
+0001ba70: 6464 7265 7373 2827 3130 2e30 2e30 2e31  ddress('10.0.0.1
+0001ba80: 3027 2929 0a20 2020 2020 2020 2073 656c  0')).        sel
+0001ba90: 662e 6173 7365 7274 4571 7561 6c28 6e65  f.assertEqual(ne
+0001baa0: 7477 6f72 6b2e 696e 6772 6573 735f 6164  twork.ingress_ad
+0001bab0: 6472 6573 7365 732c 205b 6970 6164 6472  dresses, [ipaddr
+0001bac0: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
+0001bad0: 2731 302e 302e 302e 3130 2729 5d29 0a20  '10.0.0.10')]). 
+0001bae0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001baf0: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
+0001bb00: 6567 7265 7373 5f73 7562 6e65 7473 2c20  egress_subnets, 
+0001bb10: 5b69 7061 6464 7265 7373 2e49 5076 344e  [ipaddress.IPv4N
+0001bb20: 6574 776f 726b 2827 3130 2e30 2e30 2e30  etwork('10.0.0.0
+0001bb30: 2f32 3427 295d 290a 2020 2020 2020 2020  /24')]).        
+0001bb40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001bb50: 286c 656e 286e 6574 776f 726b 2e69 6e74  (len(network.int
+0001bb60: 6572 6661 6365 7329 2c20 3129 0a20 2020  erfaces), 1).   
+0001bb70: 2020 2020 2069 6e74 6572 6661 6365 203d       interface =
+0001bb80: 206e 6574 776f 726b 2e69 6e74 6572 6661   network.interfa
+0001bb90: 6365 735b 305d 0a20 2020 2020 2020 2073  ces[0].        s
+0001bba0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001bbb0: 696e 7465 7266 6163 652e 6e61 6d65 2c20  interface.name, 
+0001bbc0: 2765 7468 3027 290a 2020 2020 2020 2020  'eth0').        
+0001bbd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001bbe0: 2869 6e74 6572 6661 6365 2e61 6464 7265  (interface.addre
+0001bbf0: 7373 2c20 6970 6164 6472 6573 732e 4950  ss, ipaddress.IP
+0001bc00: 7634 4164 6472 6573 7328 2731 302e 302e  v4Address('10.0.
+0001bc10: 302e 3130 2729 290a 2020 2020 2020 2020  0.10')).        
+0001bc20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001bc30: 2869 6e74 6572 6661 6365 2e73 7562 6e65  (interface.subne
+0001bc40: 742c 2069 7061 6464 7265 7373 2e49 5076  t, ipaddress.IPv
+0001bc50: 344e 6574 776f 726b 2827 3130 2e30 2e30  4Network('10.0.0
+0001bc60: 2e30 2f32 3427 2929 0a0a 2020 2020 6465  .0/24'))..    de
+0001bc70: 6620 7465 7374 5f61 6464 5f6e 6574 776f  f test_add_netwo
+0001bc80: 726b 5f61 6c6c 5f61 7267 7328 7365 6c66  rk_all_args(self
+0001bc90: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+0001bca0: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+0001bcb0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+0001bcc0: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
+0001bcd0: 6573 716c 2729 0a20 2020 2020 2020 2073  esql').        s
+0001bce0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001bcf0: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
+0001bd00: 3130 272c 0a20 2020 2020 2020 2020 2020  10',.           
+0001bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd20: 2020 2020 2020 656e 6470 6f69 6e74 3d27        endpoint='
+0001bd30: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
+0001bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd50: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0001bd60: 643d 7265 6c61 7469 6f6e 5f69 642c 0a20  d=relation_id,. 
+0001bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd90: 6369 6472 3d27 3130 2e30 2e30 2e30 2f38  cidr='10.0.0.0/8
+0001bda0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bdc0: 2020 2020 696e 7465 7266 6163 653d 2765      interface='e
+0001bdd0: 7468 3127 2c0a 2020 2020 2020 2020 2020  th1',.          
+0001bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bdf0: 2020 2020 2020 2069 6e67 7265 7373 5f61         ingress_a
+0001be00: 6464 7265 7373 6573 3d5b 2731 302e 302e  ddresses=['10.0.
+0001be10: 302e 3127 2c20 2731 302e 302e 302e 3227  0.1', '10.0.0.2'
+0001be20: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be40: 2020 2020 6567 7265 7373 5f73 7562 6e65      egress_subne
+0001be50: 7473 3d5b 2731 302e 302e 302e 302f 3827  ts=['10.0.0.0/8'
+0001be60: 2c20 2731 302e 3130 2e30 2e30 2f31 3627  , '10.10.0.0/16'
+0001be70: 5d29 0a0a 2020 2020 2020 2020 7265 6c61  ])..        rela
+0001be80: 7469 6f6e 203d 2073 656c 662e 6861 726e  tion = self.harn
+0001be90: 6573 732e 6d6f 6465 6c2e 6765 745f 7265  ess.model.get_re
+0001bea0: 6c61 7469 6f6e 2827 6462 272c 2072 656c  lation('db', rel
+0001beb0: 6174 696f 6e5f 6964 290a 2020 2020 2020  ation_id).      
+0001bec0: 2020 6269 6e64 696e 6720 3d20 7365 6c66    binding = self
+0001bed0: 2e68 6172 6e65 7373 2e6d 6f64 656c 2e67  .harness.model.g
+0001bee0: 6574 5f62 696e 6469 6e67 2872 656c 6174  et_binding(relat
+0001bef0: 696f 6e29 0a20 2020 2020 2020 2073 656c  ion).        sel
+0001bf00: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+0001bf10: 6e64 696e 672e 6e61 6d65 2c20 2764 6227  nding.name, 'db'
+0001bf20: 290a 2020 2020 2020 2020 6e65 7477 6f72  ).        networ
+0001bf30: 6b20 3d20 6269 6e64 696e 672e 6e65 7477  k = binding.netw
+0001bf40: 6f72 6b0a 2020 2020 2020 2020 7365 6c66  ork.        self
+0001bf50: 2e61 7373 6572 7445 7175 616c 286e 6574  .assertEqual(net
+0001bf60: 776f 726b 2e62 696e 645f 6164 6472 6573  work.bind_addres
+0001bf70: 732c 2069 7061 6464 7265 7373 2e49 5076  s, ipaddress.IPv
+0001bf80: 3441 6464 7265 7373 2827 3130 2e30 2e30  4Address('10.0.0
+0001bf90: 2e31 3027 2929 0a20 2020 2020 2020 2073  .10')).        s
+0001bfa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001bfb0: 6e65 7477 6f72 6b2e 696e 6772 6573 735f  network.ingress_
+0001bfc0: 6164 6472 6573 732c 2069 7061 6464 7265  address, ipaddre
+0001bfd0: 7373 2e49 5076 3441 6464 7265 7373 2827  ss.IPv4Address('
+0001bfe0: 3130 2e30 2e30 2e31 2729 290a 2020 2020  10.0.0.1')).    
+0001bff0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c000: 7175 616c 286e 6574 776f 726b 2e69 6e67  qual(network.ing
+0001c010: 7265 7373 5f61 6464 7265 7373 6573 2c0a  ress_addresses,.
+0001c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c030: 2020 2020 2020 2020 205b 6970 6164 6472           [ipaddr
+0001c040: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
+0001c050: 2731 302e 302e 302e 3127 292c 2069 7061  '10.0.0.1'), ipa
+0001c060: 6464 7265 7373 2e49 5076 3441 6464 7265  ddress.IPv4Addre
+0001c070: 7373 2827 3130 2e30 2e30 2e32 2729 5d29  ss('10.0.0.2')])
+0001c080: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001c090: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
+0001c0a0: 6b2e 6567 7265 7373 5f73 7562 6e65 7473  k.egress_subnets
+0001c0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c0c0: 2020 2020 2020 2020 2020 205b 6970 6164             [ipad
+0001c0d0: 6472 6573 732e 4950 7634 4e65 7477 6f72  dress.IPv4Networ
+0001c0e0: 6b28 2731 302e 302e 302e 302f 3827 292c  k('10.0.0.0/8'),
+0001c0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c100: 2020 2020 2020 2020 2020 2069 7061 6464             ipadd
+0001c110: 7265 7373 2e49 5076 344e 6574 776f 726b  ress.IPv4Network
+0001c120: 2827 3130 2e31 302e 302e 302f 3136 2729  ('10.10.0.0/16')
+0001c130: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+0001c140: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+0001c150: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
+0001c160: 6573 292c 2031 290a 2020 2020 2020 2020  es), 1).        
+0001c170: 696e 7465 7266 6163 6520 3d20 6e65 7477  interface = netw
+0001c180: 6f72 6b2e 696e 7465 7266 6163 6573 5b30  ork.interfaces[0
+0001c190: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+0001c1a0: 7373 6572 7445 7175 616c 2869 6e74 6572  ssertEqual(inter
+0001c1b0: 6661 6365 2e6e 616d 652c 2027 6574 6831  face.name, 'eth1
+0001c1c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001c1d0: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
+0001c1e0: 7266 6163 652e 6164 6472 6573 732c 2069  rface.address, i
+0001c1f0: 7061 6464 7265 7373 2e49 5076 3441 6464  paddress.IPv4Add
+0001c200: 7265 7373 2827 3130 2e30 2e30 2e31 3027  ress('10.0.0.10'
+0001c210: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001c220: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
+0001c230: 7266 6163 652e 7375 626e 6574 2c20 6970  rface.subnet, ip
+0001c240: 6164 6472 6573 732e 4950 7634 4e65 7477  address.IPv4Netw
+0001c250: 6f72 6b28 2731 302e 302e 302e 302f 3827  ork('10.0.0.0/8'
+0001c260: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0001c270: 5f61 6464 5f6e 6574 776f 726b 5f73 7065  _add_network_spe
+0001c280: 6369 6669 635f 656e 6470 6f69 6e74 2873  cific_endpoint(s
+0001c290: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0001c2a0: 6c66 2e68 6172 6e65 7373 2e61 6464 5f6e  lf.harness.add_n
+0001c2b0: 6574 776f 726b 2827 3130 2e30 2e30 2e31  etwork('10.0.0.1
+0001c2c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001c2d0: 6861 726e 6573 732e 6164 645f 6e65 7477  harness.add_netw
+0001c2e0: 6f72 6b28 2731 302e 302e 322e 3127 2c20  ork('10.0.2.1', 
+0001c2f0: 656e 6470 6f69 6e74 3d27 6462 2729 0a0a  endpoint='db')..
+0001c300: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
+0001c310: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
+0001c320: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
+0001c330: 2827 6462 2729 0a20 2020 2020 2020 2073  ('db').        s
+0001c340: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001c350: 6269 6e64 696e 672e 6e61 6d65 2c20 2764  binding.name, 'd
+0001c360: 6227 290a 2020 2020 2020 2020 6e65 7477  b').        netw
+0001c370: 6f72 6b20 3d20 6269 6e64 696e 672e 6e65  ork = binding.ne
+0001c380: 7477 6f72 6b0a 2020 2020 2020 2020 7365  twork.        se
+0001c390: 6c66 2e61 7373 6572 7445 7175 616c 286e  lf.assertEqual(n
+0001c3a0: 6574 776f 726b 2e62 696e 645f 6164 6472  etwork.bind_addr
+0001c3b0: 6573 732c 2069 7061 6464 7265 7373 2e49  ess, ipaddress.I
+0001c3c0: 5076 3441 6464 7265 7373 2827 3130 2e30  Pv4Address('10.0
+0001c3d0: 2e32 2e31 2729 290a 0a20 2020 2020 2020  .2.1'))..       
+0001c3e0: 2023 2045 6e73 7572 6520 6269 6e64 696e   # Ensure bindin
+0001c3f0: 6720 666f 7220 7468 6520 6f74 6865 7220  g for the other 
+0001c400: 696e 7465 7266 6163 6520 6973 2073 7469  interface is sti
+0001c410: 6c6c 206f 6e20 7468 6520 6465 6661 756c  ll on the defaul
+0001c420: 7420 7661 6c75 650a 2020 2020 2020 2020  t value.        
+0001c430: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001c440: 2873 656c 662e 6861 726e 6573 732e 6d6f  (self.harness.mo
+0001c450: 6465 6c2e 6765 745f 6269 6e64 696e 6728  del.get_binding(
+0001c460: 2766 6f6f 2729 2e6e 6574 776f 726b 2e62  'foo').network.b
+0001c470: 696e 645f 6164 6472 6573 732c 0a20 2020  ind_address,.   
+0001c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c490: 2020 2020 2020 6970 6164 6472 6573 732e        ipaddress.
+0001c4a0: 4950 7634 4164 6472 6573 7328 2731 302e  IPv4Address('10.
+0001c4b0: 302e 302e 3127 2929 0a0a 2020 2020 6465  0.0.1'))..    de
+0001c4c0: 6620 7465 7374 5f61 6464 5f6e 6574 776f  f test_add_netwo
+0001c4d0: 726b 5f73 7065 6369 6669 635f 7265 6c61  rk_specific_rela
+0001c4e0: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+0001c4f0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0001c500: 2e61 6464 5f6e 6574 776f 726b 2827 3130  .add_network('10
+0001c510: 2e30 2e30 2e31 2729 0a20 2020 2020 2020  .0.0.1').       
+0001c520: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+0001c530: 645f 6e65 7477 6f72 6b28 2731 302e 302e  d_network('10.0.
+0001c540: 322e 3127 2c20 656e 6470 6f69 6e74 3d27  2.1', endpoint='
+0001c550: 6462 2729 0a20 2020 2020 2020 2072 656c  db').        rel
+0001c560: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
+0001c570: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0001c580: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+0001c590: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+0001c5a0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+0001c5b0: 645f 6e65 7477 6f72 6b28 2733 352e 302e  d_network('35.0.
+0001c5c0: 302e 3127 2c20 656e 6470 6f69 6e74 3d27  0.1', endpoint='
+0001c5d0: 6462 272c 2072 656c 6174 696f 6e5f 6964  db', relation_id
+0001c5e0: 3d72 656c 6174 696f 6e5f 6964 290a 0a20  =relation_id).. 
+0001c5f0: 2020 2020 2020 2072 656c 6174 696f 6e20         relation 
+0001c600: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
+0001c610: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+0001c620: 6e28 2764 6227 2c20 7265 6c61 7469 6f6e  n('db', relation
+0001c630: 5f69 6429 0a20 2020 2020 2020 2062 696e  _id).        bin
+0001c640: 6469 6e67 203d 2073 656c 662e 6861 726e  ding = self.harn
+0001c650: 6573 732e 6d6f 6465 6c2e 6765 745f 6269  ess.model.get_bi
+0001c660: 6e64 696e 6728 7265 6c61 7469 6f6e 290a  nding(relation).
+0001c670: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c680: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+0001c690: 2e6e 616d 652c 2027 6462 2729 0a20 2020  .name, 'db').   
+0001c6a0: 2020 2020 206e 6574 776f 726b 203d 2062       network = b
+0001c6b0: 696e 6469 6e67 2e6e 6574 776f 726b 0a20  inding.network. 
+0001c6c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c6d0: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
+0001c6e0: 6269 6e64 5f61 6464 7265 7373 2c20 6970  bind_address, ip
+0001c6f0: 6164 6472 6573 732e 4950 7634 4164 6472  address.IPv4Addr
+0001c700: 6573 7328 2733 352e 302e 302e 3127 2929  ess('35.0.0.1'))
+0001c710: 0a0a 2020 2020 2020 2020 2320 456e 7375  ..        # Ensu
+0001c720: 7265 2062 696e 6469 6e67 2066 6f72 2074  re binding for t
+0001c730: 6865 206f 7468 6572 2069 6e74 6572 6661  he other interfa
+0001c740: 6365 2069 7320 7374 696c 6c20 6f6e 2074  ce is still on t
+0001c750: 6865 2064 6566 6175 6c74 2076 616c 7565  he default value
+0001c760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001c770: 7365 7274 4571 7561 6c28 7365 6c66 2e68  sertEqual(self.h
+0001c780: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
+0001c790: 5f62 696e 6469 6e67 2827 666f 6f27 292e  _binding('foo').
+0001c7a0: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
+0001c7b0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c7d0: 7061 6464 7265 7373 2e49 5076 3441 6464  paddress.IPv4Add
+0001c7e0: 7265 7373 2827 3130 2e30 2e30 2e31 2729  ress('10.0.0.1')
+0001c7f0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001c800: 6164 645f 6e65 7477 6f72 6b5f 656e 6470  add_network_endp
+0001c810: 6f69 6e74 5f66 616c 6c62 6163 6b28 7365  oint_fallback(se
+0001c820: 6c66 293a 0a20 2020 2020 2020 2072 656c  lf):.        rel
+0001c830: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
+0001c840: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0001c850: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+0001c860: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+0001c870: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+0001c880: 645f 6e65 7477 6f72 6b28 2731 302e 302e  d_network('10.0.
+0001c890: 302e 3130 272c 2065 6e64 706f 696e 743d  0.10', endpoint=
+0001c8a0: 2764 6227 290a 0a20 2020 2020 2020 2072  'db')..        r
+0001c8b0: 656c 6174 696f 6e20 3d20 7365 6c66 2e68  elation = self.h
+0001c8c0: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
+0001c8d0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+0001c8e0: 7265 6c61 7469 6f6e 5f69 6429 0a20 2020  relation_id).   
+0001c8f0: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
+0001c900: 656c 662e 6861 726e 6573 732e 6d6f 6465  elf.harness.mode
+0001c910: 6c2e 6765 745f 6269 6e64 696e 6728 7265  l.get_binding(re
+0001c920: 6c61 7469 6f6e 290a 2020 2020 2020 2020  lation).        
+0001c930: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001c940: 2862 696e 6469 6e67 2e6e 616d 652c 2027  (binding.name, '
+0001c950: 6462 2729 0a20 2020 2020 2020 206e 6574  db').        net
+0001c960: 776f 726b 203d 2062 696e 6469 6e67 2e6e  work = binding.n
+0001c970: 6574 776f 726b 0a20 2020 2020 2020 2073  etwork.        s
+0001c980: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001c990: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
+0001c9a0: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
+0001c9b0: 4950 7634 4164 6472 6573 7328 2731 302e  IPv4Address('10.
+0001c9c0: 302e 302e 3130 2729 290a 0a20 2020 2064  0.0.10'))..    d
+0001c9d0: 6566 2074 6573 745f 6164 645f 6e65 7477  ef test_add_netw
+0001c9e0: 6f72 6b5f 6465 6661 756c 745f 6661 6c6c  ork_default_fall
+0001c9f0: 6261 636b 2873 656c 6629 3a0a 2020 2020  back(self):.    
+0001ca00: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0001ca10: 2e61 6464 5f6e 6574 776f 726b 2827 3130  .add_network('10
+0001ca20: 2e30 2e30 2e31 3027 290a 0a20 2020 2020  .0.0.10')..     
+0001ca30: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
+0001ca40: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
+0001ca50: 6765 745f 6269 6e64 696e 6728 2764 6227  get_binding('db'
+0001ca60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ca70: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+0001ca80: 6e67 2e6e 616d 652c 2027 6462 2729 0a20  ng.name, 'db'). 
+0001ca90: 2020 2020 2020 206e 6574 776f 726b 203d         network =
+0001caa0: 2062 696e 6469 6e67 2e6e 6574 776f 726b   binding.network
+0001cab0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001cac0: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
+0001cad0: 6b2e 6269 6e64 5f61 6464 7265 7373 2c20  k.bind_address, 
+0001cae0: 6970 6164 6472 6573 732e 4950 7634 4164  ipaddress.IPv4Ad
+0001caf0: 6472 6573 7328 2731 302e 302e 302e 3130  dress('10.0.0.10
+0001cb00: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
+0001cb10: 745f 6164 645f 6e65 7477 6f72 6b5f 6970  t_add_network_ip
+0001cb20: 7636 2873 656c 6629 3a0a 2020 2020 2020  v6(self):.      
+0001cb30: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
+0001cb40: 6464 5f6e 6574 776f 726b 2827 3230 3031  dd_network('2001
+0001cb50: 3a30 6462 383a 3a61 3a30 3a30 3a31 2729  :0db8::a:0:0:1')
+0001cb60: 0a0a 2020 2020 2020 2020 6269 6e64 696e  ..        bindin
+0001cb70: 6720 3d20 7365 6c66 2e68 6172 6e65 7373  g = self.harness
+0001cb80: 2e6d 6f64 656c 2e67 6574 5f62 696e 6469  .model.get_bindi
+0001cb90: 6e67 2827 6462 2729 0a20 2020 2020 2020  ng('db').       
+0001cba0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001cbb0: 6c28 6269 6e64 696e 672e 6e61 6d65 2c20  l(binding.name, 
+0001cbc0: 2764 6227 290a 2020 2020 2020 2020 6e65  'db').        ne
+0001cbd0: 7477 6f72 6b20 3d20 6269 6e64 696e 672e  twork = binding.
+0001cbe0: 6e65 7477 6f72 6b0a 2020 2020 2020 2020  network.        
+0001cbf0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001cc00: 286e 6574 776f 726b 2e62 696e 645f 6164  (network.bind_ad
+0001cc10: 6472 6573 732c 2069 7061 6464 7265 7373  dress, ipaddress
+0001cc20: 2e49 5076 3641 6464 7265 7373 2827 3230  .IPv6Address('20
+0001cc30: 3031 3a30 6462 383a 3a61 3a30 3a30 3a31  01:0db8::a:0:0:1
+0001cc40: 2729 290a 2020 2020 2020 2020 7365 6c66  ')).        self
+0001cc50: 2e61 7373 6572 7445 7175 616c 286e 6574  .assertEqual(net
+0001cc60: 776f 726b 2e69 6e67 7265 7373 5f61 6464  work.ingress_add
+0001cc70: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
+0001cc80: 4950 7636 4164 6472 6573 7328 2732 3030  IPv6Address('200
+0001cc90: 313a 3064 6238 3a3a 613a 303a 303a 3127  1:0db8::a:0:0:1'
+0001cca0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001ccb0: 6173 7365 7274 4571 7561 6c28 6e65 7477  assertEqual(netw
+0001ccc0: 6f72 6b2e 696e 6772 6573 735f 6164 6472  ork.ingress_addr
+0001ccd0: 6573 7365 732c 205b 6970 6164 6472 6573  esses, [ipaddres
+0001cce0: 732e 4950 7636 4164 6472 6573 7328 2732  s.IPv6Address('2
+0001ccf0: 3030 313a 3064 6238 3a3a 613a 303a 303a  001:0db8::a:0:0:
+0001cd00: 3127 295d 290a 2020 2020 2020 2020 7365  1')]).        se
+0001cd10: 6c66 2e61 7373 6572 7445 7175 616c 286e  lf.assertEqual(n
+0001cd20: 6574 776f 726b 2e65 6772 6573 735f 7375  etwork.egress_su
+0001cd30: 626e 6574 732c 205b 6970 6164 6472 6573  bnets, [ipaddres
+0001cd40: 732e 4950 7636 4e65 7477 6f72 6b28 2732  s.IPv6Network('2
+0001cd50: 3030 313a 3064 6238 3a3a 303a 303a 303a  001:0db8::0:0:0:
+0001cd60: 302f 3634 2729 5d29 0a20 2020 2020 2020  0/64')]).       
+0001cd70: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001cd80: 6c28 6c65 6e28 6e65 7477 6f72 6b2e 696e  l(len(network.in
+0001cd90: 7465 7266 6163 6573 292c 2031 290a 2020  terfaces), 1).  
+0001cda0: 2020 2020 2020 696e 7465 7266 6163 6520        interface 
+0001cdb0: 3d20 6e65 7477 6f72 6b2e 696e 7465 7266  = network.interf
+0001cdc0: 6163 6573 5b30 5d0a 2020 2020 2020 2020  aces[0].        
+0001cdd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001cde0: 2869 6e74 6572 6661 6365 2e6e 616d 652c  (interface.name,
+0001cdf0: 2027 6574 6830 2729 0a20 2020 2020 2020   'eth0').       
+0001ce00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001ce10: 6c28 696e 7465 7266 6163 652e 6164 6472  l(interface.addr
+0001ce20: 6573 732c 2069 7061 6464 7265 7373 2e49  ess, ipaddress.I
+0001ce30: 5076 3641 6464 7265 7373 2827 3230 3031  Pv6Address('2001
+0001ce40: 3a30 6462 383a 3a61 3a30 3a30 3a31 2729  :0db8::a:0:0:1')
+0001ce50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001ce60: 7373 6572 7445 7175 616c 2869 6e74 6572  ssertEqual(inter
+0001ce70: 6661 6365 2e73 7562 6e65 742c 2069 7061  face.subnet, ipa
+0001ce80: 6464 7265 7373 2e49 5076 364e 6574 776f  ddress.IPv6Netwo
+0001ce90: 726b 2827 3230 3031 3a30 6462 383a 3a30  rk('2001:0db8::0
+0001cea0: 3a30 3a30 3a30 2f36 3427 2929 0a0a 2020  :0:0:0/64'))..  
+0001ceb0: 2020 6465 6620 7465 7374 5f6e 6574 776f    def test_netwo
+0001cec0: 726b 5f67 6574 5f72 656c 6174 696f 6e5f  rk_get_relation_
+0001ced0: 6e6f 745f 666f 756e 6428 7365 6c66 293a  not_found(self):
+0001cee0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001cef0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001cf00: 6f70 732e 5265 6c61 7469 6f6e 4e6f 7446  ops.RelationNotF
+0001cf10: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
+0001cf20: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0001cf30: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f62  ness.model.get_b
+0001cf40: 696e 6469 6e67 2827 6462 2729 2e6e 6574  inding('db').net
+0001cf50: 776f 726b 0a0a 2020 2020 6465 6620 7465  work..    def te
+0001cf60: 7374 5f61 6464 5f6e 6574 776f 726b 5f65  st_add_network_e
+0001cf70: 6e64 706f 696e 745f 6e6f 745f 696e 5f6d  ndpoint_not_in_m
+0001cf80: 6574 6128 7365 6c66 293a 0a20 2020 2020  eta(self):.     
+0001cf90: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0001cfa0: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+0001cfb0: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+0001cfc0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0001cfd0: 6573 732e 6164 645f 6e65 7477 6f72 6b28  ess.add_network(
+0001cfe0: 2733 352e 302e 302e 3127 2c20 656e 6470  '35.0.0.1', endp
+0001cff0: 6f69 6e74 3d27 7879 7a27 290a 0a20 2020  oint='xyz')..   
+0001d000: 2064 6566 2074 6573 745f 6164 645f 6e65   def test_add_ne
+0001d010: 7477 6f72 6b5f 7265 6c61 7469 6f6e 5f69  twork_relation_i
+0001d020: 645f 7365 745f 656e 6470 6f69 6e74 5f6e  d_set_endpoint_n
+0001d030: 6f74 5f73 6574 2873 656c 6629 3a0a 2020  ot_set(self):.  
+0001d040: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0001d050: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
+0001d060: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0001d070: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+0001d080: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+0001d090: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0001d0a0: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0001d0b0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+0001d0c0: 726e 6573 732e 6164 645f 6e65 7477 6f72  rness.add_networ
+0001d0d0: 6b28 2733 352e 302e 302e 3127 2c20 7265  k('35.0.0.1', re
+0001d0e0: 6c61 7469 6f6e 5f69 643d 7265 6c61 7469  lation_id=relati
+0001d0f0: 6f6e 5f69 6429 0a0a 2020 2020 6465 6620  on_id)..    def 
+0001d100: 7465 7374 5f61 6464 5f6e 6574 776f 726b  test_add_network
+0001d110: 5f72 656c 6174 696f 6e5f 6964 5f69 6e63  _relation_id_inc
+0001d120: 6f72 7265 6374 2873 656c 6629 3a0a 2020  orrect(self):.  
+0001d130: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0001d140: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
+0001d150: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0001d160: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+0001d170: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+0001d180: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0001d190: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+0001d1a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001d1b0: 6c66 2e68 6172 6e65 7373 2e61 6464 5f6e  lf.harness.add_n
+0001d1c0: 6574 776f 726b 2827 3335 2e30 2e30 2e31  etwork('35.0.0.1
+0001d1d0: 272c 2065 6e64 706f 696e 743d 2764 6227  ', endpoint='db'
+0001d1e0: 2c20 7265 6c61 7469 6f6e 5f69 643d 7265  , relation_id=re
+0001d1f0: 6c61 7469 6f6e 5f69 6420 2b20 3129 0a0a  lation_id + 1)..
+0001d200: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+0001d210: 5f6e 6574 776f 726b 5f65 6e64 706f 696e  _network_endpoin
+0001d220: 745f 616e 645f 7265 6c61 7469 6f6e 5f69  t_and_relation_i
+0001d230: 645f 646f 5f6e 6f74 5f63 6f72 7265 7370  d_do_not_corresp
+0001d240: 6f6e 6428 7365 6c66 293a 0a20 2020 2020  ond(self):.     
+0001d250: 2020 2072 656c 6174 696f 6e5f 6964 203d     relation_id =
+0001d260: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+0001d270: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+0001d280: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
+0001d290: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0001d2a0: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+0001d2b0: 732e 4d6f 6465 6c45 7272 6f72 293a 0a20  s.ModelError):. 
+0001d2c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001d2d0: 6861 726e 6573 732e 6164 645f 6e65 7477  harness.add_netw
+0001d2e0: 6f72 6b28 2733 352e 302e 302e 3127 2c20  ork('35.0.0.1', 
+0001d2f0: 656e 6470 6f69 6e74 3d27 666f 6f27 2c20  endpoint='foo', 
+0001d300: 7265 6c61 7469 6f6e 5f69 643d 7265 6c61  relation_id=rela
+0001d310: 7469 6f6e 5f69 6429 0a0a 0a63 6c61 7373  tion_id)...class
+0001d320: 2044 4252 656c 6174 696f 6e43 6861 6e67   DBRelationChang
+0001d330: 6564 4865 6c70 6572 286f 7073 2e4f 626a  edHelper(ops.Obj
+0001d340: 6563 7429 3a0a 2020 2020 6465 6620 5f5f  ect):.    def __
+0001d350: 696e 6974 5f5f 2873 656c 662c 2070 6172  init__(self, par
+0001d360: 656e 742c 206b 6579 293a 0a20 2020 2020  ent, key):.     
+0001d370: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+0001d380: 745f 5f28 7061 7265 6e74 2c20 6b65 7929  t__(parent, key)
+0001d390: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+0001d3a0: 616e 6765 7320 3d20 5b5d 0a20 2020 2020  anges = [].     
+0001d3b0: 2020 2070 6172 656e 742e 6672 616d 6577     parent.framew
+0001d3c0: 6f72 6b2e 6f62 7365 7276 6528 7061 7265  ork.observe(pare
+0001d3d0: 6e74 2e6f 6e2e 6462 5f72 656c 6174 696f  nt.on.db_relatio
+0001d3e0: 6e5f 6368 616e 6765 642c 2073 656c 662e  n_changed, self.
+0001d3f0: 6f6e 5f72 656c 6174 696f 6e5f 6368 616e  on_relation_chan
+0001d400: 6765 6429 0a0a 2020 2020 6465 6620 6f6e  ged)..    def on
+0001d410: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
+0001d420: 6428 7365 6c66 2c20 6576 656e 7429 3a0a  d(self, event):.
+0001d430: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
+0001d440: 2e75 6e69 7420 6973 206e 6f74 204e 6f6e  .unit is not Non
+0001d450: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0001d460: 656c 662e 6368 616e 6765 732e 6170 7065  elf.changes.appe
+0001d470: 6e64 2828 6576 656e 742e 7265 6c61 7469  nd((event.relati
+0001d480: 6f6e 2e69 642c 2065 7665 6e74 2e75 6e69  on.id, event.uni
+0001d490: 742e 6e61 6d65 2929 0a20 2020 2020 2020  t.name)).       
+0001d4a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001d4b0: 2020 2073 656c 662e 6368 616e 6765 732e     self.changes.
+0001d4c0: 6170 7065 6e64 2828 6576 656e 742e 7265  append((event.re
+0001d4d0: 6c61 7469 6f6e 2e69 642c 2065 7665 6e74  lation.id, event
+0001d4e0: 2e61 7070 2e6e 616d 6529 290a 0a0a 636c  .app.name))...cl
+0001d4f0: 6173 7320 5265 6c61 7469 6f6e 4368 616e  ass RelationChan
+0001d500: 6765 6456 6965 7765 7228 6f70 732e 4f62  gedViewer(ops.Ob
+0001d510: 6a65 6374 293a 0a20 2020 2022 2222 5472  ject):.    """Tr
+0001d520: 6163 6b20 7265 6c61 7469 6f6e 5f63 6861  ack relation_cha
+0001d530: 6e67 6564 2065 7665 6e74 7320 616e 6420  nged events and 
+0001d540: 7361 7665 7320 7468 6520 6461 7461 2073  saves the data s
+0001d550: 6565 6e20 696e 2074 6865 2072 656c 6174  een in the relat
+0001d560: 696f 6e20 6275 636b 6574 2e22 2222 0a0a  ion bucket."""..
+0001d570: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0001d580: 2873 656c 662c 2063 6861 726d 2c20 7265  (self, charm, re
+0001d590: 6c61 7469 6f6e 5f6e 616d 6529 3a0a 2020  lation_name):.  
+0001d5a0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+0001d5b0: 696e 6974 5f5f 2863 6861 726d 2c20 7265  init__(charm, re
+0001d5c0: 6c61 7469 6f6e 5f6e 616d 6529 0a20 2020  lation_name).   
+0001d5d0: 2020 2020 2073 656c 662e 6368 616e 6765       self.change
+0001d5e0: 7320 3d20 5b5d 0a20 2020 2020 2020 2063  s = [].        c
+0001d5f0: 6861 726d 2e66 7261 6d65 776f 726b 2e6f  harm.framework.o
+0001d600: 6273 6572 7665 2863 6861 726d 2e6f 6e5b  bserve(charm.on[
+0001d610: 7265 6c61 7469 6f6e 5f6e 616d 655d 2e72  relation_name].r
+0001d620: 656c 6174 696f 6e5f 6368 616e 6765 642c  elation_changed,
+0001d630: 2073 656c 662e 6f6e 5f72 656c 6174 696f   self.on_relatio
+0001d640: 6e5f 6368 616e 6765 6429 0a0a 2020 2020  n_changed)..    
+0001d650: 6465 6620 6f6e 5f72 656c 6174 696f 6e5f  def on_relation_
+0001d660: 6368 616e 6765 6428 7365 6c66 2c20 6576  changed(self, ev
+0001d670: 656e 7429 3a0a 2020 2020 2020 2020 6966  ent):.        if
+0001d680: 2065 7665 6e74 2e75 6e69 7420 6973 206e   event.unit is n
+0001d690: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001d6a0: 2020 2020 2064 6174 6120 3d20 6576 656e       data = even
+0001d6b0: 742e 7265 6c61 7469 6f6e 2e64 6174 615b  t.relation.data[
+0001d6c0: 6576 656e 742e 756e 6974 5d0a 2020 2020  event.unit].    
+0001d6d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001d6e0: 2020 2020 2020 6461 7461 203d 2065 7665        data = eve
+0001d6f0: 6e74 2e72 656c 6174 696f 6e2e 6461 7461  nt.relation.data
+0001d700: 5b65 7665 6e74 2e61 7070 5d0a 2020 2020  [event.app].    
+0001d710: 2020 2020 7365 6c66 2e63 6861 6e67 6573      self.changes
+0001d720: 2e61 7070 656e 6428 6469 6374 2864 6174  .append(dict(dat
+0001d730: 6129 290a 0a0a 636c 6173 7320 5265 636f  a))...class Reco
+0001d740: 7264 696e 6743 6861 726d 286f 7073 2e43  rdingCharm(ops.C
+0001d750: 6861 726d 4261 7365 293a 0a20 2020 2022  harmBase):.    "
+0001d760: 2222 5265 636f 7264 2074 6865 2065 7665  ""Record the eve
+0001d770: 6e74 7320 7468 6174 2077 6520 7365 652c  nts that we see,
+0001d780: 2061 6e64 2061 6e79 2061 7373 6f63 6961   and any associa
+0001d790: 7465 6420 6461 7461 2e22 2222 0a0a 2020  ted data."""..  
+0001d7a0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0001d7b0: 656c 662c 2066 7261 6d65 776f 726b 293a  elf, framework):
+0001d7c0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+0001d7d0: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
+0001d7e0: 6f72 6b29 0a20 2020 2020 2020 2073 656c  ork).        sel
+0001d7f0: 662e 6368 616e 6765 7320 3d20 5b5d 0a20  f.changes = []. 
+0001d800: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
+0001d810: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
+0001d820: 6c66 2e6f 6e2e 636f 6e66 6967 5f63 6861  lf.on.config_cha
+0001d830: 6e67 6564 2c20 7365 6c66 2e5f 6f6e 5f63  nged, self._on_c
+0001d840: 6f6e 6669 675f 6368 616e 6765 6429 0a20  onfig_changed). 
+0001d850: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
+0001d860: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
+0001d870: 6c66 2e6f 6e2e 6c65 6164 6572 5f65 6c65  lf.on.leader_ele
+0001d880: 6374 6564 2c20 7365 6c66 2e5f 6f6e 5f6c  cted, self._on_l
+0001d890: 6561 6465 725f 656c 6563 7465 6429 0a20  eader_elected). 
+0001d8a0: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
+0001d8b0: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
+0001d8c0: 6c66 2e6f 6e2e 6c65 6164 6572 5f73 6574  lf.on.leader_set
+0001d8d0: 7469 6e67 735f 6368 616e 6765 642c 2073  tings_changed, s
+0001d8e0: 656c 662e 5f6f 6e5f 6c65 6164 6572 5f73  elf._on_leader_s
+0001d8f0: 6574 7469 6e67 735f 6368 616e 6765 6429  ettings_changed)
+0001d900: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
+0001d910: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
+0001d920: 7365 6c66 2e6f 6e2e 696e 7374 616c 6c2c  self.on.install,
+0001d930: 2073 656c 662e 5f6f 6e5f 696e 7374 616c   self._on_instal
+0001d940: 6c29 0a20 2020 2020 2020 2073 656c 662e  l).        self.
+0001d950: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
+0001d960: 6528 7365 6c66 2e6f 6e2e 7374 6172 742c  e(self.on.start,
+0001d970: 2073 656c 662e 5f6f 6e5f 7374 6172 7429   self._on_start)
+0001d980: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
+0001d990: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
+0001d9a0: 7365 6c66 2e6f 6e2e 7374 6f70 2c20 7365  self.on.stop, se
+0001d9b0: 6c66 2e5f 6f6e 5f73 746f 7029 0a20 2020  lf._on_stop).   
+0001d9c0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+0001d9d0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+0001d9e0: 2e6f 6e2e 7265 6d6f 7665 2c20 7365 6c66  .on.remove, self
+0001d9f0: 2e5f 6f6e 5f72 656d 6f76 6529 0a20 2020  ._on_remove).   
+0001da00: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+0001da10: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+0001da20: 2e6f 6e2e 7570 6772 6164 655f 6368 6172  .on.upgrade_char
+0001da30: 6d2c 2073 656c 662e 5f6f 6e5f 7570 6772  m, self._on_upgr
+0001da40: 6164 655f 6368 6172 6d29 0a20 2020 2020  ade_charm).     
+0001da50: 2020 2073 656c 662e 6672 616d 6577 6f72     self.framewor
+0001da60: 6b2e 6f62 7365 7276 6528 7365 6c66 2e6f  k.observe(self.o
+0001da70: 6e2e 7570 6461 7465 5f73 7461 7475 732c  n.update_status,
+0001da80: 2073 656c 662e 5f6f 6e5f 7570 6461 7465   self._on_update
+0001da90: 5f73 7461 7475 7329 0a0a 2020 2020 6465  _status)..    de
+0001daa0: 6620 6765 745f 6368 616e 6765 7328 7365  f get_changes(se
+0001dab0: 6c66 2c20 7265 7365 743d 5472 7565 293a  lf, reset=True):
+0001dac0: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
+0001dad0: 203d 2073 656c 662e 6368 616e 6765 730a   = self.changes.
+0001dae0: 2020 2020 2020 2020 6966 2072 6573 6574          if reset
+0001daf0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001db00: 6c66 2e63 6861 6e67 6573 203d 205b 5d0a  lf.changes = [].
+0001db10: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0001db20: 6861 6e67 6573 0a0a 2020 2020 6465 6620  hanges..    def 
+0001db30: 5f6f 6e5f 696e 7374 616c 6c28 7365 6c66  _on_install(self
+0001db40: 2c20 5f29 3a0a 2020 2020 2020 2020 6966  , _):.        if
+0001db50: 2073 656c 662e 636f 6e66 6967 2e67 6574   self.config.get
+0001db60: 2827 7365 745f 7374 6174 7573 2729 3a0a  ('set_status'):.
+0001db70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001db80: 2e75 6e69 742e 7374 6174 7573 203d 206f  .unit.status = o
+0001db90: 7073 2e4d 6169 6e74 656e 616e 6365 5374  ps.MaintenanceSt
+0001dba0: 6174 7573 2822 5374 6174 7573 2073 6574  atus("Status set
+0001dbb0: 206f 6e20 696e 7374 616c 6c22 290a 2020   on install").  
+0001dbc0: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
+0001dbd0: 6573 2e61 7070 656e 6428 6469 6374 286e  es.append(dict(n
+0001dbe0: 616d 653d 2769 6e73 7461 6c6c 2729 290a  ame='install')).
+0001dbf0: 0a20 2020 2064 6566 205f 6f6e 5f73 7461  .    def _on_sta
+0001dc00: 7274 2873 656c 662c 205f 293a 0a20 2020  rt(self, _):.   
+0001dc10: 2020 2020 2073 656c 662e 6368 616e 6765       self.change
+0001dc20: 732e 6170 7065 6e64 2864 6963 7428 6e61  s.append(dict(na
+0001dc30: 6d65 3d27 7374 6172 7427 2929 0a0a 2020  me='start'))..  
+0001dc40: 2020 6465 6620 5f6f 6e5f 7374 6f70 2873    def _on_stop(s
+0001dc50: 656c 662c 205f 293a 0a20 2020 2020 2020  elf, _):.       
+0001dc60: 2073 656c 662e 6368 616e 6765 732e 6170   self.changes.ap
+0001dc70: 7065 6e64 2864 6963 7428 6e61 6d65 3d27  pend(dict(name='
+0001dc80: 7374 6f70 2729 290a 0a20 2020 2064 6566  stop'))..    def
+0001dc90: 205f 6f6e 5f72 656d 6f76 6528 7365 6c66   _on_remove(self
+0001dca0: 2c20 5f29 3a0a 2020 2020 2020 2020 7365  , _):.        se
+0001dcb0: 6c66 2e63 6861 6e67 6573 2e61 7070 656e  lf.changes.appen
+0001dcc0: 6428 6469 6374 286e 616d 653d 2772 656d  d(dict(name='rem
+0001dcd0: 6f76 6527 2929 0a0a 2020 2020 6465 6620  ove'))..    def 
+0001dce0: 5f6f 6e5f 636f 6e66 6967 5f63 6861 6e67  _on_config_chang
+0001dcf0: 6564 2873 656c 662c 205f 293a 0a20 2020  ed(self, _):.   
+0001dd00: 2020 2020 2073 656c 662e 6368 616e 6765       self.change
+0001dd10: 732e 6170 7065 6e64 2864 6963 7428 6e61  s.append(dict(na
+0001dd20: 6d65 3d27 636f 6e66 6967 2d63 6861 6e67  me='config-chang
+0001dd30: 6564 272c 2064 6174 613d 6469 6374 2873  ed', data=dict(s
+0001dd40: 656c 662e 6672 616d 6577 6f72 6b2e 6d6f  elf.framework.mo
+0001dd50: 6465 6c2e 636f 6e66 6967 2929 290a 0a20  del.config))).. 
+0001dd60: 2020 2064 6566 205f 6f6e 5f6c 6561 6465     def _on_leade
+0001dd70: 725f 656c 6563 7465 6428 7365 6c66 2c20  r_elected(self, 
+0001dd80: 5f29 3a0a 2020 2020 2020 2020 7365 6c66  _):.        self
+0001dd90: 2e63 6861 6e67 6573 2e61 7070 656e 6428  .changes.append(
+0001dda0: 6469 6374 286e 616d 653d 276c 6561 6465  dict(name='leade
+0001ddb0: 722d 656c 6563 7465 6427 2929 0a0a 2020  r-elected'))..  
+0001ddc0: 2020 6465 6620 5f6f 6e5f 6c65 6164 6572    def _on_leader
+0001ddd0: 5f73 6574 7469 6e67 735f 6368 616e 6765  _settings_change
+0001dde0: 6428 7365 6c66 2c20 5f29 3a0a 2020 2020  d(self, _):.    
+0001ddf0: 2020 2020 7365 6c66 2e63 6861 6e67 6573      self.changes
+0001de00: 2e61 7070 656e 6428 6469 6374 286e 616d  .append(dict(nam
+0001de10: 653d 276c 6561 6465 722d 7365 7474 696e  e='leader-settin
+0001de20: 6773 2d63 6861 6e67 6564 2729 290a 0a20  gs-changed')).. 
+0001de30: 2020 2064 6566 205f 6f6e 5f75 7067 7261     def _on_upgra
+0001de40: 6465 5f63 6861 726d 2873 656c 662c 205f  de_charm(self, _
+0001de50: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0001de60: 6368 616e 6765 732e 6170 7065 6e64 2864  changes.append(d
+0001de70: 6963 7428 6e61 6d65 3d27 7570 6772 6164  ict(name='upgrad
+0001de80: 652d 6368 6172 6d27 2929 0a0a 2020 2020  e-charm'))..    
+0001de90: 6465 6620 5f6f 6e5f 7570 6461 7465 5f73  def _on_update_s
+0001dea0: 7461 7475 7328 7365 6c66 2c20 5f29 3a0a  tatus(self, _):.
+0001deb0: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
+0001dec0: 6e67 6573 2e61 7070 656e 6428 6469 6374  nges.append(dict
+0001ded0: 286e 616d 653d 2775 7064 6174 652d 7374  (name='update-st
+0001dee0: 6174 7573 2729 290a 0a0a 636c 6173 7320  atus'))...class 
+0001def0: 5265 6c61 7469 6f6e 4576 656e 7443 6861  RelationEventCha
+0001df00: 726d 2852 6563 6f72 6469 6e67 4368 6172  rm(RecordingChar
+0001df10: 6d29 3a0a 2020 2020 2222 2252 6563 6f72  m):.    """Recor
+0001df20: 6420 6576 656e 7473 2072 656c 6174 6564  d events related
+0001df30: 2074 6f20 7265 6c61 7469 6f6e 206c 6966   to relation lif
+0001df40: 6563 7963 6c65 732e 2222 220a 0a20 2020  ecycles."""..   
+0001df50: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0001df60: 6c66 2c20 6672 616d 6577 6f72 6b29 3a0a  lf, framework):.
+0001df70: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0001df80: 5f5f 696e 6974 5f5f 2866 7261 6d65 776f  __init__(framewo
+0001df90: 726b 290a 2020 2020 2020 2020 2320 5768  rk).        # Wh
+0001dfa0: 656e 2073 6574 2c20 7468 6973 2069 6e73  en set, this ins
+0001dfb0: 7472 7563 7473 2074 6865 2063 6861 726d  tructs the charm
+0001dfc0: 2074 6f20 696e 636c 7564 6520 6120 2772   to include a 'r
+0001dfd0: 656c 6174 696f 6e5f 6461 7461 2720 6669  elation_data' fi
+0001dfe0: 656c 6420 696e 2074 6865 2027 6461 7461  eld in the 'data
+0001dff0: 270a 2020 2020 2020 2020 2320 7365 6374  '.        # sect
+0001e000: 696f 6e20 6f66 2065 6163 6820 6368 616e  ion of each chan
+0001e010: 6765 2069 7420 6c6f 6773 2c20 7768 6963  ge it logs, whic
+0001e020: 6820 616c 6c6f 7773 2075 7320 746f 2074  h allows us to t
+0001e030: 6573 7420 7768 6963 6820 7265 6c61 7469  est which relati
+0001e040: 6f6e 2064 6174 6120 7761 7320 6176 6169  on data was avai
+0001e050: 6c61 626c 650a 2020 2020 2020 2020 2320  lable.        # 
+0001e060: 696e 2065 6163 6820 686f 6f6b 2069 6e76  in each hook inv
+0001e070: 6f63 6174 696f 6e0a 2020 2020 2020 2020  ocation.        
+0001e080: 7365 6c66 2e72 6563 6f72 645f 7265 6c61  self.record_rela
+0001e090: 7469 6f6e 5f64 6174 615f 6f6e 5f65 7665  tion_data_on_eve
+0001e0a0: 6e74 7320 3d20 4661 6c73 650a 0a20 2020  nts = False..   
+0001e0b0: 2064 6566 206f 6273 6572 7665 5f72 656c   def observe_rel
+0001e0c0: 6174 696f 6e5f 6576 656e 7473 2873 656c  ation_events(sel
+0001e0d0: 662c 2072 656c 6174 696f 6e5f 6e61 6d65  f, relation_name
+0001e0e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0001e0f0: 7265 6c61 7469 6f6e 5f6e 616d 6520 3d20  relation_name = 
+0001e100: 7265 6c61 7469 6f6e 5f6e 616d 650a 2020  relation_name.  
+0001e110: 2020 2020 2020 7365 6c66 2e66 7261 6d65        self.frame
+0001e120: 776f 726b 2e6f 6273 6572 7665 2873 656c  work.observe(sel
+0001e130: 662e 6f6e 5b72 656c 6174 696f 6e5f 6e61  f.on[relation_na
+0001e140: 6d65 5d2e 7265 6c61 7469 6f6e 5f63 7265  me].relation_cre
+0001e150: 6174 6564 2c20 7365 6c66 2e5f 6f6e 5f72  ated, self._on_r
+0001e160: 656c 6174 696f 6e5f 6372 6561 7465 6429  elation_created)
+0001e170: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
+0001e180: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
+0001e190: 7365 6c66 2e6f 6e5b 7265 6c61 7469 6f6e  self.on[relation
+0001e1a0: 5f6e 616d 655d 2e72 656c 6174 696f 6e5f  _name].relation_
+0001e1b0: 6a6f 696e 6564 2c20 7365 6c66 2e5f 6f6e  joined, self._on
+0001e1c0: 5f72 656c 6174 696f 6e5f 6a6f 696e 6564  _relation_joined
+0001e1d0: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+0001e1e0: 7261 6d65 776f 726b 2e6f 6273 6572 7665  ramework.observe
+0001e1f0: 2873 656c 662e 6f6e 5b72 656c 6174 696f  (self.on[relatio
+0001e200: 6e5f 6e61 6d65 5d2e 7265 6c61 7469 6f6e  n_name].relation
+0001e210: 5f63 6861 6e67 6564 2c20 7365 6c66 2e5f  _changed, self._
+0001e220: 6f6e 5f72 656c 6174 696f 6e5f 6368 616e  on_relation_chan
+0001e230: 6765 6429 0a20 2020 2020 2020 2073 656c  ged).        sel
+0001e240: 662e 6672 616d 6577 6f72 6b2e 6f62 7365  f.framework.obse
+0001e250: 7276 6528 7365 6c66 2e6f 6e5b 7265 6c61  rve(self.on[rela
+0001e260: 7469 6f6e 5f6e 616d 655d 2e72 656c 6174  tion_name].relat
+0001e270: 696f 6e5f 6465 7061 7274 6564 2c0a 2020  ion_departed,.  
+0001e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e290: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001e2a0: 662e 5f6f 6e5f 7265 6c61 7469 6f6e 5f64  f._on_relation_d
+0001e2b0: 6570 6172 7465 6429 0a20 2020 2020 2020  eparted).       
+0001e2c0: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
+0001e2d0: 6f62 7365 7276 6528 7365 6c66 2e6f 6e5b  observe(self.on[
+0001e2e0: 7265 6c61 7469 6f6e 5f6e 616d 655d 2e72  relation_name].r
+0001e2f0: 656c 6174 696f 6e5f 6272 6f6b 656e 2c20  elation_broken, 
+0001e300: 7365 6c66 2e5f 6f6e 5f72 656c 6174 696f  self._on_relatio
+0001e310: 6e5f 6272 6f6b 656e 290a 0a20 2020 2064  n_broken)..    d
+0001e320: 6566 205f 6f6e 5f72 656c 6174 696f 6e5f  ef _on_relation_
+0001e330: 6372 6561 7465 6428 7365 6c66 2c20 6576  created(self, ev
+0001e340: 656e 7429 3a0a 2020 2020 2020 2020 7365  ent):.        se
+0001e350: 6c66 2e5f 6f62 7365 7276 655f 7265 6c61  lf._observe_rela
+0001e360: 7469 6f6e 5f65 7665 6e74 2827 7265 6c61  tion_event('rela
+0001e370: 7469 6f6e 2d63 7265 6174 6564 272c 2065  tion-created', e
+0001e380: 7665 6e74 290a 0a20 2020 2064 6566 205f  vent)..    def _
+0001e390: 6f6e 5f72 656c 6174 696f 6e5f 6a6f 696e  on_relation_join
+0001e3a0: 6564 2873 656c 662c 2065 7665 6e74 293a  ed(self, event):
+0001e3b0: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
+0001e3c0: 6273 6572 7665 5f72 656c 6174 696f 6e5f  bserve_relation_
+0001e3d0: 6576 656e 7428 2772 656c 6174 696f 6e2d  event('relation-
+0001e3e0: 6a6f 696e 6564 272c 2065 7665 6e74 290a  joined', event).
+0001e3f0: 0a20 2020 2064 6566 205f 6f6e 5f72 656c  .    def _on_rel
+0001e400: 6174 696f 6e5f 6368 616e 6765 6428 7365  ation_changed(se
+0001e410: 6c66 2c20 6576 656e 7429 3a0a 2020 2020  lf, event):.    
+0001e420: 2020 2020 7365 6c66 2e5f 6f62 7365 7276      self._observ
+0001e430: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+0001e440: 2827 7265 6c61 7469 6f6e 2d63 6861 6e67  ('relation-chang
+0001e450: 6564 272c 2065 7665 6e74 290a 0a20 2020  ed', event)..   
+0001e460: 2064 6566 205f 6f6e 5f72 656c 6174 696f   def _on_relatio
+0001e470: 6e5f 6465 7061 7274 6564 2873 656c 662c  n_departed(self,
+0001e480: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
+0001e490: 2073 656c 662e 5f6f 6273 6572 7665 5f72   self._observe_r
+0001e4a0: 656c 6174 696f 6e5f 6576 656e 7428 2772  elation_event('r
+0001e4b0: 656c 6174 696f 6e2d 6465 7061 7274 6564  elation-departed
+0001e4c0: 272c 2065 7665 6e74 290a 0a20 2020 2064  ', event)..    d
+0001e4d0: 6566 205f 6f6e 5f72 656c 6174 696f 6e5f  ef _on_relation_
+0001e4e0: 6272 6f6b 656e 2873 656c 662c 2065 7665  broken(self, eve
+0001e4f0: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
+0001e500: 662e 5f6f 6273 6572 7665 5f72 656c 6174  f._observe_relat
+0001e510: 696f 6e5f 6576 656e 7428 2772 656c 6174  ion_event('relat
+0001e520: 696f 6e2d 6272 6f6b 656e 272c 2065 7665  ion-broken', eve
+0001e530: 6e74 290a 0a20 2020 2064 6566 205f 6f62  nt)..    def _ob
+0001e540: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
+0001e550: 7665 6e74 2873 656c 662c 2065 7665 6e74  vent(self, event
+0001e560: 5f6e 616d 652c 2065 7665 6e74 293a 0a20  _name, event):. 
+0001e570: 2020 2020 2020 2075 6e69 745f 6e61 6d65         unit_name
+0001e580: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0001e590: 6966 2065 7665 6e74 2e75 6e69 7420 6973  if event.unit is
+0001e5a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001e5b0: 2020 2020 2020 2075 6e69 745f 6e61 6d65         unit_name
+0001e5c0: 203d 2065 7665 6e74 2e75 6e69 742e 6e61   = event.unit.na
+0001e5d0: 6d65 0a20 2020 2020 2020 2061 7070 5f6e  me.        app_n
+0001e5e0: 616d 6520 3d20 4e6f 6e65 0a20 2020 2020  ame = None.     
+0001e5f0: 2020 2069 6620 6576 656e 742e 6170 7020     if event.app 
+0001e600: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001e610: 2020 2020 2020 2020 2061 7070 5f6e 616d           app_nam
+0001e620: 6520 3d20 6576 656e 742e 6170 702e 6e61  e = event.app.na
+0001e630: 6d65 0a0a 2020 2020 2020 2020 6461 7461  me..        data
+0001e640: 203d 2064 6963 7428 6170 703d 6170 705f   = dict(app=app_
+0001e650: 6e61 6d65 2c20 756e 6974 3d75 6e69 745f  name, unit=unit_
+0001e660: 6e61 6d65 2c20 7265 6c61 7469 6f6e 5f69  name, relation_i
+0001e670: 643d 6576 656e 742e 7265 6c61 7469 6f6e  d=event.relation
+0001e680: 2e69 6429 0a20 2020 2020 2020 2069 6620  .id).        if 
+0001e690: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+0001e6a0: 2c20 6f70 732e 5265 6c61 7469 6f6e 4465  , ops.RelationDe
+0001e6b0: 7061 7274 6564 4576 656e 7429 3a0a 2020  partedEvent):.  
+0001e6c0: 2020 2020 2020 2020 2020 6461 7461 5b27            data['
+0001e6d0: 6465 7061 7274 696e 675f 756e 6974 275d  departing_unit']
+0001e6e0: 203d 2065 7665 6e74 2e64 6570 6172 7469   = event.departi
+0001e6f0: 6e67 5f75 6e69 742e 6e61 6d65 0a0a 2020  ng_unit.name..  
+0001e700: 2020 2020 2020 7265 636f 7264 696e 6720        recording 
+0001e710: 3d20 6469 6374 286e 616d 653d 6576 656e  = dict(name=even
+0001e720: 745f 6e61 6d65 2c20 7265 6c61 7469 6f6e  t_name, relation
+0001e730: 3d65 7665 6e74 2e72 656c 6174 696f 6e2e  =event.relation.
+0001e740: 6e61 6d65 2c20 6461 7461 3d64 6174 6129  name, data=data)
+0001e750: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0001e760: 662e 7265 636f 7264 5f72 656c 6174 696f  f.record_relatio
+0001e770: 6e5f 6461 7461 5f6f 6e5f 6576 656e 7473  n_data_on_events
+0001e780: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001e790: 636f 7264 696e 675b 2264 6174 6122 5d2e  cording["data"].
+0001e7a0: 7570 6461 7465 287b 2772 656c 6174 696f  update({'relatio
+0001e7b0: 6e5f 6461 7461 273a 207b 0a20 2020 2020  n_data': {.     
+0001e7c0: 2020 2020 2020 2020 2020 2073 7472 2878             str(x
+0001e7d0: 2e6e 616d 6529 3a20 6469 6374 2865 7665  .name): dict(eve
+0001e7e0: 6e74 2e72 656c 6174 696f 6e2e 6461 7461  nt.relation.data
+0001e7f0: 5b78 5d29 0a20 2020 2020 2020 2020 2020  [x]).           
+0001e800: 2020 2020 2066 6f72 2078 2069 6e20 6576       for x in ev
+0001e810: 656e 742e 7265 6c61 7469 6f6e 2e64 6174  ent.relation.dat
+0001e820: 610a 2020 2020 2020 2020 2020 2020 7d7d  a.            }}
+0001e830: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001e840: 6368 616e 6765 732e 6170 7065 6e64 2872  changes.append(r
+0001e850: 6563 6f72 6469 6e67 290a 0a0a 636c 6173  ecording)...clas
+0001e860: 7320 5265 6c61 7469 6f6e 4272 6f6b 656e  s RelationBroken
+0001e870: 5465 7374 6572 2852 656c 6174 696f 6e45  Tester(RelationE
+0001e880: 7665 6e74 4368 6172 6d29 3a0a 2020 2020  ventCharm):.    
+0001e890: 2222 2241 6363 6573 7320 696e 6163 6365  """Access inacce
+0001e8a0: 7373 6962 6c65 2072 656c 6174 696f 6e20  ssible relation 
+0001e8b0: 6461 7461 2e22 2222 0a0a 2020 2020 6465  data."""..    de
+0001e8c0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+0001e8d0: 2066 7261 6d65 776f 726b 293a 0a20 2020   framework):.   
+0001e8e0: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+0001e8f0: 6e69 745f 5f28 6672 616d 6577 6f72 6b29  nit__(framework)
+0001e900: 0a0a 2020 2020 6465 6620 5f6f 6e5f 7265  ..    def _on_re
+0001e910: 6c61 7469 6f6e 5f62 726f 6b65 6e28 7365  lation_broken(se
+0001e920: 6c66 2c20 6576 656e 7429 3a0a 2020 2020  lf, event):.    
+0001e930: 2020 2020 7072 696e 7428 6576 656e 742e      print(event.
+0001e940: 7265 6c61 7469 6f6e 2e64 6174 615b 6576  relation.data[ev
+0001e950: 656e 742e 7265 6c61 7469 6f6e 2e61 7070  ent.relation.app
+0001e960: 5d5b 2762 6172 275d 290a 0a0a 636c 6173  ]['bar'])...clas
+0001e970: 7320 436f 6e74 6169 6e65 7245 7665 6e74  s ContainerEvent
+0001e980: 4368 6172 6d28 5265 636f 7264 696e 6743  Charm(RecordingC
+0001e990: 6861 726d 293a 0a20 2020 2022 2222 5265  harm):.    """Re
+0001e9a0: 636f 7264 2065 7665 6e74 7320 7265 6c61  cord events rela
+0001e9b0: 7465 6420 746f 2063 6f6e 7461 696e 6572  ted to container
+0001e9c0: 206c 6966 6563 7963 6c65 732e 2222 220a   lifecycles.""".
+0001e9d0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0001e9e0: 5f28 7365 6c66 2c20 6672 616d 6577 6f72  _(self, framewor
+0001e9f0: 6b29 3a0a 2020 2020 2020 2020 7375 7065  k):.        supe
+0001ea00: 7228 292e 5f5f 696e 6974 5f5f 2866 7261  r().__init__(fra
+0001ea10: 6d65 776f 726b 290a 0a20 2020 2064 6566  mework)..    def
+0001ea20: 206f 6273 6572 7665 5f63 6f6e 7461 696e   observe_contain
+0001ea30: 6572 5f65 7665 6e74 7328 7365 6c66 2c20  er_events(self, 
+0001ea40: 636f 6e74 6169 6e65 725f 6e61 6d65 293a  container_name):
+0001ea50: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
+0001ea60: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
+0001ea70: 7365 6c66 2e6f 6e5b 636f 6e74 6169 6e65  self.on[containe
+0001ea80: 725f 6e61 6d65 5d2e 7065 6262 6c65 5f72  r_name].pebble_r
+0001ea90: 6561 6479 2c20 7365 6c66 2e5f 6f6e 5f70  eady, self._on_p
+0001eaa0: 6562 626c 655f 7265 6164 7929 0a0a 2020  ebble_ready)..  
+0001eab0: 2020 6465 6620 5f6f 6e5f 7065 6262 6c65    def _on_pebble
+0001eac0: 5f72 6561 6479 2873 656c 662c 2065 7665  _ready(self, eve
+0001ead0: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
+0001eae0: 662e 5f6f 6273 6572 7665 5f63 6f6e 7461  f._observe_conta
+0001eaf0: 696e 6572 5f65 7665 6e74 2827 7065 6262  iner_event('pebb
+0001eb00: 6c65 2d72 6561 6479 272c 2065 7665 6e74  le-ready', event
+0001eb10: 290a 0a20 2020 2064 6566 205f 6f62 7365  )..    def _obse
+0001eb20: 7276 655f 636f 6e74 6169 6e65 725f 6576  rve_container_ev
+0001eb30: 656e 7428 7365 6c66 2c20 6576 656e 745f  ent(self, event_
+0001eb40: 6e61 6d65 2c20 6576 656e 743a 206f 7073  name, event: ops
+0001eb50: 2e50 6562 626c 6552 6561 6479 4576 656e  .PebbleReadyEven
+0001eb60: 7429 3a0a 2020 2020 2020 2020 636f 6e74  t):.        cont
+0001eb70: 6169 6e65 725f 6e61 6d65 203d 204e 6f6e  ainer_name = Non
+0001eb80: 650a 2020 2020 2020 2020 6966 2065 7665  e.        if eve
+0001eb90: 6e74 2e77 6f72 6b6c 6f61 6420 6973 206e  nt.workload is n
+0001eba0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001ebb0: 2020 2020 2063 6f6e 7461 696e 6572 5f6e       container_n
+0001ebc0: 616d 6520 3d20 6576 656e 742e 776f 726b  ame = event.work
+0001ebd0: 6c6f 6164 2e6e 616d 650a 2020 2020 2020  load.name.      
+0001ebe0: 2020 7365 6c66 2e63 6861 6e67 6573 2e61    self.changes.a
+0001ebf0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+0001ec00: 2020 2064 6963 7428 6e61 6d65 3d65 7665     dict(name=eve
+0001ec10: 6e74 5f6e 616d 652c 2063 6f6e 7461 696e  nt_name, contain
+0001ec20: 6572 3d63 6f6e 7461 696e 6572 5f6e 616d  er=container_nam
+0001ec30: 6529 290a 0a0a 6465 6620 6765 745f 7075  e))...def get_pu
+0001ec40: 626c 6963 5f6d 6574 686f 6473 286f 626a  blic_methods(obj
+0001ec50: 293a 0a20 2020 2022 2222 4765 7420 7468  ):.    """Get th
+0001ec60: 6520 7075 626c 6963 2061 7474 7269 6275  e public attribu
+0001ec70: 7465 7320 6f66 206f 626a 2074 6f20 636f  tes of obj to co
+0001ec80: 6d70 6172 6520 746f 2061 6e6f 7468 6572  mpare to another
+0001ec90: 206f 626a 6563 742e 2222 220a 2020 2020   object.""".    
+0001eca0: 7075 626c 6963 203d 2073 6574 2829 0a20  public = set(). 
+0001ecb0: 2020 206d 656d 6265 7273 203d 2069 6e73     members = ins
+0001ecc0: 7065 6374 2e67 6574 6d65 6d62 6572 7328  pect.getmembers(
+0001ecd0: 6f62 6a29 0a20 2020 2066 6f72 206e 616d  obj).    for nam
+0001ece0: 652c 206d 656d 6265 7220 696e 206d 656d  e, member in mem
+0001ecf0: 6265 7273 3a0a 2020 2020 2020 2020 6966  bers:.        if
+0001ed00: 206e 616d 652e 7374 6172 7473 7769 7468   name.startswith
+0001ed10: 2827 5f27 293a 0a20 2020 2020 2020 2020  ('_'):.         
+0001ed20: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0001ed30: 2020 2020 6966 2069 6e73 7065 6374 2e69      if inspect.i
+0001ed40: 7366 756e 6374 696f 6e28 6d65 6d62 6572  sfunction(member
+0001ed50: 2920 6f72 2069 6e73 7065 6374 2e69 736d  ) or inspect.ism
+0001ed60: 6574 686f 6428 6d65 6d62 6572 293a 0a20  ethod(member):. 
+0001ed70: 2020 2020 2020 2020 2020 2070 7562 6c69             publi
+0001ed80: 632e 6164 6428 6e61 6d65 290a 2020 2020  c.add(name).    
+0001ed90: 7265 7475 726e 2070 7562 6c69 630a 0a0a  return public...
+0001eda0: 636c 6173 7320 5465 7374 5465 7374 696e  class TestTestin
+0001edb0: 674d 6f64 656c 4261 636b 656e 6428 756e  gModelBackend(un
+0001edc0: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
+0001edd0: 3a0a 0a20 2020 2064 6566 2074 6573 745f  :..    def test_
+0001ede0: 636f 6e66 6f72 6d73 5f74 6f5f 6d6f 6465  conforms_to_mode
+0001edf0: 6c5f 6261 636b 656e 6428 7365 6c66 293a  l_backend(self):
+0001ee00: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0001ee10: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0001ee20: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0001ee30: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+0001ee40: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+0001ee50: 2061 7070 0a20 2020 2020 2020 2020 2020   app.           
+0001ee60: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+0001ee70: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0001ee80: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+0001ee90: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+0001eea0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+0001eeb0: 640a 2020 2020 2020 2020 6d62 5f6d 6574  d.        mb_met
+0001eec0: 686f 6473 203d 2067 6574 5f70 7562 6c69  hods = get_publi
+0001eed0: 635f 6d65 7468 6f64 7328 5f4d 6f64 656c  c_methods(_Model
+0001eee0: 4261 636b 656e 6429 0a20 2020 2020 2020  Backend).       
+0001eef0: 2062 6163 6b65 6e64 5f6d 6574 686f 6473   backend_methods
+0001ef00: 203d 2067 6574 5f70 7562 6c69 635f 6d65   = get_public_me
+0001ef10: 7468 6f64 7328 6261 636b 656e 6429 0a20  thods(backend). 
+0001ef20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001ef30: 7274 4571 7561 6c28 6d62 5f6d 6574 686f  rtEqual(mb_metho
+0001ef40: 6473 2c20 6261 636b 656e 645f 6d65 7468  ds, backend_meth
+0001ef50: 6f64 7329 0a0a 2020 2020 6465 6620 7465  ods)..    def te
+0001ef60: 7374 5f6d 6f64 656c 5f75 7569 645f 6973  st_model_uuid_is
+0001ef70: 5f75 7569 645f 7634 2873 656c 6629 3a0a  _uuid_v4(self):.
+0001ef80: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0001ef90: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0001efa0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0001efb0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+0001efc0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0001efd0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+0001efe0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+0001eff0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0001f000: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0001f010: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+0001f020: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
+0001f030: 656e 640a 2020 2020 2020 2020 7365 6c66  end.        self
+0001f040: 2e61 7373 6572 7445 7175 616c 2875 7569  .assertEqual(uui
+0001f050: 642e 5555 4944 2862 6163 6b65 6e64 2e6d  d.UUID(backend.m
+0001f060: 6f64 656c 5f75 7569 6429 2e76 6572 7369  odel_uuid).versi
+0001f070: 6f6e 2c20 3429 0a0a 2020 2020 6465 6620  on, 4)..    def 
+0001f080: 7465 7374 5f73 7461 7475 735f 7365 745f  test_status_set_
+0001f090: 6765 745f 756e 6974 2873 656c 6629 3a0a  get_unit(self):.
+0001f0a0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0001f0b0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0001f0c0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0001f0d0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+0001f0e0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0001f0f0: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
+0001f100: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0001f110: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0001f120: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0001f130: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
+0001f140: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0001f150: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+0001f160: 2e73 7461 7475 735f 7365 7428 2762 6c6f  .status_set('blo
+0001f170: 636b 6564 272c 2027 6d65 7373 6167 6527  cked', 'message'
+0001f180: 2c20 6973 5f61 7070 3d46 616c 7365 290a  , is_app=False).
+0001f190: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001f1a0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+0001f1b0: 2020 2020 2020 6261 636b 656e 642e 7374        backend.st
+0001f1c0: 6174 7573 5f67 6574 2869 735f 6170 703d  atus_get(is_app=
+0001f1d0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+0001f1e0: 2020 2020 7b27 7374 6174 7573 273a 2027      {'status': '
+0001f1f0: 626c 6f63 6b65 6427 2c20 276d 6573 7361  blocked', 'messa
+0001f200: 6765 273a 2027 6d65 7373 6167 6527 7d29  ge': 'message'})
+0001f210: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f220: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+0001f230: 2020 2020 2020 2062 6163 6b65 6e64 2e73         backend.s
+0001f240: 7461 7475 735f 6765 7428 6973 5f61 7070  tatus_get(is_app
+0001f250: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+0001f260: 2020 2020 7b27 7374 6174 7573 273a 2027      {'status': '
+0001f270: 756e 6b6e 6f77 6e27 2c20 276d 6573 7361  unknown', 'messa
+0001f280: 6765 273a 2027 277d 290a 0a20 2020 2064  ge': ''})..    d
+0001f290: 6566 2074 6573 745f 7374 6174 7573 5f73  ef test_status_s
+0001f2a0: 6574 5f67 6574 5f61 7070 2873 656c 6629  et_get_app(self)
+0001f2b0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0001f2c0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0001f2d0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0001f2e0: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+0001f2f0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0001f300: 3a20 6170 700a 2020 2020 2020 2020 2020  : app.          
+0001f310: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+0001f320: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+0001f330: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+0001f340: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
+0001f350: 3d20 6861 726e 6573 732e 5f62 6163 6b65  = harness._backe
+0001f360: 6e64 0a20 2020 2020 2020 2062 6163 6b65  nd.        backe
+0001f370: 6e64 2e73 7461 7475 735f 7365 7428 2762  nd.status_set('b
+0001f380: 6c6f 636b 6564 272c 2027 6d65 7373 6167  locked', 'messag
+0001f390: 6527 2c20 6973 5f61 7070 3d54 7275 6529  e', is_app=True)
+0001f3a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f3b0: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+0001f3c0: 2020 2020 2020 2062 6163 6b65 6e64 2e73         backend.s
+0001f3d0: 7461 7475 735f 6765 7428 6973 5f61 7070  tatus_get(is_app
+0001f3e0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+0001f3f0: 2020 2020 7b27 7374 6174 7573 273a 2027      {'status': '
+0001f400: 626c 6f63 6b65 6427 2c20 276d 6573 7361  blocked', 'messa
+0001f410: 6765 273a 2027 6d65 7373 6167 6527 7d29  ge': 'message'})
+0001f420: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f430: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+0001f440: 2020 2020 2020 2062 6163 6b65 6e64 2e73         backend.s
+0001f450: 7461 7475 735f 6765 7428 6973 5f61 7070  tatus_get(is_app
+0001f460: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+0001f470: 2020 2020 207b 2773 7461 7475 7327 3a20       {'status': 
+0001f480: 276d 6169 6e74 656e 616e 6365 272c 2027  'maintenance', '
+0001f490: 6d65 7373 6167 6527 3a20 2727 7d29 0a0a  message': ''})..
+0001f4a0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+0001f4b0: 6174 696f 6e5f 6964 735f 756e 6b6e 6f77  ation_ids_unknow
+0001f4c0: 6e5f 7265 6c61 7469 6f6e 2873 656c 6629  n_relation(self)
+0001f4d0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0001f4e0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0001f4f0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0001f500: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+0001f510: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0001f520: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
+0001f530: 2020 2020 2020 2020 2070 726f 7669 6465           provide
+0001f540: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001f550: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+0001f560: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+0001f570: 6d79 6462 0a20 2020 2020 2020 2020 2020  mydb.           
+0001f580: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+0001f590: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0001f5a0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+0001f5b0: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+0001f5c0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+0001f5d0: 640a 2020 2020 2020 2020 2320 5769 7468  d.        # With
+0001f5e0: 206e 6f20 7265 6c61 7469 6f6e 7320 6164   no relations ad
+0001f5f0: 6465 642c 2077 6520 6a75 7374 2067 6574  ded, we just get
+0001f600: 2061 6e20 656d 7074 7920 6c69 7374 2066   an empty list f
+0001f610: 6f72 2074 6865 2069 6e74 6572 6661 6365  or the interface
+0001f620: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f630: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+0001f640: 642e 7265 6c61 7469 6f6e 5f69 6473 2827  d.relation_ids('
+0001f650: 6462 2729 2c20 5b5d 290a 2020 2020 2020  db'), []).      
+0001f660: 2020 2320 4275 7420 616e 2075 6e6b 6e6f    # But an unkno
+0001f670: 776e 2069 6e74 6572 6661 6365 2072 6169  wn interface rai
+0001f680: 7365 7320 6120 4d6f 6465 6c45 7272 6f72  ses a ModelError
+0001f690: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001f6a0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001f6b0: 6f70 732e 4d6f 6465 6c45 7272 6f72 293a  ops.ModelError):
+0001f6c0: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+0001f6d0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
+0001f6e0: 7328 2775 6e6b 6e6f 776e 2729 0a0a 2020  s('unknown')..  
+0001f6f0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+0001f700: 696f 6e5f 6765 745f 756e 6b6e 6f77 6e5f  ion_get_unknown_
+0001f710: 7265 6c61 7469 6f6e 5f69 6428 7365 6c66  relation_id(self
+0001f720: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0001f730: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0001f740: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0001f750: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+0001f760: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001f770: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
+0001f780: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0001f790: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0001f7a0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0001f7b0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0001f7c0: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
+0001f7d0: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
+0001f7e0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0001f7f0: 6572 7452 6169 7365 7328 6f70 732e 5265  ertRaises(ops.Re
+0001f800: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
+0001f810: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0001f820: 2020 6261 636b 656e 642e 7265 6c61 7469    backend.relati
+0001f830: 6f6e 5f67 6574 2831 3233 342c 2027 756e  on_get(1234, 'un
+0001f840: 6974 2f30 272c 2046 616c 7365 290a 0a20  it/0', False).. 
+0001f850: 2020 2064 6566 2074 6573 745f 7265 6c61     def test_rela
+0001f860: 7469 6f6e 5f6c 6973 745f 756e 6b6e 6f77  tion_list_unknow
+0001f870: 6e5f 7265 6c61 7469 6f6e 5f69 6428 7365  n_relation_id(se
+0001f880: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+0001f890: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+0001f8a0: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+0001f8b0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+0001f8c0: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+0001f8d0: 616d 653a 2074 6573 742d 6368 6172 6d0a  ame: test-charm.
+0001f8e0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0001f8f0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001f900: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0001f910: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0001f920: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+0001f930: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
+0001f940: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0001f950: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+0001f960: 5265 6c61 7469 6f6e 4e6f 7446 6f75 6e64  RelationNotFound
+0001f970: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0001f980: 2020 2020 6261 636b 656e 642e 7265 6c61      backend.rela
+0001f990: 7469 6f6e 5f6c 6973 7428 3132 3334 290a  tion_list(1234).
+0001f9a0: 0a20 2020 2064 6566 2074 6573 745f 6c61  .    def test_la
+0001f9b0: 7a79 5f72 6573 6f75 7263 655f 6469 7265  zy_resource_dire
+0001f9c0: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
+0001f9d0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0001f9e0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0001f9f0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0001fa00: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0001fa10: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0001fa20: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+0001fa30: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
+0001fa40: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0001fa50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001fa60: 2020 7479 7065 3a20 6f63 692d 696d 6167    type: oci-imag
+0001fa70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0001fa80: 2020 6465 7363 7269 7074 696f 6e3a 2022    description: "
+0001fa90: 496d 6167 6520 746f 2064 6570 6c6f 792e  Image to deploy.
+0001faa0: 220a 2020 2020 2020 2020 2020 2020 2727  ".            ''
+0001fab0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001fac0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+0001fad0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+0001fae0: 2020 2020 6861 726e 6573 732e 706f 7075      harness.popu
+0001faf0: 6c61 7465 5f6f 6369 5f72 6573 6f75 7263  late_oci_resourc
+0001fb00: 6573 2829 0a20 2020 2020 2020 2062 6163  es().        bac
+0001fb10: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
+0001fb20: 6261 636b 656e 640a 2020 2020 2020 2020  backend.        
+0001fb30: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+0001fb40: 6528 6261 636b 656e 642e 5f72 6573 6f75  e(backend._resou
+0001fb50: 7263 655f 6469 7229 0a20 2020 2020 2020  rce_dir).       
+0001fb60: 2070 6174 6820 3d20 6261 636b 656e 642e   path = backend.
+0001fb70: 7265 736f 7572 6365 5f67 6574 2827 696d  resource_get('im
+0001fb80: 6167 6527 290a 2020 2020 2020 2020 7365  age').        se
+0001fb90: 6c66 2e61 7373 6572 7449 734e 6f74 4e6f  lf.assertIsNotNo
+0001fba0: 6e65 2862 6163 6b65 6e64 2e5f 7265 736f  ne(backend._reso
+0001fbb0: 7572 6365 5f64 6972 290a 2020 2020 2020  urce_dir).      
+0001fbc0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0001fbd0: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+0001fbe0: 7472 2870 6174 6829 2e73 7461 7274 7377  tr(path).startsw
+0001fbf0: 6974 6828 7374 7228 6261 636b 656e 642e  ith(str(backend.
+0001fc00: 5f72 6573 6f75 7263 655f 6469 722e 6e61  _resource_dir.na
+0001fc10: 6d65 2929 2c0a 2020 2020 2020 2020 2020  me)),.          
+0001fc20: 2020 6d73 673d 6627 6578 7065 6374 6564    msg=f'expected
+0001fc30: 207b 7061 7468 7d20 746f 2062 6520 6120   {path} to be a 
+0001fc40: 7375 6264 6972 6563 746f 7279 206f 6620  subdirectory of 
+0001fc50: 7b62 6163 6b65 6e64 2e5f 7265 736f 7572  {backend._resour
+0001fc60: 6365 5f64 6972 2e6e 616d 657d 2729 0a0a  ce_dir.name}')..
+0001fc70: 2020 2020 6465 6620 7465 7374 5f72 6573      def test_res
+0001fc80: 6f75 7263 655f 6765 745f 6e6f 5f72 6573  ource_get_no_res
+0001fc90: 6f75 7263 6528 7365 6c66 293a 0a20 2020  ource(self):.   
+0001fca0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0001fcb0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0001fcc0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0001fcd0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0001fce0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0001fcf0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+0001fd00: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
+0001fd10: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0001fd20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001fd30: 2020 7479 7065 3a20 6669 6c65 0a20 2020    type: file.   
+0001fd40: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0001fd50: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
+0001fd60: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
+0001fd70: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+0001fd80: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0001fd90: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0001fda0: 6561 6e75 7029 0a20 2020 2020 2020 2062  eanup).        b
+0001fdb0: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
+0001fdc0: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
+0001fdd0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001fde0: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+0001fdf0: 656c 4572 726f 7229 2061 7320 636d 3a0a  elError) as cm:.
+0001fe00: 2020 2020 2020 2020 2020 2020 6261 636b              back
+0001fe10: 656e 642e 7265 736f 7572 6365 5f67 6574  end.resource_get
+0001fe20: 2827 666f 6f27 290a 2020 2020 2020 2020  ('foo').        
+0001fe30: 7365 6c66 2e61 7373 6572 7449 6e28 0a20  self.assertIn(. 
+0001fe40: 2020 2020 2020 2020 2020 2022 756e 6974             "unit
+0001fe50: 732f 756e 6974 2d74 6573 742d 6170 702d  s/unit-test-app-
+0001fe60: 302f 7265 736f 7572 6365 732f 666f 6f3a  0/resources/foo:
+0001fe70: 2072 6573 6f75 7263 6523 7465 7374 2d61   resource#test-a
+0001fe80: 7070 2f66 6f6f 206e 6f74 2066 6f75 6e64  pp/foo not found
+0001fe90: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+0001fea0: 7472 2863 6d2e 6578 6365 7074 696f 6e29  tr(cm.exception)
+0001feb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001fec0: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
+0001fed0: 6170 705f 6e61 6d65 2873 656c 6629 3a0a  app_name(self):.
+0001fee0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0001fef0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0001ff00: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0001ff10: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+0001ff20: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0001ff30: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+0001ff40: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+0001ff50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ff60: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+0001ff70: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+0001ff80: 666f 6f0a 2020 2020 2020 2020 2020 2020  foo.            
+0001ff90: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0001ffa0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0001ffb0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0001ffc0: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
+0001ffd0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0001ffe0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001fff0: 7373 6572 7449 7328 6261 636b 656e 642e  ssertIs(backend.
+00020000: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
+00020010: 6170 705f 6e61 6d65 2831 292c 204e 6f6e  app_name(1), Non
+00020020: 6529 0a0a 2020 2020 2020 2020 7265 6c5f  e)..        rel_
+00020030: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00020040: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00020050: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+00020060: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00020070: 7445 7175 616c 2862 6163 6b65 6e64 2e72  tEqual(backend.r
+00020080: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
+00020090: 7070 5f6e 616d 6528 7265 6c5f 6964 292c  pp_name(rel_id),
+000200a0: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
+000200b0: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+000200c0: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+000200d0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+000200e0: 6573 716c 2f30 2729 0a20 2020 2020 2020  esql/0').       
+000200f0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00020100: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
+00020110: 642c 2027 706f 7374 6772 6573 716c 2f31  d, 'postgresql/1
+00020120: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00020130: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
+00020140: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
+00020150: 6f74 655f 6170 705f 6e61 6d65 2872 656c  ote_app_name(rel
+00020160: 5f69 6429 2c20 2770 6f73 7467 7265 7371  _id), 'postgresq
+00020170: 6c27 290a 0a20 2020 2020 2020 2073 656c  l')..        sel
+00020180: 662e 6173 7365 7274 4973 2862 6163 6b65  f.assertIs(backe
+00020190: 6e64 2e72 656c 6174 696f 6e5f 7265 6d6f  nd.relation_remo
+000201a0: 7465 5f61 7070 5f6e 616d 6528 3729 2c20  te_app_name(7), 
+000201b0: 4e6f 6e65 290a 0a20 2020 2064 6566 2074  None)..    def t
+000201c0: 6573 745f 6765 745f 7065 6262 6c65 5f6d  est_get_pebble_m
+000201d0: 6574 686f 6473 2873 656c 6629 3a0a 2020  ethods(self):.  
+000201e0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+000201f0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00020200: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+00020210: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+00020220: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+00020230: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+00020240: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00020250: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+00020260: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+00020270: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+00020280: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
+00020290: 656e 640a 0a20 2020 2020 2020 2063 6c69  end..        cli
+000202a0: 656e 7420 3d20 6261 636b 656e 642e 6765  ent = backend.ge
+000202b0: 745f 7065 6262 6c65 2827 2f63 7573 746f  t_pebble('/custo
+000202c0: 6d2f 736f 636b 6574 2f70 6174 6827 290a  m/socket/path').
+000202d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000202e0: 6572 7449 7349 6e73 7461 6e63 6528 636c  ertIsInstance(cl
+000202f0: 6965 6e74 2c20 5f54 6573 7469 6e67 5065  ient, _TestingPe
+00020300: 6262 6c65 436c 6965 6e74 290a 0a0a 636c  bbleClient)...cl
+00020310: 6173 7320 5f54 6573 7469 6e67 5065 6262  ass _TestingPebb
+00020320: 6c65 436c 6965 6e74 4d69 7869 6e3a 0a20  leClientMixin:. 
+00020330: 2020 2064 6566 2067 6574 5f74 6573 7469     def get_testi
+00020340: 6e67 5f63 6c69 656e 7428 7365 6c66 293a  ng_client(self):
+00020350: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00020360: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00020370: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+00020380: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+00020390: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+000203a0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+000203b0: 2020 2020 2020 636f 6e74 6169 6e65 7273        containers
+000203c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000203d0: 6d79 636f 6e74 6169 6e65 723a 207b 7d0a  mycontainer: {}.
+000203e0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+000203f0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00020400: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00020410: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00020420: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+00020430: 6573 732e 5f62 6163 6b65 6e64 0a0a 2020  ess._backend..  
+00020440: 2020 2020 2020 636c 6965 6e74 203d 2062        client = b
+00020450: 6163 6b65 6e64 2e67 6574 5f70 6562 626c  ackend.get_pebbl
+00020460: 6528 272f 6368 6172 6d2f 636f 6e74 6169  e('/charm/contai
+00020470: 6e65 7273 2f6d 7963 6f6e 7461 696e 6572  ners/mycontainer
+00020480: 2f70 6562 626c 652e 736f 636b 6574 2729  /pebble.socket')
+00020490: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000204a0: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
+000204b0: 2827 6d79 636f 6e74 6169 6e65 7227 2c20  ('mycontainer', 
+000204c0: 5472 7565 290a 2020 2020 2020 2020 7265  True).        re
+000204d0: 7475 726e 2063 6c69 656e 740a 0a0a 2320  turn client...# 
+000204e0: 466f 7220 7465 7374 696e 6720 6e6f 6e20  For testing non 
+000204f0: 6669 6c65 206f 7073 206f 6620 7468 6520  file ops of the 
+00020500: 7065 6262 6c65 2074 6573 7469 6e67 2063  pebble testing c
+00020510: 6c69 656e 742e 0a63 6c61 7373 2054 6573  lient..class Tes
+00020520: 7454 6573 7469 6e67 5065 6262 6c65 436c  tTestingPebbleCl
+00020530: 6965 6e74 2875 6e69 7474 6573 742e 5465  ient(unittest.Te
+00020540: 7374 4361 7365 2c20 5f54 6573 7469 6e67  stCase, _Testing
+00020550: 5065 6262 6c65 436c 6965 6e74 4d69 7869  PebbleClientMixi
+00020560: 6e29 3a0a 0a20 2020 2064 6566 2074 6573  n):..    def tes
+00020570: 745f 6d65 7468 6f64 735f 6d61 7463 685f  t_methods_match_
+00020580: 7065 6262 6c65 5f63 6c69 656e 7428 7365  pebble_client(se
+00020590: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+000205a0: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
+000205b0: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
+000205c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000205d0: 6572 7449 734e 6f74 4e6f 6e65 2863 6c69  ertIsNotNone(cli
+000205e0: 656e 7429 0a20 2020 2020 2020 2070 6562  ent).        peb
+000205f0: 626c 655f 636c 6965 6e74 5f6d 6574 686f  ble_client_metho
+00020600: 6473 203d 2067 6574 5f70 7562 6c69 635f  ds = get_public_
+00020610: 6d65 7468 6f64 7328 7065 6262 6c65 2e43  methods(pebble.C
+00020620: 6c69 656e 7429 0a20 2020 2020 2020 2074  lient).        t
+00020630: 6573 7469 6e67 5f63 6c69 656e 745f 6d65  esting_client_me
+00020640: 7468 6f64 7320 3d20 6765 745f 7075 626c  thods = get_publ
+00020650: 6963 5f6d 6574 686f 6473 2863 6c69 656e  ic_methods(clien
+00020660: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+00020670: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
+00020680: 6c65 5f63 6c69 656e 745f 6d65 7468 6f64  le_client_method
+00020690: 732c 2074 6573 7469 6e67 5f63 6c69 656e  s, testing_clien
+000206a0: 745f 6d65 7468 6f64 7329 0a0a 2020 2020  t_methods)..    
+000206b0: 6465 6620 7465 7374 5f61 6464 5f6c 6179  def test_add_lay
+000206c0: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
+000206d0: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
+000206e0: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
+000206f0: 6e74 2829 0a20 2020 2020 2020 2070 6c61  nt().        pla
+00020700: 6e20 3d20 636c 6965 6e74 2e67 6574 5f70  n = client.get_p
+00020710: 6c61 6e28 290a 2020 2020 2020 2020 7365  lan().        se
+00020720: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+00020730: 6e63 6528 706c 616e 2c20 7065 6262 6c65  nce(plan, pebble
+00020740: 2e50 6c61 6e29 0a20 2020 2020 2020 2073  .Plan).        s
+00020750: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00020760: 277b 7d5c 6e27 2c20 706c 616e 2e74 6f5f  '{}\n', plan.to_
+00020770: 7961 6d6c 2829 290a 2020 2020 2020 2020  yaml()).        
+00020780: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
+00020790: 2827 666f 6f27 2c20 7065 6262 6c65 2e4c  ('foo', pebble.L
+000207a0: 6179 6572 2827 2727 5c0a 2020 2020 2020  ayer('''\.      
+000207b0: 2020 2020 2020 7375 6d6d 6172 793a 2046        summary: F
+000207c0: 6f6f 0a20 2020 2020 2020 2020 2020 2064  oo.            d
+000207d0: 6573 6372 6970 7469 6f6e 3a20 7c0a 2020  escription: |.  
+000207e0: 2020 2020 2020 2020 2020 2020 4120 6c6f              A lo
+000207f0: 6e67 6572 2064 6573 6372 6970 7469 6f6e  nger description
+00020800: 2061 626f 7574 2046 6f6f 0a20 2020 2020   about Foo.     
+00020810: 2020 2020 2020 2073 6572 7669 6365 733a         services:
+00020820: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+00020830: 6572 763a 0a20 2020 2020 2020 2020 2020  erv:.           
+00020840: 2020 2020 2073 756d 6d61 7279 3a20 5365       summary: Se
+00020850: 7276 0a20 2020 2020 2020 2020 2020 2020  rv.             
+00020860: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
+00020870: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
+00020880: 2020 2020 4120 6465 7363 7269 7074 696f      A descriptio
+00020890: 6e20 6162 6f75 7420 5365 7276 2074 6865  n about Serv the
+000208a0: 2061 6d61 7a69 6e67 2073 6572 7669 6365   amazing service
+000208b0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000208c0: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
+000208d0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+000208e0: 2020 206f 7665 7272 6964 653a 2072 6570     override: rep
+000208f0: 6c61 6365 0a20 2020 2020 2020 2020 2020  lace.           
+00020900: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+00020910: 6269 6e2f 6563 686f 2068 656c 6c6f 270a  bin/echo hello'.
+00020920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020930: 656e 7669 726f 6e6d 656e 743a 0a20 2020  environment:.   
+00020940: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+00020950: 4559 3a20 5641 4c55 450a 2020 2020 2020  EY: VALUE.      
+00020960: 2020 2020 2020 2727 2729 290a 2020 2020        ''')).    
+00020970: 2020 2020 706c 616e 203d 2063 6c69 656e      plan = clien
+00020980: 742e 6765 745f 706c 616e 2829 0a20 2020  t.get_plan().   
+00020990: 2020 2020 2023 2054 6865 2059 414d 4c20       # The YAML 
+000209a0: 7368 6f75 6c64 2062 6520 6e6f 726d 616c  should be normal
+000209b0: 697a 6564 0a20 2020 2020 2020 2073 656c  ized.        sel
+000209c0: 662e 6173 7365 7274 4571 7561 6c28 7465  f.assertEqual(te
+000209d0: 7874 7772 6170 2e64 6564 656e 7428 2727  xtwrap.dedent(''
+000209e0: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
+000209f0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+00020a00: 2020 2020 2020 2073 6572 763a 0a20 2020         serv:.   
+00020a10: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00020a20: 6d61 6e64 3a20 2f62 696e 2f65 6368 6f20  mand: /bin/echo 
+00020a30: 6865 6c6c 6f0a 2020 2020 2020 2020 2020  hello.          
+00020a40: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+00020a50: 6e3a 2027 4120 6465 7363 7269 7074 696f  n: 'A descriptio
+00020a60: 6e20 6162 6f75 7420 5365 7276 2074 6865  n about Serv the
+00020a70: 2061 6d61 7a69 6e67 2073 6572 7669 6365   amazing service
+00020a80: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+00020a90: 2020 2020 2027 0a20 2020 2020 2020 2020       '.         
+00020aa0: 2020 2020 2020 2065 6e76 6972 6f6e 6d65         environme
+00020ab0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00020ac0: 2020 2020 2020 4b45 593a 2056 414c 5545        KEY: VALUE
+00020ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ae0: 206f 7665 7272 6964 653a 2072 6570 6c61   override: repla
+00020af0: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
+00020b00: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
+00020b10: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+00020b20: 2020 2020 7375 6d6d 6172 793a 2053 6572      summary: Ser
+00020b30: 760a 2020 2020 2020 2020 2020 2020 2727  v.            ''
+00020b40: 2729 2c20 706c 616e 2e74 6f5f 7961 6d6c  '), plan.to_yaml
+00020b50: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
+00020b60: 745f 6164 645f 6c61 7965 725f 6d65 7267  t_add_layer_merg
+00020b70: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00020b80: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
+00020b90: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
+00020ba0: 7428 290a 2020 2020 2020 2020 706c 616e  t().        plan
+00020bb0: 203d 2063 6c69 656e 742e 6765 745f 706c   = client.get_pl
+00020bc0: 616e 2829 0a20 2020 2020 2020 2073 656c  an().        sel
+00020bd0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+00020be0: 6365 2870 6c61 6e2c 2070 6562 626c 652e  ce(plan, pebble.
+00020bf0: 506c 616e 290a 2020 2020 2020 2020 7365  Plan).        se
+00020c00: 6c66 2e61 7373 6572 7445 7175 616c 2827  lf.assertEqual('
+00020c10: 7b7d 5c6e 272c 2070 6c61 6e2e 746f 5f79  {}\n', plan.to_y
+00020c20: 616d 6c28 2929 0a20 2020 2020 2020 2063  aml()).        c
+00020c30: 6c69 656e 742e 6164 645f 6c61 7965 7228  lient.add_layer(
+00020c40: 2766 6f6f 272c 2070 6562 626c 652e 4c61  'foo', pebble.La
+00020c50: 7965 7228 2727 275c 0a20 2020 2020 2020  yer('''\.       
+00020c60: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
+00020c70: 6f0a 2020 2020 2020 2020 2020 2020 6465  o.            de
+00020c80: 7363 7269 7074 696f 6e3a 207c 0a20 2020  scription: |.   
+00020c90: 2020 2020 2020 2020 2020 2041 206c 6f6e             A lon
+00020ca0: 6765 7220 6465 7363 7269 7074 696f 6e20  ger description 
+00020cb0: 6162 6f75 7420 466f 6f0a 2020 2020 2020  about Foo.      
+00020cc0: 2020 2020 2020 7365 7276 6963 6573 3a0a        services:.
+00020cd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00020ce0: 7276 3a0a 2020 2020 2020 2020 2020 2020  rv:.            
+00020cf0: 2020 2020 7375 6d6d 6172 793a 2053 6572      summary: Ser
+00020d00: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
+00020d10: 2020 6465 7363 7269 7074 696f 6e3a 207c    description: |
+00020d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020d30: 2020 2041 2064 6573 6372 6970 7469 6f6e     A description
+00020d40: 2061 626f 7574 2053 6572 7620 7468 6520   about Serv the 
+00020d50: 616d 617a 696e 6720 7365 7276 6963 652e  amazing service.
+00020d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020d70: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
+00020d80: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00020d90: 2020 6f76 6572 7269 6465 3a20 7265 706c    override: repl
+00020da0: 6163 650a 2020 2020 2020 2020 2020 2020  ace.            
+00020db0: 2020 2020 636f 6d6d 616e 643a 2027 2f62      command: '/b
+00020dc0: 696e 2f65 6368 6f20 6865 6c6c 6f27 0a20  in/echo hello'. 
+00020dd0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00020de0: 6e76 6972 6f6e 6d65 6e74 3a0a 2020 2020  nvironment:.    
+00020df0: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
+00020e00: 5931 3a20 5641 4c55 4531 0a20 2020 2020  Y1: VALUE1.     
+00020e10: 2020 2020 2020 2020 2020 2061 6674 6572             after
+00020e20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020e30: 2020 2d20 7468 696e 6731 0a20 2020 2020    - thing1.     
+00020e40: 2020 2020 2020 2020 2020 2062 6566 6f72             befor
+00020e50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00020e60: 2020 202d 2074 6869 6e67 310a 2020 2020     - thing1.    
+00020e70: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00020e80: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00020e90: 2020 2020 2020 2d20 7468 696e 6731 0a20        - thing1. 
+00020ea0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00020eb0: 7365 723a 2075 7365 7231 0a20 2020 2020  ser: user1.     
+00020ec0: 2020 2020 2020 2020 2020 2075 7365 722d             user-
+00020ed0: 6964 3a20 7573 6572 4944 310a 2020 2020  id: userID1.    
+00020ee0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00020ef0: 703a 2067 726f 7570 310a 2020 2020 2020  p: group1.      
+00020f00: 2020 2020 2020 2020 2020 6772 6f75 702d            group-
+00020f10: 6964 3a20 6772 6f75 7049 4431 0a20 2020  id: groupID1.   
+00020f20: 2020 2020 2020 2020 2020 2020 206f 6e2d               on-
+00020f30: 6661 696c 7572 653a 2074 6869 6e67 310a  failure: thing1.
+00020f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f50: 6f6e 2d73 7563 6365 7373 3a20 7468 696e  on-success: thin
+00020f60: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
+00020f70: 2020 206f 6e2d 6368 6563 6b2d 6661 696c     on-check-fail
+00020f80: 7572 653a 0a20 2020 2020 2020 2020 2020  ure:.           
+00020f90: 2020 2020 2020 204b 4559 313a 2056 414c         KEY1: VAL
+00020fa0: 5545 310a 2020 2020 2020 2020 2020 2020  UE1.            
+00020fb0: 2020 2020 6261 636b 6f66 662d 6465 6c61      backoff-dela
+00020fc0: 793a 2031 0a20 2020 2020 2020 2020 2020  y: 1.           
+00020fd0: 2020 2020 2062 6163 6b6f 6666 2d66 6163       backoff-fac
+00020fe0: 746f 723a 2032 0a20 2020 2020 2020 2020  tor: 2.         
+00020ff0: 2020 2020 2020 2062 6163 6b6f 6666 2d6c         backoff-l
+00021000: 696d 6974 3a20 310a 2020 2020 2020 2020  imit: 1.        
+00021010: 2020 2020 2727 2729 290a 2020 2020 2020      ''')).      
+00021020: 2020 706c 616e 203d 2063 6c69 656e 742e    plan = client.
+00021030: 6765 745f 706c 616e 2829 0a20 2020 2020  get_plan().     
+00021040: 2020 2023 2054 6865 2059 414d 4c20 7368     # The YAML sh
+00021050: 6f75 6c64 2062 6520 6e6f 726d 616c 697a  ould be normaliz
+00021060: 6564 0a20 2020 2020 2020 2073 656c 662e  ed.        self.
+00021070: 6d61 7844 6966 6620 3d20 4e6f 6e65 0a20  maxDiff = None. 
+00021080: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00021090: 7274 4571 7561 6c28 7465 7874 7772 6170  rtEqual(textwrap
+000210a0: 2e64 6564 656e 7428 2727 275c 0a20 2020  .dedent('''\.   
+000210b0: 2020 2020 2020 2020 2073 6572 7669 6365           service
+000210c0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000210d0: 2073 6572 763a 0a20 2020 2020 2020 2020   serv:.         
+000210e0: 2020 2020 2020 2061 6674 6572 3a0a 2020         after:.  
+000210f0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+00021100: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
+00021110: 2020 2020 2020 2062 6163 6b6f 6666 2d64         backoff-d
+00021120: 656c 6179 3a20 310a 2020 2020 2020 2020  elay: 1.        
+00021130: 2020 2020 2020 2020 6261 636b 6f66 662d          backoff-
+00021140: 6661 6374 6f72 3a20 320a 2020 2020 2020  factor: 2.      
+00021150: 2020 2020 2020 2020 2020 6261 636b 6f66            backof
+00021160: 662d 6c69 6d69 743a 2031 0a20 2020 2020  f-limit: 1.     
+00021170: 2020 2020 2020 2020 2020 2062 6566 6f72             befor
+00021180: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00021190: 2020 202d 2074 6869 6e67 310a 2020 2020     - thing1.    
+000211a0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+000211b0: 616e 643a 202f 6269 6e2f 6563 686f 2068  and: /bin/echo h
+000211c0: 656c 6c6f 0a20 2020 2020 2020 2020 2020  ello.           
+000211d0: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+000211e0: 3a20 2741 2064 6573 6372 6970 7469 6f6e  : 'A description
+000211f0: 2061 626f 7574 2053 6572 7620 7468 6520   about Serv the 
+00021200: 616d 617a 696e 6720 7365 7276 6963 652e  amazing service.
+00021210: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00021220: 2020 2020 270a 2020 2020 2020 2020 2020      '.          
+00021230: 2020 2020 2020 656e 7669 726f 6e6d 656e        environmen
+00021240: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00021250: 2020 2020 204b 4559 313a 2056 414c 5545       KEY1: VALUE
+00021260: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00021270: 2020 6772 6f75 703a 2067 726f 7570 310a    group: group1.
+00021280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021290: 6772 6f75 702d 6964 3a20 6772 6f75 7049  group-id: groupI
+000212a0: 4431 0a20 2020 2020 2020 2020 2020 2020  D1.             
+000212b0: 2020 206f 6e2d 6368 6563 6b2d 6661 696c     on-check-fail
+000212c0: 7572 653a 0a20 2020 2020 2020 2020 2020  ure:.           
+000212d0: 2020 2020 2020 204b 4559 313a 2056 414c         KEY1: VAL
+000212e0: 5545 310a 2020 2020 2020 2020 2020 2020  UE1.            
+000212f0: 2020 2020 6f6e 2d66 6169 6c75 7265 3a20      on-failure: 
+00021300: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
+00021310: 2020 2020 2020 206f 6e2d 7375 6363 6573         on-succes
+00021320: 733a 2074 6869 6e67 310a 2020 2020 2020  s: thing1.      
+00021330: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
+00021340: 6465 3a20 7265 706c 6163 650a 2020 2020  de: replace.    
+00021350: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00021360: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00021370: 2020 2020 2020 2d20 7468 696e 6731 0a20        - thing1. 
+00021380: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021390: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
+000213a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213b0: 7375 6d6d 6172 793a 2053 6572 760a 2020  summary: Serv.  
+000213c0: 2020 2020 2020 2020 2020 2020 2020 7573                us
+000213d0: 6572 3a20 7573 6572 310a 2020 2020 2020  er: user1.      
+000213e0: 2020 2020 2020 2020 2020 7573 6572 2d69            user-i
+000213f0: 643a 2075 7365 7249 4431 0a20 2020 2020  d: userID1.     
+00021400: 2020 2020 2020 2027 2727 292c 2070 6c61         '''), pla
+00021410: 6e2e 746f 5f79 616d 6c28 2929 0a0a 2020  n.to_yaml())..  
+00021420: 2020 2020 2020 636c 6965 6e74 2e61 6464        client.add
+00021430: 5f6c 6179 6572 2827 666f 6f27 2c20 7065  _layer('foo', pe
+00021440: 6262 6c65 2e4c 6179 6572 2827 2727 5c0a  bble.Layer('''\.
+00021450: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00021460: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
+00021470: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+00021480: 3a20 7c0a 2020 2020 2020 2020 2020 2020  : |.            
+00021490: 2020 4120 6c6f 6e67 6572 2064 6573 6372    A longer descr
+000214a0: 6970 7469 6f6e 2061 626f 7574 2046 6f6f  iption about Foo
+000214b0: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
+000214c0: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
+000214d0: 2020 2020 2073 6572 763a 0a20 2020 2020       serv:.     
+000214e0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+000214f0: 7279 3a20 5365 7276 0a20 2020 2020 2020  ry: Serv.       
+00021500: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+00021510: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
+00021520: 2020 2020 2020 2020 2020 4120 6e65 7720            A new 
+00021530: 6465 7363 7269 7074 696f 6e20 6f66 2074  description of t
+00021540: 6865 2074 6865 2061 6d61 7a69 6e67 2053  he the amazing S
+00021550: 6572 7620 7365 7276 6963 652e 0a20 2020  erv service..   
+00021560: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00021570: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
+00021580: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
+00021590: 6572 7269 6465 3a20 6d65 7267 650a 2020  erride: merge.  
+000215a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000215b0: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
+000215c0: 6f20 6865 6c6c 6f27 0a20 2020 2020 2020  o hello'.       
+000215d0: 2020 2020 2020 2020 2065 6e76 6972 6f6e           environ
+000215e0: 6d65 6e74 3a0a 2020 2020 2020 2020 2020  ment:.          
+000215f0: 2020 2020 2020 2020 4b45 5931 3a20 5641          KEY1: VA
+00021600: 4c55 4534 0a20 2020 2020 2020 2020 2020  LUE4.           
+00021610: 2020 2020 2020 204b 4559 323a 2056 414c         KEY2: VAL
+00021620: 5545 320a 2020 2020 2020 2020 2020 2020  UE2.            
+00021630: 2020 2020 2020 4b45 5933 3a20 5641 4c55        KEY3: VALU
+00021640: 4533 0a20 2020 2020 2020 2020 2020 2020  E3.             
+00021650: 2020 2061 6674 6572 3a0a 2020 2020 2020     after:.      
+00021660: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
+00021670: 6732 0a20 2020 2020 2020 2020 2020 2020  g2.             
+00021680: 2020 2062 6566 6f72 653a 0a20 2020 2020     before:.     
+00021690: 2020 2020 2020 2020 2020 202d 2074 6869             - thi
+000216a0: 6e67 320a 2020 2020 2020 2020 2020 2020  ng2.            
+000216b0: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+000216c0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+000216d0: 7468 696e 6732 0a20 2020 2020 2020 2020  thing2.         
+000216e0: 2020 2020 2020 2075 7365 723a 2075 7365         user: use
+000216f0: 7232 0a20 2020 2020 2020 2020 2020 2020  r2.             
+00021700: 2020 2075 7365 722d 6964 3a20 7573 6572     user-id: user
+00021710: 4944 320a 2020 2020 2020 2020 2020 2020  ID2.            
+00021720: 2020 2020 6772 6f75 703a 2067 726f 7570      group: group
+00021730: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+00021740: 2020 6772 6f75 702d 6964 3a20 6772 6f75    group-id: grou
+00021750: 7049 4432 0a20 2020 2020 2020 2020 2020  pID2.           
+00021760: 2020 2020 206f 6e2d 7375 6363 6573 733a       on-success:
+00021770: 2074 6869 6e67 320a 2020 2020 2020 2020   thing2.        
+00021780: 2020 2020 2020 2020 6f6e 2d66 6169 6c75          on-failu
+00021790: 7265 3a20 7468 696e 6732 0a20 2020 2020  re: thing2.     
+000217a0: 2020 2020 2020 2020 2020 206f 6e2d 6368             on-ch
+000217b0: 6563 6b2d 6661 696c 7572 653a 0a20 2020  eck-failure:.   
+000217c0: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+000217d0: 4559 313a 2056 414c 5545 340a 2020 2020  EY1: VALUE4.    
+000217e0: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
+000217f0: 5932 3a20 5641 4c55 4532 0a20 2020 2020  Y2: VALUE2.     
+00021800: 2020 2020 2020 2020 2020 2020 204b 4559               KEY
+00021810: 333a 2056 414c 5545 330a 2020 2020 2020  3: VALUE3.      
+00021820: 2020 2020 2020 2020 2020 6261 636b 6f66            backof
+00021830: 662d 6465 6c61 793a 2032 0a20 2020 2020  f-delay: 2.     
+00021840: 2020 2020 2020 2020 2020 2062 6163 6b6f             backo
+00021850: 6666 2d66 6163 746f 723a 2033 0a20 2020  ff-factor: 3.   
+00021860: 2020 2020 2020 2020 2020 2020 2062 6163               bac
+00021870: 6b6f 6666 2d6c 696d 6974 3a20 320a 2020  koff-limit: 2.  
+00021880: 2020 2020 2020 2020 2020 2727 2729 2c20            '''), 
+00021890: 636f 6d62 696e 653d 5472 7565 290a 2020  combine=True).  
+000218a0: 2020 2020 2020 706c 616e 203d 2063 6c69        plan = cli
+000218b0: 656e 742e 6765 745f 706c 616e 2829 0a20  ent.get_plan(). 
+000218c0: 2020 2020 2020 2023 2054 6865 2059 414d         # The YAM
+000218d0: 4c20 7368 6f75 6c64 2062 6520 6e6f 726d  L should be norm
+000218e0: 616c 697a 6564 0a20 2020 2020 2020 2073  alized.        s
+000218f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00021900: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
+00021910: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+00021920: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
+00021930: 2020 2020 2020 2020 2073 6572 763a 0a20           serv:. 
+00021940: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00021950: 6674 6572 3a0a 2020 2020 2020 2020 2020  fter:.          
+00021960: 2020 2020 2020 2d20 7468 696e 6731 0a20        - thing1. 
+00021970: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+00021980: 2074 6869 6e67 320a 2020 2020 2020 2020   thing2.        
+00021990: 2020 2020 2020 2020 6261 636b 6f66 662d          backoff-
+000219a0: 6465 6c61 793a 2032 0a20 2020 2020 2020  delay: 2.       
+000219b0: 2020 2020 2020 2020 2062 6163 6b6f 6666           backoff
+000219c0: 2d66 6163 746f 723a 2033 0a20 2020 2020  -factor: 3.     
+000219d0: 2020 2020 2020 2020 2020 2062 6163 6b6f             backo
+000219e0: 6666 2d6c 696d 6974 3a20 320a 2020 2020  ff-limit: 2.    
+000219f0: 2020 2020 2020 2020 2020 2020 6265 666f              befo
+00021a00: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
+00021a10: 2020 2020 2d20 7468 696e 6731 0a20 2020      - thing1.   
+00021a20: 2020 2020 2020 2020 2020 2020 202d 2074               - t
+00021a30: 6869 6e67 320a 2020 2020 2020 2020 2020  hing2.          
+00021a40: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
+00021a50: 6269 6e2f 6563 686f 2068 656c 6c6f 0a20  bin/echo hello. 
+00021a60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00021a70: 6573 6372 6970 7469 6f6e 3a20 2741 206e  escription: 'A n
+00021a80: 6577 2064 6573 6372 6970 7469 6f6e 206f  ew description o
+00021a90: 6620 7468 6520 7468 6520 616d 617a 696e  f the the amazin
+00021aa0: 6720 5365 7276 2073 6572 7669 6365 2e0a  g Serv service..
+00021ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021ac0: 2020 2027 0a20 2020 2020 2020 2020 2020     '.           
+00021ad0: 2020 2020 2065 6e76 6972 6f6e 6d65 6e74       environment
+00021ae0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021af0: 2020 2020 4b45 5931 3a20 5641 4c55 4534      KEY1: VALUE4
+00021b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021b10: 2020 204b 4559 323a 2056 414c 5545 320a     KEY2: VALUE2.
+00021b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b30: 2020 4b45 5933 3a20 5641 4c55 4533 0a20    KEY3: VALUE3. 
+00021b40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00021b50: 726f 7570 3a20 6772 6f75 7032 0a20 2020  roup: group2.   
+00021b60: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00021b70: 7570 2d69 643a 2067 726f 7570 4944 320a  up-id: groupID2.
+00021b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b90: 6f6e 2d63 6865 636b 2d66 6169 6c75 7265  on-check-failure
+00021ba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021bb0: 2020 2020 4b45 5931 3a20 5641 4c55 4534      KEY1: VALUE4
+00021bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021bd0: 2020 204b 4559 323a 2056 414c 5545 320a     KEY2: VALUE2.
+00021be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021bf0: 2020 4b45 5933 3a20 5641 4c55 4533 0a20    KEY3: VALUE3. 
+00021c00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00021c10: 6e2d 6661 696c 7572 653a 2074 6869 6e67  n-failure: thing
+00021c20: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+00021c30: 2020 6f6e 2d73 7563 6365 7373 3a20 7468    on-success: th
+00021c40: 696e 6732 0a20 2020 2020 2020 2020 2020  ing2.           
+00021c50: 2020 2020 206f 7665 7272 6964 653a 206d       override: m
+00021c60: 6572 6765 0a20 2020 2020 2020 2020 2020  erge.           
+00021c70: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
+00021c80: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+00021c90: 2074 6869 6e67 310a 2020 2020 2020 2020   thing1.        
+00021ca0: 2020 2020 2020 2020 2d20 7468 696e 6732          - thing2
+00021cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021cc0: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
+00021cd0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00021ce0: 2020 7375 6d6d 6172 793a 2053 6572 760a    summary: Serv.
+00021cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d00: 7573 6572 3a20 7573 6572 320a 2020 2020  user: user2.    
+00021d10: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00021d20: 2d69 643a 2075 7365 7249 4432 0a20 2020  -id: userID2.   
+00021d30: 2020 2020 2020 2020 2027 2727 292c 2070           '''), p
+00021d40: 6c61 6e2e 746f 5f79 616d 6c28 2929 0a0a  lan.to_yaml())..
+00021d50: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+00021d60: 5f6c 6179 6572 5f6e 6f74 5f63 6f6d 6269  _layer_not_combi
+00021d70: 6e65 6428 7365 6c66 293a 0a20 2020 2020  ned(self):.     
+00021d80: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00021d90: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
+00021da0: 656e 7428 290a 2020 2020 2020 2020 706c  ent().        pl
+00021db0: 616e 203d 2063 6c69 656e 742e 6765 745f  an = client.get_
+00021dc0: 706c 616e 2829 0a20 2020 2020 2020 2073  plan().        s
+00021dd0: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+00021de0: 616e 6365 2870 6c61 6e2c 2070 6562 626c  ance(plan, pebbl
+00021df0: 652e 506c 616e 290a 2020 2020 2020 2020  e.Plan).        
+00021e00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00021e10: 2827 7b7d 5c6e 272c 2070 6c61 6e2e 746f  ('{}\n', plan.to
+00021e20: 5f79 616d 6c28 2929 0a20 2020 2020 2020  _yaml()).       
+00021e30: 2073 6572 7669 6365 203d 2074 6578 7477   service = textw
+00021e40: 7261 702e 6465 6465 6e74 2827 2727 5c0a  rap.dedent('''\.
+00021e50: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00021e60: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
+00021e70: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+00021e80: 3a20 7c0a 2020 2020 2020 2020 2020 2020  : |.            
+00021e90: 2020 4120 6c6f 6e67 6572 2064 6573 6372    A longer descr
+00021ea0: 6970 7469 6f6e 2061 626f 7574 2046 6f6f  iption about Foo
+00021eb0: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
+00021ec0: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
+00021ed0: 2020 2020 2073 6572 763a 0a20 2020 2020       serv:.     
+00021ee0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00021ef0: 7279 3a20 5365 7276 0a20 2020 2020 2020  ry: Serv.       
+00021f00: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+00021f10: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
+00021f20: 2020 2020 2020 2020 2020 4120 6465 7363            A desc
+00021f30: 7269 7074 696f 6e20 6162 6f75 7420 5365  ription about Se
+00021f40: 7276 2074 6865 2061 6d61 7a69 6e67 2073  rv the amazing s
+00021f50: 6572 7669 6365 2e0a 2020 2020 2020 2020  ervice..        
+00021f60: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
+00021f70: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00021f80: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
+00021f90: 653a 2072 6570 6c61 6365 0a20 2020 2020  e: replace.     
+00021fa0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00021fb0: 6e64 3a20 272f 6269 6e2f 6563 686f 2068  nd: '/bin/echo h
+00021fc0: 656c 6c6f 270a 2020 2020 2020 2020 2020  ello'.          
+00021fd0: 2020 2020 2020 656e 7669 726f 6e6d 656e        environmen
+00021fe0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00021ff0: 2020 2020 204b 4559 3a20 5641 4c55 450a       KEY: VALUE.
+00022000: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00022010: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00022020: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
+00022030: 2070 6562 626c 652e 4c61 7965 7228 7365   pebble.Layer(se
+00022040: 7276 6963 6529 290a 2020 2020 2020 2020  rvice)).        
+00022050: 2320 544f 444f 3a20 6a61 6d20 3230 3231  # TODO: jam 2021
+00022060: 2d30 342d 3139 2057 6520 7368 6f75 6c64  -04-19 We should
+00022070: 2068 6176 6520 6120 636c 6561 7265 7220   have a clearer 
+00022080: 6572 726f 7220 7479 7065 2066 6f72 2074  error type for t
+00022090: 6869 7320 6361 7365 2e20 5468 6520 6163  his case. The ac
+000220a0: 7475 616c 0a20 2020 2020 2020 2023 2020  tual.        #  
+000220b0: 7065 6262 6c65 2072 6169 7365 7320 616e  pebble raises an
+000220c0: 2048 5454 5020 6578 6365 7074 696f 6e2e   HTTP exception.
+000220d0: 2053 6565 2068 7474 7073 3a2f 2f67 6974   See https://git
+000220e0: 6875 622e 636f 6d2f 6361 6e6f 6e69 6361  hub.com/canonica
+000220f0: 6c2f 6f70 6572 6174 6f72 2f69 7373 7565  l/operator/issue
+00022100: 732f 3531 340a 2020 2020 2020 2020 2320  s/514.        # 
+00022110: 2074 6861 7420 7468 6973 2073 686f 756c   that this shoul
+00022120: 6420 6265 2063 6c65 616e 6564 2075 7020  d be cleaned up 
+00022130: 696e 746f 2061 2063 6c65 6172 6572 2065  into a clearer e
+00022140: 7272 6f72 2074 7970 652c 2068 6f77 6576  rror type, howev
+00022150: 6572 2c20 7468 6579 2073 686f 756c 6420  er, they should 
+00022160: 6765 7420 616e 0a20 2020 2020 2020 2023  get an.        #
+00022170: 2020 6572 726f 720a 2020 2020 2020 2020    error.        
+00022180: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00022190: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
+000221a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000221b0: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
+000221c0: 6572 2827 666f 6f27 2c20 7065 6262 6c65  er('foo', pebble
+000221d0: 2e4c 6179 6572 2873 6572 7669 6365 2929  .Layer(service))
+000221e0: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+000221f0: 6464 5f6c 6179 6572 5f74 6872 6565 5f73  dd_layer_three_s
+00022200: 6572 7669 6365 7328 7365 6c66 293a 0a20  ervices(self):. 
+00022210: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+00022220: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
+00022230: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
+00022240: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
+00022250: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
+00022260: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00022270: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
+00022280: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+00022290: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+000222a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000222b0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
+000222c0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000222d0: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
+000222e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000222f0: 7665 7272 6964 653a 2072 6570 6c61 6365  verride: replace
+00022300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022310: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
+00022320: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
+00022330: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00022340: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
+00022350: 7965 7228 2762 6172 272c 2027 2727 5c0a  yer('bar', '''\.
+00022360: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00022370: 6172 793a 2062 6172 0a20 2020 2020 2020  ary: bar.       
+00022380: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
+00022390: 2020 2020 2020 2020 2020 2020 2062 6172               bar
+000223a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000223b0: 2020 7375 6d6d 6172 793a 2054 6865 2047    summary: The G
+000223c0: 7265 6174 2042 6172 0a20 2020 2020 2020  reat Bar.       
+000223d0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
+000223e0: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
+000223f0: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
+00022400: 6465 3a20 7265 706c 6163 650a 2020 2020  de: replace.    
+00022410: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00022420: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
+00022430: 6261 7227 0a20 2020 2020 2020 2020 2020  bar'.           
+00022440: 2027 2727 290a 2020 2020 2020 2020 636c   ''').        cl
+00022450: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+00022460: 6261 7a27 2c20 2727 275c 0a20 2020 2020  baz', '''\.     
+00022470: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00022480: 6261 7a0a 2020 2020 2020 2020 2020 2020  baz.            
+00022490: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+000224a0: 2020 2020 2020 2020 6261 7a3a 0a20 2020          baz:.   
+000224b0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+000224c0: 6d61 7279 3a20 4e6f 7420 4261 722c 2062  mary: Not Bar, b
+000224d0: 7574 2042 617a 0a20 2020 2020 2020 2020  ut Baz.         
+000224e0: 2020 2020 2020 2073 7461 7274 7570 3a20         startup: 
+000224f0: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
+00022500: 2020 2020 2020 2020 6f76 6572 7269 6465          override
+00022510: 3a20 7265 706c 6163 650a 2020 2020 2020  : replace.      
+00022520: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+00022530: 643a 2027 2f62 696e 2f65 6368 6f20 6261  d: '/bin/echo ba
+00022540: 7a27 0a20 2020 2020 2020 2020 2020 2027  z'.            '
+00022550: 2727 290a 2020 2020 2020 2020 706c 616e  '').        plan
+00022560: 203d 2063 6c69 656e 742e 6765 745f 706c   = client.get_pl
+00022570: 616e 2829 0a20 2020 2020 2020 2073 656c  an().        sel
+00022580: 662e 6d61 7844 6966 6620 3d20 3130 3030  f.maxDiff = 1000
+00022590: 0a20 2020 2020 2020 2023 2041 6c70 6861  .        # Alpha
+000225a0: 6265 7469 6361 6c20 7365 7276 6963 6573  betical services
+000225b0: 2c20 616e 6420 7468 6520 5941 4d4c 2073  , and the YAML s
+000225c0: 686f 756c 6420 6265 206e 6f72 6d61 6c69  hould be normali
+000225d0: 7a65 640a 2020 2020 2020 2020 7365 6c66  zed.        self
+000225e0: 2e61 7373 6572 7445 7175 616c 2874 6578  .assertEqual(tex
+000225f0: 7477 7261 702e 6465 6465 6e74 2827 2727  twrap.dedent('''
+00022600: 5c0a 2020 2020 2020 2020 2020 2020 7365  \.            se
+00022610: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00022620: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00022630: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00022640: 6e64 3a20 2f62 696e 2f65 6368 6f20 6261  nd: /bin/echo ba
+00022650: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00022660: 2020 6f76 6572 7269 6465 3a20 7265 706c    override: repl
+00022670: 6163 650a 2020 2020 2020 2020 2020 2020  ace.            
+00022680: 2020 2020 7374 6172 7475 703a 2065 6e61      startup: ena
+00022690: 626c 6564 0a20 2020 2020 2020 2020 2020  bled.           
+000226a0: 2020 2020 2073 756d 6d61 7279 3a20 5468       summary: Th
+000226b0: 6520 4772 6561 7420 4261 720a 2020 2020  e Great Bar.    
+000226c0: 2020 2020 2020 2020 2020 6261 7a3a 0a20            baz:. 
+000226d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000226e0: 6f6d 6d61 6e64 3a20 2f62 696e 2f65 6368  ommand: /bin/ech
+000226f0: 6f20 6261 7a0a 2020 2020 2020 2020 2020  o baz.          
+00022700: 2020 2020 2020 6f76 6572 7269 6465 3a20        override: 
+00022710: 7265 706c 6163 650a 2020 2020 2020 2020  replace.        
+00022720: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
+00022730: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00022740: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+00022750: 3a20 4e6f 7420 4261 722c 2062 7574 2042  : Not Bar, but B
+00022760: 617a 0a20 2020 2020 2020 2020 2020 2020  az.             
+00022770: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
+00022780: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
+00022790: 6269 6e2f 6563 686f 2066 6f6f 0a20 2020  bin/echo foo.   
+000227a0: 2020 2020 2020 2020 2020 2020 206f 7665               ove
+000227b0: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
+000227c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000227d0: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
+000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227f0: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+00022800: 2020 2020 2020 2020 2027 2727 292c 2070           '''), p
+00022810: 6c61 6e2e 746f 5f79 616d 6c28 2929 0a0a  lan.to_yaml())..
+00022820: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+00022830: 5f6c 6179 6572 5f63 6f6d 6269 6e65 5f6e  _layer_combine_n
+00022840: 6f5f 6f76 6572 7269 6465 2873 656c 6629  o_override(self)
+00022850: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
+00022860: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
+00022870: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
+00022880: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
+00022890: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
+000228a0: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
+000228b0: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
+000228c0: 2020 2020 2020 2073 6572 7669 6365 733a         services:
+000228d0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
+000228e0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
+000228f0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+00022900: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+00022910: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00022920: 2066 6f6f 270a 2020 2020 2020 2020 2020   foo'.          
+00022930: 2020 2727 2729 0a20 2020 2020 2020 2023    ''').        #
+00022940: 2054 4f44 4f3a 206a 616d 2032 3032 312d   TODO: jam 2021-
+00022950: 3034 2d31 3920 5065 6262 6c65 2063 7572  04-19 Pebble cur
+00022960: 7265 6e74 6c79 2072 6169 7365 7320 6120  rently raises a 
+00022970: 4854 5450 2045 7272 6f72 2035 3030 2049  HTTP Error 500 I
+00022980: 6e74 6572 6e61 6c20 5365 7276 6963 6520  nternal Service 
+00022990: 4572 726f 720a 2020 2020 2020 2020 2320  Error.        # 
+000229a0: 2069 6620 796f 7520 646f 6e27 7420 7375   if you don't su
+000229b0: 7070 6c79 2061 6e20 6f76 6572 7269 6465  pply an override
+000229c0: 2064 6972 6563 7469 7665 2e20 5468 6174   directive. That
+000229d0: 206e 6565 6473 2074 6f20 6265 2066 6978   needs to be fix
+000229e0: 6564 2061 6e64 2074 6869 7320 7465 7374  ed and this test
+000229f0: 0a20 2020 2020 2020 2023 2020 7368 6f75  .        #  shou
+00022a00: 6c64 2062 6520 7570 6461 7465 642e 2068  ld be updated. h
+00022a10: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+00022a20: 6d2f 6361 6e6f 6e69 6361 6c2f 6f70 6572  m/canonical/oper
+00022a30: 6174 6f72 2f69 7373 7565 732f 3531 340a  ator/issues/514.
+00022a40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00022a50: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+00022a60: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+00022a70: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00022a80: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
+00022a90: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
+00022aa0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00022ab0: 666f 6f0a 2020 2020 2020 2020 2020 2020  foo.            
+00022ac0: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+00022ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ae0: 666f 6f3a 0a20 2020 2020 2020 2020 2020  foo:.           
+00022af0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+00022b00: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
 00022b10: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
 00022b20: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
 00022b30: 6f27 0a20 2020 2020 2020 2020 2020 2020  o'.             
-00022b40: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
-00022b50: 2020 2020 2020 7375 6d6d 6172 793a 2042        summary: B
-00022b60: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
-00022b70: 2020 2063 6f6d 6d61 6e64 3a20 272f 6269     command: '/bi
-00022b80: 6e2f 6563 686f 2062 6172 270a 2020 2020  n/echo bar'.    
-00022b90: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00022ba0: 2020 2020 2063 6c69 656e 742e 6175 746f       client.auto
-00022bb0: 7374 6172 745f 7365 7276 6963 6573 2829  start_services()
-00022bc0: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
-00022bd0: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
-00022be0: 6963 6573 2829 0a20 2020 2020 2020 2073  ices().        s
-00022bf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00022c00: 6c65 6e28 696e 666f 7329 2c20 3229 0a20  len(infos), 2). 
-00022c10: 2020 2020 2020 2062 6172 5f69 6e66 6f20         bar_info 
-00022c20: 3d20 696e 666f 735b 305d 0a20 2020 2020  = infos[0].     
-00022c30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022c40: 7561 6c28 2762 6172 272c 2062 6172 5f69  ual('bar', bar_i
-00022c50: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
-00022c60: 2020 2320 4465 6661 756c 7420 7768 656e    # Default when
-00022c70: 206e 6f74 2073 7065 6369 6669 6564 2069   not specified i
-00022c80: 7320 4449 5341 424c 4544 0a20 2020 2020  s DISABLED.     
-00022c90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022ca0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00022cb0: 6365 5374 6172 7475 702e 4449 5341 424c  ceStartup.DISABL
-00022cc0: 4544 2c20 6261 725f 696e 666f 2e73 7461  ED, bar_info.sta
-00022cd0: 7274 7570 290a 2020 2020 2020 2020 7365  rtup).        se
-00022ce0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00022cf0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-00022d00: 7475 732e 494e 4143 5449 5645 2c20 6261  tus.INACTIVE, ba
-00022d10: 725f 696e 666f 2e63 7572 7265 6e74 290a  r_info.current).
-00022d20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00022d30: 6572 7446 616c 7365 2862 6172 5f69 6e66  ertFalse(bar_inf
-00022d40: 6f2e 6973 5f72 756e 6e69 6e67 2829 290a  o.is_running()).
-00022d50: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
-00022d60: 203d 2069 6e66 6f73 5b31 5d0a 2020 2020   = infos[1].    
-00022d70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00022d80: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
-00022d90: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
-00022da0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022db0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00022dc0: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-00022dd0: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
-00022de0: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-00022df0: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00022e00: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-00022e10: 7573 2e41 4354 4956 452c 2066 6f6f 5f69  us.ACTIVE, foo_i
-00022e20: 6e66 6f2e 6375 7272 656e 7429 0a20 2020  nfo.current).   
-00022e30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00022e40: 5472 7565 2866 6f6f 5f69 6e66 6f2e 6973  True(foo_info.is
-00022e50: 5f72 756e 6e69 6e67 2829 290a 0a20 2020  _running())..   
-00022e60: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
-00022e70: 7276 6963 6573 5f73 7461 7274 5f73 746f  rvices_start_sto
-00022e80: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
-00022e90: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-00022ea0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-00022eb0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-00022ec0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-00022ed0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-00022ee0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-00022ef0: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-00022f00: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-00022f10: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-00022f20: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00022f30: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
-00022f40: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
-00022f50: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
-00022f60: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-00022f70: 3a20 272f 6269 6e2f 6563 686f 2066 6f6f  : '/bin/echo foo
-00022f80: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00022f90: 6261 723a 0a20 2020 2020 2020 2020 2020  bar:.           
-00022fa0: 2020 2020 2073 756d 6d61 7279 3a20 4261       summary: Ba
-00022fb0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00022fc0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00022fd0: 2f65 6368 6f20 6261 7227 0a20 2020 2020  /echo bar'.     
-00022fe0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00022ff0: 2020 2020 636c 6965 6e74 2e73 7461 7274      client.start
-00023000: 5f73 6572 7669 6365 7328 5b27 6261 7227  _services(['bar'
-00023010: 5d29 0a20 2020 2020 2020 2069 6e66 6f73  ]).        infos
-00023020: 203d 2063 6c69 656e 742e 6765 745f 7365   = client.get_se
-00023030: 7276 6963 6573 2829 0a20 2020 2020 2020  rvices().       
-00023040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00023050: 6c28 6c65 6e28 696e 666f 7329 2c20 3229  l(len(infos), 2)
-00023060: 0a20 2020 2020 2020 2062 6172 5f69 6e66  .        bar_inf
-00023070: 6f20 3d20 696e 666f 735b 305d 0a20 2020  o = infos[0].   
-00023080: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00023090: 4571 7561 6c28 2762 6172 272c 2062 6172  Equal('bar', bar
-000230a0: 5f69 6e66 6f2e 6e61 6d65 290a 2020 2020  _info.name).    
-000230b0: 2020 2020 2320 4576 656e 2074 686f 7567      # Even thoug
-000230c0: 6820 6261 7220 6465 6661 756c 7473 2074  h bar defaults t
-000230d0: 6f20 4449 5341 424c 4544 2c20 7765 2065  o DISABLED, we e
-000230e0: 7870 6c69 6369 746c 7920 7374 6172 7465  xplicitly starte
-000230f0: 6420 6974 0a20 2020 2020 2020 2073 656c  d it.        sel
-00023100: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00023110: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
-00023120: 7475 702e 4449 5341 424c 4544 2c20 6261  tup.DISABLED, ba
-00023130: 725f 696e 666f 2e73 7461 7274 7570 290a  r_info.startup).
-00023140: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00023150: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
-00023160: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
-00023170: 5449 5645 2c20 6261 725f 696e 666f 2e63  TIVE, bar_info.c
-00023180: 7572 7265 6e74 290a 2020 2020 2020 2020  urrent).        
-00023190: 2320 666f 6f20 776f 756c 6420 6265 2073  # foo would be s
-000231a0: 7461 7274 6564 2062 7920 6175 746f 7374  tarted by autost
-000231b0: 6172 742c 2062 7574 2077 6520 6f6e 6c79  art, but we only
-000231c0: 2063 616c 6c65 6420 7374 6172 745f 7365   called start_se
-000231d0: 7276 6963 6573 0a20 2020 2020 2020 2066  rvices.        f
-000231e0: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
-000231f0: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
-00023200: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
-00023210: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
-00023220: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00023230: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-00023240: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-00023250: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
-00023260: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
-00023270: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00023280: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
-00023290: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
-000232a0: 5645 2c20 666f 6f5f 696e 666f 2e63 7572  VE, foo_info.cur
-000232b0: 7265 6e74 290a 2020 2020 2020 2020 636c  rent).        cl
-000232c0: 6965 6e74 2e73 746f 705f 7365 7276 6963  ient.stop_servic
-000232d0: 6573 285b 2762 6172 275d 290a 2020 2020  es(['bar']).    
-000232e0: 2020 2020 696e 666f 7320 3d20 636c 6965      infos = clie
-000232f0: 6e74 2e67 6574 5f73 6572 7669 6365 7328  nt.get_services(
-00023300: 290a 2020 2020 2020 2020 6261 725f 696e  ).        bar_in
-00023310: 666f 203d 2069 6e66 6f73 5b30 5d0a 2020  fo = infos[0].  
-00023320: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00023330: 7445 7175 616c 2827 6261 7227 2c20 6261  tEqual('bar', ba
-00023340: 725f 696e 666f 2e6e 616d 6529 0a20 2020  r_info.name).   
-00023350: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00023360: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
-00023370: 7669 6365 5374 6172 7475 702e 4449 5341  viceStartup.DISA
-00023380: 424c 4544 2c20 6261 725f 696e 666f 2e73  BLED, bar_info.s
-00023390: 7461 7274 7570 290a 2020 2020 2020 2020  tartup).        
-000233a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000233b0: 2870 6562 626c 652e 5365 7276 6963 6553  (pebble.ServiceS
-000233c0: 7461 7475 732e 494e 4143 5449 5645 2c20  tatus.INACTIVE, 
-000233d0: 6261 725f 696e 666f 2e63 7572 7265 6e74  bar_info.current
-000233e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000233f0: 6765 745f 7365 7276 6963 6573 5f62 6164  get_services_bad
-00023400: 5f72 6571 7565 7374 2873 656c 6629 3a0a  _request(self):.
-00023410: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00023420: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
-00023430: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
-00023440: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
-00023450: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
-00023460: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00023470: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
-00023480: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-00023490: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
-000234a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000234b0: 2020 7375 6d6d 6172 793a 2046 6f6f 0a20    summary: Foo. 
-000234c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000234d0: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
-000234e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000234f0: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
-00023500: 6368 6f20 666f 6f27 0a20 2020 2020 2020  cho foo'.       
-00023510: 2020 2020 2020 2062 6172 3a0a 2020 2020         bar:.    
-00023520: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00023530: 6172 793a 2042 6172 0a20 2020 2020 2020  ary: Bar.       
-00023540: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-00023550: 3a20 272f 6269 6e2f 6563 686f 2062 6172  : '/bin/echo bar
-00023560: 270a 2020 2020 2020 2020 2020 2020 2727  '.            ''
-00023570: 2729 0a20 2020 2020 2020 2023 2049 7420  ').        # It 
-00023580: 6973 2061 2063 6f6d 6d6f 6e20 6d69 7374  is a common mist
-00023590: 616b 6520 746f 2070 6173 7320 6a75 7374  ake to pass just
-000235a0: 2061 206e 616d 6520 7673 2061 206c 6973   a name vs a lis
-000235b0: 7420 6f66 206e 616d 6573 2c20 736f 2063  t of names, so c
-000235c0: 6174 6368 2069 7420 7769 7468 2061 0a20  atch it with a. 
-000235d0: 2020 2020 2020 2023 2054 7970 6545 7272         # TypeErr
-000235e0: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
-000235f0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00023600: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-00023610: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00023620: 2e67 6574 5f73 6572 7669 6365 7328 2766  .get_services('f
-00023630: 6f6f 2729 0a0a 2020 2020 6465 6620 7465  oo')..    def te
-00023640: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
-00023650: 7375 6273 6574 2873 656c 6629 3a0a 2020  subset(self):.  
-00023660: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
-00023670: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
-00023680: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
-00023690: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
-000236a0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
-000236b0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
-000236c0: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
-000236d0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
-000236e0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
-000236f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023700: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
-00023710: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00023720: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
-00023730: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00023740: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
-00023750: 6f20 666f 6f27 0a20 2020 2020 2020 2020  o foo'.         
-00023760: 2020 2020 2062 6172 3a0a 2020 2020 2020       bar:.      
-00023770: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
-00023780: 793a 2042 6172 0a20 2020 2020 2020 2020  y: Bar.         
-00023790: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-000237a0: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
-000237b0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-000237c0: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
-000237d0: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
-000237e0: 6963 6573 285b 2766 6f6f 275d 290a 2020  ices(['foo']).  
-000237f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00023800: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
-00023810: 292c 2031 290a 2020 2020 2020 2020 666f  ), 1).        fo
-00023820: 6f5f 696e 666f 203d 2069 6e66 6f73 5b30  o_info = infos[0
-00023830: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00023840: 7373 6572 7445 7175 616c 2827 666f 6f27  ssertEqual('foo'
-00023850: 2c20 666f 6f5f 696e 666f 2e6e 616d 6529  , foo_info.name)
-00023860: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00023870: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
-00023880: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-00023890: 454e 4142 4c45 442c 2066 6f6f 5f69 6e66  ENABLED, foo_inf
-000238a0: 6f2e 7374 6172 7475 7029 0a20 2020 2020  o.startup).     
-000238b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000238c0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-000238d0: 6365 5374 6174 7573 2e49 4e41 4354 4956  ceStatus.INACTIV
-000238e0: 452c 2066 6f6f 5f69 6e66 6f2e 6375 7272  E, foo_info.curr
-000238f0: 656e 7429 0a0a 2020 2020 6465 6620 7465  ent)..    def te
-00023900: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
-00023910: 756e 6b6e 6f77 6e28 7365 6c66 293a 0a20  unknown(self):. 
-00023920: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00023930: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
-00023940: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
-00023950: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
-00023960: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
-00023970: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00023980: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
-00023990: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
-000239a0: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-000239b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000239c0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
-000239d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000239e0: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
-000239f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00023a00: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-00023a10: 686f 2066 6f6f 270a 2020 2020 2020 2020  ho foo'.        
-00023a20: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
-00023a30: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00023a40: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
-00023a50: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00023a60: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
-00023a70: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00023a80: 290a 2020 2020 2020 2020 2320 5468 6973  ).        # This
-00023a90: 2064 6f65 736e 2774 2073 6565 6d20 746f   doesn't seem to
-00023aa0: 2062 6520 616e 2065 7272 6f72 2061 7420   be an error at 
-00023ab0: 7468 6520 6d6f 6d65 6e74 2e0a 2020 2020  the moment..    
-00023ac0: 2020 2020 2320 7065 6262 6c65 5f63 6c69      # pebble_cli
-00023ad0: 2e70 7920 7365 7276 6963 6520 6a75 7374  .py service just
-00023ae0: 2072 6574 7572 6e73 2061 6e20 656d 7074   returns an empt
-00023af0: 7920 6c69 7374 0a20 2020 2020 2020 2023  y list.        #
-00023b00: 2070 6562 626c 6520 7365 7276 6963 6520   pebble service 
-00023b10: 756e 6b6e 6f77 6e20 7361 7973 2022 4e6f  unknown says "No
-00023b20: 206d 6174 6368 696e 6720 7365 7276 6963   matching servic
-00023b30: 6573 2220 2862 7574 2065 7869 7473 2030  es" (but exits 0
-00023b40: 290a 2020 2020 2020 2020 696e 666f 7320  ).        infos 
-00023b50: 3d20 636c 6965 6e74 2e67 6574 5f73 6572  = client.get_ser
-00023b60: 7669 6365 7328 5b27 756e 6b6e 6f77 6e27  vices(['unknown'
-00023b70: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00023b80: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-00023b90: 732c 205b 5d29 0a0a 2020 2020 6465 6620  s, [])..    def 
-00023ba0: 7465 7374 5f69 6e76 616c 6964 5f73 7461  test_invalid_sta
-00023bb0: 7274 5f73 6572 7669 6365 2873 656c 6629  rt_service(self)
-00023bc0: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
-00023bd0: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-00023be0: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-00023bf0: 2020 2020 2023 2054 4f44 4f3a 206a 616d       # TODO: jam
-00023c00: 2032 3032 312d 3034 2d32 3020 5468 6973   2021-04-20 This
-00023c10: 2073 686f 756c 6420 6265 636f 6d65 2061   should become a
-00023c20: 2062 6574 7465 7220 6572 726f 720a 2020   better error.  
-00023c30: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00023c40: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-00023c50: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-00023c60: 2020 2020 2020 2020 636c 6965 6e74 2e73          client.s
-00023c70: 7461 7274 5f73 6572 7669 6365 7328 5b27  tart_services(['
-00023c80: 756e 6b6e 6f77 6e27 5d29 0a0a 2020 2020  unknown'])..    
-00023c90: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
-00023ca0: 6572 7669 6365 5f73 7472 2873 656c 6629  ervice_str(self)
-00023cb0: 3a0a 2020 2020 2020 2020 2320 5374 6172  :.        # Star
-00023cc0: 7420 7365 7276 6963 6520 7461 6b65 7320  t service takes 
-00023cd0: 6120 6c69 7374 206f 6620 6e61 6d65 732c  a list of names,
-00023ce0: 2062 7574 2069 7420 6973 2072 6561 6c6c   but it is reall
-00023cf0: 7920 6561 7379 2074 6f20 6163 6369 6465  y easy to accide
-00023d00: 6e74 616c 6c79 2070 6173 7320 6a75 7374  ntally pass just
-00023d10: 2061 0a20 2020 2020 2020 2023 206e 616d   a.        # nam
-00023d20: 650a 2020 2020 2020 2020 636c 6965 6e74  e.        client
-00023d30: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-00023d40: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-00023d50: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00023d60: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-00023d70: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00023d80: 2020 2020 636c 6965 6e74 2e73 7461 7274      client.start
-00023d90: 5f73 6572 7669 6365 7328 2775 6e6b 6e6f  _services('unkno
-00023da0: 776e 2729 0a0a 2020 2020 6465 6620 7465  wn')..    def te
-00023db0: 7374 5f73 746f 705f 7365 7276 6963 655f  st_stop_service_
-00023dc0: 7374 7228 7365 6c66 293a 0a20 2020 2020  str(self):.     
-00023dd0: 2020 2023 2053 7461 7274 2073 6572 7669     # Start servi
-00023de0: 6365 2074 616b 6573 2061 206c 6973 7420  ce takes a list 
-00023df0: 6f66 206e 616d 6573 2c20 6275 7420 6974  of names, but it
-00023e00: 2069 7320 7265 616c 6c79 2065 6173 7920   is really easy 
-00023e10: 746f 2061 6363 6964 656e 7461 6c6c 7920  to accidentally 
-00023e20: 7061 7373 206a 7573 7420 610a 2020 2020  pass just a.    
-00023e30: 2020 2020 2320 6e61 6d65 0a20 2020 2020      # name.     
-00023e40: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00023e50: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
-00023e60: 656e 7428 290a 2020 2020 2020 2020 7769  ent().        wi
-00023e70: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00023e80: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00023e90: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00023ea0: 656e 742e 7374 6f70 5f73 6572 7669 6365  ent.stop_service
-00023eb0: 7328 2775 6e6b 6e6f 776e 2729 0a0a 2020  s('unknown')..  
-00023ec0: 2020 6465 6620 7465 7374 5f6d 6978 6564    def test_mixed
-00023ed0: 5f73 7461 7274 5f73 6572 7669 6365 2873  _start_service(s
-00023ee0: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00023ef0: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
-00023f00: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
-00023f10: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-00023f20: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
-00023f30: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
-00023f40: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-00023f50: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-00023f60: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-00023f70: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-00023f80: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-00023f90: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-00023fa0: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
-00023fb0: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
-00023fc0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-00023fd0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
-00023fe0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00023ff0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
-00024000: 6a61 6d20 3230 3231 2d30 342d 3230 2062  jam 2021-04-20 b
-00024010: 6574 7465 7220 6572 726f 7220 7479 7065  etter error type
-00024020: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00024030: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00024040: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
-00024050: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-00024060: 742e 7374 6172 745f 7365 7276 6963 6573  t.start_services
-00024070: 285b 2766 6f6f 272c 2027 756e 6b6e 6f77  (['foo', 'unknow
-00024080: 6e27 5d29 0a20 2020 2020 2020 2023 2066  n']).        # f
-00024090: 6f6f 2073 686f 756c 6420 6e6f 7420 6265  oo should not be
-000240a0: 2073 7461 7274 6564 0a20 2020 2020 2020   started.       
-000240b0: 2069 6e66 6f73 203d 2063 6c69 656e 742e   infos = client.
-000240c0: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
-000240d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000240e0: 7274 4571 7561 6c28 6c65 6e28 696e 666f  rtEqual(len(info
-000240f0: 7329 2c20 3129 0a20 2020 2020 2020 2066  s), 1).        f
-00024100: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
-00024110: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-00024120: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
-00024130: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
-00024140: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00024150: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-00024160: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-00024170: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
-00024180: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
-00024190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000241a0: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
-000241b0: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
-000241c0: 5645 2c20 666f 6f5f 696e 666f 2e63 7572  VE, foo_info.cur
-000241d0: 7265 6e74 290a 0a20 2020 2064 6566 2074  rent)..    def t
-000241e0: 6573 745f 7374 6f70 5f73 6572 7669 6365  est_stop_service
-000241f0: 735f 756e 6b6e 6f77 6e28 7365 6c66 293a  s_unknown(self):
-00024200: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
-00024210: 3d20 7365 6c66 2e67 6574 5f74 6573 7469  = self.get_testi
-00024220: 6e67 5f63 6c69 656e 7428 290a 2020 2020  ng_client().    
-00024230: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
-00024240: 6179 6572 2827 666f 6f27 2c20 2727 275c  ayer('foo', '''\
-00024250: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
-00024260: 6d61 7279 3a20 666f 6f0a 2020 2020 2020  mary: foo.      
-00024270: 2020 2020 2020 7365 7276 6963 6573 3a0a        services:.
-00024280: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00024290: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
-000242a0: 2020 2073 756d 6d61 7279 3a20 466f 6f0a     summary: Foo.
-000242b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242c0: 7374 6172 7475 703a 2065 6e61 626c 6564  startup: enabled
-000242d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000242e0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-000242f0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
-00024300: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00024310: 2020 2063 6c69 656e 742e 6175 746f 7374     client.autost
-00024320: 6172 745f 7365 7276 6963 6573 2829 0a20  art_services(). 
-00024330: 2020 2020 2020 2023 2054 4f44 4f3a 206a         # TODO: j
-00024340: 616d 2032 3032 312d 3034 2d32 3020 6265  am 2021-04-20 be
-00024350: 7474 6572 2065 7272 6f72 2074 7970 650a  tter error type.
-00024360: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00024370: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
-00024380: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
-00024390: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-000243a0: 2e73 746f 705f 7365 7276 6963 6573 285b  .stop_services([
-000243b0: 2766 6f6f 272c 2027 756e 6b6e 6f77 6e27  'foo', 'unknown'
-000243c0: 5d29 0a20 2020 2020 2020 2023 2066 6f6f  ]).        # foo
-000243d0: 2073 686f 756c 6420 7374 696c 6c20 6265   should still be
-000243e0: 2072 756e 6e69 6e67 0a20 2020 2020 2020   running.       
-000243f0: 2069 6e66 6f73 203d 2063 6c69 656e 742e   infos = client.
-00024400: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
-00024410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00024420: 7274 4571 7561 6c28 6c65 6e28 696e 666f  rtEqual(len(info
-00024430: 7329 2c20 3129 0a20 2020 2020 2020 2066  s), 1).        f
-00024440: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
-00024450: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-00024460: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
-00024470: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
-00024480: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00024490: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-000244a0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-000244b0: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
-000244c0: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
-000244d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000244e0: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
-000244f0: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
-00024500: 2c20 666f 6f5f 696e 666f 2e63 7572 7265  , foo_info.curre
-00024510: 6e74 290a 0a20 2020 2064 6566 2074 6573  nt)..    def tes
-00024520: 745f 7374 6172 745f 7374 6172 7465 645f  t_start_started_
-00024530: 7365 7276 6963 6528 7365 6c66 293a 0a20  service(self):. 
-00024540: 2020 2020 2020 2023 2050 6562 626c 6520         # Pebble 
-00024550: 6d61 696e 7461 696e 7320 6964 656d 706f  maintains idempo
-00024560: 7465 6e63 7920 6576 656e 2069 6620 796f  tency even if yo
-00024570: 7520 7374 6172 7420 6120 7365 7276 6963  u start a servic
-00024580: 650a 2020 2020 2020 2020 2320 7768 6963  e.        # whic
-00024590: 6820 6973 2061 6c72 6561 6479 2073 7461  h is already sta
-000245a0: 7274 6564 2e0a 2020 2020 2020 2020 636c  rted..        cl
-000245b0: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
-000245c0: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
-000245d0: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-000245e0: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
-000245f0: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
-00024600: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-00024610: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-00024620: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-00024630: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-00024640: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-00024650: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-00024660: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
-00024670: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
-00024680: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-00024690: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
-000246a0: 2020 2020 2020 2020 2020 2020 2062 6172               bar
-000246b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000246c0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
-000246d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000246e0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-000246f0: 686f 2062 6172 270a 2020 2020 2020 2020  ho bar'.        
-00024700: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00024710: 2063 6c69 656e 742e 6175 746f 7374 6172   client.autostar
-00024720: 745f 7365 7276 6963 6573 2829 0a20 2020  t_services().   
-00024730: 2020 2020 2023 2046 6f6f 2069 7320 6e6f       # Foo is no
-00024740: 7720 7374 6172 7465 642c 2062 7574 2042  w started, but B
-00024750: 6172 2069 7320 6e6f 740a 2020 2020 2020  ar is not.      
-00024760: 2020 636c 6965 6e74 2e73 7461 7274 5f73    client.start_s
-00024770: 6572 7669 6365 7328 5b27 6261 7227 2c20  ervices(['bar', 
-00024780: 2766 6f6f 275d 290a 2020 2020 2020 2020  'foo']).        
-00024790: 2320 666f 6f20 616e 6420 6261 7220 6172  # foo and bar ar
-000247a0: 6520 626f 7468 2073 7461 7274 6564 0a20  e both started. 
-000247b0: 2020 2020 2020 2069 6e66 6f73 203d 2063         infos = c
-000247c0: 6c69 656e 742e 6765 745f 7365 7276 6963  lient.get_servic
-000247d0: 6573 2829 0a20 2020 2020 2020 2073 656c  es().        sel
-000247e0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-000247f0: 6e28 696e 666f 7329 2c20 3229 0a20 2020  n(infos), 2).   
-00024800: 2020 2020 2062 6172 5f69 6e66 6f20 3d20       bar_info = 
-00024810: 696e 666f 735b 305d 0a20 2020 2020 2020  infos[0].       
-00024820: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00024830: 6c28 2762 6172 272c 2062 6172 5f69 6e66  l('bar', bar_inf
-00024840: 6f2e 6e61 6d65 290a 2020 2020 2020 2020  o.name).        
-00024850: 2320 4465 6661 756c 7420 7768 656e 206e  # Default when n
-00024860: 6f74 2073 7065 6369 6669 6564 2069 7320  ot specified is 
-00024870: 4449 5341 424c 4544 0a20 2020 2020 2020  DISABLED.       
-00024880: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00024890: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
-000248a0: 5374 6172 7475 702e 4449 5341 424c 4544  Startup.DISABLED
-000248b0: 2c20 6261 725f 696e 666f 2e73 7461 7274  , bar_info.start
-000248c0: 7570 290a 2020 2020 2020 2020 7365 6c66  up).        self
-000248d0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-000248e0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-000248f0: 732e 4143 5449 5645 2c20 6261 725f 696e  s.ACTIVE, bar_in
-00024900: 666f 2e63 7572 7265 6e74 290a 2020 2020  fo.current).    
-00024910: 2020 2020 666f 6f5f 696e 666f 203d 2069      foo_info = i
-00024920: 6e66 6f73 5b31 5d0a 2020 2020 2020 2020  nfos[1].        
-00024930: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00024940: 2827 666f 6f27 2c20 666f 6f5f 696e 666f  ('foo', foo_info
-00024950: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
-00024960: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00024970: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-00024980: 6172 7475 702e 454e 4142 4c45 442c 2066  artup.ENABLED, f
-00024990: 6f6f 5f69 6e66 6f2e 7374 6172 7475 7029  oo_info.startup)
-000249a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000249b0: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
-000249c0: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
-000249d0: 4354 4956 452c 2066 6f6f 5f69 6e66 6f2e  CTIVE, foo_info.
-000249e0: 6375 7272 656e 7429 0a0a 2020 2020 6465  current)..    de
-000249f0: 6620 7465 7374 5f73 746f 705f 7374 6f70  f test_stop_stop
-00024a00: 7065 645f 7365 7276 6963 6528 7365 6c66  ped_service(self
-00024a10: 293a 0a20 2020 2020 2020 2023 2050 6562  ):.        # Peb
-00024a20: 626c 6520 6d61 696e 7461 696e 7320 6964  ble maintains id
-00024a30: 656d 706f 7465 6e63 7920 6576 656e 2069  empotency even i
-00024a40: 6620 796f 7520 7374 6f70 2061 2073 6572  f you stop a ser
-00024a50: 7669 6365 0a20 2020 2020 2020 2023 2077  vice.        # w
-00024a60: 6869 6368 2069 7320 616c 7265 6164 7920  hich is already 
-00024a70: 7374 6f70 7065 642e 0a20 2020 2020 2020  stopped..       
-00024a80: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-00024a90: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-00024aa0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-00024ab0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-00024ac0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-00024ad0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-00024ae0: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-00024af0: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-00024b00: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-00024b10: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00024b20: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
-00024b30: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
-00024b40: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
-00024b50: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-00024b60: 3a20 272f 6269 6e2f 6563 686f 2066 6f6f  : '/bin/echo foo
-00024b70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00024b80: 6261 723a 0a20 2020 2020 2020 2020 2020  bar:.           
-00024b90: 2020 2020 2073 756d 6d61 7279 3a20 4261       summary: Ba
-00024ba0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00024bb0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00024bc0: 2f65 6368 6f20 6261 7227 0a20 2020 2020  /echo bar'.     
-00024bd0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00024be0: 2020 2020 636c 6965 6e74 2e61 7574 6f73      client.autos
-00024bf0: 7461 7274 5f73 6572 7669 6365 7328 290a  tart_services().
-00024c00: 2020 2020 2020 2020 2320 466f 6f20 6973          # Foo is
-00024c10: 206e 6f77 2073 7461 7274 6564 2c20 6275   now started, bu
-00024c20: 7420 4261 7220 6973 206e 6f74 0a20 2020  t Bar is not.   
-00024c30: 2020 2020 2063 6c69 656e 742e 7374 6f70       client.stop
-00024c40: 5f73 6572 7669 6365 7328 5b27 666f 6f27  _services(['foo'
-00024c50: 2c20 2762 6172 275d 290a 2020 2020 2020  , 'bar']).      
-00024c60: 2020 2320 666f 6f20 616e 6420 6261 7220    # foo and bar 
-00024c70: 6172 6520 626f 7468 2073 746f 7070 6564  are both stopped
-00024c80: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
-00024c90: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
-00024ca0: 6963 6573 2829 0a20 2020 2020 2020 2073  ices().        s
-00024cb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00024cc0: 6c65 6e28 696e 666f 7329 2c20 3229 0a20  len(infos), 2). 
-00024cd0: 2020 2020 2020 2062 6172 5f69 6e66 6f20         bar_info 
-00024ce0: 3d20 696e 666f 735b 305d 0a20 2020 2020  = infos[0].     
-00024cf0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00024d00: 7561 6c28 2762 6172 272c 2062 6172 5f69  ual('bar', bar_i
-00024d10: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
-00024d20: 2020 2320 4465 6661 756c 7420 7768 656e    # Default when
-00024d30: 206e 6f74 2073 7065 6369 6669 6564 2069   not specified i
-00024d40: 7320 4449 5341 424c 4544 0a20 2020 2020  s DISABLED.     
-00024d50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00024d60: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00024d70: 6365 5374 6172 7475 702e 4449 5341 424c  ceStartup.DISABL
-00024d80: 4544 2c20 6261 725f 696e 666f 2e73 7461  ED, bar_info.sta
-00024d90: 7274 7570 290a 2020 2020 2020 2020 7365  rtup).        se
-00024da0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00024db0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-00024dc0: 7475 732e 494e 4143 5449 5645 2c20 6261  tus.INACTIVE, ba
-00024dd0: 725f 696e 666f 2e63 7572 7265 6e74 290a  r_info.current).
-00024de0: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
-00024df0: 203d 2069 6e66 6f73 5b31 5d0a 2020 2020   = infos[1].    
-00024e00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00024e10: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
-00024e20: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
-00024e30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00024e40: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00024e50: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-00024e60: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
-00024e70: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-00024e80: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00024e90: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-00024ea0: 7573 2e49 4e41 4354 4956 452c 2066 6f6f  us.INACTIVE, foo
-00024eb0: 5f69 6e66 6f2e 6375 7272 656e 7429 0a0a  _info.current)..
-00024ec0: 2020 2020 4020 756e 6974 7465 7374 2e73      @ unittest.s
-00024ed0: 6b69 7055 6e6c 6573 7328 6973 5f6c 696e  kipUnless(is_lin
-00024ee0: 7578 2c20 2750 6562 626c 6520 7275 6e73  ux, 'Pebble runs
-00024ef0: 206f 6e20 4c69 6e75 7827 290a 2020 2020   on Linux').    
-00024f00: 6465 6620 7465 7374 5f73 656e 645f 7369  def test_send_si
-00024f10: 676e 616c 2873 656c 6629 3a0a 2020 2020  gnal(self):.    
-00024f20: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
-00024f30: 662e 6765 745f 7465 7374 696e 675f 636c  f.get_testing_cl
-00024f40: 6965 6e74 2829 0a20 2020 2020 2020 2063  ient().        c
-00024f50: 6c69 656e 742e 6164 645f 6c61 7965 7228  lient.add_layer(
-00024f60: 2766 6f6f 272c 2027 2727 5c0a 2020 2020  'foo', '''\.    
-00024f70: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-00024f80: 2066 6f6f 0a20 2020 2020 2020 2020 2020   foo.           
-00024f90: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
-00024fa0: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
-00024fb0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00024fc0: 6d6d 6172 793a 2046 6f6f 0a20 2020 2020  mmary: Foo.     
-00024fd0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00024fe0: 7570 3a20 656e 6162 6c65 640a 2020 2020  up: enabled.    
-00024ff0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00025000: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
-00025010: 666f 6f27 0a20 2020 2020 2020 2020 2020  foo'.           
-00025020: 2020 2062 6172 3a0a 2020 2020 2020 2020     bar:.        
-00025030: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-00025040: 2042 6172 0a20 2020 2020 2020 2020 2020   Bar.           
-00025050: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-00025060: 6269 6e2f 6563 686f 2062 6172 270a 2020  bin/echo bar'.  
-00025070: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-00025080: 2020 2020 2020 2063 6c69 656e 742e 6175         client.au
-00025090: 746f 7374 6172 745f 7365 7276 6963 6573  tostart_services
-000250a0: 2829 0a20 2020 2020 2020 2023 2046 6f6f  ().        # Foo
-000250b0: 2069 7320 6e6f 7720 7374 6172 7465 642c   is now started,
-000250c0: 2062 7574 2042 6172 2069 7320 6e6f 740a   but Bar is not.
-000250d0: 0a20 2020 2020 2020 2023 2053 656e 6420  .        # Send 
-000250e0: 6120 7661 6c69 6420 7369 676e 616c 2074  a valid signal t
-000250f0: 6f20 6120 7275 6e6e 696e 6720 7365 7276  o a running serv
-00025100: 6963 650a 2020 2020 2020 2020 636c 6965  ice.        clie
-00025110: 6e74 2e73 656e 645f 7369 676e 616c 2822  nt.send_signal("
-00025120: 5349 4749 4e54 222c 2028 2266 6f6f 222c  SIGINT", ("foo",
-00025130: 2929 0a0a 2020 2020 2020 2020 2320 5365  ))..        # Se
-00025140: 6e64 2061 2076 616c 6964 2073 6967 6e61  nd a valid signa
-00025150: 6c20 6275 7420 6f6d 6974 2073 6572 7669  l but omit servi
-00025160: 6365 206e 616d 650a 2020 2020 2020 2020  ce name.        
-00025170: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00025180: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-00025190: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-000251a0: 6c69 656e 742e 7365 6e64 5f73 6967 6e61  lient.send_signa
-000251b0: 6c28 2253 4947 494e 5422 2c20 7475 706c  l("SIGINT", tupl
-000251c0: 6528 2929 0a0a 2020 2020 2020 2020 2320  e())..        # 
-000251d0: 5365 6e64 2061 6e20 696e 7661 6c69 6420  Send an invalid 
-000251e0: 7369 676e 616c 2074 6f20 6120 7275 6e6e  signal to a runn
-000251f0: 696e 6720 7365 7276 6963 650a 2020 2020  ing service.    
-00025200: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00025210: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
-00025220: 652e 4150 4945 7272 6f72 293a 0a20 2020  e.APIError):.   
-00025230: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
-00025240: 7365 6e64 5f73 6967 6e61 6c28 2273 6967  send_signal("sig
-00025250: 696e 7422 2c20 2822 666f 6f22 2c29 290a  int", ("foo",)).
-00025260: 0a20 2020 2020 2020 2023 2053 656e 6420  .        # Send 
-00025270: 6120 7661 6c69 6420 7369 676e 616c 2074  a valid signal t
-00025280: 6f20 6120 7374 6f70 7065 6420 7365 7276  o a stopped serv
-00025290: 6963 650a 2020 2020 2020 2020 7769 7468  ice.        with
-000252a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000252b0: 6573 2870 6562 626c 652e 4150 4945 7272  es(pebble.APIErr
-000252c0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000252d0: 2063 6c69 656e 742e 7365 6e64 5f73 6967   client.send_sig
-000252e0: 6e61 6c28 2253 4947 494e 5422 2c20 2822  nal("SIGINT", ("
-000252f0: 6261 7222 2c29 290a 0a20 2020 2020 2020  bar",))..       
-00025300: 2023 2053 656e 6420 6120 7661 6c69 6420   # Send a valid 
-00025310: 7369 676e 616c 2074 6f20 6120 6e6f 6e2d  signal to a non-
-00025320: 6578 6973 7469 6e67 2073 6572 7669 6365  existing service
-00025330: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00025340: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00025350: 7065 6262 6c65 2e41 5049 4572 726f 7229  pebble.APIError)
-00025360: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00025370: 6965 6e74 2e73 656e 645f 7369 676e 616c  ient.send_signal
-00025380: 2822 5349 4749 4e54 222c 2028 2262 617a  ("SIGINT", ("baz
-00025390: 222c 2929 0a0a 2020 2020 2020 2020 2320  ",))..        # 
-000253a0: 5365 6e64 2061 2076 616c 6964 2073 6967  Send a valid sig
-000253b0: 6e61 6c20 746f 2061 206d 756c 7469 706c  nal to a multipl
-000253c0: 6520 7365 7276 6963 6573 2c20 6f6e 6520  e services, one 
-000253d0: 6f66 2077 6869 6368 2069 7320 6e6f 7420  of which is not 
-000253e0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-000253f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00025400: 5261 6973 6573 2870 6562 626c 652e 4150  Raises(pebble.AP
-00025410: 4945 7272 6f72 293a 0a20 2020 2020 2020  IError):.       
-00025420: 2020 2020 2063 6c69 656e 742e 7365 6e64       client.send
-00025430: 5f73 6967 6e61 6c28 2253 4947 494e 5422  _signal("SIGINT"
-00025440: 2c20 2822 666f 6f22 2c20 2262 6172 222c  , ("foo", "bar",
-00025450: 2929 0a0a 0a23 2046 6f72 2074 6573 7469  ))...# For testi
-00025460: 6e67 2066 696c 652d 6f70 7320 6f66 2074  ng file-ops of t
-00025470: 6865 2070 6562 626c 6520 636c 6965 6e74  he pebble client
-00025480: 2e20 2054 6869 7320 6973 2072 6566 6163  .  This is refac
-00025490: 746f 7265 6420 696e 746f 2061 0a23 2073  tored into a.# s
-000254a0: 6570 6172 6174 6520 6d69 7869 6e20 736f  eparate mixin so
-000254b0: 2077 6520 6361 6e20 7275 6e20 7468 6573   we can run thes
-000254c0: 6520 7465 7374 7320 6167 6169 6e73 7420  e tests against 
-000254d0: 626f 7468 2074 6865 206d 6f63 6b20 636c  both the mock cl
-000254e0: 6965 6e74 2061 730a 2320 7765 6c6c 2061  ient as.# well a
-000254f0: 7320 6120 7265 616c 2070 6562 626c 6520  s a real pebble 
-00025500: 7365 7276 6572 2069 6e73 7461 6e63 652e  server instance.
-00025510: 0a63 6c61 7373 205f 5065 6262 6c65 5374  .class _PebbleSt
-00025520: 6f72 6167 6541 5049 7354 6573 744d 6978  orageAPIsTestMix
-00025530: 696e 3a0a 2020 2020 2320 4f76 6572 7269  in:.    # Overri
-00025540: 6465 2074 6869 7320 696e 2063 6c61 7373  de this in class
-00025550: 6573 2075 7369 6e67 2074 6869 7320 6d69  es using this mi
-00025560: 7869 6e2e 0a20 2020 2023 2054 6869 7320  xin..    # This 
-00025570: 7368 6f75 6c64 2062 6520 7365 7420 746f  should be set to
-00025580: 2061 6e79 206e 6f6e 2d65 6d70 7479 2070   any non-empty p
-00025590: 6174 682c 2062 7574 2077 6974 686f 7574  ath, but without
-000255a0: 2061 2074 7261 696c 696e 6720 2f2e 0a20   a trailing /.. 
-000255b0: 2020 2070 7265 6669 7820 3d20 4e6f 6e65     prefix = None
-000255c0: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-000255d0: 7573 685f 616e 645f 7075 6c6c 5f62 7974  ush_and_pull_byt
-000255e0: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-000255f0: 2020 7365 6c66 2e5f 7465 7374 5f70 7573    self._test_pus
-00025600: 685f 616e 645f 7075 6c6c 5f64 6174 6128  h_and_pull_data(
-00025610: 0a20 2020 2020 2020 2020 2020 206f 7269  .            ori
-00025620: 6769 6e61 6c5f 6461 7461 3d62 225c 7830  ginal_data=b"\x0
-00025630: 305c 7830 315c 7830 325c 7830 335c 7830  0\x01\x02\x03\x0
-00025640: 3422 2c0a 2020 2020 2020 2020 2020 2020  4",.            
-00025650: 656e 636f 6469 6e67 3d4e 6f6e 652c 0a20  encoding=None,. 
-00025660: 2020 2020 2020 2020 2020 2073 7472 6561             strea
-00025670: 6d5f 636c 6173 733d 696f 2e42 7974 6573  m_class=io.Bytes
-00025680: 494f 290a 0a20 2020 2064 6566 2074 6573  IO)..    def tes
-00025690: 745f 7075 7368 5f61 6e64 5f70 756c 6c5f  t_push_and_pull_
-000256a0: 6e6f 6e5f 7574 6638 5f64 6174 6128 7365  non_utf8_data(se
-000256b0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-000256c0: 662e 5f74 6573 745f 7075 7368 5f61 6e64  f._test_push_and
-000256d0: 5f70 756c 6c5f 6461 7461 280a 2020 2020  _pull_data(.    
-000256e0: 2020 2020 2020 2020 6f72 6967 696e 616c          original
-000256f0: 5f64 6174 613d 27e6 97a5 e69c ace8 aa9e  _data='.........
-00025700: 272c 2020 2320 224a 6170 616e 6573 6522  ',  # "Japanese"
-00025710: 2069 6e20 4a61 7061 6e65 7365 0a20 2020   in Japanese.   
-00025720: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
-00025730: 673d 2773 6a69 7327 2c0a 2020 2020 2020  g='sjis',.      
-00025740: 2020 2020 2020 7374 7265 616d 5f63 6c61        stream_cla
-00025750: 7373 3d69 6f2e 5374 7269 6e67 494f 290a  ss=io.StringIO).
-00025760: 0a20 2020 2064 6566 205f 7465 7374 5f70  .    def _test_p
-00025770: 7573 685f 616e 645f 7075 6c6c 5f64 6174  ush_and_pull_dat
-00025780: 6128 7365 6c66 2c20 6f72 6967 696e 616c  a(self, original
-00025790: 5f64 6174 612c 2065 6e63 6f64 696e 672c  _data, encoding,
-000257a0: 2073 7472 6561 6d5f 636c 6173 7329 3a0a   stream_class):.
-000257b0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-000257c0: 2073 656c 662e 636c 6965 6e74 0a20 2020   self.client.   
-000257d0: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-000257e0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-000257f0: 2f74 6573 7422 2c20 6f72 6967 696e 616c  /test", original
-00025800: 5f64 6174 612c 2065 6e63 6f64 696e 673d  _data, encoding=
-00025810: 656e 636f 6469 6e67 290a 2020 2020 2020  encoding).      
-00025820: 2020 7769 7468 2063 6c69 656e 742e 7075    with client.pu
-00025830: 6c6c 2866 227b 7365 6c66 2e70 7265 6669  ll(f"{self.prefi
-00025840: 787d 2f74 6573 7422 2c20 656e 636f 6469  x}/test", encodi
-00025850: 6e67 3d65 6e63 6f64 696e 6729 2061 7320  ng=encoding) as 
-00025860: 696e 6669 6c65 3a0a 2020 2020 2020 2020  infile:.        
-00025870: 2020 2020 7265 6365 6976 6564 5f64 6174      received_dat
-00025880: 6120 3d20 696e 6669 6c65 2e72 6561 6428  a = infile.read(
-00025890: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000258a0: 7373 6572 7445 7175 616c 286f 7269 6769  ssertEqual(origi
-000258b0: 6e61 6c5f 6461 7461 2c20 7265 6365 6976  nal_data, receiv
-000258c0: 6564 5f64 6174 6129 0a0a 2020 2020 2020  ed_data)..      
-000258d0: 2020 2320 5765 2061 6c73 6f20 7375 7070    # We also supp
-000258e0: 6f72 7420 6669 6c65 2d6c 696b 6520 6f62  ort file-like ob
-000258f0: 6a65 6374 7320 6173 2069 6e70 7574 2c20  jects as input, 
-00025900: 736f 206c 6574 2773 2074 6573 7420 7468  so let's test th
-00025910: 6174 2063 6173 6520 6173 2077 656c 6c2e  at case as well.
-00025920: 0a20 2020 2020 2020 2073 6d61 6c6c 5f66  .        small_f
-00025930: 696c 6520 3d20 7374 7265 616d 5f63 6c61  ile = stream_cla
-00025940: 7373 286f 7269 6769 6e61 6c5f 6461 7461  ss(original_data
-00025950: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00025960: 2e70 7573 6828 6622 7b73 656c 662e 7072  .push(f"{self.pr
-00025970: 6566 6978 7d2f 7465 7374 222c 2073 6d61  efix}/test", sma
-00025980: 6c6c 5f66 696c 652c 2065 6e63 6f64 696e  ll_file, encodin
-00025990: 673d 656e 636f 6469 6e67 290a 2020 2020  g=encoding).    
-000259a0: 2020 2020 7769 7468 2063 6c69 656e 742e      with client.
-000259b0: 7075 6c6c 2866 227b 7365 6c66 2e70 7265  pull(f"{self.pre
-000259c0: 6669 787d 2f74 6573 7422 2c20 656e 636f  fix}/test", enco
-000259d0: 6469 6e67 3d65 6e63 6f64 696e 6729 2061  ding=encoding) a
-000259e0: 7320 696e 6669 6c65 3a0a 2020 2020 2020  s infile:.      
-000259f0: 2020 2020 2020 7265 6365 6976 6564 5f64        received_d
-00025a00: 6174 6120 3d20 696e 6669 6c65 2e72 6561  ata = infile.rea
-00025a10: 6428 290a 2020 2020 2020 2020 7365 6c66  d().        self
-00025a20: 2e61 7373 6572 7445 7175 616c 286f 7269  .assertEqual(ori
-00025a30: 6769 6e61 6c5f 6461 7461 2c20 7265 6365  ginal_data, rece
-00025a40: 6976 6564 5f64 6174 6129 0a0a 2020 2020  ived_data)..    
-00025a50: 6465 6620 7465 7374 5f70 7573 685f 616e  def test_push_an
-00025a60: 645f 7075 6c6c 5f6c 6172 6765 725f 6669  d_pull_larger_fi
-00025a70: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
-00025a80: 2020 2320 496e 7465 6e74 3a20 746f 2065    # Intent: to e
-00025a90: 6e73 7572 6520 7468 696e 6773 2077 6f72  nsure things wor
-00025aa0: 6b20 6170 7072 6f70 7269 6174 656c 7920  k appropriately 
-00025ab0: 7769 7468 206c 6172 6765 7220 6669 6c65  with larger file
-00025ac0: 732e 0a20 2020 2020 2020 2023 204c 6172  s..        # Lar
-00025ad0: 6765 7220 6669 6c65 7320 6d61 7920 6265  ger files may be
-00025ae0: 2073 656e 742f 7265 6365 6976 6564 2069   sent/received i
-00025af0: 6e20 6d75 6c74 6970 6c65 2063 6875 6e6b  n multiple chunk
-00025b00: 733b 2074 6869 7320 7368 6f75 6c64 2068  s; this should h
-00025b10: 656c 7020 666f 720a 2020 2020 2020 2020  elp for.        
-00025b20: 2320 6368 6563 6b69 6e67 2074 6861 7420  # checking that 
-00025b30: 7375 6368 206c 6f67 6963 2069 7320 636f  such logic is co
-00025b40: 7272 6563 742e 0a20 2020 2020 2020 2064  rrect..        d
-00025b50: 6174 615f 7369 7a65 203d 2031 3032 3420  ata_size = 1024 
-00025b60: 2a20 3130 3234 0a20 2020 2020 2020 206f  * 1024.        o
-00025b70: 7269 6769 6e61 6c5f 6461 7461 203d 206f  riginal_data = o
-00025b80: 732e 7572 616e 646f 6d28 6461 7461 5f73  s.urandom(data_s
-00025b90: 697a 6529 0a0a 2020 2020 2020 2020 636c  ize)..        cl
-00025ba0: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
-00025bb0: 6e74 0a20 2020 2020 2020 2063 6c69 656e  nt.        clien
-00025bc0: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
-00025bd0: 7265 6669 787d 2f74 6573 7422 2c20 6f72  refix}/test", or
-00025be0: 6967 696e 616c 5f64 6174 612c 2065 6e63  iginal_data, enc
-00025bf0: 6f64 696e 673d 4e6f 6e65 290a 2020 2020  oding=None).    
-00025c00: 2020 2020 7769 7468 2063 6c69 656e 742e      with client.
-00025c10: 7075 6c6c 2866 227b 7365 6c66 2e70 7265  pull(f"{self.pre
-00025c20: 6669 787d 2f74 6573 7422 2c20 656e 636f  fix}/test", enco
-00025c30: 6469 6e67 3d4e 6f6e 6529 2061 7320 696e  ding=None) as in
-00025c40: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00025c50: 2020 7265 6365 6976 6564 5f64 6174 6120    received_data 
-00025c60: 3d20 696e 6669 6c65 2e72 6561 6428 290a  = infile.read().
-00025c70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00025c80: 6572 7445 7175 616c 286f 7269 6769 6e61  ertEqual(origina
-00025c90: 6c5f 6461 7461 2c20 7265 6365 6976 6564  l_data, received
-00025ca0: 5f64 6174 6129 0a0a 2020 2020 6465 6620  _data)..    def 
-00025cb0: 7465 7374 5f70 7573 685f 746f 5f6e 6f6e  test_push_to_non
-00025cc0: 5f65 7869 7374 656e 745f 7375 6264 6972  _existent_subdir
-00025cd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00025ce0: 6461 7461 203d 2027 6461 7461 270a 2020  data = 'data'.  
-00025cf0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
-00025d00: 656c 662e 636c 6965 6e74 0a0a 2020 2020  elf.client..    
-00025d10: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00025d20: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
-00025d30: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
-00025d40: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-00025d50: 636c 6965 6e74 2e70 7573 6828 6622 7b73  client.push(f"{s
-00025d60: 656c 662e 7072 6566 6978 7d2f 6e6f 6e65  elf.prefix}/none
-00025d70: 7869 7374 656e 745f 6469 722f 7465 7374  xistent_dir/test
-00025d80: 222c 2064 6174 612c 206d 616b 655f 6469  ", data, make_di
-00025d90: 7273 3d46 616c 7365 290a 2020 2020 2020  rs=False).      
-00025da0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00025db0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00025dc0: 6b69 6e64 2c20 276e 6f74 2d66 6f75 6e64  kind, 'not-found
-00025dd0: 2729 0a0a 2020 2020 2020 2020 636c 6965  ')..        clie
-00025de0: 6e74 2e70 7573 6828 6622 7b73 656c 662e  nt.push(f"{self.
-00025df0: 7072 6566 6978 7d2f 6e6f 6e65 7869 7374  prefix}/nonexist
-00025e00: 656e 745f 6469 722f 7465 7374 222c 2064  ent_dir/test", d
-00025e10: 6174 612c 206d 616b 655f 6469 7273 3d54  ata, make_dirs=T
-00025e20: 7275 6529 0a0a 2020 2020 6465 6620 7465  rue)..    def te
-00025e30: 7374 5f70 7573 685f 6173 5f63 6869 6c64  st_push_as_child
-00025e40: 5f6f 665f 6669 6c65 5f72 6169 7365 735f  _of_file_raises_
-00025e50: 6572 726f 7228 7365 6c66 293a 0a20 2020  error(self):.   
-00025e60: 2020 2020 2064 6174 6120 3d20 2764 6174       data = 'dat
-00025e70: 6127 0a20 2020 2020 2020 2063 6c69 656e  a'.        clien
-00025e80: 7420 3d20 7365 6c66 2e63 6c69 656e 740a  t = self.client.
-00025e90: 2020 2020 2020 2020 636c 6965 6e74 2e70          client.p
-00025ea0: 7573 6828 6622 7b73 656c 662e 7072 6566  ush(f"{self.pref
-00025eb0: 6978 7d2f 6669 6c65 222c 2064 6174 6129  ix}/file", data)
-00025ec0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00025ed0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00025ee0: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
-00025ef0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00025f00: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-00025f10: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-00025f20: 2f66 696c 652f 6669 6c65 222c 2064 6174  /file/file", dat
-00025f30: 6129 0a20 2020 2020 2020 2073 656c 662e  a).        self.
-00025f40: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
-00025f50: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
-00025f60: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
-00025f70: 6f72 2729 0a0a 2020 2020 6465 6620 7465  or')..    def te
-00025f80: 7374 5f70 7573 685f 7769 7468 5f70 6572  st_push_with_per
-00025f90: 6d69 7373 696f 6e5f 6d61 736b 2873 656c  mission_mask(sel
-00025fa0: 6629 3a0a 2020 2020 2020 2020 6461 7461  f):.        data
-00025fb0: 203d 2027 6461 7461 270a 2020 2020 2020   = 'data'.      
-00025fc0: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00025fd0: 636c 6965 6e74 0a20 2020 2020 2020 2063  client.        c
-00025fe0: 6c69 656e 742e 7075 7368 2866 227b 7365  lient.push(f"{se
-00025ff0: 6c66 2e70 7265 6669 787d 2f66 696c 6522  lf.prefix}/file"
-00026000: 2c20 6461 7461 2c20 7065 726d 6973 7369  , data, permissi
-00026010: 6f6e 733d 306f 3630 3029 0a20 2020 2020  ons=0o600).     
-00026020: 2020 2063 6c69 656e 742e 7075 7368 2866     client.push(f
-00026030: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-00026040: 696c 6522 2c20 6461 7461 2c20 7065 726d  ile", data, perm
-00026050: 6973 7369 6f6e 733d 306f 3737 3729 0a20  issions=0o777). 
-00026060: 2020 2020 2020 2023 2049 6620 7065 726d         # If perm
-00026070: 6973 7369 6f6e 7320 6172 6520 6f75 7473  issions are outs
-00026080: 6964 6520 6f66 2074 6865 2072 616e 6765  ide of the range
-00026090: 2030 6f30 3030 2074 6872 6f75 6768 2030   0o000 through 0
-000260a0: 6f37 3737 2c20 616e 2065 7863 6570 7469  o777, an excepti
-000260b0: 6f6e 2073 686f 756c 6420 6265 0a20 2020  on should be.   
-000260c0: 2020 2020 2023 2072 6169 7365 642e 0a20       # raised.. 
-000260d0: 2020 2020 2020 2066 6f72 2062 6164 5f70         for bad_p
-000260e0: 6572 6d69 7373 696f 6e20 696e 2028 0a20  ermission in (. 
-000260f0: 2020 2020 2020 2020 2020 2030 6f31 3030             0o100
-00026100: 302c 2020 2320 4578 6365 6564 7320 306f  0,  # Exceeds 0o
-00026110: 3737 370a 2020 2020 2020 2020 2020 2020  777.            
-00026120: 2d31 2c20 2020 2020 2023 204c 6573 7320  -1,      # Less 
-00026130: 7468 616e 2030 6f30 3030 0a20 2020 2020  than 0o000.     
-00026140: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00026150: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00026160: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
-00026170: 5061 7468 4572 726f 7229 2061 7320 636d  PathError) as cm
-00026180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026190: 2020 636c 6965 6e74 2e70 7573 6828 6622    client.push(f"
-000261a0: 7b73 656c 662e 7072 6566 6978 7d2f 6669  {self.prefix}/fi
-000261b0: 6c65 222c 2064 6174 612c 2070 6572 6d69  le", data, permi
-000261c0: 7373 696f 6e73 3d62 6164 5f70 6572 6d69  ssions=bad_permi
-000261d0: 7373 696f 6e29 0a20 2020 2020 2020 2073  ssion).        s
-000261e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000261f0: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
-00026200: 642c 2027 6765 6e65 7269 632d 6669 6c65  d, 'generic-file
-00026210: 2d65 7272 6f72 2729 0a0a 2020 2020 6465  -error')..    de
-00026220: 6620 7465 7374 5f70 7573 685f 6669 6c65  f test_push_file
-00026230: 735f 616e 645f 6c69 7374 2873 656c 6629  s_and_list(self)
-00026240: 3a0a 2020 2020 2020 2020 6461 7461 203d  :.        data =
-00026250: 2027 6461 7461 270a 2020 2020 2020 2020   'data'.        
-00026260: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
-00026270: 6965 6e74 0a0a 2020 2020 2020 2020 2320  ient..        # 
-00026280: 4c65 7427 7320 7075 7368 2074 6865 2066  Let's push the f
-00026290: 6972 7374 2066 696c 6520 7769 7468 2061  irst file with a
-000262a0: 2062 756e 6368 206f 6620 6465 7461 696c   bunch of detail
-000262b0: 732e 2020 5765 276c 6c20 6368 6563 6b20  s.  We'll check 
-000262c0: 6f6e 2074 6869 7320 6c61 7465 722e 0a20  on this later.. 
-000262d0: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
-000262e0: 7368 280a 2020 2020 2020 2020 2020 2020  sh(.            
-000262f0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00026300: 6669 6c65 3122 2c20 6461 7461 2c0a 2020  file1", data,.  
-00026310: 2020 2020 2020 2020 2020 7065 726d 6973            permis
-00026320: 7369 6f6e 733d 306f 3632 3029 0a0a 2020  sions=0o620)..  
-00026330: 2020 2020 2020 2320 446f 2061 2071 7569        # Do a qui
-00026340: 636b 2070 7573 6820 7769 7468 2064 6566  ck push with def
-00026350: 6175 6c74 7320 666f 7220 7468 6520 6f74  aults for the ot
-00026360: 6865 7220 6669 6c65 732e 0a20 2020 2020  her files..     
-00026370: 2020 2063 6c69 656e 742e 7075 7368 2866     client.push(f
-00026380: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-00026390: 696c 6532 222c 2064 6174 6129 0a20 2020  ile2", data).   
-000263a0: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-000263b0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-000263c0: 2f66 696c 6533 222c 2064 6174 6129 0a0a  /file3", data)..
-000263d0: 2020 2020 2020 2020 6669 6c65 7320 3d20          files = 
-000263e0: 636c 6965 6e74 2e6c 6973 745f 6669 6c65  client.list_file
-000263f0: 7328 6622 7b73 656c 662e 7072 6566 6978  s(f"{self.prefix
-00026400: 7d2f 2229 0a20 2020 2020 2020 2073 656c  }/").        sel
-00026410: 662e 6173 7365 7274 4571 7561 6c28 7b66  f.assertEqual({f
-00026420: 696c 652e 7061 7468 2066 6f72 2066 696c  ile.path for fil
-00026430: 6520 696e 2066 696c 6573 7d2c 0a20 2020  e in files},.   
-00026440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026450: 2020 2020 2020 7b73 656c 662e 7072 6566        {self.pref
-00026460: 6978 202b 2066 696c 6520 666f 7220 6669  ix + file for fi
-00026470: 6c65 2069 6e20 2827 2f66 696c 6531 272c  le in ('/file1',
-00026480: 2027 2f66 696c 6532 272c 2027 2f66 696c   '/file2', '/fil
-00026490: 6533 2729 7d29 0a0a 2020 2020 2020 2020  e3')})..        
-000264a0: 2320 4c65 7427 7320 7075 6c6c 2074 6865  # Let's pull the
-000264b0: 2066 6972 7374 2066 696c 6520 6167 6169   first file agai
-000264c0: 6e20 616e 6420 6368 6563 6b20 6974 7320  n and check its 
-000264d0: 6465 7461 696c 730a 2020 2020 2020 2020  details.        
-000264e0: 6669 6c65 203d 205b 6620 666f 7220 6620  file = [f for f 
-000264f0: 696e 2066 696c 6573 2069 6620 662e 7061  in files if f.pa
-00026500: 7468 203d 3d20 6622 7b73 656c 662e 7072  th == f"{self.pr
-00026510: 6566 6978 7d2f 6669 6c65 3122 5d5b 305d  efix}/file1"][0]
-00026520: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00026530: 7365 7274 4571 7561 6c28 6669 6c65 2e6e  sertEqual(file.n
-00026540: 616d 652c 2027 6669 6c65 3127 290a 2020  ame, 'file1').  
-00026550: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00026560: 7445 7175 616c 2866 696c 652e 7479 7065  tEqual(file.type
-00026570: 2c20 7065 6262 6c65 2e46 696c 6554 7970  , pebble.FileTyp
-00026580: 652e 4649 4c45 290a 2020 2020 2020 2020  e.FILE).        
-00026590: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000265a0: 2866 696c 652e 7369 7a65 2c20 3429 0a20  (file.size, 4). 
-000265b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000265c0: 7274 4973 496e 7374 616e 6365 2866 696c  rtIsInstance(fil
-000265d0: 652e 6c61 7374 5f6d 6f64 6966 6965 642c  e.last_modified,
-000265e0: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
-000265f0: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-00026600: 2e61 7373 6572 7445 7175 616c 2866 696c  .assertEqual(fil
-00026610: 652e 7065 726d 6973 7369 6f6e 732c 2030  e.permissions, 0
-00026620: 6f36 3230 290a 2020 2020 2020 2020 2320  o620).        # 
-00026630: 536b 6970 7069 6e67 206f 776e 6572 7368  Skipping ownersh
-00026640: 6970 2063 6865 636b 7320 6865 7265 3b20  ip checks here; 
-00026650: 6f77 6e65 7273 6869 7020 7769 6c6c 2062  ownership will b
-00026660: 6520 6368 6563 6b65 6420 696e 2070 7572  e checked in pur
-00026670: 656c 792d 6d6f 636b 6564 2074 6573 7473  ely-mocked tests
-00026680: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-00026690: 7573 685f 616e 645f 6c69 7374 5f66 696c  ush_and_list_fil
-000266a0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-000266b0: 2064 6174 6120 3d20 2764 6174 6127 0a20   data = 'data'. 
-000266c0: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-000266d0: 7365 6c66 2e63 6c69 656e 740a 2020 2020  self.client.    
-000266e0: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-000266f0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00026700: 6669 6c65 222c 2064 6174 6129 0a20 2020  file", data).   
-00026710: 2020 2020 2066 696c 6573 203d 2063 6c69       files = cli
-00026720: 656e 742e 6c69 7374 5f66 696c 6573 2866  ent.list_files(f
-00026730: 227b 7365 6c66 2e70 7265 6669 787d 2f22  "{self.prefix}/"
-00026740: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00026750: 7373 6572 7445 7175 616c 287b 6669 6c65  ssertEqual({file
-00026760: 2e70 6174 6820 666f 7220 6669 6c65 2069  .path for file i
-00026770: 6e20 6669 6c65 737d 2c20 7b66 227b 7365  n files}, {f"{se
-00026780: 6c66 2e70 7265 6669 787d 2f66 696c 6522  lf.prefix}/file"
-00026790: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-000267a0: 5f70 7573 685f 6669 6c65 5f77 6974 685f  _push_file_with_
-000267b0: 7265 6c61 7469 7665 5f70 6174 685f 6661  relative_path_fa
-000267c0: 696c 7328 7365 6c66 293a 0a20 2020 2020  ils(self):.     
-000267d0: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-000267e0: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
-000267f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00026800: 5261 6973 6573 2870 6562 626c 652e 5061  Raises(pebble.Pa
-00026810: 7468 4572 726f 7229 2061 7320 636d 3a0a  thError) as cm:.
-00026820: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-00026830: 6e74 2e70 7573 6828 2766 696c 6527 2c20  nt.push('file', 
-00026840: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-00026850: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-00026860: 6578 6365 7074 696f 6e2e 6b69 6e64 2c20  exception.kind, 
-00026870: 2767 656e 6572 6963 2d66 696c 652d 6572  'generic-file-er
-00026880: 726f 7227 290a 0a20 2020 2064 6566 2074  ror')..    def t
-00026890: 6573 745f 7075 6c6c 5f6e 6f74 5f66 6f75  est_pull_not_fou
-000268a0: 6e64 2873 656c 6629 3a0a 2020 2020 2020  nd(self):.      
-000268b0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000268c0: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
-000268d0: 5061 7468 4572 726f 7229 2061 7320 636d  PathError) as cm
-000268e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000268f0: 6c66 2e63 6c69 656e 742e 7075 6c6c 2822  lf.client.pull("
-00026900: 2f6e 6f74 2f66 6f75 6e64 2229 0a20 2020  /not/found").   
-00026910: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00026920: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
-00026930: 6f6e 2e6b 696e 642c 2022 6e6f 742d 666f  on.kind, "not-fo
-00026940: 756e 6422 290a 2020 2020 2020 2020 7365  und").        se
-00026950: 6c66 2e61 7373 6572 7449 6e28 222f 6e6f  lf.assertIn("/no
-00026960: 742f 666f 756e 6422 2c20 636d 2e65 7863  t/found", cm.exc
-00026970: 6570 7469 6f6e 2e6d 6573 7361 6765 290a  eption.message).
-00026980: 0a20 2020 2064 6566 2074 6573 745f 7075  .    def test_pu
-00026990: 6c6c 5f64 6972 6563 746f 7279 2873 656c  ll_directory(sel
-000269a0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000269b0: 2e63 6c69 656e 742e 6d61 6b65 5f64 6972  .client.make_dir
-000269c0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-000269d0: 2f73 7562 6469 7222 290a 2020 2020 2020  /subdir").      
-000269e0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000269f0: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
-00026a00: 5061 7468 4572 726f 7229 2061 7320 636d  PathError) as cm
-00026a10: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00026a20: 6c66 2e63 6c69 656e 742e 7075 6c6c 2866  lf.client.pull(f
-00026a30: 227b 7365 6c66 2e70 7265 6669 787d 2f73  "{self.prefix}/s
-00026a40: 7562 6469 7222 290a 2020 2020 2020 2020  ubdir").        
-00026a50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00026a60: 2863 6d2e 6578 6365 7074 696f 6e2e 6b69  (cm.exception.ki
-00026a70: 6e64 2c20 2267 656e 6572 6963 2d66 696c  nd, "generic-fil
-00026a80: 652d 6572 726f 7222 290a 2020 2020 2020  e-error").      
-00026a90: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
-00026aa0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00026ab0: 7375 6264 6972 222c 2063 6d2e 6578 6365  subdir", cm.exce
-00026ac0: 7074 696f 6e2e 6d65 7373 6167 6529 0a0a  ption.message)..
-00026ad0: 2020 2020 6465 6620 7465 7374 5f6c 6973      def test_lis
-00026ae0: 745f 6669 6c65 735f 6e6f 745f 666f 756e  t_files_not_foun
-00026af0: 645f 7261 6973 6573 2873 656c 6629 3a0a  d_raises(self):.
-00026b00: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00026b10: 2073 656c 662e 636c 6965 6e74 0a20 2020   self.client.   
-00026b20: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00026b30: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-00026b40: 6c65 2e41 5049 4572 726f 7229 2061 7320  le.APIError) as 
-00026b50: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-00026b60: 636c 6965 6e74 2e6c 6973 745f 6669 6c65  client.list_file
-00026b70: 7328 222f 6e6f 742f 6578 6973 7469 6e67  s("/not/existing
-00026b80: 2f66 696c 652f 2229 0a20 2020 2020 2020  /file/").       
-00026b90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00026ba0: 6c28 636d 2e65 7863 6570 7469 6f6e 2e63  l(cm.exception.c
-00026bb0: 6f64 652c 2034 3034 290a 2020 2020 2020  ode, 404).      
-00026bc0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00026bd0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00026be0: 7374 6174 7573 2c20 274e 6f74 2046 6f75  status, 'Not Fou
-00026bf0: 6e64 2729 0a20 2020 2020 2020 2073 656c  nd').        sel
-00026c00: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-00026c10: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
-00026c20: 6765 2c20 2773 7461 7420 2f6e 6f74 2f65  ge, 'stat /not/e
-00026c30: 7869 7374 696e 672f 6669 6c65 2f3a 206e  xisting/file/: n
-00026c40: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
-00026c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c70: 2020 2027 7375 6368 2066 696c 6520 6f72     'such file or
-00026c80: 2064 6972 6563 746f 7279 2729 0a0a 2020   directory')..  
-00026c90: 2020 6465 6620 7465 7374 5f6c 6973 745f    def test_list_
-00026ca0: 6469 7265 6374 6f72 795f 6f62 6a65 6374  directory_object
-00026cb0: 5f69 7473 656c 6628 7365 6c66 293a 0a20  _itself(self):. 
-00026cc0: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00026cd0: 7365 6c66 2e63 6c69 656e 740a 0a20 2020  self.client..   
-00026ce0: 2020 2020 2023 2054 6573 7420 7769 7468       # Test with
-00026cf0: 2072 6f6f 7420 6469 720a 2020 2020 2020   root dir.      
-00026d00: 2020 2320 2853 7065 6369 616c 2063 6173    # (Special cas
-00026d10: 653b 2077 6520 776f 6e27 7420 7072 6566  e; we won't pref
-00026d20: 6978 2074 6869 732c 2065 7665 6e20 7768  ix this, even wh
-00026d30: 656e 2075 7369 6e67 2074 6865 2072 6561  en using the rea
-00026d40: 6c20 5065 6262 6c65 2073 6572 7665 722e  l Pebble server.
-00026d50: 290a 2020 2020 2020 2020 6669 6c65 7320  ).        files 
-00026d60: 3d20 636c 6965 6e74 2e6c 6973 745f 6669  = client.list_fi
-00026d70: 6c65 7328 272f 272c 2069 7473 656c 663d  les('/', itself=
-00026d80: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-00026d90: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-00026da0: 656e 2866 696c 6573 292c 2031 290a 2020  en(files), 1).  
-00026db0: 2020 2020 2020 6469 725f 203d 2066 696c        dir_ = fil
-00026dc0: 6573 5b30 5d0a 2020 2020 2020 2020 7365  es[0].        se
-00026dd0: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
-00026de0: 6972 5f2e 7061 7468 2c20 272f 2729 0a20  ir_.path, '/'). 
-00026df0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00026e00: 7274 4571 7561 6c28 6469 725f 2e6e 616d  rtEqual(dir_.nam
-00026e10: 652c 2027 2f27 290a 2020 2020 2020 2020  e, '/').        
-00026e20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00026e30: 2864 6972 5f2e 7479 7065 2c20 7065 6262  (dir_.type, pebb
-00026e40: 6c65 2e46 696c 6554 7970 652e 4449 5245  le.FileType.DIRE
-00026e50: 4354 4f52 5929 0a0a 2020 2020 2020 2020  CTORY)..        
-00026e60: 2320 5465 7374 2077 6974 6820 7375 6264  # Test with subd
-00026e70: 6972 730a 2020 2020 2020 2020 636c 6965  irs.        clie
-00026e80: 6e74 2e6d 616b 655f 6469 7228 6622 7b73  nt.make_dir(f"{s
-00026e90: 656c 662e 7072 6566 6978 7d2f 7375 6264  elf.prefix}/subd
-00026ea0: 6972 2229 0a20 2020 2020 2020 2066 696c  ir").        fil
-00026eb0: 6573 203d 2063 6c69 656e 742e 6c69 7374  es = client.list
-00026ec0: 5f66 696c 6573 2866 227b 7365 6c66 2e70  _files(f"{self.p
-00026ed0: 7265 6669 787d 2f73 7562 6469 7222 2c20  refix}/subdir", 
-00026ee0: 6974 7365 6c66 3d54 7275 6529 0a20 2020  itself=True).   
-00026ef0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00026f00: 4571 7561 6c28 6c65 6e28 6669 6c65 7329  Equal(len(files)
-00026f10: 2c20 3129 0a20 2020 2020 2020 2064 6972  , 1).        dir
-00026f20: 5f20 3d20 6669 6c65 735b 305d 0a20 2020  _ = files[0].   
-00026f30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00026f40: 4571 7561 6c28 6469 725f 2e6e 616d 652c  Equal(dir_.name,
-00026f50: 2027 7375 6264 6972 2729 0a20 2020 2020   'subdir').     
-00026f60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00026f70: 7561 6c28 6469 725f 2e74 7970 652c 2070  ual(dir_.type, p
-00026f80: 6562 626c 652e 4669 6c65 5479 7065 2e44  ebble.FileType.D
-00026f90: 4952 4543 544f 5259 290a 0a20 2020 2064  IRECTORY)..    d
-00026fa0: 6566 2074 6573 745f 7075 7368 5f66 696c  ef test_push_fil
-00026fb0: 6573 5f61 6e64 5f6c 6973 745f 6279 5f70  es_and_list_by_p
-00026fc0: 6174 7465 726e 2873 656c 6629 3a0a 2020  attern(self):.  
-00026fd0: 2020 2020 2020 2320 4e6f 7465 3a20 676c        # Note: gl
-00026fe0: 6f62 2070 6174 7465 726e 2064 656c 7461  ob pattern delta
-00026ff0: 7320 646f 2065 7869 7374 2062 6574 7765  s do exist betwe
-00027000: 656e 2067 6f6c 616e 6720 616e 6420 5079  en golang and Py
-00027010: 7468 6f6e 2c20 6275 7420 6865 7265 2c0a  thon, but here,.
-00027020: 2020 2020 2020 2020 2320 7765 276c 6c20          # we'll 
-00027030: 6a75 7374 2075 7365 2061 2073 696d 706c  just use a simpl
-00027040: 6520 2a20 7061 7474 6572 6e2e 0a20 2020  e * pattern..   
-00027050: 2020 2020 2064 6174 6120 3d20 2764 6174       data = 'dat
-00027060: 6127 0a20 2020 2020 2020 2063 6c69 656e  a'.        clien
-00027070: 7420 3d20 7365 6c66 2e63 6c69 656e 740a  t = self.client.
-00027080: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
-00027090: 6e61 6d65 2069 6e20 280a 2020 2020 2020  name in (.      
-000270a0: 2020 2020 2020 272f 6669 6c65 312e 677a        '/file1.gz
-000270b0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000270c0: 2f66 696c 6532 2e74 6172 2e67 7a27 2c0a  /file2.tar.gz',.
-000270d0: 2020 2020 2020 2020 2020 2020 272f 6669              '/fi
-000270e0: 6c65 332e 7461 722e 627a 3227 2c0a 2020  le3.tar.bz2',.  
-000270f0: 2020 2020 2020 2020 2020 272f 6261 636b            '/back
-00027100: 7570 5f66 696c 652e 677a 272c 0a20 2020  up_file.gz',.   
-00027110: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00027120: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-00027130: 7365 6c66 2e70 7265 6669 7820 2b20 6669  self.prefix + fi
-00027140: 6c65 6e61 6d65 2c20 6461 7461 290a 2020  lename, data).  
-00027150: 2020 2020 2020 6669 6c65 7320 3d20 636c        files = cl
-00027160: 6965 6e74 2e6c 6973 745f 6669 6c65 7328  ient.list_files(
-00027170: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00027180: 222c 2070 6174 7465 726e 3d27 6669 6c65  ", pattern='file
-00027190: 2a2e 677a 2729 0a20 2020 2020 2020 2073  *.gz').        s
-000271a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000271b0: 7b66 696c 652e 7061 7468 2066 6f72 2066  {file.path for f
-000271c0: 696c 6520 696e 2066 696c 6573 7d2c 0a20  ile in files},. 
-000271d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271e0: 2020 2020 2020 2020 7b73 656c 662e 7072          {self.pr
-000271f0: 6566 6978 202b 2066 696c 6520 666f 7220  efix + file for 
-00027200: 6669 6c65 2069 6e20 2827 2f66 696c 6531  file in ('/file1
-00027210: 2e67 7a27 2c20 272f 6669 6c65 322e 7461  .gz', '/file2.ta
-00027220: 722e 677a 2729 7d29 0a0a 2020 2020 6465  r.gz')})..    de
-00027230: 6620 7465 7374 5f6d 616b 655f 6469 7265  f test_make_dire
-00027240: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
+00022b40: 2020 2027 2727 2c20 636f 6d62 696e 653d     ''', combine=
+00022b50: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
+00022b60: 6573 745f 6164 645f 6c61 7965 725f 636f  est_add_layer_co
+00022b70: 6d62 696e 655f 6f76 6572 7269 6465 5f72  mbine_override_r
+00022b80: 6570 6c61 6365 2873 656c 6629 3a0a 2020  eplace(self):.  
+00022b90: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00022ba0: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
+00022bb0: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
+00022bc0: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+00022bd0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
+00022be0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00022bf0: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
+00022c00: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
+00022c10: 2020 2020 2020 2020 2020 2062 6172 3a0a             bar:.
+00022c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c30: 7375 6d6d 6172 793a 2042 6172 0a20 2020  summary: Bar.   
+00022c40: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00022c50: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00022c60: 2062 6172 270a 2020 2020 2020 2020 2020   bar'.          
+00022c70: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+00022c80: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+00022c90: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
+00022ca0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+00022cb0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
+00022cc0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00022cd0: 2020 2020 2020 2020 636c 6965 6e74 2e61          client.a
+00022ce0: 6464 5f6c 6179 6572 2827 666f 6f27 2c20  dd_layer('foo', 
+00022cf0: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+00022d00: 2073 756d 6d61 7279 3a20 666f 6f0a 2020   summary: foo.  
+00022d10: 2020 2020 2020 2020 2020 7365 7276 6963            servic
+00022d20: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00022d30: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
+00022d40: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+00022d50: 272f 6269 6e2f 6563 686f 2066 6f6f 206e  '/bin/echo foo n
+00022d60: 6577 270a 2020 2020 2020 2020 2020 2020  ew'.            
+00022d70: 2020 2020 6f76 6572 7269 6465 3a20 7265      override: re
+00022d80: 706c 6163 650a 2020 2020 2020 2020 2020  place.          
+00022d90: 2020 2727 272c 2063 6f6d 6269 6e65 3d54    ''', combine=T
+00022da0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00022db0: 662e 6173 7365 7274 4571 7561 6c28 7465  f.assertEqual(te
+00022dc0: 7874 7772 6170 2e64 6564 656e 7428 2727  xtwrap.dedent(''
+00022dd0: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
+00022de0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+00022df0: 2020 2020 2020 2062 6172 3a0a 2020 2020         bar:.    
+00022e00: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00022e10: 616e 643a 202f 6269 6e2f 6563 686f 2062  and: /bin/echo b
+00022e20: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
+00022e30: 2020 2073 756d 6d61 7279 3a20 4261 720a     summary: Bar.
+00022e40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00022e50: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
+00022e60: 2020 2063 6f6d 6d61 6e64 3a20 2f62 696e     command: /bin
+00022e70: 2f65 6368 6f20 666f 6f20 6e65 770a 2020  /echo foo new.  
+00022e80: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
+00022e90: 6572 7269 6465 3a20 7265 706c 6163 650a  erride: replace.
+00022ea0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00022eb0: 2c20 636c 6965 6e74 2e67 6574 5f70 6c61  , client.get_pla
+00022ec0: 6e28 292e 746f 5f79 616d 6c28 2929 0a0a  n().to_yaml())..
+00022ed0: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+00022ee0: 5f6c 6179 6572 5f63 6f6d 6269 6e65 5f6f  _layer_combine_o
+00022ef0: 7665 7272 6964 655f 6d65 7267 6528 7365  verride_merge(se
+00022f00: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+00022f10: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
+00022f20: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
+00022f30: 2020 2020 2020 2020 636c 6965 6e74 2e61          client.a
+00022f40: 6464 5f6c 6179 6572 2827 666f 6f27 2c20  dd_layer('foo', 
+00022f50: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+00022f60: 2073 756d 6d61 7279 3a20 666f 6f0a 2020   summary: foo.  
+00022f70: 2020 2020 2020 2020 2020 7365 7276 6963            servic
+00022f80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00022f90: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
+00022fa0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00022fb0: 4261 720a 2020 2020 2020 2020 2020 2020  Bar.            
+00022fc0: 2020 2020 636f 6d6d 616e 643a 2027 2f62      command: '/b
+00022fd0: 696e 2f65 6368 6f20 6261 7227 0a20 2020  in/echo bar'.   
+00022fe0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+00022ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023000: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+00023010: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00023020: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00023030: 2066 6f6f 270a 2020 2020 2020 2020 2020   foo'.          
+00023040: 2020 2727 2729 0a20 2020 2020 2020 2063    ''').        c
+00023050: 6c69 656e 742e 6164 645f 6c61 7965 7228  lient.add_layer(
+00023060: 2766 6f6f 272c 2027 2727 5c0a 2020 2020  'foo', '''\.    
+00023070: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00023080: 2066 6f6f 0a20 2020 2020 2020 2020 2020   foo.           
+00023090: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
+000230a0: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
+000230b0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+000230c0: 6d6d 6172 793a 2046 6f6f 0a20 2020 2020  mmary: Foo.     
+000230d0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+000230e0: 6e64 3a20 272f 6269 6e2f 6563 686f 2066  nd: '/bin/echo f
+000230f0: 6f6f 6227 0a20 2020 2020 2020 2020 2020  oob'.           
+00023100: 2020 2020 206f 7665 7272 6964 653a 206d       override: m
+00023110: 6572 6765 0a20 2020 2020 2020 2020 2020  erge.           
+00023120: 2027 2727 2c20 636f 6d62 696e 653d 5472   ''', combine=Tr
+00023130: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
+00023140: 2e61 7373 6572 7445 7175 616c 2874 6578  .assertEqual(tex
+00023150: 7477 7261 702e 6465 6465 6e74 2827 2727  twrap.dedent('''
+00023160: 5c0a 2020 2020 2020 2020 2020 2020 7365  \.            se
+00023170: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00023180: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00023190: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+000231a0: 6e64 3a20 2f62 696e 2f65 6368 6f20 6261  nd: /bin/echo ba
+000231b0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+000231c0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
+000231d0: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
+000231e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000231f0: 2020 636f 6d6d 616e 643a 202f 6269 6e2f    command: /bin/
+00023200: 6563 686f 2066 6f6f 620a 2020 2020 2020  echo foob.      
+00023210: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
+00023220: 6465 3a20 6d65 7267 650a 2020 2020 2020  de: merge.      
+00023230: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00023240: 793a 2046 6f6f 0a20 2020 2020 2020 2020  y: Foo.         
+00023250: 2020 2027 2727 292c 2063 6c69 656e 742e     '''), client.
+00023260: 6765 745f 706c 616e 2829 2e74 6f5f 7961  get_plan().to_ya
+00023270: 6d6c 2829 290a 0a20 2020 2064 6566 2074  ml())..    def t
+00023280: 6573 745f 6164 645f 6c61 7965 725f 636f  est_add_layer_co
+00023290: 6d62 696e 655f 6f76 6572 7269 6465 5f75  mbine_override_u
+000232a0: 6e6b 6e6f 776e 2873 656c 6629 3a0a 2020  nknown(self):.  
+000232b0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+000232c0: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
+000232d0: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
+000232e0: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+000232f0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
+00023300: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00023310: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
+00023320: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
+00023330: 2020 2020 2020 2020 2020 2062 6172 3a0a             bar:.
+00023340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023350: 7375 6d6d 6172 793a 2042 6172 0a20 2020  summary: Bar.   
+00023360: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00023370: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00023380: 2062 6172 270a 2020 2020 2020 2020 2020   bar'.          
+00023390: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+000233a0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+000233b0: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
+000233c0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+000233d0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
+000233e0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+000233f0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00023400: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+00023410: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+00023420: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00023430: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
+00023440: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
+00023450: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00023460: 666f 6f0a 2020 2020 2020 2020 2020 2020  foo.            
+00023470: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+00023480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023490: 666f 6f3a 0a20 2020 2020 2020 2020 2020  foo:.           
+000234a0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+000234b0: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
+000234c0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+000234d0: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
+000234e0: 6f62 270a 2020 2020 2020 2020 2020 2020  ob'.            
+000234f0: 2020 2020 2020 2020 6f76 6572 7269 6465          override
+00023500: 3a20 626c 6168 0a20 2020 2020 2020 2020  : blah.         
+00023510: 2020 2020 2020 2027 2727 2c20 636f 6d62         ''', comb
+00023520: 696e 653d 5472 7565 290a 0a20 2020 2064  ine=True)..    d
+00023530: 6566 2074 6573 745f 6765 745f 7365 7276  ef test_get_serv
+00023540: 6963 6573 5f6e 6f6e 6528 7365 6c66 293a  ices_none(self):
+00023550: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
+00023560: 3d20 7365 6c66 2e67 6574 5f74 6573 7469  = self.get_testi
+00023570: 6e67 5f63 6c69 656e 7428 290a 2020 2020  ng_client().    
+00023580: 2020 2020 7365 7276 6963 655f 696e 666f      service_info
+00023590: 203d 2063 6c69 656e 742e 6765 745f 7365   = client.get_se
+000235a0: 7276 6963 6573 2829 0a20 2020 2020 2020  rvices().       
+000235b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000235c0: 6c28 5b5d 2c20 7365 7276 6963 655f 696e  l([], service_in
+000235d0: 666f 290a 0a20 2020 2064 6566 2074 6573  fo)..    def tes
+000235e0: 745f 6765 745f 7365 7276 6963 6573 5f6e  t_get_services_n
+000235f0: 6f74 5f73 7461 7274 6564 2873 656c 6629  ot_started(self)
+00023600: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
+00023610: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
+00023620: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
+00023630: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
+00023640: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
+00023650: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
+00023660: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
+00023670: 2020 2020 2020 2073 6572 7669 6365 733a         services:
+00023680: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
+00023690: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
+000236a0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+000236b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000236c0: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
+000236d0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000236e0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
+000236f0: 2f65 6368 6f20 666f 6f27 0a20 2020 2020  /echo foo'.     
+00023700: 2020 2020 2020 2020 2062 6172 3a0a 2020           bar:.  
+00023710: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00023720: 6d6d 6172 793a 2042 6172 0a20 2020 2020  mmary: Bar.     
+00023730: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00023740: 6e64 3a20 272f 6269 6e2f 6563 686f 2062  nd: '/bin/echo b
+00023750: 6172 270a 2020 2020 2020 2020 2020 2020  ar'.            
+00023760: 2727 2729 0a20 2020 2020 2020 2069 6e66  ''').        inf
+00023770: 6f73 203d 2063 6c69 656e 742e 6765 745f  os = client.get_
+00023780: 7365 7276 6963 6573 2829 0a20 2020 2020  services().     
+00023790: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000237a0: 7561 6c28 6c65 6e28 696e 666f 7329 2c20  ual(len(infos), 
+000237b0: 3229 0a20 2020 2020 2020 2062 6172 5f69  2).        bar_i
+000237c0: 6e66 6f20 3d20 696e 666f 735b 305d 0a20  nfo = infos[0]. 
+000237d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000237e0: 7274 4571 7561 6c28 2762 6172 272c 2062  rtEqual('bar', b
+000237f0: 6172 5f69 6e66 6f2e 6e61 6d65 290a 2020  ar_info.name).  
+00023800: 2020 2020 2020 2320 4465 6661 756c 7420        # Default 
+00023810: 7768 656e 206e 6f74 2073 7065 6369 6669  when not specifi
+00023820: 6564 2069 7320 4449 5341 424c 4544 0a20  ed is DISABLED. 
+00023830: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00023840: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
+00023850: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
+00023860: 5341 424c 4544 2c20 6261 725f 696e 666f  SABLED, bar_info
+00023870: 2e73 7461 7274 7570 290a 2020 2020 2020  .startup).      
+00023880: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00023890: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+000238a0: 6553 7461 7475 732e 494e 4143 5449 5645  eStatus.INACTIVE
+000238b0: 2c20 6261 725f 696e 666f 2e63 7572 7265  , bar_info.curre
+000238c0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
+000238d0: 2e61 7373 6572 7446 616c 7365 2862 6172  .assertFalse(bar
+000238e0: 5f69 6e66 6f2e 6973 5f72 756e 6e69 6e67  _info.is_running
+000238f0: 2829 290a 2020 2020 2020 2020 666f 6f5f  ()).        foo_
+00023900: 696e 666f 203d 2069 6e66 6f73 5b31 5d0a  info = infos[1].
+00023910: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00023920: 6572 7445 7175 616c 2827 666f 6f27 2c20  ertEqual('foo', 
+00023930: 666f 6f5f 696e 666f 2e6e 616d 6529 0a20  foo_info.name). 
+00023940: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00023950: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
+00023960: 6572 7669 6365 5374 6172 7475 702e 454e  erviceStartup.EN
+00023970: 4142 4c45 442c 2066 6f6f 5f69 6e66 6f2e  ABLED, foo_info.
+00023980: 7374 6172 7475 7029 0a20 2020 2020 2020  startup).       
+00023990: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000239a0: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
+000239b0: 5374 6174 7573 2e49 4e41 4354 4956 452c  Status.INACTIVE,
+000239c0: 2066 6f6f 5f69 6e66 6f2e 6375 7272 656e   foo_info.curren
+000239d0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+000239e0: 6173 7365 7274 4661 6c73 6528 666f 6f5f  assertFalse(foo_
+000239f0: 696e 666f 2e69 735f 7275 6e6e 696e 6728  info.is_running(
+00023a00: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+00023a10: 5f67 6574 5f73 6572 7669 6365 735f 6175  _get_services_au
+00023a20: 746f 7374 6172 7428 7365 6c66 293a 0a20  tostart(self):. 
+00023a30: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+00023a40: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
+00023a50: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
+00023a60: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
+00023a70: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
+00023a80: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00023a90: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
+00023aa0: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+00023ab0: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+00023ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ad0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
+00023ae0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00023af0: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
+00023b00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00023b10: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
+00023b20: 686f 2066 6f6f 270a 2020 2020 2020 2020  ho foo'.        
+00023b30: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00023b40: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00023b50: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
+00023b60: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00023b70: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
+00023b80: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00023b90: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
+00023ba0: 2e61 7574 6f73 7461 7274 5f73 6572 7669  .autostart_servi
+00023bb0: 6365 7328 290a 2020 2020 2020 2020 696e  ces().        in
+00023bc0: 666f 7320 3d20 636c 6965 6e74 2e67 6574  fos = client.get
+00023bd0: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
+00023be0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00023bf0: 7175 616c 286c 656e 2869 6e66 6f73 292c  qual(len(infos),
+00023c00: 2032 290a 2020 2020 2020 2020 6261 725f   2).        bar_
+00023c10: 696e 666f 203d 2069 6e66 6f73 5b30 5d0a  info = infos[0].
+00023c20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00023c30: 6572 7445 7175 616c 2827 6261 7227 2c20  ertEqual('bar', 
+00023c40: 6261 725f 696e 666f 2e6e 616d 6529 0a20  bar_info.name). 
+00023c50: 2020 2020 2020 2023 2044 6566 6175 6c74         # Default
+00023c60: 2077 6865 6e20 6e6f 7420 7370 6563 6966   when not specif
+00023c70: 6965 6420 6973 2044 4953 4142 4c45 440a  ied is DISABLED.
+00023c80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00023c90: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00023ca0: 5365 7276 6963 6553 7461 7274 7570 2e44  ServiceStartup.D
+00023cb0: 4953 4142 4c45 442c 2062 6172 5f69 6e66  ISABLED, bar_inf
+00023cc0: 6f2e 7374 6172 7475 7029 0a20 2020 2020  o.startup).     
+00023cd0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00023ce0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00023cf0: 6365 5374 6174 7573 2e49 4e41 4354 4956  ceStatus.INACTIV
+00023d00: 452c 2062 6172 5f69 6e66 6f2e 6375 7272  E, bar_info.curr
+00023d10: 656e 7429 0a20 2020 2020 2020 2073 656c  ent).        sel
+00023d20: 662e 6173 7365 7274 4661 6c73 6528 6261  f.assertFalse(ba
+00023d30: 725f 696e 666f 2e69 735f 7275 6e6e 696e  r_info.is_runnin
+00023d40: 6728 2929 0a20 2020 2020 2020 2066 6f6f  g()).        foo
+00023d50: 5f69 6e66 6f20 3d20 696e 666f 735b 315d  _info = infos[1]
+00023d60: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00023d70: 7365 7274 4571 7561 6c28 2766 6f6f 272c  sertEqual('foo',
+00023d80: 2066 6f6f 5f69 6e66 6f2e 6e61 6d65 290a   foo_info.name).
+00023d90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00023da0: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00023db0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
+00023dc0: 4e41 424c 4544 2c20 666f 6f5f 696e 666f  NABLED, foo_info
+00023dd0: 2e73 7461 7274 7570 290a 2020 2020 2020  .startup).      
+00023de0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00023df0: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+00023e00: 6553 7461 7475 732e 4143 5449 5645 2c20  eStatus.ACTIVE, 
+00023e10: 666f 6f5f 696e 666f 2e63 7572 7265 6e74  foo_info.current
+00023e20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00023e30: 7373 6572 7454 7275 6528 666f 6f5f 696e  ssertTrue(foo_in
+00023e40: 666f 2e69 735f 7275 6e6e 696e 6728 2929  fo.is_running())
+00023e50: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+00023e60: 6574 5f73 6572 7669 6365 735f 7374 6172  et_services_star
+00023e70: 745f 7374 6f70 2873 656c 6629 3a0a 2020  t_stop(self):.  
+00023e80: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00023e90: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
+00023ea0: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
+00023eb0: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+00023ec0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
+00023ed0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00023ee0: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
+00023ef0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
+00023f00: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+00023f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f20: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+00023f30: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00023f40: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
+00023f50: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00023f60: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
+00023f70: 6f20 666f 6f27 0a20 2020 2020 2020 2020  o foo'.         
+00023f80: 2020 2020 2062 6172 3a0a 2020 2020 2020       bar:.      
+00023f90: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00023fa0: 793a 2042 6172 0a20 2020 2020 2020 2020  y: Bar.         
+00023fb0: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+00023fc0: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
+00023fd0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00023fe0: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00023ff0: 7374 6172 745f 7365 7276 6963 6573 285b  start_services([
+00024000: 2762 6172 275d 290a 2020 2020 2020 2020  'bar']).        
+00024010: 696e 666f 7320 3d20 636c 6965 6e74 2e67  infos = client.g
+00024020: 6574 5f73 6572 7669 6365 7328 290a 2020  et_services().  
+00024030: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00024040: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
+00024050: 292c 2032 290a 2020 2020 2020 2020 6261  ), 2).        ba
+00024060: 725f 696e 666f 203d 2069 6e66 6f73 5b30  r_info = infos[0
+00024070: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00024080: 7373 6572 7445 7175 616c 2827 6261 7227  ssertEqual('bar'
+00024090: 2c20 6261 725f 696e 666f 2e6e 616d 6529  , bar_info.name)
+000240a0: 0a20 2020 2020 2020 2023 2045 7665 6e20  .        # Even 
+000240b0: 7468 6f75 6768 2062 6172 2064 6566 6175  though bar defau
+000240c0: 6c74 7320 746f 2044 4953 4142 4c45 442c  lts to DISABLED,
+000240d0: 2077 6520 6578 706c 6963 6974 6c79 2073   we explicitly s
+000240e0: 7461 7274 6564 2069 740a 2020 2020 2020  tarted it.      
+000240f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00024100: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+00024110: 6553 7461 7274 7570 2e44 4953 4142 4c45  eStartup.DISABLE
+00024120: 442c 2062 6172 5f69 6e66 6f2e 7374 6172  D, bar_info.star
+00024130: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
+00024140: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00024150: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+00024160: 7573 2e41 4354 4956 452c 2062 6172 5f69  us.ACTIVE, bar_i
+00024170: 6e66 6f2e 6375 7272 656e 7429 0a20 2020  nfo.current).   
+00024180: 2020 2020 2023 2066 6f6f 2077 6f75 6c64       # foo would
+00024190: 2062 6520 7374 6172 7465 6420 6279 2061   be started by a
+000241a0: 7574 6f73 7461 7274 2c20 6275 7420 7765  utostart, but we
+000241b0: 206f 6e6c 7920 6361 6c6c 6564 2073 7461   only called sta
+000241c0: 7274 5f73 6572 7669 6365 730a 2020 2020  rt_services.    
+000241d0: 2020 2020 666f 6f5f 696e 666f 203d 2069      foo_info = i
+000241e0: 6e66 6f73 5b31 5d0a 2020 2020 2020 2020  nfos[1].        
+000241f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00024200: 2827 666f 6f27 2c20 666f 6f5f 696e 666f  ('foo', foo_info
+00024210: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
+00024220: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00024230: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+00024240: 6172 7475 702e 454e 4142 4c45 442c 2066  artup.ENABLED, f
+00024250: 6f6f 5f69 6e66 6f2e 7374 6172 7475 7029  oo_info.startup)
+00024260: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00024270: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
+00024280: 2e53 6572 7669 6365 5374 6174 7573 2e49  .ServiceStatus.I
+00024290: 4e41 4354 4956 452c 2066 6f6f 5f69 6e66  NACTIVE, foo_inf
+000242a0: 6f2e 6375 7272 656e 7429 0a20 2020 2020  o.current).     
+000242b0: 2020 2063 6c69 656e 742e 7374 6f70 5f73     client.stop_s
+000242c0: 6572 7669 6365 7328 5b27 6261 7227 5d29  ervices(['bar'])
+000242d0: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
+000242e0: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
+000242f0: 6963 6573 2829 0a20 2020 2020 2020 2062  ices().        b
+00024300: 6172 5f69 6e66 6f20 3d20 696e 666f 735b  ar_info = infos[
+00024310: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+00024320: 6173 7365 7274 4571 7561 6c28 2762 6172  assertEqual('bar
+00024330: 272c 2062 6172 5f69 6e66 6f2e 6e61 6d65  ', bar_info.name
+00024340: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00024350: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+00024360: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+00024370: 2e44 4953 4142 4c45 442c 2062 6172 5f69  .DISABLED, bar_i
+00024380: 6e66 6f2e 7374 6172 7475 7029 0a20 2020  nfo.startup).   
+00024390: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000243a0: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
+000243b0: 7669 6365 5374 6174 7573 2e49 4e41 4354  viceStatus.INACT
+000243c0: 4956 452c 2062 6172 5f69 6e66 6f2e 6375  IVE, bar_info.cu
+000243d0: 7272 656e 7429 0a0a 2020 2020 6465 6620  rrent)..    def 
+000243e0: 7465 7374 5f67 6574 5f73 6572 7669 6365  test_get_service
+000243f0: 735f 6261 645f 7265 7175 6573 7428 7365  s_bad_request(se
+00024400: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+00024410: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
+00024420: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
+00024430: 2020 2020 2020 2020 636c 6965 6e74 2e61          client.a
+00024440: 6464 5f6c 6179 6572 2827 666f 6f27 2c20  dd_layer('foo', 
+00024450: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+00024460: 2073 756d 6d61 7279 3a20 666f 6f0a 2020   summary: foo.  
+00024470: 2020 2020 2020 2020 2020 7365 7276 6963            servic
+00024480: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00024490: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
+000244a0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+000244b0: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
+000244c0: 2020 2020 7374 6172 7475 703a 2065 6e61      startup: ena
+000244d0: 626c 6564 0a20 2020 2020 2020 2020 2020  bled.           
+000244e0: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+000244f0: 6269 6e2f 6563 686f 2066 6f6f 270a 2020  bin/echo foo'.  
+00024500: 2020 2020 2020 2020 2020 2020 6261 723a              bar:
+00024510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024520: 2073 756d 6d61 7279 3a20 4261 720a 2020   summary: Bar.  
+00024530: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00024540: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
+00024550: 6f20 6261 7227 0a20 2020 2020 2020 2020  o bar'.         
+00024560: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00024570: 2320 4974 2069 7320 6120 636f 6d6d 6f6e  # It is a common
+00024580: 206d 6973 7461 6b65 2074 6f20 7061 7373   mistake to pass
+00024590: 206a 7573 7420 6120 6e61 6d65 2076 7320   just a name vs 
+000245a0: 6120 6c69 7374 206f 6620 6e61 6d65 732c  a list of names,
+000245b0: 2073 6f20 6361 7463 6820 6974 2077 6974   so catch it wit
+000245c0: 6820 610a 2020 2020 2020 2020 2320 5479  h a.        # Ty
+000245d0: 7065 4572 726f 720a 2020 2020 2020 2020  peError.        
+000245e0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+000245f0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+00024600: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00024610: 6c69 656e 742e 6765 745f 7365 7276 6963  lient.get_servic
+00024620: 6573 2827 666f 6f27 290a 0a20 2020 2064  es('foo')..    d
+00024630: 6566 2074 6573 745f 6765 745f 7365 7276  ef test_get_serv
+00024640: 6963 6573 5f73 7562 7365 7428 7365 6c66  ices_subset(self
+00024650: 293a 0a20 2020 2020 2020 2063 6c69 656e  ):.        clien
+00024660: 7420 3d20 7365 6c66 2e67 6574 5f74 6573  t = self.get_tes
+00024670: 7469 6e67 5f63 6c69 656e 7428 290a 2020  ting_client().  
+00024680: 2020 2020 2020 636c 6965 6e74 2e61 6464        client.add
+00024690: 5f6c 6179 6572 2827 666f 6f27 2c20 2727  _layer('foo', ''
+000246a0: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
+000246b0: 756d 6d61 7279 3a20 666f 6f0a 2020 2020  ummary: foo.    
+000246c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
+000246d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000246e0: 666f 6f3a 0a20 2020 2020 2020 2020 2020  foo:.           
+000246f0: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
+00024700: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
+00024710: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
+00024720: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+00024730: 2020 2063 6f6d 6d61 6e64 3a20 272f 6269     command: '/bi
+00024740: 6e2f 6563 686f 2066 6f6f 270a 2020 2020  n/echo foo'.    
+00024750: 2020 2020 2020 2020 2020 6261 723a 0a20            bar:. 
+00024760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024770: 756d 6d61 7279 3a20 4261 720a 2020 2020  ummary: Bar.    
+00024780: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00024790: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
+000247a0: 6261 7227 0a20 2020 2020 2020 2020 2020  bar'.           
+000247b0: 2027 2727 290a 2020 2020 2020 2020 696e   ''').        in
+000247c0: 666f 7320 3d20 636c 6965 6e74 2e67 6574  fos = client.get
+000247d0: 5f73 6572 7669 6365 7328 5b27 666f 6f27  _services(['foo'
+000247e0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+000247f0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+00024800: 696e 666f 7329 2c20 3129 0a20 2020 2020  infos), 1).     
+00024810: 2020 2066 6f6f 5f69 6e66 6f20 3d20 696e     foo_info = in
+00024820: 666f 735b 305d 0a20 2020 2020 2020 2073  fos[0].        s
+00024830: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00024840: 2766 6f6f 272c 2066 6f6f 5f69 6e66 6f2e  'foo', foo_info.
+00024850: 6e61 6d65 290a 2020 2020 2020 2020 7365  name).        se
+00024860: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00024870: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00024880: 7274 7570 2e45 4e41 424c 4544 2c20 666f  rtup.ENABLED, fo
+00024890: 6f5f 696e 666f 2e73 7461 7274 7570 290a  o_info.startup).
+000248a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000248b0: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+000248c0: 5365 7276 6963 6553 7461 7475 732e 494e  ServiceStatus.IN
+000248d0: 4143 5449 5645 2c20 666f 6f5f 696e 666f  ACTIVE, foo_info
+000248e0: 2e63 7572 7265 6e74 290a 0a20 2020 2064  .current)..    d
+000248f0: 6566 2074 6573 745f 6765 745f 7365 7276  ef test_get_serv
+00024900: 6963 6573 5f75 6e6b 6e6f 776e 2873 656c  ices_unknown(sel
+00024910: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
+00024920: 6e74 203d 2073 656c 662e 6765 745f 7465  nt = self.get_te
+00024930: 7374 696e 675f 636c 6965 6e74 2829 0a20  sting_client(). 
+00024940: 2020 2020 2020 2063 6c69 656e 742e 6164         client.ad
+00024950: 645f 6c61 7965 7228 2766 6f6f 272c 2027  d_layer('foo', '
+00024960: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
+00024970: 7375 6d6d 6172 793a 2066 6f6f 0a20 2020  summary: foo.   
+00024980: 2020 2020 2020 2020 2073 6572 7669 6365           service
+00024990: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000249a0: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
+000249b0: 2020 2020 2020 7375 6d6d 6172 793a 2046        summary: F
+000249c0: 6f6f 0a20 2020 2020 2020 2020 2020 2020  oo.             
+000249d0: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
+000249e0: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+000249f0: 2020 2020 636f 6d6d 616e 643a 2027 2f62      command: '/b
+00024a00: 696e 2f65 6368 6f20 666f 6f27 0a20 2020  in/echo foo'.   
+00024a10: 2020 2020 2020 2020 2020 2062 6172 3a0a             bar:.
+00024a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a30: 7375 6d6d 6172 793a 2042 6172 0a20 2020  summary: Bar.   
+00024a40: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00024a50: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00024a60: 2062 6172 270a 2020 2020 2020 2020 2020   bar'.          
+00024a70: 2020 2727 2729 0a20 2020 2020 2020 2023    ''').        #
+00024a80: 2054 6869 7320 646f 6573 6e27 7420 7365   This doesn't se
+00024a90: 656d 2074 6f20 6265 2061 6e20 6572 726f  em to be an erro
+00024aa0: 7220 6174 2074 6865 206d 6f6d 656e 742e  r at the moment.
+00024ab0: 0a20 2020 2020 2020 2023 2070 6562 626c  .        # pebbl
+00024ac0: 655f 636c 692e 7079 2073 6572 7669 6365  e_cli.py service
+00024ad0: 206a 7573 7420 7265 7475 726e 7320 616e   just returns an
+00024ae0: 2065 6d70 7479 206c 6973 740a 2020 2020   empty list.    
+00024af0: 2020 2020 2320 7065 6262 6c65 2073 6572      # pebble ser
+00024b00: 7669 6365 2075 6e6b 6e6f 776e 2073 6179  vice unknown say
+00024b10: 7320 224e 6f20 6d61 7463 6869 6e67 2073  s "No matching s
+00024b20: 6572 7669 6365 7322 2028 6275 7420 6578  ervices" (but ex
+00024b30: 6974 7320 3029 0a20 2020 2020 2020 2069  its 0).        i
+00024b40: 6e66 6f73 203d 2063 6c69 656e 742e 6765  nfos = client.ge
+00024b50: 745f 7365 7276 6963 6573 285b 2775 6e6b  t_services(['unk
+00024b60: 6e6f 776e 275d 290a 2020 2020 2020 2020  nown']).        
+00024b70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00024b80: 2869 6e66 6f73 2c20 5b5d 290a 0a20 2020  (infos, [])..   
+00024b90: 2064 6566 2074 6573 745f 696e 7661 6c69   def test_invali
+00024ba0: 645f 7374 6172 745f 7365 7276 6963 6528  d_start_service(
+00024bb0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+00024bc0: 6c69 656e 7420 3d20 7365 6c66 2e67 6574  lient = self.get
+00024bd0: 5f74 6573 7469 6e67 5f63 6c69 656e 7428  _testing_client(
+00024be0: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
+00024bf0: 3a20 6a61 6d20 3230 3231 2d30 342d 3230  : jam 2021-04-20
+00024c00: 2054 6869 7320 7368 6f75 6c64 2062 6563   This should bec
+00024c10: 6f6d 6520 6120 6265 7474 6572 2065 7272  ome a better err
+00024c20: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
+00024c30: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00024c40: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+00024c50: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00024c60: 656e 742e 7374 6172 745f 7365 7276 6963  ent.start_servic
+00024c70: 6573 285b 2775 6e6b 6e6f 776e 275d 290a  es(['unknown']).
+00024c80: 0a20 2020 2064 6566 2074 6573 745f 7374  .    def test_st
+00024c90: 6172 745f 7365 7276 6963 655f 7374 7228  art_service_str(
+00024ca0: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+00024cb0: 2053 7461 7274 2073 6572 7669 6365 2074   Start service t
+00024cc0: 616b 6573 2061 206c 6973 7420 6f66 206e  akes a list of n
+00024cd0: 616d 6573 2c20 6275 7420 6974 2069 7320  ames, but it is 
+00024ce0: 7265 616c 6c79 2065 6173 7920 746f 2061  really easy to a
+00024cf0: 6363 6964 656e 7461 6c6c 7920 7061 7373  ccidentally pass
+00024d00: 206a 7573 7420 610a 2020 2020 2020 2020   just a.        
+00024d10: 2320 6e61 6d65 0a20 2020 2020 2020 2063  # name.        c
+00024d20: 6c69 656e 7420 3d20 7365 6c66 2e67 6574  lient = self.get
+00024d30: 5f74 6573 7469 6e67 5f63 6c69 656e 7428  _testing_client(
+00024d40: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00024d50: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00024d60: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+00024d70: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
+00024d80: 7374 6172 745f 7365 7276 6963 6573 2827  start_services('
+00024d90: 756e 6b6e 6f77 6e27 290a 0a20 2020 2064  unknown')..    d
+00024da0: 6566 2074 6573 745f 7374 6f70 5f73 6572  ef test_stop_ser
+00024db0: 7669 6365 5f73 7472 2873 656c 6629 3a0a  vice_str(self):.
+00024dc0: 2020 2020 2020 2020 2320 5374 6172 7420          # Start 
+00024dd0: 7365 7276 6963 6520 7461 6b65 7320 6120  service takes a 
+00024de0: 6c69 7374 206f 6620 6e61 6d65 732c 2062  list of names, b
+00024df0: 7574 2069 7420 6973 2072 6561 6c6c 7920  ut it is really 
+00024e00: 6561 7379 2074 6f20 6163 6369 6465 6e74  easy to accident
+00024e10: 616c 6c79 2070 6173 7320 6a75 7374 2061  ally pass just a
+00024e20: 0a20 2020 2020 2020 2023 206e 616d 650a  .        # name.
+00024e30: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+00024e40: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
+00024e50: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
+00024e60: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00024e70: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+00024e80: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00024e90: 2020 636c 6965 6e74 2e73 746f 705f 7365    client.stop_se
+00024ea0: 7276 6963 6573 2827 756e 6b6e 6f77 6e27  rvices('unknown'
+00024eb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00024ec0: 6d69 7865 645f 7374 6172 745f 7365 7276  mixed_start_serv
+00024ed0: 6963 6528 7365 6c66 293a 0a20 2020 2020  ice(self):.     
+00024ee0: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00024ef0: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
+00024f00: 656e 7428 290a 2020 2020 2020 2020 636c  ent().        cl
+00024f10: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+00024f20: 666f 6f27 2c20 2727 275c 0a20 2020 2020  foo', '''\.     
+00024f30: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00024f40: 666f 6f0a 2020 2020 2020 2020 2020 2020  foo.            
+00024f50: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+00024f60: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+00024f70: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00024f80: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
+00024f90: 2020 2020 2020 2020 2020 7374 6172 7475            startu
+00024fa0: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
+00024fb0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00024fc0: 6e64 3a20 272f 6269 6e2f 6563 686f 2066  nd: '/bin/echo f
+00024fd0: 6f6f 270a 2020 2020 2020 2020 2020 2020  oo'.            
+00024fe0: 2727 2729 0a20 2020 2020 2020 2023 2054  ''').        # T
+00024ff0: 4f44 4f3a 206a 616d 2032 3032 312d 3034  ODO: jam 2021-04
+00025000: 2d32 3020 6265 7474 6572 2065 7272 6f72  -20 better error
+00025010: 2074 7970 650a 2020 2020 2020 2020 7769   type.        wi
+00025020: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00025030: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+00025040: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00025050: 636c 6965 6e74 2e73 7461 7274 5f73 6572  client.start_ser
+00025060: 7669 6365 7328 5b27 666f 6f27 2c20 2775  vices(['foo', 'u
+00025070: 6e6b 6e6f 776e 275d 290a 2020 2020 2020  nknown']).      
+00025080: 2020 2320 666f 6f20 7368 6f75 6c64 206e    # foo should n
+00025090: 6f74 2062 6520 7374 6172 7465 640a 2020  ot be started.  
+000250a0: 2020 2020 2020 696e 666f 7320 3d20 636c        infos = cl
+000250b0: 6965 6e74 2e67 6574 5f73 6572 7669 6365  ient.get_service
+000250c0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+000250d0: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+000250e0: 2869 6e66 6f73 292c 2031 290a 2020 2020  (infos), 1).    
+000250f0: 2020 2020 666f 6f5f 696e 666f 203d 2069      foo_info = i
+00025100: 6e66 6f73 5b30 5d0a 2020 2020 2020 2020  nfos[0].        
+00025110: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00025120: 2827 666f 6f27 2c20 666f 6f5f 696e 666f  ('foo', foo_info
+00025130: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
+00025140: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00025150: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+00025160: 6172 7475 702e 454e 4142 4c45 442c 2066  artup.ENABLED, f
+00025170: 6f6f 5f69 6e66 6f2e 7374 6172 7475 7029  oo_info.startup)
+00025180: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00025190: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
+000251a0: 2e53 6572 7669 6365 5374 6174 7573 2e49  .ServiceStatus.I
+000251b0: 4e41 4354 4956 452c 2066 6f6f 5f69 6e66  NACTIVE, foo_inf
+000251c0: 6f2e 6375 7272 656e 7429 0a0a 2020 2020  o.current)..    
+000251d0: 6465 6620 7465 7374 5f73 746f 705f 7365  def test_stop_se
+000251e0: 7276 6963 6573 5f75 6e6b 6e6f 776e 2873  rvices_unknown(s
+000251f0: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
+00025200: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
+00025210: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
+00025220: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00025230: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
+00025240: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
+00025250: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
+00025260: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+00025270: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+00025280: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+00025290: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+000252a0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
+000252b0: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
+000252c0: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
+000252d0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+000252e0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
+000252f0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00025300: 2020 2020 2020 2020 636c 6965 6e74 2e61          client.a
+00025310: 7574 6f73 7461 7274 5f73 6572 7669 6365  utostart_service
+00025320: 7328 290a 2020 2020 2020 2020 2320 544f  s().        # TO
+00025330: 444f 3a20 6a61 6d20 3230 3231 2d30 342d  DO: jam 2021-04-
+00025340: 3230 2062 6574 7465 7220 6572 726f 7220  20 better error 
+00025350: 7479 7065 0a20 2020 2020 2020 2077 6974  type.        wit
+00025360: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00025370: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
+00025380: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00025390: 6c69 656e 742e 7374 6f70 5f73 6572 7669  lient.stop_servi
+000253a0: 6365 7328 5b27 666f 6f27 2c20 2775 6e6b  ces(['foo', 'unk
+000253b0: 6e6f 776e 275d 290a 2020 2020 2020 2020  nown']).        
+000253c0: 2320 666f 6f20 7368 6f75 6c64 2073 7469  # foo should sti
+000253d0: 6c6c 2062 6520 7275 6e6e 696e 670a 2020  ll be running.  
+000253e0: 2020 2020 2020 696e 666f 7320 3d20 636c        infos = cl
+000253f0: 6965 6e74 2e67 6574 5f73 6572 7669 6365  ient.get_service
+00025400: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+00025410: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00025420: 2869 6e66 6f73 292c 2031 290a 2020 2020  (infos), 1).    
+00025430: 2020 2020 666f 6f5f 696e 666f 203d 2069      foo_info = i
+00025440: 6e66 6f73 5b30 5d0a 2020 2020 2020 2020  nfos[0].        
+00025450: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00025460: 2827 666f 6f27 2c20 666f 6f5f 696e 666f  ('foo', foo_info
+00025470: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
+00025480: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00025490: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+000254a0: 6172 7475 702e 454e 4142 4c45 442c 2066  artup.ENABLED, f
+000254b0: 6f6f 5f69 6e66 6f2e 7374 6172 7475 7029  oo_info.startup)
+000254c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000254d0: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
+000254e0: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
+000254f0: 4354 4956 452c 2066 6f6f 5f69 6e66 6f2e  CTIVE, foo_info.
+00025500: 6375 7272 656e 7429 0a0a 2020 2020 6465  current)..    de
+00025510: 6620 7465 7374 5f73 7461 7274 5f73 7461  f test_start_sta
+00025520: 7274 6564 5f73 6572 7669 6365 2873 656c  rted_service(sel
+00025530: 6629 3a0a 2020 2020 2020 2020 2320 5065  f):.        # Pe
+00025540: 6262 6c65 206d 6169 6e74 6169 6e73 2069  bble maintains i
+00025550: 6465 6d70 6f74 656e 6379 2065 7665 6e20  dempotency even 
+00025560: 6966 2079 6f75 2073 7461 7274 2061 2073  if you start a s
+00025570: 6572 7669 6365 0a20 2020 2020 2020 2023  ervice.        #
+00025580: 2077 6869 6368 2069 7320 616c 7265 6164   which is alread
+00025590: 7920 7374 6172 7465 642e 0a20 2020 2020  y started..     
+000255a0: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+000255b0: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
+000255c0: 656e 7428 290a 2020 2020 2020 2020 636c  ent().        cl
+000255d0: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+000255e0: 666f 6f27 2c20 2727 275c 0a20 2020 2020  foo', '''\.     
+000255f0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00025600: 666f 6f0a 2020 2020 2020 2020 2020 2020  foo.            
+00025610: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+00025620: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+00025630: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00025640: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
+00025650: 2020 2020 2020 2020 2020 7374 6172 7475            startu
+00025660: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
+00025670: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00025680: 6e64 3a20 272f 6269 6e2f 6563 686f 2066  nd: '/bin/echo f
+00025690: 6f6f 270a 2020 2020 2020 2020 2020 2020  oo'.            
+000256a0: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
+000256b0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+000256c0: 4261 720a 2020 2020 2020 2020 2020 2020  Bar.            
+000256d0: 2020 2020 636f 6d6d 616e 643a 2027 2f62      command: '/b
+000256e0: 696e 2f65 6368 6f20 6261 7227 0a20 2020  in/echo bar'.   
+000256f0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00025700: 2020 2020 2020 636c 6965 6e74 2e61 7574        client.aut
+00025710: 6f73 7461 7274 5f73 6572 7669 6365 7328  ostart_services(
+00025720: 290a 2020 2020 2020 2020 2320 466f 6f20  ).        # Foo 
+00025730: 6973 206e 6f77 2073 7461 7274 6564 2c20  is now started, 
+00025740: 6275 7420 4261 7220 6973 206e 6f74 0a20  but Bar is not. 
+00025750: 2020 2020 2020 2063 6c69 656e 742e 7374         client.st
+00025760: 6172 745f 7365 7276 6963 6573 285b 2762  art_services(['b
+00025770: 6172 272c 2027 666f 6f27 5d29 0a20 2020  ar', 'foo']).   
+00025780: 2020 2020 2023 2066 6f6f 2061 6e64 2062       # foo and b
+00025790: 6172 2061 7265 2062 6f74 6820 7374 6172  ar are both star
+000257a0: 7465 640a 2020 2020 2020 2020 696e 666f  ted.        info
+000257b0: 7320 3d20 636c 6965 6e74 2e67 6574 5f73  s = client.get_s
+000257c0: 6572 7669 6365 7328 290a 2020 2020 2020  ervices().      
+000257d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000257e0: 616c 286c 656e 2869 6e66 6f73 292c 2032  al(len(infos), 2
+000257f0: 290a 2020 2020 2020 2020 6261 725f 696e  ).        bar_in
+00025800: 666f 203d 2069 6e66 6f73 5b30 5d0a 2020  fo = infos[0].  
+00025810: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00025820: 7445 7175 616c 2827 6261 7227 2c20 6261  tEqual('bar', ba
+00025830: 725f 696e 666f 2e6e 616d 6529 0a20 2020  r_info.name).   
+00025840: 2020 2020 2023 2044 6566 6175 6c74 2077       # Default w
+00025850: 6865 6e20 6e6f 7420 7370 6563 6966 6965  hen not specifie
+00025860: 6420 6973 2044 4953 4142 4c45 440a 2020  d is DISABLED.  
+00025870: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00025880: 7445 7175 616c 2870 6562 626c 652e 5365  tEqual(pebble.Se
+00025890: 7276 6963 6553 7461 7274 7570 2e44 4953  rviceStartup.DIS
+000258a0: 4142 4c45 442c 2062 6172 5f69 6e66 6f2e  ABLED, bar_info.
+000258b0: 7374 6172 7475 7029 0a20 2020 2020 2020  startup).       
+000258c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000258d0: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
+000258e0: 5374 6174 7573 2e41 4354 4956 452c 2062  Status.ACTIVE, b
+000258f0: 6172 5f69 6e66 6f2e 6375 7272 656e 7429  ar_info.current)
+00025900: 0a20 2020 2020 2020 2066 6f6f 5f69 6e66  .        foo_inf
+00025910: 6f20 3d20 696e 666f 735b 315d 0a20 2020  o = infos[1].   
+00025920: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00025930: 4571 7561 6c28 2766 6f6f 272c 2066 6f6f  Equal('foo', foo
+00025940: 5f69 6e66 6f2e 6e61 6d65 290a 2020 2020  _info.name).    
+00025950: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00025960: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
+00025970: 6963 6553 7461 7274 7570 2e45 4e41 424c  iceStartup.ENABL
+00025980: 4544 2c20 666f 6f5f 696e 666f 2e73 7461  ED, foo_info.sta
+00025990: 7274 7570 290a 2020 2020 2020 2020 7365  rtup).        se
+000259a0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+000259b0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+000259c0: 7475 732e 4143 5449 5645 2c20 666f 6f5f  tus.ACTIVE, foo_
+000259d0: 696e 666f 2e63 7572 7265 6e74 290a 0a20  info.current).. 
+000259e0: 2020 2064 6566 2074 6573 745f 7374 6f70     def test_stop
+000259f0: 5f73 746f 7070 6564 5f73 6572 7669 6365  _stopped_service
+00025a00: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00025a10: 2320 5065 6262 6c65 206d 6169 6e74 6169  # Pebble maintai
+00025a20: 6e73 2069 6465 6d70 6f74 656e 6379 2065  ns idempotency e
+00025a30: 7665 6e20 6966 2079 6f75 2073 746f 7020  ven if you stop 
+00025a40: 6120 7365 7276 6963 650a 2020 2020 2020  a service.      
+00025a50: 2020 2320 7768 6963 6820 6973 2061 6c72    # which is alr
+00025a60: 6561 6479 2073 746f 7070 6564 2e0a 2020  eady stopped..  
+00025a70: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00025a80: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
+00025a90: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
+00025aa0: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+00025ab0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
+00025ac0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00025ad0: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
+00025ae0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
+00025af0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+00025b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b10: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+00025b20: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00025b30: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
+00025b40: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00025b50: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
+00025b60: 6f20 666f 6f27 0a20 2020 2020 2020 2020  o foo'.         
+00025b70: 2020 2020 2062 6172 3a0a 2020 2020 2020       bar:.      
+00025b80: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00025b90: 793a 2042 6172 0a20 2020 2020 2020 2020  y: Bar.         
+00025ba0: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+00025bb0: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
+00025bc0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00025bd0: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00025be0: 6175 746f 7374 6172 745f 7365 7276 6963  autostart_servic
+00025bf0: 6573 2829 0a20 2020 2020 2020 2023 2046  es().        # F
+00025c00: 6f6f 2069 7320 6e6f 7720 7374 6172 7465  oo is now starte
+00025c10: 642c 2062 7574 2042 6172 2069 7320 6e6f  d, but Bar is no
+00025c20: 740a 2020 2020 2020 2020 636c 6965 6e74  t.        client
+00025c30: 2e73 746f 705f 7365 7276 6963 6573 285b  .stop_services([
+00025c40: 2766 6f6f 272c 2027 6261 7227 5d29 0a20  'foo', 'bar']). 
+00025c50: 2020 2020 2020 2023 2066 6f6f 2061 6e64         # foo and
+00025c60: 2062 6172 2061 7265 2062 6f74 6820 7374   bar are both st
+00025c70: 6f70 7065 640a 2020 2020 2020 2020 696e  opped.        in
+00025c80: 666f 7320 3d20 636c 6965 6e74 2e67 6574  fos = client.get
+00025c90: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
+00025ca0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00025cb0: 7175 616c 286c 656e 2869 6e66 6f73 292c  qual(len(infos),
+00025cc0: 2032 290a 2020 2020 2020 2020 6261 725f   2).        bar_
+00025cd0: 696e 666f 203d 2069 6e66 6f73 5b30 5d0a  info = infos[0].
+00025ce0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00025cf0: 6572 7445 7175 616c 2827 6261 7227 2c20  ertEqual('bar', 
+00025d00: 6261 725f 696e 666f 2e6e 616d 6529 0a20  bar_info.name). 
+00025d10: 2020 2020 2020 2023 2044 6566 6175 6c74         # Default
+00025d20: 2077 6865 6e20 6e6f 7420 7370 6563 6966   when not specif
+00025d30: 6965 6420 6973 2044 4953 4142 4c45 440a  ied is DISABLED.
+00025d40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00025d50: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00025d60: 5365 7276 6963 6553 7461 7274 7570 2e44  ServiceStartup.D
+00025d70: 4953 4142 4c45 442c 2062 6172 5f69 6e66  ISABLED, bar_inf
+00025d80: 6f2e 7374 6172 7475 7029 0a20 2020 2020  o.startup).     
+00025d90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00025da0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00025db0: 6365 5374 6174 7573 2e49 4e41 4354 4956  ceStatus.INACTIV
+00025dc0: 452c 2062 6172 5f69 6e66 6f2e 6375 7272  E, bar_info.curr
+00025dd0: 656e 7429 0a20 2020 2020 2020 2066 6f6f  ent).        foo
+00025de0: 5f69 6e66 6f20 3d20 696e 666f 735b 315d  _info = infos[1]
+00025df0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00025e00: 7365 7274 4571 7561 6c28 2766 6f6f 272c  sertEqual('foo',
+00025e10: 2066 6f6f 5f69 6e66 6f2e 6e61 6d65 290a   foo_info.name).
+00025e20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00025e30: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00025e40: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
+00025e50: 4e41 424c 4544 2c20 666f 6f5f 696e 666f  NABLED, foo_info
+00025e60: 2e73 7461 7274 7570 290a 2020 2020 2020  .startup).      
+00025e70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00025e80: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+00025e90: 6553 7461 7475 732e 494e 4143 5449 5645  eStatus.INACTIVE
+00025ea0: 2c20 666f 6f5f 696e 666f 2e63 7572 7265  , foo_info.curre
+00025eb0: 6e74 290a 0a20 2020 2040 2075 6e69 7474  nt)..    @ unitt
+00025ec0: 6573 742e 736b 6970 556e 6c65 7373 2869  est.skipUnless(i
+00025ed0: 735f 6c69 6e75 782c 2027 5065 6262 6c65  s_linux, 'Pebble
+00025ee0: 2072 756e 7320 6f6e 204c 696e 7578 2729   runs on Linux')
+00025ef0: 0a20 2020 2064 6566 2074 6573 745f 7365  .    def test_se
+00025f00: 6e64 5f73 6967 6e61 6c28 7365 6c66 293a  nd_signal(self):
+00025f10: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
+00025f20: 3d20 7365 6c66 2e67 6574 5f74 6573 7469  = self.get_testi
+00025f30: 6e67 5f63 6c69 656e 7428 290a 2020 2020  ng_client().    
+00025f40: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
+00025f50: 6179 6572 2827 666f 6f27 2c20 2727 275c  ayer('foo', '''\
+00025f60: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
+00025f70: 6d61 7279 3a20 666f 6f0a 2020 2020 2020  mary: foo.      
+00025f80: 2020 2020 2020 7365 7276 6963 6573 3a0a        services:.
+00025f90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00025fa0: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
+00025fb0: 2020 2073 756d 6d61 7279 3a20 466f 6f0a     summary: Foo.
+00025fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025fd0: 7374 6172 7475 703a 2065 6e61 626c 6564  startup: enabled
+00025fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025ff0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
+00026000: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
+00026010: 2020 2020 2020 2020 6261 723a 0a20 2020          bar:.   
+00026020: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00026030: 6d61 7279 3a20 4261 720a 2020 2020 2020  mary: Bar.      
+00026040: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+00026050: 643a 2027 2f62 696e 2f65 6368 6f20 6261  d: '/bin/echo ba
+00026060: 7227 0a20 2020 2020 2020 2020 2020 2027  r'.            '
+00026070: 2727 290a 2020 2020 2020 2020 636c 6965  '').        clie
+00026080: 6e74 2e61 7574 6f73 7461 7274 5f73 6572  nt.autostart_ser
+00026090: 7669 6365 7328 290a 2020 2020 2020 2020  vices().        
+000260a0: 2320 466f 6f20 6973 206e 6f77 2073 7461  # Foo is now sta
+000260b0: 7274 6564 2c20 6275 7420 4261 7220 6973  rted, but Bar is
+000260c0: 206e 6f74 0a0a 2020 2020 2020 2020 2320   not..        # 
+000260d0: 5365 6e64 2061 2076 616c 6964 2073 6967  Send a valid sig
+000260e0: 6e61 6c20 746f 2061 2072 756e 6e69 6e67  nal to a running
+000260f0: 2073 6572 7669 6365 0a20 2020 2020 2020   service.       
+00026100: 2063 6c69 656e 742e 7365 6e64 5f73 6967   client.send_sig
+00026110: 6e61 6c28 2253 4947 494e 5422 2c20 2822  nal("SIGINT", ("
+00026120: 666f 6f22 2c29 290a 0a20 2020 2020 2020  foo",))..       
+00026130: 2023 2053 656e 6420 6120 7661 6c69 6420   # Send a valid 
+00026140: 7369 676e 616c 2062 7574 206f 6d69 7420  signal but omit 
+00026150: 7365 7276 6963 6520 6e61 6d65 0a20 2020  service name.   
+00026160: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00026170: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+00026180: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00026190: 2020 2020 636c 6965 6e74 2e73 656e 645f      client.send_
+000261a0: 7369 676e 616c 2822 5349 4749 4e54 222c  signal("SIGINT",
+000261b0: 2074 7570 6c65 2829 290a 0a20 2020 2020   tuple())..     
+000261c0: 2020 2023 2053 656e 6420 616e 2069 6e76     # Send an inv
+000261d0: 616c 6964 2073 6967 6e61 6c20 746f 2061  alid signal to a
+000261e0: 2072 756e 6e69 6e67 2073 6572 7669 6365   running service
+000261f0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00026200: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00026210: 7065 6262 6c65 2e41 5049 4572 726f 7229  pebble.APIError)
+00026220: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00026230: 6965 6e74 2e73 656e 645f 7369 676e 616c  ient.send_signal
+00026240: 2822 7369 6769 6e74 222c 2028 2266 6f6f  ("sigint", ("foo
+00026250: 222c 2929 0a0a 2020 2020 2020 2020 2320  ",))..        # 
+00026260: 5365 6e64 2061 2076 616c 6964 2073 6967  Send a valid sig
+00026270: 6e61 6c20 746f 2061 2073 746f 7070 6564  nal to a stopped
+00026280: 2073 6572 7669 6365 0a20 2020 2020 2020   service.       
+00026290: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000262a0: 7452 6169 7365 7328 7065 6262 6c65 2e41  tRaises(pebble.A
+000262b0: 5049 4572 726f 7229 3a0a 2020 2020 2020  PIError):.      
+000262c0: 2020 2020 2020 636c 6965 6e74 2e73 656e        client.sen
+000262d0: 645f 7369 676e 616c 2822 5349 4749 4e54  d_signal("SIGINT
+000262e0: 222c 2028 2262 6172 222c 2929 0a0a 2020  ", ("bar",))..  
+000262f0: 2020 2020 2020 2320 5365 6e64 2061 2076        # Send a v
+00026300: 616c 6964 2073 6967 6e61 6c20 746f 2061  alid signal to a
+00026310: 206e 6f6e 2d65 7869 7374 696e 6720 7365   non-existing se
+00026320: 7276 6963 650a 2020 2020 2020 2020 7769  rvice.        wi
+00026330: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00026340: 6973 6573 2870 6562 626c 652e 4150 4945  ises(pebble.APIE
+00026350: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00026360: 2020 2063 6c69 656e 742e 7365 6e64 5f73     client.send_s
+00026370: 6967 6e61 6c28 2253 4947 494e 5422 2c20  ignal("SIGINT", 
+00026380: 2822 6261 7a22 2c29 290a 0a20 2020 2020  ("baz",))..     
+00026390: 2020 2023 2053 656e 6420 6120 7661 6c69     # Send a vali
+000263a0: 6420 7369 676e 616c 2074 6f20 6120 6d75  d signal to a mu
+000263b0: 6c74 6970 6c65 2073 6572 7669 6365 732c  ltiple services,
+000263c0: 206f 6e65 206f 6620 7768 6963 6820 6973   one of which is
+000263d0: 206e 6f74 2072 756e 6e69 6e67 0a20 2020   not running.   
+000263e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+000263f0: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
+00026400: 6c65 2e41 5049 4572 726f 7229 3a0a 2020  le.APIError):.  
+00026410: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00026420: 2e73 656e 645f 7369 676e 616c 2822 5349  .send_signal("SI
+00026430: 4749 4e54 222c 2028 2266 6f6f 222c 2022  GINT", ("foo", "
+00026440: 6261 7222 2c29 290a 0a0a 2320 466f 7220  bar",))...# For 
+00026450: 7465 7374 696e 6720 6669 6c65 2d6f 7073  testing file-ops
+00026460: 206f 6620 7468 6520 7065 6262 6c65 2063   of the pebble c
+00026470: 6c69 656e 742e 2020 5468 6973 2069 7320  lient.  This is 
+00026480: 7265 6661 6374 6f72 6564 2069 6e74 6f20  refactored into 
+00026490: 610a 2320 7365 7061 7261 7465 206d 6978  a.# separate mix
+000264a0: 696e 2073 6f20 7765 2063 616e 2072 756e  in so we can run
+000264b0: 2074 6865 7365 2074 6573 7473 2061 6761   these tests aga
+000264c0: 696e 7374 2062 6f74 6820 7468 6520 6d6f  inst both the mo
+000264d0: 636b 2063 6c69 656e 7420 6173 0a23 2077  ck client as.# w
+000264e0: 656c 6c20 6173 2061 2072 6561 6c20 7065  ell as a real pe
+000264f0: 6262 6c65 2073 6572 7665 7220 696e 7374  bble server inst
+00026500: 616e 6365 2e0a 636c 6173 7320 5f50 6562  ance..class _Peb
+00026510: 626c 6553 746f 7261 6765 4150 4973 5465  bleStorageAPIsTe
+00026520: 7374 4d69 7869 6e3a 0a20 2020 2023 204f  stMixin:.    # O
+00026530: 7665 7272 6964 6520 7468 6973 2069 6e20  verride this in 
+00026540: 636c 6173 7365 7320 7573 696e 6720 7468  classes using th
+00026550: 6973 206d 6978 696e 2e0a 2020 2020 2320  is mixin..    # 
+00026560: 5468 6973 2073 686f 756c 6420 6265 2073  This should be s
+00026570: 6574 2074 6f20 616e 7920 6e6f 6e2d 656d  et to any non-em
+00026580: 7074 7920 7061 7468 2c20 6275 7420 7769  pty path, but wi
+00026590: 7468 6f75 7420 6120 7472 6169 6c69 6e67  thout a trailing
+000265a0: 202f 2e0a 2020 2020 7072 6566 6978 203d   /..    prefix =
+000265b0: 204e 6f6e 650a 0a20 2020 2064 6566 2074   None..    def t
+000265c0: 6573 745f 7075 7368 5f61 6e64 5f70 756c  est_push_and_pul
+000265d0: 6c5f 6279 7465 7328 7365 6c66 293a 0a20  l_bytes(self):. 
+000265e0: 2020 2020 2020 2073 656c 662e 5f74 6573         self._tes
+000265f0: 745f 7075 7368 5f61 6e64 5f70 756c 6c5f  t_push_and_pull_
+00026600: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
+00026610: 2020 6f72 6967 696e 616c 5f64 6174 613d    original_data=
+00026620: 6222 5c78 3030 5c78 3031 5c78 3032 5c78  b"\x00\x01\x02\x
+00026630: 3033 5c78 3034 222c 0a20 2020 2020 2020  03\x04",.       
+00026640: 2020 2020 2065 6e63 6f64 696e 673d 4e6f       encoding=No
+00026650: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00026660: 7374 7265 616d 5f63 6c61 7373 3d69 6f2e  stream_class=io.
+00026670: 4279 7465 7349 4f29 0a0a 2020 2020 6465  BytesIO)..    de
+00026680: 6620 7465 7374 5f70 7573 685f 616e 645f  f test_push_and_
+00026690: 7075 6c6c 5f6e 6f6e 5f75 7466 385f 6461  pull_non_utf8_da
+000266a0: 7461 2873 656c 6629 3a0a 2020 2020 2020  ta(self):.      
+000266b0: 2020 7365 6c66 2e5f 7465 7374 5f70 7573    self._test_pus
+000266c0: 685f 616e 645f 7075 6c6c 5f64 6174 6128  h_and_pull_data(
+000266d0: 0a20 2020 2020 2020 2020 2020 206f 7269  .            ori
+000266e0: 6769 6e61 6c5f 6461 7461 3d27 e697 a5e6  ginal_data='....
+000266f0: 9cac e8aa 9e27 2c20 2023 2022 4a61 7061  .....',  # "Japa
+00026700: 6e65 7365 2220 696e 204a 6170 616e 6573  nese" in Japanes
+00026710: 650a 2020 2020 2020 2020 2020 2020 656e  e.            en
+00026720: 636f 6469 6e67 3d27 736a 6973 272c 0a20  coding='sjis',. 
+00026730: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+00026740: 6d5f 636c 6173 733d 696f 2e53 7472 696e  m_class=io.Strin
+00026750: 6749 4f29 0a0a 2020 2020 6465 6620 5f74  gIO)..    def _t
+00026760: 6573 745f 7075 7368 5f61 6e64 5f70 756c  est_push_and_pul
+00026770: 6c5f 6461 7461 2873 656c 662c 206f 7269  l_data(self, ori
+00026780: 6769 6e61 6c5f 6461 7461 2c20 656e 636f  ginal_data, enco
+00026790: 6469 6e67 2c20 7374 7265 616d 5f63 6c61  ding, stream_cla
+000267a0: 7373 293a 0a20 2020 2020 2020 2063 6c69  ss):.        cli
+000267b0: 656e 7420 3d20 7365 6c66 2e63 6c69 656e  ent = self.clien
+000267c0: 740a 2020 2020 2020 2020 636c 6965 6e74  t.        client
+000267d0: 2e70 7573 6828 6622 7b73 656c 662e 7072  .push(f"{self.pr
+000267e0: 6566 6978 7d2f 7465 7374 222c 206f 7269  efix}/test", ori
+000267f0: 6769 6e61 6c5f 6461 7461 2c20 656e 636f  ginal_data, enco
+00026800: 6469 6e67 3d65 6e63 6f64 696e 6729 0a20  ding=encoding). 
+00026810: 2020 2020 2020 2077 6974 6820 636c 6965         with clie
+00026820: 6e74 2e70 756c 6c28 6622 7b73 656c 662e  nt.pull(f"{self.
+00026830: 7072 6566 6978 7d2f 7465 7374 222c 2065  prefix}/test", e
+00026840: 6e63 6f64 696e 673d 656e 636f 6469 6e67  ncoding=encoding
+00026850: 2920 6173 2069 6e66 696c 653a 0a20 2020  ) as infile:.   
+00026860: 2020 2020 2020 2020 2072 6563 6569 7665           receive
+00026870: 645f 6461 7461 203d 2069 6e66 696c 652e  d_data = infile.
+00026880: 7265 6164 2829 0a20 2020 2020 2020 2073  read().        s
+00026890: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000268a0: 6f72 6967 696e 616c 5f64 6174 612c 2072  original_data, r
+000268b0: 6563 6569 7665 645f 6461 7461 290a 0a20  eceived_data).. 
+000268c0: 2020 2020 2020 2023 2057 6520 616c 736f         # We also
+000268d0: 2073 7570 706f 7274 2066 696c 652d 6c69   support file-li
+000268e0: 6b65 206f 626a 6563 7473 2061 7320 696e  ke objects as in
+000268f0: 7075 742c 2073 6f20 6c65 7427 7320 7465  put, so let's te
+00026900: 7374 2074 6861 7420 6361 7365 2061 7320  st that case as 
+00026910: 7765 6c6c 2e0a 2020 2020 2020 2020 736d  well..        sm
+00026920: 616c 6c5f 6669 6c65 203d 2073 7472 6561  all_file = strea
+00026930: 6d5f 636c 6173 7328 6f72 6967 696e 616c  m_class(original
+00026940: 5f64 6174 6129 0a20 2020 2020 2020 2063  _data).        c
+00026950: 6c69 656e 742e 7075 7368 2866 227b 7365  lient.push(f"{se
+00026960: 6c66 2e70 7265 6669 787d 2f74 6573 7422  lf.prefix}/test"
+00026970: 2c20 736d 616c 6c5f 6669 6c65 2c20 656e  , small_file, en
+00026980: 636f 6469 6e67 3d65 6e63 6f64 696e 6729  coding=encoding)
+00026990: 0a20 2020 2020 2020 2077 6974 6820 636c  .        with cl
+000269a0: 6965 6e74 2e70 756c 6c28 6622 7b73 656c  ient.pull(f"{sel
+000269b0: 662e 7072 6566 6978 7d2f 7465 7374 222c  f.prefix}/test",
+000269c0: 2065 6e63 6f64 696e 673d 656e 636f 6469   encoding=encodi
+000269d0: 6e67 2920 6173 2069 6e66 696c 653a 0a20  ng) as infile:. 
+000269e0: 2020 2020 2020 2020 2020 2072 6563 6569             recei
+000269f0: 7665 645f 6461 7461 203d 2069 6e66 696c  ved_data = infil
+00026a00: 652e 7265 6164 2829 0a20 2020 2020 2020  e.read().       
+00026a10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00026a20: 6c28 6f72 6967 696e 616c 5f64 6174 612c  l(original_data,
+00026a30: 2072 6563 6569 7665 645f 6461 7461 290a   received_data).
+00026a40: 0a20 2020 2064 6566 2074 6573 745f 7075  .    def test_pu
+00026a50: 7368 5f61 6e64 5f70 756c 6c5f 6c61 7267  sh_and_pull_larg
+00026a60: 6572 5f66 696c 6528 7365 6c66 293a 0a20  er_file(self):. 
+00026a70: 2020 2020 2020 2023 2049 6e74 656e 743a         # Intent:
+00026a80: 2074 6f20 656e 7375 7265 2074 6869 6e67   to ensure thing
+00026a90: 7320 776f 726b 2061 7070 726f 7072 6961  s work appropria
+00026aa0: 7465 6c79 2077 6974 6820 6c61 7267 6572  tely with larger
+00026ab0: 2066 696c 6573 2e0a 2020 2020 2020 2020   files..        
+00026ac0: 2320 4c61 7267 6572 2066 696c 6573 206d  # Larger files m
+00026ad0: 6179 2062 6520 7365 6e74 2f72 6563 6569  ay be sent/recei
+00026ae0: 7665 6420 696e 206d 756c 7469 706c 6520  ved in multiple 
+00026af0: 6368 756e 6b73 3b20 7468 6973 2073 686f  chunks; this sho
+00026b00: 756c 6420 6865 6c70 2066 6f72 0a20 2020  uld help for.   
+00026b10: 2020 2020 2023 2063 6865 636b 696e 6720       # checking 
+00026b20: 7468 6174 2073 7563 6820 6c6f 6769 6320  that such logic 
+00026b30: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
+00026b40: 2020 2020 6461 7461 5f73 697a 6520 3d20      data_size = 
+00026b50: 3130 3234 202a 2031 3032 340a 2020 2020  1024 * 1024.    
+00026b60: 2020 2020 6f72 6967 696e 616c 5f64 6174      original_dat
+00026b70: 6120 3d20 6f73 2e75 7261 6e64 6f6d 2864  a = os.urandom(d
+00026b80: 6174 615f 7369 7a65 290a 0a20 2020 2020  ata_size)..     
+00026b90: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00026ba0: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00026bb0: 636c 6965 6e74 2e70 7573 6828 6622 7b73  client.push(f"{s
+00026bc0: 656c 662e 7072 6566 6978 7d2f 7465 7374  elf.prefix}/test
+00026bd0: 222c 206f 7269 6769 6e61 6c5f 6461 7461  ", original_data
+00026be0: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+00026bf0: 0a20 2020 2020 2020 2077 6974 6820 636c  .        with cl
+00026c00: 6965 6e74 2e70 756c 6c28 6622 7b73 656c  ient.pull(f"{sel
+00026c10: 662e 7072 6566 6978 7d2f 7465 7374 222c  f.prefix}/test",
+00026c20: 2065 6e63 6f64 696e 673d 4e6f 6e65 2920   encoding=None) 
+00026c30: 6173 2069 6e66 696c 653a 0a20 2020 2020  as infile:.     
+00026c40: 2020 2020 2020 2072 6563 6569 7665 645f         received_
+00026c50: 6461 7461 203d 2069 6e66 696c 652e 7265  data = infile.re
+00026c60: 6164 2829 0a20 2020 2020 2020 2073 656c  ad().        sel
+00026c70: 662e 6173 7365 7274 4571 7561 6c28 6f72  f.assertEqual(or
+00026c80: 6967 696e 616c 5f64 6174 612c 2072 6563  iginal_data, rec
+00026c90: 6569 7665 645f 6461 7461 290a 0a20 2020  eived_data)..   
+00026ca0: 2064 6566 2074 6573 745f 7075 7368 5f74   def test_push_t
+00026cb0: 6f5f 6e6f 6e5f 6578 6973 7465 6e74 5f73  o_non_existent_s
+00026cc0: 7562 6469 7228 7365 6c66 293a 0a20 2020  ubdir(self):.   
+00026cd0: 2020 2020 2064 6174 6120 3d20 2764 6174       data = 'dat
+00026ce0: 6127 0a20 2020 2020 2020 2063 6c69 656e  a'.        clien
+00026cf0: 7420 3d20 7365 6c66 2e63 6c69 656e 740a  t = self.client.
+00026d00: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00026d10: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00026d20: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
+00026d30: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00026d40: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
+00026d50: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00026d60: 2f6e 6f6e 6578 6973 7465 6e74 5f64 6972  /nonexistent_dir
+00026d70: 2f74 6573 7422 2c20 6461 7461 2c20 6d61  /test", data, ma
+00026d80: 6b65 5f64 6972 733d 4661 6c73 6529 0a20  ke_dirs=False). 
+00026d90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00026da0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+00026db0: 7469 6f6e 2e6b 696e 642c 2027 6e6f 742d  tion.kind, 'not-
+00026dc0: 666f 756e 6427 290a 0a20 2020 2020 2020  found')..       
+00026dd0: 2063 6c69 656e 742e 7075 7368 2866 227b   client.push(f"{
+00026de0: 7365 6c66 2e70 7265 6669 787d 2f6e 6f6e  self.prefix}/non
+00026df0: 6578 6973 7465 6e74 5f64 6972 2f74 6573  existent_dir/tes
+00026e00: 7422 2c20 6461 7461 2c20 6d61 6b65 5f64  t", data, make_d
+00026e10: 6972 733d 5472 7565 290a 0a20 2020 2064  irs=True)..    d
+00026e20: 6566 2074 6573 745f 7075 7368 5f61 735f  ef test_push_as_
+00026e30: 6368 696c 645f 6f66 5f66 696c 655f 7261  child_of_file_ra
+00026e40: 6973 6573 5f65 7272 6f72 2873 656c 6629  ises_error(self)
+00026e50: 3a0a 2020 2020 2020 2020 6461 7461 203d  :.        data =
+00026e60: 2027 6461 7461 270a 2020 2020 2020 2020   'data'.        
+00026e70: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+00026e80: 6965 6e74 0a20 2020 2020 2020 2063 6c69  ient.        cli
+00026e90: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
+00026ea0: 2e70 7265 6669 787d 2f66 696c 6522 2c20  .prefix}/file", 
+00026eb0: 6461 7461 290a 2020 2020 2020 2020 7769  data).        wi
+00026ec0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00026ed0: 6973 6573 2870 6562 626c 652e 5061 7468  ises(pebble.Path
+00026ee0: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
+00026ef0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00026f00: 2e70 7573 6828 6622 7b73 656c 662e 7072  .push(f"{self.pr
+00026f10: 6566 6978 7d2f 6669 6c65 2f66 696c 6522  efix}/file/file"
+00026f20: 2c20 6461 7461 290a 2020 2020 2020 2020  , data).        
+00026f30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00026f40: 2863 6d2e 6578 6365 7074 696f 6e2e 6b69  (cm.exception.ki
+00026f50: 6e64 2c20 2767 656e 6572 6963 2d66 696c  nd, 'generic-fil
+00026f60: 652d 6572 726f 7227 290a 0a20 2020 2064  e-error')..    d
+00026f70: 6566 2074 6573 745f 7075 7368 5f77 6974  ef test_push_wit
+00026f80: 685f 7065 726d 6973 7369 6f6e 5f6d 6173  h_permission_mas
+00026f90: 6b28 7365 6c66 293a 0a20 2020 2020 2020  k(self):.       
+00026fa0: 2064 6174 6120 3d20 2764 6174 6127 0a20   data = 'data'. 
+00026fb0: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+00026fc0: 7365 6c66 2e63 6c69 656e 740a 2020 2020  self.client.    
+00026fd0: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
+00026fe0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00026ff0: 6669 6c65 222c 2064 6174 612c 2070 6572  file", data, per
+00027000: 6d69 7373 696f 6e73 3d30 6f36 3030 290a  missions=0o600).
+00027010: 2020 2020 2020 2020 636c 6965 6e74 2e70          client.p
+00027020: 7573 6828 6622 7b73 656c 662e 7072 6566  ush(f"{self.pref
+00027030: 6978 7d2f 6669 6c65 222c 2064 6174 612c  ix}/file", data,
+00027040: 2070 6572 6d69 7373 696f 6e73 3d30 6f37   permissions=0o7
+00027050: 3737 290a 2020 2020 2020 2020 2320 4966  77).        # If
+00027060: 2070 6572 6d69 7373 696f 6e73 2061 7265   permissions are
+00027070: 206f 7574 7369 6465 206f 6620 7468 6520   outside of the 
+00027080: 7261 6e67 6520 306f 3030 3020 7468 726f  range 0o000 thro
+00027090: 7567 6820 306f 3737 372c 2061 6e20 6578  ugh 0o777, an ex
+000270a0: 6365 7074 696f 6e20 7368 6f75 6c64 2062  ception should b
+000270b0: 650a 2020 2020 2020 2020 2320 7261 6973  e.        # rais
+000270c0: 6564 2e0a 2020 2020 2020 2020 666f 7220  ed..        for 
+000270d0: 6261 645f 7065 726d 6973 7369 6f6e 2069  bad_permission i
+000270e0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+000270f0: 306f 3130 3030 2c20 2023 2045 7863 6565  0o1000,  # Excee
+00027100: 6473 2030 6f37 3737 0a20 2020 2020 2020  ds 0o777.       
+00027110: 2020 2020 202d 312c 2020 2020 2020 2320       -1,      # 
+00027120: 4c65 7373 2074 6861 6e20 306f 3030 300a  Less than 0o000.
+00027130: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00027140: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00027150: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00027160: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
+00027170: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+00027180: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
+00027190: 7368 2866 227b 7365 6c66 2e70 7265 6669  sh(f"{self.prefi
+000271a0: 787d 2f66 696c 6522 2c20 6461 7461 2c20  x}/file", data, 
+000271b0: 7065 726d 6973 7369 6f6e 733d 6261 645f  permissions=bad_
+000271c0: 7065 726d 6973 7369 6f6e 290a 2020 2020  permission).    
+000271d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000271e0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+000271f0: 6e2e 6b69 6e64 2c20 2767 656e 6572 6963  n.kind, 'generic
+00027200: 2d66 696c 652d 6572 726f 7227 290a 0a20  -file-error').. 
+00027210: 2020 2064 6566 2074 6573 745f 7075 7368     def test_push
+00027220: 5f66 696c 6573 5f61 6e64 5f6c 6973 7428  _files_and_list(
+00027230: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00027240: 6174 6120 3d20 2764 6174 6127 0a20 2020  ata = 'data'.   
 00027250: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
-00027260: 6c66 2e63 6c69 656e 740a 2020 2020 2020  lf.client.      
-00027270: 2020 636c 6965 6e74 2e6d 616b 655f 6469    client.make_di
-00027280: 7228 6622 7b73 656c 662e 7072 6566 6978  r(f"{self.prefix
-00027290: 7d2f 7375 6264 6972 2229 0a20 2020 2020  }/subdir").     
-000272a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000272b0: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-000272c0: 2063 6c69 656e 742e 6c69 7374 5f66 696c   client.list_fil
-000272d0: 6573 2866 227b 7365 6c66 2e70 7265 6669  es(f"{self.prefi
-000272e0: 787d 2f22 2c20 7061 7474 6572 6e3d 2773  x}/", pattern='s
-000272f0: 7562 6469 7227 295b 305d 2e70 6174 682c  ubdir')[0].path,
-00027300: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
-00027310: 7365 6c66 2e70 7265 6669 787d 2f73 7562  self.prefix}/sub
-00027320: 6469 7222 290a 2020 2020 2020 2020 636c  dir").        cl
-00027330: 6965 6e74 2e6d 616b 655f 6469 7228 6622  ient.make_dir(f"
-00027340: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
-00027350: 6264 6972 2f73 7562 6469 7222 290a 2020  bdir/subdir").  
-00027360: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00027370: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
-00027380: 2020 2020 636c 6965 6e74 2e6c 6973 745f      client.list_
-00027390: 6669 6c65 7328 6622 7b73 656c 662e 7072  files(f"{self.pr
-000273a0: 6566 6978 7d2f 7375 6264 6972 222c 2070  efix}/subdir", p
-000273b0: 6174 7465 726e 3d27 7375 6264 6972 2729  attern='subdir')
-000273c0: 5b30 5d2e 7061 7468 2c0a 2020 2020 2020  [0].path,.      
-000273d0: 2020 2020 2020 6622 7b73 656c 662e 7072        f"{self.pr
-000273e0: 6566 6978 7d2f 7375 6264 6972 2f73 7562  efix}/subdir/sub
-000273f0: 6469 7222 290a 0a20 2020 2064 6566 2074  dir")..    def t
-00027400: 6573 745f 6d61 6b65 5f64 6972 6563 746f  est_make_directo
-00027410: 7279 5f72 6563 7572 7369 7665 6c79 2873  ry_recursively(s
-00027420: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00027430: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
-00027440: 6e74 0a0a 2020 2020 2020 2020 7769 7468  nt..        with
-00027450: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00027460: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
-00027470: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-00027480: 2020 2020 2020 2020 636c 6965 6e74 2e6d          client.m
-00027490: 616b 655f 6469 7228 6622 7b73 656c 662e  ake_dir(f"{self.
-000274a0: 7072 6566 6978 7d2f 7375 6264 6972 2f73  prefix}/subdir/s
-000274b0: 7562 6469 7222 2c20 6d61 6b65 5f70 6172  ubdir", make_par
-000274c0: 656e 7473 3d46 616c 7365 290a 2020 2020  ents=False).    
-000274d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000274e0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-000274f0: 6e2e 6b69 6e64 2c20 276e 6f74 2d66 6f75  n.kind, 'not-fou
-00027500: 6e64 2729 0a0a 2020 2020 2020 2020 636c  nd')..        cl
-00027510: 6965 6e74 2e6d 616b 655f 6469 7228 6622  ient.make_dir(f"
-00027520: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
-00027530: 6264 6972 2f73 7562 6469 7222 2c20 6d61  bdir/subdir", ma
-00027540: 6b65 5f70 6172 656e 7473 3d54 7275 6529  ke_parents=True)
-00027550: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00027560: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-00027570: 2020 2020 2020 2063 6c69 656e 742e 6c69         client.li
-00027580: 7374 5f66 696c 6573 2866 227b 7365 6c66  st_files(f"{self
-00027590: 2e70 7265 6669 787d 2f73 7562 6469 7222  .prefix}/subdir"
-000275a0: 2c20 7061 7474 6572 6e3d 2773 7562 6469  , pattern='subdi
-000275b0: 7227 295b 305d 2e70 6174 682c 0a20 2020  r')[0].path,.   
-000275c0: 2020 2020 2020 2020 2066 227b 7365 6c66           f"{self
-000275d0: 2e70 7265 6669 787d 2f73 7562 6469 722f  .prefix}/subdir/
-000275e0: 7375 6264 6972 2229 0a0a 2020 2020 6465  subdir")..    de
-000275f0: 6620 7465 7374 5f6d 616b 655f 6469 7265  f test_make_dire
-00027600: 6374 6f72 795f 7769 7468 5f72 656c 6174  ctory_with_relat
-00027610: 6976 655f 7061 7468 5f66 6169 6c73 2873  ive_path_fails(s
-00027620: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00027630: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
-00027640: 6e74 0a20 2020 2020 2020 2077 6974 6820  nt.        with 
-00027650: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00027660: 7328 7065 6262 6c65 2e50 6174 6845 7272  s(pebble.PathErr
-00027670: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-00027680: 2020 2020 2020 2063 6c69 656e 742e 6d61         client.ma
-00027690: 6b65 5f64 6972 2827 6469 7227 290a 2020  ke_dir('dir').  
-000276a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000276b0: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-000276c0: 696f 6e2e 6b69 6e64 2c20 2767 656e 6572  ion.kind, 'gener
-000276d0: 6963 2d66 696c 652d 6572 726f 7227 290a  ic-file-error').
-000276e0: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
-000276f0: 6b65 5f73 7562 6469 725f 6f66 5f66 696c  ke_subdir_of_fil
-00027700: 655f 6661 696c 7328 7365 6c66 293a 0a20  e_fails(self):. 
-00027710: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00027720: 7365 6c66 2e63 6c69 656e 740a 2020 2020  self.client.    
-00027730: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-00027740: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00027750: 6669 6c65 222c 2027 6461 7461 2729 0a0a  file", 'data')..
-00027760: 2020 2020 2020 2020 2320 4469 7265 6374          # Direct
-00027770: 2063 6869 6c64 2063 6173 650a 2020 2020   child case.    
-00027780: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00027790: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
-000277a0: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
-000277b0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-000277c0: 636c 6965 6e74 2e6d 616b 655f 6469 7228  client.make_dir(
-000277d0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-000277e0: 6669 6c65 2f73 7562 6469 7222 290a 2020  file/subdir").  
-000277f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00027800: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-00027810: 696f 6e2e 6b69 6e64 2c20 2767 656e 6572  ion.kind, 'gener
-00027820: 6963 2d66 696c 652d 6572 726f 7227 290a  ic-file-error').
-00027830: 0a20 2020 2020 2020 2023 2052 6563 7572  .        # Recur
-00027840: 7369 7665 2063 7265 6174 696f 6e20 6361  sive creation ca
-00027850: 7365 2c20 696e 2063 6173 6520 6974 7320  se, in case its 
-00027860: 666c 6f77 2069 7320 6469 6666 6572 656e  flow is differen
-00027870: 740a 2020 2020 2020 2020 7769 7468 2073  t.        with s
-00027880: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00027890: 2870 6562 626c 652e 5061 7468 4572 726f  (pebble.PathErro
-000278a0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
-000278b0: 2020 2020 2020 636c 6965 6e74 2e6d 616b        client.mak
-000278c0: 655f 6469 7228 6622 7b73 656c 662e 7072  e_dir(f"{self.pr
-000278d0: 6566 6978 7d2f 6669 6c65 2f73 7562 6469  efix}/file/subdi
-000278e0: 722f 7375 6264 6972 222c 206d 616b 655f  r/subdir", make_
-000278f0: 7061 7265 6e74 733d 5472 7565 290a 2020  parents=True).  
-00027900: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00027910: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-00027920: 696f 6e2e 6b69 6e64 2c20 2767 656e 6572  ion.kind, 'gener
-00027930: 6963 2d66 696c 652d 6572 726f 7227 290a  ic-file-error').
-00027940: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
-00027950: 6b65 5f64 6972 5f77 6974 685f 7065 726d  ke_dir_with_perm
-00027960: 6973 7369 6f6e 5f6d 6173 6b28 7365 6c66  ission_mask(self
-00027970: 293a 0a20 2020 2020 2020 2063 6c69 656e  ):.        clien
-00027980: 7420 3d20 7365 6c66 2e63 6c69 656e 740a  t = self.client.
-00027990: 2020 2020 2020 2020 636c 6965 6e74 2e6d          client.m
-000279a0: 616b 655f 6469 7228 6622 7b73 656c 662e  ake_dir(f"{self.
-000279b0: 7072 6566 6978 7d2f 6469 7231 222c 2070  prefix}/dir1", p
-000279c0: 6572 6d69 7373 696f 6e73 3d30 6f37 3030  ermissions=0o700
-000279d0: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-000279e0: 2e6d 616b 655f 6469 7228 6622 7b73 656c  .make_dir(f"{sel
-000279f0: 662e 7072 6566 6978 7d2f 6469 7232 222c  f.prefix}/dir2",
-00027a00: 2070 6572 6d69 7373 696f 6e73 3d30 6f37   permissions=0o7
-00027a10: 3737 290a 0a20 2020 2020 2020 2066 696c  77)..        fil
-00027a20: 6573 203d 2063 6c69 656e 742e 6c69 7374  es = client.list
-00027a30: 5f66 696c 6573 2866 227b 7365 6c66 2e70  _files(f"{self.p
-00027a40: 7265 6669 787d 2f22 2c20 7061 7474 6572  refix}/", patter
-00027a50: 6e3d 2764 6972 2a27 290a 2020 2020 2020  n='dir*').      
-00027a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00027a70: 616c 285b 6620 666f 7220 6620 696e 2066  al([f for f in f
-00027a80: 696c 6573 2069 6620 662e 7061 7468 203d  iles if f.path =
-00027a90: 3d20 6622 7b73 656c 662e 7072 6566 6978  = f"{self.prefix
-00027aa0: 7d2f 6469 7231 225d 0a20 2020 2020 2020  }/dir1"].       
-00027ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ac0: 2020 5b30 5d2e 7065 726d 6973 7369 6f6e    [0].permission
-00027ad0: 732c 2030 6f37 3030 290a 2020 2020 2020  s, 0o700).      
-00027ae0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00027af0: 616c 285b 6620 666f 7220 6620 696e 2066  al([f for f in f
-00027b00: 696c 6573 2069 6620 662e 7061 7468 203d  iles if f.path =
-00027b10: 3d20 6622 7b73 656c 662e 7072 6566 6978  = f"{self.prefix
-00027b20: 7d2f 6469 7232 225d 0a20 2020 2020 2020  }/dir2"].       
-00027b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027b40: 2020 5b30 5d2e 7065 726d 6973 7369 6f6e    [0].permission
-00027b50: 732c 2030 6f37 3737 290a 0a20 2020 2020  s, 0o777)..     
-00027b60: 2020 2023 2049 6620 7065 726d 6973 7369     # If permissi
-00027b70: 6f6e 7320 6172 6520 6f75 7473 6964 6520  ons are outside 
-00027b80: 6f66 2074 6865 2072 616e 6765 2030 6f30  of the range 0o0
-00027b90: 3030 2074 6872 6f75 6768 2030 6f37 3737  00 through 0o777
-00027ba0: 2c20 616e 2065 7863 6570 7469 6f6e 2073  , an exception s
-00027bb0: 686f 756c 6420 6265 0a20 2020 2020 2020  hould be.       
-00027bc0: 2023 2072 6169 7365 642e 0a20 2020 2020   # raised..     
-00027bd0: 2020 2066 6f72 2069 2c20 6261 645f 7065     for i, bad_pe
-00027be0: 726d 6973 7369 6f6e 2069 6e20 656e 756d  rmission in enum
-00027bf0: 6572 6174 6528 280a 2020 2020 2020 2020  erate((.        
-00027c00: 2020 2020 306f 3130 3030 2c20 2023 2045      0o1000,  # E
-00027c10: 7863 6565 6473 2030 6f37 3737 0a20 2020  xceeds 0o777.   
-00027c20: 2020 2020 2020 2020 202d 312c 2020 2020           -1,    
-00027c30: 2020 2320 4c65 7373 2074 6861 6e20 306f    # Less than 0o
-00027c40: 3030 300a 2020 2020 2020 2020 2929 3a0a  000.        )):.
-00027c50: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00027c60: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00027c70: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
-00027c80: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-00027c90: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-00027ca0: 6e74 2e6d 616b 655f 6469 7228 6622 7b73  nt.make_dir(f"{s
-00027cb0: 656c 662e 7072 6566 6978 7d2f 6469 7233  elf.prefix}/dir3
-00027cc0: 5f7b 697d 222c 2070 6572 6d69 7373 696f  _{i}", permissio
-00027cd0: 6e73 3d62 6164 5f70 6572 6d69 7373 696f  ns=bad_permissio
-00027ce0: 6e29 0a20 2020 2020 2020 2020 2020 2073  n).            s
-00027cf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00027d00: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
-00027d10: 642c 2027 6765 6e65 7269 632d 6669 6c65  d, 'generic-file
-00027d20: 2d65 7272 6f72 2729 0a0a 2020 2020 6465  -error')..    de
-00027d30: 6620 7465 7374 5f72 656d 6f76 655f 7061  f test_remove_pa
-00027d40: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
-00027d50: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00027d60: 636c 6965 6e74 0a20 2020 2020 2020 2063  client.        c
-00027d70: 6c69 656e 742e 7075 7368 2866 227b 7365  lient.push(f"{se
-00027d80: 6c66 2e70 7265 6669 787d 2f66 696c 6522  lf.prefix}/file"
-00027d90: 2c20 2727 290a 2020 2020 2020 2020 636c  , '').        cl
-00027da0: 6965 6e74 2e6d 616b 655f 6469 7228 6622  ient.make_dir(f"
-00027db0: 7b73 656c 662e 7072 6566 6978 7d2f 6469  {self.prefix}/di
-00027dc0: 722f 7375 6264 6972 222c 206d 616b 655f  r/subdir", make_
-00027dd0: 7061 7265 6e74 733d 5472 7565 290a 2020  parents=True).  
-00027de0: 2020 2020 2020 636c 6965 6e74 2e70 7573        client.pus
-00027df0: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
-00027e00: 7d2f 6469 722f 7375 6264 6972 2f66 696c  }/dir/subdir/fil
-00027e10: 6531 222c 2027 2729 0a20 2020 2020 2020  e1", '').       
-00027e20: 2063 6c69 656e 742e 7075 7368 2866 227b   client.push(f"{
-00027e30: 7365 6c66 2e70 7265 6669 787d 2f64 6972  self.prefix}/dir
-00027e40: 2f73 7562 6469 722f 6669 6c65 3222 2c20  /subdir/file2", 
-00027e50: 2727 290a 2020 2020 2020 2020 636c 6965  '').        clie
-00027e60: 6e74 2e70 7573 6828 6622 7b73 656c 662e  nt.push(f"{self.
-00027e70: 7072 6566 6978 7d2f 6469 722f 7375 6264  prefix}/dir/subd
-00027e80: 6972 2f66 696c 6533 222c 2027 2729 0a20  ir/file3", ''). 
-00027e90: 2020 2020 2020 2063 6c69 656e 742e 6d61         client.ma
-00027ea0: 6b65 5f64 6972 2866 227b 7365 6c66 2e70  ke_dir(f"{self.p
-00027eb0: 7265 6669 787d 2f65 6d70 7479 5f64 6972  refix}/empty_dir
-00027ec0: 2229 0a0a 2020 2020 2020 2020 636c 6965  ")..        clie
-00027ed0: 6e74 2e72 656d 6f76 655f 7061 7468 2866  nt.remove_path(f
-00027ee0: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-00027ef0: 696c 6522 290a 0a20 2020 2020 2020 2063  ile")..        c
-00027f00: 6c69 656e 742e 7265 6d6f 7665 5f70 6174  lient.remove_pat
-00027f10: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
-00027f20: 7d2f 656d 7074 795f 6469 7222 290a 0a20  }/empty_dir").. 
-00027f30: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
-00027f40: 6e6f 6e2d 656d 7074 7920 6469 7265 6374  non-empty direct
-00027f50: 6f72 792c 2072 6563 7572 7369 7665 3d46  ory, recursive=F
-00027f60: 616c 7365 3a20 6572 726f 720a 2020 2020  alse: error.    
-00027f70: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00027f80: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
-00027f90: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
-00027fa0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-00027fb0: 636c 6965 6e74 2e72 656d 6f76 655f 7061  client.remove_pa
-00027fc0: 7468 2866 227b 7365 6c66 2e70 7265 6669  th(f"{self.prefi
-00027fd0: 787d 2f64 6972 222c 2072 6563 7572 7369  x}/dir", recursi
-00027fe0: 7665 3d46 616c 7365 290a 2020 2020 2020  ve=False).      
-00027ff0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00028000: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00028010: 6b69 6e64 2c20 2767 656e 6572 6963 2d66  kind, 'generic-f
-00028020: 696c 652d 6572 726f 7227 290a 0a20 2020  ile-error')..   
-00028030: 2020 2020 2023 2052 656d 6f76 6520 6e6f       # Remove no
-00028040: 6e2d 656d 7074 7920 6469 7265 6374 6f72  n-empty director
-00028050: 792c 2072 6563 7572 7369 7665 3d54 7275  y, recursive=Tru
-00028060: 653a 2073 7563 6365 6564 7320 2861 6e64  e: succeeds (and
-00028070: 2072 656d 6f76 6573 2063 6869 6c64 206f   removes child o
-00028080: 626a 6563 7473 290a 2020 2020 2020 2020  bjects).        
-00028090: 636c 6965 6e74 2e72 656d 6f76 655f 7061  client.remove_pa
-000280a0: 7468 2866 227b 7365 6c66 2e70 7265 6669  th(f"{self.prefi
-000280b0: 787d 2f64 6972 222c 2072 6563 7572 7369  x}/dir", recursi
-000280c0: 7665 3d54 7275 6529 0a0a 2020 2020 2020  ve=True)..      
-000280d0: 2020 2320 5265 6d6f 7665 206e 6f6e 2d65    # Remove non-e
-000280e0: 7869 7374 656e 7420 7061 7468 2c20 7265  xistent path, re
-000280f0: 6375 7273 6976 653d 4661 6c73 653a 2065  cursive=False: e
-00028100: 7272 6f72 0a20 2020 2020 2020 2077 6974  rror.        wit
-00028110: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00028120: 7365 7328 7065 6262 6c65 2e50 6174 6845  ses(pebble.PathE
-00028130: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00028140: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
-00028150: 7265 6d6f 7665 5f70 6174 6828 6622 7b73  remove_path(f"{s
-00028160: 656c 662e 7072 6566 6978 7d2f 6469 722f  elf.prefix}/dir/
-00028170: 646f 6573 2f6e 6f74 2f65 7869 7374 2f61  does/not/exist/a
-00028180: 7364 6622 2c20 7265 6375 7273 6976 653d  sdf", recursive=
-00028190: 4661 6c73 6529 0a20 2020 2020 2020 2073  False).        s
-000281a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000281b0: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
-000281c0: 642c 2027 6e6f 742d 666f 756e 6427 290a  d, 'not-found').
-000281d0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-000281e0: 6520 6e6f 6e2d 6578 6973 7465 6e74 2070  e non-existent p
-000281f0: 6174 682c 2072 6563 7572 7369 7665 3d54  ath, recursive=T
-00028200: 7275 653a 2073 7563 6365 6564 730a 2020  rue: succeeds.  
-00028210: 2020 2020 2020 636c 6965 6e74 2e72 656d        client.rem
-00028220: 6f76 655f 7061 7468 2866 227b 7365 6c66  ove_path(f"{self
-00028230: 2e70 7265 6669 787d 2f64 6972 2f64 6f65  .prefix}/dir/doe
-00028240: 732f 6e6f 742f 6578 6973 742f 6173 6466  s/not/exist/asdf
-00028250: 222c 2072 6563 7572 7369 7665 3d54 7275  ", recursive=Tru
-00028260: 6529 0a0a 2020 2020 2320 4f74 6865 7220  e)..    # Other 
-00028270: 6e6f 7465 733a 0a20 2020 2023 202a 2050  notes:.    # * P
-00028280: 6172 656e 7420 6469 7265 6374 6f72 6965  arent directorie
-00028290: 7320 6372 6561 7465 6420 7669 6120 7075  s created via pu
-000282a0: 7368 286d 616b 655f 6469 7273 3d54 7275  sh(make_dirs=Tru
-000282b0: 6529 2064 6566 6175 6c74 2074 6f20 726f  e) default to ro
-000282c0: 6f74 3a72 6f6f 7420 6f77 6e65 7273 6869  ot:root ownershi
-000282d0: 700a 2020 2020 2320 2020 616e 6420 7768  p.    #   and wh
-000282e0: 6174 6576 6572 2070 6572 6d69 7373 696f  atever permissio
-000282f0: 6e73 2061 7265 2073 7065 6369 6669 6564  ns are specified
-00028300: 2076 6961 2074 6865 2070 6572 6d69 7373   via the permiss
-00028310: 696f 6e73 2061 7267 756d 656e 743b 2061  ions argument; a
-00028320: 7320 7765 2064 6566 6175 6c74 2074 6f20  s we default to 
-00028330: 4e6f 6e65 0a20 2020 2023 2020 2066 6f72  None.    #   for
-00028340: 206f 776e 6572 7368 6970 2f70 6572 6d69   ownership/permi
-00028350: 7373 696f 6e73 2c20 7765 2064 6f20 6967  ssions, we do ig
-00028360: 6e6f 7265 2074 6869 7320 6e75 616e 6365  nore this nuance
-00028370: 2e0a 2020 2020 2320 2a20 5061 7265 6e74  ..    # * Parent
-00028380: 2064 6972 6563 746f 7269 6573 2063 7265   directories cre
-00028390: 6174 6564 2076 6961 206d 616b 655f 6469  ated via make_di
-000283a0: 7228 6d61 6b65 5f70 6172 656e 7473 3d54  r(make_parents=T
-000283b0: 7275 6529 2064 6566 6175 6c74 2074 6f20  rue) default to 
-000283c0: 726f 6f74 3a72 6f6f 7420 6f77 6e65 7273  root:root owners
-000283d0: 6869 700a 2020 2020 2320 2020 616e 6420  hip.    #   and 
-000283e0: 306f 3735 3520 7065 726d 6973 7369 6f6e  0o755 permission
-000283f0: 733b 2061 7320 7765 2064 6566 6175 6c74  s; as we default
-00028400: 2074 6f20 4e6f 6e65 2066 6f72 206f 776e   to None for own
-00028410: 6572 7368 6970 2f70 6572 6d69 7373 696f  ership/permissio
-00028420: 6e73 2c20 7765 2064 6f20 6967 6e6f 7265  ns, we do ignore
-00028430: 2074 6869 730a 2020 2020 2320 2020 6e75   this.    #   nu
-00028440: 616e 6365 2e0a 0a0a 636c 6173 7320 4765  ance....class Ge
-00028450: 6e65 7269 6354 6573 7469 6e67 4669 6c65  nericTestingFile
-00028460: 7379 7374 656d 5465 7374 733a 0a20 2020  systemTests:.   
-00028470: 2064 6566 2074 6573 745f 6c69 7374 6469   def test_listdi
-00028480: 725f 726f 6f74 5f6f 6e5f 656d 7074 795f  r_root_on_empty_
-00028490: 6f73 2873 656c 6629 3a0a 2020 2020 2020  os(self):.      
-000284a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000284b0: 616c 2873 656c 662e 6673 2e6c 6973 745f  al(self.fs.list_
-000284c0: 6469 7228 272f 2729 2c20 5b5d 290a 0a20  dir('/'), []).. 
-000284d0: 2020 2064 6566 2074 6573 745f 6c69 7374     def test_list
-000284e0: 6469 725f 6f6e 5f6e 6f6e 6578 6973 7465  dir_on_nonexiste
-000284f0: 6e74 5f64 6972 2873 656c 6629 3a0a 2020  nt_dir(self):.  
-00028500: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00028510: 6173 7365 7274 5261 6973 6573 2846 696c  assertRaises(Fil
-00028520: 654e 6f74 466f 756e 6445 7272 6f72 2920  eNotFoundError) 
-00028530: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00028540: 2020 2073 656c 662e 6673 2e6c 6973 745f     self.fs.list_
-00028550: 6469 7228 272f 6574 6327 290a 2020 2020  dir('/etc').    
-00028560: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00028570: 7275 6528 272f 6574 6327 2069 6e20 636d  rue('/etc' in cm
-00028580: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
-00028590: 305d 290a 0a20 2020 2064 6566 2074 6573  0])..    def tes
-000285a0: 745f 6c69 7374 6469 7228 7365 6c66 293a  t_listdir(self):
-000285b0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-000285c0: 2e63 7265 6174 655f 6469 7228 272f 6f70  .create_dir('/op
-000285d0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-000285e0: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
-000285f0: 272f 6f70 742f 6669 6c65 3127 2c20 2764  '/opt/file1', 'd
-00028600: 6174 6127 290a 2020 2020 2020 2020 7365  ata').        se
-00028610: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00028620: 6528 272f 6f70 742f 6669 6c65 3227 2c20  e('/opt/file2', 
-00028630: 2764 6174 6127 290a 2020 2020 2020 2020  'data').        
-00028640: 6578 7065 6374 6564 5f72 6573 756c 7473  expected_results
-00028650: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00028660: 2070 6174 686c 6962 2e50 7572 6550 6f73   pathlib.PurePos
-00028670: 6978 5061 7468 2827 2f6f 7074 2f66 696c  ixPath('/opt/fil
-00028680: 6531 2729 2c0a 2020 2020 2020 2020 2020  e1'),.          
-00028690: 2020 7061 7468 6c69 622e 5075 7265 506f    pathlib.PurePo
-000286a0: 7369 7850 6174 6828 272f 6f70 742f 6669  sixPath('/opt/fi
-000286b0: 6c65 3227 297d 0a20 2020 2020 2020 2073  le2')}.        s
-000286c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000286d0: 6578 7065 6374 6564 5f72 6573 756c 7473  expected_results
-000286e0: 2c20 7b66 2e70 6174 6820 666f 7220 6620  , {f.path for f 
-000286f0: 696e 2073 656c 662e 6673 2e6c 6973 745f  in self.fs.list_
-00028700: 6469 7228 272f 6f70 7427 297d 290a 2020  dir('/opt')}).  
-00028710: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-00028720: 6861 7420 5061 7468 7320 616c 736f 2077  hat Paths also w
-00028730: 6f72 6b20 666f 7220 6c69 7374 6469 720a  ork for listdir.
-00028740: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00028750: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-00028760: 2020 2020 2020 6578 7065 6374 6564 5f72        expected_r
-00028770: 6573 756c 7473 2c20 7b66 2e70 6174 6820  esults, {f.path 
-00028780: 666f 7220 6620 696e 2073 656c 662e 6673  for f in self.fs
-00028790: 2e6c 6973 745f 6469 7228 7061 7468 6c69  .list_dir(pathli
-000287a0: 622e 5075 7265 506f 7369 7850 6174 6828  b.PurePosixPath(
-000287b0: 272f 6f70 7427 2929 7d29 0a0a 2020 2020  '/opt'))})..    
-000287c0: 6465 6620 7465 7374 5f6c 6973 7464 6972  def test_listdir
-000287d0: 5f6f 6e5f 6669 6c65 2873 656c 6629 3a0a  _on_file(self):.
-000287e0: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
-000287f0: 6372 6561 7465 5f66 696c 6528 272f 6669  create_file('/fi
-00028800: 6c65 272c 2027 6461 7461 2729 0a20 2020  le', 'data').   
-00028810: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00028820: 7373 6572 7452 6169 7365 7328 4e6f 7441  ssertRaises(NotA
-00028830: 4469 7265 6374 6f72 7945 7272 6f72 2920  DirectoryError) 
-00028840: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00028850: 2020 2073 656c 662e 6673 2e6c 6973 745f     self.fs.list_
-00028860: 6469 7228 272f 6669 6c65 2729 0a20 2020  dir('/file').   
-00028870: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00028880: 5472 7565 2827 2f66 696c 6527 2069 6e20  True('/file' in 
-00028890: 636d 2e65 7863 6570 7469 6f6e 2e61 7267  cm.exception.arg
-000288a0: 735b 305d 290a 0a20 2020 2064 6566 2074  s[0])..    def t
-000288b0: 6573 745f 6d61 6b65 6469 7228 7365 6c66  est_makedir(self
-000288c0: 293a 0a20 2020 2020 2020 2064 203d 2073  ):.        d = s
-000288d0: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-000288e0: 7228 272f 6574 6327 290a 2020 2020 2020  r('/etc').      
-000288f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00028900: 616c 2864 2e6e 616d 652c 2027 6574 6327  al(d.name, 'etc'
-00028910: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00028920: 7373 6572 7445 7175 616c 2864 2e70 6174  ssertEqual(d.pat
-00028930: 682c 2070 6174 686c 6962 2e50 7572 6550  h, pathlib.PureP
-00028940: 6f73 6978 5061 7468 2827 2f65 7463 2729  osixPath('/etc')
-00028950: 290a 2020 2020 2020 2020 6432 203d 2073  ).        d2 = s
-00028960: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00028970: 7228 272f 6574 632f 696e 6974 2e64 2729  r('/etc/init.d')
-00028980: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00028990: 7365 7274 4571 7561 6c28 6432 2e6e 616d  sertEqual(d2.nam
-000289a0: 652c 2027 696e 6974 2e64 2729 0a20 2020  e, 'init.d').   
-000289b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000289c0: 4571 7561 6c28 6432 2e70 6174 682c 2070  Equal(d2.path, p
-000289d0: 6174 686c 6962 2e50 7572 6550 6f73 6978  athlib.PurePosix
-000289e0: 5061 7468 2827 2f65 7463 2f69 6e69 742e  Path('/etc/init.
-000289f0: 6427 2929 0a0a 2020 2020 6465 6620 7465  d'))..    def te
-00028a00: 7374 5f6d 616b 6564 6972 5f66 6169 6c73  st_makedir_fails
-00028a10: 5f69 665f 616c 7265 6164 795f 6578 6973  _if_already_exis
-00028a20: 7473 2873 656c 6629 3a0a 2020 2020 2020  ts(self):.      
-00028a30: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-00028a40: 5f64 6972 2827 2f65 7463 2729 0a20 2020  _dir('/etc').   
-00028a50: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00028a60: 7373 6572 7452 6169 7365 7328 4669 6c65  ssertRaises(File
-00028a70: 4578 6973 7473 4572 726f 7229 2061 7320  ExistsError) as 
-00028a80: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-00028a90: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00028aa0: 6972 2827 2f65 7463 2729 0a20 2020 2020  ir('/etc').     
-00028ab0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00028ac0: 7565 2827 2f65 7463 2720 696e 2063 6d2e  ue('/etc' in cm.
-00028ad0: 6578 6365 7074 696f 6e2e 6172 6773 5b30  exception.args[0
-00028ae0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00028af0: 5f6d 616b 6564 6972 5f73 7563 6365 6564  _makedir_succeed
-00028b00: 735f 6966 5f61 6c72 6561 6479 5f65 7869  s_if_already_exi
-00028b10: 7374 735f 7768 656e 5f6d 616b 655f 7061  sts_when_make_pa
-00028b20: 7265 6e74 735f 7472 7565 2873 656c 6629  rents_true(self)
-00028b30: 3a0a 2020 2020 2020 2020 6431 203d 2073  :.        d1 = s
-00028b40: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00028b50: 7228 272f 6574 6327 290a 2020 2020 2020  r('/etc').      
-00028b60: 2020 6432 203d 2073 656c 662e 6673 2e63    d2 = self.fs.c
-00028b70: 7265 6174 655f 6469 7228 272f 6574 6327  reate_dir('/etc'
-00028b80: 2c20 6d61 6b65 5f70 6172 656e 7473 3d54  , make_parents=T
-00028b90: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-00028ba0: 662e 6173 7365 7274 4571 7561 6c28 6431  f.assertEqual(d1
-00028bb0: 2e70 6174 682c 2064 322e 7061 7468 290a  .path, d2.path).
-00028bc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00028bd0: 6572 7445 7175 616c 2864 312e 6e61 6d65  ertEqual(d1.name
-00028be0: 2c20 6432 2e6e 616d 6529 0a0a 2020 2020  , d2.name)..    
-00028bf0: 6465 6620 7465 7374 5f6d 616b 6564 6972  def test_makedir
-00028c00: 5f66 6169 6c73 5f69 665f 7061 7265 6e74  _fails_if_parent
-00028c10: 5f64 6972 5f64 6f65 736e 745f 6578 6973  _dir_doesnt_exis
-00028c20: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00028c30: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00028c40: 7452 6169 7365 7328 4669 6c65 4e6f 7446  tRaises(FileNotF
-00028c50: 6f75 6e64 4572 726f 7229 2061 7320 636d  oundError) as cm
-00028c60: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00028c70: 6c66 2e66 732e 6372 6561 7465 5f64 6972  lf.fs.create_dir
-00028c80: 2827 2f65 7463 2f69 6e69 742e 6427 290a  ('/etc/init.d').
-00028c90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00028ca0: 6572 7454 7275 6528 272f 6574 6327 2069  ertTrue('/etc' i
-00028cb0: 6e20 636d 2e65 7863 6570 7469 6f6e 2e61  n cm.exception.a
-00028cc0: 7267 735b 305d 290a 0a20 2020 2064 6566  rgs[0])..    def
-00028cd0: 2074 6573 745f 6d61 6b65 5f61 6e64 5f6c   test_make_and_l
-00028ce0: 6973 745f 6469 7265 6374 6f72 7928 7365  ist_directory(se
-00028cf0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00028d00: 662e 6673 2e63 7265 6174 655f 6469 7228  f.fs.create_dir(
-00028d10: 272f 6574 6327 290a 2020 2020 2020 2020  '/etc').        
-00028d20: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00028d30: 6972 2827 2f76 6172 2729 0a20 2020 2020  ir('/var').     
-00028d40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00028d50: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-00028d60: 207b 662e 7061 7468 2066 6f72 2066 2069   {f.path for f i
-00028d70: 6e20 7365 6c66 2e66 732e 6c69 7374 5f64  n self.fs.list_d
-00028d80: 6972 2827 2f27 297d 2c0a 2020 2020 2020  ir('/')},.      
-00028d90: 2020 2020 2020 7b70 6174 686c 6962 2e50        {pathlib.P
-00028da0: 7572 6550 6f73 6978 5061 7468 2827 2f65  urePosixPath('/e
-00028db0: 7463 2729 2c20 7061 7468 6c69 622e 5075  tc'), pathlib.Pu
-00028dc0: 7265 506f 7369 7850 6174 6828 272f 7661  rePosixPath('/va
-00028dd0: 7227 297d 290a 0a20 2020 2064 6566 2074  r')})..    def t
-00028de0: 6573 745f 6d61 6b65 5f64 6972 6563 746f  est_make_directo
-00028df0: 7279 5f72 6563 7572 7369 7665 6c79 2873  ry_recursively(s
-00028e00: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00028e10: 6c66 2e66 732e 6372 6561 7465 5f64 6972  lf.fs.create_dir
-00028e20: 2827 2f65 7463 2f69 6e69 742e 6427 2c20  ('/etc/init.d', 
-00028e30: 6d61 6b65 5f70 6172 656e 7473 3d54 7275  make_parents=Tru
-00028e40: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00028e50: 6173 7365 7274 4571 7561 6c28 5b73 7472  assertEqual([str
-00028e60: 286f 2e70 6174 6829 2066 6f72 206f 2069  (o.path) for o i
-00028e70: 6e20 7365 6c66 2e66 732e 6c69 7374 5f64  n self.fs.list_d
-00028e80: 6972 2827 2f27 295d 2c20 5b27 2f65 7463  ir('/')], ['/etc
-00028e90: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
-00028ea0: 2e61 7373 6572 7445 7175 616c 285b 7374  .assertEqual([st
-00028eb0: 7228 6f2e 7061 7468 2920 666f 7220 6f20  r(o.path) for o 
-00028ec0: 696e 2073 656c 662e 6673 2e6c 6973 745f  in self.fs.list_
-00028ed0: 6469 7228 272f 6574 6327 295d 2c20 5b27  dir('/etc')], ['
-00028ee0: 2f65 7463 2f69 6e69 742e 6427 5d29 0a0a  /etc/init.d'])..
-00028ef0: 2020 2020 6465 6620 7465 7374 5f6d 616b      def test_mak
-00028f00: 6564 6972 5f70 6174 685f 6d75 7374 5f73  edir_path_must_s
-00028f10: 7461 7274 5f77 6974 685f 736c 6173 6828  tart_with_slash(
-00028f20: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00028f30: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00028f40: 6169 7365 7328 4e6f 6e41 6273 6f6c 7574  aises(NonAbsolut
-00028f50: 6550 6174 6845 7272 6f72 293a 0a20 2020  ePathError):.   
-00028f60: 2020 2020 2020 2020 2073 656c 662e 6673           self.fs
-00028f70: 2e63 7265 6174 655f 6469 7228 226e 6f73  .create_dir("nos
-00028f80: 6c61 7368 2229 0a0a 2020 2020 6465 6620  lash")..    def 
-00028f90: 7465 7374 5f63 7265 6174 655f 6669 6c65  test_create_file
-00028fa0: 5f66 6169 6c73 5f69 665f 7061 7265 6e74  _fails_if_parent
-00028fb0: 5f64 6972 5f64 6f65 736e 745f 6578 6973  _dir_doesnt_exis
-00028fc0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00028fd0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00028fe0: 7452 6169 7365 7328 4669 6c65 4e6f 7446  tRaises(FileNotF
-00028ff0: 6f75 6e64 4572 726f 7229 2061 7320 636d  oundError) as cm
-00029000: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00029010: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00029020: 6528 272f 6574 632f 7061 7373 7764 272c  e('/etc/passwd',
-00029030: 2022 666f 6f22 290a 2020 2020 2020 2020   "foo").        
-00029040: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00029050: 272f 6574 6327 2069 6e20 636d 2e65 7863  '/etc' in cm.exc
-00029060: 6570 7469 6f6e 2e61 7267 735b 305d 290a  eption.args[0]).
-00029070: 0a20 2020 2064 6566 2074 6573 745f 6372  .    def test_cr
-00029080: 6561 7465 5f66 696c 655f 7375 6363 6565  eate_file_succee
-00029090: 6473 5f69 665f 7061 7265 6e74 5f64 6972  ds_if_parent_dir
-000290a0: 5f64 6f65 736e 745f 6578 6973 745f 7768  _doesnt_exist_wh
-000290b0: 656e 5f6d 616b 655f 6469 7273 5f74 7275  en_make_dirs_tru
-000290c0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-000290d0: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-000290e0: 6669 6c65 2827 2f74 6573 742f 7375 6264  file('/test/subd
-000290f0: 6972 2f74 6573 7466 696c 6527 2c20 2266  ir/testfile', "f
-00029100: 6f6f 222c 206d 616b 655f 6469 7273 3d54  oo", make_dirs=T
-00029110: 7275 6529 0a20 2020 2020 2020 2077 6974  rue).        wit
-00029120: 6820 7365 6c66 2e66 732e 6f70 656e 2827  h self.fs.open('
-00029130: 2f74 6573 742f 7375 6264 6972 2f74 6573  /test/subdir/tes
-00029140: 7466 696c 6527 2920 6173 2069 6e66 696c  tfile') as infil
-00029150: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00029160: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00029170: 696e 6669 6c65 2e72 6561 6428 292c 2027  infile.read(), '
-00029180: 666f 6f27 290a 0a20 2020 2064 6566 2074  foo')..    def t
-00029190: 6573 745f 6372 6561 7465 5f66 696c 655f  est_create_file_
-000291a0: 6672 6f6d 5f73 7472 2873 656c 6629 3a0a  from_str(self):.
-000291b0: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
-000291c0: 6372 6561 7465 5f66 696c 6528 272f 7465  create_file('/te
-000291d0: 7374 272c 2022 666f 6f22 290a 2020 2020  st', "foo").    
-000291e0: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
-000291f0: 2e6f 7065 6e28 272f 7465 7374 2729 2061  .open('/test') a
-00029200: 7320 696e 6669 6c65 3a0a 2020 2020 2020  s infile:.      
-00029210: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00029220: 7445 7175 616c 2869 6e66 696c 652e 7265  tEqual(infile.re
-00029230: 6164 2829 2c20 2766 6f6f 2729 0a0a 2020  ad(), 'foo')..  
-00029240: 2020 6465 6620 7465 7374 5f63 7265 6174    def test_creat
-00029250: 655f 6669 6c65 5f66 726f 6d5f 6279 7465  e_file_from_byte
-00029260: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00029270: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00029280: 6669 6c65 2827 2f74 6573 7427 2c20 6222  file('/test', b"
-00029290: 666f 6f22 290a 2020 2020 2020 2020 7769  foo").        wi
-000292a0: 7468 2073 656c 662e 6673 2e6f 7065 6e28  th self.fs.open(
-000292b0: 272f 7465 7374 272c 2065 6e63 6f64 696e  '/test', encodin
-000292c0: 673d 4e6f 6e65 2920 6173 2069 6e66 696c  g=None) as infil
-000292d0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000292e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000292f0: 696e 6669 6c65 2e72 6561 6428 292c 2062  infile.read(), b
-00029300: 2766 6f6f 2729 0a0a 2020 2020 6465 6620  'foo')..    def 
-00029310: 7465 7374 5f63 7265 6174 655f 6669 6c65  test_create_file
-00029320: 5f66 726f 6d5f 6669 6c65 7328 7365 6c66  _from_files(self
-00029330: 293a 0a20 2020 2020 2020 2064 6174 6120  ):.        data 
-00029340: 3d20 2266 6f6f 220a 0a20 2020 2020 2020  = "foo"..       
-00029350: 2073 696f 203d 2053 7472 696e 6749 4f28   sio = StringIO(
-00029360: 6461 7461 290a 2020 2020 2020 2020 7365  data).        se
-00029370: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00029380: 6528 272f 7465 7374 272c 2073 696f 290a  e('/test', sio).
-00029390: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000293a0: 662e 6673 2e6f 7065 6e28 272f 7465 7374  f.fs.open('/test
-000293b0: 2729 2061 7320 696e 6669 6c65 3a0a 2020  ') as infile:.  
-000293c0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-000293d0: 7373 6572 7445 7175 616c 2869 6e66 696c  ssertEqual(infil
-000293e0: 652e 7265 6164 2829 2c20 2766 6f6f 2729  e.read(), 'foo')
-000293f0: 0a0a 2020 2020 2020 2020 6269 6f20 3d20  ..        bio = 
-00029400: 4279 7465 7349 4f28 6461 7461 2e65 6e63  BytesIO(data.enc
-00029410: 6f64 6528 2929 0a20 2020 2020 2020 2073  ode()).        s
-00029420: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-00029430: 6c65 2827 2f74 6573 7432 272c 2062 696f  le('/test2', bio
-00029440: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00029450: 656c 662e 6673 2e6f 7065 6e28 272f 7465  elf.fs.open('/te
-00029460: 7374 3227 2920 6173 2069 6e66 696c 653a  st2') as infile:
-00029470: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00029480: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-00029490: 6669 6c65 2e72 6561 6428 292c 2027 666f  file.read(), 'fo
-000294a0: 6f27 290a 0a20 2020 2064 6566 2074 6573  o')..    def tes
-000294b0: 745f 6372 6561 7465 5f61 6e64 5f72 6561  t_create_and_rea
-000294c0: 645f 7769 7468 5f64 6966 6665 7265 6e74  d_with_different
-000294d0: 5f65 6e63 6f64 696e 6773 2873 656c 6629  _encodings(self)
-000294e0: 3a0a 2020 2020 2020 2020 2320 7772 6974  :.        # writ
-000294f0: 6520 7374 722c 2072 6561 6420 6173 2075  e str, read as u
-00029500: 7466 2d38 2062 7974 6573 0a20 2020 2020  tf-8 bytes.     
-00029510: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
-00029520: 655f 6669 6c65 2827 2f74 6573 7427 2c20  e_file('/test', 
-00029530: 2266 6f6f 2229 0a20 2020 2020 2020 2077  "foo").        w
-00029540: 6974 6820 7365 6c66 2e66 732e 6f70 656e  ith self.fs.open
-00029550: 2827 2f74 6573 7427 2c20 656e 636f 6469  ('/test', encodi
-00029560: 6e67 3d4e 6f6e 6529 2061 7320 696e 6669  ng=None) as infi
-00029570: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00029580: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00029590: 2869 6e66 696c 652e 7265 6164 2829 2c20  (infile.read(), 
-000295a0: 6227 666f 6f27 290a 0a20 2020 2020 2020  b'foo')..       
-000295b0: 2023 2077 7269 7465 2062 7974 6573 2c20   # write bytes, 
-000295c0: 7265 6164 2061 7320 7574 662d 382d 6465  read as utf-8-de
-000295d0: 636f 6465 6420 7374 720a 2020 2020 2020  coded str.      
-000295e0: 2020 6461 7461 203d 2022 e697 a5e6 9cac    data = "......
-000295f0: e8aa 9e22 2020 2320 4a61 7061 6e65 7365  ..."  # Japanese
-00029600: 2066 6f72 2022 4a61 7061 6e65 7365 220a   for "Japanese".
-00029610: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
-00029620: 6372 6561 7465 5f66 696c 6528 272f 7465  create_file('/te
-00029630: 7374 3227 2c20 6461 7461 2e65 6e63 6f64  st2', data.encod
-00029640: 6528 2775 7466 2d38 2729 290a 2020 2020  e('utf-8')).    
-00029650: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
-00029660: 2e6f 7065 6e28 272f 7465 7374 3227 2920  .open('/test2') 
-00029670: 6173 2069 6e66 696c 653a 2020 2020 2020  as infile:      
-00029680: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00029690: 496d 706c 6963 6974 2075 7466 2d38 2072  Implicit utf-8 r
-000296a0: 6561 640a 2020 2020 2020 2020 2020 2020  ead.            
-000296b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000296c0: 2869 6e66 696c 652e 7265 6164 2829 2c20  (infile.read(), 
-000296d0: 6461 7461 290a 2020 2020 2020 2020 7769  data).        wi
-000296e0: 7468 2073 656c 662e 6673 2e6f 7065 6e28  th self.fs.open(
-000296f0: 272f 7465 7374 3227 2c20 656e 636f 6469  '/test2', encodi
-00029700: 6e67 3d27 7574 662d 3827 2920 6173 2069  ng='utf-8') as i
-00029710: 6e66 696c 653a 2020 2320 4578 706c 6963  nfile:  # Explic
-00029720: 6974 2075 7466 2d38 2072 6561 640a 2020  it utf-8 read.  
-00029730: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00029740: 7373 6572 7445 7175 616c 2869 6e66 696c  ssertEqual(infil
-00029750: 652e 7265 6164 2829 2c20 6461 7461 290a  e.read(), data).
-00029760: 0a20 2020 2064 6566 2074 6573 745f 6f70  .    def test_op
-00029770: 656e 5f64 6972 6563 746f 7279 5f66 6169  en_directory_fai
-00029780: 6c73 2873 656c 6629 3a0a 2020 2020 2020  ls(self):.      
-00029790: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-000297a0: 5f64 6972 2827 2f64 6972 3127 290a 2020  _dir('/dir1').  
-000297b0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000297c0: 6173 7365 7274 5261 6973 6573 2849 7341  assertRaises(IsA
-000297d0: 4469 7265 6374 6f72 7945 7272 6f72 2920  DirectoryError) 
-000297e0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-000297f0: 2020 2073 656c 662e 6673 2e6f 7065 6e28     self.fs.open(
-00029800: 272f 6469 7231 2729 0a20 2020 2020 2020  '/dir1').       
-00029810: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00029820: 6c28 636d 2e65 7863 6570 7469 6f6e 2e61  l(cm.exception.a
-00029830: 7267 735b 305d 2c20 272f 6469 7231 2729  rgs[0], '/dir1')
-00029840: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
-00029850: 656c 6574 655f 6669 6c65 2873 656c 6629  elete_file(self)
-00029860: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-00029870: 732e 6372 6561 7465 5f66 696c 6528 272f  s.create_file('/
-00029880: 7465 7374 272c 2022 666f 6f22 290a 2020  test', "foo").  
-00029890: 2020 2020 2020 7365 6c66 2e66 732e 6465        self.fs.de
-000298a0: 6c65 7465 5f70 6174 6828 272f 7465 7374  lete_path('/test
-000298b0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-000298c0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000298d0: 7328 4669 6c65 4e6f 7446 6f75 6e64 4572  s(FileNotFoundEr
-000298e0: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-000298f0: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
-00029900: 6765 745f 7061 7468 2827 2f74 6573 7427  get_path('/test'
-00029910: 290a 0a20 2020 2020 2020 2023 2044 656c  )..        # Del
-00029920: 6574 696e 6720 6465 6c65 7465 6420 6669  eting deleted fi
-00029930: 6c65 7320 7368 6f75 6c64 2066 6169 6c20  les should fail 
-00029940: 6173 2077 656c 6c0a 2020 2020 2020 2020  as well.        
-00029950: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00029960: 5261 6973 6573 2846 696c 654e 6f74 466f  Raises(FileNotFo
-00029970: 756e 6445 7272 6f72 2920 6173 2063 6d3a  undError) as cm:
-00029980: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00029990: 662e 6673 2e64 656c 6574 655f 7061 7468  f.fs.delete_path
-000299a0: 2827 2f74 6573 7427 290a 2020 2020 2020  ('/test').      
-000299b0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-000299c0: 6528 272f 7465 7374 2720 696e 2063 6d2e  e('/test' in cm.
-000299d0: 6578 6365 7074 696f 6e2e 6172 6773 5b30  exception.args[0
-000299e0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-000299f0: 5f63 7265 6174 655f 6469 725f 7769 7468  _create_dir_with
-00029a00: 5f65 7874 7261 5f61 7267 7328 7365 6c66  _extra_args(self
-00029a10: 293a 0a20 2020 2020 2020 2064 203d 2073  ):.        d = s
-00029a20: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00029a30: 7228 272f 6469 7231 2729 0a20 2020 2020  r('/dir1').     
-00029a40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00029a50: 7561 6c28 642e 6b77 6172 6773 2c20 7b7d  ual(d.kwargs, {}
-00029a60: 290a 0a20 2020 2020 2020 2064 203d 2073  )..        d = s
-00029a70: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00029a80: 7228 0a20 2020 2020 2020 2020 2020 2027  r(.            '
-00029a90: 2f64 6972 3227 2c20 7065 726d 6973 7369  /dir2', permissi
-00029aa0: 6f6e 733d 306f 3730 302c 2075 7365 723d  ons=0o700, user=
-00029ab0: 2775 6275 6e74 7527 2c20 7573 6572 5f69  'ubuntu', user_i
-00029ac0: 643d 3130 3030 2c20 6772 6f75 703d 2777  d=1000, group='w
-00029ad0: 7777 2d64 6174 6127 2c20 6772 6f75 705f  ww-data', group_
-00029ae0: 6964 3d33 3329 0a20 2020 2020 2020 2073  id=33).        s
-00029af0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00029b00: 642e 6b77 6172 6773 2c20 7b0a 2020 2020  d.kwargs, {.    
-00029b10: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
-00029b20: 696f 6e73 273a 2030 6f37 3030 2c0a 2020  ions': 0o700,.  
-00029b30: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
-00029b40: 3a20 2775 6275 6e74 7527 2c0a 2020 2020  : 'ubuntu',.    
-00029b50: 2020 2020 2020 2020 2775 7365 725f 6964          'user_id
-00029b60: 273a 2031 3030 302c 0a20 2020 2020 2020  ': 1000,.       
-00029b70: 2020 2020 2027 6772 6f75 7027 3a20 2777       'group': 'w
-00029b80: 7777 2d64 6174 6127 2c0a 2020 2020 2020  ww-data',.      
-00029b90: 2020 2020 2020 2767 726f 7570 5f69 6427        'group_id'
-00029ba0: 3a20 3333 2c0a 2020 2020 2020 2020 7d29  : 33,.        })
-00029bb0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00029bc0: 7265 6174 655f 6669 6c65 5f77 6974 685f  reate_file_with_
-00029bd0: 6578 7472 615f 6172 6773 2873 656c 6629  extra_args(self)
-00029be0: 3a0a 2020 2020 2020 2020 6620 3d20 7365  :.        f = se
-00029bf0: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00029c00: 6528 272f 6669 6c65 3127 2c20 2764 6174  e('/file1', 'dat
-00029c10: 6127 290a 2020 2020 2020 2020 7365 6c66  a').        self
-00029c20: 2e61 7373 6572 7445 7175 616c 2866 2e6b  .assertEqual(f.k
-00029c30: 7761 7267 732c 207b 7d29 0a0a 2020 2020  wargs, {})..    
-00029c40: 2020 2020 6620 3d20 7365 6c66 2e66 732e      f = self.fs.
-00029c50: 6372 6561 7465 5f66 696c 6528 0a20 2020  create_file(.   
-00029c60: 2020 2020 2020 2020 2027 2f66 696c 6532           '/file2
-00029c70: 272c 2027 6461 7461 272c 0a20 2020 2020  ', 'data',.     
-00029c80: 2020 2020 2020 2070 6572 6d69 7373 696f         permissio
-00029c90: 6e73 3d30 6f37 3534 2c20 7573 6572 3d27  ns=0o754, user='
-00029ca0: 7562 756e 7475 272c 2075 7365 725f 6964  ubuntu', user_id
-00029cb0: 3d31 3030 302c 2067 726f 7570 3d27 7777  =1000, group='ww
-00029cc0: 772d 6461 7461 272c 2067 726f 7570 5f69  w-data', group_i
-00029cd0: 643d 3333 290a 2020 2020 2020 2020 7365  d=33).        se
-00029ce0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00029cf0: 2e6b 7761 7267 732c 207b 0a20 2020 2020  .kwargs, {.     
-00029d00: 2020 2020 2020 2027 7065 726d 6973 7369         'permissi
-00029d10: 6f6e 7327 3a20 306f 3735 342c 0a20 2020  ons': 0o754,.   
-00029d20: 2020 2020 2020 2020 2027 7573 6572 273a           'user':
-00029d30: 2027 7562 756e 7475 272c 0a20 2020 2020   'ubuntu',.     
-00029d40: 2020 2020 2020 2027 7573 6572 5f69 6427         'user_id'
-00029d50: 3a20 3130 3030 2c0a 2020 2020 2020 2020  : 1000,.        
-00029d60: 2020 2020 2767 726f 7570 273a 2027 7777      'group': 'ww
-00029d70: 772d 6461 7461 272c 0a20 2020 2020 2020  w-data',.       
-00029d80: 2020 2020 2027 6772 6f75 705f 6964 273a       'group_id':
-00029d90: 2033 332c 0a20 2020 2020 2020 207d 290a   33,.        }).
-00029da0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-00029db0: 7461 7474 7228 7365 6c66 293a 0a20 2020  tattr(self):.   
-00029dc0: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
-00029dd0: 6174 655f 6469 7228 272f 6574 632f 696e  ate_dir('/etc/in
-00029de0: 6974 2e64 272c 206d 616b 655f 7061 7265  it.d', make_pare
-00029df0: 6e74 733d 5472 7565 290a 0a20 2020 2020  nts=True)..     
-00029e00: 2020 2023 2042 7920 7061 7468 0a20 2020     # By path.   
-00029e10: 2020 2020 206f 203d 2073 656c 662e 6673       o = self.fs
-00029e20: 2e67 6574 5f70 6174 6828 7061 7468 6c69  .get_path(pathli
-00029e30: 622e 5075 7265 506f 7369 7850 6174 6828  b.PurePosixPath(
-00029e40: 272f 6574 632f 696e 6974 2e64 2729 290a  '/etc/init.d')).
-00029e50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00029e60: 6572 7449 7349 6e73 7461 6e63 6528 6f2c  ertIsInstance(o,
-00029e70: 205f 4469 7265 6374 6f72 7929 0a20 2020   _Directory).   
-00029e80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00029e90: 4571 7561 6c28 6f2e 7061 7468 2c20 7061  Equal(o.path, pa
-00029ea0: 7468 6c69 622e 5075 7265 506f 7369 7850  thlib.PurePosixP
-00029eb0: 6174 6828 272f 6574 632f 696e 6974 2e64  ath('/etc/init.d
-00029ec0: 2729 290a 0a20 2020 2020 2020 2023 2042  '))..        # B
-00029ed0: 7920 7374 720a 2020 2020 2020 2020 6f20  y str.        o 
-00029ee0: 3d20 7365 6c66 2e66 732e 6765 745f 7061  = self.fs.get_pa
-00029ef0: 7468 2827 2f65 7463 2f69 6e69 742e 6427  th('/etc/init.d'
-00029f00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00029f10: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-00029f20: 6f2c 205f 4469 7265 6374 6f72 7929 0a20  o, _Directory). 
-00029f30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00029f40: 7274 4571 7561 6c28 6f2e 7061 7468 2c20  rtEqual(o.path, 
-00029f50: 7061 7468 6c69 622e 5075 7265 506f 7369  pathlib.PurePosi
-00029f60: 7850 6174 6828 272f 6574 632f 696e 6974  xPath('/etc/init
-00029f70: 2e64 2729 290a 0a20 2020 2064 6566 2074  .d'))..    def t
-00029f80: 6573 745f 6765 7461 7474 725f 6669 6c65  est_getattr_file
-00029f90: 5f6e 6f74 5f66 6f75 6e64 2873 656c 6629  _not_found(self)
-00029fa0: 3a0a 2020 2020 2020 2020 2320 4172 6775  :.        # Argu
-00029fb0: 6162 6c79 2074 6869 7320 636f 756c 6420  ably this could 
-00029fc0: 6265 2061 204b 6579 4572 726f 7220 6769  be a KeyError gi
-00029fd0: 7665 6e20 7468 6520 6469 6374 696f 6e61  ven the dictiona
-00029fe0: 7279 2d73 7479 6c65 2061 6363 6573 732e  ry-style access.
-00029ff0: 0a20 2020 2020 2020 2023 2048 6f77 6576  .        # Howev
-0002a000: 6572 2c20 4669 6c65 4e6f 7446 6f75 6e64  er, FileNotFound
-0002a010: 4572 726f 7220 7365 656d 7320 6d6f 7265  Error seems more
-0002a020: 2061 7070 726f 7072 6961 7465 2066 6f72   appropriate for
-0002a030: 2061 2066 696c 6573 7973 7465 6d2c 2061   a filesystem, a
-0002a040: 6e64 2069 740a 2020 2020 2020 2020 2320  nd it.        # 
-0002a050: 6769 7665 7320 6120 636c 6f73 6572 2073  gives a closer s
-0002a060: 656d 616e 7469 6320 6665 656c 696e 672c  emantic feeling,
-0002a070: 2069 6e20 6d79 206f 7069 6e69 6f6e 2e0a   in my opinion..
-0002a080: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0002a090: 662e 6173 7365 7274 5261 6973 6573 2846  f.assertRaises(F
-0002a0a0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0002a0b0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-0002a0c0: 2020 2020 2073 656c 662e 6673 2e67 6574       self.fs.get
-0002a0d0: 5f70 6174 6828 272f 6e6f 6e65 7869 7374  _path('/nonexist
-0002a0e0: 656e 745f 6669 6c65 2729 0a20 2020 2020  ent_file').     
-0002a0f0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0002a100: 7565 2827 2f6e 6f6e 6578 6973 7465 6e74  ue('/nonexistent
-0002a110: 5f66 696c 6527 2069 6e20 636d 2e65 7863  _file' in cm.exc
-0002a120: 6570 7469 6f6e 2e61 7267 735b 305d 290a  eption.args[0]).
-0002a130: 0a0a 636c 6173 7320 5465 7374 5465 7374  ..class TestTest
-0002a140: 696e 6746 696c 6573 7973 7465 6d28 4765  ingFilesystem(Ge
-0002a150: 6e65 7269 6354 6573 7469 6e67 4669 6c65  nericTestingFile
-0002a160: 7379 7374 656d 5465 7374 732c 2075 6e69  systemTests, uni
-0002a170: 7474 6573 742e 5465 7374 4361 7365 293a  ttest.TestCase):
-0002a180: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
-0002a190: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0002a1a0: 6c66 2e66 7320 3d20 5f54 6573 7469 6e67  lf.fs = _Testing
-0002a1b0: 4669 6c65 7379 7374 656d 2829 0a0a 2020  Filesystem()..  
-0002a1c0: 2020 6465 6620 7465 7374 5f73 746f 7261    def test_stora
-0002a1d0: 6765 5f6d 6f75 6e74 2873 656c 6629 3a0a  ge_mount(self):.
-0002a1e0: 2020 2020 2020 2020 746d 7064 6972 203d          tmpdir =
-0002a1f0: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
-0002a200: 6172 7944 6972 6563 746f 7279 2829 0a20  aryDirectory(). 
-0002a210: 2020 2020 2020 2073 656c 662e 6673 2e61         self.fs.a
-0002a220: 6464 5f6d 6f75 6e74 2827 666f 6f27 2c20  dd_mount('foo', 
-0002a230: 272f 666f 6f27 2c20 746d 7064 6972 2e6e  '/foo', tmpdir.n
-0002a240: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-0002a250: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
-0002a260: 2827 2f66 6f6f 2f62 6172 2f62 617a 2e74  ('/foo/bar/baz.t
-0002a270: 7874 272c 2027 7175 7578 272c 206d 616b  xt', 'quux', mak
-0002a280: 655f 6469 7273 3d54 7275 6529 0a0a 2020  e_dirs=True)..  
-0002a290: 2020 2020 2020 746d 7070 6174 6820 3d20        tmppath = 
-0002a2a0: 6f73 2e70 6174 682e 6a6f 696e 2874 6d70  os.path.join(tmp
-0002a2b0: 6469 722e 6e61 6d65 2c20 2762 6172 2f62  dir.name, 'bar/b
-0002a2c0: 617a 2e74 7874 2729 0a20 2020 2020 2020  az.txt').       
-0002a2d0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0002a2e0: 286f 732e 7061 7468 2e65 7869 7374 7328  (os.path.exists(
-0002a2f0: 746d 7070 6174 6829 290a 2020 2020 2020  tmppath)).      
-0002a300: 2020 7769 7468 206f 7065 6e28 746d 7070    with open(tmpp
-0002a310: 6174 6829 2061 7320 663a 0a20 2020 2020  ath) as f:.     
-0002a320: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002a330: 7274 4571 7561 6c28 662e 7265 6164 2829  rtEqual(f.read()
-0002a340: 2c20 2771 7575 7827 290a 0a0a 636c 6173  , 'quux')...clas
-0002a350: 7320 5465 7374 5465 7374 696e 6753 746f  s TestTestingSto
-0002a360: 7261 6765 4d6f 756e 7428 4765 6e65 7269  rageMount(Generi
-0002a370: 6354 6573 7469 6e67 4669 6c65 7379 7374  cTestingFilesyst
-0002a380: 656d 5465 7374 732c 2075 6e69 7474 6573  emTests, unittes
-0002a390: 742e 5465 7374 4361 7365 293a 0a20 2020  t.TestCase):.   
-0002a3a0: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
-0002a3b0: 3a0a 2020 2020 2020 2020 7365 6c66 2e74  :.        self.t
-0002a3c0: 6d70 203d 2074 656d 7066 696c 652e 5465  mp = tempfile.Te
-0002a3d0: 6d70 6f72 6172 7944 6972 6563 746f 7279  mporaryDirectory
-0002a3e0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0002a3f0: 6164 6443 6c65 616e 7570 2873 656c 662e  addCleanup(self.
-0002a400: 746d 702e 636c 6561 6e75 7029 0a20 2020  tmp.cleanup).   
-0002a410: 2020 2020 2073 656c 662e 6673 203d 205f       self.fs = _
-0002a420: 5465 7374 696e 6753 746f 7261 6765 4d6f  TestingStorageMo
-0002a430: 756e 7428 272f 272c 2070 6174 686c 6962  unt('/', pathlib
-0002a440: 2e50 6174 6828 7365 6c66 2e74 6d70 2e6e  .Path(self.tmp.n
-0002a450: 616d 6529 290a 0a0a 636c 6173 7320 5465  ame))...class Te
-0002a460: 7374 5065 6262 6c65 5374 6f72 6167 6541  stPebbleStorageA
-0002a470: 5049 7355 7369 6e67 4d6f 636b 7328 0a20  PIsUsingMocks(. 
-0002a480: 2020 2020 2020 2075 6e69 7474 6573 742e         unittest.
-0002a490: 5465 7374 4361 7365 2c0a 2020 2020 2020  TestCase,.      
-0002a4a0: 2020 5f54 6573 7469 6e67 5065 6262 6c65    _TestingPebble
-0002a4b0: 436c 6965 6e74 4d69 7869 6e2c 0a20 2020  ClientMixin,.   
-0002a4c0: 2020 2020 205f 5065 6262 6c65 5374 6f72       _PebbleStor
-0002a4d0: 6167 6541 5049 7354 6573 744d 6978 696e  ageAPIsTestMixin
-0002a4e0: 293a 0a20 2020 2064 6566 2073 6574 5570  ):.    def setUp
-0002a4f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002a500: 7365 6c66 2e70 7265 6669 7820 3d20 272f  self.prefix = '/
-0002a510: 7072 6566 6978 270a 2020 2020 2020 2020  prefix'.        
-0002a520: 7365 6c66 2e63 6c69 656e 7420 3d20 7365  self.client = se
-0002a530: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
-0002a540: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-0002a550: 6966 2073 656c 662e 7072 6566 6978 3a0a  if self.prefix:.
-0002a560: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002a570: 2e63 6c69 656e 742e 6d61 6b65 5f64 6972  .client.make_dir
-0002a580: 2873 656c 662e 7072 6566 6978 2c20 6d61  (self.prefix, ma
-0002a590: 6b65 5f70 6172 656e 7473 3d54 7275 6529  ke_parents=True)
-0002a5a0: 0a0a 2020 2020 4075 6e69 7474 6573 742e  ..    @unittest.
-0002a5b0: 736b 6970 556e 6c65 7373 2869 735f 6c69  skipUnless(is_li
-0002a5c0: 6e75 782c 2027 5065 6262 6c65 2072 756e  nux, 'Pebble run
-0002a5d0: 7320 6f6e 204c 696e 7578 2729 0a20 2020  s on Linux').   
-0002a5e0: 2064 6566 2074 6573 745f 636f 6e74 6169   def test_contai
-0002a5f0: 6e65 725f 7374 6f72 6167 655f 6d6f 756e  ner_storage_moun
-0002a600: 7473 2873 656c 6629 3a0a 2020 2020 2020  ts(self):.      
-0002a610: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0002a620: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0002a630: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
-0002a640: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-0002a650: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-0002a660: 7070 0a20 2020 2020 2020 2020 2020 2063  pp.            c
-0002a670: 6f6e 7461 696e 6572 733a 0a20 2020 2020  ontainers:.     
-0002a680: 2020 2020 2020 2020 2020 2063 313a 0a20             c1:. 
-0002a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6a0: 2020 206d 6f75 6e74 733a 0a20 2020 2020     mounts:.     
-0002a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6c0: 2020 202d 2073 746f 7261 6765 3a20 7374     - storage: st
-0002a6d0: 6f72 6531 0a20 2020 2020 2020 2020 2020  ore1.           
-0002a6e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002a6f0: 6f63 6174 696f 6e3a 202f 6d6f 756e 7473  ocation: /mounts
-0002a700: 2f66 6f6f 0a20 2020 2020 2020 2020 2020  /foo.           
-0002a710: 2020 2020 2063 323a 0a20 2020 2020 2020       c2:.       
-0002a720: 2020 2020 2020 2020 2020 2020 206d 6f75               mou
-0002a730: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0002a740: 2020 2020 2020 2020 2020 2020 202d 2073               - s
-0002a750: 746f 7261 6765 3a20 7374 6f72 6532 0a20  torage: store2. 
-0002a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a770: 2020 2020 2020 2020 206c 6f63 6174 696f           locatio
-0002a780: 6e3a 202f 6d6f 756e 7473 2f66 6f6f 0a20  n: /mounts/foo. 
-0002a790: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002a7a0: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-0002a7b0: 2020 2020 2020 206d 6f75 6e74 733a 0a20         mounts:. 
-0002a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7d0: 2020 2020 2020 202d 2073 746f 7261 6765         - storage
-0002a7e0: 3a20 7374 6f72 6531 0a20 2020 2020 2020  : store1.       
-0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a800: 2020 206c 6f63 6174 696f 6e3a 202f 6d6f     location: /mo
-0002a810: 756e 7473 2f62 6172 0a20 2020 2020 2020  unts/bar.       
-0002a820: 2020 2020 2073 746f 7261 6765 3a0a 2020       storage:.  
-0002a830: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002a840: 6f72 6531 3a0a 2020 2020 2020 2020 2020  ore1:.          
-0002a850: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
-0002a860: 6669 6c65 7379 7374 656d 0a20 2020 2020  filesystem.     
-0002a870: 2020 2020 2020 2020 2020 2073 746f 7265             store
-0002a880: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-0002a890: 2020 2020 2020 2074 7970 653a 2066 696c         type: fil
-0002a8a0: 6573 7973 7465 6d0a 2020 2020 2020 2020  esystem.        
-0002a8b0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-0002a8c0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0002a8d0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0002a8e0: 290a 0a20 2020 2020 2020 2073 746f 7265  )..        store
-0002a8f0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0002a900: 645f 7374 6f72 6167 6528 2773 746f 7265  d_storage('store
-0002a910: 3127 295b 305d 0a20 2020 2020 2020 2068  1')[0].        h
-0002a920: 6172 6e65 7373 2e61 7474 6163 685f 7374  arness.attach_st
-0002a930: 6f72 6167 6528 7374 6f72 655f 6964 290a  orage(store_id).
-0002a940: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002a950: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0002a960: 2068 6172 6e65 7373 2e73 6574 5f63 616e   harness.set_can
-0002a970: 5f63 6f6e 6e65 6374 2827 6331 272c 2054  _connect('c1', T
-0002a980: 7275 6529 0a20 2020 2020 2020 2068 6172  rue).        har
-0002a990: 6e65 7373 2e73 6574 5f63 616e 5f63 6f6e  ness.set_can_con
-0002a9a0: 6e65 6374 2827 6332 272c 2054 7275 6529  nect('c2', True)
-0002a9b0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002a9c0: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
-0002a9d0: 2827 6333 272c 2054 7275 6529 0a0a 2020  ('c3', True)..  
-0002a9e0: 2020 2020 2020 2320 7075 7368 2066 696c        # push fil
-0002a9f0: 6520 746f 2063 3120 7374 6f72 6167 6520  e to c1 storage 
-0002aa00: 6d6f 756e 742c 2063 6865 636b 2074 6861  mount, check tha
-0002aa10: 7420 7765 2063 616e 2073 6565 2069 7420  t we can see it 
-0002aa20: 696e 2063 6861 726d 2063 6f6e 7461 696e  in charm contain
-0002aa30: 6572 2073 746f 7261 6765 2070 6174 682e  er storage path.
-0002aa40: 0a20 2020 2020 2020 2063 3120 3d20 6861  .        c1 = ha
-0002aa50: 726e 6573 732e 6d6f 6465 6c2e 756e 6974  rness.model.unit
-0002aa60: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
-0002aa70: 6331 2729 0a20 2020 2020 2020 2063 315f  c1').        c1_
-0002aa80: 666e 616d 6520 3d20 2766 6f6f 2e74 7874  fname = 'foo.txt
-0002aa90: 270a 2020 2020 2020 2020 6331 5f66 7061  '.        c1_fpa
-0002aaa0: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
-0002aab0: 6e28 272f 6d6f 756e 7473 2f66 6f6f 272c  n('/mounts/foo',
-0002aac0: 2063 315f 666e 616d 6529 0a20 2020 2020   c1_fname).     
-0002aad0: 2020 2063 312e 7075 7368 2863 315f 6670     c1.push(c1_fp
-0002aae0: 6174 682c 2027 3432 2729 0a20 2020 2020  ath, '42').     
-0002aaf0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0002ab00: 7565 2863 312e 6578 6973 7473 2863 315f  ue(c1.exists(c1_
-0002ab10: 6670 6174 6829 290a 2020 2020 2020 2020  fpath)).        
-0002ab20: 6670 6174 6820 3d20 6f73 2e70 6174 682e  fpath = os.path.
-0002ab30: 6a6f 696e 2873 7472 2868 6172 6e65 7373  join(str(harness
-0002ab40: 2e6d 6f64 656c 2e73 746f 7261 6765 735b  .model.storages[
-0002ab50: 2773 746f 7265 3127 5d5b 305d 2e6c 6f63  'store1'][0].loc
-0002ab60: 6174 696f 6e29 2c20 2766 6f6f 2e74 7874  ation), 'foo.txt
-0002ab70: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-0002ab80: 6f70 656e 2866 7061 7468 2920 6173 2066  open(fpath) as f
-0002ab90: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002aba0: 6c66 2e61 7373 6572 7445 7175 616c 2827  lf.assertEqual('
-0002abb0: 3432 272c 2066 2e72 6561 6428 2929 0a0a  42', f.read())..
-0002abc0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-0002abd0: 7468 6174 2074 6865 2066 696c 6520 6973  that the file is
-0002abe0: 206e 6f74 2076 6973 6962 6c65 2069 6e20   not visible in 
-0002abf0: 6332 2077 6869 6368 2068 6173 2061 2064  c2 which has a d
-0002ac00: 6966 6665 7265 6e74 2073 746f 7261 6765  ifferent storage
-0002ac10: 206d 6f75 6e74 0a20 2020 2020 2020 2063   mount.        c
-0002ac20: 3220 3d20 6861 726e 6573 732e 6d6f 6465  2 = harness.mode
-0002ac30: 6c2e 756e 6974 2e67 6574 5f63 6f6e 7461  l.unit.get_conta
-0002ac40: 696e 6572 2827 6332 2729 0a20 2020 2020  iner('c2').     
-0002ac50: 2020 2063 325f 6670 6174 6820 3d20 6f73     c2_fpath = os
-0002ac60: 2e70 6174 682e 6a6f 696e 2827 2f6d 6f75  .path.join('/mou
-0002ac70: 6e74 732f 666f 6f27 2c20 6331 5f66 6e61  nts/foo', c1_fna
-0002ac80: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-0002ac90: 2e61 7373 6572 7446 616c 7365 2863 322e  .assertFalse(c2.
-0002aca0: 6578 6973 7473 2863 325f 6670 6174 6829  exists(c2_fpath)
-0002acb0: 290a 0a20 2020 2020 2020 2023 2063 6865  )..        # che
-0002acc0: 636b 2074 6861 7420 7468 6520 6669 6c65  ck that the file
-0002acd0: 2069 7320 7669 7369 626c 6520 696e 2063   is visible in c
-0002ace0: 3320 7768 6963 6820 6861 7320 7468 6520  3 which has the 
-0002acf0: 7361 6d65 2073 746f 7261 6765 206d 6f75  same storage mou
-0002ad00: 6e74 0a20 2020 2020 2020 2063 3320 3d20  nt.        c3 = 
-0002ad10: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
-0002ad20: 6974 2e67 6574 5f63 6f6e 7461 696e 6572  it.get_container
-0002ad30: 2827 6333 2729 0a20 2020 2020 2020 2063  ('c3').        c
-0002ad40: 335f 6670 6174 6820 3d20 6f73 2e70 6174  3_fpath = os.pat
-0002ad50: 682e 6a6f 696e 2827 2f6d 6f75 6e74 732f  h.join('/mounts/
-0002ad60: 6261 7227 2c20 6331 5f66 6e61 6d65 290a  bar', c1_fname).
-0002ad70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0002ad80: 6572 7454 7275 6528 6333 2e65 7869 7374  ertTrue(c3.exist
-0002ad90: 7328 6333 5f66 7061 7468 2929 0a20 2020  s(c3_fpath)).   
-0002ada0: 2020 2020 2077 6974 6820 6333 2e70 756c       with c3.pul
-0002adb0: 6c28 6333 5f66 7061 7468 2920 6173 2066  l(c3_fpath) as f
-0002adc0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002add0: 6c66 2e61 7373 6572 7445 7175 616c 2827  lf.assertEqual('
-0002ade0: 3432 272c 2066 2e72 6561 6428 2929 0a0a  42', f.read())..
-0002adf0: 2020 2020 2020 2020 2320 7465 7374 2061          # test a
-0002ae00: 6c6c 206f 7468 6572 2063 6f6e 7461 696e  ll other contain
-0002ae10: 6572 2066 696c 6520 6f70 730a 2020 2020  er file ops.    
-0002ae20: 2020 2020 7769 7468 2063 312e 7075 6c6c      with c1.pull
-0002ae30: 2863 315f 6670 6174 6829 2061 7320 663a  (c1_fpath) as f:
-0002ae40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002ae50: 662e 6173 7365 7274 4571 7561 6c28 2734  f.assertEqual('4
-0002ae60: 3227 2c20 662e 7265 6164 2829 290a 2020  2', f.read()).  
-0002ae70: 2020 2020 2020 6669 6c65 7320 3d20 6331        files = c1
-0002ae80: 2e6c 6973 745f 6669 6c65 7328 6331 5f66  .list_files(c1_f
-0002ae90: 7061 7468 290a 2020 2020 2020 2020 7365  path).        se
-0002aea0: 6c66 2e61 7373 6572 7445 7175 616c 285b  lf.assertEqual([
-0002aeb0: 6331 5f66 7061 7468 5d2c 205b 6669 2e70  c1_fpath], [fi.p
-0002aec0: 6174 6820 666f 7220 6669 2069 6e20 6669  ath for fi in fi
-0002aed0: 6c65 735d 290a 2020 2020 2020 2020 6331  les]).        c1
-0002aee0: 2e72 656d 6f76 655f 7061 7468 2863 315f  .remove_path(c1_
-0002aef0: 6670 6174 6829 0a20 2020 2020 2020 2073  fpath).        s
-0002af00: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-0002af10: 6331 2e65 7869 7374 7328 6331 5f66 7061  c1.exists(c1_fpa
-0002af20: 7468 2929 0a0a 2020 2020 2020 2020 2320  th))..        # 
-0002af30: 7465 7374 2064 6574 6163 6869 6e67 2073  test detaching s
-0002af40: 746f 7261 6765 0a20 2020 2020 2020 2063  torage.        c
-0002af50: 312e 7075 7368 2863 315f 6670 6174 682c  1.push(c1_fpath,
-0002af60: 2027 3432 2729 0a20 2020 2020 2020 2073   '42').        s
-0002af70: 656c 662e 6173 7365 7274 5472 7565 2863  elf.assertTrue(c
-0002af80: 312e 6578 6973 7473 2863 315f 6670 6174  1.exists(c1_fpat
-0002af90: 6829 290a 2020 2020 2020 2020 7374 6f72  h)).        stor
-0002afa0: 6531 5f69 6420 3d20 6861 726e 6573 732e  e1_id = harness.
-0002afb0: 6d6f 6465 6c2e 7374 6f72 6167 6573 5b27  model.storages['
-0002afc0: 7374 6f72 6531 275d 5b30 5d2e 6675 6c6c  store1'][0].full
-0002afd0: 5f69 640a 2020 2020 2020 2020 6861 726e  _id.        harn
-0002afe0: 6573 732e 7265 6d6f 7665 5f73 746f 7261  ess.remove_stora
-0002aff0: 6765 2873 746f 7265 315f 6964 290a 2020  ge(store1_id).  
-0002b000: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002b010: 7446 616c 7365 2863 312e 6578 6973 7473  tFalse(c1.exists
-0002b020: 2863 315f 6670 6174 6829 290a 0a20 2020  (c1_fpath))..   
-0002b030: 2064 6566 2074 6573 745f 7075 7368 5f77   def test_push_w
-0002b040: 6974 685f 6f77 6e65 7273 6869 7028 7365  ith_ownership(se
-0002b050: 6c66 293a 0a20 2020 2020 2020 2023 204e  lf):.        # N
-0002b060: 6f74 653a 2054 6f20 7369 6d70 6c69 6679  ote: To simplify
-0002b070: 2069 6d70 6c65 6d65 6e74 6174 696f 6e2c   implementation,
-0002b080: 206f 776e 6572 7368 6970 2069 7320 7369   ownership is si
-0002b090: 6d70 6c79 2073 746f 7265 6420 6173 2d69  mply stored as-i
-0002b0a0: 7320 7769 7468 206e 6f20 7665 7269 6669  s with no verifi
-0002b0b0: 6361 7469 6f6e 2e0a 2020 2020 2020 2020  cation..        
-0002b0c0: 6461 7461 203d 2027 6461 7461 270a 2020  data = 'data'.  
-0002b0d0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
-0002b0e0: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
-0002b0f0: 2020 2063 6c69 656e 742e 7075 7368 2866     client.push(f
-0002b100: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-0002b110: 696c 6522 2c20 6461 7461 2c20 7573 6572  ile", data, user
-0002b120: 5f69 643d 312c 2075 7365 723d 2766 6f6f  _id=1, user='foo
-0002b130: 272c 2067 726f 7570 5f69 643d 332c 2067  ', group_id=3, g
-0002b140: 726f 7570 3d27 6261 7227 290a 2020 2020  roup='bar').    
-0002b150: 2020 2020 6669 6c65 5f20 3d20 636c 6965      file_ = clie
-0002b160: 6e74 2e6c 6973 745f 6669 6c65 7328 6622  nt.list_files(f"
-0002b170: 7b73 656c 662e 7072 6566 6978 7d2f 6669  {self.prefix}/fi
-0002b180: 6c65 2229 5b30 5d0a 2020 2020 2020 2020  le")[0].        
-0002b190: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002b1a0: 2866 696c 655f 2e75 7365 725f 6964 2c20  (file_.user_id, 
-0002b1b0: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
-0002b1c0: 6173 7365 7274 4571 7561 6c28 6669 6c65  assertEqual(file
-0002b1d0: 5f2e 7573 6572 2c20 2766 6f6f 2729 0a20  _.user, 'foo'). 
-0002b1e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002b1f0: 7274 4571 7561 6c28 6669 6c65 5f2e 6772  rtEqual(file_.gr
-0002b200: 6f75 705f 6964 2c20 3329 0a20 2020 2020  oup_id, 3).     
-0002b210: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002b220: 7561 6c28 6669 6c65 5f2e 6772 6f75 702c  ual(file_.group,
-0002b230: 2027 6261 7227 290a 0a20 2020 2064 6566   'bar')..    def
-0002b240: 2074 6573 745f 6d61 6b65 5f64 6972 5f77   test_make_dir_w
-0002b250: 6974 685f 6f77 6e65 7273 6869 7028 7365  ith_ownership(se
-0002b260: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
-0002b270: 656e 7420 3d20 7365 6c66 2e63 6c69 656e  ent = self.clien
-0002b280: 740a 2020 2020 2020 2020 636c 6965 6e74  t.        client
-0002b290: 2e6d 616b 655f 6469 7228 6622 7b73 656c  .make_dir(f"{sel
-0002b2a0: 662e 7072 6566 6978 7d2f 6469 7231 222c  f.prefix}/dir1",
-0002b2b0: 2075 7365 725f 6964 3d31 2c20 7573 6572   user_id=1, user
-0002b2c0: 3d22 666f 6f22 2c20 6772 6f75 705f 6964  ="foo", group_id
-0002b2d0: 3d33 2c20 6772 6f75 703d 2262 6172 2229  =3, group="bar")
-0002b2e0: 0a20 2020 2020 2020 2064 6972 5f20 3d20  .        dir_ = 
-0002b2f0: 636c 6965 6e74 2e6c 6973 745f 6669 6c65  client.list_file
-0002b300: 7328 6622 7b73 656c 662e 7072 6566 6978  s(f"{self.prefix
-0002b310: 7d2f 6469 7231 222c 2069 7473 656c 663d  }/dir1", itself=
-0002b320: 5472 7565 295b 305d 0a20 2020 2020 2020  True)[0].       
-0002b330: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002b340: 6c28 6469 725f 2e75 7365 725f 6964 2c20  l(dir_.user_id, 
-0002b350: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
-0002b360: 6173 7365 7274 4571 7561 6c28 6469 725f  assertEqual(dir_
-0002b370: 2e75 7365 722c 2022 666f 6f22 290a 2020  .user, "foo").  
-0002b380: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002b390: 7445 7175 616c 2864 6972 5f2e 6772 6f75  tEqual(dir_.grou
-0002b3a0: 705f 6964 2c20 3329 0a20 2020 2020 2020  p_id, 3).       
-0002b3b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002b3c0: 6c28 6469 725f 2e67 726f 7570 2c20 2262  l(dir_.group, "b
-0002b3d0: 6172 2229 0a0a 0a40 756e 6974 7465 7374  ar")...@unittest
-0002b3e0: 2e73 6b69 7055 6e6c 6573 7328 6f73 2e67  .skipUnless(os.g
-0002b3f0: 6574 656e 7628 2752 554e 5f52 4541 4c5f  etenv('RUN_REAL_
-0002b400: 5045 4242 4c45 5f54 4553 5453 2729 2c20  PEBBLE_TESTS'), 
-0002b410: 2752 554e 5f52 4541 4c5f 5045 4242 4c45  'RUN_REAL_PEBBLE
-0002b420: 5f54 4553 5453 206e 6f74 2073 6574 2729  _TESTS not set')
-0002b430: 0a63 6c61 7373 2054 6573 7450 6562 626c  .class TestPebbl
-0002b440: 6553 746f 7261 6765 4150 4973 5573 696e  eStorageAPIsUsin
-0002b450: 6752 6561 6c50 6562 626c 6528 756e 6974  gRealPebble(unit
-0002b460: 7465 7374 2e54 6573 7443 6173 652c 205f  test.TestCase, _
-0002b470: 5065 6262 6c65 5374 6f72 6167 6541 5049  PebbleStorageAPI
-0002b480: 7354 6573 744d 6978 696e 293a 0a20 2020  sTestMixin):.   
-0002b490: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
-0002b4a0: 3a0a 2020 2020 2020 2020 736f 636b 6574  :.        socket
-0002b4b0: 5f70 6174 6820 3d20 6f73 2e67 6574 656e  _path = os.geten
-0002b4c0: 7628 2750 4542 424c 455f 534f 434b 4554  v('PEBBLE_SOCKET
-0002b4d0: 2729 0a20 2020 2020 2020 2070 6562 626c  ').        pebbl
-0002b4e0: 655f 6469 7220 3d20 6f73 2e67 6574 656e  e_dir = os.geten
-0002b4f0: 7628 2750 4542 424c 4527 290a 2020 2020  v('PEBBLE').    
-0002b500: 2020 2020 6966 206e 6f74 2073 6f63 6b65      if not socke
-0002b510: 745f 7061 7468 2061 6e64 2070 6562 626c  t_path and pebbl
-0002b520: 655f 6469 723a 0a20 2020 2020 2020 2020  e_dir:.         
-0002b530: 2020 2073 6f63 6b65 745f 7061 7468 203d     socket_path =
-0002b540: 206f 732e 7061 7468 2e6a 6f69 6e28 7065   os.path.join(pe
-0002b550: 6262 6c65 5f64 6972 2c20 272e 7065 6262  bble_dir, '.pebb
-0002b560: 6c65 2e73 6f63 6b65 7427 290a 2020 2020  le.socket').    
-0002b570: 2020 2020 6173 7365 7274 2073 6f63 6b65      assert socke
-0002b580: 745f 7061 7468 2061 6e64 2070 6562 626c  t_path and pebbl
-0002b590: 655f 6469 722c 2027 5045 4242 4c45 206d  e_dir, 'PEBBLE m
-0002b5a0: 7573 7420 6265 2073 6574 2069 6620 5255  ust be set if RU
-0002b5b0: 4e5f 5245 414c 5f50 4542 424c 455f 5445  N_REAL_PEBBLE_TE
-0002b5c0: 5354 5320 7365 7427 0a0a 2020 2020 2020  STS set'..      
-0002b5d0: 2020 7365 6c66 2e70 7265 6669 7820 3d20    self.prefix = 
-0002b5e0: 7465 6d70 6669 6c65 2e6d 6b64 7465 6d70  tempfile.mkdtemp
-0002b5f0: 2864 6972 3d70 6562 626c 655f 6469 7229  (dir=pebble_dir)
-0002b600: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0002b610: 6965 6e74 203d 2070 6562 626c 652e 436c  ient = pebble.Cl
-0002b620: 6965 6e74 2873 6f63 6b65 745f 7061 7468  ient(socket_path
-0002b630: 3d73 6f63 6b65 745f 7061 7468 290a 0a20  =socket_path).. 
-0002b640: 2020 2064 6566 2074 6561 7244 6f77 6e28     def tearDown(
-0002b650: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0002b660: 6875 7469 6c2e 726d 7472 6565 2873 656c  hutil.rmtree(sel
-0002b670: 662e 7072 6566 6978 290a 0a20 2020 2023  f.prefix)..    #
-0002b680: 2052 656d 6f76 6520 7468 6973 2065 6e74   Remove this ent
-0002b690: 6972 656c 7920 6f6e 6365 2074 6865 2061  irely once the a
-0002b6a0: 7373 6f63 6961 7465 6420 6275 6720 6973  ssociated bug is
-0002b6b0: 2066 6978 6564 3b20 6974 206f 7665 7272   fixed; it overr
-0002b6c0: 6964 6573 2074 6865 206f 7269 6769 6e61  ides the origina
-0002b6d0: 6c20 7465 7374 2069 6e20 7468 650a 2020  l test in the.  
-0002b6e0: 2020 2320 7465 7374 206d 6978 696e 2063    # test mixin c
-0002b6f0: 6c61 7373 2e0a 2020 2020 4075 6e69 7474  lass..    @unitt
-0002b700: 6573 742e 736b 6970 2827 7065 6e64 696e  est.skip('pendin
-0002b710: 6720 7265 736f 6c75 7469 6f6e 206f 6620  g resolution of 
-0002b720: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-0002b730: 6f6d 2f63 616e 6f6e 6963 616c 2f70 6562  om/canonical/peb
-0002b740: 626c 652f 6973 7375 6573 2f38 3027 290a  ble/issues/80').
-0002b750: 2020 2020 6465 6620 7465 7374 5f6d 616b      def test_mak
-0002b760: 655f 6469 725f 7769 7468 5f70 6572 6d69  e_dir_with_permi
-0002b770: 7373 696f 6e5f 6d61 736b 2873 656c 6629  ssion_mask(self)
-0002b780: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
-0002b790: 0a63 6c61 7373 2054 6573 7453 6563 7265  .class TestSecre
-0002b7a0: 7473 2875 6e69 7474 6573 742e 5465 7374  ts(unittest.Test
-0002b7b0: 4361 7365 293a 0a20 2020 2064 6566 2074  Case):.    def t
-0002b7c0: 6573 745f 6164 645f 6d6f 6465 6c5f 7365  est_add_model_se
-0002b7d0: 6372 6574 5f62 795f 6170 705f 6e61 6d65  cret_by_app_name
-0002b7e0: 5f73 7472 2873 656c 6629 3a0a 2020 2020  _str(self):.    
-0002b7f0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0002b800: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0002b810: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
-0002b820: 206d 6574 613d 276e 616d 653a 2077 6562   meta='name: web
-0002b830: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
-0002b840: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0002b850: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-0002b860: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-0002b870: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-0002b880: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-0002b890: 2764 6174 6162 6173 6527 290a 2020 2020  'database').    
-0002b8a0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-0002b8b0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-0002b8c0: 6c61 7469 6f6e 5f69 642c 2027 6461 7461  lation_id, 'data
-0002b8d0: 6261 7365 2f30 2729 0a0a 2020 2020 2020  base/0')..      
-0002b8e0: 2020 7365 6372 6574 5f69 6420 3d20 6861    secret_id = ha
-0002b8f0: 726e 6573 732e 6164 645f 6d6f 6465 6c5f  rness.add_model_
-0002b900: 7365 6372 6574 2827 6461 7461 6261 7365  secret('database
-0002b910: 272c 207b 2770 6173 7377 6f72 6427 3a20  ', {'password': 
-0002b920: 2768 756e 7465 7232 277d 290a 2020 2020  'hunter2'}).    
-0002b930: 2020 2020 6861 726e 6573 732e 6772 616e      harness.gran
-0002b940: 745f 7365 6372 6574 2873 6563 7265 745f  t_secret(secret_
-0002b950: 6964 2c20 2777 6562 6170 7027 290a 2020  id, 'webapp').  
-0002b960: 2020 2020 2020 7365 6372 6574 203d 2068        secret = h
-0002b970: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
-0002b980: 5f73 6563 7265 7428 6964 3d73 6563 7265  _secret(id=secre
-0002b990: 745f 6964 290a 2020 2020 2020 2020 7365  t_id).        se
-0002b9a0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0002b9b0: 6563 7265 742e 6964 2c20 7365 6372 6574  ecret.id, secret
-0002b9c0: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
-0002b9d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0002b9e0: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0002b9f0: 2829 2c20 7b27 7061 7373 776f 7264 273a  (), {'password':
-0002ba00: 2027 6875 6e74 6572 3227 7d29 0a0a 2020   'hunter2'})..  
-0002ba10: 2020 6465 6620 7465 7374 5f61 6464 5f6d    def test_add_m
-0002ba20: 6f64 656c 5f73 6563 7265 745f 6279 5f61  odel_secret_by_a
-0002ba30: 7070 5f69 6e73 7461 6e63 6528 7365 6c66  pp_instance(self
-0002ba40: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0002ba50: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0002ba60: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-0002ba70: 726d 4261 7365 2c20 6d65 7461 3d27 6e61  rmBase, meta='na
-0002ba80: 6d65 3a20 7765 6261 7070 2729 0a20 2020  me: webapp').   
-0002ba90: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0002baa0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0002bab0: 616e 7570 290a 2020 2020 2020 2020 7265  anup).        re
-0002bac0: 6c61 7469 6f6e 5f69 6420 3d20 6861 726e  lation_id = harn
-0002bad0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0002bae0: 2827 6462 272c 2027 6461 7461 6261 7365  ('db', 'database
-0002baf0: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-0002bb00: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0002bb10: 756e 6974 2872 656c 6174 696f 6e5f 6964  unit(relation_id
-0002bb20: 2c20 2764 6174 6162 6173 652f 3027 290a  , 'database/0').
-0002bb30: 0a20 2020 2020 2020 2061 7070 203d 2068  .        app = h
-0002bb40: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
-0002bb50: 5f61 7070 2827 6461 7461 6261 7365 2729  _app('database')
-0002bb60: 0a20 2020 2020 2020 2073 6563 7265 745f  .        secret_
-0002bb70: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-0002bb80: 5f6d 6f64 656c 5f73 6563 7265 7428 6170  _model_secret(ap
-0002bb90: 702c 207b 2770 6173 7377 6f72 6427 3a20  p, {'password': 
-0002bba0: 2768 756e 7465 7233 277d 290a 2020 2020  'hunter3'}).    
-0002bbb0: 2020 2020 6861 726e 6573 732e 6772 616e      harness.gran
-0002bbc0: 745f 7365 6372 6574 2873 6563 7265 745f  t_secret(secret_
-0002bbd0: 6964 2c20 2777 6562 6170 7027 290a 2020  id, 'webapp').  
-0002bbe0: 2020 2020 2020 7365 6372 6574 203d 2068        secret = h
-0002bbf0: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
-0002bc00: 5f73 6563 7265 7428 6964 3d73 6563 7265  _secret(id=secre
-0002bc10: 745f 6964 290a 2020 2020 2020 2020 7365  t_id).        se
-0002bc20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0002bc30: 6563 7265 742e 6964 2c20 7365 6372 6574  ecret.id, secret
-0002bc40: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
-0002bc50: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0002bc60: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0002bc70: 2829 2c20 7b27 7061 7373 776f 7264 273a  (), {'password':
-0002bc80: 2027 6875 6e74 6572 3327 7d29 0a0a 2020   'hunter3'})..  
-0002bc90: 2020 6465 6620 7465 7374 5f61 6464 5f6d    def test_add_m
-0002bca0: 6f64 656c 5f73 6563 7265 745f 6279 5f75  odel_secret_by_u
-0002bcb0: 6e69 745f 696e 7374 616e 6365 2873 656c  nit_instance(sel
-0002bcc0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0002bcd0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-0002bce0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-0002bcf0: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
-0002bd00: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
-0002bd10: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0002bd20: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0002bd30: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
-0002bd40: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
-0002bd50: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0002bd60: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
-0002bd70: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
-0002bd80: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0002bd90: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-0002bda0: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
-0002bdb0: 0a0a 2020 2020 2020 2020 756e 6974 203d  ..        unit =
-0002bdc0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e67   harness.model.g
-0002bdd0: 6574 5f75 6e69 7428 2764 6174 6162 6173  et_unit('databas
-0002bde0: 652f 3027 290a 2020 2020 2020 2020 7365  e/0').        se
-0002bdf0: 6372 6574 5f69 6420 3d20 6861 726e 6573  cret_id = harnes
-0002be00: 732e 6164 645f 6d6f 6465 6c5f 7365 6372  s.add_model_secr
-0002be10: 6574 2875 6e69 742c 207b 2770 6173 7377  et(unit, {'passw
-0002be20: 6f72 6427 3a20 2768 756e 7465 7234 277d  ord': 'hunter4'}
-0002be30: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0002be40: 732e 6772 616e 745f 7365 6372 6574 2873  s.grant_secret(s
-0002be50: 6563 7265 745f 6964 2c20 2777 6562 6170  ecret_id, 'webap
-0002be60: 7027 290a 2020 2020 2020 2020 7365 6372  p').        secr
-0002be70: 6574 203d 2068 6172 6e65 7373 2e6d 6f64  et = harness.mod
-0002be80: 656c 2e67 6574 5f73 6563 7265 7428 6964  el.get_secret(id
-0002be90: 3d73 6563 7265 745f 6964 290a 2020 2020  =secret_id).    
-0002bea0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002beb0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
-0002bec0: 7365 6372 6574 5f69 6429 0a20 2020 2020  secret_id).     
-0002bed0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002bee0: 7561 6c28 7365 6372 6574 2e67 6574 5f63  ual(secret.get_c
-0002bef0: 6f6e 7465 6e74 2829 2c20 7b27 7061 7373  ontent(), {'pass
-0002bf00: 776f 7264 273a 2027 6875 6e74 6572 3427  word': 'hunter4'
-0002bf10: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-0002bf20: 5f61 6464 5f6d 6f64 656c 5f73 6563 7265  _add_model_secre
-0002bf30: 745f 696e 7661 6c69 645f 636f 6e74 656e  t_invalid_conten
-0002bf40: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0002bf50: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-0002bf60: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-0002bf70: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-0002bf80: 7461 3d27 6e61 6d65 3a20 7765 6261 7070  ta='name: webapp
-0002bf90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0002bfa0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0002bfb0: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
-0002bfc0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0002bfd0: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
-0002bfe0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0002bff0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-0002c000: 5f6d 6f64 656c 5f73 6563 7265 7428 2764  _model_secret('d
-0002c010: 6174 6162 6173 6527 2c20 7b27 7827 3a20  atabase', {'x': 
-0002c020: 2779 277d 2920 2023 206b 6579 2074 6f6f  'y'})  # key too
-0002c030: 2073 686f 7274 0a0a 2020 2020 6465 6620   short..    def 
-0002c040: 7465 7374 5f73 6574 5f73 6563 7265 745f  test_set_secret_
-0002c050: 636f 6e74 656e 7428 7365 6c66 293a 0a20  content(self):. 
-0002c060: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-0002c070: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-0002c080: 6e65 7373 2845 7665 6e74 5265 636f 7264  ness(EventRecord
-0002c090: 6572 2c20 6d65 7461 3d27 6e61 6d65 3a20  er, meta='name: 
-0002c0a0: 7765 6261 7070 2729 0a20 2020 2020 2020  webapp').       
-0002c0b0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0002c0c0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0002c0d0: 290a 2020 2020 2020 2020 7265 6c61 7469  ).        relati
-0002c0e0: 6f6e 5f69 6420 3d20 6861 726e 6573 732e  on_id = harness.
-0002c0f0: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-0002c100: 272c 2027 6461 7461 6261 7365 2729 0a20  ', 'database'). 
-0002c110: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
-0002c120: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-0002c130: 2872 656c 6174 696f 6e5f 6964 2c20 2764  (relation_id, 'd
-0002c140: 6174 6162 6173 652f 3027 290a 0a20 2020  atabase/0')..   
-0002c150: 2020 2020 2073 6563 7265 745f 6964 203d       secret_id =
-0002c160: 2068 6172 6e65 7373 2e61 6464 5f6d 6f64   harness.add_mod
-0002c170: 656c 5f73 6563 7265 7428 2764 6174 6162  el_secret('datab
-0002c180: 6173 6527 2c20 7b27 666f 6f27 3a20 2731  ase', {'foo': '1
-0002c190: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
-0002c1a0: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
-0002c1b0: 2873 6563 7265 745f 6964 2c20 2777 6562  (secret_id, 'web
-0002c1c0: 6170 7027 290a 2020 2020 2020 2020 6861  app').        ha
-0002c1d0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-0002c1e0: 2020 2020 2020 6861 726e 6573 732e 6672        harness.fr
-0002c1f0: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-0002c200: 6861 726e 6573 732e 6368 6172 6d2e 6f6e  harness.charm.on
-0002c210: 2e73 6563 7265 745f 6368 616e 6765 642c  .secret_changed,
-0002c220: 2068 6172 6e65 7373 2e63 6861 726d 2e72   harness.charm.r
-0002c230: 6563 6f72 645f 6576 656e 7429 0a20 2020  ecord_event).   
-0002c240: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-0002c250: 5f73 6563 7265 745f 636f 6e74 656e 7428  _secret_content(
-0002c260: 7365 6372 6574 5f69 642c 207b 2766 6f6f  secret_id, {'foo
-0002c270: 273a 2027 3227 7d29 0a0a 2020 2020 2020  ': '2'})..      
-0002c280: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0002c290: 616c 286c 656e 2868 6172 6e65 7373 2e63  al(len(harness.c
-0002c2a0: 6861 726d 2e65 7665 6e74 7329 2c20 3129  harm.events), 1)
-0002c2b0: 0a20 2020 2020 2020 2065 7665 6e74 203d  .        event =
-0002c2c0: 2068 6172 6e65 7373 2e63 6861 726d 2e65   harness.charm.e
-0002c2d0: 7665 6e74 735b 305d 0a20 2020 2020 2020  vents[0].       
-0002c2e0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0002c2f0: 7374 616e 6365 2865 7665 6e74 2c20 6f70  stance(event, op
-0002c300: 732e 5365 6372 6574 4368 616e 6765 6445  s.SecretChangedE
-0002c310: 7665 6e74 290a 2020 2020 2020 2020 7365  vent).        se
-0002c320: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-0002c330: 7665 6e74 2e73 6563 7265 742e 6765 745f  vent.secret.get_
-0002c340: 636f 6e74 656e 7428 292c 207b 2766 6f6f  content(), {'foo
-0002c350: 273a 2027 3127 7d29 0a20 2020 2020 2020  ': '1'}).       
-0002c360: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002c370: 6c28 6576 656e 742e 7365 6372 6574 2e67  l(event.secret.g
-0002c380: 6574 5f63 6f6e 7465 6e74 2872 6566 7265  et_content(refre
-0002c390: 7368 3d54 7275 6529 2c20 7b27 666f 6f27  sh=True), {'foo'
-0002c3a0: 3a20 2732 277d 290a 2020 2020 2020 2020  : '2'}).        
-0002c3b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002c3c0: 2865 7665 6e74 2e73 6563 7265 742e 6765  (event.secret.ge
-0002c3d0: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
-0002c3e0: 6f6f 273a 2027 3227 7d29 0a0a 2020 2020  oo': '2'})..    
-0002c3f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002c400: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
-0002c410: 5f73 6563 7265 745f 7265 7669 7369 6f6e  _secret_revision
-0002c420: 7328 7365 6372 6574 5f69 6429 2c20 5b31  s(secret_id), [1
-0002c430: 2c20 325d 290a 0a20 2020 2064 6566 2074  , 2])..    def t
-0002c440: 6573 745f 7365 745f 7365 6372 6574 5f63  est_set_secret_c
-0002c450: 6f6e 7465 6e74 5f77 726f 6e67 5f6f 776e  ontent_wrong_own
-0002c460: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
-0002c470: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0002c480: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0002c490: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
-0002c4a0: 6574 613d 276e 616d 653a 2077 6562 6170  eta='name: webap
-0002c4b0: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-0002c4c0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0002c4d0: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
-0002c4e0: 2020 2020 2020 7365 6372 6574 203d 2068        secret = h
-0002c4f0: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
-0002c500: 2e61 6464 5f73 6563 7265 7428 7b27 666f  .add_secret({'fo
-0002c510: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
-0002c520: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0002c530: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0002c540: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0002c550: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-0002c560: 745f 7365 6372 6574 5f63 6f6e 7465 6e74  t_secret_content
-0002c570: 2873 6563 7265 742e 6964 2c20 7b27 6261  (secret.id, {'ba
-0002c580: 7227 3a20 2766 6f6f 277d 290a 0a20 2020  r': 'foo'})..   
-0002c590: 2064 6566 2074 6573 745f 7365 745f 7365   def test_set_se
-0002c5a0: 6372 6574 5f63 6f6e 7465 6e74 5f69 6e76  cret_content_inv
-0002c5b0: 616c 6964 5f73 6563 7265 745f 6964 2873  alid_secret_id(s
-0002c5c0: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-0002c5d0: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
-0002c5e0: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
-0002c5f0: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-0002c600: 276e 616d 653a 2077 6562 6170 7027 290a  'name: webapp').
-0002c610: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-0002c620: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-0002c630: 636c 6561 6e75 7029 0a0a 2020 2020 2020  cleanup)..      
-0002c640: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0002c650: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-0002c660: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002c670: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-0002c680: 7365 6372 6574 5f63 6f6e 7465 6e74 2827  secret_content('
-0002c690: 6173 6466 272c 207b 2766 6f6f 273a 2027  asdf', {'foo': '
-0002c6a0: 6261 7227 7d29 0a0a 2020 2020 6465 6620  bar'})..    def 
-0002c6b0: 7465 7374 5f73 6574 5f73 6563 7265 745f  test_set_secret_
-0002c6c0: 636f 6e74 656e 745f 696e 7661 6c69 645f  content_invalid_
-0002c6d0: 636f 6e74 656e 7428 7365 6c66 293a 0a20  content(self):. 
-0002c6e0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-0002c6f0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
-0002c700: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
-0002c710: 7365 2c20 6d65 7461 3d27 6e61 6d65 3a20  se, meta='name: 
-0002c720: 7765 6261 7070 2729 0a20 2020 2020 2020  webapp').       
-0002c730: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0002c740: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0002c750: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0002c760: 745f 6964 203d 2068 6172 6e65 7373 2e61  t_id = harness.a
-0002c770: 6464 5f6d 6f64 656c 5f73 6563 7265 7428  dd_model_secret(
-0002c780: 2764 6174 6162 6173 6527 2c20 7b27 666f  'database', {'fo
-0002c790: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
-0002c7a0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0002c7b0: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
-0002c7c0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002c7d0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-0002c7e0: 7365 6372 6574 5f63 6f6e 7465 6e74 2873  secret_content(s
-0002c7f0: 6563 7265 745f 6964 2c20 7b27 7827 3a20  ecret_id, {'x': 
-0002c800: 2779 277d 290a 0a20 2020 2064 6566 2074  'y'})..    def t
-0002c810: 6573 745f 6772 616e 745f 7365 6372 6574  est_grant_secret
-0002c820: 5f61 6e64 5f72 6576 6f6b 655f 7365 6372  _and_revoke_secr
-0002c830: 6574 2873 656c 6629 3a0a 2020 2020 2020  et(self):.      
-0002c840: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0002c850: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0002c860: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
-0002c870: 6574 613d 276e 616d 653a 2077 6562 6170  eta='name: webap
-0002c880: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-0002c890: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0002c8a0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-0002c8b0: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
-0002c8c0: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
-0002c8d0: 656c 6174 696f 6e28 2764 6227 2c20 2764  elation('db', 'd
-0002c8e0: 6174 6162 6173 6527 290a 2020 2020 2020  atabase').      
-0002c8f0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-0002c900: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
-0002c910: 7469 6f6e 5f69 642c 2027 6461 7461 6261  tion_id, 'databa
-0002c920: 7365 2f30 2729 0a0a 2020 2020 2020 2020  se/0')..        
-0002c930: 7365 6372 6574 5f69 6420 3d20 6861 726e  secret_id = harn
-0002c940: 6573 732e 6164 645f 6d6f 6465 6c5f 7365  ess.add_model_se
-0002c950: 6372 6574 2827 6461 7461 6261 7365 272c  cret('database',
-0002c960: 207b 2770 6173 7377 6f72 6427 3a20 2768   {'password': 'h
-0002c970: 756e 7465 7232 277d 290a 2020 2020 2020  unter2'}).      
-0002c980: 2020 6861 726e 6573 732e 6772 616e 745f    harness.grant_
-0002c990: 7365 6372 6574 2873 6563 7265 745f 6964  secret(secret_id
-0002c9a0: 2c20 2777 6562 6170 7027 290a 2020 2020  , 'webapp').    
-0002c9b0: 2020 2020 7365 6372 6574 203d 2068 6172      secret = har
-0002c9c0: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f73  ness.model.get_s
-0002c9d0: 6563 7265 7428 6964 3d73 6563 7265 745f  ecret(id=secret_
-0002c9e0: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
-0002c9f0: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0002ca00: 7265 742e 6964 2c20 7365 6372 6574 5f69  ret.id, secret_i
-0002ca10: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-0002ca20: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
-0002ca30: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
-0002ca40: 2c20 7b27 7061 7373 776f 7264 273a 2027  , {'password': '
-0002ca50: 6875 6e74 6572 3227 7d29 0a0a 2020 2020  hunter2'})..    
-0002ca60: 2020 2020 6861 726e 6573 732e 7265 766f      harness.revo
-0002ca70: 6b65 5f73 6563 7265 7428 7365 6372 6574  ke_secret(secret
-0002ca80: 5f69 642c 2027 7765 6261 7070 2729 0a20  _id, 'webapp'). 
-0002ca90: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0002caa0: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-0002cab0: 732e 5365 6372 6574 4e6f 7446 6f75 6e64  s.SecretNotFound
-0002cac0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002cad0: 2020 2020 6861 726e 6573 732e 6d6f 6465      harness.mode
-0002cae0: 6c2e 6765 745f 7365 6372 6574 2869 643d  l.get_secret(id=
-0002caf0: 7365 6372 6574 5f69 6429 0a0a 2020 2020  secret_id)..    
-0002cb00: 6465 6620 7465 7374 5f67 7261 6e74 5f73  def test_grant_s
-0002cb10: 6563 7265 745f 7772 6f6e 675f 6170 7028  ecret_wrong_app(
-0002cb20: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0002cb30: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-0002cb40: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
-0002cb50: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
-0002cb60: 3d27 6e61 6d65 3a20 7765 6261 7070 2729  ='name: webapp')
-0002cb70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0002cb80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0002cb90: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-0002cba0: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
-0002cbb0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-0002cbc0: 7469 6f6e 2827 6462 272c 2027 6461 7461  tion('db', 'data
-0002cbd0: 6261 7365 2729 0a20 2020 2020 2020 2068  base').        h
-0002cbe0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-0002cbf0: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
-0002cc00: 6e5f 6964 2c20 2764 6174 6162 6173 652f  n_id, 'database/
-0002cc10: 3027 290a 0a20 2020 2020 2020 2073 6563  0')..        sec
-0002cc20: 7265 745f 6964 203d 2068 6172 6e65 7373  ret_id = harness
-0002cc30: 2e61 6464 5f6d 6f64 656c 5f73 6563 7265  .add_model_secre
-0002cc40: 7428 2764 6174 6162 6173 6527 2c20 7b27  t('database', {'
-0002cc50: 7061 7373 776f 7264 273a 2027 6875 6e74  password': 'hunt
-0002cc60: 6572 3227 7d29 0a20 2020 2020 2020 2068  er2'}).        h
-0002cc70: 6172 6e65 7373 2e67 7261 6e74 5f73 6563  arness.grant_sec
-0002cc80: 7265 7428 7365 6372 6574 5f69 642c 2027  ret(secret_id, '
-0002cc90: 6f74 6865 7261 7070 2729 0a20 2020 2020  otherapp').     
-0002cca0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0002ccb0: 6572 7452 6169 7365 7328 6f70 732e 5365  ertRaises(ops.Se
-0002ccc0: 6372 6574 4e6f 7446 6f75 6e64 4572 726f  cretNotFoundErro
-0002ccd0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0002cce0: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
-0002ccf0: 745f 7365 6372 6574 2869 643d 7365 6372  t_secret(id=secr
-0002cd00: 6574 5f69 6429 0a0a 2020 2020 6465 6620  et_id)..    def 
-0002cd10: 7465 7374 5f67 7261 6e74 5f73 6563 7265  test_grant_secre
-0002cd20: 745f 7772 6f6e 675f 756e 6974 2873 656c  t_wrong_unit(sel
-0002cd30: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0002cd40: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
-0002cd50: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
-0002cd60: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
-0002cd70: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
-0002cd80: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0002cd90: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0002cda0: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
-0002cdb0: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
-0002cdc0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0002cdd0: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
-0002cde0: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
-0002cdf0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0002ce00: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-0002ce10: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
-0002ce20: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0002ce30: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0002ce40: 645f 6d6f 6465 6c5f 7365 6372 6574 2827  d_model_secret('
-0002ce50: 6461 7461 6261 7365 272c 207b 2770 6173  database', {'pas
-0002ce60: 7377 6f72 6427 3a20 2768 756e 7465 7232  sword': 'hunter2
-0002ce70: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
-0002ce80: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
-0002ce90: 2873 6563 7265 745f 6964 2c20 2777 6562  (secret_id, 'web
-0002cea0: 6170 702f 3127 2920 2023 2073 686f 756c  app/1')  # shoul
-0002ceb0: 6420 6265 2077 6562 6170 702f 300a 2020  d be webapp/0.  
-0002cec0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0002ced0: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-0002cee0: 2e53 6563 7265 744e 6f74 466f 756e 6445  .SecretNotFoundE
-0002cef0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0002cf00: 2020 2068 6172 6e65 7373 2e6d 6f64 656c     harness.model
-0002cf10: 2e67 6574 5f73 6563 7265 7428 6964 3d73  .get_secret(id=s
-0002cf20: 6563 7265 745f 6964 290a 0a20 2020 2064  ecret_id)..    d
-0002cf30: 6566 2074 6573 745f 6772 616e 745f 7365  ef test_grant_se
-0002cf40: 6372 6574 5f6e 6f5f 7265 6c61 7469 6f6e  cret_no_relation
-0002cf50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002cf60: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
-0002cf70: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
-0002cf80: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
-0002cf90: 613d 276e 616d 653a 2077 6562 6170 7027  a='name: webapp'
-0002cfa0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002cfb0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-0002cfc0: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
-0002cfd0: 2020 2020 7365 6372 6574 5f69 6420 3d20      secret_id = 
-0002cfe0: 6861 726e 6573 732e 6164 645f 6d6f 6465  harness.add_mode
-0002cff0: 6c5f 7365 6372 6574 2827 6461 7461 6261  l_secret('databa
-0002d000: 7365 272c 207b 2770 6173 7377 6f72 6427  se', {'password'
-0002d010: 3a20 2768 756e 7465 7232 277d 290a 2020  : 'hunter2'}).  
-0002d020: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0002d030: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0002d040: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0002d050: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0002d060: 6772 616e 745f 7365 6372 6574 2873 6563  grant_secret(sec
-0002d070: 7265 745f 6964 2c20 2777 6562 6170 7027  ret_id, 'webapp'
-0002d080: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0002d090: 6765 745f 7365 6372 6574 5f67 7261 6e74  get_secret_grant
-0002d0a0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0002d0b0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
-0002d0c0: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
-0002d0d0: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
-0002d0e0: 7461 3d27 6e61 6d65 3a20 6461 7461 6261  ta='name: databa
-0002d0f0: 7365 2729 0a20 2020 2020 2020 2073 656c  se').        sel
-0002d100: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0002d110: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
-0002d120: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-0002d130: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-0002d140: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-0002d150: 2777 6562 6170 7027 290a 2020 2020 2020  'webapp').      
-0002d160: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-0002d170: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
-0002d180: 7469 6f6e 5f69 642c 2027 7765 6261 7070  tion_id, 'webapp
-0002d190: 2f30 2729 0a0a 2020 2020 2020 2020 7365  /0')..        se
-0002d1a0: 6372 6574 203d 2068 6172 6e65 7373 2e6d  cret = harness.m
-0002d1b0: 6f64 656c 2e61 7070 2e61 6464 5f73 6563  odel.app.add_sec
-0002d1c0: 7265 7428 7b27 666f 6f27 3a20 2778 277d  ret({'foo': 'x'}
-0002d1d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002d1e0: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
-0002d1f0: 7373 2e67 6574 5f73 6563 7265 745f 6772  ss.get_secret_gr
-0002d200: 616e 7473 2873 6563 7265 742e 6964 2c20  ants(secret.id, 
-0002d210: 7265 6c61 7469 6f6e 5f69 6429 2c20 7365  relation_id), se
-0002d220: 7428 2929 0a20 2020 2020 2020 2073 6563  t()).        sec
-0002d230: 7265 742e 6772 616e 7428 6861 726e 6573  ret.grant(harnes
-0002d240: 732e 6d6f 6465 6c2e 6765 745f 7265 6c61  s.model.get_rela
-0002d250: 7469 6f6e 2827 6462 2729 290a 2020 2020  tion('db')).    
-0002d260: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002d270: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
-0002d280: 5f73 6563 7265 745f 6772 616e 7473 2873  _secret_grants(s
-0002d290: 6563 7265 742e 6964 2c20 7265 6c61 7469  ecret.id, relati
-0002d2a0: 6f6e 5f69 6429 2c20 7b27 7765 6261 7070  on_id), {'webapp
-0002d2b0: 277d 290a 0a20 2020 2020 2020 2073 6563  '})..        sec
-0002d2c0: 7265 742e 7265 766f 6b65 2868 6172 6e65  ret.revoke(harne
-0002d2d0: 7373 2e6d 6f64 656c 2e67 6574 5f72 656c  ss.model.get_rel
-0002d2e0: 6174 696f 6e28 2764 6227 2929 0a20 2020  ation('db')).   
-0002d2f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002d300: 4571 7561 6c28 6861 726e 6573 732e 6765  Equal(harness.ge
-0002d310: 745f 7365 6372 6574 5f67 7261 6e74 7328  t_secret_grants(
-0002d320: 7365 6372 6574 2e69 642c 2072 656c 6174  secret.id, relat
-0002d330: 696f 6e5f 6964 292c 2073 6574 2829 290a  ion_id), set()).
-0002d340: 2020 2020 2020 2020 7365 6372 6574 2e67          secret.g
-0002d350: 7261 6e74 2868 6172 6e65 7373 2e6d 6f64  rant(harness.mod
-0002d360: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-0002d370: 2764 6227 292c 2075 6e69 743d 6861 726e  'db'), unit=harn
-0002d380: 6573 732e 6d6f 6465 6c2e 6765 745f 756e  ess.model.get_un
-0002d390: 6974 2827 7765 6261 7070 2f30 2729 290a  it('webapp/0')).
-0002d3a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0002d3b0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-0002d3c0: 2e67 6574 5f73 6563 7265 745f 6772 616e  .get_secret_gran
-0002d3d0: 7473 2873 6563 7265 742e 6964 2c20 7265  ts(secret.id, re
-0002d3e0: 6c61 7469 6f6e 5f69 6429 2c20 7b27 7765  lation_id), {'we
-0002d3f0: 6261 7070 2f30 277d 290a 0a20 2020 2064  bapp/0'})..    d
-0002d400: 6566 2074 6573 745f 7472 6967 6765 725f  ef test_trigger_
-0002d410: 7365 6372 6574 5f72 6f74 6174 696f 6e28  secret_rotation(
-0002d420: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0002d430: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-0002d440: 7469 6e67 2e48 6172 6e65 7373 2845 7665  ting.Harness(Eve
-0002d450: 6e74 5265 636f 7264 6572 2c20 6d65 7461  ntRecorder, meta
-0002d460: 3d27 6e61 6d65 3a20 6461 7461 6261 7365  ='name: database
-0002d470: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0002d480: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0002d490: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
-0002d4a0: 2020 2020 2073 6563 7265 7420 3d20 6861       secret = ha
-0002d4b0: 726e 6573 732e 6d6f 6465 6c2e 6170 702e  rness.model.app.
-0002d4c0: 6164 645f 7365 6372 6574 287b 2766 6f6f  add_secret({'foo
-0002d4d0: 273a 2027 7827 7d2c 206c 6162 656c 3d27  ': 'x'}, label='
-0002d4e0: 6c62 6c27 290a 2020 2020 2020 2020 6861  lbl').        ha
-0002d4f0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-0002d500: 2020 2020 2020 6861 726e 6573 732e 6672        harness.fr
-0002d510: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-0002d520: 6861 726e 6573 732e 6368 6172 6d2e 6f6e  harness.charm.on
-0002d530: 2e73 6563 7265 745f 726f 7461 7465 2c20  .secret_rotate, 
-0002d540: 6861 726e 6573 732e 6368 6172 6d2e 7265  harness.charm.re
-0002d550: 636f 7264 5f65 7665 6e74 290a 2020 2020  cord_event).    
-0002d560: 2020 2020 6861 726e 6573 732e 7472 6967      harness.trig
-0002d570: 6765 725f 7365 6372 6574 5f72 6f74 6174  ger_secret_rotat
-0002d580: 696f 6e28 7365 6372 6574 2e69 6429 0a20  ion(secret.id). 
-0002d590: 2020 2020 2020 2068 6172 6e65 7373 2e74         harness.t
-0002d5a0: 7269 6767 6572 5f73 6563 7265 745f 726f  rigger_secret_ro
-0002d5b0: 7461 7469 6f6e 2873 6563 7265 742e 6964  tation(secret.id
-0002d5c0: 2c20 6c61 6265 6c3d 276f 7665 7272 6964  , label='overrid
-0002d5d0: 6527 290a 0a20 2020 2020 2020 2073 656c  e')..        sel
-0002d5e0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-0002d5f0: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
-0002d600: 6576 656e 7473 292c 2032 290a 2020 2020  events), 2).    
-0002d610: 2020 2020 6576 656e 7420 3d20 6861 726e      event = harn
-0002d620: 6573 732e 6368 6172 6d2e 6576 656e 7473  ess.charm.events
-0002d630: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-0002d640: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0002d650: 6528 6576 656e 742c 206f 7073 2e53 6563  e(event, ops.Sec
-0002d660: 7265 7452 6f74 6174 6545 7665 6e74 290a  retRotateEvent).
-0002d670: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0002d680: 6572 7445 7175 616c 2865 7665 6e74 2e73  ertEqual(event.s
-0002d690: 6563 7265 742e 6c61 6265 6c2c 2027 6c62  ecret.label, 'lb
-0002d6a0: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-0002d6b0: 2e61 7373 6572 7445 7175 616c 2865 7665  .assertEqual(eve
-0002d6c0: 6e74 2e73 6563 7265 742e 6765 745f 636f  nt.secret.get_co
-0002d6d0: 6e74 656e 7428 292c 207b 2766 6f6f 273a  ntent(), {'foo':
-0002d6e0: 2027 7827 7d29 0a20 2020 2020 2020 2065   'x'}).        e
-0002d6f0: 7665 6e74 203d 2068 6172 6e65 7373 2e63  vent = harness.c
-0002d700: 6861 726d 2e65 7665 6e74 735b 315d 0a20  harm.events[1]. 
-0002d710: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002d720: 7274 4973 496e 7374 616e 6365 2865 7665  rtIsInstance(eve
-0002d730: 6e74 2c20 6f70 732e 5365 6372 6574 526f  nt, ops.SecretRo
-0002d740: 7461 7465 4576 656e 7429 0a20 2020 2020  tateEvent).     
-0002d750: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002d760: 7561 6c28 6576 656e 742e 7365 6372 6574  ual(event.secret
-0002d770: 2e6c 6162 656c 2c20 276f 7665 7272 6964  .label, 'overrid
-0002d780: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
-0002d790: 2e61 7373 6572 7445 7175 616c 2865 7665  .assertEqual(eve
-0002d7a0: 6e74 2e73 6563 7265 742e 6765 745f 636f  nt.secret.get_co
-0002d7b0: 6e74 656e 7428 292c 207b 2766 6f6f 273a  ntent(), {'foo':
-0002d7c0: 2027 7827 7d29 0a0a 2020 2020 2020 2020   'x'})..        
-0002d7d0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0002d7e0: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
-0002d7f0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0002d800: 2020 6861 726e 6573 732e 7472 6967 6765    harness.trigge
-0002d810: 725f 7365 6372 6574 5f72 6f74 6174 696f  r_secret_rotatio
-0002d820: 6e28 276e 6f73 6563 7265 7427 290a 0a20  n('nosecret').. 
-0002d830: 2020 2064 6566 2074 6573 745f 7472 6967     def test_trig
-0002d840: 6765 725f 7365 6372 6574 5f72 656d 6f76  ger_secret_remov
-0002d850: 616c 2873 656c 6629 3a0a 2020 2020 2020  al(self):.      
-0002d860: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
-0002d870: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
-0002d880: 4576 656e 7452 6563 6f72 6465 722c 206d  EventRecorder, m
-0002d890: 6574 613d 276e 616d 653a 2064 6174 6162  eta='name: datab
-0002d8a0: 6173 6527 290a 2020 2020 2020 2020 7365  ase').        se
-0002d8b0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0002d8c0: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
-0002d8d0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
-0002d8e0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e61   harness.model.a
-0002d8f0: 7070 2e61 6464 5f73 6563 7265 7428 7b27  pp.add_secret({'
-0002d900: 666f 6f27 3a20 2778 277d 2c20 6c61 6265  foo': 'x'}, labe
-0002d910: 6c3d 276c 626c 2729 0a20 2020 2020 2020  l='lbl').       
-0002d920: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
-0002d930: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002d940: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
-0002d950: 7665 2868 6172 6e65 7373 2e63 6861 726d  ve(harness.charm
-0002d960: 2e6f 6e2e 7365 6372 6574 5f72 656d 6f76  .on.secret_remov
-0002d970: 652c 2068 6172 6e65 7373 2e63 6861 726d  e, harness.charm
-0002d980: 2e72 6563 6f72 645f 6576 656e 7429 0a20  .record_event). 
-0002d990: 2020 2020 2020 2068 6172 6e65 7373 2e74         harness.t
-0002d9a0: 7269 6767 6572 5f73 6563 7265 745f 7265  rigger_secret_re
-0002d9b0: 6d6f 7661 6c28 7365 6372 6574 2e69 642c  moval(secret.id,
-0002d9c0: 2031 290a 2020 2020 2020 2020 6861 726e   1).        harn
-0002d9d0: 6573 732e 7472 6967 6765 725f 7365 6372  ess.trigger_secr
-0002d9e0: 6574 5f72 656d 6f76 616c 2873 6563 7265  et_removal(secre
-0002d9f0: 742e 6964 2c20 3432 2c20 6c61 6265 6c3d  t.id, 42, label=
-0002da00: 276f 7665 7272 6964 6527 290a 0a20 2020  'override')..   
-0002da10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002da20: 4571 7561 6c28 6c65 6e28 6861 726e 6573  Equal(len(harnes
-0002da30: 732e 6368 6172 6d2e 6576 656e 7473 292c  s.charm.events),
-0002da40: 2032 290a 2020 2020 2020 2020 6576 656e   2).        even
-0002da50: 7420 3d20 6861 726e 6573 732e 6368 6172  t = harness.char
-0002da60: 6d2e 6576 656e 7473 5b30 5d0a 2020 2020  m.events[0].    
-0002da70: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0002da80: 7349 6e73 7461 6e63 6528 6576 656e 742c  sInstance(event,
-0002da90: 206f 7073 2e53 6563 7265 7452 656d 6f76   ops.SecretRemov
-0002daa0: 6545 7665 6e74 290a 2020 2020 2020 2020  eEvent).        
-0002dab0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002dac0: 2865 7665 6e74 2e73 6563 7265 742e 6c61  (event.secret.la
-0002dad0: 6265 6c2c 2027 6c62 6c27 290a 2020 2020  bel, 'lbl').    
-0002dae0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002daf0: 7175 616c 2865 7665 6e74 2e72 6576 6973  qual(event.revis
-0002db00: 696f 6e2c 2031 290a 2020 2020 2020 2020  ion, 1).        
-0002db10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002db20: 2865 7665 6e74 2e73 6563 7265 742e 6765  (event.secret.ge
-0002db30: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
-0002db40: 6f6f 273a 2027 7827 7d29 0a20 2020 2020  oo': 'x'}).     
-0002db50: 2020 2065 7665 6e74 203d 2068 6172 6e65     event = harne
-0002db60: 7373 2e63 6861 726d 2e65 7665 6e74 735b  ss.charm.events[
-0002db70: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
-0002db80: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-0002db90: 2865 7665 6e74 2c20 6f70 732e 5365 6372  (event, ops.Secr
-0002dba0: 6574 5265 6d6f 7665 4576 656e 7429 0a20  etRemoveEvent). 
-0002dbb0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002dbc0: 7274 4571 7561 6c28 6576 656e 742e 7365  rtEqual(event.se
-0002dbd0: 6372 6574 2e6c 6162 656c 2c20 276f 7665  cret.label, 'ove
-0002dbe0: 7272 6964 6527 290a 2020 2020 2020 2020  rride').        
-0002dbf0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002dc00: 2865 7665 6e74 2e72 6576 6973 696f 6e2c  (event.revision,
-0002dc10: 2034 3229 0a20 2020 2020 2020 2073 656c   42).        sel
-0002dc20: 662e 6173 7365 7274 4571 7561 6c28 6576  f.assertEqual(ev
-0002dc30: 656e 742e 7365 6372 6574 2e67 6574 5f63  ent.secret.get_c
-0002dc40: 6f6e 7465 6e74 2829 2c20 7b27 666f 6f27  ontent(), {'foo'
-0002dc50: 3a20 2778 277d 290a 0a20 2020 2020 2020  : 'x'})..       
-0002dc60: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0002dc70: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-0002dc80: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0002dc90: 2020 2068 6172 6e65 7373 2e74 7269 6767     harness.trigg
-0002dca0: 6572 5f73 6563 7265 745f 7265 6d6f 7661  er_secret_remova
-0002dcb0: 6c28 276e 6f73 6563 7265 7427 2c20 3129  l('nosecret', 1)
-0002dcc0: 0a0a 2020 2020 6465 6620 7465 7374 5f74  ..    def test_t
-0002dcd0: 7269 6767 6572 5f73 6563 7265 745f 6578  rigger_secret_ex
-0002dce0: 7069 7261 7469 6f6e 2873 656c 6629 3a0a  piration(self):.
-0002dcf0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0002dd00: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-0002dd10: 726e 6573 7328 4576 656e 7452 6563 6f72  rness(EventRecor
-0002dd20: 6465 722c 206d 6574 613d 276e 616d 653a  der, meta='name:
-0002dd30: 2064 6174 6162 6173 6527 290a 2020 2020   database').    
-0002dd40: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0002dd50: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0002dd60: 6e75 7029 0a0a 2020 2020 2020 2020 7365  nup)..        se
-0002dd70: 6372 6574 203d 2068 6172 6e65 7373 2e6d  cret = harness.m
-0002dd80: 6f64 656c 2e61 7070 2e61 6464 5f73 6563  odel.app.add_sec
-0002dd90: 7265 7428 7b27 666f 6f27 3a20 2778 277d  ret({'foo': 'x'}
-0002dda0: 2c20 6c61 6265 6c3d 276c 626c 2729 0a20  , label='lbl'). 
-0002ddb0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-0002ddc0: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
-0002ddd0: 6172 6e65 7373 2e66 7261 6d65 776f 726b  arness.framework
-0002dde0: 2e6f 6273 6572 7665 2868 6172 6e65 7373  .observe(harness
-0002ddf0: 2e63 6861 726d 2e6f 6e2e 7365 6372 6574  .charm.on.secret
-0002de00: 5f72 656d 6f76 652c 2068 6172 6e65 7373  _remove, harness
-0002de10: 2e63 6861 726d 2e72 6563 6f72 645f 6576  .charm.record_ev
-0002de20: 656e 7429 0a20 2020 2020 2020 2068 6172  ent).        har
-0002de30: 6e65 7373 2e74 7269 6767 6572 5f73 6563  ness.trigger_sec
-0002de40: 7265 745f 7265 6d6f 7661 6c28 7365 6372  ret_removal(secr
-0002de50: 6574 2e69 642c 2031 290a 2020 2020 2020  et.id, 1).      
-0002de60: 2020 6861 726e 6573 732e 7472 6967 6765    harness.trigge
-0002de70: 725f 7365 6372 6574 5f72 656d 6f76 616c  r_secret_removal
-0002de80: 2873 6563 7265 742e 6964 2c20 3432 2c20  (secret.id, 42, 
-0002de90: 6c61 6265 6c3d 276f 7665 7272 6964 6527  label='override'
-0002dea0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0002deb0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-0002dec0: 6861 726e 6573 732e 6368 6172 6d2e 6576  harness.charm.ev
-0002ded0: 656e 7473 292c 2032 290a 2020 2020 2020  ents), 2).      
-0002dee0: 2020 6576 656e 7420 3d20 6861 726e 6573    event = harnes
-0002def0: 732e 6368 6172 6d2e 6576 656e 7473 5b30  s.charm.events[0
-0002df00: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-0002df10: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-0002df20: 6576 656e 742c 206f 7073 2e53 6563 7265  event, ops.Secre
-0002df30: 7452 656d 6f76 6545 7665 6e74 290a 2020  tRemoveEvent).  
-0002df40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002df50: 7445 7175 616c 2865 7665 6e74 2e73 6563  tEqual(event.sec
-0002df60: 7265 742e 6c61 6265 6c2c 2027 6c62 6c27  ret.label, 'lbl'
-0002df70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002df80: 7373 6572 7445 7175 616c 2865 7665 6e74  ssertEqual(event
-0002df90: 2e72 6576 6973 696f 6e2c 2031 290a 2020  .revision, 1).  
-0002dfa0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002dfb0: 7445 7175 616c 2865 7665 6e74 2e73 6563  tEqual(event.sec
-0002dfc0: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
-0002dfd0: 292c 207b 2766 6f6f 273a 2027 7827 7d29  ), {'foo': 'x'})
-0002dfe0: 0a20 2020 2020 2020 2065 7665 6e74 203d  .        event =
-0002dff0: 2068 6172 6e65 7373 2e63 6861 726d 2e65   harness.charm.e
-0002e000: 7665 6e74 735b 315d 0a20 2020 2020 2020  vents[1].       
-0002e010: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0002e020: 7374 616e 6365 2865 7665 6e74 2c20 6f70  stance(event, op
-0002e030: 732e 5365 6372 6574 5265 6d6f 7665 4576  s.SecretRemoveEv
-0002e040: 656e 7429 0a20 2020 2020 2020 2073 656c  ent).        sel
-0002e050: 662e 6173 7365 7274 4571 7561 6c28 6576  f.assertEqual(ev
-0002e060: 656e 742e 7365 6372 6574 2e6c 6162 656c  ent.secret.label
-0002e070: 2c20 276f 7665 7272 6964 6527 290a 2020  , 'override').  
-0002e080: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002e090: 7445 7175 616c 2865 7665 6e74 2e72 6576  tEqual(event.rev
-0002e0a0: 6973 696f 6e2c 2034 3229 0a20 2020 2020  ision, 42).     
-0002e0b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002e0c0: 7561 6c28 6576 656e 742e 7365 6372 6574  ual(event.secret
-0002e0d0: 2e67 6574 5f63 6f6e 7465 6e74 2829 2c20  .get_content(), 
-0002e0e0: 7b27 666f 6f27 3a20 2778 277d 290a 0a20  {'foo': 'x'}).. 
-0002e0f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0002e100: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
-0002e110: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
-0002e120: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-0002e130: 2e74 7269 6767 6572 5f73 6563 7265 745f  .trigger_secret_
-0002e140: 7265 6d6f 7661 6c28 276e 6f73 6563 7265  removal('nosecre
-0002e150: 7427 2c20 3129 0a0a 0a63 6c61 7373 2045  t', 1)...class E
-0002e160: 7665 6e74 5265 636f 7264 6572 286f 7073  ventRecorder(ops
-0002e170: 2e43 6861 726d 4261 7365 293a 0a20 2020  .CharmBase):.   
-0002e180: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0002e190: 6c66 2c20 6672 616d 6577 6f72 6b29 3a0a  lf, framework):.
-0002e1a0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-0002e1b0: 5f5f 696e 6974 5f5f 2866 7261 6d65 776f  __init__(framewo
-0002e1c0: 726b 290a 2020 2020 2020 2020 7365 6c66  rk).        self
-0002e1d0: 2e65 7665 6e74 7320 3d20 5b5d 0a0a 2020  .events = []..  
-0002e1e0: 2020 6465 6620 7265 636f 7264 5f65 7665    def record_eve
-0002e1f0: 6e74 2873 656c 662c 2065 7665 6e74 293a  nt(self, event):
-0002e200: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
-0002e210: 656e 7473 2e61 7070 656e 6428 6576 656e  ents.append(even
-0002e220: 7429 0a0a 0a63 6c61 7373 2054 6573 7450  t)...class TestP
-0002e230: 6f72 7473 2875 6e69 7474 6573 742e 5465  orts(unittest.Te
-0002e240: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-0002e250: 2074 6573 745f 706f 7274 7328 7365 6c66   test_ports(self
-0002e260: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0002e270: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
-0002e280: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
-0002e290: 726d 4261 7365 2c20 6d65 7461 3d27 6e61  rmBase, meta='na
-0002e2a0: 6d65 3a20 7765 6261 7070 2729 0a20 2020  me: webapp').   
-0002e2b0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0002e2c0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0002e2d0: 616e 7570 290a 2020 2020 2020 2020 756e  anup).        un
-0002e2e0: 6974 203d 2068 6172 6e65 7373 2e6d 6f64  it = harness.mod
-0002e2f0: 656c 2e75 6e69 740a 0a20 2020 2020 2020  el.unit..       
-0002e300: 2075 6e69 742e 6f70 656e 5f70 6f72 7428   unit.open_port(
-0002e310: 2774 6370 272c 2038 3038 3029 0a20 2020  'tcp', 8080).   
-0002e320: 2020 2020 2075 6e69 742e 6f70 656e 5f70       unit.open_p
-0002e330: 6f72 7428 2775 6470 272c 2034 3030 3029  ort('udp', 4000)
-0002e340: 0a20 2020 2020 2020 2075 6e69 742e 6f70  .        unit.op
-0002e350: 656e 5f70 6f72 7428 2769 636d 7027 290a  en_port('icmp').
-0002e360: 0a20 2020 2020 2020 2070 6f72 7473 5f73  .        ports_s
-0002e370: 6574 203d 2075 6e69 742e 6f70 656e 6564  et = unit.opened
-0002e380: 5f70 6f72 7473 2829 0a20 2020 2020 2020  _ports().       
-0002e390: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0002e3a0: 7374 616e 6365 2870 6f72 7473 5f73 6574  stance(ports_set
-0002e3b0: 2c20 7365 7429 0a20 2020 2020 2020 2070  , set).        p
-0002e3c0: 6f72 7473 203d 2073 6f72 7465 6428 706f  orts = sorted(po
-0002e3d0: 7274 735f 7365 742c 206b 6579 3d6c 616d  rts_set, key=lam
-0002e3e0: 6264 6120 703a 2028 702e 7072 6f74 6f63  bda p: (p.protoc
-0002e3f0: 6f6c 2c20 702e 706f 7274 2929 0a20 2020  ol, p.port)).   
-0002e400: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002e410: 4571 7561 6c28 6c65 6e28 706f 7274 7329  Equal(len(ports)
-0002e420: 2c20 3329 0a20 2020 2020 2020 2073 656c  , 3).        sel
-0002e430: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0002e440: 6365 2870 6f72 7473 5b30 5d2c 206f 7073  ce(ports[0], ops
-0002e450: 2e4f 7065 6e65 6450 6f72 7429 0a20 2020  .OpenedPort).   
-0002e460: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002e470: 4571 7561 6c28 706f 7274 735b 305d 2e70  Equal(ports[0].p
-0002e480: 726f 746f 636f 6c2c 2027 6963 6d70 2729  rotocol, 'icmp')
-0002e490: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002e4a0: 7365 7274 4973 4e6f 6e65 2870 6f72 7473  sertIsNone(ports
-0002e4b0: 5b30 5d2e 706f 7274 290a 2020 2020 2020  [0].port).      
-0002e4c0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0002e4d0: 6e73 7461 6e63 6528 706f 7274 735b 315d  nstance(ports[1]
-0002e4e0: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
-0002e4f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002e500: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
-0002e510: 5b31 5d2e 7072 6f74 6f63 6f6c 2c20 2774  [1].protocol, 't
-0002e520: 6370 2729 0a20 2020 2020 2020 2073 656c  cp').        sel
-0002e530: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
-0002e540: 7274 735b 315d 2e70 6f72 742c 2038 3038  rts[1].port, 808
-0002e550: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-0002e560: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-0002e570: 2870 6f72 7473 5b32 5d2c 206f 7073 2e4f  (ports[2], ops.O
-0002e580: 7065 6e65 6450 6f72 7429 0a20 2020 2020  penedPort).     
-0002e590: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002e5a0: 7561 6c28 706f 7274 735b 325d 2e70 726f  ual(ports[2].pro
-0002e5b0: 746f 636f 6c2c 2027 7564 7027 290a 2020  tocol, 'udp').  
-0002e5c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002e5d0: 7445 7175 616c 2870 6f72 7473 5b32 5d2e  tEqual(ports[2].
-0002e5e0: 706f 7274 2c20 3430 3030 290a 0a20 2020  port, 4000)..   
-0002e5f0: 2020 2020 2075 6e69 742e 636c 6f73 655f       unit.close_
-0002e600: 706f 7274 2827 7463 7027 2c20 3830 3830  port('tcp', 8080
-0002e610: 290a 2020 2020 2020 2020 756e 6974 2e63  ).        unit.c
-0002e620: 6c6f 7365 5f70 6f72 7428 2774 6370 272c  lose_port('tcp',
-0002e630: 2038 3038 3029 2020 2320 636c 6f73 696e   8080)  # closin
-0002e640: 6720 7361 6d65 2070 6f72 7420 6167 6169  g same port agai
-0002e650: 6e20 6861 7320 6e6f 2065 6666 6563 740a  n has no effect.
-0002e660: 2020 2020 2020 2020 756e 6974 2e63 6c6f          unit.clo
-0002e670: 7365 5f70 6f72 7428 2775 6470 272c 2034  se_port('udp', 4
-0002e680: 3030 3029 0a0a 2020 2020 2020 2020 706f  000)..        po
-0002e690: 7274 735f 7365 7420 3d20 756e 6974 2e6f  rts_set = unit.o
-0002e6a0: 7065 6e65 645f 706f 7274 7328 290a 2020  pened_ports().  
-0002e6b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002e6c0: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
-0002e6d0: 735f 7365 742c 2073 6574 290a 2020 2020  s_set, set).    
-0002e6e0: 2020 2020 706f 7274 7320 3d20 736f 7274      ports = sort
-0002e6f0: 6564 2870 6f72 7473 5f73 6574 2c20 6b65  ed(ports_set, ke
-0002e700: 793d 6c61 6d62 6461 2070 3a20 2870 2e70  y=lambda p: (p.p
-0002e710: 726f 746f 636f 6c2c 2070 2e70 6f72 7429  rotocol, p.port)
-0002e720: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002e730: 7373 6572 7445 7175 616c 286c 656e 2870  ssertEqual(len(p
-0002e740: 6f72 7473 292c 2031 290a 2020 2020 2020  orts), 1).      
-0002e750: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0002e760: 6e73 7461 6e63 6528 706f 7274 735b 305d  nstance(ports[0]
-0002e770: 2c20 6f70 732e 4f70 656e 6564 506f 7274  , ops.OpenedPort
-0002e780: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002e790: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
-0002e7a0: 5b30 5d2e 7072 6f74 6f63 6f6c 2c20 2769  [0].protocol, 'i
-0002e7b0: 636d 7027 290a 2020 2020 2020 2020 7365  cmp').        se
-0002e7c0: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0002e7d0: 706f 7274 735b 305d 2e70 6f72 7429 0a0a  ports[0].port)..
-0002e7e0: 2020 2020 2020 2020 756e 6974 2e63 6c6f          unit.clo
-0002e7f0: 7365 5f70 6f72 7428 2769 636d 7027 290a  se_port('icmp').
-0002e800: 0a20 2020 2020 2020 2070 6f72 7473 5f73  .        ports_s
-0002e810: 6574 203d 2075 6e69 742e 6f70 656e 6564  et = unit.opened
-0002e820: 5f70 6f72 7473 2829 0a20 2020 2020 2020  _ports().       
-0002e830: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002e840: 6c28 706f 7274 735f 7365 742c 2073 6574  l(ports_set, set
-0002e850: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
-0002e860: 745f 6572 726f 7273 2873 656c 6629 3a0a  t_errors(self):.
-0002e870: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0002e880: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
-0002e890: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
-0002e8a0: 6173 652c 206d 6574 613d 276e 616d 653a  ase, meta='name:
-0002e8b0: 2077 6562 6170 7027 290a 2020 2020 2020   webapp').      
-0002e8c0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0002e8d0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0002e8e0: 7029 0a20 2020 2020 2020 2075 6e69 7420  p).        unit 
-0002e8f0: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
-0002e900: 756e 6974 0a0a 2020 2020 2020 2020 7769  unit..        wi
-0002e910: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0002e920: 6973 6573 286f 7073 2e4d 6f64 656c 4572  ises(ops.ModelEr
-0002e930: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0002e940: 2020 756e 6974 2e6f 7065 6e5f 706f 7274    unit.open_port
-0002e950: 2827 6963 6d70 272c 2038 3038 3029 2020  ('icmp', 8080)  
-0002e960: 2320 6963 6d70 2063 616e 6e6f 7420 6861  # icmp cannot ha
-0002e970: 7665 2070 6f72 740a 2020 2020 2020 2020  ve port.        
-0002e980: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0002e990: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
-0002e9a0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002e9b0: 2020 2020 756e 6974 2e6f 7065 6e5f 706f      unit.open_po
-0002e9c0: 7274 2827 6674 7027 2c20 3830 3830 2920  rt('ftp', 8080) 
-0002e9d0: 2023 2069 6e76 616c 6964 2070 726f 746f   # invalid proto
-0002e9e0: 636f 6c0a 2020 2020 2020 2020 7769 7468  col.        with
-0002e9f0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0002ea00: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
-0002ea10: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0002ea20: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
-0002ea30: 7463 7027 2920 2023 2074 6370 206d 7573  tcp')  # tcp mus
-0002ea40: 7420 6861 7665 2070 6f72 740a 2020 2020  t have port.    
-0002ea50: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0002ea60: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
-0002ea70: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-0002ea80: 2020 2020 2020 2020 756e 6974 2e6f 7065          unit.ope
-0002ea90: 6e5f 706f 7274 2827 7564 7027 2920 2023  n_port('udp')  #
-0002eaa0: 2075 6470 206d 7573 7420 6861 7665 2070   udp must have p
-0002eab0: 6f72 740a 2020 2020 2020 2020 7769 7468  ort.        with
-0002eac0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0002ead0: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
-0002eae0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0002eaf0: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
-0002eb00: 7463 7027 2c20 3029 2020 2320 706f 7274  tcp', 0)  # port
-0002eb10: 206f 7574 206f 6620 7261 6e67 650a 2020   out of range.  
-0002eb20: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0002eb30: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
-0002eb40: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-0002eb50: 2020 2020 2020 2020 2020 756e 6974 2e6f            unit.o
-0002eb60: 7065 6e5f 706f 7274 2827 7463 7027 2c20  pen_port('tcp', 
-0002eb70: 3635 3533 3629 2020 2320 706f 7274 206f  65536)  # port o
-0002eb80: 7574 206f 6620 7261 6e67 650a            ut of range.
+00027260: 6c66 2e63 6c69 656e 740a 0a20 2020 2020  lf.client..     
+00027270: 2020 2023 204c 6574 2773 2070 7573 6820     # Let's push 
+00027280: 7468 6520 6669 7273 7420 6669 6c65 2077  the first file w
+00027290: 6974 6820 6120 6275 6e63 6820 6f66 2064  ith a bunch of d
+000272a0: 6574 6169 6c73 2e20 2057 6527 6c6c 2063  etails.  We'll c
+000272b0: 6865 636b 206f 6e20 7468 6973 206c 6174  heck on this lat
+000272c0: 6572 2e0a 2020 2020 2020 2020 636c 6965  er..        clie
+000272d0: 6e74 2e70 7573 6828 0a20 2020 2020 2020  nt.push(.       
+000272e0: 2020 2020 2066 227b 7365 6c66 2e70 7265       f"{self.pre
+000272f0: 6669 787d 2f66 696c 6531 222c 2064 6174  fix}/file1", dat
+00027300: 612c 0a20 2020 2020 2020 2020 2020 2070  a,.            p
+00027310: 6572 6d69 7373 696f 6e73 3d30 6f36 3230  ermissions=0o620
+00027320: 290a 0a20 2020 2020 2020 2023 2044 6f20  )..        # Do 
+00027330: 6120 7175 6963 6b20 7075 7368 2077 6974  a quick push wit
+00027340: 6820 6465 6661 756c 7473 2066 6f72 2074  h defaults for t
+00027350: 6865 206f 7468 6572 2066 696c 6573 2e0a  he other files..
+00027360: 2020 2020 2020 2020 636c 6965 6e74 2e70          client.p
+00027370: 7573 6828 6622 7b73 656c 662e 7072 6566  ush(f"{self.pref
+00027380: 6978 7d2f 6669 6c65 3222 2c20 6461 7461  ix}/file2", data
+00027390: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
+000273a0: 2e70 7573 6828 6622 7b73 656c 662e 7072  .push(f"{self.pr
+000273b0: 6566 6978 7d2f 6669 6c65 3322 2c20 6461  efix}/file3", da
+000273c0: 7461 290a 0a20 2020 2020 2020 2066 696c  ta)..        fil
+000273d0: 6573 203d 2063 6c69 656e 742e 6c69 7374  es = client.list
+000273e0: 5f66 696c 6573 2866 227b 7365 6c66 2e70  _files(f"{self.p
+000273f0: 7265 6669 787d 2f22 290a 2020 2020 2020  refix}/").      
+00027400: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00027410: 616c 287b 6669 6c65 2e70 6174 6820 666f  al({file.path fo
+00027420: 7220 6669 6c65 2069 6e20 6669 6c65 737d  r file in files}
+00027430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027440: 2020 2020 2020 2020 2020 207b 7365 6c66             {self
+00027450: 2e70 7265 6669 7820 2b20 6669 6c65 2066  .prefix + file f
+00027460: 6f72 2066 696c 6520 696e 2028 272f 6669  or file in ('/fi
+00027470: 6c65 3127 2c20 272f 6669 6c65 3227 2c20  le1', '/file2', 
+00027480: 272f 6669 6c65 3327 297d 290a 0a20 2020  '/file3')})..   
+00027490: 2020 2020 2023 204c 6574 2773 2070 756c       # Let's pul
+000274a0: 6c20 7468 6520 6669 7273 7420 6669 6c65  l the first file
+000274b0: 2061 6761 696e 2061 6e64 2063 6865 636b   again and check
+000274c0: 2069 7473 2064 6574 6169 6c73 0a20 2020   its details.   
+000274d0: 2020 2020 2066 696c 6520 3d20 5b66 2066       file = [f f
+000274e0: 6f72 2066 2069 6e20 6669 6c65 7320 6966  or f in files if
+000274f0: 2066 2e70 6174 6820 3d3d 2066 227b 7365   f.path == f"{se
+00027500: 6c66 2e70 7265 6669 787d 2f66 696c 6531  lf.prefix}/file1
+00027510: 225d 5b30 5d0a 2020 2020 2020 2020 7365  "][0].        se
+00027520: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00027530: 696c 652e 6e61 6d65 2c20 2766 696c 6531  ile.name, 'file1
+00027540: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00027550: 6173 7365 7274 4571 7561 6c28 6669 6c65  assertEqual(file
+00027560: 2e74 7970 652c 2070 6562 626c 652e 4669  .type, pebble.Fi
+00027570: 6c65 5479 7065 2e46 494c 4529 0a20 2020  leType.FILE).   
+00027580: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00027590: 4571 7561 6c28 6669 6c65 2e73 697a 652c  Equal(file.size,
+000275a0: 2034 290a 2020 2020 2020 2020 7365 6c66   4).        self
+000275b0: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+000275c0: 6528 6669 6c65 2e6c 6173 745f 6d6f 6469  e(file.last_modi
+000275d0: 6669 6564 2c20 6461 7465 7469 6d65 2e64  fied, datetime.d
+000275e0: 6174 6574 696d 6529 0a20 2020 2020 2020  atetime).       
+000275f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00027600: 6c28 6669 6c65 2e70 6572 6d69 7373 696f  l(file.permissio
+00027610: 6e73 2c20 306f 3632 3029 0a20 2020 2020  ns, 0o620).     
+00027620: 2020 2023 2053 6b69 7070 696e 6720 6f77     # Skipping ow
+00027630: 6e65 7273 6869 7020 6368 6563 6b73 2068  nership checks h
+00027640: 6572 653b 206f 776e 6572 7368 6970 2077  ere; ownership w
+00027650: 696c 6c20 6265 2063 6865 636b 6564 2069  ill be checked i
+00027660: 6e20 7075 7265 6c79 2d6d 6f63 6b65 6420  n purely-mocked 
+00027670: 7465 7374 730a 0a20 2020 2064 6566 2074  tests..    def t
+00027680: 6573 745f 7075 7368 5f61 6e64 5f6c 6973  est_push_and_lis
+00027690: 745f 6669 6c65 2873 656c 6629 3a0a 2020  t_file(self):.  
+000276a0: 2020 2020 2020 6461 7461 203d 2027 6461        data = 'da
+000276b0: 7461 270a 2020 2020 2020 2020 636c 6965  ta'.        clie
+000276c0: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
+000276d0: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+000276e0: 7075 7368 2866 227b 7365 6c66 2e70 7265  push(f"{self.pre
+000276f0: 6669 787d 2f66 696c 6522 2c20 6461 7461  fix}/file", data
+00027700: 290a 2020 2020 2020 2020 6669 6c65 7320  ).        files 
+00027710: 3d20 636c 6965 6e74 2e6c 6973 745f 6669  = client.list_fi
+00027720: 6c65 7328 6622 7b73 656c 662e 7072 6566  les(f"{self.pref
+00027730: 6978 7d2f 2229 0a20 2020 2020 2020 2073  ix}/").        s
+00027740: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00027750: 7b66 696c 652e 7061 7468 2066 6f72 2066  {file.path for f
+00027760: 696c 6520 696e 2066 696c 6573 7d2c 207b  ile in files}, {
+00027770: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00027780: 6669 6c65 227d 290a 0a20 2020 2064 6566  file"})..    def
+00027790: 2074 6573 745f 7075 7368 5f66 696c 655f   test_push_file_
+000277a0: 7769 7468 5f72 656c 6174 6976 655f 7061  with_relative_pa
+000277b0: 7468 5f66 6169 6c73 2873 656c 6629 3a0a  th_fails(self):.
+000277c0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+000277d0: 2073 656c 662e 636c 6965 6e74 0a20 2020   self.client.   
+000277e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+000277f0: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
+00027800: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
+00027810: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+00027820: 2063 6c69 656e 742e 7075 7368 2827 6669   client.push('fi
+00027830: 6c65 272c 2027 2729 0a20 2020 2020 2020  le', '').       
+00027840: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00027850: 6c28 636d 2e65 7863 6570 7469 6f6e 2e6b  l(cm.exception.k
+00027860: 696e 642c 2027 6765 6e65 7269 632d 6669  ind, 'generic-fi
+00027870: 6c65 2d65 7272 6f72 2729 0a0a 2020 2020  le-error')..    
+00027880: 6465 6620 7465 7374 5f70 756c 6c5f 6e6f  def test_pull_no
+00027890: 745f 666f 756e 6428 7365 6c66 293a 0a20  t_found(self):. 
+000278a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000278b0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+000278c0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
+000278d0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+000278e0: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
+000278f0: 756c 6c28 222f 6e6f 742f 666f 756e 6422  ull("/not/found"
+00027900: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00027910: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00027920: 6365 7074 696f 6e2e 6b69 6e64 2c20 226e  ception.kind, "n
+00027930: 6f74 2d66 6f75 6e64 2229 0a20 2020 2020  ot-found").     
+00027940: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
+00027950: 2822 2f6e 6f74 2f66 6f75 6e64 222c 2063  ("/not/found", c
+00027960: 6d2e 6578 6365 7074 696f 6e2e 6d65 7373  m.exception.mess
+00027970: 6167 6529 0a0a 2020 2020 6465 6620 7465  age)..    def te
+00027980: 7374 5f70 756c 6c5f 6469 7265 6374 6f72  st_pull_director
+00027990: 7928 7365 6c66 293a 0a20 2020 2020 2020  y(self):.       
+000279a0: 2073 656c 662e 636c 6965 6e74 2e6d 616b   self.client.mak
+000279b0: 655f 6469 7228 6622 7b73 656c 662e 7072  e_dir(f"{self.pr
+000279c0: 6566 6978 7d2f 7375 6264 6972 2229 0a20  efix}/subdir"). 
+000279d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000279e0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+000279f0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
+00027a00: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+00027a10: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
+00027a20: 756c 6c28 6622 7b73 656c 662e 7072 6566  ull(f"{self.pref
+00027a30: 6978 7d2f 7375 6264 6972 2229 0a20 2020  ix}/subdir").   
+00027a40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00027a50: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
+00027a60: 6f6e 2e6b 696e 642c 2022 6765 6e65 7269  on.kind, "generi
+00027a70: 632d 6669 6c65 2d65 7272 6f72 2229 0a20  c-file-error"). 
+00027a80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00027a90: 7274 496e 2866 227b 7365 6c66 2e70 7265  rtIn(f"{self.pre
+00027aa0: 6669 787d 2f73 7562 6469 7222 2c20 636d  fix}/subdir", cm
+00027ab0: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
+00027ac0: 6765 290a 0a20 2020 2064 6566 2074 6573  ge)..    def tes
+00027ad0: 745f 6c69 7374 5f66 696c 6573 5f6e 6f74  t_list_files_not
+00027ae0: 5f66 6f75 6e64 5f72 6169 7365 7328 7365  _found_raises(se
+00027af0: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+00027b00: 656e 7420 3d20 7365 6c66 2e63 6c69 656e  ent = self.clien
+00027b10: 740a 2020 2020 2020 2020 7769 7468 2073  t.        with s
+00027b20: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00027b30: 2870 6562 626c 652e 4150 4945 7272 6f72  (pebble.APIError
+00027b40: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00027b50: 2020 2020 2063 6c69 656e 742e 6c69 7374       client.list
+00027b60: 5f66 696c 6573 2822 2f6e 6f74 2f65 7869  _files("/not/exi
+00027b70: 7374 696e 672f 6669 6c65 2f22 290a 2020  sting/file/").  
+00027b80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00027b90: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
+00027ba0: 696f 6e2e 636f 6465 2c20 3430 3429 0a20  ion.code, 404). 
+00027bb0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00027bc0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+00027bd0: 7469 6f6e 2e73 7461 7475 732c 2027 4e6f  tion.status, 'No
+00027be0: 7420 466f 756e 6427 290a 2020 2020 2020  t Found').      
+00027bf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00027c00: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
+00027c10: 6d65 7373 6167 652c 2027 7374 6174 202f  message, 'stat /
+00027c20: 6e6f 742f 6578 6973 7469 6e67 2f66 696c  not/existing/fil
+00027c30: 652f 3a20 6e6f 2027 0a20 2020 2020 2020  e/: no '.       
+00027c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c60: 2020 2020 2020 2020 2773 7563 6820 6669          'such fi
+00027c70: 6c65 206f 7220 6469 7265 6374 6f72 7927  le or directory'
+00027c80: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00027c90: 6c69 7374 5f64 6972 6563 746f 7279 5f6f  list_directory_o
+00027ca0: 626a 6563 745f 6974 7365 6c66 2873 656c  bject_itself(sel
+00027cb0: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
+00027cc0: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
+00027cd0: 0a0a 2020 2020 2020 2020 2320 5465 7374  ..        # Test
+00027ce0: 2077 6974 6820 726f 6f74 2064 6972 0a20   with root dir. 
+00027cf0: 2020 2020 2020 2023 2028 5370 6563 6961         # (Specia
+00027d00: 6c20 6361 7365 3b20 7765 2077 6f6e 2774  l case; we won't
+00027d10: 2070 7265 6669 7820 7468 6973 2c20 6576   prefix this, ev
+00027d20: 656e 2077 6865 6e20 7573 696e 6720 7468  en when using th
+00027d30: 6520 7265 616c 2050 6562 626c 6520 7365  e real Pebble se
+00027d40: 7276 6572 2e29 0a20 2020 2020 2020 2066  rver.).        f
+00027d50: 696c 6573 203d 2063 6c69 656e 742e 6c69  iles = client.li
+00027d60: 7374 5f66 696c 6573 2827 2f27 2c20 6974  st_files('/', it
+00027d70: 7365 6c66 3d54 7275 6529 0a20 2020 2020  self=True).     
+00027d80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00027d90: 7561 6c28 6c65 6e28 6669 6c65 7329 2c20  ual(len(files), 
+00027da0: 3129 0a20 2020 2020 2020 2064 6972 5f20  1).        dir_ 
+00027db0: 3d20 6669 6c65 735b 305d 0a20 2020 2020  = files[0].     
+00027dc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00027dd0: 7561 6c28 6469 725f 2e70 6174 682c 2027  ual(dir_.path, '
+00027de0: 2f27 290a 2020 2020 2020 2020 7365 6c66  /').        self
+00027df0: 2e61 7373 6572 7445 7175 616c 2864 6972  .assertEqual(dir
+00027e00: 5f2e 6e61 6d65 2c20 272f 2729 0a20 2020  _.name, '/').   
+00027e10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00027e20: 4571 7561 6c28 6469 725f 2e74 7970 652c  Equal(dir_.type,
+00027e30: 2070 6562 626c 652e 4669 6c65 5479 7065   pebble.FileType
+00027e40: 2e44 4952 4543 544f 5259 290a 0a20 2020  .DIRECTORY)..   
+00027e50: 2020 2020 2023 2054 6573 7420 7769 7468       # Test with
+00027e60: 2073 7562 6469 7273 0a20 2020 2020 2020   subdirs.       
+00027e70: 2063 6c69 656e 742e 6d61 6b65 5f64 6972   client.make_dir
+00027e80: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00027e90: 2f73 7562 6469 7222 290a 2020 2020 2020  /subdir").      
+00027ea0: 2020 6669 6c65 7320 3d20 636c 6965 6e74    files = client
+00027eb0: 2e6c 6973 745f 6669 6c65 7328 6622 7b73  .list_files(f"{s
+00027ec0: 656c 662e 7072 6566 6978 7d2f 7375 6264  elf.prefix}/subd
+00027ed0: 6972 222c 2069 7473 656c 663d 5472 7565  ir", itself=True
+00027ee0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00027ef0: 7373 6572 7445 7175 616c 286c 656e 2866  ssertEqual(len(f
+00027f00: 696c 6573 292c 2031 290a 2020 2020 2020  iles), 1).      
+00027f10: 2020 6469 725f 203d 2066 696c 6573 5b30    dir_ = files[0
+00027f20: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00027f30: 7373 6572 7445 7175 616c 2864 6972 5f2e  ssertEqual(dir_.
+00027f40: 6e61 6d65 2c20 2773 7562 6469 7227 290a  name, 'subdir').
+00027f50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00027f60: 6572 7445 7175 616c 2864 6972 5f2e 7479  ertEqual(dir_.ty
+00027f70: 7065 2c20 7065 6262 6c65 2e46 696c 6554  pe, pebble.FileT
+00027f80: 7970 652e 4449 5245 4354 4f52 5929 0a0a  ype.DIRECTORY)..
+00027f90: 2020 2020 6465 6620 7465 7374 5f70 7573      def test_pus
+00027fa0: 685f 6669 6c65 735f 616e 645f 6c69 7374  h_files_and_list
+00027fb0: 5f62 795f 7061 7474 6572 6e28 7365 6c66  _by_pattern(self
+00027fc0: 293a 0a20 2020 2020 2020 2023 204e 6f74  ):.        # Not
+00027fd0: 653a 2067 6c6f 6220 7061 7474 6572 6e20  e: glob pattern 
+00027fe0: 6465 6c74 6173 2064 6f20 6578 6973 7420  deltas do exist 
+00027ff0: 6265 7477 6565 6e20 676f 6c61 6e67 2061  between golang a
+00028000: 6e64 2050 7974 686f 6e2c 2062 7574 2068  nd Python, but h
+00028010: 6572 652c 0a20 2020 2020 2020 2023 2077  ere,.        # w
+00028020: 6527 6c6c 206a 7573 7420 7573 6520 6120  e'll just use a 
+00028030: 7369 6d70 6c65 202a 2070 6174 7465 726e  simple * pattern
+00028040: 2e0a 2020 2020 2020 2020 6461 7461 203d  ..        data =
+00028050: 2027 6461 7461 270a 2020 2020 2020 2020   'data'.        
+00028060: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+00028070: 6965 6e74 0a20 2020 2020 2020 2066 6f72  ient.        for
+00028080: 2066 696c 656e 616d 6520 696e 2028 0a20   filename in (. 
+00028090: 2020 2020 2020 2020 2020 2027 2f66 696c             '/fil
+000280a0: 6531 2e67 7a27 2c0a 2020 2020 2020 2020  e1.gz',.        
+000280b0: 2020 2020 272f 6669 6c65 322e 7461 722e      '/file2.tar.
+000280c0: 677a 272c 0a20 2020 2020 2020 2020 2020  gz',.           
+000280d0: 2027 2f66 696c 6533 2e74 6172 2e62 7a32   '/file3.tar.bz2
+000280e0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000280f0: 2f62 6163 6b75 705f 6669 6c65 2e67 7a27  /backup_file.gz'
+00028100: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
+00028110: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
+00028120: 7075 7368 2873 656c 662e 7072 6566 6978  push(self.prefix
+00028130: 202b 2066 696c 656e 616d 652c 2064 6174   + filename, dat
+00028140: 6129 0a20 2020 2020 2020 2066 696c 6573  a).        files
+00028150: 203d 2063 6c69 656e 742e 6c69 7374 5f66   = client.list_f
+00028160: 696c 6573 2866 227b 7365 6c66 2e70 7265  iles(f"{self.pre
+00028170: 6669 787d 2f22 2c20 7061 7474 6572 6e3d  fix}/", pattern=
+00028180: 2766 696c 652a 2e67 7a27 290a 2020 2020  'file*.gz').    
+00028190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000281a0: 7175 616c 287b 6669 6c65 2e70 6174 6820  qual({file.path 
+000281b0: 666f 7220 6669 6c65 2069 6e20 6669 6c65  for file in file
+000281c0: 737d 2c0a 2020 2020 2020 2020 2020 2020  s},.            
+000281d0: 2020 2020 2020 2020 2020 2020 207b 7365               {se
+000281e0: 6c66 2e70 7265 6669 7820 2b20 6669 6c65  lf.prefix + file
+000281f0: 2066 6f72 2066 696c 6520 696e 2028 272f   for file in ('/
+00028200: 6669 6c65 312e 677a 272c 2027 2f66 696c  file1.gz', '/fil
+00028210: 6532 2e74 6172 2e67 7a27 297d 290a 0a20  e2.tar.gz')}).. 
+00028220: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+00028230: 5f64 6972 6563 746f 7279 2873 656c 6629  _directory(self)
+00028240: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
+00028250: 203d 2073 656c 662e 636c 6965 6e74 0a20   = self.client. 
+00028260: 2020 2020 2020 2063 6c69 656e 742e 6d61         client.ma
+00028270: 6b65 5f64 6972 2866 227b 7365 6c66 2e70  ke_dir(f"{self.p
+00028280: 7265 6669 787d 2f73 7562 6469 7222 290a  refix}/subdir").
+00028290: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000282a0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000282b0: 2020 2020 2020 636c 6965 6e74 2e6c 6973        client.lis
+000282c0: 745f 6669 6c65 7328 6622 7b73 656c 662e  t_files(f"{self.
+000282d0: 7072 6566 6978 7d2f 222c 2070 6174 7465  prefix}/", patte
+000282e0: 726e 3d27 7375 6264 6972 2729 5b30 5d2e  rn='subdir')[0].
+000282f0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00028300: 2020 6622 7b73 656c 662e 7072 6566 6978    f"{self.prefix
+00028310: 7d2f 7375 6264 6972 2229 0a20 2020 2020  }/subdir").     
+00028320: 2020 2063 6c69 656e 742e 6d61 6b65 5f64     client.make_d
+00028330: 6972 2866 227b 7365 6c66 2e70 7265 6669  ir(f"{self.prefi
+00028340: 787d 2f73 7562 6469 722f 7375 6264 6972  x}/subdir/subdir
+00028350: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00028360: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00028370: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
+00028380: 6c69 7374 5f66 696c 6573 2866 227b 7365  list_files(f"{se
+00028390: 6c66 2e70 7265 6669 787d 2f73 7562 6469  lf.prefix}/subdi
+000283a0: 7222 2c20 7061 7474 6572 6e3d 2773 7562  r", pattern='sub
+000283b0: 6469 7227 295b 305d 2e70 6174 682c 0a20  dir')[0].path,. 
+000283c0: 2020 2020 2020 2020 2020 2066 227b 7365             f"{se
+000283d0: 6c66 2e70 7265 6669 787d 2f73 7562 6469  lf.prefix}/subdi
+000283e0: 722f 7375 6264 6972 2229 0a0a 2020 2020  r/subdir")..    
+000283f0: 6465 6620 7465 7374 5f6d 616b 655f 6469  def test_make_di
+00028400: 7265 6374 6f72 795f 7265 6375 7273 6976  rectory_recursiv
+00028410: 656c 7928 7365 6c66 293a 0a20 2020 2020  ely(self):.     
+00028420: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00028430: 2e63 6c69 656e 740a 0a20 2020 2020 2020  .client..       
+00028440: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00028450: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
+00028460: 6174 6845 7272 6f72 2920 6173 2063 6d3a  athError) as cm:
+00028470: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00028480: 656e 742e 6d61 6b65 5f64 6972 2866 227b  ent.make_dir(f"{
+00028490: 7365 6c66 2e70 7265 6669 787d 2f73 7562  self.prefix}/sub
+000284a0: 6469 722f 7375 6264 6972 222c 206d 616b  dir/subdir", mak
+000284b0: 655f 7061 7265 6e74 733d 4661 6c73 6529  e_parents=False)
+000284c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000284d0: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+000284e0: 6570 7469 6f6e 2e6b 696e 642c 2027 6e6f  eption.kind, 'no
+000284f0: 742d 666f 756e 6427 290a 0a20 2020 2020  t-found')..     
+00028500: 2020 2063 6c69 656e 742e 6d61 6b65 5f64     client.make_d
+00028510: 6972 2866 227b 7365 6c66 2e70 7265 6669  ir(f"{self.prefi
+00028520: 787d 2f73 7562 6469 722f 7375 6264 6972  x}/subdir/subdir
+00028530: 222c 206d 616b 655f 7061 7265 6e74 733d  ", make_parents=
+00028540: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+00028550: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+00028560: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00028570: 6e74 2e6c 6973 745f 6669 6c65 7328 6622  nt.list_files(f"
+00028580: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
+00028590: 6264 6972 222c 2070 6174 7465 726e 3d27  bdir", pattern='
+000285a0: 7375 6264 6972 2729 5b30 5d2e 7061 7468  subdir')[0].path
+000285b0: 2c0a 2020 2020 2020 2020 2020 2020 6622  ,.            f"
+000285c0: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
+000285d0: 6264 6972 2f73 7562 6469 7222 290a 0a20  bdir/subdir").. 
+000285e0: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+000285f0: 5f64 6972 6563 746f 7279 5f77 6974 685f  _directory_with_
+00028600: 7265 6c61 7469 7665 5f70 6174 685f 6661  relative_path_fa
+00028610: 696c 7328 7365 6c66 293a 0a20 2020 2020  ils(self):.     
+00028620: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00028630: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00028640: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00028650: 5261 6973 6573 2870 6562 626c 652e 5061  Raises(pebble.Pa
+00028660: 7468 4572 726f 7229 2061 7320 636d 3a0a  thError) as cm:.
+00028670: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00028680: 6e74 2e6d 616b 655f 6469 7228 2764 6972  nt.make_dir('dir
+00028690: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000286a0: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
+000286b0: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
+000286c0: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
+000286d0: 6f72 2729 0a0a 2020 2020 6465 6620 7465  or')..    def te
+000286e0: 7374 5f6d 616b 655f 7375 6264 6972 5f6f  st_make_subdir_o
+000286f0: 665f 6669 6c65 5f66 6169 6c73 2873 656c  f_file_fails(sel
+00028700: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
+00028710: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
+00028720: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00028730: 7075 7368 2866 227b 7365 6c66 2e70 7265  push(f"{self.pre
+00028740: 6669 787d 2f66 696c 6522 2c20 2764 6174  fix}/file", 'dat
+00028750: 6127 290a 0a20 2020 2020 2020 2023 2044  a')..        # D
+00028760: 6972 6563 7420 6368 696c 6420 6361 7365  irect child case
+00028770: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00028780: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00028790: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
+000287a0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+000287b0: 2020 2020 2063 6c69 656e 742e 6d61 6b65       client.make
+000287c0: 5f64 6972 2866 227b 7365 6c66 2e70 7265  _dir(f"{self.pre
+000287d0: 6669 787d 2f66 696c 652f 7375 6264 6972  fix}/file/subdir
+000287e0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+000287f0: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
+00028800: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
+00028810: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
+00028820: 6f72 2729 0a0a 2020 2020 2020 2020 2320  or')..        # 
+00028830: 5265 6375 7273 6976 6520 6372 6561 7469  Recursive creati
+00028840: 6f6e 2063 6173 652c 2069 6e20 6361 7365  on case, in case
+00028850: 2069 7473 2066 6c6f 7720 6973 2064 6966   its flow is dif
+00028860: 6665 7265 6e74 0a20 2020 2020 2020 2077  ferent.        w
+00028870: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00028880: 6169 7365 7328 7065 6262 6c65 2e50 6174  aises(pebble.Pat
+00028890: 6845 7272 6f72 2920 6173 2063 6d3a 0a20  hError) as cm:. 
+000288a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+000288b0: 742e 6d61 6b65 5f64 6972 2866 227b 7365  t.make_dir(f"{se
+000288c0: 6c66 2e70 7265 6669 787d 2f66 696c 652f  lf.prefix}/file/
+000288d0: 7375 6264 6972 2f73 7562 6469 7222 2c20  subdir/subdir", 
+000288e0: 6d61 6b65 5f70 6172 656e 7473 3d54 7275  make_parents=Tru
+000288f0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00028900: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
+00028910: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
+00028920: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
+00028930: 6f72 2729 0a0a 2020 2020 6465 6620 7465  or')..    def te
+00028940: 7374 5f6d 616b 655f 6469 725f 7769 7468  st_make_dir_with
+00028950: 5f70 6572 6d69 7373 696f 6e5f 6d61 736b  _permission_mask
+00028960: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00028970: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+00028980: 6965 6e74 0a20 2020 2020 2020 2063 6c69  ient.        cli
+00028990: 656e 742e 6d61 6b65 5f64 6972 2866 227b  ent.make_dir(f"{
+000289a0: 7365 6c66 2e70 7265 6669 787d 2f64 6972  self.prefix}/dir
+000289b0: 3122 2c20 7065 726d 6973 7369 6f6e 733d  1", permissions=
+000289c0: 306f 3730 3029 0a20 2020 2020 2020 2063  0o700).        c
+000289d0: 6c69 656e 742e 6d61 6b65 5f64 6972 2866  lient.make_dir(f
+000289e0: 227b 7365 6c66 2e70 7265 6669 787d 2f64  "{self.prefix}/d
+000289f0: 6972 3222 2c20 7065 726d 6973 7369 6f6e  ir2", permission
+00028a00: 733d 306f 3737 3729 0a0a 2020 2020 2020  s=0o777)..      
+00028a10: 2020 6669 6c65 7320 3d20 636c 6965 6e74    files = client
+00028a20: 2e6c 6973 745f 6669 6c65 7328 6622 7b73  .list_files(f"{s
+00028a30: 656c 662e 7072 6566 6978 7d2f 222c 2070  elf.prefix}/", p
+00028a40: 6174 7465 726e 3d27 6469 722a 2729 0a20  attern='dir*'). 
+00028a50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00028a60: 7274 4571 7561 6c28 5b66 2066 6f72 2066  rtEqual([f for f
+00028a70: 2069 6e20 6669 6c65 7320 6966 2066 2e70   in files if f.p
+00028a80: 6174 6820 3d3d 2066 227b 7365 6c66 2e70  ath == f"{self.p
+00028a90: 7265 6669 787d 2f64 6972 3122 5d0a 2020  refix}/dir1"].  
+00028aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ab0: 2020 2020 2020 205b 305d 2e70 6572 6d69         [0].permi
+00028ac0: 7373 696f 6e73 2c20 306f 3730 3029 0a20  ssions, 0o700). 
+00028ad0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00028ae0: 7274 4571 7561 6c28 5b66 2066 6f72 2066  rtEqual([f for f
+00028af0: 2069 6e20 6669 6c65 7320 6966 2066 2e70   in files if f.p
+00028b00: 6174 6820 3d3d 2066 227b 7365 6c66 2e70  ath == f"{self.p
+00028b10: 7265 6669 787d 2f64 6972 3222 5d0a 2020  refix}/dir2"].  
+00028b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b30: 2020 2020 2020 205b 305d 2e70 6572 6d69         [0].permi
+00028b40: 7373 696f 6e73 2c20 306f 3737 3729 0a0a  ssions, 0o777)..
+00028b50: 2020 2020 2020 2020 2320 4966 2070 6572          # If per
+00028b60: 6d69 7373 696f 6e73 2061 7265 206f 7574  missions are out
+00028b70: 7369 6465 206f 6620 7468 6520 7261 6e67  side of the rang
+00028b80: 6520 306f 3030 3020 7468 726f 7567 6820  e 0o000 through 
+00028b90: 306f 3737 372c 2061 6e20 6578 6365 7074  0o777, an except
+00028ba0: 696f 6e20 7368 6f75 6c64 2062 650a 2020  ion should be.  
+00028bb0: 2020 2020 2020 2320 7261 6973 6564 2e0a        # raised..
+00028bc0: 2020 2020 2020 2020 666f 7220 692c 2062          for i, b
+00028bd0: 6164 5f70 6572 6d69 7373 696f 6e20 696e  ad_permission in
+00028be0: 2065 6e75 6d65 7261 7465 2828 0a20 2020   enumerate((.   
+00028bf0: 2020 2020 2020 2020 2030 6f31 3030 302c           0o1000,
+00028c00: 2020 2320 4578 6365 6564 7320 306f 3737    # Exceeds 0o77
+00028c10: 370a 2020 2020 2020 2020 2020 2020 2d31  7.            -1
+00028c20: 2c20 2020 2020 2023 204c 6573 7320 7468  ,      # Less th
+00028c30: 616e 2030 6f30 3030 0a20 2020 2020 2020  an 0o000.       
+00028c40: 2029 293a 0a20 2020 2020 2020 2020 2020   )):.           
+00028c50: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00028c60: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
+00028c70: 6174 6845 7272 6f72 2920 6173 2063 6d3a  athError) as cm:
+00028c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028c90: 2063 6c69 656e 742e 6d61 6b65 5f64 6972   client.make_dir
+00028ca0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00028cb0: 2f64 6972 335f 7b69 7d22 2c20 7065 726d  /dir3_{i}", perm
+00028cc0: 6973 7369 6f6e 733d 6261 645f 7065 726d  issions=bad_perm
+00028cd0: 6973 7369 6f6e 290a 2020 2020 2020 2020  ission).        
+00028ce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00028cf0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00028d00: 6e2e 6b69 6e64 2c20 2767 656e 6572 6963  n.kind, 'generic
+00028d10: 2d66 696c 652d 6572 726f 7227 290a 0a20  -file-error').. 
+00028d20: 2020 2064 6566 2074 6573 745f 7265 6d6f     def test_remo
+00028d30: 7665 5f70 6174 6828 7365 6c66 293a 0a20  ve_path(self):. 
+00028d40: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+00028d50: 7365 6c66 2e63 6c69 656e 740a 2020 2020  self.client.    
+00028d60: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
+00028d70: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00028d80: 6669 6c65 222c 2027 2729 0a20 2020 2020  file", '').     
+00028d90: 2020 2063 6c69 656e 742e 6d61 6b65 5f64     client.make_d
+00028da0: 6972 2866 227b 7365 6c66 2e70 7265 6669  ir(f"{self.prefi
+00028db0: 787d 2f64 6972 2f73 7562 6469 7222 2c20  x}/dir/subdir", 
+00028dc0: 6d61 6b65 5f70 6172 656e 7473 3d54 7275  make_parents=Tru
+00028dd0: 6529 0a20 2020 2020 2020 2063 6c69 656e  e).        clien
+00028de0: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
+00028df0: 7265 6669 787d 2f64 6972 2f73 7562 6469  refix}/dir/subdi
+00028e00: 722f 6669 6c65 3122 2c20 2727 290a 2020  r/file1", '').  
+00028e10: 2020 2020 2020 636c 6965 6e74 2e70 7573        client.pus
+00028e20: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
+00028e30: 7d2f 6469 722f 7375 6264 6972 2f66 696c  }/dir/subdir/fil
+00028e40: 6532 222c 2027 2729 0a20 2020 2020 2020  e2", '').       
+00028e50: 2063 6c69 656e 742e 7075 7368 2866 227b   client.push(f"{
+00028e60: 7365 6c66 2e70 7265 6669 787d 2f64 6972  self.prefix}/dir
+00028e70: 2f73 7562 6469 722f 6669 6c65 3322 2c20  /subdir/file3", 
+00028e80: 2727 290a 2020 2020 2020 2020 636c 6965  '').        clie
+00028e90: 6e74 2e6d 616b 655f 6469 7228 6622 7b73  nt.make_dir(f"{s
+00028ea0: 656c 662e 7072 6566 6978 7d2f 656d 7074  elf.prefix}/empt
+00028eb0: 795f 6469 7222 290a 0a20 2020 2020 2020  y_dir")..       
+00028ec0: 2063 6c69 656e 742e 7265 6d6f 7665 5f70   client.remove_p
+00028ed0: 6174 6828 6622 7b73 656c 662e 7072 6566  ath(f"{self.pref
+00028ee0: 6978 7d2f 6669 6c65 2229 0a0a 2020 2020  ix}/file")..    
+00028ef0: 2020 2020 636c 6965 6e74 2e72 656d 6f76      client.remov
+00028f00: 655f 7061 7468 2866 227b 7365 6c66 2e70  e_path(f"{self.p
+00028f10: 7265 6669 787d 2f65 6d70 7479 5f64 6972  refix}/empty_dir
+00028f20: 2229 0a0a 2020 2020 2020 2020 2320 5265  ")..        # Re
+00028f30: 6d6f 7665 206e 6f6e 2d65 6d70 7479 2064  move non-empty d
+00028f40: 6972 6563 746f 7279 2c20 7265 6375 7273  irectory, recurs
+00028f50: 6976 653d 4661 6c73 653a 2065 7272 6f72  ive=False: error
+00028f60: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00028f70: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00028f80: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
+00028f90: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00028fa0: 2020 2020 2063 6c69 656e 742e 7265 6d6f       client.remo
+00028fb0: 7665 5f70 6174 6828 6622 7b73 656c 662e  ve_path(f"{self.
+00028fc0: 7072 6566 6978 7d2f 6469 7222 2c20 7265  prefix}/dir", re
+00028fd0: 6375 7273 6976 653d 4661 6c73 6529 0a20  cursive=False). 
+00028fe0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00028ff0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+00029000: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
+00029010: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
+00029020: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
+00029030: 7665 206e 6f6e 2d65 6d70 7479 2064 6972  ve non-empty dir
+00029040: 6563 746f 7279 2c20 7265 6375 7273 6976  ectory, recursiv
+00029050: 653d 5472 7565 3a20 7375 6363 6565 6473  e=True: succeeds
+00029060: 2028 616e 6420 7265 6d6f 7665 7320 6368   (and removes ch
+00029070: 696c 6420 6f62 6a65 6374 7329 0a20 2020  ild objects).   
+00029080: 2020 2020 2063 6c69 656e 742e 7265 6d6f       client.remo
+00029090: 7665 5f70 6174 6828 6622 7b73 656c 662e  ve_path(f"{self.
+000290a0: 7072 6566 6978 7d2f 6469 7222 2c20 7265  prefix}/dir", re
+000290b0: 6375 7273 6976 653d 5472 7565 290a 0a20  cursive=True).. 
+000290c0: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
+000290d0: 6e6f 6e2d 6578 6973 7465 6e74 2070 6174  non-existent pat
+000290e0: 682c 2072 6563 7572 7369 7665 3d46 616c  h, recursive=Fal
+000290f0: 7365 3a20 6572 726f 720a 2020 2020 2020  se: error.      
+00029100: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00029110: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
+00029120: 5061 7468 4572 726f 7229 2061 7320 636d  PathError) as cm
+00029130: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00029140: 6965 6e74 2e72 656d 6f76 655f 7061 7468  ient.remove_path
+00029150: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00029160: 2f64 6972 2f64 6f65 732f 6e6f 742f 6578  /dir/does/not/ex
+00029170: 6973 742f 6173 6466 222c 2072 6563 7572  ist/asdf", recur
+00029180: 7369 7665 3d46 616c 7365 290a 2020 2020  sive=False).    
+00029190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000291a0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+000291b0: 6e2e 6b69 6e64 2c20 276e 6f74 2d66 6f75  n.kind, 'not-fou
+000291c0: 6e64 2729 0a0a 2020 2020 2020 2020 2320  nd')..        # 
+000291d0: 5265 6d6f 7665 206e 6f6e 2d65 7869 7374  Remove non-exist
+000291e0: 656e 7420 7061 7468 2c20 7265 6375 7273  ent path, recurs
+000291f0: 6976 653d 5472 7565 3a20 7375 6363 6565  ive=True: succee
+00029200: 6473 0a20 2020 2020 2020 2063 6c69 656e  ds.        clien
+00029210: 742e 7265 6d6f 7665 5f70 6174 6828 6622  t.remove_path(f"
+00029220: 7b73 656c 662e 7072 6566 6978 7d2f 6469  {self.prefix}/di
+00029230: 722f 646f 6573 2f6e 6f74 2f65 7869 7374  r/does/not/exist
+00029240: 2f61 7364 6622 2c20 7265 6375 7273 6976  /asdf", recursiv
+00029250: 653d 5472 7565 290a 0a20 2020 2023 204f  e=True)..    # O
+00029260: 7468 6572 206e 6f74 6573 3a0a 2020 2020  ther notes:.    
+00029270: 2320 2a20 5061 7265 6e74 2064 6972 6563  # * Parent direc
+00029280: 746f 7269 6573 2063 7265 6174 6564 2076  tories created v
+00029290: 6961 2070 7573 6828 6d61 6b65 5f64 6972  ia push(make_dir
+000292a0: 733d 5472 7565 2920 6465 6661 756c 7420  s=True) default 
+000292b0: 746f 2072 6f6f 743a 726f 6f74 206f 776e  to root:root own
+000292c0: 6572 7368 6970 0a20 2020 2023 2020 2061  ership.    #   a
+000292d0: 6e64 2077 6861 7465 7665 7220 7065 726d  nd whatever perm
+000292e0: 6973 7369 6f6e 7320 6172 6520 7370 6563  issions are spec
+000292f0: 6966 6965 6420 7669 6120 7468 6520 7065  ified via the pe
+00029300: 726d 6973 7369 6f6e 7320 6172 6775 6d65  rmissions argume
+00029310: 6e74 3b20 6173 2077 6520 6465 6661 756c  nt; as we defaul
+00029320: 7420 746f 204e 6f6e 650a 2020 2020 2320  t to None.    # 
+00029330: 2020 666f 7220 6f77 6e65 7273 6869 702f    for ownership/
+00029340: 7065 726d 6973 7369 6f6e 732c 2077 6520  permissions, we 
+00029350: 646f 2069 676e 6f72 6520 7468 6973 206e  do ignore this n
+00029360: 7561 6e63 652e 0a20 2020 2023 202a 2050  uance..    # * P
+00029370: 6172 656e 7420 6469 7265 6374 6f72 6965  arent directorie
+00029380: 7320 6372 6561 7465 6420 7669 6120 6d61  s created via ma
+00029390: 6b65 5f64 6972 286d 616b 655f 7061 7265  ke_dir(make_pare
+000293a0: 6e74 733d 5472 7565 2920 6465 6661 756c  nts=True) defaul
+000293b0: 7420 746f 2072 6f6f 743a 726f 6f74 206f  t to root:root o
+000293c0: 776e 6572 7368 6970 0a20 2020 2023 2020  wnership.    #  
+000293d0: 2061 6e64 2030 6f37 3535 2070 6572 6d69   and 0o755 permi
+000293e0: 7373 696f 6e73 3b20 6173 2077 6520 6465  ssions; as we de
+000293f0: 6661 756c 7420 746f 204e 6f6e 6520 666f  fault to None fo
+00029400: 7220 6f77 6e65 7273 6869 702f 7065 726d  r ownership/perm
+00029410: 6973 7369 6f6e 732c 2077 6520 646f 2069  issions, we do i
+00029420: 676e 6f72 6520 7468 6973 0a20 2020 2023  gnore this.    #
+00029430: 2020 206e 7561 6e63 652e 0a0a 0a63 6c61     nuance....cla
+00029440: 7373 2054 6573 7450 6562 626c 6553 746f  ss TestPebbleSto
+00029450: 7261 6765 4150 4973 5573 696e 674d 6f63  rageAPIsUsingMoc
+00029460: 6b73 280a 2020 2020 2020 2020 756e 6974  ks(.        unit
+00029470: 7465 7374 2e54 6573 7443 6173 652c 0a20  test.TestCase,. 
+00029480: 2020 2020 2020 205f 5465 7374 696e 6750         _TestingP
+00029490: 6562 626c 6543 6c69 656e 744d 6978 696e  ebbleClientMixin
+000294a0: 2c0a 2020 2020 2020 2020 5f50 6562 626c  ,.        _Pebbl
+000294b0: 6553 746f 7261 6765 4150 4973 5465 7374  eStorageAPIsTest
+000294c0: 4d69 7869 6e29 3a0a 2020 2020 6465 6620  Mixin):.    def 
+000294d0: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
+000294e0: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
+000294f0: 203d 2027 2f70 7265 6669 7827 0a20 2020   = '/prefix'.   
+00029500: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00029510: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
+00029520: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
+00029530: 2020 2020 2069 6620 7365 6c66 2e70 7265       if self.pre
+00029540: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+00029550: 2073 656c 662e 636c 6965 6e74 2e6d 616b   self.client.mak
+00029560: 655f 6469 7228 7365 6c66 2e70 7265 6669  e_dir(self.prefi
+00029570: 782c 206d 616b 655f 7061 7265 6e74 733d  x, make_parents=
+00029580: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
+00029590: 6573 745f 636f 6e74 6169 6e65 725f 7374  est_container_st
+000295a0: 6f72 6167 655f 6d6f 756e 7473 2873 656c  orage_mounts(sel
+000295b0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+000295c0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+000295d0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+000295e0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+000295f0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00029600: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00029610: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
+00029620: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00029630: 2020 2020 2063 313a 0a20 2020 2020 2020       c1:.       
+00029640: 2020 2020 2020 2020 2020 2020 206d 6f75               mou
+00029650: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00029660: 2020 2020 2020 2020 2020 2020 202d 2073               - s
+00029670: 746f 7261 6765 3a20 7374 6f72 6531 0a20  torage: store1. 
+00029680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029690: 2020 2020 2020 2020 206c 6f63 6174 696f           locatio
+000296a0: 6e3a 202f 6d6f 756e 7473 2f66 6f6f 0a20  n: /mounts/foo. 
+000296b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000296c0: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+000296d0: 2020 2020 2020 206d 6f75 6e74 733a 0a20         mounts:. 
+000296e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296f0: 2020 2020 2020 202d 2073 746f 7261 6765         - storage
+00029700: 3a20 7374 6f72 6532 0a20 2020 2020 2020  : store2.       
+00029710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029720: 2020 206c 6f63 6174 696f 6e3a 202f 6d6f     location: /mo
+00029730: 756e 7473 2f66 6f6f 0a20 2020 2020 2020  unts/foo.       
+00029740: 2020 2020 2020 2020 2063 333a 0a20 2020           c3:.   
+00029750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029760: 206d 6f75 6e74 733a 0a20 2020 2020 2020   mounts:.       
+00029770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029780: 202d 2073 746f 7261 6765 3a20 7374 6f72   - storage: stor
+00029790: 6531 0a20 2020 2020 2020 2020 2020 2020  e1.             
+000297a0: 2020 2020 2020 2020 2020 2020 206c 6f63               loc
+000297b0: 6174 696f 6e3a 202f 6d6f 756e 7473 2f62  ation: /mounts/b
+000297c0: 6172 0a20 2020 2020 2020 2020 2020 2073  ar.            s
+000297d0: 746f 7261 6765 3a0a 2020 2020 2020 2020  torage:.        
+000297e0: 2020 2020 2020 2020 7374 6f72 6531 3a0a          store1:.
+000297f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029800: 2020 2020 7479 7065 3a20 6669 6c65 7379      type: filesy
+00029810: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
+00029820: 2020 2020 2073 746f 7265 323a 0a20 2020       store2:.   
+00029830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029840: 2074 7970 653a 2066 696c 6573 7973 7465   type: filesyste
+00029850: 6d0a 2020 2020 2020 2020 2020 2020 2727  m.            ''
+00029860: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00029870: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00029880: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
+00029890: 2020 2020 2073 746f 7265 5f69 6420 3d20       store_id = 
+000298a0: 6861 726e 6573 732e 6164 645f 7374 6f72  harness.add_stor
+000298b0: 6167 6528 2773 746f 7265 3127 295b 305d  age('store1')[0]
+000298c0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000298d0: 2e61 7474 6163 685f 7374 6f72 6167 6528  .attach_storage(
+000298e0: 7374 6f72 655f 6964 290a 0a20 2020 2020  store_id)..     
+000298f0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00029900: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+00029910: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+00029920: 6374 2827 6331 272c 2054 7275 6529 0a20  ct('c1', True). 
+00029930: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+00029940: 6574 5f63 616e 5f63 6f6e 6e65 6374 2827  et_can_connect('
+00029950: 6332 272c 2054 7275 6529 0a20 2020 2020  c2', True).     
+00029960: 2020 2068 6172 6e65 7373 2e73 6574 5f63     harness.set_c
+00029970: 616e 5f63 6f6e 6e65 6374 2827 6333 272c  an_connect('c3',
+00029980: 2054 7275 6529 0a0a 2020 2020 2020 2020   True)..        
+00029990: 2320 7075 7368 2066 696c 6520 746f 2063  # push file to c
+000299a0: 3120 7374 6f72 6167 6520 6d6f 756e 742c  1 storage mount,
+000299b0: 2063 6865 636b 2074 6861 7420 7765 2063   check that we c
+000299c0: 616e 2073 6565 2069 7420 696e 2063 6861  an see it in cha
+000299d0: 726d 2063 6f6e 7461 696e 6572 2073 746f  rm container sto
+000299e0: 7261 6765 2070 6174 682e 0a20 2020 2020  rage path..     
+000299f0: 2020 2063 3120 3d20 6861 726e 6573 732e     c1 = harness.
+00029a00: 6d6f 6465 6c2e 756e 6974 2e67 6574 5f63  model.unit.get_c
+00029a10: 6f6e 7461 696e 6572 2827 6331 2729 0a20  ontainer('c1'). 
+00029a20: 2020 2020 2020 2063 315f 666e 616d 6520         c1_fname 
+00029a30: 3d20 2766 6f6f 2e74 7874 270a 2020 2020  = 'foo.txt'.    
+00029a40: 2020 2020 6331 5f66 7061 7468 203d 206f      c1_fpath = o
+00029a50: 732e 7061 7468 2e6a 6f69 6e28 272f 6d6f  s.path.join('/mo
+00029a60: 756e 7473 2f66 6f6f 272c 2063 315f 666e  unts/foo', c1_fn
+00029a70: 616d 6529 0a20 2020 2020 2020 2063 312e  ame).        c1.
+00029a80: 7075 7368 2863 315f 6670 6174 682c 2027  push(c1_fpath, '
+00029a90: 3432 2729 0a20 2020 2020 2020 2073 656c  42').        sel
+00029aa0: 662e 6173 7365 7274 5472 7565 2863 312e  f.assertTrue(c1.
+00029ab0: 6578 6973 7473 2863 315f 6670 6174 6829  exists(c1_fpath)
+00029ac0: 290a 2020 2020 2020 2020 6670 6174 6820  ).        fpath 
+00029ad0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
+00029ae0: 7472 2868 6172 6e65 7373 2e6d 6f64 656c  tr(harness.model
+00029af0: 2e73 746f 7261 6765 735b 2773 746f 7265  .storages['store
+00029b00: 3127 5d5b 305d 2e6c 6f63 6174 696f 6e29  1'][0].location)
+00029b10: 2c20 2766 6f6f 2e74 7874 2729 0a20 2020  , 'foo.txt').   
+00029b20: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
+00029b30: 7061 7468 2920 6173 2066 3a0a 2020 2020  path) as f:.    
+00029b40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00029b50: 6572 7445 7175 616c 2827 3432 272c 2066  ertEqual('42', f
+00029b60: 2e72 6561 6428 2929 0a0a 2020 2020 2020  .read())..      
+00029b70: 2020 2320 6368 6563 6b20 7468 6174 2074    # check that t
+00029b80: 6865 2066 696c 6520 6973 206e 6f74 2076  he file is not v
+00029b90: 6973 6962 6c65 2069 6e20 6332 2077 6869  isible in c2 whi
+00029ba0: 6368 2068 6173 2061 2064 6966 6665 7265  ch has a differe
+00029bb0: 6e74 2073 746f 7261 6765 206d 6f75 6e74  nt storage mount
+00029bc0: 0a20 2020 2020 2020 2063 3220 3d20 6861  .        c2 = ha
+00029bd0: 726e 6573 732e 6d6f 6465 6c2e 756e 6974  rness.model.unit
+00029be0: 2e67 6574 5f63 6f6e 7461 696e 6572 2827  .get_container('
+00029bf0: 6332 2729 0a20 2020 2020 2020 2063 325f  c2').        c2_
+00029c00: 6670 6174 6820 3d20 6f73 2e70 6174 682e  fpath = os.path.
+00029c10: 6a6f 696e 2827 2f6d 6f75 6e74 732f 666f  join('/mounts/fo
+00029c20: 6f27 2c20 6331 5f66 6e61 6d65 290a 2020  o', c1_fname).  
+00029c30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00029c40: 7446 616c 7365 2863 322e 6578 6973 7473  tFalse(c2.exists
+00029c50: 2863 325f 6670 6174 6829 290a 0a20 2020  (c2_fpath))..   
+00029c60: 2020 2020 2023 2063 6865 636b 2074 6861       # check tha
+00029c70: 7420 7468 6520 6669 6c65 2069 7320 7669  t the file is vi
+00029c80: 7369 626c 6520 696e 2063 3320 7768 6963  sible in c3 whic
+00029c90: 6820 6861 7320 7468 6520 7361 6d65 2073  h has the same s
+00029ca0: 746f 7261 6765 206d 6f75 6e74 0a20 2020  torage mount.   
+00029cb0: 2020 2020 2063 3320 3d20 6861 726e 6573       c3 = harnes
+00029cc0: 732e 6d6f 6465 6c2e 756e 6974 2e67 6574  s.model.unit.get
+00029cd0: 5f63 6f6e 7461 696e 6572 2827 6333 2729  _container('c3')
+00029ce0: 0a20 2020 2020 2020 2063 335f 6670 6174  .        c3_fpat
+00029cf0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+00029d00: 2827 2f6d 6f75 6e74 732f 6261 7227 2c20  ('/mounts/bar', 
+00029d10: 6331 5f66 6e61 6d65 290a 2020 2020 2020  c1_fname).      
+00029d20: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00029d30: 6528 6333 2e65 7869 7374 7328 6333 5f66  e(c3.exists(c3_f
+00029d40: 7061 7468 2929 0a20 2020 2020 2020 2077  path)).        w
+00029d50: 6974 6820 6333 2e70 756c 6c28 6333 5f66  ith c3.pull(c3_f
+00029d60: 7061 7468 2920 6173 2066 3a0a 2020 2020  path) as f:.    
+00029d70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00029d80: 6572 7445 7175 616c 2827 3432 272c 2066  ertEqual('42', f
+00029d90: 2e72 6561 6428 2929 0a0a 2020 2020 2020  .read())..      
+00029da0: 2020 2320 7465 7374 2061 6c6c 206f 7468    # test all oth
+00029db0: 6572 2063 6f6e 7461 696e 6572 2066 696c  er container fil
+00029dc0: 6520 6f70 730a 2020 2020 2020 2020 7769  e ops.        wi
+00029dd0: 7468 2063 312e 7075 6c6c 2863 315f 6670  th c1.pull(c1_fp
+00029de0: 6174 6829 2061 7320 663a 0a20 2020 2020  ath) as f:.     
+00029df0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00029e00: 7274 4571 7561 6c28 2734 3227 2c20 662e  rtEqual('42', f.
+00029e10: 7265 6164 2829 290a 2020 2020 2020 2020  read()).        
+00029e20: 6669 6c65 7320 3d20 6331 2e6c 6973 745f  files = c1.list_
+00029e30: 6669 6c65 7328 6331 5f66 7061 7468 290a  files(c1_fpath).
+00029e40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00029e50: 6572 7445 7175 616c 285b 6331 5f66 7061  ertEqual([c1_fpa
+00029e60: 7468 5d2c 205b 6669 2e70 6174 6820 666f  th], [fi.path fo
+00029e70: 7220 6669 2069 6e20 6669 6c65 735d 290a  r fi in files]).
+00029e80: 2020 2020 2020 2020 6331 2e72 656d 6f76          c1.remov
+00029e90: 655f 7061 7468 2863 315f 6670 6174 6829  e_path(c1_fpath)
+00029ea0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00029eb0: 7365 7274 4661 6c73 6528 6331 2e65 7869  sertFalse(c1.exi
+00029ec0: 7374 7328 6331 5f66 7061 7468 2929 0a0a  sts(c1_fpath))..
+00029ed0: 2020 2020 2020 2020 2320 7465 7374 2064          # test d
+00029ee0: 6574 6163 6869 6e67 2073 746f 7261 6765  etaching storage
+00029ef0: 0a20 2020 2020 2020 2063 312e 7075 7368  .        c1.push
+00029f00: 2863 315f 6670 6174 682c 2027 3432 2729  (c1_fpath, '42')
+00029f10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00029f20: 7365 7274 5472 7565 2863 312e 6578 6973  sertTrue(c1.exis
+00029f30: 7473 2863 315f 6670 6174 6829 290a 2020  ts(c1_fpath)).  
+00029f40: 2020 2020 2020 7374 6f72 6531 5f69 6420        store1_id 
+00029f50: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
+00029f60: 7374 6f72 6167 6573 5b27 7374 6f72 6531  storages['store1
+00029f70: 275d 5b30 5d2e 6675 6c6c 5f69 640a 2020  '][0].full_id.  
+00029f80: 2020 2020 2020 6861 726e 6573 732e 7265        harness.re
+00029f90: 6d6f 7665 5f73 746f 7261 6765 2873 746f  move_storage(sto
+00029fa0: 7265 315f 6964 290a 2020 2020 2020 2020  re1_id).        
+00029fb0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+00029fc0: 2863 312e 6578 6973 7473 2863 315f 6670  (c1.exists(c1_fp
+00029fd0: 6174 6829 290a 0a20 2020 2064 6566 205f  ath))..    def _
+00029fe0: 7365 6c65 6374 5f74 6573 7469 6e67 5f75  select_testing_u
+00029ff0: 7365 725f 6772 6f75 7028 7365 6c66 293a  ser_group(self):
+0002a000: 0a20 2020 2020 2020 2075 7365 7220 3d20  .        user = 
+0002a010: 5b75 2066 6f72 2075 2069 6e20 7077 642e  [u for u in pwd.
+0002a020: 6765 7470 7761 6c6c 2829 2069 6620 752e  getpwall() if u.
+0002a030: 7077 5f75 6964 2021 3d20 6f73 2e67 6574  pw_uid != os.get
+0002a040: 7569 6428 295d 5b30 5d0a 2020 2020 2020  uid()][0].      
+0002a050: 2020 6772 6f75 7020 3d20 5b67 2066 6f72    group = [g for
+0002a060: 2067 2069 6e20 6772 702e 6765 7467 7261   g in grp.getgra
+0002a070: 6c6c 2829 2069 6620 672e 6772 5f67 6964  ll() if g.gr_gid
+0002a080: 2021 3d20 6f73 2e67 6574 6769 6428 295d   != os.getgid()]
+0002a090: 5b30 5d0a 2020 2020 2020 2020 7265 7475  [0].        retu
+0002a0a0: 726e 2075 7365 722c 2067 726f 7570 0a0a  rn user, group..
+0002a0b0: 2020 2020 6465 6620 7465 7374 5f70 7573      def test_pus
+0002a0c0: 685f 7769 7468 5f6f 776e 6572 7368 6970  h_with_ownership
+0002a0d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002a0e0: 6461 7461 203d 2027 6461 7461 270a 2020  data = 'data'.  
+0002a0f0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+0002a100: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
+0002a110: 2020 2075 7365 722c 2067 726f 7570 203d     user, group =
+0002a120: 2073 656c 662e 5f73 656c 6563 745f 7465   self._select_te
+0002a130: 7374 696e 675f 7573 6572 5f67 726f 7570  sting_user_group
+0002a140: 2829 0a20 2020 2020 2020 2063 6173 6573  ().        cases
+0002a150: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002a160: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a170: 2020 2022 7573 6572 5f69 6422 3a20 7573     "user_id": us
+0002a180: 6572 2e70 775f 7569 642c 0a20 2020 2020  er.pw_uid,.     
+0002a190: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a1a0: 223a 204e 6f6e 652c 0a20 2020 2020 2020  ": None,.       
+0002a1b0: 2020 2020 2020 2020 2022 6772 6f75 705f           "group_
+0002a1c0: 6964 223a 2067 726f 7570 2e67 725f 6769  id": group.gr_gi
+0002a1d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002a1e0: 2020 2022 6772 6f75 7022 3a20 4e6f 6e65     "group": None
+0002a1f0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a200: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0002a210: 2020 2020 2020 2020 2020 2020 2020 2275                "u
+0002a220: 7365 725f 6964 223a 204e 6f6e 652c 0a20  ser_id": None,. 
+0002a230: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a240: 7573 6572 223a 2075 7365 722e 7077 5f6e  user": user.pw_n
+0002a250: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002a260: 2020 2020 2022 6772 6f75 705f 6964 223a       "group_id":
+0002a270: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0002a280: 2020 2020 2020 2022 6772 6f75 7022 3a20         "group": 
+0002a290: 6772 6f75 702e 6772 5f6e 616d 650a 2020  group.gr_name.  
+0002a2a0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0002a2b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0002a2c0: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a2d0: 5f69 6422 3a20 4e6f 6e65 2c0a 2020 2020  _id": None,.    
+0002a2e0: 2020 2020 2020 2020 2020 2020 2275 7365              "use
+0002a2f0: 7222 3a20 7573 6572 2e70 775f 6e61 6d65  r": user.pw_name
+0002a300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a310: 2020 2267 726f 7570 5f69 6422 3a20 6772    "group_id": gr
+0002a320: 6f75 702e 6772 5f67 6964 2c0a 2020 2020  oup.gr_gid,.    
+0002a330: 2020 2020 2020 2020 2020 2020 2267 726f              "gro
+0002a340: 7570 223a 204e 6f6e 650a 2020 2020 2020  up": None.      
+0002a350: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a360: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0002a370: 2020 2020 2020 2022 7573 6572 5f69 6422         "user_id"
+0002a380: 3a20 7573 6572 2e70 775f 7569 642c 0a20  : user.pw_uid,. 
+0002a390: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a3a0: 7573 6572 223a 204e 6f6e 652c 0a20 2020  user": None,.   
+0002a3b0: 2020 2020 2020 2020 2020 2020 2022 6772               "gr
+0002a3c0: 6f75 705f 6964 223a 204e 6f6e 652c 0a20  oup_id": None,. 
+0002a3d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a3e0: 6772 6f75 7022 3a20 6772 6f75 702e 6772  group": group.gr
+0002a3f0: 5f6e 616d 650a 2020 2020 2020 2020 2020  _name.          
+0002a400: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0002a410: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a420: 2020 2022 7573 6572 5f69 6422 3a20 7573     "user_id": us
+0002a430: 6572 2e70 775f 7569 642c 0a20 2020 2020  er.pw_uid,.     
+0002a440: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a450: 223a 2075 7365 722e 7077 5f6e 616d 652c  ": user.pw_name,
+0002a460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a470: 2022 6772 6f75 705f 6964 223a 2067 726f   "group_id": gro
+0002a480: 7570 2e67 725f 6769 642c 0a20 2020 2020  up.gr_gid,.     
+0002a490: 2020 2020 2020 2020 2020 2022 6772 6f75             "grou
+0002a4a0: 7022 3a20 6772 6f75 702e 6772 5f6e 616d  p": group.gr_nam
+0002a4b0: 650a 2020 2020 2020 2020 2020 2020 7d0a  e.            }.
+0002a4c0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0002a4d0: 2020 666f 7220 6964 782c 2063 6173 6520    for idx, case 
+0002a4e0: 696e 2065 6e75 6d65 7261 7465 2863 6173  in enumerate(cas
+0002a4f0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+0002a500: 2063 6c69 656e 742e 7075 7368 2866 227b   client.push(f"{
+0002a510: 7365 6c66 2e70 7265 6669 787d 2f66 696c  self.prefix}/fil
+0002a520: 657b 6964 787d 222c 2064 6174 612c 202a  e{idx}", data, *
+0002a530: 2a63 6173 6529 0a20 2020 2020 2020 2020  *case).         
+0002a540: 2020 2066 696c 655f 203d 2063 6c69 656e     file_ = clien
+0002a550: 742e 6c69 7374 5f66 696c 6573 2866 227b  t.list_files(f"{
+0002a560: 7365 6c66 2e70 7265 6669 787d 2f66 696c  self.prefix}/fil
+0002a570: 657b 6964 787d 2229 5b30 5d0a 2020 2020  e{idx}")[0].    
+0002a580: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002a590: 6572 7445 7175 616c 2866 696c 655f 2e70  ertEqual(file_.p
+0002a5a0: 6174 682c 2066 227b 7365 6c66 2e70 7265  ath, f"{self.pre
+0002a5b0: 6669 787d 2f66 696c 657b 6964 787d 2229  fix}/file{idx}")
+0002a5c0: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
+0002a5d0: 616b 655f 6469 725f 7769 7468 5f6f 776e  ake_dir_with_own
+0002a5e0: 6572 7368 6970 2873 656c 6629 3a0a 2020  ership(self):.  
+0002a5f0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+0002a600: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
+0002a610: 2020 2075 7365 722c 2067 726f 7570 203d     user, group =
+0002a620: 2073 656c 662e 5f73 656c 6563 745f 7465   self._select_te
+0002a630: 7374 696e 675f 7573 6572 5f67 726f 7570  sting_user_group
+0002a640: 2829 0a20 2020 2020 2020 2063 6173 6573  ().        cases
+0002a650: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002a660: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a670: 2020 2022 7573 6572 5f69 6422 3a20 7573     "user_id": us
+0002a680: 6572 2e70 775f 7569 642c 0a20 2020 2020  er.pw_uid,.     
+0002a690: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a6a0: 223a 204e 6f6e 652c 0a20 2020 2020 2020  ": None,.       
+0002a6b0: 2020 2020 2020 2020 2022 6772 6f75 705f           "group_
+0002a6c0: 6964 223a 2067 726f 7570 2e67 725f 6769  id": group.gr_gi
+0002a6d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002a6e0: 2020 2022 6772 6f75 7022 3a20 4e6f 6e65     "group": None
+0002a6f0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a700: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0002a710: 2020 2020 2020 2020 2020 2020 2020 2275                "u
+0002a720: 7365 725f 6964 223a 204e 6f6e 652c 0a20  ser_id": None,. 
+0002a730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a740: 7573 6572 223a 2075 7365 722e 7077 5f6e  user": user.pw_n
+0002a750: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002a760: 2020 2020 2022 6772 6f75 705f 6964 223a       "group_id":
+0002a770: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0002a780: 2020 2020 2020 2022 6772 6f75 7022 3a20         "group": 
+0002a790: 6772 6f75 702e 6772 5f6e 616d 650a 2020  group.gr_name.  
+0002a7a0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0002a7b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0002a7c0: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a7d0: 5f69 6422 3a20 4e6f 6e65 2c0a 2020 2020  _id": None,.    
+0002a7e0: 2020 2020 2020 2020 2020 2020 2275 7365              "use
+0002a7f0: 7222 3a20 7573 6572 2e70 775f 6e61 6d65  r": user.pw_name
+0002a800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a810: 2020 2267 726f 7570 5f69 6422 3a20 6772    "group_id": gr
+0002a820: 6f75 702e 6772 5f67 6964 2c0a 2020 2020  oup.gr_gid,.    
+0002a830: 2020 2020 2020 2020 2020 2020 2267 726f              "gro
+0002a840: 7570 223a 204e 6f6e 650a 2020 2020 2020  up": None.      
+0002a850: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a860: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0002a870: 2020 2020 2020 2022 7573 6572 5f69 6422         "user_id"
+0002a880: 3a20 7573 6572 2e70 775f 7569 642c 0a20  : user.pw_uid,. 
+0002a890: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a8a0: 7573 6572 223a 204e 6f6e 652c 0a20 2020  user": None,.   
+0002a8b0: 2020 2020 2020 2020 2020 2020 2022 6772               "gr
+0002a8c0: 6f75 705f 6964 223a 204e 6f6e 652c 0a20  oup_id": None,. 
+0002a8d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a8e0: 6772 6f75 7022 3a20 6772 6f75 702e 6772  group": group.gr
+0002a8f0: 5f6e 616d 650a 2020 2020 2020 2020 2020  _name.          
+0002a900: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0002a910: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a920: 2020 2022 7573 6572 5f69 6422 3a20 7573     "user_id": us
+0002a930: 6572 2e70 775f 7569 642c 0a20 2020 2020  er.pw_uid,.     
+0002a940: 2020 2020 2020 2020 2020 2022 7573 6572             "user
+0002a950: 223a 2075 7365 722e 7077 5f6e 616d 652c  ": user.pw_name,
+0002a960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a970: 2022 6772 6f75 705f 6964 223a 2067 726f   "group_id": gro
+0002a980: 7570 2e67 725f 6769 642c 0a20 2020 2020  up.gr_gid,.     
+0002a990: 2020 2020 2020 2020 2020 2022 6772 6f75             "grou
+0002a9a0: 7022 3a20 6772 6f75 702e 6772 5f6e 616d  p": group.gr_nam
+0002a9b0: 650a 2020 2020 2020 2020 2020 2020 7d0a  e.            }.
+0002a9c0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0002a9d0: 2020 666f 7220 6964 782c 2063 6173 6520    for idx, case 
+0002a9e0: 696e 2065 6e75 6d65 7261 7465 2863 6173  in enumerate(cas
+0002a9f0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+0002aa00: 2063 6c69 656e 742e 6d61 6b65 5f64 6972   client.make_dir
+0002aa10: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+0002aa20: 2f64 6972 7b69 6478 7d22 2c20 2a2a 6361  /dir{idx}", **ca
+0002aa30: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0002aa40: 6469 725f 203d 2063 6c69 656e 742e 6c69  dir_ = client.li
+0002aa50: 7374 5f66 696c 6573 2866 227b 7365 6c66  st_files(f"{self
+0002aa60: 2e70 7265 6669 787d 2f64 6972 7b69 6478  .prefix}/dir{idx
+0002aa70: 7d22 2c20 6974 7365 6c66 3d54 7275 6529  }", itself=True)
+0002aa80: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0002aa90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002aaa0: 2864 6972 5f2e 7061 7468 2c20 6622 7b73  (dir_.path, f"{s
+0002aab0: 656c 662e 7072 6566 6978 7d2f 6469 727b  elf.prefix}/dir{
+0002aac0: 6964 787d 2229 0a0a 0a40 756e 6974 7465  idx}")...@unitte
+0002aad0: 7374 2e73 6b69 7055 6e6c 6573 7328 6f73  st.skipUnless(os
+0002aae0: 2e67 6574 656e 7628 2752 554e 5f52 4541  .getenv('RUN_REA
+0002aaf0: 4c5f 5045 4242 4c45 5f54 4553 5453 2729  L_PEBBLE_TESTS')
+0002ab00: 2c20 2752 554e 5f52 4541 4c5f 5045 4242  , 'RUN_REAL_PEBB
+0002ab10: 4c45 5f54 4553 5453 206e 6f74 2073 6574  LE_TESTS not set
+0002ab20: 2729 0a63 6c61 7373 2054 6573 7450 6562  ').class TestPeb
+0002ab30: 626c 6553 746f 7261 6765 4150 4973 5573  bleStorageAPIsUs
+0002ab40: 696e 6752 6561 6c50 6562 626c 6528 756e  ingRealPebble(un
+0002ab50: 6974 7465 7374 2e54 6573 7443 6173 652c  ittest.TestCase,
+0002ab60: 205f 5065 6262 6c65 5374 6f72 6167 6541   _PebbleStorageA
+0002ab70: 5049 7354 6573 744d 6978 696e 293a 0a20  PIsTestMixin):. 
+0002ab80: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
+0002ab90: 6629 3a0a 2020 2020 2020 2020 736f 636b  f):.        sock
+0002aba0: 6574 5f70 6174 6820 3d20 6f73 2e67 6574  et_path = os.get
+0002abb0: 656e 7628 2750 4542 424c 455f 534f 434b  env('PEBBLE_SOCK
+0002abc0: 4554 2729 0a20 2020 2020 2020 2070 6562  ET').        peb
+0002abd0: 626c 655f 6469 7220 3d20 6f73 2e67 6574  ble_dir = os.get
+0002abe0: 656e 7628 2750 4542 424c 4527 290a 2020  env('PEBBLE').  
+0002abf0: 2020 2020 2020 6966 206e 6f74 2073 6f63        if not soc
+0002ac00: 6b65 745f 7061 7468 2061 6e64 2070 6562  ket_path and peb
+0002ac10: 626c 655f 6469 723a 0a20 2020 2020 2020  ble_dir:.       
+0002ac20: 2020 2020 2073 6f63 6b65 745f 7061 7468       socket_path
+0002ac30: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0002ac40: 7065 6262 6c65 5f64 6972 2c20 272e 7065  pebble_dir, '.pe
+0002ac50: 6262 6c65 2e73 6f63 6b65 7427 290a 2020  bble.socket').  
+0002ac60: 2020 2020 2020 6173 7365 7274 2073 6f63        assert soc
+0002ac70: 6b65 745f 7061 7468 2061 6e64 2070 6562  ket_path and peb
+0002ac80: 626c 655f 6469 722c 2027 5045 4242 4c45  ble_dir, 'PEBBLE
+0002ac90: 206d 7573 7420 6265 2073 6574 2069 6620   must be set if 
+0002aca0: 5255 4e5f 5245 414c 5f50 4542 424c 455f  RUN_REAL_PEBBLE_
+0002acb0: 5445 5354 5320 7365 7427 0a0a 2020 2020  TESTS set'..    
+0002acc0: 2020 2020 7365 6c66 2e70 7265 6669 7820      self.prefix 
+0002acd0: 3d20 7465 6d70 6669 6c65 2e6d 6b64 7465  = tempfile.mkdte
+0002ace0: 6d70 2864 6972 3d70 6562 626c 655f 6469  mp(dir=pebble_di
+0002acf0: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
+0002ad00: 636c 6965 6e74 203d 2070 6562 626c 652e  client = pebble.
+0002ad10: 436c 6965 6e74 2873 6f63 6b65 745f 7061  Client(socket_pa
+0002ad20: 7468 3d73 6f63 6b65 745f 7061 7468 290a  th=socket_path).
+0002ad30: 0a20 2020 2064 6566 2074 6561 7244 6f77  .    def tearDow
+0002ad40: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+0002ad50: 2073 6875 7469 6c2e 726d 7472 6565 2873   shutil.rmtree(s
+0002ad60: 656c 662e 7072 6566 6978 290a 0a20 2020  elf.prefix)..   
+0002ad70: 2023 2052 656d 6f76 6520 7468 6973 2065   # Remove this e
+0002ad80: 6e74 6972 656c 7920 6f6e 6365 2074 6865  ntirely once the
+0002ad90: 2061 7373 6f63 6961 7465 6420 6275 6720   associated bug 
+0002ada0: 6973 2066 6978 6564 3b20 6974 206f 7665  is fixed; it ove
+0002adb0: 7272 6964 6573 2074 6865 206f 7269 6769  rrides the origi
+0002adc0: 6e61 6c20 7465 7374 2069 6e20 7468 650a  nal test in the.
+0002add0: 2020 2020 2320 7465 7374 206d 6978 696e      # test mixin
+0002ade0: 2063 6c61 7373 2e0a 2020 2020 4075 6e69   class..    @uni
+0002adf0: 7474 6573 742e 736b 6970 2827 7065 6e64  ttest.skip('pend
+0002ae00: 696e 6720 7265 736f 6c75 7469 6f6e 206f  ing resolution o
+0002ae10: 6620 6874 7470 733a 2f2f 6769 7468 7562  f https://github
+0002ae20: 2e63 6f6d 2f63 616e 6f6e 6963 616c 2f70  .com/canonical/p
+0002ae30: 6562 626c 652f 6973 7375 6573 2f38 3027  ebble/issues/80'
+0002ae40: 290a 2020 2020 6465 6620 7465 7374 5f6d  ).    def test_m
+0002ae50: 616b 655f 6469 725f 7769 7468 5f70 6572  ake_dir_with_per
+0002ae60: 6d69 7373 696f 6e5f 6d61 736b 2873 656c  mission_mask(sel
+0002ae70: 6629 3a0a 2020 2020 2020 2020 7061 7373  f):.        pass
+0002ae80: 0a0a 0a63 6c61 7373 2054 6573 7446 696c  ...class TestFil
+0002ae90: 6573 7973 7465 6d28 756e 6974 7465 7374  esystem(unittest
+0002aea0: 2e54 6573 7443 6173 652c 205f 5465 7374  .TestCase, _Test
+0002aeb0: 696e 6750 6562 626c 6543 6c69 656e 744d  ingPebbleClientM
+0002aec0: 6978 696e 293a 0a20 2020 2064 6566 2073  ixin):.    def s
+0002aed0: 6574 5570 2873 656c 6629 202d 3e20 4e6f  etUp(self) -> No
+0002aee0: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+0002aef0: 2e68 6172 6e65 7373 203d 206f 7073 2e74  .harness = ops.t
+0002af00: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+0002af10: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+0002af20: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0002af30: 2020 206e 616d 653a 2074 6573 740a 2020     name: test.  
+0002af40: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+0002af50: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
+0002af60: 2020 2020 2020 7465 7374 2d63 6f6e 7461        test-conta
+0002af70: 696e 6572 3a0a 2020 2020 2020 2020 2020  iner:.          
+0002af80: 2020 2020 2020 2020 2020 6d6f 756e 7473            mounts
+0002af90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002afa0: 2020 2020 2020 2020 2020 2d20 7374 6f72            - stor
+0002afb0: 6167 653a 2074 6573 742d 7374 6f72 6167  age: test-storag
+0002afc0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002afd0: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+0002afe0: 7469 6f6e 3a20 2f6d 6f75 6e74 732f 666f  tion: /mounts/fo
+0002aff0: 6f0a 2020 2020 2020 2020 2020 2020 7374  o.            st
+0002b000: 6f72 6167 653a 0a20 2020 2020 2020 2020  orage:.         
+0002b010: 2020 2020 2020 2074 6573 742d 7374 6f72         test-stor
+0002b020: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0002b030: 2020 2020 2020 2020 2074 7970 653a 2066           type: f
+0002b040: 696c 6573 7973 7465 6d0a 2020 2020 2020  ilesystem.      
+0002b050: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+0002b060: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0002b070: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+0002b080: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
+0002b090: 5f63 616e 5f63 6f6e 6e65 6374 2822 7465  _can_connect("te
+0002b0a0: 7374 2d63 6f6e 7461 696e 6572 222c 2054  st-container", T
+0002b0b0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+0002b0c0: 662e 726f 6f74 203d 2073 656c 662e 6861  f.root = self.ha
+0002b0d0: 726e 6573 732e 6765 745f 6669 6c65 7379  rness.get_filesy
+0002b0e0: 7374 656d 5f72 6f6f 7428 2274 6573 742d  stem_root("test-
+0002b0f0: 636f 6e74 6169 6e65 7222 290a 2020 2020  container").    
+0002b100: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0002b110: 6572 203d 2073 656c 662e 6861 726e 6573  er = self.harnes
+0002b120: 732e 6368 6172 6d2e 756e 6974 2e67 6574  s.charm.unit.get
+0002b130: 5f63 6f6e 7461 696e 6572 2822 7465 7374  _container("test
+0002b140: 2d63 6f6e 7461 696e 6572 2229 0a0a 2020  -container")..  
+0002b150: 2020 6465 6620 7465 6172 446f 776e 2873    def tearDown(s
+0002b160: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+0002b170: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0002b180: 7373 2e63 6c65 616e 7570 2829 0a0a 2020  ss.cleanup()..  
+0002b190: 2020 6465 6620 7465 7374 5f70 7573 6828    def test_push(
+0002b1a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0002b1b0: 656c 662e 636f 6e74 6169 6e65 722e 7075  elf.container.pu
+0002b1c0: 7368 2822 2f66 6f6f 222c 2073 6f75 7263  sh("/foo", sourc
+0002b1d0: 653d 2266 6f6f 2229 0a20 2020 2020 2020  e="foo").       
+0002b1e0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0002b1f0: 2828 7365 6c66 2e72 6f6f 7420 2f20 2266  ((self.root / "f
+0002b200: 6f6f 2229 2e69 735f 6669 6c65 2829 290a  oo").is_file()).
+0002b210: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002b220: 6572 7445 7175 616c 2828 7365 6c66 2e72  ertEqual((self.r
+0002b230: 6f6f 7420 2f20 2266 6f6f 2229 2e72 6561  oot / "foo").rea
+0002b240: 645f 7465 7874 2829 2c20 2266 6f6f 2229  d_text(), "foo")
+0002b250: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+0002b260: 7573 685f 6372 6561 7465 5f70 6172 656e  ush_create_paren
+0002b270: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0002b280: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0002b290: 7075 7368 2822 2f66 6f6f 2f62 6172 222c  push("/foo/bar",
+0002b2a0: 2073 6f75 7263 653d 2262 6172 222c 206d   source="bar", m
+0002b2b0: 616b 655f 6469 7273 3d54 7275 6529 0a20  ake_dirs=True). 
+0002b2c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002b2d0: 7274 5472 7565 2828 7365 6c66 2e72 6f6f  rtTrue((self.roo
+0002b2e0: 7420 2f20 2266 6f6f 2229 2e69 735f 6469  t / "foo").is_di
+0002b2f0: 7228 2929 0a20 2020 2020 2020 2073 656c  r()).        sel
+0002b300: 662e 6173 7365 7274 4571 7561 6c28 2873  f.assertEqual((s
+0002b310: 656c 662e 726f 6f74 202f 2022 666f 6f22  elf.root / "foo"
+0002b320: 202f 2022 6261 7222 292e 7265 6164 5f74   / "bar").read_t
+0002b330: 6578 7428 292c 2022 6261 7222 290a 0a20  ext(), "bar").. 
+0002b340: 2020 2064 6566 2074 6573 745f 7075 7368     def test_push
+0002b350: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+0002b360: 2020 2020 2077 6974 6820 7465 6d70 6669       with tempfi
+0002b370: 6c65 2e54 656d 706f 7261 7279 4469 7265  le.TemporaryDire
+0002b380: 6374 6f72 7928 2920 6173 2074 656d 703a  ctory() as temp:
+0002b390: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0002b3a0: 7064 6972 203d 2070 6174 686c 6962 2e50  pdir = pathlib.P
+0002b3b0: 6174 6828 7465 6d70 290a 2020 2020 2020  ath(temp).      
+0002b3c0: 2020 2020 2020 2874 656d 7064 6972 202f        (tempdir /
+0002b3d0: 2022 666f 6f2f 6261 7222 292e 6d6b 6469   "foo/bar").mkdi
+0002b3e0: 7228 7061 7265 6e74 733d 5472 7565 290a  r(parents=True).
+0002b3f0: 2020 2020 2020 2020 2020 2020 2874 656d              (tem
+0002b400: 7064 6972 202f 2022 666f 6f2f 7465 7374  pdir / "foo/test
+0002b410: 2229 2e77 7269 7465 5f74 6578 7428 2274  ").write_text("t
+0002b420: 6573 7422 290a 2020 2020 2020 2020 2020  est").          
+0002b430: 2020 2874 656d 7064 6972 202f 2022 666f    (tempdir / "fo
+0002b440: 6f2f 6261 722f 666f 6f62 6172 2229 2e77  o/bar/foobar").w
+0002b450: 7269 7465 5f74 6578 7428 2266 6f6f 6261  rite_text("fooba
+0002b460: 7222 290a 2020 2020 2020 2020 2020 2020  r").            
+0002b470: 7365 6c66 2e63 6f6e 7461 696e 6572 2e70  self.container.p
+0002b480: 7573 685f 7061 7468 2874 656d 7064 6972  ush_path(tempdir
+0002b490: 202f 2022 666f 6f22 2c20 222f 746d 7022   / "foo", "/tmp"
+0002b4a0: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
+0002b4b0: 656c 662e 6173 7365 7274 5472 7565 2828  elf.assertTrue((
+0002b4c0: 7365 6c66 2e72 6f6f 7420 2f20 2274 6d70  self.root / "tmp
+0002b4d0: 2229 2e69 735f 6469 7228 2929 0a20 2020  ").is_dir()).   
+0002b4e0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0002b4f0: 7365 7274 5472 7565 2828 7365 6c66 2e72  sertTrue((self.r
+0002b500: 6f6f 7420 2f20 2274 6d70 2f66 6f6f 2229  oot / "tmp/foo")
+0002b510: 2e69 735f 6469 7228 2929 0a20 2020 2020  .is_dir()).     
+0002b520: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002b530: 7274 5472 7565 2828 7365 6c66 2e72 6f6f  rtTrue((self.roo
+0002b540: 7420 2f20 2274 6d70 2f66 6f6f 2f62 6172  t / "tmp/foo/bar
+0002b550: 2229 2e69 735f 6469 7228 2929 0a20 2020  ").is_dir()).   
+0002b560: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0002b570: 7365 7274 4571 7561 6c28 2873 656c 662e  sertEqual((self.
+0002b580: 726f 6f74 202f 2022 746d 702f 666f 6f2f  root / "tmp/foo/
+0002b590: 7465 7374 2229 2e72 6561 645f 7465 7874  test").read_text
+0002b5a0: 2829 2c20 2274 6573 7422 290a 2020 2020  (), "test").    
+0002b5b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002b5c0: 6572 7445 7175 616c 2828 7365 6c66 2e72  ertEqual((self.r
+0002b5d0: 6f6f 7420 2f20 2274 6d70 2f66 6f6f 2f62  oot / "tmp/foo/b
+0002b5e0: 6172 2f66 6f6f 6261 7222 292e 7265 6164  ar/foobar").read
+0002b5f0: 5f74 6578 7428 292c 2022 666f 6f62 6172  _text(), "foobar
+0002b600: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
+0002b610: 5f6d 616b 655f 6469 7228 7365 6c66 293a  _make_dir(self):
+0002b620: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0002b630: 6e74 6169 6e65 722e 6d61 6b65 5f64 6972  ntainer.make_dir
+0002b640: 2822 2f74 6d70 2229 0a20 2020 2020 2020  ("/tmp").       
+0002b650: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0002b660: 2828 7365 6c66 2e72 6f6f 7420 2f20 2274  ((self.root / "t
+0002b670: 6d70 2229 2e69 735f 6469 7228 2929 0a20  mp").is_dir()). 
+0002b680: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0002b690: 6169 6e65 722e 6d61 6b65 5f64 6972 2822  ainer.make_dir("
+0002b6a0: 2f66 6f6f 2f62 6172 2f66 6f6f 6261 7222  /foo/bar/foobar"
+0002b6b0: 2c20 6d61 6b65 5f70 6172 656e 7473 3d54  , make_parents=T
+0002b6c0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+0002b6d0: 662e 6173 7365 7274 5472 7565 2828 7365  f.assertTrue((se
+0002b6e0: 6c66 2e72 6f6f 7420 2f20 2266 6f6f 2f62  lf.root / "foo/b
+0002b6f0: 6172 2f66 6f6f 6261 7222 292e 6973 5f64  ar/foobar").is_d
+0002b700: 6972 2829 290a 0a20 2020 2064 6566 2074  ir())..    def t
+0002b710: 6573 745f 7075 6c6c 2873 656c 6629 3a0a  est_pull(self):.
+0002b720: 2020 2020 2020 2020 2873 656c 662e 726f          (self.ro
+0002b730: 6f74 202f 2022 666f 6f22 292e 7772 6974  ot / "foo").writ
+0002b740: 655f 7465 7874 2822 666f 6f22 290a 2020  e_text("foo").  
+0002b750: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002b760: 7445 7175 616c 2873 656c 662e 636f 6e74  tEqual(self.cont
+0002b770: 6169 6e65 722e 7075 6c6c 2822 2f66 6f6f  ainer.pull("/foo
+0002b780: 2229 2e72 6561 6428 292c 2022 666f 6f22  ").read(), "foo"
+0002b790: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0002b7a0: 7075 6c6c 5f70 6174 6828 7365 6c66 293a  pull_path(self):
+0002b7b0: 0a20 2020 2020 2020 2028 7365 6c66 2e72  .        (self.r
+0002b7c0: 6f6f 7420 2f20 2266 6f6f 2229 2e6d 6b64  oot / "foo").mkd
+0002b7d0: 6972 2829 0a20 2020 2020 2020 2028 7365  ir().        (se
+0002b7e0: 6c66 2e72 6f6f 7420 2f20 2266 6f6f 2f62  lf.root / "foo/b
+0002b7f0: 6172 2229 2e77 7269 7465 5f74 6578 7428  ar").write_text(
+0002b800: 2262 6172 2229 0a20 2020 2020 2020 2023  "bar").        #
+0002b810: 2054 4f44 4f3a 2070 756c 6c5f 7061 7468   TODO: pull_path
+0002b820: 2064 6f65 736e 2774 2070 756c 6c20 656d   doesn't pull em
+0002b830: 7074 7920 6469 7265 6374 6f72 6965 730a  pty directories.
+0002b840: 2020 2020 2020 2020 2320 6874 7470 733a          # https:
+0002b850: 2f2f 6769 7468 7562 2e63 6f6d 2f63 616e  //github.com/can
+0002b860: 6f6e 6963 616c 2f6f 7065 7261 746f 722f  onical/operator/
+0002b870: 6973 7375 6573 2f39 3638 0a20 2020 2020  issues/968.     
+0002b880: 2020 2023 2028 7365 6c66 2e72 6f6f 7420     # (self.root 
+0002b890: 2f20 2266 6f6f 6261 7222 292e 6d6b 6469  / "foobar").mkdi
+0002b8a0: 7228 290a 2020 2020 2020 2020 2873 656c  r().        (sel
+0002b8b0: 662e 726f 6f74 202f 2022 7465 7374 2229  f.root / "test")
+0002b8c0: 2e77 7269 7465 5f74 6578 7428 2274 6573  .write_text("tes
+0002b8d0: 7422 290a 2020 2020 2020 2020 7769 7468  t").        with
+0002b8e0: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
+0002b8f0: 6172 7944 6972 6563 746f 7279 2829 2061  aryDirectory() a
+0002b900: 7320 7465 6d70 3a0a 2020 2020 2020 2020  s temp:.        
+0002b910: 2020 2020 7465 6d70 6469 7220 3d20 7061      tempdir = pa
+0002b920: 7468 6c69 622e 5061 7468 2874 656d 7029  thlib.Path(temp)
+0002b930: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002b940: 662e 636f 6e74 6169 6e65 722e 7075 6c6c  f.container.pull
+0002b950: 5f70 6174 6828 222f 222c 2074 656d 7064  _path("/", tempd
+0002b960: 6972 290a 2020 2020 2020 2020 2020 2020  ir).            
+0002b970: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0002b980: 2874 656d 7064 6972 202f 2022 666f 6f22  (tempdir / "foo"
+0002b990: 292e 6973 5f64 6972 2829 290a 2020 2020  ).is_dir()).    
+0002b9a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002b9b0: 6572 7445 7175 616c 2828 7465 6d70 6469  ertEqual((tempdi
+0002b9c0: 7220 2f20 2266 6f6f 2f62 6172 2229 2e72  r / "foo/bar").r
+0002b9d0: 6561 645f 7465 7874 2829 2c20 2262 6172  ead_text(), "bar
+0002b9e0: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
+0002b9f0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0002ba00: 2828 7465 6d70 6469 7220 2f20 2266 6f6f  ((tempdir / "foo
+0002ba10: 6261 7222 292e 6973 5f64 6972 2829 290a  bar").is_dir()).
+0002ba20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002ba30: 2e61 7373 6572 7445 7175 616c 2828 7465  .assertEqual((te
+0002ba40: 6d70 6469 7220 2f20 2274 6573 7422 292e  mpdir / "test").
+0002ba50: 7265 6164 5f74 6578 7428 292c 2022 7465  read_text(), "te
+0002ba60: 7374 2229 0a0a 2020 2020 6465 6620 7465  st")..    def te
+0002ba70: 7374 5f6c 6973 745f 6669 6c65 7328 7365  st_list_files(se
+0002ba80: 6c66 293a 0a20 2020 2020 2020 2028 7365  lf):.        (se
+0002ba90: 6c66 2e72 6f6f 7420 2f20 2266 6f6f 2229  lf.root / "foo")
+0002baa0: 2e6d 6b64 6972 2829 0a20 2020 2020 2020  .mkdir().       
+0002bab0: 2073 656c 662e 6173 7365 7274 5365 7175   self.assertSequ
+0002bac0: 656e 6365 4571 7561 6c28 7365 6c66 2e63  enceEqual(self.c
+0002bad0: 6f6e 7461 696e 6572 2e6c 6973 745f 6669  ontainer.list_fi
+0002bae0: 6c65 7328 222f 666f 6f22 292c 205b 5d29  les("/foo"), [])
+0002baf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002bb00: 7365 7274 4571 7561 6c28 6c65 6e28 7365  sertEqual(len(se
+0002bb10: 6c66 2e63 6f6e 7461 696e 6572 2e6c 6973  lf.container.lis
+0002bb20: 745f 6669 6c65 7328 222f 2229 292c 2031  t_files("/")), 1
+0002bb30: 290a 2020 2020 2020 2020 6669 6c65 5f69  ).        file_i
+0002bb40: 6e66 6f20 3d20 7365 6c66 2e63 6f6e 7461  nfo = self.conta
+0002bb50: 696e 6572 2e6c 6973 745f 6669 6c65 7328  iner.list_files(
+0002bb60: 222f 2229 5b30 5d0a 2020 2020 2020 2020  "/")[0].        
+0002bb70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002bb80: 2866 696c 655f 696e 666f 2e70 6174 682c  (file_info.path,
+0002bb90: 2022 2f66 6f6f 2229 0a20 2020 2020 2020   "/foo").       
+0002bba0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002bbb0: 6c28 6669 6c65 5f69 6e66 6f2e 7479 7065  l(file_info.type
+0002bbc0: 2c20 4669 6c65 5479 7065 2e44 4952 4543  , FileType.DIREC
+0002bbd0: 544f 5259 290a 2020 2020 2020 2020 7365  TORY).        se
+0002bbe0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0002bbf0: 656c 662e 636f 6e74 6169 6e65 722e 6c69  elf.container.li
+0002bc00: 7374 5f66 696c 6573 2822 2f66 6f6f 222c  st_files("/foo",
+0002bc10: 2069 7473 656c 663d 5472 7565 295b 305d   itself=True)[0]
+0002bc20: 2e70 6174 682c 2022 2f66 6f6f 2229 0a20  .path, "/foo"). 
+0002bc30: 2020 2020 2020 2028 7365 6c66 2e72 6f6f         (self.roo
+0002bc40: 7420 2f20 2266 6f6f 2f62 6172 2229 2e77  t / "foo/bar").w
+0002bc50: 7269 7465 5f74 6578 7428 2266 6f6f 6261  rite_text("fooba
+0002bc60: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+0002bc70: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+0002bc80: 2873 656c 662e 636f 6e74 6169 6e65 722e  (self.container.
+0002bc90: 6c69 7374 5f66 696c 6573 2822 2f66 6f6f  list_files("/foo
+0002bca0: 2229 292c 2031 290a 2020 2020 2020 2020  ")), 1).        
+0002bcb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002bcc0: 286c 656e 2873 656c 662e 636f 6e74 6169  (len(self.contai
+0002bcd0: 6e65 722e 6c69 7374 5f66 696c 6573 2822  ner.list_files("
+0002bce0: 2f66 6f6f 222c 2070 6174 7465 726e 3d22  /foo", pattern="
+0002bcf0: 2a61 7222 2929 2c20 3129 0a20 2020 2020  *ar")), 1).     
+0002bd00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0002bd10: 7561 6c28 6c65 6e28 7365 6c66 2e63 6f6e  ual(len(self.con
+0002bd20: 7461 696e 6572 2e6c 6973 745f 6669 6c65  tainer.list_file
+0002bd30: 7328 222f 666f 6f22 2c20 7061 7474 6572  s("/foo", patter
+0002bd40: 6e3d 222a 6f6f 2229 292c 2030 290a 2020  n="*oo")), 0).  
+0002bd50: 2020 2020 2020 6669 6c65 5f69 6e66 6f20        file_info 
+0002bd60: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
+0002bd70: 2e6c 6973 745f 6669 6c65 7328 222f 666f  .list_files("/fo
+0002bd80: 6f22 295b 305d 0a20 2020 2020 2020 2073  o")[0].        s
+0002bd90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002bda0: 6669 6c65 5f69 6e66 6f2e 7061 7468 2c20  file_info.path, 
+0002bdb0: 222f 666f 6f2f 6261 7222 290a 2020 2020  "/foo/bar").    
+0002bdc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002bdd0: 7175 616c 2866 696c 655f 696e 666f 2e74  qual(file_info.t
+0002bde0: 7970 652c 2046 696c 6554 7970 652e 4649  ype, FileType.FI
+0002bdf0: 4c45 290a 2020 2020 2020 2020 726f 6f74  LE).        root
+0002be00: 5f69 6e66 6f20 3d20 7365 6c66 2e63 6f6e  _info = self.con
+0002be10: 7461 696e 6572 2e6c 6973 745f 6669 6c65  tainer.list_file
+0002be20: 7328 222f 222c 2069 7473 656c 663d 5472  s("/", itself=Tr
+0002be30: 7565 295b 305d 0a20 2020 2020 2020 2073  ue)[0].        s
+0002be40: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002be50: 726f 6f74 5f69 6e66 6f2e 7061 7468 2c20  root_info.path, 
+0002be60: 222f 2229 0a20 2020 2020 2020 2073 656c  "/").        sel
+0002be70: 662e 6173 7365 7274 4571 7561 6c28 726f  f.assertEqual(ro
+0002be80: 6f74 5f69 6e66 6f2e 6e61 6d65 2c20 222f  ot_info.name, "/
+0002be90: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
+0002bea0: 5f73 746f 7261 6765 5f6d 6f75 6e74 2873  _storage_mount(s
+0002beb0: 656c 6629 3a0a 2020 2020 2020 2020 7374  elf):.        st
+0002bec0: 6f72 6167 655f 6964 203d 2073 656c 662e  orage_id = self.
+0002bed0: 6861 726e 6573 732e 6164 645f 7374 6f72  harness.add_stor
+0002bee0: 6167 6528 2274 6573 742d 7374 6f72 6167  age("test-storag
+0002bef0: 6522 2c20 312c 2061 7474 6163 683d 5472  e", 1, attach=Tr
+0002bf00: 7565 295b 305d 0a20 2020 2020 2020 2073  ue)[0].        s
+0002bf10: 656c 662e 6173 7365 7274 5472 7565 2828  elf.assertTrue((
+0002bf20: 7365 6c66 2e72 6f6f 7420 2f20 226d 6f75  self.root / "mou
+0002bf30: 6e74 732f 666f 6f22 292e 6578 6973 7473  nts/foo").exists
+0002bf40: 2829 290a 2020 2020 2020 2020 2873 656c  ()).        (sel
+0002bf50: 662e 726f 6f74 202f 2022 6d6f 756e 7473  f.root / "mounts
+0002bf60: 2f66 6f6f 2f62 6172 2229 2e77 7269 7465  /foo/bar").write
+0002bf70: 5f74 6578 7428 2266 6f6f 6261 7222 290a  _text("foobar").
+0002bf80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002bf90: 6572 7445 7175 616c 2873 656c 662e 636f  ertEqual(self.co
+0002bfa0: 6e74 6169 6e65 722e 7075 6c6c 2822 2f6d  ntainer.pull("/m
+0002bfb0: 6f75 6e74 732f 666f 6f2f 6261 7222 292e  ounts/foo/bar").
+0002bfc0: 7265 6164 2829 2c20 2266 6f6f 6261 7222  read(), "foobar"
+0002bfd0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
+0002bfe0: 6172 6e65 7373 2e64 6574 6163 685f 7374  arness.detach_st
+0002bff0: 6f72 6167 6528 7374 6f72 6167 655f 6964  orage(storage_id
+0002c000: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002c010: 7373 6572 7446 616c 7365 2828 7365 6c66  ssertFalse((self
+0002c020: 2e72 6f6f 7420 2f20 226d 6f75 6e74 732f  .root / "mounts/
+0002c030: 666f 6f2f 6261 7222 292e 6973 5f66 696c  foo/bar").is_fil
+0002c040: 6528 2929 0a20 2020 2020 2020 2073 656c  e()).        sel
+0002c050: 662e 6861 726e 6573 732e 6174 7461 6368  f.harness.attach
+0002c060: 5f73 746f 7261 6765 2873 746f 7261 6765  _storage(storage
+0002c070: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
+0002c080: 662e 6173 7365 7274 5472 7565 2828 7365  f.assertTrue((se
+0002c090: 6c66 2e72 6f6f 7420 2f20 226d 6f75 6e74  lf.root / "mount
+0002c0a0: 732f 666f 6f2f 6261 7222 292e 7265 6164  s/foo/bar").read
+0002c0b0: 5f74 6578 7428 292c 2022 666f 6f62 6172  _text(), "foobar
+0002c0c0: 2229 0a0a 0a63 6c61 7373 2054 6573 7453  ")...class TestS
+0002c0d0: 6563 7265 7473 2875 6e69 7474 6573 742e  ecrets(unittest.
+0002c0e0: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
+0002c0f0: 6566 2074 6573 745f 6164 645f 6d6f 6465  ef test_add_mode
+0002c100: 6c5f 7365 6372 6574 5f62 795f 6170 705f  l_secret_by_app_
+0002c110: 6e61 6d65 5f73 7472 2873 656c 6629 3a0a  name_str(self):.
+0002c120: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0002c130: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0002c140: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0002c150: 6173 652c 206d 6574 613d 276e 616d 653a  ase, meta='name:
+0002c160: 2077 6562 6170 7027 290a 2020 2020 2020   webapp').      
+0002c170: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0002c180: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0002c190: 7029 0a20 2020 2020 2020 2072 656c 6174  p).        relat
+0002c1a0: 696f 6e5f 6964 203d 2068 6172 6e65 7373  ion_id = harness
+0002c1b0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0002c1c0: 6227 2c20 2764 6174 6162 6173 6527 290a  b', 'database').
+0002c1d0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002c1e0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+0002c1f0: 7428 7265 6c61 7469 6f6e 5f69 642c 2027  t(relation_id, '
+0002c200: 6461 7461 6261 7365 2f30 2729 0a0a 2020  database/0')..  
+0002c210: 2020 2020 2020 7365 6372 6574 5f69 6420        secret_id 
+0002c220: 3d20 6861 726e 6573 732e 6164 645f 6d6f  = harness.add_mo
+0002c230: 6465 6c5f 7365 6372 6574 2827 6461 7461  del_secret('data
+0002c240: 6261 7365 272c 207b 2770 6173 7377 6f72  base', {'passwor
+0002c250: 6427 3a20 2768 756e 7465 7232 277d 290a  d': 'hunter2'}).
+0002c260: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002c270: 6772 616e 745f 7365 6372 6574 2873 6563  grant_secret(sec
+0002c280: 7265 745f 6964 2c20 2777 6562 6170 7027  ret_id, 'webapp'
+0002c290: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0002c2a0: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0002c2b0: 2e67 6574 5f73 6563 7265 7428 6964 3d73  .get_secret(id=s
+0002c2c0: 6563 7265 745f 6964 290a 2020 2020 2020  ecret_id).      
+0002c2d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002c2e0: 616c 2873 6563 7265 742e 6964 2c20 7365  al(secret.id, se
+0002c2f0: 6372 6574 5f69 6429 0a20 2020 2020 2020  cret_id).       
+0002c300: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002c310: 6c28 7365 6372 6574 2e67 6574 5f63 6f6e  l(secret.get_con
+0002c320: 7465 6e74 2829 2c20 7b27 7061 7373 776f  tent(), {'passwo
+0002c330: 7264 273a 2027 6875 6e74 6572 3227 7d29  rd': 'hunter2'})
+0002c340: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+0002c350: 6464 5f6d 6f64 656c 5f73 6563 7265 745f  dd_model_secret_
+0002c360: 6279 5f61 7070 5f69 6e73 7461 6e63 6528  by_app_instance(
+0002c370: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0002c380: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0002c390: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+0002c3a0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+0002c3b0: 3d27 6e61 6d65 3a20 7765 6261 7070 2729  ='name: webapp')
+0002c3c0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0002c3d0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0002c3e0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0002c3f0: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
+0002c400: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0002c410: 7469 6f6e 2827 6462 272c 2027 6461 7461  tion('db', 'data
+0002c420: 6261 7365 2729 0a20 2020 2020 2020 2068  base').        h
+0002c430: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+0002c440: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
+0002c450: 6e5f 6964 2c20 2764 6174 6162 6173 652f  n_id, 'database/
+0002c460: 3027 290a 0a20 2020 2020 2020 2061 7070  0')..        app
+0002c470: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0002c480: 2e67 6574 5f61 7070 2827 6461 7461 6261  .get_app('databa
+0002c490: 7365 2729 0a20 2020 2020 2020 2073 6563  se').        sec
+0002c4a0: 7265 745f 6964 203d 2068 6172 6e65 7373  ret_id = harness
+0002c4b0: 2e61 6464 5f6d 6f64 656c 5f73 6563 7265  .add_model_secre
+0002c4c0: 7428 6170 702c 207b 2770 6173 7377 6f72  t(app, {'passwor
+0002c4d0: 6427 3a20 2768 756e 7465 7233 277d 290a  d': 'hunter3'}).
+0002c4e0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002c4f0: 6772 616e 745f 7365 6372 6574 2873 6563  grant_secret(sec
+0002c500: 7265 745f 6964 2c20 2777 6562 6170 7027  ret_id, 'webapp'
+0002c510: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0002c520: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0002c530: 2e67 6574 5f73 6563 7265 7428 6964 3d73  .get_secret(id=s
+0002c540: 6563 7265 745f 6964 290a 2020 2020 2020  ecret_id).      
+0002c550: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002c560: 616c 2873 6563 7265 742e 6964 2c20 7365  al(secret.id, se
+0002c570: 6372 6574 5f69 6429 0a20 2020 2020 2020  cret_id).       
+0002c580: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002c590: 6c28 7365 6372 6574 2e67 6574 5f63 6f6e  l(secret.get_con
+0002c5a0: 7465 6e74 2829 2c20 7b27 7061 7373 776f  tent(), {'passwo
+0002c5b0: 7264 273a 2027 6875 6e74 6572 3327 7d29  rd': 'hunter3'})
+0002c5c0: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+0002c5d0: 6464 5f6d 6f64 656c 5f73 6563 7265 745f  dd_model_secret_
+0002c5e0: 6279 5f75 6e69 745f 696e 7374 616e 6365  by_unit_instance
+0002c5f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002c600: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0002c610: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0002c620: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0002c630: 613d 276e 616d 653a 2077 6562 6170 7027  a='name: webapp'
+0002c640: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002c650: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0002c660: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0002c670: 2020 2072 656c 6174 696f 6e5f 6964 203d     relation_id =
+0002c680: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+0002c690: 6174 696f 6e28 2764 6227 2c20 2764 6174  ation('db', 'dat
+0002c6a0: 6162 6173 6527 290a 2020 2020 2020 2020  abase').        
+0002c6b0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0002c6c0: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+0002c6d0: 6f6e 5f69 642c 2027 6461 7461 6261 7365  on_id, 'database
+0002c6e0: 2f30 2729 0a0a 2020 2020 2020 2020 756e  /0')..        un
+0002c6f0: 6974 203d 2068 6172 6e65 7373 2e6d 6f64  it = harness.mod
+0002c700: 656c 2e67 6574 5f75 6e69 7428 2764 6174  el.get_unit('dat
+0002c710: 6162 6173 652f 3027 290a 2020 2020 2020  abase/0').      
+0002c720: 2020 7365 6372 6574 5f69 6420 3d20 6861    secret_id = ha
+0002c730: 726e 6573 732e 6164 645f 6d6f 6465 6c5f  rness.add_model_
+0002c740: 7365 6372 6574 2875 6e69 742c 207b 2770  secret(unit, {'p
+0002c750: 6173 7377 6f72 6427 3a20 2768 756e 7465  assword': 'hunte
+0002c760: 7234 277d 290a 2020 2020 2020 2020 6861  r4'}).        ha
+0002c770: 726e 6573 732e 6772 616e 745f 7365 6372  rness.grant_secr
+0002c780: 6574 2873 6563 7265 745f 6964 2c20 2777  et(secret_id, 'w
+0002c790: 6562 6170 7027 290a 2020 2020 2020 2020  ebapp').        
+0002c7a0: 7365 6372 6574 203d 2068 6172 6e65 7373  secret = harness
+0002c7b0: 2e6d 6f64 656c 2e67 6574 5f73 6563 7265  .model.get_secre
+0002c7c0: 7428 6964 3d73 6563 7265 745f 6964 290a  t(id=secret_id).
+0002c7d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002c7e0: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0002c7f0: 6964 2c20 7365 6372 6574 5f69 6429 0a20  id, secret_id). 
+0002c800: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002c810: 7274 4571 7561 6c28 7365 6372 6574 2e67  rtEqual(secret.g
+0002c820: 6574 5f63 6f6e 7465 6e74 2829 2c20 7b27  et_content(), {'
+0002c830: 7061 7373 776f 7264 273a 2027 6875 6e74  password': 'hunt
+0002c840: 6572 3427 7d29 0a0a 2020 2020 6465 6620  er4'})..    def 
+0002c850: 7465 7374 5f61 6464 5f6d 6f64 656c 5f73  test_add_model_s
+0002c860: 6563 7265 745f 696e 7661 6c69 645f 636f  ecret_invalid_co
+0002c870: 6e74 656e 7428 7365 6c66 293a 0a20 2020  ntent(self):.   
+0002c880: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0002c890: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0002c8a0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0002c8b0: 2c20 6d65 7461 3d27 6e61 6d65 3a20 7765  , meta='name: we
+0002c8c0: 6261 7070 2729 0a20 2020 2020 2020 2073  bapp').        s
+0002c8d0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+0002c8e0: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+0002c8f0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0002c900: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0002c910: 5661 6c75 6545 7272 6f72 293a 0a20 2020  ValueError):.   
+0002c920: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+0002c930: 2e61 6464 5f6d 6f64 656c 5f73 6563 7265  .add_model_secre
+0002c940: 7428 2764 6174 6162 6173 6527 2c20 7b27  t('database', {'
+0002c950: 7827 3a20 2779 277d 2920 2023 206b 6579  x': 'y'})  # key
+0002c960: 2074 6f6f 2073 686f 7274 0a0a 2020 2020   too short..    
+0002c970: 6465 6620 7465 7374 5f73 6574 5f73 6563  def test_set_sec
+0002c980: 7265 745f 636f 6e74 656e 7428 7365 6c66  ret_content(self
+0002c990: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0002c9a0: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0002c9b0: 2e48 6172 6e65 7373 2845 7665 6e74 5265  .Harness(EventRe
+0002c9c0: 636f 7264 6572 2c20 6d65 7461 3d27 6e61  corder, meta='na
+0002c9d0: 6d65 3a20 7765 6261 7070 2729 0a20 2020  me: webapp').   
+0002c9e0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0002c9f0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0002ca00: 616e 7570 290a 2020 2020 2020 2020 7265  anup).        re
+0002ca10: 6c61 7469 6f6e 5f69 6420 3d20 6861 726e  lation_id = harn
+0002ca20: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+0002ca30: 2827 6462 272c 2027 6461 7461 6261 7365  ('db', 'database
+0002ca40: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+0002ca50: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
+0002ca60: 756e 6974 2872 656c 6174 696f 6e5f 6964  unit(relation_id
+0002ca70: 2c20 2764 6174 6162 6173 652f 3027 290a  , 'database/0').
+0002ca80: 0a20 2020 2020 2020 2073 6563 7265 745f  .        secret_
+0002ca90: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+0002caa0: 5f6d 6f64 656c 5f73 6563 7265 7428 2764  _model_secret('d
+0002cab0: 6174 6162 6173 6527 2c20 7b27 666f 6f27  atabase', {'foo'
+0002cac0: 3a20 2731 277d 290a 2020 2020 2020 2020  : '1'}).        
+0002cad0: 6861 726e 6573 732e 6772 616e 745f 7365  harness.grant_se
+0002cae0: 6372 6574 2873 6563 7265 745f 6964 2c20  cret(secret_id, 
+0002caf0: 2777 6562 6170 7027 290a 2020 2020 2020  'webapp').      
+0002cb00: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0002cb10: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002cb20: 732e 6672 616d 6577 6f72 6b2e 6f62 7365  s.framework.obse
+0002cb30: 7276 6528 6861 726e 6573 732e 6368 6172  rve(harness.char
+0002cb40: 6d2e 6f6e 2e73 6563 7265 745f 6368 616e  m.on.secret_chan
+0002cb50: 6765 642c 2068 6172 6e65 7373 2e63 6861  ged, harness.cha
+0002cb60: 726d 2e72 6563 6f72 645f 6576 656e 7429  rm.record_event)
+0002cb70: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0002cb80: 2e73 6574 5f73 6563 7265 745f 636f 6e74  .set_secret_cont
+0002cb90: 656e 7428 7365 6372 6574 5f69 642c 207b  ent(secret_id, {
+0002cba0: 2766 6f6f 273a 2027 3227 7d29 0a0a 2020  'foo': '2'})..  
+0002cbb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002cbc0: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
+0002cbd0: 7373 2e63 6861 726d 2e65 7665 6e74 7329  ss.charm.events)
+0002cbe0: 2c20 3129 0a20 2020 2020 2020 2065 7665  , 1).        eve
+0002cbf0: 6e74 203d 2068 6172 6e65 7373 2e63 6861  nt = harness.cha
+0002cc00: 726d 2e65 7665 6e74 735b 305d 0a20 2020  rm.events[0].   
+0002cc10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002cc20: 4973 496e 7374 616e 6365 2865 7665 6e74  IsInstance(event
+0002cc30: 2c20 6f70 732e 5365 6372 6574 4368 616e  , ops.SecretChan
+0002cc40: 6765 6445 7665 6e74 290a 2020 2020 2020  gedEvent).      
+0002cc50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002cc60: 616c 2865 7665 6e74 2e73 6563 7265 742e  al(event.secret.
+0002cc70: 6765 745f 636f 6e74 656e 7428 292c 207b  get_content(), {
+0002cc80: 2766 6f6f 273a 2027 3127 7d29 0a20 2020  'foo': '1'}).   
+0002cc90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002cca0: 4571 7561 6c28 6576 656e 742e 7365 6372  Equal(event.secr
+0002ccb0: 6574 2e67 6574 5f63 6f6e 7465 6e74 2872  et.get_content(r
+0002ccc0: 6566 7265 7368 3d54 7275 6529 2c20 7b27  efresh=True), {'
+0002ccd0: 666f 6f27 3a20 2732 277d 290a 2020 2020  foo': '2'}).    
+0002cce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002ccf0: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
+0002cd00: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0002cd10: 207b 2766 6f6f 273a 2027 3227 7d29 0a0a   {'foo': '2'})..
+0002cd20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002cd30: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+0002cd40: 2e67 6574 5f73 6563 7265 745f 7265 7669  .get_secret_revi
+0002cd50: 7369 6f6e 7328 7365 6372 6574 5f69 6429  sions(secret_id)
+0002cd60: 2c20 5b31 2c20 325d 290a 0a20 2020 2064  , [1, 2])..    d
+0002cd70: 6566 2074 6573 745f 7365 745f 7365 6372  ef test_set_secr
+0002cd80: 6574 5f63 6f6e 7465 6e74 5f77 726f 6e67  et_content_wrong
+0002cd90: 5f6f 776e 6572 2873 656c 6629 3a0a 2020  _owner(self):.  
+0002cda0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0002cdb0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0002cdc0: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0002cdd0: 652c 206d 6574 613d 276e 616d 653a 2077  e, meta='name: w
+0002cde0: 6562 6170 7027 290a 2020 2020 2020 2020  ebapp').        
+0002cdf0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0002ce00: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0002ce10: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
+0002ce20: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0002ce30: 2e61 7070 2e61 6464 5f73 6563 7265 7428  .app.add_secret(
+0002ce40: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
+0002ce50: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0002ce60: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+0002ce70: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+0002ce80: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+0002ce90: 732e 7365 745f 7365 6372 6574 5f63 6f6e  s.set_secret_con
+0002cea0: 7465 6e74 2873 6563 7265 742e 6964 2c20  tent(secret.id, 
+0002ceb0: 7b27 6261 7227 3a20 2766 6f6f 277d 290a  {'bar': 'foo'}).
+0002cec0: 0a20 2020 2064 6566 2074 6573 745f 7365  .    def test_se
+0002ced0: 745f 7365 6372 6574 5f63 6f6e 7465 6e74  t_secret_content
+0002cee0: 5f69 6e76 616c 6964 5f73 6563 7265 745f  _invalid_secret_
+0002cef0: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
+0002cf00: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+0002cf10: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+0002cf20: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
+0002cf30: 6574 613d 276e 616d 653a 2077 6562 6170  eta='name: webap
+0002cf40: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
+0002cf50: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0002cf60: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0002cf70: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0002cf80: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0002cf90: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+0002cfa0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002cfb0: 7365 745f 7365 6372 6574 5f63 6f6e 7465  set_secret_conte
+0002cfc0: 6e74 2827 6173 6466 272c 207b 2766 6f6f  nt('asdf', {'foo
+0002cfd0: 273a 2027 6261 7227 7d29 0a0a 2020 2020  ': 'bar'})..    
+0002cfe0: 6465 6620 7465 7374 5f73 6574 5f73 6563  def test_set_sec
+0002cff0: 7265 745f 636f 6e74 656e 745f 696e 7661  ret_content_inva
+0002d000: 6c69 645f 636f 6e74 656e 7428 7365 6c66  lid_content(self
+0002d010: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0002d020: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0002d030: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0002d040: 726d 4261 7365 2c20 6d65 7461 3d27 6e61  rmBase, meta='na
+0002d050: 6d65 3a20 7765 6261 7070 2729 0a20 2020  me: webapp').   
+0002d060: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0002d070: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0002d080: 616e 7570 290a 0a20 2020 2020 2020 2073  anup)..        s
+0002d090: 6563 7265 745f 6964 203d 2068 6172 6e65  ecret_id = harne
+0002d0a0: 7373 2e61 6464 5f6d 6f64 656c 5f73 6563  ss.add_model_sec
+0002d0b0: 7265 7428 2764 6174 6162 6173 6527 2c20  ret('database', 
+0002d0c0: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
+0002d0d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0002d0e0: 662e 6173 7365 7274 5261 6973 6573 2856  f.assertRaises(V
+0002d0f0: 616c 7565 4572 726f 7229 3a0a 2020 2020  alueError):.    
+0002d100: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002d110: 7365 745f 7365 6372 6574 5f63 6f6e 7465  set_secret_conte
+0002d120: 6e74 2873 6563 7265 745f 6964 2c20 7b27  nt(secret_id, {'
+0002d130: 7827 3a20 2779 277d 290a 0a20 2020 2064  x': 'y'})..    d
+0002d140: 6566 2074 6573 745f 6772 616e 745f 7365  ef test_grant_se
+0002d150: 6372 6574 5f61 6e64 5f72 6576 6f6b 655f  cret_and_revoke_
+0002d160: 7365 6372 6574 2873 656c 6629 3a0a 2020  secret(self):.  
+0002d170: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0002d180: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0002d190: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0002d1a0: 652c 206d 6574 613d 276e 616d 653a 2077  e, meta='name: w
+0002d1b0: 6562 6170 7027 290a 2020 2020 2020 2020  ebapp').        
+0002d1c0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0002d1d0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0002d1e0: 0a20 2020 2020 2020 2072 656c 6174 696f  .        relatio
+0002d1f0: 6e5f 6964 203d 2068 6172 6e65 7373 2e61  n_id = harness.a
+0002d200: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
+0002d210: 2c20 2764 6174 6162 6173 6527 290a 2020  , 'database').  
+0002d220: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0002d230: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+0002d240: 7265 6c61 7469 6f6e 5f69 642c 2027 6461  relation_id, 'da
+0002d250: 7461 6261 7365 2f30 2729 0a0a 2020 2020  tabase/0')..    
+0002d260: 2020 2020 7365 6372 6574 5f69 6420 3d20      secret_id = 
+0002d270: 6861 726e 6573 732e 6164 645f 6d6f 6465  harness.add_mode
+0002d280: 6c5f 7365 6372 6574 2827 6461 7461 6261  l_secret('databa
+0002d290: 7365 272c 207b 2770 6173 7377 6f72 6427  se', {'password'
+0002d2a0: 3a20 2768 756e 7465 7232 277d 290a 2020  : 'hunter2'}).  
+0002d2b0: 2020 2020 2020 6861 726e 6573 732e 6772        harness.gr
+0002d2c0: 616e 745f 7365 6372 6574 2873 6563 7265  ant_secret(secre
+0002d2d0: 745f 6964 2c20 2777 6562 6170 7027 290a  t_id, 'webapp').
+0002d2e0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0002d2f0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e67   harness.model.g
+0002d300: 6574 5f73 6563 7265 7428 6964 3d73 6563  et_secret(id=sec
+0002d310: 7265 745f 6964 290a 2020 2020 2020 2020  ret_id).        
+0002d320: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002d330: 2873 6563 7265 742e 6964 2c20 7365 6372  (secret.id, secr
+0002d340: 6574 5f69 6429 0a20 2020 2020 2020 2073  et_id).        s
+0002d350: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002d360: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
+0002d370: 6e74 2829 2c20 7b27 7061 7373 776f 7264  nt(), {'password
+0002d380: 273a 2027 6875 6e74 6572 3227 7d29 0a0a  ': 'hunter2'})..
+0002d390: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002d3a0: 7265 766f 6b65 5f73 6563 7265 7428 7365  revoke_secret(se
+0002d3b0: 6372 6574 5f69 642c 2027 7765 6261 7070  cret_id, 'webapp
+0002d3c0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+0002d3d0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0002d3e0: 7328 6f70 732e 5365 6372 6574 4e6f 7446  s(ops.SecretNotF
+0002d3f0: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
+0002d400: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002d410: 6d6f 6465 6c2e 6765 745f 7365 6372 6574  model.get_secret
+0002d420: 2869 643d 7365 6372 6574 5f69 6429 0a0a  (id=secret_id)..
+0002d430: 2020 2020 6465 6620 7465 7374 5f67 7261      def test_gra
+0002d440: 6e74 5f73 6563 7265 745f 7772 6f6e 675f  nt_secret_wrong_
+0002d450: 6170 7028 7365 6c66 293a 0a20 2020 2020  app(self):.     
+0002d460: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0002d470: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0002d480: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0002d490: 6d65 7461 3d27 6e61 6d65 3a20 7765 6261  meta='name: weba
+0002d4a0: 7070 2729 0a20 2020 2020 2020 2073 656c  pp').        sel
+0002d4b0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0002d4c0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0002d4d0: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0002d4e0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+0002d4f0: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+0002d500: 6461 7461 6261 7365 2729 0a20 2020 2020  database').     
+0002d510: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+0002d520: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+0002d530: 6174 696f 6e5f 6964 2c20 2764 6174 6162  ation_id, 'datab
+0002d540: 6173 652f 3027 290a 0a20 2020 2020 2020  ase/0')..       
+0002d550: 2073 6563 7265 745f 6964 203d 2068 6172   secret_id = har
+0002d560: 6e65 7373 2e61 6464 5f6d 6f64 656c 5f73  ness.add_model_s
+0002d570: 6563 7265 7428 2764 6174 6162 6173 6527  ecret('database'
+0002d580: 2c20 7b27 7061 7373 776f 7264 273a 2027  , {'password': '
+0002d590: 6875 6e74 6572 3227 7d29 0a20 2020 2020  hunter2'}).     
+0002d5a0: 2020 2068 6172 6e65 7373 2e67 7261 6e74     harness.grant
+0002d5b0: 5f73 6563 7265 7428 7365 6372 6574 5f69  _secret(secret_i
+0002d5c0: 642c 2027 6f74 6865 7261 7070 2729 0a20  d, 'otherapp'). 
+0002d5d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0002d5e0: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+0002d5f0: 732e 5365 6372 6574 4e6f 7446 6f75 6e64  s.SecretNotFound
+0002d600: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0002d610: 2020 2020 6861 726e 6573 732e 6d6f 6465      harness.mode
+0002d620: 6c2e 6765 745f 7365 6372 6574 2869 643d  l.get_secret(id=
+0002d630: 7365 6372 6574 5f69 6429 0a0a 2020 2020  secret_id)..    
+0002d640: 6465 6620 7465 7374 5f67 7261 6e74 5f73  def test_grant_s
+0002d650: 6563 7265 745f 7772 6f6e 675f 756e 6974  ecret_wrong_unit
+0002d660: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002d670: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0002d680: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0002d690: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0002d6a0: 613d 276e 616d 653a 2077 6562 6170 7027  a='name: webapp'
+0002d6b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002d6c0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0002d6d0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0002d6e0: 2020 2072 656c 6174 696f 6e5f 6964 203d     relation_id =
+0002d6f0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+0002d700: 6174 696f 6e28 2764 6227 2c20 2764 6174  ation('db', 'dat
+0002d710: 6162 6173 6527 290a 2020 2020 2020 2020  abase').        
+0002d720: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0002d730: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+0002d740: 6f6e 5f69 642c 2027 6461 7461 6261 7365  on_id, 'database
+0002d750: 2f30 2729 0a0a 2020 2020 2020 2020 7365  /0')..        se
+0002d760: 6372 6574 5f69 6420 3d20 6861 726e 6573  cret_id = harnes
+0002d770: 732e 6164 645f 6d6f 6465 6c5f 7365 6372  s.add_model_secr
+0002d780: 6574 2827 6461 7461 6261 7365 272c 207b  et('database', {
+0002d790: 2770 6173 7377 6f72 6427 3a20 2768 756e  'password': 'hun
+0002d7a0: 7465 7232 277d 290a 2020 2020 2020 2020  ter2'}).        
+0002d7b0: 6861 726e 6573 732e 6772 616e 745f 7365  harness.grant_se
+0002d7c0: 6372 6574 2873 6563 7265 745f 6964 2c20  cret(secret_id, 
+0002d7d0: 2777 6562 6170 702f 3127 2920 2023 2073  'webapp/1')  # s
+0002d7e0: 686f 756c 6420 6265 2077 6562 6170 702f  hould be webapp/
+0002d7f0: 300a 2020 2020 2020 2020 7769 7468 2073  0.        with s
+0002d800: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0002d810: 286f 7073 2e53 6563 7265 744e 6f74 466f  (ops.SecretNotFo
+0002d820: 756e 6445 7272 6f72 293a 0a20 2020 2020  undError):.     
+0002d830: 2020 2020 2020 2068 6172 6e65 7373 2e6d         harness.m
+0002d840: 6f64 656c 2e67 6574 5f73 6563 7265 7428  odel.get_secret(
+0002d850: 6964 3d73 6563 7265 745f 6964 290a 0a20  id=secret_id).. 
+0002d860: 2020 2064 6566 2074 6573 745f 6772 616e     def test_gran
+0002d870: 745f 7365 6372 6574 5f6e 6f5f 7265 6c61  t_secret_no_rela
+0002d880: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+0002d890: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0002d8a0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0002d8b0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0002d8c0: 206d 6574 613d 276e 616d 653a 2077 6562   meta='name: web
+0002d8d0: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+0002d8e0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0002d8f0: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
+0002d900: 2020 2020 2020 2020 7365 6372 6574 5f69          secret_i
+0002d910: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+0002d920: 6d6f 6465 6c5f 7365 6372 6574 2827 6461  model_secret('da
+0002d930: 7461 6261 7365 272c 207b 2770 6173 7377  tabase', {'passw
+0002d940: 6f72 6427 3a20 2768 756e 7465 7232 277d  ord': 'hunter2'}
+0002d950: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+0002d960: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0002d970: 2852 756e 7469 6d65 4572 726f 7229 3a0a  (RuntimeError):.
+0002d980: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+0002d990: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
+0002d9a0: 2873 6563 7265 745f 6964 2c20 2777 6562  (secret_id, 'web
+0002d9b0: 6170 7027 290a 0a20 2020 2064 6566 2074  app')..    def t
+0002d9c0: 6573 745f 6765 745f 7365 6372 6574 5f67  est_get_secret_g
+0002d9d0: 7261 6e74 7328 7365 6c66 293a 0a20 2020  rants(self):.   
+0002d9e0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0002d9f0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0002da00: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0002da10: 2c20 6d65 7461 3d27 6e61 6d65 3a20 6461  , meta='name: da
+0002da20: 7461 6261 7365 2729 0a20 2020 2020 2020  tabase').       
+0002da30: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+0002da40: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+0002da50: 290a 0a20 2020 2020 2020 2072 656c 6174  )..        relat
+0002da60: 696f 6e5f 6964 203d 2068 6172 6e65 7373  ion_id = harness
+0002da70: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0002da80: 6227 2c20 2777 6562 6170 7027 290a 2020  b', 'webapp').  
+0002da90: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0002daa0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+0002dab0: 7265 6c61 7469 6f6e 5f69 642c 2027 7765  relation_id, 'we
+0002dac0: 6261 7070 2f30 2729 0a0a 2020 2020 2020  bapp/0')..      
+0002dad0: 2020 7365 6372 6574 203d 2068 6172 6e65    secret = harne
+0002dae0: 7373 2e6d 6f64 656c 2e61 7070 2e61 6464  ss.model.app.add
+0002daf0: 5f73 6563 7265 7428 7b27 666f 6f27 3a20  _secret({'foo': 
+0002db00: 2778 277d 290a 2020 2020 2020 2020 7365  'x'}).        se
+0002db10: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+0002db20: 6172 6e65 7373 2e67 6574 5f73 6563 7265  arness.get_secre
+0002db30: 745f 6772 616e 7473 2873 6563 7265 742e  t_grants(secret.
+0002db40: 6964 2c20 7265 6c61 7469 6f6e 5f69 6429  id, relation_id)
+0002db50: 2c20 7365 7428 2929 0a20 2020 2020 2020  , set()).       
+0002db60: 2073 6563 7265 742e 6772 616e 7428 6861   secret.grant(ha
+0002db70: 726e 6573 732e 6d6f 6465 6c2e 6765 745f  rness.model.get_
+0002db80: 7265 6c61 7469 6f6e 2827 6462 2729 290a  relation('db')).
+0002db90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002dba0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+0002dbb0: 2e67 6574 5f73 6563 7265 745f 6772 616e  .get_secret_gran
+0002dbc0: 7473 2873 6563 7265 742e 6964 2c20 7265  ts(secret.id, re
+0002dbd0: 6c61 7469 6f6e 5f69 6429 2c20 7b27 7765  lation_id), {'we
+0002dbe0: 6261 7070 277d 290a 0a20 2020 2020 2020  bapp'})..       
+0002dbf0: 2073 6563 7265 742e 7265 766f 6b65 2868   secret.revoke(h
+0002dc00: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
+0002dc10: 5f72 656c 6174 696f 6e28 2764 6227 2929  _relation('db'))
+0002dc20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002dc30: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+0002dc40: 732e 6765 745f 7365 6372 6574 5f67 7261  s.get_secret_gra
+0002dc50: 6e74 7328 7365 6372 6574 2e69 642c 2072  nts(secret.id, r
+0002dc60: 656c 6174 696f 6e5f 6964 292c 2073 6574  elation_id), set
+0002dc70: 2829 290a 2020 2020 2020 2020 7365 6372  ()).        secr
+0002dc80: 6574 2e67 7261 6e74 2868 6172 6e65 7373  et.grant(harness
+0002dc90: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+0002dca0: 696f 6e28 2764 6227 292c 2075 6e69 743d  ion('db'), unit=
+0002dcb0: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
+0002dcc0: 745f 756e 6974 2827 7765 6261 7070 2f30  t_unit('webapp/0
+0002dcd0: 2729 290a 2020 2020 2020 2020 7365 6c66  ')).        self
+0002dce0: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
+0002dcf0: 6e65 7373 2e67 6574 5f73 6563 7265 745f  ness.get_secret_
+0002dd00: 6772 616e 7473 2873 6563 7265 742e 6964  grants(secret.id
+0002dd10: 2c20 7265 6c61 7469 6f6e 5f69 6429 2c20  , relation_id), 
+0002dd20: 7b27 7765 6261 7070 2f30 277d 290a 0a20  {'webapp/0'}).. 
+0002dd30: 2020 2064 6566 2074 6573 745f 7472 6967     def test_trig
+0002dd40: 6765 725f 7365 6372 6574 5f72 6f74 6174  ger_secret_rotat
+0002dd50: 696f 6e28 7365 6c66 293a 0a20 2020 2020  ion(self):.     
+0002dd60: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0002dd70: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0002dd80: 2845 7665 6e74 5265 636f 7264 6572 2c20  (EventRecorder, 
+0002dd90: 6d65 7461 3d27 6e61 6d65 3a20 6461 7461  meta='name: data
+0002dda0: 6261 7365 2729 0a20 2020 2020 2020 2073  base').        s
+0002ddb0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+0002ddc0: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+0002ddd0: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
+0002dde0: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
+0002ddf0: 6170 702e 6164 645f 7365 6372 6574 287b  app.add_secret({
+0002de00: 2766 6f6f 273a 2027 7827 7d2c 206c 6162  'foo': 'x'}, lab
+0002de10: 656c 3d27 6c62 6c27 290a 2020 2020 2020  el='lbl').      
+0002de20: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0002de30: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002de40: 732e 6672 616d 6577 6f72 6b2e 6f62 7365  s.framework.obse
+0002de50: 7276 6528 6861 726e 6573 732e 6368 6172  rve(harness.char
+0002de60: 6d2e 6f6e 2e73 6563 7265 745f 726f 7461  m.on.secret_rota
+0002de70: 7465 2c20 6861 726e 6573 732e 6368 6172  te, harness.char
+0002de80: 6d2e 7265 636f 7264 5f65 7665 6e74 290a  m.record_event).
+0002de90: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002dea0: 7472 6967 6765 725f 7365 6372 6574 5f72  trigger_secret_r
+0002deb0: 6f74 6174 696f 6e28 7365 6372 6574 2e69  otation(secret.i
+0002dec0: 6429 0a20 2020 2020 2020 2068 6172 6e65  d).        harne
+0002ded0: 7373 2e74 7269 6767 6572 5f73 6563 7265  ss.trigger_secre
+0002dee0: 745f 726f 7461 7469 6f6e 2873 6563 7265  t_rotation(secre
+0002def0: 742e 6964 2c20 6c61 6265 6c3d 276f 7665  t.id, label='ove
+0002df00: 7272 6964 6527 290a 0a20 2020 2020 2020  rride')..       
+0002df10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002df20: 6c28 6c65 6e28 6861 726e 6573 732e 6368  l(len(harness.ch
+0002df30: 6172 6d2e 6576 656e 7473 292c 2032 290a  arm.events), 2).
+0002df40: 2020 2020 2020 2020 6576 656e 7420 3d20          event = 
+0002df50: 6861 726e 6573 732e 6368 6172 6d2e 6576  harness.charm.ev
+0002df60: 656e 7473 5b30 5d0a 2020 2020 2020 2020  ents[0].        
+0002df70: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+0002df80: 7461 6e63 6528 6576 656e 742c 206f 7073  tance(event, ops
+0002df90: 2e53 6563 7265 7452 6f74 6174 6545 7665  .SecretRotateEve
+0002dfa0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
+0002dfb0: 2e61 7373 6572 7445 7175 616c 2865 7665  .assertEqual(eve
+0002dfc0: 6e74 2e73 6563 7265 742e 6c61 6265 6c2c  nt.secret.label,
+0002dfd0: 2027 6c62 6c27 290a 2020 2020 2020 2020   'lbl').        
+0002dfe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002dff0: 2865 7665 6e74 2e73 6563 7265 742e 6765  (event.secret.ge
+0002e000: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
+0002e010: 6f6f 273a 2027 7827 7d29 0a20 2020 2020  oo': 'x'}).     
+0002e020: 2020 2065 7665 6e74 203d 2068 6172 6e65     event = harne
+0002e030: 7373 2e63 6861 726d 2e65 7665 6e74 735b  ss.charm.events[
+0002e040: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
+0002e050: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
+0002e060: 2865 7665 6e74 2c20 6f70 732e 5365 6372  (event, ops.Secr
+0002e070: 6574 526f 7461 7465 4576 656e 7429 0a20  etRotateEvent). 
+0002e080: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002e090: 7274 4571 7561 6c28 6576 656e 742e 7365  rtEqual(event.se
+0002e0a0: 6372 6574 2e6c 6162 656c 2c20 276f 7665  cret.label, 'ove
+0002e0b0: 7272 6964 6527 290a 2020 2020 2020 2020  rride').        
+0002e0c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002e0d0: 2865 7665 6e74 2e73 6563 7265 742e 6765  (event.secret.ge
+0002e0e0: 745f 636f 6e74 656e 7428 292c 207b 2766  t_content(), {'f
+0002e0f0: 6f6f 273a 2027 7827 7d29 0a0a 2020 2020  oo': 'x'})..    
+0002e100: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0002e110: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+0002e120: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+0002e130: 2020 2020 2020 6861 726e 6573 732e 7472        harness.tr
+0002e140: 6967 6765 725f 7365 6372 6574 5f72 6f74  igger_secret_rot
+0002e150: 6174 696f 6e28 276e 6f73 6563 7265 7427  ation('nosecret'
+0002e160: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0002e170: 7472 6967 6765 725f 7365 6372 6574 5f72  trigger_secret_r
+0002e180: 656d 6f76 616c 2873 656c 6629 3a0a 2020  emoval(self):.  
+0002e190: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0002e1a0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0002e1b0: 6573 7328 4576 656e 7452 6563 6f72 6465  ess(EventRecorde
+0002e1c0: 722c 206d 6574 613d 276e 616d 653a 2064  r, meta='name: d
+0002e1d0: 6174 6162 6173 6527 290a 2020 2020 2020  atabase').      
+0002e1e0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0002e1f0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0002e200: 7029 0a0a 2020 2020 2020 2020 7365 6372  p)..        secr
+0002e210: 6574 203d 2068 6172 6e65 7373 2e6d 6f64  et = harness.mod
+0002e220: 656c 2e61 7070 2e61 6464 5f73 6563 7265  el.app.add_secre
+0002e230: 7428 7b27 666f 6f27 3a20 2778 277d 2c20  t({'foo': 'x'}, 
+0002e240: 6c61 6265 6c3d 276c 626c 2729 0a20 2020  label='lbl').   
+0002e250: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+0002e260: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
+0002e270: 6e65 7373 2e66 7261 6d65 776f 726b 2e6f  ness.framework.o
+0002e280: 6273 6572 7665 2868 6172 6e65 7373 2e63  bserve(harness.c
+0002e290: 6861 726d 2e6f 6e2e 7365 6372 6574 5f72  harm.on.secret_r
+0002e2a0: 656d 6f76 652c 2068 6172 6e65 7373 2e63  emove, harness.c
+0002e2b0: 6861 726d 2e72 6563 6f72 645f 6576 656e  harm.record_even
+0002e2c0: 7429 0a20 2020 2020 2020 2068 6172 6e65  t).        harne
+0002e2d0: 7373 2e74 7269 6767 6572 5f73 6563 7265  ss.trigger_secre
+0002e2e0: 745f 7265 6d6f 7661 6c28 7365 6372 6574  t_removal(secret
+0002e2f0: 2e69 642c 2031 290a 2020 2020 2020 2020  .id, 1).        
+0002e300: 6861 726e 6573 732e 7472 6967 6765 725f  harness.trigger_
+0002e310: 7365 6372 6574 5f72 656d 6f76 616c 2873  secret_removal(s
+0002e320: 6563 7265 742e 6964 2c20 3432 2c20 6c61  ecret.id, 42, la
+0002e330: 6265 6c3d 276f 7665 7272 6964 6527 290a  bel='override').
+0002e340: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002e350: 7365 7274 4571 7561 6c28 6c65 6e28 6861  sertEqual(len(ha
+0002e360: 726e 6573 732e 6368 6172 6d2e 6576 656e  rness.charm.even
+0002e370: 7473 292c 2032 290a 2020 2020 2020 2020  ts), 2).        
+0002e380: 6576 656e 7420 3d20 6861 726e 6573 732e  event = harness.
+0002e390: 6368 6172 6d2e 6576 656e 7473 5b30 5d0a  charm.events[0].
+0002e3a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002e3b0: 6572 7449 7349 6e73 7461 6e63 6528 6576  ertIsInstance(ev
+0002e3c0: 656e 742c 206f 7073 2e53 6563 7265 7452  ent, ops.SecretR
+0002e3d0: 656d 6f76 6545 7665 6e74 290a 2020 2020  emoveEvent).    
+0002e3e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002e3f0: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
+0002e400: 742e 6c61 6265 6c2c 2027 6c62 6c27 290a  t.label, 'lbl').
+0002e410: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002e420: 6572 7445 7175 616c 2865 7665 6e74 2e72  ertEqual(event.r
+0002e430: 6576 6973 696f 6e2c 2031 290a 2020 2020  evision, 1).    
+0002e440: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002e450: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
+0002e460: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0002e470: 207b 2766 6f6f 273a 2027 7827 7d29 0a20   {'foo': 'x'}). 
+0002e480: 2020 2020 2020 2065 7665 6e74 203d 2068         event = h
+0002e490: 6172 6e65 7373 2e63 6861 726d 2e65 7665  arness.charm.eve
+0002e4a0: 6e74 735b 315d 0a20 2020 2020 2020 2073  nts[1].        s
+0002e4b0: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0002e4c0: 616e 6365 2865 7665 6e74 2c20 6f70 732e  ance(event, ops.
+0002e4d0: 5365 6372 6574 5265 6d6f 7665 4576 656e  SecretRemoveEven
+0002e4e0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0002e4f0: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
+0002e500: 742e 7365 6372 6574 2e6c 6162 656c 2c20  t.secret.label, 
+0002e510: 276f 7665 7272 6964 6527 290a 2020 2020  'override').    
+0002e520: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002e530: 7175 616c 2865 7665 6e74 2e72 6576 6973  qual(event.revis
+0002e540: 696f 6e2c 2034 3229 0a20 2020 2020 2020  ion, 42).       
+0002e550: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002e560: 6c28 6576 656e 742e 7365 6372 6574 2e67  l(event.secret.g
+0002e570: 6574 5f63 6f6e 7465 6e74 2829 2c20 7b27  et_content(), {'
+0002e580: 666f 6f27 3a20 2778 277d 290a 0a20 2020  foo': 'x'})..   
+0002e590: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0002e5a0: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
+0002e5b0: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
+0002e5c0: 2020 2020 2020 2068 6172 6e65 7373 2e74         harness.t
+0002e5d0: 7269 6767 6572 5f73 6563 7265 745f 7265  rigger_secret_re
+0002e5e0: 6d6f 7661 6c28 276e 6f73 6563 7265 7427  moval('nosecret'
+0002e5f0: 2c20 3129 0a0a 2020 2020 6465 6620 7465  , 1)..    def te
+0002e600: 7374 5f74 7269 6767 6572 5f73 6563 7265  st_trigger_secre
+0002e610: 745f 6578 7069 7261 7469 6f6e 2873 656c  t_expiration(sel
+0002e620: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+0002e630: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+0002e640: 672e 4861 726e 6573 7328 4576 656e 7452  g.Harness(EventR
+0002e650: 6563 6f72 6465 722c 206d 6574 613d 276e  ecorder, meta='n
+0002e660: 616d 653a 2064 6174 6162 6173 6527 290a  ame: database').
+0002e670: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0002e680: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+0002e690: 636c 6561 6e75 7029 0a0a 2020 2020 2020  cleanup)..      
+0002e6a0: 2020 7365 6372 6574 203d 2068 6172 6e65    secret = harne
+0002e6b0: 7373 2e6d 6f64 656c 2e61 7070 2e61 6464  ss.model.app.add
+0002e6c0: 5f73 6563 7265 7428 7b27 666f 6f27 3a20  _secret({'foo': 
+0002e6d0: 2778 277d 2c20 6c61 6265 6c3d 276c 626c  'x'}, label='lbl
+0002e6e0: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+0002e6f0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0002e700: 2020 2068 6172 6e65 7373 2e66 7261 6d65     harness.frame
+0002e710: 776f 726b 2e6f 6273 6572 7665 2868 6172  work.observe(har
+0002e720: 6e65 7373 2e63 6861 726d 2e6f 6e2e 7365  ness.charm.on.se
+0002e730: 6372 6574 5f72 656d 6f76 652c 2068 6172  cret_remove, har
+0002e740: 6e65 7373 2e63 6861 726d 2e72 6563 6f72  ness.charm.recor
+0002e750: 645f 6576 656e 7429 0a20 2020 2020 2020  d_event).       
+0002e760: 2068 6172 6e65 7373 2e74 7269 6767 6572   harness.trigger
+0002e770: 5f73 6563 7265 745f 7265 6d6f 7661 6c28  _secret_removal(
+0002e780: 7365 6372 6574 2e69 642c 2031 290a 2020  secret.id, 1).  
+0002e790: 2020 2020 2020 6861 726e 6573 732e 7472        harness.tr
+0002e7a0: 6967 6765 725f 7365 6372 6574 5f72 656d  igger_secret_rem
+0002e7b0: 6f76 616c 2873 6563 7265 742e 6964 2c20  oval(secret.id, 
+0002e7c0: 3432 2c20 6c61 6265 6c3d 276f 7665 7272  42, label='overr
+0002e7d0: 6964 6527 290a 0a20 2020 2020 2020 2073  ide')..        s
+0002e7e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002e7f0: 6c65 6e28 6861 726e 6573 732e 6368 6172  len(harness.char
+0002e800: 6d2e 6576 656e 7473 292c 2032 290a 2020  m.events), 2).  
+0002e810: 2020 2020 2020 6576 656e 7420 3d20 6861        event = ha
+0002e820: 726e 6573 732e 6368 6172 6d2e 6576 656e  rness.charm.even
+0002e830: 7473 5b30 5d0a 2020 2020 2020 2020 7365  ts[0].        se
+0002e840: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+0002e850: 6e63 6528 6576 656e 742c 206f 7073 2e53  nce(event, ops.S
+0002e860: 6563 7265 7452 656d 6f76 6545 7665 6e74  ecretRemoveEvent
+0002e870: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e880: 7373 6572 7445 7175 616c 2865 7665 6e74  ssertEqual(event
+0002e890: 2e73 6563 7265 742e 6c61 6265 6c2c 2027  .secret.label, '
+0002e8a0: 6c62 6c27 290a 2020 2020 2020 2020 7365  lbl').        se
+0002e8b0: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+0002e8c0: 7665 6e74 2e72 6576 6973 696f 6e2c 2031  vent.revision, 1
+0002e8d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e8e0: 7373 6572 7445 7175 616c 2865 7665 6e74  ssertEqual(event
+0002e8f0: 2e73 6563 7265 742e 6765 745f 636f 6e74  .secret.get_cont
+0002e900: 656e 7428 292c 207b 2766 6f6f 273a 2027  ent(), {'foo': '
+0002e910: 7827 7d29 0a20 2020 2020 2020 2065 7665  x'}).        eve
+0002e920: 6e74 203d 2068 6172 6e65 7373 2e63 6861  nt = harness.cha
+0002e930: 726d 2e65 7665 6e74 735b 315d 0a20 2020  rm.events[1].   
+0002e940: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002e950: 4973 496e 7374 616e 6365 2865 7665 6e74  IsInstance(event
+0002e960: 2c20 6f70 732e 5365 6372 6574 5265 6d6f  , ops.SecretRemo
+0002e970: 7665 4576 656e 7429 0a20 2020 2020 2020  veEvent).       
+0002e980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002e990: 6c28 6576 656e 742e 7365 6372 6574 2e6c  l(event.secret.l
+0002e9a0: 6162 656c 2c20 276f 7665 7272 6964 6527  abel, 'override'
+0002e9b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e9c0: 7373 6572 7445 7175 616c 2865 7665 6e74  ssertEqual(event
+0002e9d0: 2e72 6576 6973 696f 6e2c 2034 3229 0a20  .revision, 42). 
+0002e9e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002e9f0: 7274 4571 7561 6c28 6576 656e 742e 7365  rtEqual(event.se
+0002ea00: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
+0002ea10: 2829 2c20 7b27 666f 6f27 3a20 2778 277d  (), {'foo': 'x'}
+0002ea20: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+0002ea30: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0002ea40: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+0002ea50: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0002ea60: 6e65 7373 2e74 7269 6767 6572 5f73 6563  ness.trigger_sec
+0002ea70: 7265 745f 7265 6d6f 7661 6c28 276e 6f73  ret_removal('nos
+0002ea80: 6563 7265 7427 2c20 3129 0a0a 0a63 6c61  ecret', 1)...cla
+0002ea90: 7373 2045 7665 6e74 5265 636f 7264 6572  ss EventRecorder
+0002eaa0: 286f 7073 2e43 6861 726d 4261 7365 293a  (ops.CharmBase):
+0002eab0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0002eac0: 5f28 7365 6c66 2c20 6672 616d 6577 6f72  _(self, framewor
+0002ead0: 6b29 3a0a 2020 2020 2020 2020 7375 7065  k):.        supe
+0002eae0: 7228 292e 5f5f 696e 6974 5f5f 2866 7261  r().__init__(fra
+0002eaf0: 6d65 776f 726b 290a 2020 2020 2020 2020  mework).        
+0002eb00: 7365 6c66 2e65 7665 6e74 7320 3d20 5b5d  self.events = []
+0002eb10: 0a0a 2020 2020 6465 6620 7265 636f 7264  ..    def record
+0002eb20: 5f65 7665 6e74 2873 656c 662c 2065 7665  _event(self, eve
+0002eb30: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
+0002eb40: 662e 6576 656e 7473 2e61 7070 656e 6428  f.events.append(
+0002eb50: 6576 656e 7429 0a0a 0a63 6c61 7373 2054  event)...class T
+0002eb60: 6573 7450 6f72 7473 2875 6e69 7474 6573  estPorts(unittes
+0002eb70: 742e 5465 7374 4361 7365 293a 0a20 2020  t.TestCase):.   
+0002eb80: 2064 6566 2074 6573 745f 706f 7274 7328   def test_ports(
+0002eb90: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0002eba0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0002ebb0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+0002ebc0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+0002ebd0: 3d27 6e61 6d65 3a20 7765 6261 7070 2729  ='name: webapp')
+0002ebe0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0002ebf0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0002ec00: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0002ec10: 2020 756e 6974 203d 2068 6172 6e65 7373    unit = harness
+0002ec20: 2e6d 6f64 656c 2e75 6e69 740a 0a20 2020  .model.unit..   
+0002ec30: 2020 2020 2075 6e69 742e 6f70 656e 5f70       unit.open_p
+0002ec40: 6f72 7428 2774 6370 272c 2038 3038 3029  ort('tcp', 8080)
+0002ec50: 0a20 2020 2020 2020 2075 6e69 742e 6f70  .        unit.op
+0002ec60: 656e 5f70 6f72 7428 2775 6470 272c 2034  en_port('udp', 4
+0002ec70: 3030 3029 0a20 2020 2020 2020 2075 6e69  000).        uni
+0002ec80: 742e 6f70 656e 5f70 6f72 7428 2769 636d  t.open_port('icm
+0002ec90: 7027 290a 0a20 2020 2020 2020 2070 6f72  p')..        por
+0002eca0: 7473 5f73 6574 203d 2075 6e69 742e 6f70  ts_set = unit.op
+0002ecb0: 656e 6564 5f70 6f72 7473 2829 0a20 2020  ened_ports().   
+0002ecc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002ecd0: 4973 496e 7374 616e 6365 2870 6f72 7473  IsInstance(ports
+0002ece0: 5f73 6574 2c20 7365 7429 0a20 2020 2020  _set, set).     
+0002ecf0: 2020 2070 6f72 7473 203d 2073 6f72 7465     ports = sorte
+0002ed00: 6428 706f 7274 735f 7365 742c 206b 6579  d(ports_set, key
+0002ed10: 3d6c 616d 6264 6120 703a 2028 702e 7072  =lambda p: (p.pr
+0002ed20: 6f74 6f63 6f6c 2c20 702e 706f 7274 2929  otocol, p.port))
+0002ed30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002ed40: 7365 7274 4571 7561 6c28 6c65 6e28 706f  sertEqual(len(po
+0002ed50: 7274 7329 2c20 3329 0a20 2020 2020 2020  rts), 3).       
+0002ed60: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+0002ed70: 7374 616e 6365 2870 6f72 7473 5b30 5d2c  stance(ports[0],
+0002ed80: 206f 7073 2e4f 7065 6e65 6450 6f72 7429   ops.OpenedPort)
+0002ed90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002eda0: 7365 7274 4571 7561 6c28 706f 7274 735b  sertEqual(ports[
+0002edb0: 305d 2e70 726f 746f 636f 6c2c 2027 6963  0].protocol, 'ic
+0002edc0: 6d70 2729 0a20 2020 2020 2020 2073 656c  mp').        sel
+0002edd0: 662e 6173 7365 7274 4973 4e6f 6e65 2870  f.assertIsNone(p
+0002ede0: 6f72 7473 5b30 5d2e 706f 7274 290a 2020  orts[0].port).  
+0002edf0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002ee00: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
+0002ee10: 735b 315d 2c20 6f70 732e 4f70 656e 6564  s[1], ops.Opened
+0002ee20: 506f 7274 290a 2020 2020 2020 2020 7365  Port).        se
+0002ee30: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+0002ee40: 6f72 7473 5b31 5d2e 7072 6f74 6f63 6f6c  orts[1].protocol
+0002ee50: 2c20 2774 6370 2729 0a20 2020 2020 2020  , 'tcp').       
+0002ee60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0002ee70: 6c28 706f 7274 735b 315d 2e70 6f72 742c  l(ports[1].port,
+0002ee80: 2038 3038 3029 0a20 2020 2020 2020 2073   8080).        s
+0002ee90: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0002eea0: 616e 6365 2870 6f72 7473 5b32 5d2c 206f  ance(ports[2], o
+0002eeb0: 7073 2e4f 7065 6e65 6450 6f72 7429 0a20  ps.OpenedPort). 
+0002eec0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002eed0: 7274 4571 7561 6c28 706f 7274 735b 325d  rtEqual(ports[2]
+0002eee0: 2e70 726f 746f 636f 6c2c 2027 7564 7027  .protocol, 'udp'
+0002eef0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002ef00: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
+0002ef10: 5b32 5d2e 706f 7274 2c20 3430 3030 290a  [2].port, 4000).
+0002ef20: 0a20 2020 2020 2020 2075 6e69 742e 636c  .        unit.cl
+0002ef30: 6f73 655f 706f 7274 2827 7463 7027 2c20  ose_port('tcp', 
+0002ef40: 3830 3830 290a 2020 2020 2020 2020 756e  8080).        un
+0002ef50: 6974 2e63 6c6f 7365 5f70 6f72 7428 2774  it.close_port('t
+0002ef60: 6370 272c 2038 3038 3029 2020 2320 636c  cp', 8080)  # cl
+0002ef70: 6f73 696e 6720 7361 6d65 2070 6f72 7420  osing same port 
+0002ef80: 6167 6169 6e20 6861 7320 6e6f 2065 6666  again has no eff
+0002ef90: 6563 740a 2020 2020 2020 2020 756e 6974  ect.        unit
+0002efa0: 2e63 6c6f 7365 5f70 6f72 7428 2775 6470  .close_port('udp
+0002efb0: 272c 2034 3030 3029 0a0a 2020 2020 2020  ', 4000)..      
+0002efc0: 2020 706f 7274 735f 7365 7420 3d20 756e    ports_set = un
+0002efd0: 6974 2e6f 7065 6e65 645f 706f 7274 7328  it.opened_ports(
+0002efe0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002eff0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+0002f000: 706f 7274 735f 7365 742c 2073 6574 290a  ports_set, set).
+0002f010: 2020 2020 2020 2020 706f 7274 7320 3d20          ports = 
+0002f020: 736f 7274 6564 2870 6f72 7473 5f73 6574  sorted(ports_set
+0002f030: 2c20 6b65 793d 6c61 6d62 6461 2070 3a20  , key=lambda p: 
+0002f040: 2870 2e70 726f 746f 636f 6c2c 2070 2e70  (p.protocol, p.p
+0002f050: 6f72 7429 290a 2020 2020 2020 2020 7365  ort)).        se
+0002f060: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+0002f070: 656e 2870 6f72 7473 292c 2031 290a 2020  en(ports), 1).  
+0002f080: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002f090: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
+0002f0a0: 735b 305d 2c20 6f70 732e 4f70 656e 6564  s[0], ops.Opened
+0002f0b0: 506f 7274 290a 2020 2020 2020 2020 7365  Port).        se
+0002f0c0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+0002f0d0: 6f72 7473 5b30 5d2e 7072 6f74 6f63 6f6c  orts[0].protocol
+0002f0e0: 2c20 2769 636d 7027 290a 2020 2020 2020  , 'icmp').      
+0002f0f0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+0002f100: 6f6e 6528 706f 7274 735b 305d 2e70 6f72  one(ports[0].por
+0002f110: 7429 0a0a 2020 2020 2020 2020 756e 6974  t)..        unit
+0002f120: 2e63 6c6f 7365 5f70 6f72 7428 2769 636d  .close_port('icm
+0002f130: 7027 290a 0a20 2020 2020 2020 2070 6f72  p')..        por
+0002f140: 7473 5f73 6574 203d 2075 6e69 742e 6f70  ts_set = unit.op
+0002f150: 656e 6564 5f70 6f72 7473 2829 0a20 2020  ened_ports().   
+0002f160: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002f170: 4571 7561 6c28 706f 7274 735f 7365 742c  Equal(ports_set,
+0002f180: 2073 6574 2829 290a 0a20 2020 2064 6566   set())..    def
+0002f190: 2074 6573 745f 6572 726f 7273 2873 656c   test_errors(sel
+0002f1a0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+0002f1b0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+0002f1c0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+0002f1d0: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
+0002f1e0: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
+0002f1f0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0002f200: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0002f210: 6561 6e75 7029 0a20 2020 2020 2020 2075  eanup).        u
+0002f220: 6e69 7420 3d20 6861 726e 6573 732e 6d6f  nit = harness.mo
+0002f230: 6465 6c2e 756e 6974 0a0a 2020 2020 2020  del.unit..      
+0002f240: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0002f250: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+0002f260: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
+0002f270: 2020 2020 2020 756e 6974 2e6f 7065 6e5f        unit.open_
+0002f280: 706f 7274 2827 6963 6d70 272c 2038 3038  port('icmp', 808
+0002f290: 3029 2020 2320 6963 6d70 2063 616e 6e6f  0)  # icmp canno
+0002f2a0: 7420 6861 7665 2070 6f72 740a 2020 2020  t have port.    
+0002f2b0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0002f2c0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0002f2d0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+0002f2e0: 2020 2020 2020 2020 756e 6974 2e6f 7065          unit.ope
+0002f2f0: 6e5f 706f 7274 2827 6674 7027 2c20 3830  n_port('ftp', 80
+0002f300: 3830 2920 2023 2069 6e76 616c 6964 2070  80)  # invalid p
+0002f310: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
+0002f320: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0002f330: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
+0002f340: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0002f350: 2020 2020 756e 6974 2e6f 7065 6e5f 706f      unit.open_po
+0002f360: 7274 2827 7463 7027 2920 2023 2074 6370  rt('tcp')  # tcp
+0002f370: 206d 7573 7420 6861 7665 2070 6f72 740a   must have port.
+0002f380: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0002f390: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0002f3a0: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+0002f3b0: 2020 2020 2020 2020 2020 2020 756e 6974              unit
+0002f3c0: 2e6f 7065 6e5f 706f 7274 2827 7564 7027  .open_port('udp'
+0002f3d0: 2920 2023 2075 6470 206d 7573 7420 6861  )  # udp must ha
+0002f3e0: 7665 2070 6f72 740a 2020 2020 2020 2020  ve port.        
+0002f3f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0002f400: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
+0002f410: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0002f420: 2020 2020 756e 6974 2e6f 7065 6e5f 706f      unit.open_po
+0002f430: 7274 2827 7463 7027 2c20 3029 2020 2320  rt('tcp', 0)  # 
+0002f440: 706f 7274 206f 7574 206f 6620 7261 6e67  port out of rang
+0002f450: 650a 2020 2020 2020 2020 7769 7468 2073  e.        with s
+0002f460: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0002f470: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+0002f480: 3a0a 2020 2020 2020 2020 2020 2020 756e  :.            un
+0002f490: 6974 2e6f 7065 6e5f 706f 7274 2827 7463  it.open_port('tc
+0002f4a0: 7027 2c20 3635 3533 3629 2020 2320 706f  p', 65536)  # po
+0002f4b0: 7274 206f 7574 206f 6620 7261 6e67 650a  rt out of range.
```

